/*! v10.12.4. Copyright 2018-2021 Structured Data, LLC. All rights reserved. CC BY-ND: https://treb.app/license */
(()=>{var t={691:function(t,e){!function(t){"use strict";var e=new(function(){function t(t){void 0===t&&(t=0),this.m_w=0,this.m_z=0,this.Seed(t)}return t.prototype.Seed=function(t){void 0===t&&(t=0),t?(this.m_w=Math.round(2863311530&t)||1,this.m_z=Math.round(1431655765&t)||1):(this.m_w=Math.round(1e5*Math.random()),this.m_z=Math.round((new Date).getTime()))},t.prototype.Next=function(){return this.m_z=36969*(65535&this.m_z)+(this.m_z>>16)&4294967295,this.m_w=18e3*(65535&this.m_w)+(this.m_w>>16)&4294967295,.5+((this.m_z<<16)+this.m_w&4294967295)/4294967296},t.prototype.GetState=function(){return[this.m_w,this.m_z]},t}()),r=function(){function t(){}return t.Sort=function(t,e){this.QuickSort(t,e,0,t.length)},t.Partition=function(t,e,r,s){for(var i=t[s-1],n=r,a=r;a<s-1;a+=1)t[a]<=i&&(this.Swap(t,e,a,n),n+=1);return this.Swap(t,e,n,s-1),n},t.Swap=function(t,e,r,s){var i=t[r];t[r]=t[s],t[s]=i,i=e[r],e[r]=e[s],e[s]=i},t.QuickSort=function(t,e,r,s){if(r<s){var i=this.Partition(t,e,r,s);this.QuickSort(t,e,r,i),this.QuickSort(t,e,i+1,s)}},t}(),s=function(){return(s=Object.assign||function(t){for(var e,r=1,s=arguments.length;r<s;r++)for(var i in e=arguments[r])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)},i=function(){function t(){}return t.Sort=function(t){return this.QuickSort(t,0,t.length-1),t},t.Swap=function(t,e,r){var s=t[e];t[e]=t[r],t[r]=s},t.Partition=function(t,e,r){for(var s=t[Math.floor((r+e)/2)];e<=r;){for(;t[e]<s;)e++;for(;t[r]>s;)r--;e<=r&&(this.Swap(t,e,r),e++,r--)}return e},t.QuickSort=function(t,e,r){var s;return t.length>1&&(e<(s=this.Partition(t,e,r))-1&&this.QuickSort(t,e,s-1),s<r&&this.QuickSort(t,s,r)),t},t}(),n=function(){function t(){}return t.Correlation=function(t,e){for(var r=0,s=0,i=0,n=0,a=0,o=0,l=0;l<t.length;l++)s+=t[l]*e[l],i+=t[l],n+=e[l],a+=t[l]*t[l],o+=e[l]*e[l];return(r=t.length*s-i*n)&&(r/=Math.sqrt((t.length*a-i*i)*(t.length*o-n*n))),r},t.TickRange=function(t,e,r){var s=t/(e-1),i=Math.ceil(this.Log10(s)-1),n=Math.pow(10,i);return Math.ceil(s/n)*n},t.Log10=function(t){return Math.log(t)/Math.LN10},t.Log2=function(t){return Math.log(t)/Math.LN2},t.Percentiles=function(t,e){for(var r=i.Sort(t.slice(0)),s=r.length,n=new Array(101),a=0;a<100;a++)n[a]=r[Math.round(s*a/100)];return n[100]=r[s-1],n},t.Percentile=function(t,e){var r=i.Sort(t.slice(0)),s=r.length;return r[Math.max(0,Math.min(s-1,Math.round(s*e)))]},t.Interval=function(t){var e=0;if(!t.data||!t.data.length)return 0;if(void 0===t.min){if(void 0===t.max)return 1;for(var r=0,s=t.data;r<s.length;r++)(l=s[r])<=t.max&&e++}else if(void 0===t.max)for(var i=0,n=t.data;i<n.length;i++)(l=n[i])>=t.min&&e++;else for(var a=0,o=t.data;a<o.length;a++){var l;(l=o[a])>=t.min&&l<=t.max&&e++}return e/t.data.length},t.R2=function(t,e){for(var r=0,s=0,i=0,n=0,a=0,o=0,l=0,h=0,u=0;u<t.length;u++)n+=(s=e[u])*(i=t[u]),a+=s,o+=i,l+=s*s,h+=i*i;return(r=t.length*n-a*o)&&(r/=Math.sqrt((t.length*l-a*a)*(t.length*h-o*o))),r*r},t.ToSD=function(t,e){if(void 0===e&&(e=2),e=e||2,0===t)return t;var r=Math.pow(10,Math.floor(this.Log10(t))+1-e);return Math.round(t/r)*r},t.Statistics=function(t){for(var e=this.Range(t),r=t.length,n=0,a=0,o=0,l=0,h=i.Sort(t.slice(0)),u=h[Math.round(r/2)],c=0;c<r;c++)n+=t[c];var d=n/=r;for(c=0;c<r;c++){var m=t[c]-n;a+=m*m,l+=m*m*m,o+=m*m*m*m}var f=r,p=a/r,_=Math.sqrt(a/r),g=l/((r-1)*Math.pow(_,3)),y=o/((r-1)*Math.pow(_,4)),v=Math.sqrt(a/r)/Math.sqrt(r),b={};for(c=5;c<100;c+=5)b[c]=h[Math.round(r*c/100)];b[0]=h[0],b[100]=h[r-1];var w=this.Interval({data:t,max:0});return s(s({},e),{median:u,mean:d,N:f,variance:p,stdev:_,skewness:g,kurtosis:y,stderr:v,percentiles:b,zero:w})},t.Truncate=function(t,e,r){var s=i.Sort(t.slice(0));return s.slice(Math.round(s.length*e/100),Math.round(s.length*r/100))},t.Histogram=function(t,e){void 0===e&&(e="sturges");for(var r=!0,s=0;r&&s<t.length;s++)r=r&&t[s]===Math.round(t[s]);var i=this.Range(t);if("string"==typeof e||!e)if("fd"===e){var n=this.FD(t);e=0===n||0===i.range?1:Math.round(i.range/n+1)}else e=this.Sturges(t);var a=[],o=[];if(r&&e>i.range){for(e=i.range+1,s=0;s<e;s++)a[s]=0,o[s]=i.min+s;for(var l=0,h=t;l<h.length;l++)a[(_=h[l])-i.min]++}else{var u=this.TickRange(i.range,e),c=this.FirstBin(i.max,i.min,e,u),d=Math.ceil(this.Log10(u)-1);for(s=0;s<e;s++)a[s]=0,o[s]=(c+s*u).toFixed(Math.max(0,-d));for(var m=c-u,f=0,p=t;f<p.length;f++){var _=p[f];a[Math.floor((_-m)/u)]++}}return{bins:a,labels:o}},t.Sturges=function(t){return Math.ceil(this.Log2(t.length)+1)},t.IQR=function(t){var e=this.Quantiles(t,[.25,.75]);return e[1]-e[0]},t.Quantiles=function(t,e){void 0===e&&(e=[0,.25,.5,.75,1]);var r=i.Sort(t.slice(0));return e.map((function(t){return r[Math.floor((r.length-1)*t)]}))},t.FD=function(t){return 2*this.IQR(t)*Math.pow(t.length,-1/3)},t.FirstBin=function(t,e,r,s){var i=(Math.floor(e/s)+1)*s,n=Math.floor((i+(r-1)*s-t)/s);return n>=2?i-n/2*s:i},t.Range=function(t){for(var e=t.length,r=e>0?t[0]:0,s=e>0?t[0]:0,i=1;i<e;i++)t[i]>s&&(s=t[i]),t[i]<r&&(r=t[i]);return{min:r,max:s,range:s-r}},t.EPSILON_DOUBLE=2220446049250313e-31,t.QUIET_NAN=Number.NaN,t.s_undefined="undefined",t.s_object="object",t.s_number="number",t}(),a=function(){function t(){this.rows=0,this.columns=0,this.data=[]}return t.Zero=function(e,r){return void 0===r&&(r=e),(new t).Reset(e,r)},t.Identity=function(t){for(var e=this.Zero(t,t),r=0;r<t;r++)e.data[r][r]=1;return e},t.Clone=function(e){var r=new t;r.rows=e.rows,r.columns=e.columns;for(var s=0,i=e.data;s<i.length;s++){var n=i[s];r.data.push(new Float64Array(n))}return r},t.FromArray=function(t,e){void 0===e&&(e=!1);var r=t[0].length,s=t.length;if(e){for(var i=this.Zero(r,s),n=0;n<s;n++)for(var a=0;a<r;a++)i.data[n][a]=t[n][a];return i}for(i=this.Zero(s,r),n=0;n<s;n++)for(a=0;a<r;a++)i.data[a][n]=t[n][a]||0;return i},t.prototype.Reset=function(t,e){this.data=new Array(e);for(var r=0;r<e;r++)this.data[r]=new Float64Array(t);return this.rows=t,this.columns=e,this},t.prototype.CopyTo=function(t){t.rows=this.rows,t.columns=this.columns,t.data=new Array(this.columns);for(var e=0,r=this.data;e<r.length;e++){var s=r[e];t.data.push(new Float64Array(s))}return t},t.prototype.GetColumn=function(t){return this.data[t]},t.prototype.SetColumn=function(t,e){this.data[t]=new Float64Array(e)},t.prototype.Transpose=function(){for(var e=t.Zero(this.columns,this.rows),r=0;r<this.columns;r++)for(var s=0;s<this.rows;s++)e.data[r][s]=this.data[s][r];return e},t.prototype.Symmetrize=function(e){void 0===e&&(e=!1);var r=this.Transpose(),s=t.Clone(this);if(e)for(n=1;n<this.columns;n++)for(i=0;i<n;i++)s.data[i][n]=r.data[i][n];else for(var i=1;i<this.rows;i++)for(var n=0;n<i;n++)s.data[i][n]=r.data[i][n];return s},t.prototype.Cholesky=function(e){if(void 0===e&&(e=!1),this.rows!==this.columns)throw new Error("matrix not square");for(var r=this.rows,s=t.Zero(r),i=0;i<r;i++){for(var n=0,a=0;a<i;a++){for(var o=0,l=0;l<a;l++)o+=s.data[a][l]*s.data[i][l];if(s.data[i][a]=o=(this.data[i][a]-o)/s.data[a][a],n+=o*o,this.data[a][i]!==this.data[i][a])throw new Error("matrix not symmetrical")}if((n=this.data[i][i]-n)<=0)throw new Error("matrix not pos-def ("+n+")");for(s.data[i][i]=n>0?Math.sqrt(n):0,a=i+1;a<r;a++)s.data[i][a]=0}return e?s.Transpose():s},t.prototype.Multiply=function(e){for(var r=0,s=0,i=t.Zero(this.rows,e.columns),n=0;n<this.rows;n++)for(var a=0;a<e.columns;a++){for(s=r=0;r<this.columns;r++)s+=this.data[r][n]*e.data[a][r];i.data[a][n]=s}return i},t.prototype.Inverse=function(){if(this.rows!==this.columns)throw new Error("invalid matrix");for(var e=t.Clone(this),r=0,s=e.rows,i=1;i<s;i++)e.data[i][0]/=e.data[0][0];for(i=1;i<s;i++){for(var n=i;n<s;n++){r=0;for(var a=0;a<i;a++)r+=e.data[a][n]*e.data[i][a];e.data[i][n]-=r}if(i!==s-1)for(n=i+1;n<s;n++){for(r=0,a=0;a<i;a++)r+=e.data[a][i]*e.data[n][a];e.data[n][i]=(e.data[n][i]-r)/e.data[i][i]}}for(i=0;i<s;i++)for(n=i;n<s;n++){var o=1;if(i!==n)for(o=0,a=i;a<n;a++)o-=e.data[a][n]*e.data[i][a];e.data[i][n]=o/e.data[n][n]}for(i=0;i<s;i++)for(n=i;n<s;n++)if(i!==n){for(r=0,a=i;a<n;a++)r+=e.data[n][a]*(i===a?1:e.data[a][i]);e.data[n][i]=-r}for(i=0;i<s;i++)for(n=0;n<s;n++){for(r=0,a=i>n?i:n;a<s;a++)r+=(n===a?1:e.data[a][n])*e.data[i][a];e.data[i][n]=r}return e},t.prototype.SortColumns=function(e){void 0===e&&(e=!1);for(var r=t.Clone(this),s=e?function(t,e){return e-t}:function(t,e){return t-e},i=0,n=r.data;i<n.length;i++)n[i].sort(s);return r},t.prototype.Rank=function(e){void 0===e&&(e=!1);for(var s=t.Clone(this),i=new Int32Array(this.rows),n=0;n<this.rows;n++)i[n]=n;for(var a=0;a<this.columns;a++){var o=new Int32Array(i);for(r.Sort(s.data[a],o),e&&o.reverse(),n=0;n<this.rows;n++)s.data[a][o[n]]=n}return s},t.prototype.Rank2=function(e,s){void 0===e&&(e=!1);for(var i=t.Zero(this.rows,this.columns),n=new Int32Array(this.rows),a=0;a<this.rows;a++)n[a]=a;for(var o=0;o<this.columns;o++){var l=new Int32Array(n);for(r.Sort(this.data[o],l),e&&l.reverse(),a=0;a<this.rows;a++)i.data[o][l[a]]=s.data[o][a]}return i},t.prototype.Correl=function(){for(var e=t.Zero(this.columns,this.columns),r=0;r<this.columns;r++){e.data[r][r]=1;for(var s=0;s<r;s++)e.data[s][r]=n.Correlation(this.data[r],this.data[s])}return e.Symmetrize()},t.prototype.IsSymmetric=function(){if(this.rows!==this.columns)return!1;for(var t=0;t<this.columns;t++)for(var e=0;e<this.rows;e++)if(this.data[t][e]!==this.data[e][t])return!1;return!0},t.prototype.toString=function(t){var e="";t=t||2;for(var r=0;r<this.rows;r++){for(var s=0;s<this.columns;s++){var i=this.data[s][r];i>=0&&(e+=" "),e+=i.toFixed(t),e+=" "}e+="\n"}return e},t}();Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length,r=0;r<e;r++){if(arguments[r]===1/0||arguments[r]===-1/0)return 1/0;t+=arguments[r]*arguments[r]}return Math.sqrt(t)});var o=function(){function t(){}return t.Guid=function(){for(var t="",e=0;e<8;e++)t+=Math.round(256*Math.random()).toString(16);return t},t.Log10=function(t){return Math.log(t)/Math.LN10},t.ToSD=function(t,e){if(void 0===e&&(e=2),e=e||2,0===t)return t;var r=t<0?-1:1;t*=r;var s=Math.pow(10,Math.floor(this.Log10(t))+1-e);return Math.round(t/s)*s*r},t.ToSDCeil=function(t,e){if(void 0===e&&(e=2),e=e||2,0===t)return t;var r=t<0?-1:1;t*=r;var s=Math.pow(10,Math.floor(this.Log10(t))+1-e);return Math.ceil(t/s)*s*r},t.SuggestDecimals=function(t){if("number"!=typeof t){for(var e=t[0],r=t[0],s=0,i=t;s<i.length;s++){var n=i[s];e=Math.min(e,n),r=Math.max(r,n)}t=r-e}var a=Math.ceil(this.Log10(t));return console.log(a),a<=0?1-a:1},t.YearFraction=function(t){var e=new Date(t.getTime());return e.setMonth(11,31),(e.getTime()-t.getTime())/this.MILLIS_YEAR},t.DEFAULT_NUMBER_FORMAT="(0,0.00)",t.DEFAULT_PCT_FORMAT="0.00",t.DEFAULT_CURRENCY_FORMAT="(0,0)",t.MILLIS_YEAR=315576e5,t}(),l=function(){function t(t){this.order=0,this.realvalues=[],this.ivalues=[],this.vectors=[];var e=t.length;this.order=e,this.vectors=[];for(var r=!0,s=0;r&&s<e;s++){if(t[s].length!==e)throw new Error("not square");for(var i=0;i<e;i++)t[s][i]!==t[i][s]&&(r=!1)}if(r){for(s=0;s<e;s++)Array.isArray(t[s])?this.vectors.push(t[s].slice(0)):this.vectors.push(Array.from(t[s]));this.tred2(),this.tql2()}else{var n=[],a=[];for(s=0;s<e;s++){for(Array.isArray(t[s])?n.push(t[s].slice(0)):n.push(Array.from(t[s])),this.vectors.push([]),i=0;i<e;i++)this.vectors[s][i]=0;a.push(0)}this.orthes(n,a),this.hqr2(n,a)}}return t.prototype.GetDiagonal=function(){for(var t=[],e=0;e<this.order;e++){t.push([]);for(var r=0;r<this.order;r++)t[e][r]=0;t[e][e]=this.realvalues[e],this.ivalues[e]>0?t[e][e+1]=this.ivalues[e]:this.ivalues[e]<0&&(t[e][e-1]=this.ivalues[e])}return t},t.prototype.tred2=function(){for(var t=0,e=0,r=0,s=0,i=0,n=this.order,a=this.vectors,o=this.realvalues,l=this.ivalues,h=0;h<n;h++)o[h]=a[n-1][h];for(var u=n-1;u>0;u--){r=0,s=0;for(var c=0;c<u;c++)r+=Math.abs(o[c]);if(0===r)for(l[u]=o[u-1],h=0;h<u;h++)o[h]=a[u-1][h],a[u][h]=0,a[h][u]=0;else{for(c=0;c<u;c++)o[c]/=r,s+=o[c]*o[c];for(t=o[u-1],e=Math.sqrt(s),t>0&&(e=-e),l[u]=r*e,s-=t*e,o[u-1]=t-e,h=0;h<u;h++)l[h]=0;for(h=0;h<u;h++){t=o[h],a[h][u]=t;var d=l[h]+a[h][h]*t;for(c=h+1;c<=u-1;c++)d+=a[c][h]*o[c],l[c]+=a[c][h]*t;l[h]=d}for(t=0,h=0;h<u;h++)l[h]/=s,t+=l[h]*o[h];for(i=t/(s+s),h=0;h<u;h++)l[h]-=i*o[h];for(h=0;h<u;h++){for(t=o[h],e=l[h],c=h;c<=u-1;c++)a[c][h]-=t*l[c]+e*o[c];o[h]=a[u-1][h],a[u][h]=0}}o[u]=s}for(u=0;u<n-1;u++){if(a[n-1][u]=a[u][u],a[u][u]=1,0!==(s=o[u+1])){for(c=0;c<=u;c++)o[c]=a[c][u+1]/s;for(h=0;h<=u;h++){for(e=0,c=0;c<=u;c++)e+=a[c][u+1]*a[c][h];for(c=0;c<=u;c++)a[c][h]-=e*o[c]}}for(c=0;c<=u;c++)a[c][u+1]=0}for(h=0;h<n;h++)o[h]=a[n-1][h],a[n-1][h]=0;a[n-1][n-1]=1,l[0]=0},t.prototype.tql2=function(){var t,e,r,s,i,n,a,o,l,h,u,c,d,m,f,p,_,g,y,v=this.order,b=this.vectors,w=this.realvalues,x=this.ivalues;for(t=1;t<v;t++)x[t-1]=x[t];for(x[v-1]=0,a=0,o=0,l=Math.pow(2,-52),e=0;e<v;e++){for(o=Math.max(o,Math.abs(w[e])+Math.abs(x[e])),n=e;n<v&&!(Math.abs(x[n])<=l*o);)n++;if(n>e)do{for(h=w[e],s=(w[e+1]-h)/(2*x[e]),u=Math.hypot(s,1),s<0&&(u=-u),w[e]=x[e]/(s+u),w[e+1]=x[e]*(s+u),c=w[e+1],d=h-w[e],t=e+2;t<v;t++)w[t]-=d;for(a+=d,s=w[n],f=m=1,p=m,_=x[e+1],g=0,y=0,t=n-1;t>=e;t--)for(p=f,f=m,y=g,h=m*x[t],d=m*s,u=Math.hypot(s,x[t]),x[t+1]=g*u,g=x[t]/u,s=(m=s/u)*w[t]-g*h,w[t+1]=d+g*(m*h+g*w[t]),r=0;r<v;r++)d=b[r][t+1],b[r][t+1]=g*b[r][t]+m*d,b[r][t]=m*b[r][t]-g*d;s=-g*y*p*_*x[e]/c,x[e]=g*s,w[e]=m*s}while(Math.abs(x[e])>l*o);w[e]=w[e]+a,x[e]=0}for(t=0;t<v-1;t++){for(r=t,s=w[t],i=t+1;i<v;i++)w[i]<s&&(r=i,s=w[i]);if(r!==t)for(w[r]=w[t],w[t]=s,i=0;i<v;i++)s=b[i][t],b[i][t]=b[i][r],b[i][r]=s}},t.prototype.orthes=function(t,e){var r,s,i,n,a,o,l,h=this.order,u=this.vectors,c=(this.realvalues,this.ivalues,h-1);for(o=1;o<=c-1;o++){for(l=0,n=o;n<=c;n++)l+=Math.abs(t[n][o-1]);if(0!==l){for(i=0,n=c;n>=o;n--)e[n]=t[n][o-1]/l,i+=e[n]*e[n];for(s=Math.sqrt(i),e[o]>0&&(s=-s),i-=e[o]*s,e[o]=e[o]-s,a=o;a<h;a++){for(r=0,n=c;n>=o;n--)r+=e[n]*t[n][a];for(r/=i,n=o;n<=c;n++)t[n][a]-=r*e[n]}for(n=0;n<=c;n++){for(r=0,a=c;a>=o;a--)r+=e[a]*t[n][a];for(r/=i,a=o;a<=c;a++)t[n][a]-=r*e[a]}e[o]=l*e[o],t[o][o-1]=l*s}}for(n=0;n<h;n++)for(a=0;a<h;a++)u[n][a]=n===a?1:0;for(o=c-1;o>=1;o--)if(0!==t[o][o-1]){for(n=o+1;n<=c;n++)e[n]=t[n][o-1];for(a=o;a<=c;a++){for(s=0,n=o;n<=c;n++)s+=e[n]*u[n][a];for(s=s/e[o]/t[o][o-1],n=o;n<=c;n++)u[n][a]+=s*e[n]}}},t.prototype.cdiv=function(t,e,r,s){var i=0,n=0;return Math.abs(r)>Math.abs(s)?{r:(t+(i=s/r)*e)/(n=r+i*s),i:(e-i*t)/n}:{r:((i=r/s)*t+e)/(n=s+i*r),i:(i*e-t)/n}},t.prototype.hqr2=function(t,e){var r,s,i,n,a,o,l,h,u,c,d,m=this.order,f=this.vectors,p=this.realvalues,_=this.ivalues,g=m,y=g-1,v=g-1,b=Math.pow(2,-52),w=0,x=0,M=0,C=0,S=0,A=0,R=0;for(o=0;o<g;o++)for((o<0||o>v)&&(p[o]=t[o][o],_[o]=0),l=Math.max(o-1,0);l<g;l++)R+=Math.abs(t[o][l]);for(u=0;y>=0;){for(c=y;c>0&&(0===(S=Math.abs(t[c-1][c-1])+Math.abs(t[c][c]))&&(S=R),!(Math.abs(t[c][c-1])<b*S));)c--;if(c===y)t[y][y]=t[y][y]+w,p[y]=t[y][y],_[y]=0,y--,u=0;else if(c===y-1){if(s=t[y][y-1]*t[y-1][y],M=(x=(t[y-1][y-1]-t[y][y])/2)*x+s,A=Math.sqrt(Math.abs(M)),t[y][y]=t[y][y]+w,t[y-1][y-1]=t[y-1][y-1]+w,i=t[y][y],M>=0){for(A=x>=0?x+A:x-A,p[y-1]=i+A,p[y]=p[y-1],0!==A&&(p[y]=i-s/A),_[y-1]=0,_[y]=0,x=(i=t[y][y-1])/(S=Math.abs(i)+Math.abs(A)),M=A/S,x/=C=Math.sqrt(x*x+M*M),M/=C,l=y-1;l<g;l++)A=t[y-1][l],t[y-1][l]=M*A+x*t[y][l],t[y][l]=M*t[y][l]-x*A;for(o=0;o<=y;o++)A=t[o][y-1],t[o][y-1]=M*A+x*t[o][y],t[o][y]=M*t[o][y]-x*A;for(o=0;o<=v;o++)A=f[o][y-1],f[o][y-1]=M*A+x*f[o][y],f[o][y]=M*f[o][y]-x*A}else p[y-1]=i+x,p[y]=i+x,_[y-1]=A,_[y]=-A;y-=2,u=0}else{if(i=t[y][y],n=0,s=0,c<y&&(n=t[y-1][y-1],s=t[y][y-1]*t[y-1][y]),10===u){for(w+=i,o=0;o<=y;o++)t[o][o]-=i;i=n=.75*(S=Math.abs(t[y][y-1])+Math.abs(t[y-1][y-2])),s=-.4375*S*S}if(30===u&&(S=(S=(n-i)/2)*S+s)>0){for(S=Math.sqrt(S),n<i&&(S=-S),S=i-s/((n-i)/2+S),o=0;o<=y;o++)t[o][o]-=S;w+=S,i=n=s=.964}for(u+=1,d=y-2;d>=c&&(x=((C=i-(A=t[d][d]))*(S=n-A)-s)/t[d+1][d]+t[d][d+1],M=t[d+1][d+1]-A-C-S,C=t[d+2][d+1],x/=S=Math.abs(x)+Math.abs(M)+Math.abs(C),M/=S,C/=S,d!==c)&&!(Math.abs(t[d][d-1])*(Math.abs(M)+Math.abs(C))<b*(Math.abs(x)*(Math.abs(t[d-1][d-1])+Math.abs(A)+Math.abs(t[d+1][d+1]))));)d--;for(o=d+2;o<=y;o++)t[o][o-2]=0,o>d+2&&(t[o][o-3]=0);for(h=d;h<=y-1;h++){var k=h!==y-1;if(h!==d&&(x=t[h][h-1],M=t[h+1][h-1],C=k?t[h+2][h-1]:0,0!==(i=Math.abs(x)+Math.abs(M)+Math.abs(C))&&(x/=i,M/=i,C/=i)),0===i)break;if(S=Math.sqrt(x*x+M*M+C*C),x<0&&(S=-S),0!==S){for(h!==d?t[h][h-1]=-S*i:c!==d&&(t[h][h-1]=-t[h][h-1]),i=(x+=S)/S,n=M/S,A=C/S,M/=x,C/=x,l=h;l<g;l++)x=t[h][l]+M*t[h+1][l],k&&(x+=C*t[h+2][l],t[h+2][l]=t[h+2][l]-x*A),t[h][l]=t[h][l]-x*i,t[h+1][l]=t[h+1][l]-x*n;for(o=0;o<=Math.min(y,h+3);o++)x=i*t[o][h]+n*t[o][h+1],k&&(x+=A*t[o][h+2],t[o][h+2]=t[o][h+2]-x*C),t[o][h]=t[o][h]-x,t[o][h+1]=t[o][h+1]-x*M;for(o=0;o<=v;o++)x=i*f[o][h]+n*f[o][h+1],k&&(x+=A*f[o][h+2],f[o][h+2]=f[o][h+2]-x*C),f[o][h]=f[o][h]-x,f[o][h+1]=f[o][h+1]-x*M}}}}if(0!==R){for(y=g-1;y>=0;y--)if(x=p[y],0===(M=_[y]))for(c=y,t[y][y]=1,o=y-1;o>=0;o--){for(s=t[o][o]-x,C=0,l=c;l<=y;l++)C+=t[o][l]*t[l][y];if(_[o]<0)A=s,S=C;else if(c=o,0===_[o]?t[o][y]=0!==s?-C/s:-C/(b*R):(i=t[o][o+1],n=t[o+1][o],r=(i*S-A*C)/(M=(p[o]-x)*(p[o]-x)+_[o]*_[o]),t[o][y]=r,Math.abs(i)>Math.abs(A)?t[o+1][y]=(-C-s*r)/i:t[o+1][y]=(-S-n*r)/A),b*(r=Math.abs(t[o][y]))*r>1)for(l=o;l<=y;l++)t[l][y]=t[l][y]/r}else if(M<0)for(c=y-1,Math.abs(t[y][y-1])>Math.abs(t[y-1][y])?(t[y-1][y-1]=M/t[y][y-1],t[y-1][y]=-(t[y][y]-x)/t[y][y-1]):(a=this.cdiv(0,-t[y-1][y],t[y-1][y-1]-x,M),t[y-1][y-1]=a.r,t[y-1][y]=a.i),t[y][y-1]=0,t[y][y]=1,o=y-2;o>=0;o--){var N=void 0,D=void 0,P=void 0,E=void 0;for(N=0,D=0,l=c;l<=y;l++)N+=t[o][l]*t[l][y-1],D+=t[o][l]*t[l][y];if(s=t[o][o]-x,_[o]<0)A=s,C=N,S=D;else if(c=o,0===_[o]?(a=this.cdiv(-N,-D,s,M),t[o][y-1]=a.r,t[o][y]=a.i):(i=t[o][o+1],n=t[o+1][o],P=(p[o]-x)*(p[o]-x)+_[o]*_[o]-M*M,E=2*(p[o]-x)*M,0===P&&0===E&&(P=b*R*(Math.abs(s)+Math.abs(M)+Math.abs(i)+Math.abs(n)+Math.abs(A))),a=this.cdiv(i*C-A*N+M*D,i*S-A*D-M*N,P,E),t[o][y-1]=a.r,t[o][y]=a.i,Math.abs(i)>Math.abs(A)+Math.abs(M)?(t[o+1][y-1]=(-N-s*t[o][y-1]+M*t[o][y])/i,t[o+1][y]=(-D-s*t[o][y]-M*t[o][y-1])/i):(a=this.cdiv(-C-n*t[o][y-1],-S-n*t[o][y],A,M),t[o+1][y-1]=a.r,t[o+1][y]=a.i)),b*(r=Math.max(Math.abs(t[o][y-1]),Math.abs(t[o][y])))*r>1)for(l=o;l<=y;l++)t[l][y-1]=t[l][y-1]/r,t[l][y]=t[l][y]/r}for(o=0;o<g;o++)if(o<0||o>v)for(l=o;l<g;l++)f[o][l]=t[o][l];for(l=g-1;l>=0;l--)for(o=0;o<=v;o++){for(A=0,h=0;h<=Math.min(l,v);h++)A+=f[o][h]*t[h][l];f[o][l]=A}}},t}(),h=Math.pow(2,-52),u=function(){function t(){this.rows=0,this.columns=0,this._data=[]}return t.FromArray=function(t){for(var e=t[0].length,r=t.length,s=this.Zero(r,e),i=0;i<r;i++)for(var n=0;n<e;n++)s._data[i][n]=t[i][n]||0;return s},t.Zero=function(e,r){return void 0===r&&(r=e),(new t).Reset(e,r)},t.Identity=function(t){for(var e=this.Zero(t),r=0;r<t;r++)e._data[r][r]=1;return e},t.Clone=function(t){for(var e=this.Zero(t.rows,t.columns),r=0;r<t.rows;r++)e._data[r]=new Float64Array(t._data[r]);return e},t.prototype.Reset=function(t,e){void 0===e&&(e=t),this._data=new Array(t);for(var r=0;r<t;r++)this._data[r]=new Float64Array(e);return this.rows=t,this.columns=e,this},t.prototype.CopyTo=function(t){t.rows=this.rows,t.columns=this.columns,t._data=[];for(var e=0;e<this.rows;e++)t._data[e]=new Float64Array(this._data[e]);return t},t.prototype.Row=function(t,e){return void 0!==e&&(this._data[t]=new Float64Array(e)),Array.from(this._data[t])},t.prototype.Column=function(t,e){if(void 0!==e)for(var r=0;r<this.rows;r++)this._data[r][t]=arguments[1][r];var s=new Array(this.rows);for(r=0;r<this.rows;r++)s[r]=this._data[r][t];return s},t.prototype.Transpose=function(){for(var e=t.Zero(this.columns,this.rows),r=0;r<this.rows;r++)for(var s=0;s<this.columns;s++)e._data[s][r]=this._data[r][s];return e},t.prototype.ToArray=function(t){void 0===t&&(t=!1);var e=[];if(t)for(var r=0;r<this.columns;r++)e.push(this.Column(r));else for(var s=0;s<this.rows;s++)e.push(this.Row(s));return e},t.prototype.EigenSystem=function(){return new l(this._data)},t.prototype.IsPosDef=function(){return new l(this._data).realvalues.every((function(t){return t>0}))},t.prototype.MakePosDef=function(e){void 0===e&&(e=h);var r,s,i=new l(this._data),n=i.realvalues.length,a=t.Zero(n),o=t.Zero(n),u=0,c=t.Zero(n);for(i.vectors.forEach((function(t,e){return c.Row(e,t)})),r=0;r<n;r++){for(s=0;s<n;s++)a._data[r][s]=e;i.realvalues[r]>e&&(a._data[r][r]=i.realvalues[r])}for(r=0;r<n;r++){for(u=0,s=0;s<n;s++)o._data[r][s]=0,u+=i.vectors[r][s]*i.vectors[r][s]*a._data[s][s];o._data[r][r]=Math.sqrt(1/u)}for(r=0;r<n;r++)a._data[r][r]=Math.sqrt(a._data[r][r]);for(var d=o.Multiply(c.Multiply(a)),m=d.Multiply(d.Transpose()).Symmetrize(),f=0;f<m.rows;f++)m._data[f][f]=1;return m},t.prototype.Symmetrize=function(e){void 0===e&&(e=!1);var r,s,i=this.Transpose(),n=t.Clone(this);if(e)for(r=1;r<this.rows;r++)for(s=0;s<r;s++)n._data[r][s]=i._data[r][s];else for(s=1;s<this.columns;s++)for(r=0;r<s;r++)n._data[r][s]=i._data[r][s];return n},t.prototype.Cholesky=function(e){if(void 0===e&&(e=!1),this.rows!==this.columns)throw new Error("matrix not square");var r,s,i,n,a,o=this.rows,l=t.Zero(o);for(n=0;n<o;n++){for(s=0,a=0;a<n;a++){for(r=0,i=0;i<a;i++)r+=l._data[i][a]*l._data[i][n];if(l._data[a][n]=r=(this._data[a][n]-r)/l._data[a][a],s+=r*r,this._data[a][n]!=this._data[n][a])throw new Error("matrix not symmetrical")}if((s=this._data[n][n]-s)<=0)throw new Error("matrix not pos-def");for(l._data[n][n]=s>0?Math.sqrt(s):0,a=n+1;a<o;a++)l._data[a][n]=0}return e?l.Transpose():l},t.prototype.Multiply=function(e){var r,s,i,n,a=t.Zero(this.rows,e.columns);for(r=0;r<this.rows;r++)for(s=0;s<e.columns;s++){for(n=i=0;i<this.columns;i++)n+=this._data[r][i]*e._data[i][s];a._data[r][s]=n}return a},t.prototype.Inverse=function(){if(this.rows!==this.columns)throw new Error("invalid matrix");var e,r,s,i,n=t.Clone(this),a=n.rows;for(r=1;r<a;r++)n._data[0][r]/=n._data[0][0];for(r=1;r<a;r++){for(s=r;s<a;s++){for(e=0,i=0;i<r;i++)e+=n._data[s][i]*n._data[i][r];n._data[s][r]-=e}if(r!=a-1)for(s=r+1;s<a;s++){for(e=0,i=0;i<r;i++)e+=n._data[r][i]*n._data[i][s];n._data[r][s]=(n._data[r][s]-e)/n._data[r][r]}}for(r=0;r<a;r++)for(s=r;s<a;s++){var o=1;if(r!=s)for(o=0,i=r;i<s;i++)o-=n._data[s][i]*n._data[i][r];n._data[s][r]=o/n._data[s][s]}for(r=0;r<a;r++)for(s=r;s<a;s++)if(r!=s){for(e=0,i=r;i<s;i++)e+=n._data[i][s]*(r==i?1:n._data[r][i]);n._data[r][s]=-e}for(r=0;r<a;r++)for(s=0;s<a;s++){for(e=0,i=r>s?r:s;i<a;i++)e+=(s==i?1:n._data[s][i])*n._data[i][r];n._data[s][r]=e}return n},t.prototype.SortColumns=function(e){void 0===e&&(e=!1);for(var r=t.Clone(this),s=e?function(t,e){return e-t}:function(t,e){return t-e},i=0;i<this.columns;i++)r.Column(i,this.Column(i).sort(s));return r},t.prototype.Rank=function(e){void 0===e&&(e=!1);for(var s,i=t.Clone(this),n=new Array(this.rows),a=new Array(this.rows),o=0;o<this.columns;o++){for(s=0;s<this.rows;s++)a[s]=s,n[s]=this._data[s][o];for(r.Sort(n,a),e&&a.reverse(),s=0;s<this.rows;s++)i._data[a[s]][o]=s}return i},t.prototype.Correl=function(){for(var e=new Array(this.columns),r=0;r<this.columns;r++)e[r]=this.Column(r);for(var s=t.Zero(this.columns),i=0;i<this.columns;i++){s._data[i][i]=1;for(var a=0;a<i;a++)s._data[i][a]=n.Correlation(e[i],e[a])}return s.Symmetrize()},t.prototype.IsSymmetric=function(){if(this.rows!=this.columns)return!1;for(var t=0;t<this.rows;t++)for(var e=0;e<this.columns;e++)if(this._data[t][e]!==this._data[e][t])return!1;return!0},t}();Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length,r=0;r<e;r++){if(arguments[r]===1/0||arguments[r]===-1/0)return 1/0;t+=arguments[r]*arguments[r]}return Math.sqrt(t)});for(var c=function(){function t(){}return t.Normal=function(t,e){var r=this;void 0===e&&(e={});var i=s({mean:0,sd:1,lhs:!1,ordered:!1},e);return(i.lhs?this.LHSField(t,i.ordered):this.UniformField(t,i.ordered)).map((function(t){return r.InverseNormal2(t)*i.sd+i.mean}))},t.ReverseInverseNormal2=function(t,e){var r=this;void 0===e&&(e=40);for(var s=[0,Math.min(1,Math.max(0,.5+.125*t)),1],i=s.map((function(t){return r.InverseNormal2(t)})),n=0;n<e;n++){if(Math.abs(i[1]-t)<=1e-6)return s[1];i[1]<t?(s=[s[1],(s[1]+s[2])/2,s[2]],i=[i[1],this.InverseNormal2(s[1]),i[2]]):(s=[s[0],(s[0]+s[1])/2,s[1]],i=[i[0],this.InverseNormal2(s[1]),i[1]])}return s[1]},t.TruncatedNormal=function(t,e){var r=this;void 0===e&&(e={});var i=s({mean:0,sd:1,lhs:!1,ordered:!1},e),n=i.lhs?this.LHSField(t,i.ordered):this.UniformField(t,i.ordered),a=0,o=1;"number"==typeof i.min&&(a=this.ReverseInverseNormal2((i.min-i.mean)/i.sd,i.max_iterations)),"number"==typeof i.max&&(o=this.ReverseInverseNormal2((i.max-i.mean)/i.sd,i.max_iterations));var l=o-a;return(n=n.map((function(t){return t*l+a}))).map((function(t){return r.InverseNormal2(t)*i.sd+i.mean}))},t.LogNormal=function(t,e){void 0===e&&(e={});for(var r=s({mean:1,sd:1,lhs:!1,ordered:!1},e),i=r.lhs?this.LHSFieldDouble(t,r.ordered):this.UniformField(t,r.ordered),n=0;n<i.length;n++)i[n]=Math.exp(this.InverseNormal2(i[n])*r.sd+r.mean);return i},t.LogNormalReturn=function(t,e){void 0===e&&(e={});var r=s({mean:1,sd:1,lhs:!1,ordered:!1},e),i=r.lhs?this.LHSFieldDouble(t,r.ordered):this.UniformField(t,r.ordered);r.mean+=1;for(var n=r.mean*r.mean,a=r.sd*r.sd,o=Math.log(n/Math.sqrt(n+a)),l=Math.sqrt(Math.log((n+a)/n)),h=0;h<t;h++)i[h]=Math.exp(this.InverseNormal2(i[h])*l+o)-1;return i},t.Triangular=function(t,e){var r=this;void 0===e&&(e={});var i=s({a:0,b:1,c:.5,lhs:!1,ordered:!1,field:null},e);return(i.field||(i.lhs?this.LHSField(t,i.ordered):this.UniformField(t,i.ordered))).map((function(t){return r.InverseTriangular(t,i.a,i.b,i.c)}))},t.PERT=function(t,e){void 0===e&&(e={});var r=s({field:null,lhs:!1,a:0,b:1,c:.5,lambda:4,ordered:!1},e),i=r.field||(r.lhs?this.LHSField(t,r.ordered):this.UniformField(t,r.ordered));return this.InversePERTField(i,r.a,r.b,r.c,r.lambda)},t.Uniform=function(t,e){void 0===e&&(e={});for(var r=s({lhs:!1,min:0,max:1,ordered:!1},e),i=r.lhs?this.LHSFieldDouble(t,r.ordered):this.UniformField(t,r.ordered),n=r.max-r.min,a=0;a<i.length;a++)i[a]=i[a]*n+r.min;return i},t.Bernoulli=function(t,e){void 0===e&&(e={});var r=s({lhs:!1,p:.5},e);return this.Uniform(t,{lhs:r.lhs,min:0,max:1}).map((function(t){return t<=r.p}))},t.Beta=function(t,e){var r=this;void 0===e&&(e={});var i=s({lhs:!1,a:0,b:1,ordered:!1},e);return(i.lhs?this.LHSField(t,i.ordered):this.UniformField(t,i.ordered)).map((function(t){return r.InverseBeta(t,i.a,i.b)}))},t.Discretize=function(t,e){var r=t.slice(0);e=e||Math.round;for(var s=0;s<r.length;s++)r[s]=e(r[s]);return r},t.Constant=function(t,e){for(var r=new Array(t),s=0;s<t;s++)r[s]=e;return r},t.Fixed=function(t,e){void 0===e&&(e={}),e=s({value:0},e);for(var r=new Array(t),i=0;i<t;i++)r[i]=e.value;return r},t.Conditional=function(t,e,r,s,i,n){void 0===i&&(i=0);for(var a=n||this.Bernoulli(t,{lhs:!0,p:e}),o=r(Math.ceil(t*e),s),l=new Array(t),h=0,u=0;h<t;h++)l[h]=a[h]?o[u++]:i;return l},t.Correlate=function(t,e,r){void 0===r&&(r=!1);var s,i=e.length,n=e[0].length,a=u.Zero(n,i);for(s=0;s<i;s++)a.Column(s,this.VDWField(n));var o=a.Multiply(t.Cholesky(!0).Multiply(a.Correl().Cholesky(!0).Inverse()).Transpose()).Rank();return r?e.map((function(t,e){var r=new Array(t.length),i=o.Column(e);for(s=0;s<i.length;s++)r[s]=t[i[s]];return r})):e.map((function(t,e){var r=t.slice(0).sort((function(t,e){return t-e})),i=new Array(t.length),n=o.Column(e);for(s=0;s<n.length;s++)i[s]=r[n[s]];return i}))},t.CorrelateCDM=function(t,e,r){void 0===r&&(r=!1);var s,i=e.length,n=e[0].length,o=a.Zero(n,i);for(s=0;s<i;s++)o.SetColumn(s,this.VDWField(n));var l=new a;if(l.rows=n,l.columns=i,l.data=e.map((function(t){return new Float64Array(t)})),!r)throw new Error("E_NOTIMPL: correlateCDM !ordered");return o.Multiply(t.Cholesky(!0).Multiply(o.Correl().Cholesky(!0).Inverse()).Transpose()).Rank2(!1,l).data},t.P80Pert=function(t,e,r,s){var i=this.PERTParameters(t,e,r,s),n=(i.max-i.min)/(this.InverseBeta(.9,i.v,i.w)-this.InverseBeta(.1,i.v,i.w)),a=i.min-this.InverseBeta(.1,i.v,i.w)*n,o=i.max+(1-this.InverseBeta(.9,i.v,i.w))*n;return{a:a/i.scale,b:o/i.scale,c:r}},t.P80Triangular=function(t,e,r){var s,i=(r-t)/(e-t),n=i<.5;n&&(i=1-i);var a=2.1266864*i-.1596122-2.1742909*i*i+1.1087738*i*i*i;n&&(a=1-a);var o=(e-t)/(.6890868-.4434898*i+.35757*i*i);return{a:s=r-a*o,b:s+o,c:r}},t.BetaDensity=function(t,e,r){if("number"!=typeof t){for(var s=new Array(t.length),i=0;i<t.length;i++)t[i]<=0||t[i]>=1?s[i]=0:s[i]=Math.exp((e-1)*Math.log(t[i])+(r-1)*Math.log(1-t[i])-this.LnGamma(e)-this.LnGamma(r)+this.LnGamma(e+r));return s}return t<=0||t>=1?0:Math.exp((e-1)*Math.log(t)+(r-1)*Math.log(1-t)-this.LnGamma(e)-this.LnGamma(r)+this.LnGamma(e+r))},t.PERTDensity=function(t,e,r,s,i){void 0===i&&(i=4);var n,a,o=(e+r+i*s)/(i+2);return a=(n=s===o?i/2+1:(o-e)*(2*s-e-r)/((s-o)*(r-e)))*(r-o)/(o-e),this.BetaDensity(t,n,a)},t.NormalDensity=function(t){if("number"!=typeof t){for(var e=new Array(t.length),r=0;r<t.length;r++)e[r]=.398942280401433*Math.exp(-t[r]*t[r]/2);return e}return.398942280401433*Math.exp(-t*t/2)},t.Shuffle=function(t){var r,s,i;for(s=t.length-1;s>=0;s--)r=Math.floor(e.Next()*(s+1)),i=t[s],t[s]=t[r],t[r]=i;return t},t.VDWField=function(t){if(this.vdw_cache.length!==t){this.vdw_cache=new Float64Array(t);for(var e=0;e<t;e++)this.vdw_cache[e]=this.InverseNormal2((e+1)/(t+1))}var r=new Float64Array(this.vdw_cache);return this.Shuffle(r)},t.LHSFieldDouble=function(t,r){void 0===r&&(r=!1);for(var s=1/t,i=new Float64Array(t),n=0;n<t;n++)i[n]=e.Next()*s+n*s;return r||this.Shuffle(i),i},t.LHSField=function(t,r){void 0===r&&(r=!1);for(var s=1/t,i=new Array(t),n=0;n<t;n++)i[n]=e.Next()*s+n*s;return r||this.Shuffle(i),i},t.UniformField=function(t,r){void 0===r&&(r=!1);for(var s=new Array(t),i=0;i<t;i++)s[i]=e.Next();return r&&s.sort((function(t,e){return t-e})),s},t.InverseTriangular=function(t,e,r,s){return e===r?e:t<=(s-e)/(r-e)?e+Math.sqrt((r-e)*(s-e)*t):r-Math.sqrt((r-e)*(r-s)*(1-t))},t.InverseNormal=function(t){return.5===t?0:(e=t<1&&t>.5?1-t:t,s=(r=Math.sqrt(Math.log(1/Math.pow(e,2))))-(2.515517+.802853*r+.010328*Math.pow(r,2))/(1+1.432788*r+.189269*Math.pow(r,2)+.001308*Math.pow(r,3)),t>.5?s:-s);var e,r,s},t.InverseNormal2=function(t){var e,r,s=t-.5;return Math.abs(s)<=.425?s*(((((((2509.0809287301227*(r=.180625-s*s)+33430.57558358813)*r+67265.7709270087)*r+45921.95393154987)*r+13731.69376550946)*r+1971.5909503065513)*r+133.14166789178438)*r+3.3871328727963665)/(((((((5226.495278852854*r+28729.085735721943)*r+39307.89580009271)*r+21213.794301586597)*r+5394.196021424751)*r+687.1870074920579)*r+42.31333070160091)*r+1):(r=s<0?t:1-t)<=0?0:(e=(r=Math.sqrt(-Math.log(r)))<=5?(((((((.0007745450142783414*(r-=1.6)+.022723844989269184)*r+.2417807251774506)*r+1.2704582524523684)*r+3.6478483247632045)*r+5.769497221460691)*r+4.630337846156546)*r+1.4234371107496835)/(((((((1.0507500716444169e-9*r+.0005475938084995345)*r+.015198666563616457)*r+.14810397642748008)*r+.6897673349851)*r+1.6763848301838038)*r+2.053191626637759)*r+1):(((((((2.0103343992922881e-7*(r-=5)+27115555687434876e-21)*r+.0012426609473880784)*r+.026532189526576124)*r+.29656057182850487)*r+1.7848265399172913)*r+5.463784911164114)*r+6.657904643501103)/(((((((20442631033899397e-31*r+1.421511758316446e-7)*r+18463183175100548e-21)*r+.0007868691311456133)*r+.014875361290850615)*r+.1369298809227358)*r+.599832206555888)*r+1),s<0?-e:e)},t.Log1p=function(t){var e=1+t;return Math.log(e)-(e-1-t)/e},t.BetaContFrac=function(e,r,s,i){var n,a=2*Number.MIN_VALUE,o=0,l=1,h=1-(e+r)*s/(e+1);for(Math.abs(h)<a&&(h=t.QUIET_NAN),n=h=1/h;o<512;){var u,c=o+1,d=c*(r-c)*s/((e-1+2*c)*(e+2*c));if(h=1+d*h,l=1+d/l,Math.abs(h)<a&&(h=t.QUIET_NAN),Math.abs(l)<a&&(l=t.QUIET_NAN),n*=(h=1/h)*l,h=1+(d=-(e+c)*(e+r+c)*s/((e+2*c)*(e+2*c+1)))*h,l=1+d/l,Math.abs(h)<a&&(h=t.QUIET_NAN),Math.abs(l)<a&&(l=t.QUIET_NAN),n*=u=(h=1/h)*l,Math.abs(u-1)<2*t.EPSILON_DOUBLE)break;if(n*Math.abs(u-1)<i)break;++o}return o>=512?t.QUIET_NAN:n},t.BetaCDF=function(e,r,s){if(e<=0)return 0;if(e>=1)return 1;if(0===e)return 0;if(1===e)return 1;var i,n=-(this.LnGamma(r)+this.LnGamma(s)-this.LnGamma(r+s))+r*Math.log(e)+s*this.Log1p(-e),a=Math.exp(n);return e<(r+1)/(r+s+2)?(i=Math.abs(0/(1*a/r))*t.EPSILON_DOUBLE,a*this.BetaContFrac(r,s,e,i)/r*1+0):(i=Math.abs(1/(1*a/s))*t.EPSILON_DOUBLE,1*(1-a*this.BetaContFrac(s,r,1-e,i)/s)+0)},t.LnGamma=function(t){var e=t-1,r=e+5.5;r-=(e+.5)*Math.log(r);var s=1;return s+=76.18009173/(e+=1),s+=-86.50532033/(e+=1),s+=24.01409822/(e+=1),s+=-1.231739516/(e+=1),s+=.00120858003/(e+=1),s+=-536382e-11/(e+=1),-r+Math.log(2.50662827465*s)},t.BetaPDF=function(t,e,r){return t<0||t>1?0:Math.exp(this.LnGamma(e+r)-this.LnGamma(e)-this.LnGamma(r))*Math.pow(t,e-1)*Math.pow(1-t,r-1)},t.InverseBeta=function(t,e,r){var s,i,n,a,o,l,h,u,c=0;if(t<0||t>1||e<0||r<0)return 0;if(0===t)return 0;if(1===t)return 1;if(t>.5){var d=1-t;return d>.5?this.InverseBeta(1-d,e,r):1-this.InverseBeta(d,r,e)}if(i=e/(e+r),t<.1){var m=(Math.log(e)+this.LnGamma(e)+this.LnGamma(r)-this.LnGamma(e+r)+Math.log(t))/e;m<=0?(s=Math.exp(m),s*=Math.pow(1-s,-(r-1)/e)):s=i,s>i&&(s=i)}else s=i;do{if(a=t-this.BetaCDF(s,e,r),o=this.BetaPDF(s,e,r),0===a||c++>64)return s;u=-((e-1)/s-(r-1)/(1-s))*(n=a/Math.max(2*Math.abs(a/s),o))*n/2,l=h=n,Math.abs(u)<Math.abs(h)?l+=u:l*=2*Math.abs(h/u),s+l>0&&s+l<1?s+=l:s=Math.sqrt(s)*Math.sqrt(i)}while(Math.abs(h)>1e-10*s);return s},t.InversePERTField=function(t,e,r,s,i){var n=this;if(r<=e)return t.map((function(){return e}));try{var a=this.PERTParameters(e,r,s,i);return t.map((function(t){return(n.InverseBeta(t,a.v,a.w)*(a.max-a.min)+a.min)/a.scale}))}catch(s){return e===r?t.map((function(t){return e})):t.map((function(t){return 0}))}},t.PERTParameters=function(t,e,r,s){if(void 0===s&&(s=4),t>=e||s<0||r<t||r>e)throw new Error("Invalid parameters");for(var i,n,a=1;Math.abs(t)<1&&Math.abs(e)<1;)a*=10,t*=10,e*=10,r*=10;return i=(t+e+s*r)/(s+2),{v:n=(0===r?Math.abs(i-r):Math.abs((i-r)/r))<=1e-12?s/2+1:(i-t)*(2*r-t-e)/((r-i)*(e-t)),w:n*(e-i)/(i-t),min:t,max:e,scale:a}},t.InversePERT=function(t,e,r,s,i){void 0===i&&(i=4);var n=this.PERTParameters(e,r,s,i);return(this.InverseBeta(t,n.v,n.w)*(n.max-n.min)+n.min)/n.scale},t.EPSILON_DOUBLE=2220446049250313e-31,t.QUIET_NAN=Number.NaN,t.M_LN_SQRT_2PI=.9189385332046728,t.M_1_SQRT_2PI=.3989422804014327,t.vdw_cache=new Float64Array(0),t}(),d=new Array(256),m=0;m<256;++m)d[m]=(m+256).toString(16).substr(1);var f=function(){function t(){this.buffer=[],this.buffer=[];for(var t=0;t<16;t++)this.buffer[t]=Math.floor(256*e.Next())}return t.prototype.toString=function(){var t=0;return d[this.buffer[t++]]+d[this.buffer[t++]]+d[this.buffer[t++]]+d[this.buffer[t++]]+"-"+d[this.buffer[t++]]+d[this.buffer[t++]]+"-"+d[this.buffer[t++]]+d[this.buffer[t++]]+"-"+d[this.buffer[t++]]+d[this.buffer[t++]]+"-"+d[this.buffer[t++]]+d[this.buffer[t++]]+d[this.buffer[t++]]+d[this.buffer[t++]]+d[this.buffer[t++]]+d[this.buffer[t++]]},t}();t.CDMatrix=a,t.Eigensystem=l,t.MC=c,t.Matrix=u,t.QSort=i,t.QSort2=r,t.Random=e,t.Stats=n,t.UUID=f,t.Util=o,Object.defineProperty(t,"__esModule",{value:!0})}(e)}},e={};function r(s){var i=e[s];if(void 0!==i)return i.exports;var n=e[s]={exports:{}};return t[s].call(n.exports,n,n.exports,r),n.exports}(()=>{"use strict";class t{constructor(t,e=t,r=!1){this.end_=this.PatchNull(e),this.start_=this.PatchNull(t),r&&this.Normalize()}static FromColumn(e){return new t({row:1/0,column:e})}static FromRow(e){return new t({row:e,column:1/0})}static ColumnToLabel(t){let e=String.fromCharCode(65+t%26);for(;t>25;)t=Math.floor(t/26)-1,e=String.fromCharCode(65+t%26)+e;return e}static CellAddressToLabel(t,e=!1){return(e?`${t.sheet_id||0}!`:"")+(t.absolute_column?"$":"")+this.ColumnToLabel(t.column)+(t.absolute_row?"$":"")+(t.row+1)}static Join(e,...r){const s=new t(e.start,e.end);for(const t of r)t&&(s.ConsumeAddress(t.start),s.ConsumeAddress(t.end));return s}static Bleed(e,r=1){return new t({row:Math.max(0,e.start.row-r),column:Math.max(0,e.start.column-r)},{row:e.end.row+r,column:e.end.column+r})}get start(){return Object.assign({},this.start_)}set start(t){this.start_=t}get end(){return Object.assign({},this.end_)}set end(t){this.end_=t}get rows(){return this.start_.row===1/0||this.end_.row===1/0?1/0:this.end_.row-this.start_.row+1}get columns(){return this.start_.column===1/0||this.end_.column===1/0?1/0:this.end_.column-this.start_.column+1}get count(){return this.rows*this.columns}get entire_sheet(){return this.entire_row&&this.entire_column}get entire_column(){return this.start_.row===1/0}get entire_row(){return this.start_.column===1/0}PatchNull(t){const e=Object.assign({},t);return null===e.row&&(e.row=1/0),null===e.column&&(e.column=1/0),e}SetSheetID(t){this.start_.sheet_id=t}Normalize(){const t=Object.assign({},this.start_),e=Object.assign({},this.end_);t.row===1/0||e.row===1/0?t.row=e.row=1/0:t.row>e.row&&(t.row=this.end_.row,t.absolute_row=this.end_.absolute_row,e.row=this.start_.row,e.absolute_row=this.start_.absolute_row),t.column===1/0||e.column===1/0?t.column=e.column=1/0:t.column>e.column&&(t.column=this.end_.column,t.absolute_column=this.end_.absolute_column,e.column=this.start_.column,e.absolute_column=this.start_.absolute_column),this.start_=t,this.end_=e}TopLeft(){const t={row:0,column:0};return this.entire_row||(t.column=this.start.column),this.entire_column||(t.row=this.start.row),t}BottomRight(){const t={row:0,column:0};return this.entire_row||(t.column=this.end.column),this.entire_column||(t.row=this.end.row),t}ContainsRow(t){return this.entire_column||t>=this.start_.row&&t<=this.end_.row}ContainsColumn(t){return this.entire_row||t>=this.start_.column&&t<=this.end_.column}Contains(t){return(this.entire_column||t.row>=this.start_.row&&t.row<=this.end_.row)&&(this.entire_row||t.column>=this.start_.column&&t.column<=this.end_.column)}ContainsArea(t){return this.start.column<=t.start.column&&this.end.column>=t.end.column&&this.start.row<=t.start.row&&this.end.row>=t.end.row}Intersects(t){return!(t.start.column>this.end.column||this.start.column>t.end.column||t.start.row>this.end.row||this.start.row>t.end.row)}Equals(t){return t.start_.row===this.start_.row&&t.start_.column===this.start_.column&&t.end_.row===this.end_.row&&t.end_.column===this.end_.column}Clone(){return new t(this.start,this.end)}Array(){if(this.entire_column||this.entire_row)throw new Error("can't convert infinite area to array");const t=new Array(this.rows*this.columns),e=this.start_.sheet_id;let r=0;for(let s=this.start_.row;s<=this.end_.row;s++)for(let i=this.start_.column;i<=this.end_.column;i++)t[r++]={row:s,column:i,sheet_id:e};return t}get left(){const e=new t(this.start_,this.end_);return e.end_.column=e.start_.column,e}get right(){const e=new t(this.start_,this.end_);return e.start_.column=e.end_.column,e}get top(){const e=new t(this.start_,this.end_);return e.end_.row=e.start_.row,e}get bottom(){const e=new t(this.start_,this.end_);return e.start_.row=e.end_.row,e}Shift(t,e){return this.start_.row+=t,this.start_.column+=e,this.end_.row+=t,this.end_.column+=e,this}ConsumeAddress(t){this.entire_row||(t.column<this.start_.column&&(this.start_.column=t.column),t.column>this.end_.column&&(this.end_.column=t.column)),this.entire_column||(t.row<this.start_.row&&(this.start_.row=t.row),t.row>this.end_.row&&(this.end_.row=t.row))}ConsumeArea(t){this.ConsumeAddress(t.start),this.ConsumeAddress(t.end)}Resize(t,e){return this.end_.row=this.start_.row+t-1,this.end_.column=this.start_.column+e-1,this}Iterate(t){if(this.entire_column||this.entire_row)console.warn("don't iterate infinite area");else for(let e=this.start_.column;e<=this.end_.column;e++)for(let r=this.start_.row;r<=this.end_.row;r++)t({column:e,row:r,sheet_id:this.start_.sheet_id})}get spreadsheet_label(){let e;return this.entire_sheet?"":this.entire_column?(e=t.ColumnToLabel(this.start_.column),e+=":"+t.ColumnToLabel(this.end_.column),e):this.entire_row?(e=String(this.start_.row+1),e+=":"+(this.end_.row+1),e):(e=t.CellAddressToLabel(this.start_),this.columns>1||this.rows>1?e+":"+t.CellAddressToLabel(this.end_):e)}toJSON(){return{start:Object.assign({},this.start_),end:Object.assign({},this.end_)}}}var e;!function(t){t[t[void 0]=0]="undefined",t[t.formula=1]="formula",t[t.string=2]="string",t[t.number=3]="number",t[t.boolean=4]="boolean",t[t.object=5]="object",t[t.error=6]="error"}(e||(e={}));const s=t=>{switch(typeof t){case"undefined":return e.undefined;case"number":return e.number;case"boolean":return e.boolean;case"object":return null===t?e.undefined:e.object;case"string":return"="===t[0]?e.formula:e.string;default:return e.error}};var i;!function(t){t[t.List=0]="List",t[t.Date=1]="Date",t[t.Range=2]="Range",t[t.Number=3]="Number",t[t.Boolean=4]="Boolean"}(i||(i={}));class n{constructor(t,r){this.type=e.undefined,this.render_dirty=!0,void 0!==t&&this.Set(t,r)}static StringToColumn(t){let e=0;t=t.toUpperCase();for(let r=0;r<t.length;r++)e*=26,e+=t.charCodeAt(r)-64;return e-1}ValueIsNumber(){return this.type===e.number}ValueIsFormula(){return this.type===e.formula}ValueIsBoolean(){return this.type===e.boolean}FlushStyle(){this.formatted=this.rendered_type=this.style=void 0,this.render_dirty=!0}FlushArray(){this.area=void 0}FlushCache(){this.calculated=this.calculated_type=this.formatted=this.rendered_type=this.render_function=this.click_function=void 0,this.render_dirty=!0}Reset(){this.type=e.undefined,this.value=this.note=this.hyperlink=this.formatted=this.rendered_type=this.style=this.calculated=this.calculated_type=this.area=this.renderer_data=this.render_function=this.click_function=void 0,this.render_dirty=!0}Set(t,e=s(t)){this.value=t,this.type=e,this.formatted=this.rendered_type=this.style=this.calculated=this.calculated_type=this.render_function=this.click_function=this.area=void 0,this.render_dirty=!0}SetCalculatedValue(t,e=s(t)){this.calculated!==t&&(this.calculated=t,this.calculated_type=e,this.formatted=this.rendered_type=void 0,this.render_dirty=!0)}SetCalculatedValueOrError(t,r){void 0===r&&("object"==typeof t&&t.error?(r=e.error,t=t.error):r=s(t)),this.calculated!==t&&(this.calculated=t,this.calculated_type=r,this.formatted=this.rendered_type=void 0,this.render_dirty=!0)}GetValue(){return this.calculated_type?this.calculated:"string"==typeof this.value&&"'"===this.value[0]?this.value.slice(1):this.value}GetValue4(){return this.calculated_type?{type:this.calculated_type,value:this.calculated}:this.type===e.formula?{type:e.number,value:0}:{type:this.type,value:"string"==typeof this.value&&"'"===this.value[0]?this.value.slice(1):this.value}}SetNote(t){this.note=t,this.render_dirty=!0}SetCalculationError(t="ERR"){this.SetCalculatedValue(t,e.error)}SetArray(t){this.type=e.undefined,this.value=this.formatted=this.rendered_type=this.style=this.hyperlink=this.calculated=this.calculated_type=void 0,this.area=t,this.render_dirty=!0}SetArrayHead(t,e){this.type=s(e),this.value=e,this.formatted=this.rendered_type=this.style=this.calculated=this.calculated_type=void 0,this.area=t,this.render_dirty=!0}}function a(t,e){var r={};for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&e.indexOf(s)<0&&(r[s]=t[s]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(s=Object.getOwnPropertySymbols(t);i<s.length;i++)e.indexOf(s[i])<0&&Object.prototype.propertyIsEnumerable.call(t,s[i])&&(r[s[i]]=t[s[i]])}return r}Object.create,Object.create;const o=t=>t.type===e.formula,l=()=>({type:e.undefined,value:void 0}),h=(t,e)=>(void 0===e&&(e=s(t)),{value:t,type:e}),u=t=>!!t[0]&&(t=>!t.cells)(t[0]),c=t=>!!t[0]&&void 0!==t[0].row;class d{constructor(){this.data=[],this.rows_=0,this.columns_=0}get rows(){return this.rows_}get columns(){return this.columns_}EnsureRow(t){this.rows_=Math.max(t+1,this.rows_)}EnsureColumn(t){this.columns_=Math.max(t+1,this.columns_)}InsertColumns(t=0,e=1){this.data=this.data.map((r=>{if(r.length>=t){const s=r.slice(0,t);let i=t+e;return r.slice(t).forEach((t=>s[i++]=t)),s}return r})),this.columns_+=e}DeleteColumns(t,e=1){this.data.forEach((r=>r.splice(t,e))),this.columns_-=e}DeleteRows(t,e=1){this.data.splice(t,e),this.rows_-=e}InsertRows(t=0,e=1){const r=[t,0,[]];for(let t=1;t<e;t++)r.push([]);Array.prototype.splice.apply(this.data,r),this.rows_+=e}GetCell(t,e){const{row:r,column:s}=t;if(!this.data[r]){if(!e)return;this.data[r]=[],this.rows_=Math.max(this.rows_,r+1)}return this.data[r][s]||e&&(this.data[r][s]=new n,this.columns_=Math.max(this.columns_,s+1)),this.data[r][s]}EnsureCell(t){const{row:e,column:r}=t;let s=this.data[e];s||(this.data[e]=s=[],this.rows_=Math.max(this.rows_,e+1));let i=s[r];return i||(i=s[r]=new n,this.columns_=Math.max(this.columns_,r+1)),i}FromArray(t=[],e=!1){this.data=[];let r=0,s=0;if(e){s=t.length;for(let e=0;e<s;e++){const s=t[e];r=Math.max(r,s.length);for(let t=0;t<s.length;t++)this.data[t]||(this.data[t]=[]),this.data[t][e]=new n(s[t])}}else{r=t.length;for(let e=0;e<r;e++){const r=[],i=t[e];s=Math.max(s,i.length);for(let t=0;t<i.length;t++)r[t]=new n(i[t]);this.data[e]=r}}this.rows_=r,this.columns_=s}FromJSON(e=[]){if(this.data=[],!u(e)){const t=[];if(c(e))for(const r of e)for(const e of r.cells)t.push(Object.assign(Object.assign({},e),{row:r.row}));else for(const r of e)for(const e of r.cells)t.push(Object.assign(Object.assign({},e),{column:r.column}));e=t}for(const r of e){this.data[r.row]||(this.data[r.row]=[]);const e=new n(r.value);if(void 0!==r.calculated&&e.SetCalculatedValue(r.calculated,r.calculated_type),void 0!==r.note&&(e.note=r.note),void 0!==r.hyperlink&&(e.hyperlink=r.hyperlink),this.data[r.row][r.column]&&this.data[r.row][r.column].area&&(e.area=this.data[r.row][r.column].area),this.data[r.row][r.column]=e,r.area){const e=new t(r.area.start,r.area.end);for(let t=e.start.row;t<=e.end.row;t++)for(let r=e.start.column;r<=e.end.column;r++)this.data[t]||(this.data[t]=[]),this.data[t][r]||(this.data[t][r]=new n),this.data[t][r].area=e}if(r.merge_area){const e=new t(r.merge_area.start,r.merge_area.end);for(let t=e.start.row;t<=e.end.row;t++)for(let r=e.start.column;r<=e.end.column;r++)this.data[t]||(this.data[t]=[]),this.data[t][r]||(this.data[t][r]=new n),this.data[t][r].merge_area=e}r.validation&&(e.validation=r.validation)}this.rows_=this.data.length,this.columns_=this.data.reduce(((t,e)=>Math.max(t,e.length)),0)}toJSON(t={}){let r,s=0,i=0,n=this.data.length-1;t.subset&&(s=t.subset.start.column,i=t.subset.start.row,n=t.subset.end.row);const o=[];let l=-1,h=-1;const u={},c={};for(let a=i;a<=n;a++)if(this.data[a]){const i=this.data[a];r=i.length-1,t.subset&&(r=t.subset.end.column);for(let n=s;n<=r;n++){const r=i[n],s=r&&r.merge_area&&r.merge_area.start.row===a&&r.merge_area.start.column===n,d=r&&r.area&&r.area.start.row===a&&r.area.start.column===n,m=!r||r.type===e.string&&!r.value;if(r&&(!m||t.preserve_empty_strings)&&(s||r.type||r.calculated_type&&t.expand_arrays||r.calculated_type&&t.calculated_value||r.validation||t.decorated_cells&&r.style&&(r.style.fill||r.style.border_bottom||r.style.border_top||r.style.border_left||r.style.border_right))){const s={row:a,column:n,value:r.value};r.note&&(s.note=r.note),r.hyperlink&&(s.hyperlink=r.hyperlink),t.preserve_type&&(s.type=r.type),t.sheet_id&&(s.sheet_id=t.sheet_id),t.calculated_value&&void 0!==r.calculated&&(s.calculated=r.calculated,(t.preserve_type||r.calculated_type===e.error)&&(s.calculated_type=r.calculated_type)),r.area&&d&&(s.area=r.area.toJSON()),r.merge_area&&(s.merge_area=r.merge_area.toJSON()),r.validation&&(s.validation=r.validation),t.cell_style_refs&&t.cell_style_refs[n]&&t.cell_style_refs[n][a]&&(s.style_ref=t.cell_style_refs[n][a],t.cell_style_refs[n][a]=0),u[a]=a,c[n]=n,l=Math.max(a,l),h=Math.max(n,h),o.push(s)}}}if(t.nested){const t=Object.keys(u),e=Object.keys(c);if(t.length<=e.length&&t.length){const e={},r=[];for(const t of o){const{row:r}=t,s=a(t,["row"]);e[t.row]||(e[t.row]=[]),e[t.row].push(s)}for(const s of t){const t=Number(s);r.push({row:t,cells:e[t]})}return{data:r,rows:l,columns:h+1}}if(e.length){const t={},r=[];for(const e of o){const{column:r}=e,s=a(e,["column"]);t[e.column]||(t[e.column]=[]),t[e.column].push(s)}for(const s of e){const e=Number(s);r.push({column:e,cells:t[e]})}return{data:r,rows:l,columns:h+1}}}return{data:o,rows:l+1,columns:h+1}}GetAll(t=!1){return this.GetRange({row:0,column:0},{row:this.rows_-1,column:this.columns_-1},t)}Normalize2(t,e){return t.column===1/0&&(t=Object.assign(Object.assign({},t),{column:0})),t.row===1/0&&(t=Object.assign(Object.assign({},t),{row:0})),e.column===1/0&&(e=Object.assign(Object.assign({},e),{column:this.columns_-1})),e.row===1/0&&(e=Object.assign(Object.assign({},e),{row:this.rows_-1})),{from:t,to:e}}Normalize1(t){return t.column===1/0&&(t=Object.assign(Object.assign({},t),{column:0})),t.row===1/0&&(t=Object.assign(Object.assign({},t),{row:0})),t}RawValue(t,e=t){if(({from:t,to:e}=this.Normalize2(t,e)),t.row===e.row&&t.column===e.column)return this.data[t.row]&&this.data[t.row][t.column]?this.data[t.row][t.column].value:void 0;const r=[],s=this.data.slice(t.row,e.row+1),i=t.column,n=e.column+1;for(const t of s){const e=[];for(let r=i,s=0;r<n;r++,s++){const s=t[r];e.push(s?s.value:void 0)}r.push(e)}return r}GetRange(t,e,r=!1){if(e?({from:t,to:e}=this.Normalize2(t,e)):t=this.Normalize1(t),!e||t===e||t.column===e.column&&t.row===e.row)return this.data[t.row]&&this.data[t.row][t.column]?this.data[t.row][t.column].GetValue():void 0;const s=[];if(r)for(let r=t.column;r<=e.column;r++){const i=[];for(let s=t.row;s<=e.row;s++)this.data[s]&&this.data[s][r]?i.push(this.data[s][r].GetValue()):i.push(void 0);s.push(i)}else for(let r=t.row;r<=e.row;r++){const i=[];for(let s=t.column;s<=e.column;s++)this.data[r]&&this.data[r][s]?i.push(this.data[r][s].GetValue()):i.push(void 0);s.push(i)}return s}GetRange4(t,r=t,s=!1){if(({from:t,to:r}=this.Normalize2(t,r)),t.row===r.row&&t.column===r.column)return this.data[t.row]&&this.data[t.row][t.column]?this.data[t.row][t.column].GetValue4():{value:void 0,type:e.undefined};const i=[];if(s)for(let e=t.column;e<=r.column;e++){const s=[];for(let i=t.row;i<=r.row;i++)this.data[i]&&this.data[i][e]?s.push(this.data[i][e].GetValue4()):s.push(l());i.push(s)}else for(let e=t.row;e<=r.row;e++){const s=[];for(let i=t.column;i<=r.column;i++)this.data[e]&&this.data[e][i]?s.push(this.data[e][i].GetValue4()):s.push(l());i.push(s)}return i}Apply(e,r,s=!1){var i;if("object"==typeof(i=e)&&void 0!==i.row&&void 0!==i.column&&(e=new t(e)),e.entire_column||e.entire_row)throw new Error("don't iterate infinite cells");const a=e.start,o=e.end;if(s)for(let t=a.row;t<=o.row;t++){this.data[t]||(this.data[t]=[]);const e=this.data[t];for(let s=a.column;s<=o.column;s++)e[s]||(e[s]=new n),r(e[s],s,t)}else for(let t=a.row;t<=o.row;t++)if(this.data[t]){const e=this.data[t];for(let s=a.column;s<=o.column;s++)e[s]&&r(e[s],s,t)}}SetArea(t,e){if(ArrayBuffer.isView(e))throw new Error("ABIV");if(Array.isArray(e))for(let r=t.start.row,s=0;r<=t.end.row;r++,s++){this.data[r]||(this.data[r]=[]);const i=this.data[r];if(e[s])for(let r=t.start.column,a=0;r<=t.end.column;r++,a++)i[r]||(i[r]=new n),i[r].Set(e[s][a])}else{const r=s(e);for(let s=t.start.row;s<=t.end.row;s++){this.data[s]||(this.data[s]=[]);const i=this.data[s];for(let s=t.start.column;s<=t.end.column;s++)i[s]||(i[s]=new n),i[s].Set(e,r)}}this.rows_=Math.max(this.rows_,t.end.row+1),this.columns_=Math.max(this.columns_,t.end.column+1)}IterateAll(t){for(const e of this.data)if(e)for(const r of e)r&&t(r)}FlushCellStyles(){for(const t of this.data)if(t)for(const e of t)e&&e.FlushStyle()}FlushCachedValues(){for(const t of this.data)if(t)for(const e of t)e&&e.FlushCache()}}class m{static UpdateLocale(t){var e;if(t)this.locale=t;else if("undefined"!=typeof self){const t=null===(e=null===self||void 0===self?void 0:self.document)||void 0===e?void 0:e.location;if(t&&t.search&&/locale=([^?&]+?)(?:\?|$|&)/.test(t.search)){const e=t.search.match(/locale=(.*?)(?:\?|$|&)/);e&&(this.locale=e[1]),console.info("override locale",this.locale)}else"undefined"!=typeof navigator&&(navigator.languages&&navigator.languages[0]?this.locale=navigator.languages[0]:this.locale=navigator.language)}const r=new Intl.NumberFormat(this.locale,{minimumFractionDigits:1}).format(3.3).replace(/\d/g,"");this.decimal_separator=","===r?",":".",","===this.decimal_separator&&(this.argument_separator=";",this.grouping_separator=" ");let s=new Date(2e3,0,2,12,0,0,0);this.UpdateDateComponent(0,0,s),s=new Date(2e3,1,7,12,0,0,0),this.UpdateDateComponent(1,1,s),s=new Date(2e3,2,7,12,0,0,0),this.UpdateDateComponent(2,2,s),s=new Date(2e3,3,5,12,0,0,0),this.UpdateDateComponent(3,3,s),s=new Date(2e3,4,4,12,0,0,0),this.UpdateDateComponent(4,4,s),s=new Date(2e3,5,2,12,0,0,0),this.UpdateDateComponent(5,5,s),s=new Date(2e3,6,1,12,0,0,0),this.UpdateDateComponent(6,6,s),s=new Date(2e3,7,1,12,0,0,0),this.UpdateDateComponent(7,-1,s),s=new Date(2e3,8,1,12,0,0,0),this.UpdateDateComponent(8,-1,s),s=new Date(2e3,9,1,12,0,0,0),this.UpdateDateComponent(9,-1,s),s=new Date(2e3,10,1,12,0,0,0),this.UpdateDateComponent(10,-1,s),s=new Date(2e3,11,1,12,0,0,0),this.UpdateDateComponent(11,-1,s)}static UpdateDateComponent(t,e,r){e>=0&&(this.date_components.short_days[e]=r.toLocaleString(this.locale,{weekday:"short"}),this.date_components.long_days[e]=r.toLocaleString(this.locale,{weekday:"long"})),t>=0&&(this.date_components.short_months[t]=r.toLocaleString(this.locale,{month:"short"}),this.date_components.long_months[t]=r.toLocaleString(this.locale,{month:"long"}))}}m.locale="en-us",m.decimal_separator=".",m.argument_separator=",",m.grouping_separator=",",m.date_components={short_days:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],long_days:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],short_months:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],long_months:["January","February","March","April","May","June","July","August","September","October","November","December"]},m.UpdateLocale();class f{constructor(t=0,e=0,r=0,s=0){this.left=t,this.top=e,this.width=r,this.height=s}get right(){return this.left+this.width}get bottom(){return this.top+this.height}static Create(t){return new f(t.left||0,t.top||0,t.width||0,t.height||0)}static IsRectangle(t){var e,r,s,i;return"object"==typeof t&&"number"==typeof(null===(e=t)||void 0===e?void 0:e.left)&&"number"==typeof(null===(r=t)||void 0===r?void 0:r.top)&&"number"==typeof(null===(s=t)||void 0===s?void 0:s.width)&&"number"==typeof(null===(i=t)||void 0===i?void 0:i.height)}Shift(t=0,e=0){return new f(this.left+t,this.top+e,this.width,this.height)}Scale(t=1,e=t){return new f(this.left*t,this.top*e,this.width*t,this.height*e)}Expand(t=0,e=0){return new f(this.left,this.top,this.width+t,this.height+e)}Combine(t){return new f(Math.min(this.left,t.left),Math.min(this.top,t.top),Math.max(this.right,t.right)-Math.min(this.left,t.left),Math.max(this.bottom,t.bottom)-Math.min(this.top,t.top))}CheckEdges(t,e,r=16){let s=0;return t-this.left<r&&(s|=1),this.right-t<r&&(s|=2),e-this.top<r&&(s|=4),this.bottom-e<r&&(s|=8),s}Contains(t,e,r=0){return t>=this.left-r&&t<=this.left+this.width+r&&e>=this.top-r&&e<=this.top+this.height+r}ContextFill(t){t.fillRect(this.left,this.top,this.width,this.height)}ContextStroke(t){t.strokeRect(this.left,this.top,this.width,this.height)}Clamp(t,e){return{x:t=Math.min(Math.max(t,this.left),this.right),y:e=Math.min(Math.max(e,this.top),this.bottom)}}ApplyStyle(t){t.style.top=this.top+"px",t.style.left=this.left+"px",t.style.width=this.width+"px",t.style.height=this.height+"px"}toJSON(){return{top:this.top,left:this.left,width:this.width,height:this.height}}}var p,_,g;!function(t){const e=JSON.stringify({});let r,s;!function(t){t[t.None=0]="None",t[t.Left=1]="Left",t[t.Center=2]="Center",t[t.Right=3]="Right"}(r=t.HorizontalAlign||(t.HorizontalAlign={})),function(t){t[t.None=0]="None",t[t.Top=1]="Top",t[t.Bottom=2]="Bottom",t[t.Middle=3]="Middle"}(s=t.VerticalAlign||(t.VerticalAlign={})),t.DefaultProperties={horizontal_align:r.None,vertical_align:s.None,number_format:"General",nan:"NaN",font_size_value:10,font_size_unit:"pt",font_face:"calibri",font_bold:!1,font_italic:!1,font_underline:!1,font_strike:!1,text:{theme:1},border_top:0,border_left:0,border_right:0,border_bottom:0},t.Merge=(t,e,r=!0)=>{const s=r?Object.assign(Object.assign({},t),e):Object.assign({},e);return JSON.parse(JSON.stringify(s))},t.Composite=t=>JSON.parse(JSON.stringify(t.reduce(((t,e)=>Object.assign(Object.assign({},t),e)),{}))),t.Empty=t=>JSON.stringify(t)===e,t.ValidColor=t=>!(!t||t.none||!t.text&&!t.theme&&0!==t.theme),t.Font=(t,e=1)=>{const r=[];return t.font_weight?r.push(t.font_weight.toString()):t.font_bold&&r.push("bold"),t.font_italic&&r.push("italic"),r.push(((t.font_size_value||0)*e).toFixed(2)+(t.font_size_unit||"pt")),r.push(t.font_face||""),r.join(" ")}}(p||(p={})),function(t){t[t.default=0]="default",t[t.hidden=1]="hidden",t[t.padded=2]="padded",t[t.date_component=3]="date_component",t[t.date_component_minutes=4]="date_component_minutes",t[t.literal=5]="literal",t[t.formatting=6]="formatting"}(_||(_={})),new class{Darken(t,e,r,s,i=!1){let{h:n,s:a,l:o}=this.RGBToHSL(t,e,r);return o-=i?o*s/100:s/100,o=Math.max(0,Math.min(1,o)),this.HSLToRGB(n,a,o)}Lighten(t,e,r,s,i=!1){let{h:n,s:a,l:o}=this.RGBToHSL(t,e,r);return o+=i?o*s/100:s/100,o=Math.max(0,Math.min(1,o)),this.HSLToRGB(n,a,o)}RGBToHSL(t,e,r){t/=255,e/=255,r/=255;const s=Math.max(t,e,r),i=Math.min(t,e,r);let n=0,a=0;const o=(s+i)/2;if(s===i)n=a=0;else{const l=s-i;switch(a=o>.5?l/(2-s-i):l/(s+i),s){case t:n=(e-r)/l+(e<r?6:0);break;case e:n=(r-t)/l+2;break;case r:n=(t-e)/l+4}n/=6}return{h:360*n,s:a,l:o}}HSLToRGB(t,e,r){let s,i,n;if(0===e)s=i=n=r;else{t/=360;const a=r<.5?r*(1+e):r+e-r*e,o=2*r-a;s=this.HueToRGB(o,a,t+1/3),i=this.HueToRGB(o,a,t),n=this.HueToRGB(o,a,t-1/3)}return{r:Math.round(255*s),g:Math.round(255*i),b:Math.round(255*n)}}HueToRGB(t,e,r){return r<0&&(r+=1),r>1&&(r-=1),r<1/6?t+6*(e-t)*r:r<.5?e:r<2/3?t+(e-t)*(2/3-r)*6:t}};class y{constructor(){this.date_format=!1,this.string_format=!1,this.fraction_format=!1,this.twelve_hour=!1,this.fraction_denominator=0,this.fraction_integer=!0,this.fraction_align=0,this.fraction_denominator_digits=0,this.integer_min_digits=0,this.decimal_min_digits=0,this.decimal_max_digits=0,this.grouping=!1,this.has_number_format=!1,this.prefix=[{text:""}],this.suffix=[{text:""}],this.scaling=0,this.percent=!1,this.exponential=!1,this.has_asterisk=!1}}!function(t){t[t.Integer=0]="Integer",t[t.Decimal=1]="Decimal"}(g||(g={}));class v{static Parse(t){if(this.pattern=t,this.characters=t.split("").map((t=>t.charCodeAt(0))),this.char_index=0,this.current_section=new y,this.sections=[this.current_section],this.ParseDatePattern())return this.sections;for(this.char_index=0,this.current_section=new y,this.sections=[this.current_section];this.char_index<this.characters.length;)this.ConsumeChar();return this.sections}static ConsumeString(){let t="";for(this.preserve_formatting_characters&&(t+=this.pattern[this.char_index]),++this.char_index;this.char_index<this.characters.length;this.char_index++)switch(this.characters[this.char_index]){case 92:this.preserve_formatting_characters&&(t+=this.pattern[this.char_index]),this.char_index+1<this.characters.length&&(t+=this.pattern[++this.char_index]);break;case 34:return this.preserve_formatting_characters&&(t+=this.pattern[this.char_index]),this.char_index++,t;default:t+=this.pattern[this.char_index]}throw new Error("unterminated string")}static ConsumeFormatting(){let t="";for(++this.char_index;this.char_index<this.characters.length;this.char_index++)switch(this.characters[this.char_index]){case 92:throw new Error("invalid escape character in formatting block");case 93:return this.char_index++,t;default:t+=this.pattern[this.char_index]}throw new Error("unterminated format")}static ScanFractionFormat(){const t=this.pattern.substr(this.char_index).match(/^([#?]+ +){0,1}([#?]+)\/([#?0-9]+)(?:$|[^#?0-9])/);if(!t)return!1;const e=(t[1]||"").length+t[2].length+t[3].length+1;this.current_section.fraction_format=!0,this.current_section.fraction_integer=!!t[1];const r=Number(t[3]);return isNaN(r)||(this.current_section.fraction_denominator=r),this.current_section.decimal_max_digits=this.current_section.fraction_denominator_digits=t[3].length,this.char_index+=e,this.current_section.has_number_format=!0,!0}static ConsumeNumberFormat(){let t=g.Integer;for(this.char_index;this.char_index<this.characters.length;this.char_index++)switch(this.characters[this.char_index]){case this.group_separator:{let e=!1;for(let t=this.char_index+1;!e&&t<this.characters.length;t++){const r=this.characters[t];if(r===this.decimal_mark||35===r||48===r)e=!0;else if(44!==r)break}if(e){if(t===g.Decimal)throw new Error("invalid grouping in decimal part");this.current_section.grouping=!0}else this.current_section.scaling=1e3*(this.current_section.scaling||1)}break;case this.decimal_mark:if(t===g.Decimal)throw new Error("too many decimal marks");t=g.Decimal;break;case 35:t===g.Decimal?this.current_section.decimal_max_digits++:this.current_section.integer_min_digits&&this.current_section.integer_min_digits++;break;case 48:t===g.Decimal?(this.current_section.decimal_max_digits++,this.current_section.decimal_min_digits=this.current_section.decimal_max_digits):this.current_section.integer_min_digits++;break;default:return}}static AppendCharAsText(t=!0){this.current_section.has_number_format?this.current_section.suffix[this.current_section.suffix.length-1].text+=this.pattern[this.char_index]:this.current_section.prefix[this.current_section.prefix.length-1].text+=this.pattern[this.char_index],t&&this.char_index++}static AppendString(t){this.current_section.has_number_format?this.current_section.suffix[this.current_section.suffix.length-1].text+=t:this.current_section.prefix[this.current_section.prefix.length-1].text+=t}static AppendTextPart(t){this.current_section.has_number_format?(this.current_section.suffix.push(t),this.current_section.suffix.push({text:""})):(this.current_section.prefix.push(t),this.current_section.prefix.push({text:""}))}static ConsumeChar(){const t=this.characters[this.char_index];if(63!==t&&35!==t||this.current_section.has_number_format||this.current_section.string_format||!this.ScanFractionFormat())switch(t){case 59:this.char_index++,this.current_section=new y,3===this.sections.length&&(this.current_section.string_format=!0),this.sections.push(this.current_section);break;case 64:this.char_index++,this.AppendTextPart({text:"@",flag:_.literal}),this.current_section.string_format=!0;break;case 48:case 35:case 46:case 44:this.current_section.has_number_format||this.current_section.string_format?this.AppendCharAsText():(this.ConsumeNumberFormat(),this.current_section.has_number_format=!0);break;case 91:this.AppendTextPart({text:this.ConsumeFormatting(),flag:_.formatting});break;case 34:this.AppendString(this.ConsumeString());break;case 63:this.preserve_formatting_characters?this.AppendCharAsText():(this.AppendTextPart({text:"0",flag:_.hidden}),this.char_index++);break;case 95:if(this.preserve_formatting_characters)this.AppendCharAsText();else{if(++this.char_index>=this.characters.length)throw new Error("invalid pad character at end");this.AppendTextPart({text:this.pattern[this.char_index++],flag:_.hidden})}break;case 42:if(this.current_section.has_asterisk)throw new Error("we don't support multiple asterisks");if(this.preserve_formatting_characters)this.AppendCharAsText();else{if(++this.char_index>=this.characters.length)throw new Error("invalid pad character at end");this.AppendTextPart({text:this.pattern[this.char_index++],flag:_.padded}),this.current_section.has_asterisk=!0}break;case 101:case 69:this.current_section.percent||this.current_section.exponential||this.current_section.string_format?this.AppendCharAsText():(this.current_section.exponential=!0,this.char_index++);break;case 37:this.current_section.exponential||this.current_section.string_format||(this.current_section.percent=!0),this.AppendCharAsText();break;case 92:if(this.preserve_formatting_characters&&this.AppendCharAsText(!1),++this.char_index>=this.characters.length)throw new Error("invalid escape character at end");this.AppendCharAsText();break;default:this.AppendCharAsText()}}static ParseDatePattern(){for(this.date_pattern=!0;this.date_pattern&&this.char_index<this.pattern.length;)this.DatePatternConsumeChar();if(this.date_pattern){this.date_pattern=!1;for(const t of this.sections)for(const e of t.prefix)e.flag&&e.flag&(_.date_component|_.date_component_minutes)&&(this.date_pattern=!0)}return this.date_pattern&&(this.sections[0].date_format=!0,this.sections[0].prefix.forEach(((t,e)=>{if(t.flag===_.date_component&&("mm"===t.text||"m"===t.text)){if(e)for(let r=e-1;r;r--){const e=this.sections[0].prefix[r];if(e.flag===_.date_component){/h/i.test(e.text)&&(t.flag=_.date_component_minutes,t.text=t.text.toLowerCase());break}}if(e<this.sections[0].prefix.length-1)for(let r=e+1;r<this.sections[0].prefix.length;r++){const e=this.sections[0].prefix[r];if(e.flag===_.date_component){/s/i.test(e.text)&&(t.flag=_.date_component_minutes,t.text=t.text.toLowerCase());break}}}}))),this.date_pattern}static ConsumeDatePart(){const t=this.pattern[this.char_index++],e=t.toLowerCase(),r={text:t,flag:_.date_component};for(;this.pattern[this.char_index]&&this.pattern[this.char_index].toLowerCase()===e;)r.text+=this.pattern[this.char_index++];if("s"===e&&"."===this.pattern[this.char_index])for(r.text+=this.pattern[this.char_index++];"0"===this.pattern[this.char_index];)r.text+=this.pattern[this.char_index++];return r}static ConsumeAMPM(){let t=this.pattern.substr(this.char_index,5);return"am/pm"===t||"AM/PM"===t?(this.char_index+=5,this.sections[0].twelve_hour=!0,{text:t,flag:_.date_component}):(t=this.pattern.substr(this.char_index,3),"a/p"===t||"A/P"===t?(this.char_index+=3,this.sections[0].twelve_hour=!0,{text:t,flag:_.date_component}):void 0)}static DatePatternConsumeChar(){switch(this.characters[this.char_index]){case 59:this.char_index=this.characters.length;break;case 48:case 35:case 101:case 69:case 37:case 64:this.date_pattern=!1;break;case 72:case 104:case 77:case 109:case 83:case 115:case 68:case 100:case 89:case 121:this.AppendTextPart(this.ConsumeDatePart());break;case 65:case 97:{const t=this.ConsumeAMPM();t?this.AppendTextPart(t):this.AppendCharAsText()}break;case 34:this.AppendString(this.ConsumeString());break;case 63:this.preserve_formatting_characters?this.AppendCharAsText():(this.AppendTextPart({text:"0",flag:_.hidden}),this.char_index++);break;case 95:if(this.preserve_formatting_characters)this.AppendCharAsText();else{if(++this.char_index>=this.characters.length)throw new Error("invalid pad character at end");this.AppendTextPart({text:this.pattern[this.char_index++],flag:_.hidden})}break;case 42:if(this.current_section.has_asterisk)throw new Error("we don't support multiple asterisks");if(this.preserve_formatting_characters)this.AppendCharAsText();else{if(++this.char_index>=this.characters.length)throw new Error("invalid pad character at end");this.AppendTextPart({text:this.pattern[this.char_index++],flag:_.padded}),this.current_section.has_asterisk=!0}break;case 92:if(this.preserve_formatting_characters&&this.AppendCharAsText(!1),++this.char_index>=this.characters.length)throw new Error("invalid escape character at end");this.AppendCharAsText();break;default:this.AppendCharAsText()}}}v.date_pattern=!1,v.pattern="",v.char_index=0,v.characters=[],v.sections=[],v.current_section=new y,v.preserve_formatting_characters=!1,v.decimal_mark=46,v.group_separator=44;const b=t=>(t>=60&&t--,new Date(864e5*t-22090752e5)),w=(t,e=!0)=>{if(e){const e=new Date(t),r=new Date;r.setUTCMilliseconds(e.getUTCMilliseconds()),r.setUTCSeconds(e.getUTCSeconds()),r.setUTCMinutes(e.getUTCMinutes()),r.setUTCHours(e.getHours()),r.setUTCDate(e.getDate()),r.setUTCMonth(e.getMonth()),r.setUTCFullYear(e.getFullYear()),t=r.getTime()}return(t=(t+22090752e5)/864e5)>=60&&t++,t};class x{constructor(t){if(this._pattern="",this.decimal_zero_regexp=[],this.cloned=[],this.magic_decimal=!1,this._pattern=t,this.sections=v.Parse(t),this.sections.length||(this.sections=[]),this.sections[0]||(this.sections[0]=new y),this.sections[1]||(this.sections[1]=Object.assign({},this.sections[0]),this.sections[1].prefix=JSON.parse(JSON.stringify(this.sections[1].prefix)),this.sections[1].suffix=JSON.parse(JSON.stringify(this.sections[1].suffix)),this.sections[1].prefix.push({text:"-"}),this.cloned[1]=!0),this.sections[2]||(this.sections[2]=Object.assign({},this.sections[0]),this.cloned[2]=!0),!this.sections[3])for(const t of this.sections[0].prefix)if(t.flag===_.literal){this.sections[3]=Object.assign({},this.sections[0]),this.sections[3].string_format=!0,this.cloned[3]=!0;break}this.decimal_zero_regexp=this.sections.map((t=>{if(t.decimal_max_digits>t.decimal_min_digits)return new RegExp(`0{1,${t.decimal_max_digits-t.decimal_min_digits}}(?:$|e)`)}))}static FormatPartsAsText(t,e=0){let r=-1;const s=t.map(((t,e)=>{switch(t.flag){case _.padded:return r=e,t.text;case _.hidden:return t.text.replace(/./g," ");case _.formatting:return"";default:return t.text}}));if(r>=0&&e){const t=s.reduce(((t,e,s)=>s===r?t:t+e.length),0);let i="";for(let n=0;n<e-t;n++)i+=s[r];s[r]=i}return s.join("")}get pattern(){return this._pattern}get date_format(){return this.sections[0]&&this.sections[0].date_format}IncreaseDecimal(){this.sections.forEach((t=>{t.decimal_min_digits++,t.decimal_max_digits=t.decimal_min_digits}))}DecreaseDecimal(){this.sections.forEach((t=>{t.decimal_min_digits=Math.max(0,t.decimal_min_digits-1),t.decimal_max_digits=t.decimal_min_digits}))}AddGrouping(){this.sections.forEach((t=>{t.grouping=!0}))}RemoveGrouping(){this.sections.forEach((t=>{t.grouping=!1}))}ToggleGrouping(){const t=!this.sections[0].grouping;this.sections.forEach((e=>{e.grouping=t}))}toString(){return this.sections[0].date_format?this._pattern:this.sections.filter(((t,e)=>!this.cloned[e])).map((t=>{let e="",r=0;if(t.fraction_format){t.fraction_integer&&(e+="? ");let r="";for(let e=0;e<t.fraction_denominator_digits;e++)r+="#";e+=r,e+="/",t.fraction_denominator?e+=t.fraction_denominator:e+=r}else if(t.has_number_format){for(r=0;r<t.integer_min_digits;r++)e+="0";if(t.grouping&&(e.length<4&&(e=("####"+e).slice(-4)),e=e.replace(/[\d#]{1,3}(?=([\d#]{3})+(?![\d#]))/g,"$&,")),t.decimal_max_digits||t.decimal_min_digits){for(e+=".",r=0;r<t.decimal_min_digits;r++)e+="0";for(;r<t.decimal_max_digits;r++)e+="#"}if(t.scaling){const s=Math.log10(t.scaling)/3;for(r=0;r<s;r++)e+=","}t.exponential&&(e+="e")}return t.prefix.map((t=>t.flag===_.hidden?"0"===t.text?"?":"_"+t.text:t.flag===_.padded?"*"+t.text:t.flag===_.formatting?"["+t.text+"]":t.text)).join("")+e+t.suffix.map((t=>t.flag===_.hidden?"0"===t.text?"?":"_"+t.text:t.flag===_.padded?"*"+t.text:t.text)).join("")})).join(";")}FormatParts(t){if("number"!=typeof t&&!this.sections[3])return[{text:t.toString()}];const{parts:e,section:r}=this.BaseFormat(t);let s=[];if(r.date_format||r.string_format)for(const t of e)"string"==typeof t?s.push({text:t}):s.push(t);else this.magic_decimal&&""===e[1]&&e.splice(1,1),s=[...r.prefix.map((t=>Object.assign({},t))),{text:r.has_number_format?e.join(m.decimal_separator):""},...r.suffix.map((t=>Object.assign({},t)))];for(let t=1;t<s.length;t++)s[t].flag===s[t-1].flag&&(s[t].text=s[t-1].text+s[t].text,s[t-1].text="");return s.filter((t=>t.text))}Format(t,e=0){return x.FormatPartsAsText(this.FormatParts(t),e)}ZeroPad(t,e){for(;t.length<e;)t="0"+t;return t}DateFormat(t){const e=b(t),r=this.sections[0];let s=e.getUTCHours();return r.twelve_hour&&(s>12&&(s-=12),0===s&&(s=12)),{parts:r.prefix.map((t=>{if(t.flag===_.date_component_minutes)return"mm"===t.text?{text:this.ZeroPad(e.getUTCMinutes().toString(),2)}:{text:this.ZeroPad(e.getUTCMinutes().toString(),1)};if(t.flag===_.date_component){switch(t.text.toLowerCase()){case"am/pm":case"a/p":{const r=t.text.split("/");return{text:e.getUTCHours()>12?r[1]:r[0]}}case"mmmmm":return{text:m.date_components.long_months[e.getUTCMonth()][0]};case"mmmm":return"MMMM"===t.text?{text:m.date_components.long_months[e.getUTCMonth()].toUpperCase()}:{text:m.date_components.long_months[e.getUTCMonth()]};case"mmm":return"MMM"===t.text?{text:m.date_components.short_months[e.getUTCMonth()].toUpperCase()}:{text:m.date_components.short_months[e.getUTCMonth()]};case"mm":return{text:this.ZeroPad((e.getUTCMonth()+1).toString(),2)};case"m":return{text:this.ZeroPad((e.getUTCMonth()+1).toString(),1)};case"ddddd":case"dddd":return"DDDDD"===t.text||"DDDD"===t.text?{text:m.date_components.long_days[e.getUTCDay()].toUpperCase()}:{text:m.date_components.long_days[e.getUTCDay()]};case"ddd":return"DDD"===t.text?{text:m.date_components.short_days[e.getUTCDay()].toUpperCase()}:{text:m.date_components.short_days[e.getUTCDay()]};case"dd":return{text:this.ZeroPad(e.getUTCDate().toString(),2)};case"d":return{text:this.ZeroPad(e.getUTCDate().toString(),1)};case"yyyy":case"yyy":return{text:e.getUTCFullYear().toString()};case"yy":case"y":return{text:this.ZeroPad((e.getUTCFullYear()%100).toString(),2)};case"hh":return{text:this.ZeroPad(s.toString(),2)};case"h":return{text:this.ZeroPad(s.toString(),1)};case"ss":return{text:this.ZeroPad(e.getUTCSeconds().toString(),2)};case"s":return{text:this.ZeroPad(e.getUTCSeconds().toString(),1)}}const r=t.text.match(/^(s+)\.(0+)$/);if(r)return{text:this.ZeroPad(e.getUTCSeconds().toString(),r[1].length)+m.decimal_separator+(e.getUTCMilliseconds()/1e3).toFixed(r[2].length).substr(2)}}return Object.assign({},t)})),section:r}}StringFormat(t,e){const r=[];for(const s of e.prefix)s.flag===_.literal?r.push({text:t}):r.push(Object.assign({},s));return{parts:r,section:e}}Round2(t,e){const r=Math.pow(10,e);return Math.round(r*t)/r}FormatFraction(t,e){e.percent&&(t*=100);let r={denominator:1,numerator:Math.round(t),error:Math.abs(Math.round(t)-t)};if(e.fraction_denominator)r.denominator=e.fraction_denominator,r.numerator=Math.round(t*r.denominator);else if(r.error){const s=x.fraction_limits[e.fraction_denominator_digits-1]||x.fraction_limits[0];for(let e=2;e<=s;e++){const s=Math.round(t*e),i=Math.abs(s/e-t);if(i<r.error&&(r={numerator:s,denominator:e,error:i},!i))break}}const s=[];if(e.fraction_integer){const t=Math.floor(r.numerator/r.denominator);r.numerator%=r.denominator,!t&&r.numerator||(s.push(t.toString()),r.numerator&&s.push(" "))}else r.numerator||s.push("0");return r.numerator&&(s.push(r.numerator.toString()),s.push("/"),s.push(r.denominator.toString())),s.join("")}BaseFormat(t){if(this.sections[0].date_format)return this.DateFormat(Number(t));if("number"!=typeof t)return this.StringFormat(t.toString(),this.sections[3]);let e=this.sections[0],r=this.decimal_zero_regexp[0];t<0&&(e=this.sections[1]);const s=e.percent?e.decimal_max_digits+2:e.decimal_max_digits,i=Math.pow(10,-s)/2;let n=Math.abs(t);if(n<i&&(e=this.sections[2],r=this.decimal_zero_regexp[2]),e.scaling&&(n/=e.scaling,n<i&&(e=this.sections[2],r=this.decimal_zero_regexp[2])),e.string_format)return this.StringFormat(t.toString(),e);let a="";if(e.fraction_format)return{parts:[this.FormatFraction(n,e)],section:e};e.exponential?a=n.toExponential(e.decimal_max_digits):(e.percent&&(n*=100),a=this.Round2(n,e.decimal_max_digits).toFixed(e.decimal_max_digits)),r&&(a=a.replace(r,""));const o=a.split(".");for(;o[0].length<e.integer_min_digits;)o[0]=("0000000000000000"+o[0]).slice(-e.integer_min_digits);return 0===e.integer_min_digits&&"0"===o[0]&&(o[0]=""),e.grouping&&(o[0]=o[0].replace(x.grouping_regexp,"$&"+m.grouping_separator)),{parts:o,section:e}}}x.grouping_regexp=/\d{1,3}(?=(\d{3})+(?!\d))/g,x.fraction_limits=[9,99,999,9999];class M{static Get(t){const e=this.symbolc_name_map[t.toLowerCase()];let r=this.cache[e||t];return r||(r=new x(t),this.cache[t]=r),r}static Equals(t,e){if(t===e)return!0;const r=this.Get(t),s=this.Get(e);return r.pattern===s.pattern}static Translate(t){const e=this.symbolc_name_map[t.toLowerCase()];return e?this.cache[e].toString():t}static SymbolicName(t){for(const e of Object.keys(this.base_formats))if(t===this.base_formats[e])return e;return null}static InitCache(){for(const t of Object.keys(this.base_formats))this.cache[t]=new x(this.base_formats[t]),this.symbolc_name_map[t.toLowerCase()]=t;this.cache.General.magic_decimal=!0;for(const t of Object.keys(this.aliases))this.cache[t]=this.cache[this.aliases[t]],this.symbolc_name_map[t.toLowerCase()]=t}}var C;M.cache={},M.symbolc_name_map={},M.base_formats={Accounting:"_(#,##0.00_);(#,##0.00);-???",Number:"0.00",Integer:"0",Percent:"0.00%",General:"0.######",Fraction:"# ?/?",Dollar:"$* _(#,##0.00_);$* (#,##0.00);$* -???",Exponential:"0.000e","Short Date":"mm/dd/yy","Long Date":"dddd, mmm d yyyy",Timestamp:"mm-dd-yy hh:mm:ss"},M.aliases={Scientific:"Exponential",Percentage:"Percent",Currency:"Dollar"},M.InitCache(),function(t){t[t.None=0]="None",t[t.Nan=1]="Nan",t[t.Exponential=2]="Exponential",t[t.Percent=4]="Percent",t[t.Currency=8]="Currency",t[t.Grouping=16]="Grouping",t[t.Parens=32]="Parens",t[t.Date=64]="Date",t[t.Time=128]="Time"}(C||(C={}));const S=(new Date).getUTCFullYear();new class{TestDate(t){const e=Date.parse(t);if(isNaN(e))return!1;const r=new Date(e),s=t.replace(/[\d\-\\/,.\s]+/g," ").toLocaleLowerCase().split(/\s+/).map((t=>t.trim())).filter((t=>!!t));if(!s.length)return e;if(!this.compare_month){this.compare_month={};for(let t=0;t<12;t++)this.compare_month[m.date_components.long_months[t].toLocaleLowerCase().replace(/\./,"")]=t,this.compare_month[m.date_components.short_months[t].toLocaleLowerCase().replace(/\./,"")]=t}if(!this.compare_day){this.compare_day={};for(let t=0;t<7;t++)this.compare_day[m.date_components.long_days[t].toLocaleLowerCase().replace(/\./,"")]=t,this.compare_day[m.date_components.short_days[t].toLocaleLowerCase().replace(/\./,"")]=t}let i=!1,n=!1;for(const t of s){let e=!1;for(const[s,n]of Object.entries(this.compare_month))if(t===s){if(i)return!1;if(r.getUTCMonth()!==n)return!1;e=!0,i=!0}if(!e)for(const[s,i]of Object.entries(this.compare_day))if(t===s){if(n)return!1;if(r.getUTCDay()!==i)return!1;e=!0,n=!0}if(!e)return!1}return!(n&&!i)&&e}TryParse(t=""){let r=C.None;if("'"===t[0])return{value:t,type:e.string};if(""===t)return{value:t,type:e.string};if("NaN"===t)return{value:NaN,type:e.number,hints:C.Nan};let s=t.trim();const i=s.match(/^[$](.*?)$/);i&&(s=i[1],r|=C.Currency);const n=s.match(/^\((.*?)\)$/);n&&(s=n[1],r|=C.Parens);const a=s.match(/^(.*?)%\s*$/);a&&(s=a[1],r|=C.Percent),"."===m.decimal_separator?/,/.test(s)&&(s=s.replace(/,/g,""),r|=C.Grouping):(s=s.replace(/(\d)\s+/g,"$1"),s=s.replace(/\./g,""),s=s.replace(/,/,"."));let o=Number(s);if(null===o||isNaN(o)){const s=t.toLowerCase();if("false"===s)return{value:!1,type:e.boolean};if("true"===s)return{value:!0,type:e.boolean};const i=this.TestDate(t);if(!1!==i&&!isNaN(i)){const t=new Date(i),s=t.getUTCFullYear();if(s>=S-200&&s<=S+200)return r=C.Date,(t.getHours()||t.getMinutes()||t.getSeconds())&&(r|=C.Time),{value:w(i),type:e.number,hints:r}}return{value:t,type:e.string}}if(n&&(o=-o),a){const t=o<0?-1:1,e=(t*o).toString().split(".");e[0]=("00"+e[0]).replace(/(\d\d)$/,".$1"),o=Number(e.join(""))*t}return/e/.test(t)&&(r|=C.Exponential),{value:o,type:e.number,hints:r}}};class A{static MeasureColorARGB(t){const e=this.MeasureColor(t);let r="FF";for(let t=0;t<3;t++){const s=e[t].toString(16);0===s.length?r+="00":1===s.length?r+=`0${s}`:r+=s}return r.toUpperCase()}static MeasureColor(t){let e=this.color_cache[t];if(e)return e;this.color_measurement_canvas||(this.color_measurement_canvas=document.createElement("canvas"),this.color_measurement_canvas.width=1,this.color_measurement_canvas.height=1);const r=this.color_measurement_canvas.getContext("2d");return r?(r.fillStyle="#fff",r.fillRect(0,0,1,1),r.fillStyle=t,r.fillRect(0,0,1,1),e=r.getImageData(0,0,1,1).data,this.color_cache[t]=e,e):new Uint8ClampedArray(3)}static EnsureMeasurementNode(){if(!this.text_measurement_node){const t=document.querySelector(".treb-chart-measurement-node");t?this.text_measurement_node=t:(this.text_measurement_node=document.createElement("div"),this.text_measurement_node.classList.add("treb-chart-measurement-node"),this.text_measurement_node.style.margin="0px",this.text_measurement_node.style.padding="0px",this.text_measurement_node.style.whiteSpace="nowrap",this.text_measurement_node.style.position="fixed",this.text_measurement_node.style.border="0px",this.text_measurement_node.style.border="1px solid red",this.text_measurement_node.style.boxSizing="content-box",this.text_measurement_node.style.top=this.text_measurement_node.style.left="-1000px",document.body.appendChild(this.text_measurement_node))}}static FontLoaded(t,e=!1,r=400){const s=`${e?"italic":""} ${r} 20pt ${t}`,i=this.MeasureText(`${s}, sans-serif`,"check font"),n=this.MeasureText(`${s}, serif`,"check font"),a=this.MeasureText(`${s}, monospace`,"check font");return i.width===n.width&&n.width===a.width}static MeasureText(t,e,r=0){this.EnsureMeasurementNode(),this.text_measurement_node.style.font=t,/\n/.test(e)?(e=e.replace(/\n/g,"<BR/>"),this.text_measurement_node.innerHTML=e):this.text_measurement_node.textContent=e,this.text_measurement_node.style.lineHeight="1em",this.text_measurement_node.style.transform=r?`rotate(${r}deg)`:"";const s=this.text_measurement_node.getBoundingClientRect();return{width:s.width,height:s.height}}}A.color_cache={};const R=(t,e,r=6.5,s=!1)=>{if(e===t)e++,t&&t--;else{const r=Math.round(1e5*e)/1e5;Math.abs(r-e)/(e-t)<1e-5&&(e=r)}const i=e-t,n=Math.log(i)/Math.log(10),a=Math.floor(Math.abs(n))*(n<0?-1:1)-1,o=[.1,.25,.5,1,2.5,5,10,25,50,100];let l=-1,h=0;for(const i of o){const n=i*Math.pow(10,a),o=Math.floor(t/n)*n,u=(Math.ceil(e/n)*n-o)/n,c=Math.abs(u-r);(l<0||c<h)&&(!s||u<=r)&&(h=c,l=n)}return t=Math.floor(t/l)*l,e=Math.ceil(e/l)*l,{scale:a,step:l,count:r=Math.round((e-t)/l),min:t,max:e}};let k=100;class N{constructor(t={}){this.key_=k++,this.data={},this.type="",this.temp={},this.inflated=!1,this.resizable=!0,this.movable=!0,this.removable=!0,this.selectable=!0,this.move_with_cells=!0,this.resize_with_cells=!0,this.formula="";for(const e of Object.keys(this))"layout"!==e&&t[e]&&(this[e]=t[e]);t.layout&&(this.layout=JSON.parse(JSON.stringify(t.layout))),t.rect&&(this.rect=f.Create(t.rect))}get key(){return this.key_}toJSON(){const t={};return this.data&&(t.data=this.data),this.formula&&(t.formula=this.formula),this.type&&(t.type=this.type),this.resizable||(t.resizable=this.resizable),this.movable||(t.movable=this.movable),this.removable||(t.removable=this.removable),this.selectable||(t.selectable=this.selectable),this.move_with_cells||(t.move_with_cells=this.move_with_cells),this.resize_with_cells||(t.resize_with_cells=this.resize_with_cells),this.layout&&(t.layout=this.layout),this.extent&&(t.extent=this.extent),t}}class D{constructor(e){this.annotations=[],this.freeze={rows:0,columns:0},this.visible=!0,this.default_column_width=100,this.default_row_height=25,this.cells=new d,this.selection={target:{row:0,column:0},area:new t({row:0,column:0}),empty:!0},this.scroll_offset={x:0,y:0},this.name=D.default_sheet_name,this.row_height_=[],this.column_width_=[],this.row_headers=[],this.column_headers=[],this.row_header_width=100,this.column_header_height=25,this.style_map=[],this.style_json_map=[],this.sheet_style={},this.row_styles={},this.column_styles={},this.row_pattern=[],this.cell_style=[],this.default_style_properties=e,this.default_column_width=100,this.row_header_width=60,this.UpdateDefaultRowHeight(),this.id_=D.base_id++}static Reset(){this.base_id=100}static Blank(t,e,r=30,s=20){const i=new D(t);return e&&(i.name=e),r=Math.max(r,1),s=Math.max(s,1),i.cells.EnsureCell({row:r-1,column:s-1}),i}static FromJSON(t,e,r){let s;s="string"==typeof t?JSON.parse(t):t;const i=(t,e)=>{Object.keys(e).forEach((r=>{const s=Number(r)||0;t[s]=e[r]}))};r||(r=new D(e)),s.default_column_width&&(r.default_column_width=s.default_column_width),s.default_row_height&&(r.default_row_height=s.default_row_height),s.id&&(r.id=s.id),s.name&&(r.name=s.name);const n=t=>{const e=t;e.text_color&&("none"!==e.text_color&&(e.text={text:e.text_color}),e.text_color=void 0),e.background&&("none"!==e.background&&(e.fill={text:e.background}),e.background=void 0),e.border_top_color&&("none"!==e.border_top_color&&(e.border_top_fill={text:e.border_top_color}),e.border_top_color=void 0),e.border_left_color&&("none"!==e.border_left_color&&(e.border_left_fill={text:e.border_left_color}),e.border_left_color=void 0),e.border_bottom_color&&("none"!==e.border_bottom_color&&(e.border_bottom_fill={text:e.border_bottom_color}),e.border_bottom_color=void 0),e.border_right_color&&("none"!==e.border_right_color&&(e.border_right_fill={text:e.border_right_color}),e.border_right_color=void 0)},a=s.cell_style_refs;for(const t of a)n(t);if(r.cell_style=[],a&&(s.cell_styles||[]).forEach((t=>{"number"==typeof t.ref&&(t.style=JSON.parse(JSON.stringify(a[t.ref])))})),r.cells.FromJSON(s.data),s.rows&&r.cells.EnsureRow(s.rows-1),s.columns&&r.cells.EnsureColumn(s.columns-1),s.data)if(u(s.data))for(const t of s.data)t.style_ref&&(r.cell_style[t.column]||(r.cell_style[t.column]=[]),r.cell_style[t.column][t.row]=JSON.parse(JSON.stringify(a[t.style_ref])));else if(c(s.data))for(const t of s.data){const e=t.row;for(const s of t.cells){const t=s.column;s.style_ref&&(r.cell_style[t]||(r.cell_style[t]=[]),r.cell_style[t][e]=JSON.parse(JSON.stringify(a[s.style_ref])))}}else for(const t of s.data){const e=t.column;for(const s of t.cells){const t=s.row;s.style_ref&&(r.cell_style[e]||(r.cell_style[e]=[]),r.cell_style[e][t]=JSON.parse(JSON.stringify(a[s.style_ref])))}}r.freeze.rows=0,r.freeze.columns=0,s.freeze&&(r.freeze.rows=s.freeze.rows||0,r.freeze.columns=s.freeze.columns||0),r.scroll_offset=s.scroll?Object.assign({},s.scroll):{x:0,y:0};for(const t of s.cell_styles||[])t.style&&(r.cell_style[t.column]||(r.cell_style[t.column]=[]),r.cell_style[t.column][t.row]=t.style);r.sheet_style=s.sheet_style||{},r.row_styles=s.row_style,r.column_styles=s.column_style,r.row_pattern=s.row_pattern||[],n(r.sheet_style||{});for(const t of r.row_pattern)n(t);for(const t of Object.keys(r.column_styles))n(r.column_styles[t]);for(const t of Object.keys(r.row_styles))n(r.row_styles[t]);return r.row_height_=[],i(r.row_height_,s.row_height||{}),r.row_height_.length&&r.cells.EnsureRow(r.row_height_.length-1),r.column_width_=[],i(r.column_width_,s.column_width||{}),r.column_width_.length&&r.cells.EnsureColumn(r.column_width_.length-1),r.annotations=(s.annotations||[]).map((t=>new N(t))),s.selection&&(r.selection=JSON.parse(JSON.stringify(s.selection))),r.visible=!0,void 0!==s.visible&&(r.visible=!!s.visible),r}get header_offset(){return{x:this.row_header_width,y:this.column_header_height}}get rows(){return this.cells.rows}get columns(){return this.cells.columns}get id(){return this.id_}set id(t){this.id_=t,this.id>=D.base_id&&(D.base_id=this.id+1)}MergeCells(t){t=t.Clone(),this.cells.Apply(t,((e,r,s)=>{e.merge_area=t,e.render_dirty=!0,r===t.start.column&&s===t.start.row||e.Reset()}),!0)}UnmergeCells(t){let e=!0;this.cells.Apply(t,(r=>{e=e&&!!r.merge_area&&t.Equals(r.merge_area)}),!1),e?this.cells.Apply(t,(t=>{t.merge_area=void 0,t.render_dirty=!0}),!1):console.warn("area mismatch")}StyleFontSize(t){let e=t.font_size_value||0;return"px"===t.font_size_unit&&(e*=.75),e||10}UpdateDefaultRowHeight(){const t=p.Composite([this.default_style_properties,this.sheet_style]);if("undefined"!=typeof window){const e=A.MeasureText(p.Font(t),"M"),r=Math.round(1.4*e.height);this.default_row_height<r&&(this.default_row_height=r)}}SetRowHeaders(t){this.row_headers=t.map((t=>void 0===t?"":t.toString())),this.row_headers&&this.cells.EnsureRow(this.row_headers.length-1)}SetColumnHeaders(t){this.column_headers=t.map((t=>void 0===t?"":t.toString())),t&&this.cells.EnsureColumn(t.length-1)}RowHeader(t){return this.row_headers?this.row_headers.length>t?this.row_headers[t]:"":t+1}ColumnHeader(t){let e="";if(this.column_headers)return this.column_headers.length>t?this.column_headers[t]:"";for(;;){const r=t%26;if(e=String.fromCharCode(65+r)+e,!(t=Math.floor(t/26)))break;t--}return e}GetRowHeight(t){const e=this.row_height_[t];return void 0===e?this.default_row_height:e}SetRowHeight(t,e){return this.row_height_[t]=e,this.cells.EnsureRow(t),e}GetColumnWidth(t){const e=this.column_width_[t];return void 0===e?this.default_column_width:e}SetColumnWidth(t,e){return this.column_width_[t]=e,this.cells.EnsureColumn(t),e}Delta(t,e){const r={},s=[...Object.keys(t),...Object.keys(e)];for(const i of s){const s=t[i],n=e[i];"object"==typeof s&&"object"==typeof n?JSON.stringify(s)!==JSON.stringify(n)&&(r[i]=n):s!==n&&(r[i]=n)}return r}UpdateCellStyle(t,e,r=!0){const{row:s,column:i}=t;this.cell_style[i]||(this.cell_style[i]=[]);const n=this.CompositeStyleForCell(t,!1,!1),a=p.Composite([this.default_style_properties,n,p.Merge(this.cell_style[i][s]||{},e,r)]),o=this.Delta(n,a);this.cell_style[i][s]=o,this.CellData(t).FlushStyle()}Invalidate(t){this.cells.Apply(this.RealArea(t),(t=>t.render_dirty=!0))}UpdateAreaStyle(t,e={},r=!0){if(t)if(t.entire_sheet)this.UpdateSheetStyle(e,r);else if(t.entire_column)for(let s=t.start.column;s<=t.end.column;s++)this.UpdateColumnStyle(s,e,r);else if(t.entire_row)for(let s=t.start.row;s<=t.end.row;s++)this.UpdateRowStyle(s,e,r);else t.Array().forEach((t=>this.UpdateCellStyle(t,e,r)))}HasCellStyle(t){return!!(this.cell_style[t.column]&&this.cell_style[t.column][t.row]||this.row_styles[t.row]||this.column_styles[t.column]||this.row_pattern.length)}NextVisibleColumn(t){for(++t;0===this.column_width_[t];t++);return t}PreviousVisibleColumn(t){for(--t;t>=0&&0===this.column_width_[t];t--);return t}NextVisibleRow(t){for(++t;0===this.row_height_[t];t++);return t}PreviousVisibleRow(t){for(--t;t>=0&&0===this.row_height_[t];t--);return t}SurroundingStyle(t){const e=[{},{},{},{},{},{},{},{},{},{}];let r=t.column+1,s=t.column-1,i=t.row+1,n=t.row-1;for(;0===this.column_width_[r];r++);for(;0===this.row_height_[i];i++);for(;s>=0&&0===this.column_width_[s];s--);for(;n>=0&&0===this.row_height_[n];n--);return s>=0&&n>=0&&(e[7]=this.CellStyleData({row:n,column:s})||{}),s>=0&&(e[4]=this.CellStyleData({row:t.row,column:s})||{},e[1]=this.CellStyleData({row:i,column:s})||{}),n>=0&&(e[8]=this.CellStyleData({row:n,column:t.column})||{},e[9]=this.CellStyleData({row:n,column:r})||{}),e[6]=this.CellStyleData({row:t.row,column:r})||{},e[2]=this.CellStyleData({row:i,column:t.column})||{},e[3]=this.CellStyleData({row:i,column:r})||{},e}CellStyleData(t){const e=this.cells.GetCell(t);if(e){if(!e.style){const r=this.GetStyleIndex(this.CompositeStyleForCell(t));e.style=this.style_map[r]}return e.style}}GetCopyStyle(t){return this.CompositeStyleForCell(t,!0,!1)}CellData(t){const r=this.cells.EnsureCell(t);if(r.rendered_type)return r;let s,i;if(r.calculated_type?(i=r.calculated,s=r.calculated_type):(i=r.value,s=r.type),!r.style){const e=this.GetStyleIndex(this.CompositeStyleForCell(t));r.style=this.style_map[e]}return s&&null!=i?s===e.number?(isNaN(i)?r.formatted=void 0===r.style.nan?"NaN":r.style.nan:r.formatted=this.FormatNumber(i,r.style.number_format),r.rendered_type=e.number):s===e.error?(r.formatted="#"+(i||"ERR?"),r.rendered_type=e.error):s===e.boolean?(r.formatted=i.toString().toUpperCase(),r.rendered_type=e.boolean):s===e.formula&&void 0===r.calculated?(r.formatted="",r.rendered_type=e.string):(r.formatted=this.FormatNumber(i,r.style.number_format),r.rendered_type=e.string):(r.formatted="",r.rendered_type=e.string),r}FormatNumber(t,e=""){const r=M.Get(e).FormatParts(t);return r.length?1!==r.length||r[0].flag?r:r[0].text||"":""}SetHeaderSize(t=60,e=this.default_row_height){this.row_header_width=t,this.column_header_height=e}AutoSizeRow(t){let e=this.default_row_height;for(let r=0;r<this.cells.columns;r++){const s=this.CellData({row:t,column:r}),i=s.style;let n=s.formatted||"";if("string"!=typeof n&&(n=n.map((t=>t.text)).join("")),i&&n&&n.length){const t=n.split(/\n/),r=this.StyleFontSize(i);e=Math.max(e,((r||10)+9)*t.length)}}this.SetRowHeight(t,e)}AutoSizeColumn(t,e=!0){D.measurement_canvas||(D.measurement_canvas=document.createElement("canvas"));const r=D.measurement_canvas.getContext("2d");if(!r)return;let s=12;e||(s=this.GetColumnWidth(t));for(let e=0;e<this.cells.rows;e++){const i=this.CellData({row:e,column:t});let n=i.formatted||"";"string"!=typeof n&&(n=n.map((t=>t.text)).join("")),n&&n.length&&(r.font=p.Font(i.style||{}),s=Math.max(s,Math.ceil(r.measureText(n).width)+8))}this.SetColumnWidth(t,s)}GetStyle(t){return this.style_map[t]}InsertRows(e=0,r=1){if(e)for(let t=0;t<this.cells.columns;t++){const r=this.cells.GetCell({row:e-1,column:t},!1);if(r&&r.area){const s=this.cells.GetCell({row:e,column:t},!1);if(s&&s.area&&s.area.Equals(r.area))return!1}}r<0?this.cells.DeleteRows(e,-r):this.cells.InsertRows(e,r);const s={},i={};for(let t=e;t<this.cells.rows;t++)for(let e=0;e<this.cells.columns;e++){const r=this.cells.GetCell({row:t,column:e},!1);r&&(r.area&&!i[r.area.spreadsheet_label]&&(i[r.area.spreadsheet_label]=r.area),r.merge_area&&!s[r.merge_area.spreadsheet_label]&&(s[r.merge_area.spreadsheet_label]=r.merge_area))}for(const e of Object.keys(i)){const s=i[e],n=new t({row:s.start.row+r,column:s.start.column},{row:s.end.row+r,column:s.end.column});n.Iterate((t=>{this.cells.GetCell(t,!0).area=n}))}for(const i of Object.keys(s)){const n=s[i],a={row:n.start.row,column:n.start.column};n.start.row>=e&&(a.row+=r);const o=new t(a,{row:n.end.row+r,column:n.end.column});o.Iterate((t=>{this.cells.GetCell(t,!0).merge_area=o}))}const n=Object.keys(this.row_styles),a={};n.forEach((t=>{const s=Number(t);s<e?a[s]=this.row_styles[s]:r<0&&s<e-r||(a[s+r]=this.row_styles[s])})),this.row_styles=a;let o=[];if(r<0)o=[e,-r];else{o=[e,0];for(let t=0;t<r;t++)o.push(void 0)}return this.cell_style.forEach((t=>{t&&t.length>=e&&t.splice.apply(t,o)})),this.row_height_.splice.apply(this.row_height_,o),this.FlushCellStyles(),!0}InsertColumns(e=0,r=1){if(e)for(let t=0;t<this.cells.rows;t++){const r=this.cells.GetCell({row:t,column:e-1},!1);if(r&&r.area){const s=this.cells.GetCell({row:t,column:e},!1);if(s&&s.area&&s.area.Equals(r.area))return!1}}r<0?this.cells.DeleteColumns(e,-r):this.cells.InsertColumns(e,r);const s={},i={};for(let t=e;t<this.cells.columns;t++)for(let e=0;e<this.cells.rows;e++){const r=this.cells.GetCell({row:e,column:t},!1);r&&(r.area&&!i[r.area.spreadsheet_label]&&(i[r.area.spreadsheet_label]=r.area),r.merge_area&&!s[r.merge_area.spreadsheet_label]&&(s[r.merge_area.spreadsheet_label]=r.merge_area))}for(const e of Object.keys(i)){const s=i[e],n=new t({row:s.start.row,column:s.start.column+r},{row:s.end.row,column:s.end.column+r});n.Iterate((t=>{this.cells.GetCell(t,!0).area=n}))}for(const i of Object.keys(s)){const n=s[i],a={row:n.start.row,column:n.start.column};n.start.column>=e&&(a.column+=r);const o=new t(a,{row:n.end.row,column:n.end.column+r});o.Iterate((t=>{this.cells.GetCell(t,!0).merge_area=o}))}const n=Object.keys(this.column_styles),a={};n.forEach((t=>{const s=Number(t);s<e?a[s]=this.column_styles[s]:r<0&&s<e-r||(a[s+r]=this.column_styles[s])})),this.column_styles=a;let o=[];if(r<0)o=[e,-r];else{o=[e,0];for(let t=0;t<r;t++)o.push(void 0)}return this.cell_style.splice.apply(this.cell_style,o),this.column_width_.splice.apply(this.column_width_,o),this.FlushCellStyles(),!0}ClearArea(t){t=this.RealArea(t),this.cells.Apply(t,(t=>t.Reset()))}SetAreaValues2(t,e){t=this.RealArea(t),this.cells.SetArea(t,e)}SetArrayValue(t,e){t=this.RealArea(t),this.cells.Apply(t,(e=>e.SetArray(t)),!0),this.cells.GetCell(t.start,!0).SetArrayHead(t,e)}SetCellValue(t,e){this.cells.GetCell(t,!0).Set(e)}RealArea(e,r=!1){const s=e.start,i=e.end;return e.entire_row&&(s.column=0,s.absolute_column=!1,i.column=this.cells.columns-1,i.absolute_column=!1),e.entire_column&&(s.row=0,s.absolute_row=!1,i.row=this.cells.rows-1,i.absolute_row=!1),r&&(i.row>=this.rows&&(i.row=this.rows-1,i.absolute_row=!1),i.column>=this.columns&&(i.column=this.columns-1,i.absolute_column=!1)),new t(s,i)}FormattedCellValue(t){const e=this.CellData(t);if(e)return"string"==typeof e.formatted?e.formatted:e.formatted?e.formatted.map((t=>{switch(t.flag){case 1:case 2:return" ";default:return t.text}})).join(""):e.value}GetFormattedRange(t,e=t){if(t.row===e.row&&t.column===e.column)return this.FormattedCellValue(t);const r=[];for(let s=t.row;s<=e.row;s++){const i=[];for(let r=t.column;r<=e.column;r++)i.push(this.FormattedCellValue({row:s,column:r}));r.push(i)}return r}NumberFormatsAndColors(t,e){const r=r=>{var s,i,n,a,o,l;r.number_format&&(e[r.number_format]=1),(null===(s=r.text)||void 0===s?void 0:s.text)&&"none"!==r.text.text&&(t[r.text.text]=1),(null===(i=r.fill)||void 0===i?void 0:i.text)&&(t[r.fill.text]=1),(null===(n=r.border_top_fill)||void 0===n?void 0:n.text)&&(t[r.border_top_fill.text]=1),(null===(a=r.border_left_fill)||void 0===a?void 0:a.text)&&(t[r.border_left_fill.text]=1),(null===(o=r.border_right_fill)||void 0===o?void 0:o.text)&&(t[r.border_right_fill.text]=1),(null===(l=r.border_bottom_fill)||void 0===l?void 0:l.text)&&(t[r.border_bottom_fill.text]=1)};r(this.sheet_style);for(const t in this.row_styles)r(this.row_styles[t]);for(const t in this.column_styles)r(this.column_styles[t]);for(const t of this.row_pattern)r(t);for(const t of this.cell_style)if(t)for(const e of t)e&&r(e)}toJSON(t={}){var e;const r=(t,e)=>{const r={};for(let s=0;s<t.length;s++)void 0!==t[s]&&t[s]!==e&&(r[s]=t[s]);if(Object.keys(r).length)return r};let s=[{}];const i={},n=[],a=JSON.stringify({});for(let t=0;t<this.cell_style.length;t++){const e=this.cell_style[t];if(e){n[t]=[];for(let r=0;r<e.length;r++)if(e[r]){const o=JSON.stringify(e[r]);if(o!==a){let a=i[o];"number"!=typeof a&&(i[o]=a=s.length,s.push(e[r])),n[t][r]=a}}}}s=JSON.parse(JSON.stringify(s));const o=JSON.parse(JSON.stringify(this.sheet_style)),l=JSON.parse(JSON.stringify(this.row_styles)),h=JSON.parse(JSON.stringify(this.column_styles)),u=JSON.parse(JSON.stringify(this.row_pattern)),c=(t={},e={})=>{const r=Object.assign(Object.assign({},e),t);return r.text?(r.text=A.MeasureColorARGB(r.text),r):"number"==typeof r.theme?r:void 0};if(t.export_colors){const t=[];for(const e of[l,h,s,[o],u])if(Array.isArray(e))for(const r of e)t.push(r);else for(const r of Object.keys(e))t.push(e[r]);for(const r of t)r.border_top_fill=c(r.border_top_fill,p.DefaultProperties.border_top_fill),r.border_left_fill=c(r.border_left_fill,p.DefaultProperties.border_top_fill),r.border_right_fill=c(r.border_right_fill,p.DefaultProperties.border_top_fill),r.border_bottom_fill=c(r.border_bottom_fill,p.DefaultProperties.border_top_fill),(null===(e=r.fill)||void 0===e?void 0:e.text)&&(r.fill.text=A.MeasureColorARGB(r.fill.text)),r.text&&r.text.text&&"none"!==r.text.text&&(r.text.text=A.MeasureColorARGB(r.text.text))}const d={calculated_value:!!t.rendered_values,preserve_type:!!t.preserve_type,expand_arrays:!!t.expand_arrays,decorated_cells:!!t.decorated_cells,nested:!0,cell_style_refs:n},m=this.cells.toJSON(d),f=m.data;let{rows:_,columns:g}=m;t.shrink?(_+=2,g+=1):(_=this.rows,g=this.columns);for(const t of this.annotations)t.extent||this.CalculateAnnotationExtent(t),t.extent&&(_=Math.max(_,t.extent.row+1),g=Math.max(g,t.extent.column+1));const y=[];for(let t=0;t<n.length;t++){const e=n[t];if(e)for(let r=0;r<e.length;r++)e[r]&&y.push({row:r,column:t,ref:e[r]})}const v={id:this.id,name:this.name,data:f,sheet_style:o,rows:_,columns:g,cell_styles:y,cell_style_refs:s,row_style:l,column_style:h,row_pattern:u.length?u:void 0,default_row_height:this.default_row_height,default_column_width:this.default_column_width,row_height:r(this.row_height_,this.default_row_height),column_width:r(this.column_width_,this.default_column_width),selection:JSON.parse(JSON.stringify(this.selection)),annotations:JSON.parse(JSON.stringify(this.annotations))};return this.visible||(v.visible=this.visible),(this.scroll_offset.x||this.scroll_offset.y)&&(v.scroll=this.scroll_offset),(this.freeze.rows||this.freeze.columns)&&(v.freeze=this.freeze),v}FlushCellStyles(){this.style_map=[],this.style_json_map=[],this.cells.FlushCellStyles()}ImportData(e){const r=e.styles,s=e.sheet_style;s&&this.UpdateAreaStyle(new t({row:1/0,column:1/0},{row:1/0,column:1/0}),r[s]);const i=e.column_styles;if(i)for(let e=0;e<i.length;e++)i[e]&&this.UpdateAreaStyle(new t({row:1/0,column:e},{row:1/0,column:e}),r[i[e]]);this.cells.FromJSON(e.cells),e.name&&(this.name=e.name||"");const n=this.cell_style;for(const t of e.cells)t.style_ref&&(n[t.column]||(n[t.column]=[]),n[t.column][t.row]=r[t.style_ref]);for(let t=0;t<e.column_widths.length;t++)void 0!==e.column_widths[t]&&this.SetColumnWidth(t,e.column_widths[t]);for(let t=0;t<e.row_heights.length;t++)void 0!==e.row_heights[t]&&this.SetRowHeight(t,e.row_heights[t]);for(const t of e.annotations||[])this.annotations.push(new N(t));e.hidden&&(this.visible=!1)}CalculateAnnotationExtent(t){var e,r;if(t.layout)return void(t.extent=Object.assign({},t.layout.br.address));t.extent={row:0,column:0};let s=null===(e=t.rect)||void 0===e?void 0:e.right;if(s&&this.default_column_width)for(let e=0;s>=0&&e<1e3;e++)if(s-=this.GetColumnWidth(e),s<0){t.extent.column=e;break}let i=null===(r=t.rect)||void 0===r?void 0:r.bottom;if(i&&this.default_row_height)for(let e=0;i>=0&&e<1e3;e++)if(i-=this.GetRowHeight(e),i<0){t.extent.row=e;break}}UpdateSheetStyle(t,e=!0){this.sheet_style=p.Merge(this.sheet_style,t,e);const r=Object.keys(t);for(const t of this.cell_style)if(t)for(const e of t)e&&r.forEach((t=>delete e[t]));for(const t of Object.keys(this.row_styles))r.forEach((e=>delete this.row_styles[t][e]));for(const t of Object.keys(this.column_styles))r.forEach((e=>delete this.column_styles[t][e]));this.FlushCellStyles()}UpdateRowStyle(e,r,s=!0){this.row_styles[e]=p.Merge(this.row_styles[e]||{},r,s);const i=Object.keys(r);for(const t of this.cell_style)t&&t[e]&&i.forEach((r=>delete t[e][r]));for(let t=0;t<this.cells.columns;t++)if(this.column_styles[t]){const s=this.column_styles[t],n=this.cell_style[t]&&this.cell_style[t][e]||{};for(const t of i)void 0!==s[t]&&(n[t]=r[t]);Object.keys(n).length&&(this.cell_style[t]||(this.cell_style[t]=[]),this.cell_style[t][e]=JSON.parse(JSON.stringify(n)))}this.cells.Apply(this.RealArea(t.FromRow(e)),(t=>t.FlushStyle()))}FlattenStyles(){this.CompositeStyleForCell}UpdateColumnStyle(e,r,s=!0){this.column_styles[e]=p.Merge(this.column_styles[e]||{},r,s);const i=Object.keys(r);if(this.cell_style[e])for(const t of this.cell_style[e])t&&i.forEach((e=>delete t[e]));this.cells.Apply(this.RealArea(t.FromColumn(e)),(t=>t.FlushStyle()))}CompositeStyleForCell(t,e=!0,r=!0){const{row:s,column:i}=t,n=[this.default_style_properties,this.sheet_style];return r&&this.row_pattern.length&&n.push(this.row_pattern[s%this.row_pattern.length]),this.row_styles[s]&&n.push(this.row_styles[s]),this.column_styles[i]&&n.push(this.column_styles[i]),e&&this.cell_style[i]&&this.cell_style[i][s]&&n.push(this.cell_style[i][s]),p.Composite(n)}GetStyleIndex(t){const e=JSON.stringify(t);for(let t=0;t<this.style_json_map.length;t++)if(e===this.style_json_map[t])return t;const r=this.style_map.length;return this.style_map.push(JSON.parse(e)),this.style_json_map.push(e),r}}D.base_id=100,D.default_sheet_name="Sheet1";class P{constructor(){this.forward={},this.backward=[]}Count(){return this.backward.length}Serialize(){return JSON.parse(JSON.stringify(this.Map()))}Deserialize(e){if(this.Reset(),e){for(const r of Object.keys(e))this.SetName(r,new t(e[r].start,e[r].end),!1);this.RebuildList()}}MatchSelection(t,e){if(!t.start.sheet_id)throw new Error("match selection without sheet id");let r;for(const s of this.List())if(s.range.start.sheet_id===t.start.sheet_id&&(s.range.Equals(t)&&(r=s.name),null==e?void 0:e.Equals(s.range)))return s.name;return r}SetName(t,e,r=!0){const s=this.ValidateNamed(t);return s?e.entire_column||e.entire_row?(console.warn("invalid range"),!1):(this.forward[s]=e,r&&this.RebuildList(),!0):(console.warn("invalid name"),!1)}SetNames(e){for(const r of Object.keys(e)){const s=e[r];this.SetName(r,new t(s.start,s.end),!1)}this.RebuildList()}ClearName(t,e=!0){delete this.forward[t],e&&this.RebuildList()}Reset(){this.forward={},this.backward=[]}Get(t){return this.forward[t.toUpperCase()]}Map(){return this.forward}List(){return this.backward}ValidateNamed(t){return!!(t=t.trim()).length&&!/^[A-Za-z]{1,3}\d+$/.test(t)&&!/[^A-Za-z\d_.]/.test(t)&&!/^[^A-Za-z_]/.test(t)&&t.toUpperCase()}PatchNamedRanges(e,r,s,i){const n=this.List().slice(0);for(const a of n){const n=a.name,o=a.range;if(r&&e<=o.end.column)if(r>0)e<=o.start.column?o.Shift(0,r):e>o.start.column&&e<=o.end.column?o.ConsumeAddress({row:o.end.row,column:o.end.column+r}):console.warn("PNR X case 1",e,r,JSON.stringify(o));else if(r<0)if(e-r<=o.start.column)o.Shift(0,r);else if(e<=o.start.column&&e-r>o.end.column)this.ClearName(n,!1);else if(e<=o.start.column){const s=e-r-1;this.SetName(n,new t({row:o.start.row,column:s+1+r},{row:o.end.row,column:o.end.column+r}),!1)}else e<=o.end.column?e-r-1>=o.end.column?this.SetName(n,new t({row:o.start.row,column:o.start.column},{row:o.end.row,column:e-1}),!1):this.SetName(n,new t({row:o.start.row,column:o.start.column},{row:o.end.row,column:o.start.column+o.columns+r-1}),!1):console.warn("PNR X case 2",e,r,JSON.stringify(o));if(i&&s<=o.end.row)if(i>0)s<=o.start.row?o.Shift(i,0):s>o.start.row&&s<=o.end.row?o.ConsumeAddress({row:o.end.row+i,column:o.end.column}):console.warn("PNR X case 3",s,i,JSON.stringify(o));else if(i<0)if(s-i<=o.start.row)o.Shift(i,0);else if(s<=o.start.row&&s-i>o.end.row)this.ClearName(n,!1);else if(s<=o.start.row){const e=s-i-1;this.SetName(n,new t({column:o.start.column,row:e+1+i},{column:o.end.column,row:o.end.row+i}),!1)}else s<=o.end.row?s-i-1>=o.end.row?this.SetName(n,new t({column:o.start.column,row:o.start.row},{column:o.end.column,row:s-1}),!1):this.SetName(n,new t({column:o.start.column,row:o.start.row},{column:o.end.column,row:o.start.row+o.rows+i-1}),!1):console.warn("PNR X case 4",s,i,JSON.stringify(o))}this.RebuildList()}RebuildList(){this.backward=[];for(const t of Object.keys(this.forward))this.backward.push({name:t,range:this.forward[t]})}}var E,T;!function(t){t.Comma=",",t.Semicolon=";"}(E||(E={})),function(t){t.Period=".",t.Comma=","}(T||(T={}));const F=/[\s-+=<>!()]/,O=48,L={"==":6,"!=":6,"<>":6,"=":6,"<":7,">":7,"<=":7,">=":7,"+":9,"-":9,"&":9,"*":10,"/":10,"^":11,":":13},I=Object.keys(L).sort(((t,e)=>e.length-t.length)),U={"-":100,"+":100};class V{constructor(){this.argument_separator=E.Comma,this.decimal_mark=T.Period,this.argument_separator_char=44,this.decimal_mark_char=46,this.id_counter=0,this.expression="",this.data=[],this.index=0,this.length=0,this.valid=!0,this.dependencies={addresses:{},ranges:{}},this.address_refcount={},this.full_reference_list=[]}Walk(t,e){switch(t.type){case"address":case"missing":case"literal":case"identifier":case"operator":return void e(t);case"range":return void(e(t)&&(this.Walk(t.start,e),this.Walk(t.end,e)));case"binary":return void(e(t)&&(this.Walk(t.left,e),this.Walk(t.right,e)));case"unary":return void(e(t)&&this.Walk(t.operand,e));case"group":return void(e(t)&&t.elements.forEach((t=>this.Walk(t,e))));case"call":e(t)&&t.args.forEach((t=>this.Walk(t,e)))}}Transpose(t){const e=t.length,r=[];let s=0;for(let r=0;r<e;r++)Array.isArray(t[r])&&(s=Math.max(s,t[r].length));for(let i=0;i<s;i++){r[i]=[];for(let s=0;s<e;s++)r[i][s]=t[s][i]}return r}Render(t,e={rows:0,columns:0},r="(missing)",s,i){let n=this.argument_separator+" ";i===E.Comma?n=", ":i===E.Semicolon&&(n="; ");const a=s===T.Comma?",":".",o=this.decimal_mark===T.Comma?/,/:/\./;switch(t.type){case"address":return this.AddressLabel(t,e);case"range":return this.AddressLabel(t.start,e)+":"+this.AddressLabel(t.end,e);case"missing":return r;case"array":return"{"+this.Transpose(t.values).map((t=>t.map((t=>"string"==typeof t?'"'+t+'"':t)).join(", "))).join("; ")+"}";case"binary":return this.Render(t.left,e,r,s,i)+" "+t.operator+" "+this.Render(t.right,e,r,s,i);case"unary":return t.operator+this.Render(t.operand,e,r,s,i);case"literal":if("string"==typeof t.value)return'"'+t.value.replace(/"/g,'""')+'"';if(s&&"number"==typeof t.value){if(t.text){let e=t.text;return s===T.Comma&&this.decimal_mark===T.Period&&(e=e.replace(/,/g,"")),e.replace(o,a)}return t.value.toString().replace(/\./,a)}return t.text?t.text:t.value.toString();case"identifier":return t.name;case"operator":return"["+t.operator+"]";case"group":return t.explicit?"("+t.elements.map((t=>this.Render(t,e,r,s,i))).join(n)+")":t.elements.map((t=>this.Render(t,e,r,s,i))).join(n);case"call":return t.name+"("+t.args.map((t=>this.Render(t,e,r,s,i))).join(n)+")"}return"??"}Parse(t){switch("="===(t=t.trim())[0]&&(t=t.substr(1).trim()),this.expression=t,this.data=[],this.length=t.length,this.index=0,this.valid=!0,this.error_position=void 0,this.error=void 0,this.dependencies.addresses={},this.dependencies.ranges={},this.address_refcount={},this.full_reference_list=[],this.id_counter=0,this.argument_separator){case E.Semicolon:this.argument_separator_char=59;break;default:this.argument_separator_char=44}switch(this.decimal_mark){case T.Comma:this.decimal_mark_char=44;break;default:this.decimal_mark_char=46}for(let e=0;e<this.length;e++)this.data[e]=t.charCodeAt(e);const e=this.ParseGeneric(),r={};for(const t of Object.keys(this.dependencies.addresses))this.address_refcount[t]&&(r[t]=this.dependencies.addresses[t]);return this.dependencies.addresses=r,{expression:e||void 0,valid:this.valid,error:this.error,error_position:this.error_position,dependencies:this.dependencies,separator:this.argument_separator,decimal_mark:this.decimal_mark,full_reference_list:this.full_reference_list.slice(0)}}ColumnLabel(t){if(t===1/0)return"";let e=String.fromCharCode(65+t%26);for(;t>25;)t=Math.floor(t/26)-1,e=String.fromCharCode(65+t%26)+e;return e}AddressLabel(t,e){let r=t.column;t.absolute_column||t.column===1/0||(r+=e.columns);let s=t.row;if(t.absolute_row||t.row===1/0||(s+=e.rows),s<0||r<0||s===1/0&&r===1/0)return"#REF";let i="";return t.sheet&&(i=(F.test(t.sheet)?"'"+t.sheet+"'":t.sheet)+"!"),s===1/0?i+(t.absolute_column?"$":"")+this.ColumnLabel(r):r===1/0?i+(t.absolute_row?"$":"")+(s+1):i+(t.absolute_column?"$":"")+this.ColumnLabel(r)+(t.absolute_row?"$":"")+(s+1)}ParseGeneric(t=[0]){const e=[];for(;this.index<this.length;){const r=this.ParseNext(0===e.length);if("number"==typeof r){if(t.some((t=>r===t)))break;if(40===r){this.index++;const t=this.ParseGeneric([41]);this.index++,t&&e.push({type:"group",id:this.id_counter++,elements:[t],explicit:!0})}else{const t=this.ConsumeOperator();t?e.push(t):(this.error=`unexpected character [1]: ${String.fromCharCode(r)}, ${r}`,this.valid=!1,this.index++)}}else e.push(r)}return 0===e.length?null:1===e.length?e[0]:this.BinaryToRange(this.ArrangeUnits(e))}UnitToAddress(t){if("literal"===t.type){if("number"==typeof t.value&&t.value>0&&!/\./.test(t.text||""))return{type:"address",position:t.position,label:t.value.toString(),row:t.value-1,id:this.id_counter++,column:1/0}}else{let e,r=t.name;const s=r.split("!");if(s.length>1&&(e=s.slice(0,s.length-1).join("!"),r=r.substr(e.length+1),"'"===e[0])){if(!(e.length>1&&"'"===e[e.length-1]))return;e=e.substr(1,e.length-2)}const i="$"===r[0];r=(i?r.substr(1):r).toUpperCase();const n=Number(r);if(isNaN(n)){if(/[A-Z]{1,3}/.test(r)){let s=-1;for(let t=0;t<r.length;t++)s=26*(1+s)+(r[t].charCodeAt(0)-65);return{type:"address",position:t.position,absolute_column:i,label:t.name,column:s,id:this.id_counter++,row:1/0,sheet:e}}}else if(n>0&&n!==1/0&&!/\./.test(r))return{type:"address",position:t.position,absolute_row:i,label:t.name,row:n-1,id:this.id_counter++,column:1/0,sheet:e}}}BinaryToRange(t){if("binary"===t.type){if(":"===t.operator){let e,r="";if("address"===t.left.type&&"address"===t.right.type){const s=t.left.position+t.left.label.length,i=t.right.position;e={type:"range",id:this.id_counter++,position:t.left.position,start:t.left,end:t.right,label:t.left.label+this.expression.substring(s,i)+t.right.label},r=e.start.label+":"+e.end.label,this.address_refcount[e.start.label]--,this.address_refcount[e.end.label]--;const n=[t.left.position,t.right.position];this.full_reference_list=this.full_reference_list.filter((t=>t.position!==n[0]&&t.position!==n[1]))}else if(!("literal"!==t.left.type&&"identifier"!==t.left.type||"literal"!==t.right.type&&"identifier"!==t.right.type)){const s=this.UnitToAddress(t.left),i=this.UnitToAddress(t.right);s&&i&&(s.column===1/0&&i.column===1/0||s.row===1/0&&i.row===1/0)&&(r=s.label+":"+i.label,e={type:"range",id:this.id_counter++,position:t.left.position,start:s,end:i,label:r})}if(e)return this.dependencies.ranges[r]=e,this.full_reference_list.push(e),e;this.error="unexpected character: :",this.valid=!1}t.left=this.BinaryToRange(t.left),t.right=this.BinaryToRange(t.right)}return t}ArrangeUnits(t){if(0===t.length)return{type:"missing",id:this.id_counter++};if(1===t.length)return t[0];const e=[];for(let r=0;r<t.length;r++){let s=t[r];if("operator"===s.type){if(0!==e.length&&"operator"!==e[e.length-1].type){e.push(s);continue}if(!U[s.operator])return this.error=`unexpected character [2]: ${s.operator}`,this.error_position=s.position,this.valid=!1,{type:"group",id:this.id_counter++,elements:t,explicit:!1};{const e=this.BinaryToRange(this.ArrangeUnits(t.slice(r+1)));if(!this.valid)return{type:"group",id:this.id_counter++,elements:t,explicit:!1};"binary"===e.type?(e.left={type:"unary",id:this.id_counter++,operator:s.operator,operand:e.left,position:s.position},s=e):s={type:"unary",id:this.id_counter++,operator:s.operator,operand:e,position:s.position},r=t.length}}if(e.length<2)e.push(s);else{if("operator"!==e[e.length-1].type)return this.error="multiple expressions",this.error_position=s.position,this.valid=!1,{type:"group",id:this.id_counter++,elements:t,explicit:!1};{const t=e[e.length-2],r=e[e.length-1],i=r.operator,n={type:"binary",id:this.id_counter++,left:t,operator:i,position:r.position,right:s};"binary"===t.type&&L[i]>L[t.operator]&&(n.left=t.left,n.operator=t.operator,n.position=t.position,n.right={type:"binary",id:this.id_counter++,left:t.right,right:s,operator:i,position:r.position}),e.splice(-2,2,n)}}}return e[0]}ParseNext(t=!0){this.ConsumeWhiteSpace();const e=this.data[this.index];if(34===e)return{type:"literal",id:this.id_counter++,position:this.index,value:this.ConsumeString()};if(e>=O&&e<=57||e===this.decimal_mark_char){const t=this.index,[e,r]=this.ConsumeNumber();return{type:"literal",id:this.id_counter++,position:t,value:e,text:r}}if(123===e)return this.ConsumeArray();if(!t||45!==e&&43!==e){if(e>=65&&e<=90||e>=97&&e<=122||95===e||39===e||36===e||e>=192&&e<=312)return this.ConsumeToken(e)}else{const t=this.data[this.index+1];if(t>=O&&t<=57||t===this.decimal_mark_char){const t=this.index,[e,r]=this.ConsumeNumber();return{type:"literal",id:this.id_counter++,position:t,value:e,text:r}}}return e}ConsumeArray(){const t={type:"array",id:this.id_counter++,values:[],position:this.index};this.index++;let e=0,r=0;for(;this.index<this.length;){const s=this.ParseNext(),i=this.index;if("number"==typeof s)switch(this.index++,s){case 59:r++,e=0;break;case 44:e++;break;case 125:return t;default:this.valid&&(this.error="invalid character in array literal",this.error_position=i,this.valid=!1)}else switch(s.type){case"literal":t.values[e]||(t.values[e]=[]),t.values[e][r]=s.value;break;default:this.valid&&(this.error="invalid value in array literal",this.error_position=i,this.valid=!1)}}return t}ConsumeOperator(){for(const t of I)if(this.expression.substr(this.index,t.length)===t){const e=this.index;return this.index+=t.length,{type:"operator",id:this.id_counter++,operator:t,position:e}}return null}ConsumeArguments(){this.index++;let t=0;const e=[];for(;this.index<this.length;){const r=this.ParseGeneric([this.argument_separator_char,41]);null!==r&&e.push(r);const s=this.data[this.index];if(s===this.argument_separator_char){this.index++,t++;for(let r=e.length;r<t;r++)e.push({type:"missing",id:this.id_counter++})}else if(41===s)return this.index++,e}return e}ConsumeToken(t){const e=[t],r=this.index;let s=39===t;for(++this.index;this.index<this.length;this.index++){const t=this.data[this.index];if(!(t>=65&&t<=90||t>=97&&t<=122||t>=192&&t<=312||95===t||36===t||46===t||33===t||s||t>=O&&t<=57))break;e.push(t),39===t&&(s=!1)}const i=e.map((t=>String.fromCharCode(t))).join("");if(s)return this.error="unbalanced single quote",this.error_position=r,this.valid=!1,{type:"identifier",id:this.id_counter++,name:i,position:r};if("true"===i.toLowerCase())return{type:"literal",id:this.id_counter++,value:!0,position:r};if("false"===i.toLowerCase())return{type:"literal",id:this.id_counter++,value:!1,position:r};if(this.ConsumeWhiteSpace(),40===this.data[this.index]){const t=this.ConsumeArguments();return{type:"call",id:this.id_counter++,name:i,args:t,position:r}}const n=this.ConsumeAddress(i,r);if(n)return n;const a={type:"identifier",id:this.id_counter++,name:i,position:r};return this.full_reference_list.push(a),a}ConsumeAddress(t,e){const r=e,s=t.length;let i;const n=t.split("!");n.length>1&&(i=n.slice(0,n.length-1).join("!"),e+=i.length+1);const a=this.ConsumeAddressColumn(e);if(!a)return null;e=a.position;const o=this.ConsumeAddressRow(e);if(!o)return null;e=o.position;const l=i?i+t.substr(i.length,e-r).toUpperCase():t.substr(0,e-r).toUpperCase();i&&"'"===i[0]&&(i=i.substr(1,i.length-2));const h={type:"address",id:this.id_counter++,label:l,row:o.row,column:a.column,absolute_row:o.absolute,absolute_column:a.absolute,position:r,sheet:i};return s!==e-r?null:(this.dependencies.addresses[h.label]=h,this.address_refcount[h.label]=(this.address_refcount[h.label]||0)+1,this.full_reference_list.push(h),h)}ConsumeAddressRow(t){const e=36===this.data[t];e&&t++;const r=t;let s=0;for(;;t++){const e=this.data[t];if(!(e>=O&&e<=57))break;s*=10,s+=e-O}return r!==t&&{absolute:e,row:s-1,position:t}}ConsumeAddressColumn(t){let e=-1,r=0;const s=36===this.data[t];for(s&&t++;;t++,r++){if(r>=4)return!1;const s=this.data[t];if(s>=65&&s<=90)e=26*(1+e)+(s-65);else{if(!(s>=97&&s<=122))break;e=26*(1+e)+(s-97)}}return!(e<0)&&{absolute:s,column:e,position:t}}ConsumeNumber(){let t=0,e=!1,r=!1,s=0,i=0,n=0,a="integer",o=0;const l=this.index;for(;this.index<this.length;this.index++,o++){const l=this.data[this.index];if(l===this.decimal_mark_char){if("integer"!==a)break;a="fraction"}else{if(37===l){s/=100,n/=100,this.index++;break}if(43===l||45===l){if(0!==o)break;45===l&&(r=!0)}else if(69===l||101===l){if("integer"!==a&&"fraction"!==a)break;a="exponent",this.index<this.length-1&&(43===this.data[this.index+1]?this.index++:45===this.data[this.index+1]&&(this.index++,e=!0))}else{if(!(l>=O&&l<=57))break;switch(a){case"integer":s=10*s+(l-O);break;case"fraction":n=10*n+(l-O),i++;break;case"exponent":t=10*t+(l-O)}}}}let h=s+n*Math.pow(10,-i);return"exponent"===a&&(h*=Math.pow(10,(e?-1:1)*t)),[r?-h:h,this.expression.substring(l,this.index)||""]}ConsumeString(){this.index++;const t=[];for(;this.index<this.length;this.index++){const e=this.data[this.index];if(34===e&&(this.index++,this.index>=this.length||34!==this.data[this.index]))break;t.push(e)}return t.map((t=>String.fromCharCode(t))).join("")}ConsumeWhiteSpace(){for(;this.index<this.length;){const t=this.data[this.index];if(32!==t&&9!==t&&10!==t&&13!==t&&160!==t)return;this.index++}}}var j,G,B,J,z,q;!function(t){t[t.default=0]="default",t[t.quoted=1]="quoted"}(j||(j={})),(q=G||(G={}))[q.white=0]="white",q[q.gray=1]="gray",q[q.black=2]="black";class H{constructor(){this.type=H.type,this.color=G.white,this.edges_in=[],this.edges_out=[]}get has_inbound_edges(){return this.edges_in.length>0}get has_outbound_edges(){return this.edges_out.length>0}Reset(){for(const t of this.edges_out)t.RemoveDependency(this);for(const t of this.edges_in)t.RemoveDependent(this);this.edges_out=[],this.edges_in=[]}ClearDependencies(){for(const t of this.edges_in)t.RemoveDependent(this);this.edges_in=[]}AddDependent(t){if(t!==this){for(const e of this.edges_out)if(e===t)return;this.edges_out.push(t)}}RemoveDependent(t){this.edges_out=this.edges_out.filter((e=>e!==t))}AddDependency(t){if(t!==this){for(const e of this.edges_in)if(e===t)return;this.edges_in.push(t)}}RemoveDependency(t){this.edges_in=this.edges_in.filter((e=>e!==t))}LinkTo(t){this.AddDependent(t),t.AddDependency(this)}DependsOn(t){this.AddDependency(t),t.AddDependent(this)}LoopCheck(){this.color=G.gray;for(const t of this.edges_out)if(t.color===G.gray||t.color===G.white&&t.LoopCheck())return this.color=G.white,!0;return this.color=G.black,!1}}H.type="vertex";class $ extends H{constructor(){super(...arguments),this.dirty=!1}}!function(t){t[t.None=0]="None",t[t.CalculationError=1]="CalculationError"}(B||(B={}));class Z extends ${constructor(){super(...arguments),this.error=B.None,this.result=l(),this.expression={type:"missing",id:-1},this.expression_error=!1,this.short_circuit=!1,this.type=Z.type}get array_head(){return!!this.address&&!!this.reference&&!!this.reference.area&&this.reference.area.start.column===this.address.column&&this.reference.area.start.row===this.address.row}TakeReferenceValue(){this.reference&&(this.result=h(this.reference.GetValue()))}Calculate(t){if(this.dirty)if(this.color===G.white&&this.LoopCheck()&&(this.dirty=!1,this.edges_in.length)){this.reference&&(this.array_head||this.reference.type===e.formula)&&this.reference.SetCalculationError("LOOP");for(const e of this.edges_out)e.Calculate(t)}else{for(const t of this.edges_in)if(t.dirty)return;if(this.reference){if(this.reference.type===e.formula){this.short_circuit=!1;const e=t.CalculationCallback.call(t,this);if(this.result=e.value,this.short_circuit)return;e.volatile&&t.volatile_list.push(this)}else this.result=this.reference.GetValue4();if(this.array_head)t.SpreadCallback.call(t,this,this.result);else if(this.reference.type===e.formula){const t=Array.isArray(this.result)?this.result[0][0]:this.result;this.reference.SetCalculatedValue(t.value,t.type)}}else console.info("skip dirty constant? [or dangling...]");this.dirty=!1;for(const e of this.edges_out)e.Calculate(t)}}}Z.type="spreadsheet-vertex";class W extends ${constructor(t){super(),this.type=W.type,this.area=t.Clone(),W.list.push(this)}static GetVertex(t){for(const e of this.list)if(e.area.start.sheet_id===t.start.sheet_id&&e.area.Equals(t))return[e,!1];return[new W(t),!0]}static Clear(){this.list=[]}static GetContainingArrays(t){const e=[];for(const r of this.list)r.area.start.sheet_id===t.sheet_id&&r.area.Contains(t)&&e.push(r);return e}static CreateImplicitEdges(t,e){for(const r of this.list)r.area.start.sheet_id===e.sheet_id&&r.area.Contains(e)&&r.DependsOn(t)}RemoveDependent(t){super.RemoveDependent(t),this.edges_out.length||(this.Reset(),W.list=W.list.filter((t=>t!==this)))}Calculate(t){if(this.dirty)if(this.color===G.white&&this.LoopCheck()&&(this.dirty=!1,this.edges_in.length))for(const e of this.edges_out)e.Calculate(t);else{for(const t of this.edges_in)if(t.dirty)return;this.dirty=!1;for(const e of this.edges_out)e.Calculate(t)}}}W.type="array-vertex",W.list=[],function(t){t[t.OK=0]="OK",t[t.Loop=1]="Loop",t[t.CalculationError=2]="CalculationError"}(J||(J={})),function(t){t.Argument="ARG",t.Data="DATA",t.Reference="REF",t.Name="NAME",t.Expression="EXPR",t.Value="VALUE",t.Unknown="UNK",t.NotImpl="NOTIMPL",t.Div0="DIV/0",t.NA="N/A"}(z||(z={}));const Q={error:z.NotImpl},Y=()=>({type:e.error,value:z.Expression}),K=()=>({type:e.error,value:z.Data}),X=()=>({type:e.error,value:z.Div0}),tt=()=>({type:e.error,value:z.Argument}),et=()=>({type:e.error,value:z.Value}),rt=()=>({type:e.error,value:z.Reference}),st=()=>({type:e.error,value:z.Name}),it=()=>({type:e.error,value:z.Unknown});var nt;!function(t){t[t.value=0]="value",t[t.reference=1]="reference"}(nt||(nt={}));const at=(t,r)=>{if(t.type===e.error)return[0,0,t];if(r.type===e.error)return[0,0,r];const s=[0,0];switch(t.type){case e.number:s[0]=t.value;break;case e.boolean:s[0]=t.value?1:0;break;case e.undefined:break;default:return[0,0,et()]}switch(r.type){case e.number:s[1]=r.value;break;case e.boolean:s[1]=r.value?1:0;break;case e.undefined:break;default:return[0,0,et()]}return s},ot=(t,r)=>{const[s,i,n]=at(t,r);return n||{value:s+i,type:e.number}},lt=(t,r)=>{const[s,i,n]=at(t,r);return n||{value:s-i,type:e.number}},ht=(t,r)=>{const[s,i,n]=at(t,r);return n||{value:Math.pow(s,i),type:e.number}},ut=(t,r)=>{const[s,i,n]=at(t,r);return n||{value:s*i,type:e.number}},ct=(t,r)=>{const[s,i,n]=at(t,r);return n||(0===i?X():{value:s/i,type:e.number})},dt=(t,r)=>{const[s,i,n]=at(t,r);return n||(0===i?X():{value:s%i,type:e.number})},mt=(t,r)=>t.type===e.error?t:r.type===e.error?r:{type:e.string,value:`${t.type===e.undefined?"":t.value}${r.type===e.undefined?"":r.value}`},ft=(t,r)=>t.type===e.error?t:r.type===e.error?r:t.type===e.undefined&&(""===r.value||0===r.value)||r.type===e.undefined&&(""===t.value||0===t.value)?{type:e.boolean,value:!0}:{type:e.boolean,value:t.value==r.value},pt=(t,r)=>t.type===e.error?t:r.type===e.error?r:t.type===e.undefined&&(""===r.value||0===r.value)||r.type===e.undefined&&(""===t.value||0===t.value)?{type:e.boolean,value:!1}:{type:e.boolean,value:t.value!=r.value},_t=(t,r)=>t.type===e.error?t:r.type===e.error?r:{type:e.boolean,value:(t.value||0)>(r.value||0)},gt=(t,r)=>t.type===e.error?t:r.type===e.error?r:{type:e.boolean,value:t.value>=r.value},yt=(t,r)=>t.type===e.error?t:r.type===e.error?r:{type:e.boolean,value:t.value<r.value},vt=(t,r)=>t.type===e.error?t:r.type===e.error?r:{type:e.boolean,value:t.value<=r.value},bt=t=>!Array.isArray(t)&&t.type===e.object&&!!t.value.type,wt=t=>!Array.isArray(t)&&t.type===e.object&&"metadata"===t.value.type;class xt{constructor(t,e){this.library=t,this.parser=e,this.context={address:{row:-1,column:-1},volatile:!1,call_index:0},this.call_index=0,this.cells_map={},this.sheet_name_map={},this.named_range_map={}}SetModel(t){this.cells_map={},this.sheet_name_map={};for(const e of t.sheets)this.cells_map[e.id]=e.cells,this.sheet_name_map[e.name.toLowerCase()]=e.id;this.data_model=t,this.named_range_map=t.named_ranges.Map(),this.context.model=t}Calculate(t,e,r=!1){return r||(this.context.address=e,this.context.volatile=!1,this.context.call_index=0,this.call_index=0),{value:this.CalculateExpression(t),volatile:this.context.volatile}}CellFunction2(t){if(!t.sheet_id){if(!t.sheet)return()=>rt();t.sheet_id=this.sheet_name_map[t.sheet.toLowerCase()]}const r=this.cells_map[t.sheet_id];if(!r)return console.warn("missing cells reference @ "+t.sheet_id),()=>rt();const s=r.GetCell(t);return s?()=>s.GetValue4():()=>({type:e.undefined,value:void 0})}CellFunction4(t,e){if(!t.sheet_id)throw new Error("missing sheet id in CellFunction4");return this.cells_map[t.sheet_id].GetRange4(t,e,!0)}GetMetadata(t,r){let s,i;switch(t.type){case"address":s=t;break;case"range":i=t;break;case"identifier":{const e=this.named_range_map[t.name.toUpperCase()];e&&(1===e.count?s=e.start:i=e)}break;case"call":{const e=this.CalculateExpression(t,!0);if(!bt(e))return e;if("address"===e.value.type)s=e.value;else{if("range"!==e.value.type)return e;i=e.value}}break;default:return this.CalculateExpression(t)}if(s){let t=this.data_model.active_sheet;if(s.sheet_id&&s.sheet_id!==t.id)for(const e of this.data_model.sheets)if(e.id===s.sheet_id){t=e;break}const i=t.CellData(s),n=i.calculated_type?i.calculated:i.value,a=Object.assign({type:"metadata",address:Object.assign({},s),value:n,format:i.style?i.style.number_format:void 0},r(i,s));return{type:e.object,value:a}}if(i){if(i.start.row===1/0||i.start.column===1/0)return rt();let t=this.data_model.active_sheet;if(i.start.sheet_id&&i.start.sheet_id!==t.id)for(const e of this.data_model.sheets)if(e.id===i.start.sheet_id){t=e;break}const n=[];for(let a=i.start.column;a<=i.end.column;a++){const o=[];for(let n=i.start.row;n<=i.end.row;n++){const l=t.CellData({row:n,column:a});s=Object.assign(Object.assign({},i.start),{row:n,column:a});const h=l.calculated_type?l.calculated:l.value,u=Object.assign({type:"metadata",address:s,value:h,format:l.style?l.style.number_format:void 0},r(l,s));o.push({type:e.object,value:u})}n.push(o)}return n}return this.CalculateExpression(t)}RewriteMacro(t,e){let r;switch(t.type){case"identifier":if(r=e[t.name.toUpperCase()],r)return JSON.parse(JSON.stringify(r));break;case"binary":t.left=this.RewriteMacro(t.left,e),t.right=this.RewriteMacro(t.right,e);break;case"unary":t.operand=this.RewriteMacro(t.operand,e);break;case"group":t.elements=t.elements.map((t=>this.RewriteMacro(t,e)));break;case"call":t.args=t.args.map((t=>this.RewriteMacro(t,e)))}return t}CallMacro(t,e){var r;if(!e.expression)return()=>Y();const s=JSON.stringify(e.expression),i={},n=(null===(r=e.argument_names)||void 0===r?void 0:r.map((t=>t.toUpperCase())))||[];return t=>{const e=JSON.parse(s);for(let e=0;e<n.length;e++)i[n[e]]=t.args[e]||{type:"missing"};return this.CalculateExpression(this.RewriteMacro(e,i))}}CallExpression(t,r=!1){const s=this.library.Get(t.name);return s?i=>{const n=this.call_index++;this.context.volatile=this.context.volatile||!!s.volatile;const a="if"===t.name.toLowerCase();let o,h=-1;const u=s.arguments||[],c=i.args.map(((t,r)=>{if(o)return;const s=u[Math.min(r,u.length-1)]||{};if(r===h)return s.boxed?l():void 0;if(void 0===t)return a&&0===r&&(h=1),s.boxed?l():void 0;if(s.address)return s.boxed?{type:e.string,value:this.parser.Render(t).replace(/\$/g,"")}:this.parser.Render(t).replace(/\$/g,"");if(s.metadata)return this.GetMetadata(t,(()=>({})));{const i=this.CalculateExpression(t);if(!Array.isArray(i)&&i.type===e.error)return s.allow_error?i:void(o=i);if(a&&0===r&&!Array.isArray(i)){let t=!1;if(i.type===e.string){const e=i.value.toLowerCase().trim();t="false"!==e&&"f"!==e}else t=!!i.value;h=t?2:1}return s.boxed?i:Array.isArray(i)?i.map((t=>t.map((t=>t.value)))):i.value}}));if(o)return o;if(this.context.call_index=n,s.return_type===nt.reference){const t=s.fn.apply(null,c);if(r)return t;if(bt(t)){if("address"===t.value.type)return this.CellFunction2(t.value)();if("range"===t.value.type)return this.CellFunction4(t.value.start,t.value.end)}return t}return s.fn.apply(null,c)}:()=>st()}UnaryExpression(t){switch(t.operator){case"+":return t=>this.CalculateExpression(t.operand);case"-":{const t=lt,r={type:e.number,value:0};return e=>{const s=this.CalculateExpression(e.operand);return Array.isArray(s)?s.map((e=>e.map((e=>t(r,e))))):t(r,s)}}default:return()=>(console.warn("unexpected unary operator:",t.operator),Y())}}RecycleArray(t,e,r){if(t[0].length<r){const e=t[0].length;for(const s of t)for(let t=e;t<r;t++)s[t]=s[t%e]}if(t.length<e){const r=t.length;for(let s=r;s<e;s++)t[s]=t[s%r].slice(0)}return t}ElementwiseBinaryExpression(t,e,r){const s=Math.max(e.length,r.length),i=Math.max(e[0].length,r[0].length);e=this.RecycleArray(e,s,i),r=this.RecycleArray(r,s,i);const n=[];for(let a=0;a<s;a++){const s=[];for(let n=0;n<i;n++)s[n]=t(e[a][n],r[a][n]);n.push(s)}return n}BinaryExpression(t){const e=(t=>{switch(t){case"&":return mt;case"+":return ot;case"-":return lt;case"*":return ut;case"/":return ct;case"^":case"**":return ht;case"%":return dt;case"=":case"==":return ft;case"!=":case"<>":return pt;case">":return _t;case">=":return gt;case"<":return yt;case"<=":return vt}})(t.operator);return e?t=>{const r=this.CalculateExpression(t.left),s=this.CalculateExpression(t.right);return Array.isArray(r)?Array.isArray(s)?this.ElementwiseBinaryExpression(e,r,s):this.ElementwiseBinaryExpression(e,r,[[s]]):Array.isArray(s)?this.ElementwiseBinaryExpression(e,[[r]],s):e(r,s)}:()=>(console.info(`(unexpected binary operator: ${t.operator})`),Y())}Identifier(t){const r=t.name,s=r.toUpperCase();switch(s){case"FALSE":case"F":return()=>({value:!1,type:e.boolean});case"TRUE":case"T":return()=>({value:!0,type:e.boolean});case"UNDEFINED":return()=>({value:void 0,type:e.undefined})}return()=>{const t=this.named_range_map[s];return t?1===t.count?this.CellFunction4(t.start,t.start):this.CellFunction4(t.start,t.end):(console.info("** identifier",r),st())}}GroupExpression(t){return t.elements&&1===t.elements.length?t=>this.CalculateExpression(t.elements[0]):(console.warn("Can't handle group !== 1"),()=>Y())}CalculateExpression(t,r=!1){if(t.user_data)return t.user_data(t);switch(t.type){case"call":{const e=this.data_model.macro_functions[t.name.toUpperCase()];return e?(t.user_data=this.CallMacro(t,e))(t):(t.user_data=this.CallExpression(t,r))(t)}case"address":return(t.user_data=this.CellFunction2(t))();case"range":return(t.user_data=t=>this.CellFunction4(t.start,t.end))(t);case"binary":return(t.user_data=this.BinaryExpression(t))(t);case"unary":return(t.user_data=this.UnaryExpression(t))(t);case"identifier":return(t.user_data=this.Identifier(t))();case"missing":return(t.user_data=()=>({value:void 0,type:e.undefined}))();case"literal":{const e={value:t.value,type:s(t.value)};return(t.user_data=()=>e)()}case"group":return(t.user_data=this.GroupExpression(t))(t);case"array":return(t.user_data=()=>t.values.map((t=>(Array.isArray(t)?t:[t]).map((t=>({value:t,type:s(t)}))))))();default:return console.warn("Unhandled parse expr:",t),it()}}}const Mt=t=>{const e=[],r=t.length,s=t[0].length;for(let i=0;i<s;i++){e[i]=[];for(let s=0;s<r;s++)e[i][s]=t[s][i]}return e},Ct=t=>Array.isArray(t)?t.reduce(((t,e)=>void 0===e?t:Array.isArray(e)?t.concat(Ct(e)):e instanceof Float32Array||e instanceof Float64Array?t.concat(Array.from(e)):t.concat([e])),[]):[t],St=t=>(e,...r)=>Array.isArray(e)?e.map((e=>e.map((e=>t(e,...r))))):t(e,...r),At=t=>(e,r,...s)=>Array.isArray(e)?Array.isArray(r)?e.map(((e,i)=>e.map(((e,n)=>t(e,r[i][n],...s))))):e.map((e=>e.map((e=>t(e,r,...s))))):t(e,r,...s);class Rt{constructor(){this.functions={}}Register(...t){for(const e of t)for(const t of Object.keys(e)){if(/[^a-zA-Z0-9._]/.test(t))throw new Error("invalid function name (invalid character)");if(t.length>255)throw new Error("invalid function name (too long, > 255)");if(/^[^a-zA-Z]/.test(t))throw new Error("invalid function name (start with an ascii letter)");const r=t.toLowerCase();if(this.functions[r])throw new Error(`function name (${r}) is already in use`);const s=e[t];s.canonical_name=t,this.functions[r]=s}}Get(t){const e=t.toLowerCase();return this.functions[e]}List(){const t={};for(const e of Object.keys(this.functions))t[e]=this.functions[e];return t}Alias(t,e){const r=this.Get(e);if(!r)throw new Error(`referenced function ${e} does not exist`);this.Register({[t]:Object.assign({},r)})}}var kt;!function(t){t[t.move=0]="move",t[t.line=1]="line"}(kt||(kt={}));class Nt{static UnpackValues(t){if(Array.isArray(t)){const e=t[0];return Array.isArray(e)||e instanceof Float64Array||e instanceof Float32Array?t.reduce(((t,e)=>t.concat(this.UnpackValues(e))),[]):t.map((t=>isNaN(t)?void 0:t))}if(t instanceof Float32Array||t instanceof Float64Array)return Array.prototype.slice.call(t);if(t&&"object"==typeof t){const e=Object.keys(t).length;if(void 0!==t[0]&&void 0!==t[(e-1).toString()]){const r=[];for(let s=0;s<e;s++)r[s]=t[s.toString()];return r}}return[]}static SparklineCommon(t,e){var r;let s=[];const i=(null===(r=e.text)||void 0===r?void 0:r.text)||this.default_color,n=[i,i];return Array.isArray(t.calculated)&&(s=this.UnpackValues(t.calculated[0]),"string"==typeof t.calculated[1]&&(n[0]=t.calculated[1]),"string"==typeof t.calculated[2]&&(n[1]=t.calculated[2])),{values:s,colors:n}}static RenderLine(t,e,r,s,i){const{values:n,colors:a}=this.SparklineCommon(s,i);let o=1;Array.isArray(s.calculated)&&"number"==typeof s.calculated[2]&&(o=s.calculated[2]);let l=0,h=0,u=-1;for(let t=0;t<n.length;t++){const e=n[t];"number"==typeof e&&(u>=0?(l=Math.min(l,e),h=Math.max(h,e)):(u=t,l=h=e))}if(l!==h){const s=.9*t/(n.length-1),i=h-l,c=.8*e,d=.1*e;r.strokeStyle=a[0],r.lineWidth=o,r.lineCap="round",r.lineJoin="round",r.beginPath();let m=kt.move;for(let a=u;a<n.length;a++){const o=n[a];if("number"==typeof o){const n=.05*t+s*a,h=e-(o-l)*c/i-d;m===kt.move?(r.moveTo(n,h),m=kt.line):r.lineTo(n,h)}else m=kt.move}r.stroke()}}static RenderColumn(t,e,r,s,i){const{values:n,colors:a}=this.SparklineCommon(s,i);let o=0,l=0,h=!1;for(const t of n)"number"==typeof t&&(h?(o=Math.min(o,t),l=Math.max(l,t)):(h=!0,o=l=t));if(n.length){const s=(t-6-2)/(n.length-1),i=e-5,h=2.5;if(o!==l)if(o<0&&l>0){const t=l-o,e=h+l/t*i;for(let o=0;o<n.length;o++){const l=n[o];if("number"==typeof l){const n=3+o*s,h=Math.abs(l)/t*i;if(l>=0){r.fillStyle=a[0];const t=e-h;r.fillRect(n+2,t,s-2,h)}else{r.fillStyle=a[1];const t=e;r.fillRect(n+2,t,s-2,h)}}}}else if(l>0){r.fillStyle=a[0];const t=l-o;for(let a=0;a<n.length;a++){const l=n[a];if("number"==typeof l){const n=3+a*s,u=Math.max(1,(l-o)/t*i),c=e-h-u;r.fillRect(n+2,c,s-2,u)}}}else{r.fillStyle=a[1];const t=l-o;for(let e=0;e<n.length;e++){const a=n[e];if("number"==typeof a){const n=3+e*s,o=Math.max(1,Math.abs(l-a)/t*i),u=h;r.fillRect(n+2,u,s-2,o)}}}}}}Nt.default_color="#888";const Dt=t=>{const e=1/(1+.3275911*(t=Math.abs(t)));return 1-((((1.061405429*e-1.453152027)*e+1.421413741)*e-.284496736)*e+.254829592)*e*Math.exp(-1*t*t)},Pt=t=>{if(.5===t)return 0;const e=t<1&&t>.5?1-t:t,r=Math.sqrt(Math.log(1/Math.pow(e,2))),s=r-(2.515517+.802853*r+.010328*Math.pow(r,2))/(1+1.432788*r+.189269*Math.pow(r,2)+.001308*Math.pow(r,3));return t>.5?s:-s},Et={type:e.boolean,value:!0},Tt={type:e.boolean,value:!1},Ft={Rand:{volatile:!0,fn:()=>({type:e.number,value:Math.random()})},RandBetween:{arguments:[{name:"min"},{name:"max"}],volatile:!0,fn:(t=0,r=1)=>{if(t>r){const e=t;t=r,r=e}return{type:e.number,value:Math.random()*(r-t)+t}}},Sum:{description:"Adds arguments and ranges",arguments:[{boxed:!0,name:"values or ranges"}],fn:(...t)=>{let r=0;const s=Ct(t);for(const t of s)switch(t.type){case e.number:r+=t.value;break;case e.boolean:r+=t.value?1:0;break;case e.error:return t}return{type:e.number,value:r}}},Now:{description:"Returns current time",volatile:!0,fn:()=>({type:e.number,value:w((new Date).getTime())})},Today:{description:"Returns current day",volatile:!0,fn:()=>{const t=new Date;return t.setMilliseconds(0),t.setSeconds(0),t.setMinutes(0),t.setHours(12),{type:e.number,value:w(t.getTime())}}},IfError:{description:"Returns the original value, or the alternate value if the original value contains an error",arguments:[{name:"original value",allow_error:!0,boxed:!0},{name:"alternate value"}],fn:(t,r=0)=>t&&t.type===e.error?{value:r,type:s(r)}:t},IsError:{description:"Checks if another cell contains an error",arguments:[{name:"reference",allow_error:!0,boxed:!0}],fn:t=>{if(Array.isArray(t)){const r=Ct(t);for(const t of r)if(t.type===e.error)return{type:e.boolean,value:!0}}else if(t)return{type:e.boolean,value:t.type===e.error};return{type:e.boolean,value:!1}}},Cell:{description:"Returns data about a cell",arguments:[{name:"type",description:"Type of data to return"},{name:"reference",description:"Cell reference",metadata:!0}],fn:(t,r)=>{if(!wt(r))return rt();if(t)switch(t.toString().toLowerCase()){case"format":return r.value.format?{type:e.string,value:r.value.format}:rt();case"address":return{type:e.string,value:r.value.address.label.replace(/\$/g,"")}}return{type:e.error,value:Q.error}}},Year:{description:"Returns year from date",arguments:[{name:"date"}],fn:t=>h(new Date(b(t)).getUTCFullYear())},Month:{description:"Returns month from date",arguments:[{name:"date"}],fn:t=>h(new Date(b(t)).getUTCMonth()+1)},Day:{description:"Returns day of month from date",arguments:[{name:"date"}],fn:t=>h(new Date(b(t)).getUTCDate())},Radians:{description:"Converts degrees to radians",arguments:[{name:"Degrees",description:"Angle in degrees"}],fn:St((t=>h(t*Math.PI/180)))},Degrees:{description:"Converts radians to degrees",arguments:[{name:"Radians",description:"Angle in radians"}],fn:St((t=>h(t/Math.PI*180)))},CountA:{description:"Counts cells that are not empty",fn:(...t)=>h(Ct(t).reduce(((t,e)=>void 0===e?t:t+1),0))},Count:{description:"Counts cells that contain numbers",fn:(...t)=>h(Ct(t).reduce(((t,e)=>"number"==typeof e?t+1:t),0))},Or:{fn:(...t)=>{let e=!1;t=Ct(t);for(const r of t)e=e||!!r;return h(e)}},And:{fn:(...t)=>{let e=!0;t=Ct(t);for(const r of t)e=e&&!!r;return h(e)}},Not:{fn:(...t)=>0===t.length?tt():1===t.length?h(!t[0]):h(!0)},If:{arguments:[{name:"test value",boxed:!0},{name:"value if true",boxed:!0,allow_error:!0},{name:"value if false",boxed:!0,allow_error:!0}],fn:(t,e=Et,r=Tt)=>Array.isArray(t)?t.map(((t,s)=>t.map(((t,i)=>(o(t)?"false"!==t.value.toLowerCase()&&"f"!==t.value.toLowerCase():t.value)?Array.isArray(e)?e[s][i]:e:Array.isArray(r)?r[s][i]:r)))):(o(t)?"false"!==t.value.toLowerCase()&&"f"!==t.value.toLowerCase():t.value)?e:r},Power:{fn:At(((t,e)=>h(Math.pow(t,e))))},Mod:{fn:At(((t,e)=>e?h(t%e):X()))},Sort:{arguments:[{name:"values"}],fn:(...t)=>((t=Ct(t)).every((t=>"number"==typeof t))?t.sort(((t,e)=>t-e)):t.sort(),[t.map((t=>h(t)))])},Transpose:{description:"Returns transpose of input matrix",arguments:[{name:"matrix",boxed:!0}],fn:t=>Array.isArray(t)?Mt(t):t},Max:{fn:(...t)=>({type:e.number,value:Math.max.apply(0,Ct(t).filter((t=>"number"==typeof t)))})},Min:{fn:(...t)=>({type:e.number,value:Math.min.apply(0,Ct(t).filter((t=>"number"==typeof t)))})},SumProduct:{description:"Returns the sum of pairwise products of two or more ranges",fn:(...t)=>{const r=t.map((t=>Ct(t))),s=Math.max.apply(0,r.map((t=>t.length)));let i=0;for(let t=0;t<s;t++)i+=r.reduce(((e,r)=>e*(r[t]||0)),1);return{type:e.number,value:i}}},VLookup:{fn:(t,r,s,i=!0)=>{if(s=Math.max(0,s-1),i){let e=Math.abs(t-r[0][0]),i=r[s][0];for(let n=1;n<r[0].length;n++){const a=Math.abs(r[0][n]-t);a<e&&(e=a,i=r[s][n])}return h(i)}for(let e=1;e<r[0].length;e++)if(r[0][e]==t)return r[s][e];return{type:e.error,value:z.NA}}},Product:{fn:(...t)=>({type:e.number,value:Ct(t).reduce(((t,e)=>void 0===e?t:t*Number(e)),1)})},Log:{fn:At(((t,r=10)=>({type:e.number,value:Math.log(t)/Math.log(r)})))},Log10:{fn:St((t=>({type:e.number,value:Math.log(t)/Math.log(10)})))},Ln:{fn:St((t=>({type:e.number,value:Math.log(t)})))},Round:{fn:At(((t,r=0)=>{const s=Math.pow(10,r);return{type:e.number,value:Math.round(s*t)/s}}))},RoundDown:{fn:At(((t,r=0)=>{const s=Math.pow(10,r),i=t>=0;return{type:e.number,value:i?Math.floor(s*t)/s:Math.ceil(s*t)/s}}))},Reverse:{arguments:[{boxed:!0}],fn:t=>Array.isArray(t)?1===t.length?[t[0].reverse()]:t.reverse():{type:e.string,value:t.value.toString().split("").reverse().join("")}},Abs:{fn:St((t=>({type:e.number,value:Math.abs(t)})))},Simplify:{fn:At(((t,r=2)=>{if(r=r||2,0===t)return{type:e.number,value:t};const s=t<0?-1:1;t*=s;const i=Math.pow(10,Math.floor(Math.log10(t))+1-r);return{type:e.number,value:Math.round(t/i)*i*s}}))},Erf:{fn:t=>({type:e.number,value:Dt(t)})},NormsInv:{description:"Inverse of the normal cumulative distribution",arguments:[{name:"probability"}],fn:t=>({type:e.number,value:Pt(t)})},"Norm.Inv":{description:"Inverse of the normal cumulative distribution",arguments:[{name:"probability"},{name:"mean",default:0},{name:"standard deviation",default:1}],fn:(t,r=0,s=1)=>({type:e.number,value:Pt(t)*s+r})},"Norm.Dist":{description:"Cumulative normal distribution",arguments:[{name:"value"},{name:"mean",default:0},{name:"standard deviation",default:1}],fn:(t,r=0,s=1)=>{const i=t<r?-1:1;return{type:e.number,value:.5*(1+i*Dt(Math.abs(t-r)/(s*Math.sqrt(2))))}}},HexToDec:{arguments:[{description:"hexadecimal string"}],fn:t=>({type:e.number,value:parseInt(t,16)})},DecToHex:{arguments:[{description:"number"}],fn:t=>({type:e.string,value:t.toString(16)})},Checkbox:{arguments:[{name:"checked"}],click:t=>{const{x:e,y:r,width:s,height:i,cell:n}=t,a={};if(n&&s&&i&&e&&r){const t={x:3,y:i-3-16};if(n.style){switch(n.style.vertical_align){case p.VerticalAlign.Top:t.y=3;break;case p.VerticalAlign.Middle:t.y=Math.round(i/2-8)}switch(n.style.horizontal_align){case p.HorizontalAlign.Right:t.x=Math.round(s-3-16);break;case p.HorizontalAlign.Center:t.x=Math.round(s/2-8)}}e>=t.x&&e<=t.x+16&&r>=t.y&&r<=t.y+16&&(a.value=`=Checkbox(${n.calculated?"FALSE":"TRUE"})`,a.block_selection=!0)}return a},render:t=>{const{context:e,width:r,height:s,cell:i}=t,n=t.scale||1;e.lineJoin="round",e.lineCap="round";const a=3*n;let o=a,l=s-a-16*n;if(i.style){switch(i.style.vertical_align){case p.VerticalAlign.Top:l=a;break;case p.VerticalAlign.Middle:l=Math.round(s/2-8*n)}switch(i.style.horizontal_align){case p.HorizontalAlign.Right:o=Math.round(r-a-16*n);break;case p.HorizontalAlign.Center:o=Math.round(r/2-8*n)}}if(i&&i.calculated){e.lineWidth=.5,e.fillStyle=e.strokeStyle,e.beginPath(),e.moveTo(o,l),e.lineTo(o+16*n,l),e.lineTo(o+16*n,l+16*n),e.lineTo(o,l+16*n),e.closePath(),e.moveTo(o+15*n,l+4*n);for(const t of[[13.59,2.58],[6,10.17],[2.41,6.59],[1,8],[6,13]])e.lineTo(o+t[0]*n,l+t[1]*n);e.closePath(),e.fill()}else e.lineWidth=Math.max(2,2*n),e.strokeRect(o,l,16*n,16*n);return{handled:!0}},fn:t=>({value:!!t,type:e.boolean})},"Sparkline.Column":{arguments:[{name:"data"},{name:"color"},{name:"negative color"}],render:t=>(Nt.RenderColumn(t.width,t.height,t.context,t.cell,t.style),{handled:!0}),fn:(...t)=>({type:e.object,value:t})},"Sparkline.Line":{arguments:[{name:"data"},{name:"color"},{name:"line width"}],render:t=>(Nt.RenderLine(t.width,t.height,t.context,t.cell,t.style),{handled:!0}),fn:(...t)=>({type:e.object,value:t})}},Ot={};for(const t of Object.keys(Ft))Ot[t.toLowerCase()]=t;for(const t of Object.getOwnPropertyNames(Math)){if(Ot[t.toLowerCase()])continue;const r=Object.getOwnPropertyDescriptor(Math,t);if(!r)continue;const s=r.value,i=typeof s;switch(i){case"number":Ft[t]={fn:()=>({type:e.number,value:s}),category:["Math Functions"]};break;case"function":Ft[t]={fn:(...t)=>h(s(...t)),category:["Math Functions"]};break;default:console.info("unexpected type:",i,t)}}Math.log10||(Math.log10=t=>Math.log(t)/Math.log(10));const Lt=(t,e,r=0,s=0,i=0)=>i?-r*(t/(1-Math.pow(1+t,-e)))/(1+t)-s*(1/((1+t)*((Math.pow(1+t,e)-1)/t))):-(r*t*Math.pow(1+t,e)+s*t)/(Math.pow(1+t,e)-1),It=(t,e,r,s=0,i=0)=>i?(1+t)*-r/t*(Math.pow(1+t,e)-1)-s*Math.pow(1+t,e):-r/t*(Math.pow(1+t,e)-1)-s*Math.pow(1+t,e),Ut=(t,e,r,s=0,i=0,n=0)=>{if(e<1)return NaN;if(1===e&&n)return 0;const a=Lt(t,r,s,i,n),o=It(t,e-1,a,s,n)*t;return n?o/(1+t):o},Vt=(t,e,r,s=0,i=0,n=0)=>Lt(t,r,s,i,n)-Ut(t,e,r,s,i,n),jt={NPV:{description:"Returns the present value of a series of future cashflows",arguments:[{name:"Rate"},{name:"Cashflow"}],fn:(t=0,...r)=>{let s=0;const i=Ct(r);for(let e=0;e<i.length;e++){const r=i[e];"number"==typeof r&&(s+=Math.pow(1+t,-(e+1))*r)}return{type:e.number,value:s}}},IRR:{description:"Calculates the internal rate of return of a series of cashflows",arguments:[{name:"Cashflows"},{name:"Guess",default:.1}],fn:(t,r=.1)=>{const s=Ct(t).map((t=>"number"==typeof t?t:0)),i=[{found:!1,value:0},{found:!1,value:0}];for(let t=0;t<50;t++){let t=0;for(let e=0;e<s.length;e++)t+=Math.pow(1+r,-(e+1))*s[e];if(Math.abs(t)<=.00125)return{type:e.number,value:r};if(t>0){if(i[0].value=i[0].found?Math.max(i[0].value,r):r,i[0].found=!0,!i[1].found){r+=.1;continue}}else if(i[1].value=i[1].found?Math.min(i[1].value,r):r,i[1].found=!0,!i[0].found){r-=.1;continue}r=i[0].value+(i[1].value-i[0].value)/2}return{type:e.error,value:"NUM"}}},CUMPRINC:{description:"Returns cumulative principal paid on a loan between two periods",arguments:[{name:"Rate"},{name:"Periods"},{name:"Present Value"},{name:"Start Period"},{name:"End Period"},{name:"Type",default:0}],fn:(t,r,s,i,n,a=0)=>{let o=0;for(let e=i;e<=n;e++)o+=Vt(t,e,r,s,0,a);return{type:e.number,value:o}}},CUMIPMT:{description:"Returns cumulative interest paid on a loan between two periods",arguments:[{name:"Rate"},{name:"Periods"},{name:"Present Value"},{name:"Start Period"},{name:"End Period"},{name:"Type",default:0}],fn:(t,r,s,i,n,a=0)=>{let o=0;for(let e=i;e<=n;e++)o+=Ut(t,e,r,s,0,a);return{type:e.number,value:o}}},IPMT:{description:"Returns the interest portion of a payment",arguments:[{name:"Rate"},{name:"Period"},{name:"Periods"},{name:"Present Value",default:0},{name:"Future Value",default:0},{name:"Type",default:0}],fn:(t,r,s,i=0,n=0,a=0)=>({type:e.number,value:Ut(t,r,s,i,n,a)})},PPMT:{description:"Returns the principal portion of a payment",arguments:[{name:"Rate"},{name:"Period"},{name:"Periods"},{name:"Present Value",default:0},{name:"Future Value",default:0},{name:"Type",default:0}],fn:(t,r,s,i=0,n=0,a=0)=>({type:e.number,value:Vt(t,r,s,i,n,a)})},Rate:{description:"Returns the interest rate of a loan",arguments:[{name:"Periods"},{name:"Payment"},{name:"Present Value",default:0},{name:"Future Value",default:0},{name:"Type",default:0}],fn:(t,r,s=0,i=0,n=0)=>{let a=.25;const o=[-1,1];for(let l=0;l<32;l++){const l=Lt(a,t,s,i,n);if(Math.abs(l-r)<=1e-6)return{type:e.number,value:a};const h=Lt(o[1],t,s,i,n);r>=l&&r<=h||r>=h&&r<=l?o[0]=a:o[1]=a,a=o[0]+(o[1]-o[0])/2}return{type:e.number,value:a}}},FV:{description:"Returns the future value of an investment",arguments:[{name:"Rate"},{name:"Periods"},{name:"Payment"},{name:"Present Value",default:0},{name:"Type",default:0}],fn:(t,r,s,i=0,n=0)=>({type:e.number,value:It(t,r,s,i,n)})},PV:{description:"Returns the present value of an investment",arguments:[{name:"Rate"},{name:"Periods"},{name:"Payment"},{name:"Future Value",default:0},{name:"Type",default:0}],fn:(t,r,s,i=0,n=0)=>n?(s+=i*(1/((1+t)*((Math.pow(1+t,r)-1)/t))),{type:e.number,value:-(s+s/t*(1-Math.pow(1+t,-(r-1))))}):{type:e.number,value:-(i+s/t*(Math.pow(1+t,r)-1))/Math.pow(1+t,r)}},NPER:{description:"Returns the number of periods of an investment",arguments:[{name:"Rate"},{name:"Payment"},{name:"Present Value"},{name:"Future Value",default:0},{name:"Type",default:0}],fn:(t,r,s=0,i=0,n=0)=>n?{type:e.number,value:1+(-Math.log(1+t*(1-s/-r))+Math.log(1+i*t/(-r*(1+t))))/Math.log(1+t)}:{type:e.number,value:(Math.log(Math.pow(1-s*t/-r,-1))+Math.log(1+i*t/-r))/Math.log(1+t)}},PMT:{description:"Returns the periodic payment of a loan",arguments:[{name:"Rate"},{name:"Periods"},{name:"Present Value"},{name:"Future Value",default:0},{name:"Type",default:0}],fn:(t,r,s,i=0,n=0)=>({type:e.number,value:Lt(t,r,s,i,n)})}},Gt={Char:{arguments:[{name:"number"}],fn:t=>({type:e.string,value:String.fromCodePoint(t||32)}),category:["text"]},Code:{arguments:[{name:"string"}],fn:t=>({type:e.number,value:t.codePointAt(0)}),category:["text"]},Text:{arguments:[{name:"value"},{name:"number format"}],fn:(t,r="0.00####")=>({type:e.string,value:M.Get(r).Format(t||0)}),category:["text"]},Left:{arguments:[{name:"string"},{name:"count"}],fn:(t,r=1)=>({type:e.string,value:t.substr(0,r)}),category:["text"]},Right:{arguments:[{name:"string"},{name:"count"}],fn:(t,r=1)=>({type:e.string,value:t.slice(-r)}),category:["text"]},Mid:{arguments:[{name:"string"},{name:"left"},{name:"count"}],fn:(t,r=0,s=1)=>({type:e.string,value:t.substr(Math.max(0,r-1),s)}),category:["text"]},Search:{description:"Find a string (needle) in another string (haystack). Case-insensitive.",arguments:[{name:"Needle"},{name:"Haystack"},{name:"Start",default:1}],fn:(t,r,s=1)=>{if(s>=1){if(!t)return{type:e.number,value:s};const i=(t=>{const e=[],r=t.length,s="[\\^$.|?*+()";for(let i=0;i<r;i++){let r=t[i];switch(r){case"*":e.push(".","*");break;case"?":e.push(".");break;case"~":r=t[++i]||"";default:for(let t=0;t<s.length;t++)if(r===s[t]){e.push("\\");break}e.push(r)}}return e.join("")})(t),n=new RegExp(i,"i").exec(r.substr(s-1));if(n)return{type:e.number,value:n.index+s}}return et()}},Find:{description:"Find a string (needle) in another string (haystack). Case-sensitive.",arguments:[{name:"Needle"},{name:"Haystack"},{name:"Start",default:1}],fn:(t,r,s=1)=>{if(s>=1){if(!t)return{type:e.number,value:s};const i=new RegExp(t).exec(r.substr(s-1));if(i)return{type:e.number,value:i.index+s}}return et()}},Concat:{description:"Pastes strings together",fn:(...t)=>{const r=Ct(t).map((t=>{var e;const r=(null===(e=t)||void 0===e?void 0:e.toString())||"";return"number"==typeof t&&","===m.decimal_separator?r.replace(/\./,","):r})).join("");return{type:e.string,value:r}}}},Bt={Concatenate:"Concat"},Jt={IsBlank:{description:"Returns true if the reference is blank",arguments:[{name:"Reference",metadata:!0}],fn:St((t=>({type:e.boolean,value:!(null==t?void 0:t.value)||void 0===t.value.value})))},IsNumber:{description:"Returns true if the reference is a number",arguments:[{name:"Reference",metadata:!0}],fn:St((t=>({type:e.boolean,value:(null==t?void 0:t.value)&&"number"==typeof t.value.value})))},IsLogical:{description:"Returns true if the reference is a logical TRUE or FALSE",arguments:[{name:"Reference",metadata:!0}],fn:St((t=>({type:e.boolean,value:(null==t?void 0:t.value)&&"boolean"==typeof t.value.value})))},IsText:{description:"Returns true if the reference is text",arguments:[{name:"Reference",metadata:!0}],fn:St((t=>({type:e.boolean,value:(null==t?void 0:t.value)&&"string"==typeof t.value.value})))}},zt=(t,e=!1)=>{const r=t.length;let s=0,i=0;for(let e=0;e<r;e++)s+=t[e];s/=r;for(let e=0;e<r;e++){const r=t[e]-s;i+=r*r}return e?i/(r-1):i/r},qt={StDev:{description:"Returns the standard deviation of a set of values, corresponding to a population",arguments:[{name:"data"}],fn:(...t)=>({type:e.number,value:Math.sqrt(zt(Ct(t),!1))})},"StDev.S":{description:"Returns the standard deviation of a set of values, corresponding to a sample of a population",arguments:[{name:"data"}],fn:(...t)=>({type:e.number,value:Math.sqrt(zt(Ct(t),!0))})},Var:{description:"Returns the variance of a set of values, corresponding to a population",arguments:[{name:"data"}],fn:(...t)=>({type:e.number,value:zt(Ct(t),!1)})},"Var.S":{description:"Returns the variance of a set of values, corresponding to a sample of a population",arguments:[{name:"data"}],fn:(...t)=>({type:e.number,value:zt(Ct(t),!0)})},Correl:{description:"Returns the correlation between two ranges of values",arguments:[{name:"A"},{name:"B"}],fn:(t,r)=>{if(!Array.isArray(t)||!Array.isArray(r))return et();if(!Array.isArray(t[0])||!Array.isArray(r[0]))return et();let s=0,i=0,n=0,a=0,o=0,l=0,h=0;for(let e=0;e<t.length;e++){if(!t[e]||!r[e])continue;const s=t[e].length;for(let u=0;u<s;u++){const s=Number(t[e][u]),c=Number(r[e][u]);isNaN(s)||isNaN(c)||(i+=s*c,n+=s,a+=c,o+=s*s,l+=c*c,h++)}}return s=h*i-n*a,s&&(s/=Math.sqrt((h*o-n*n)*(h*l-a*a))),{type:e.number,value:s}}},GeoMean:{fn:(...t)=>{t=Ct(t);let r=0,s=1;for(const e of t){if(void 0===e)continue;const t=Number(e);if(t<0)return et();r++,s*=t}return{type:e.number,value:Math.pow(s,1/r)}}},Average:{fn:(...t)=>{const r=(t=Ct(t)).reduce(((t,e)=>void 0===e?t:t+Number(e)),0)/t.length;return{type:e.number,value:r}}},Percentile:{description:"Returns the kth percentile value from the range of data",arguments:[{name:"range"},{name:"percentile"}],fn:(t,r)=>{const s=Ct(t).filter((t=>"number"==typeof t));s.sort(((t,e)=>t-e));const i=s.length,n=Math.pow(10,8),a=Math.round((1+(i-1)*r)*n)/n,o=Math.floor(a),l=Math.ceil(a);return{type:e.number,value:(s[o-1]+s[l-1])/2}}},Median:{description:"Returns the median value of the range of data",arguments:[{name:"range"}],fn:(...t)=>{const r=Ct(t).filter((t=>"number"==typeof t));r.sort(((t,e)=>t-e));const s=1+.5*(r.length-1),i=Math.floor(s),n=Math.ceil(s);return{type:e.number,value:(r[i-1]+r[n-1])/2}}}},Ht={Mean:"Average","StDev.P":"StDev","Var.P":"Var"};class $t extends Z{constructor(){super(...arguments),this.state_id=0,this.type=$t.type,this.state_representation=""}UpdateState(){const t=JSON.stringify(this.edges_in.map((t=>t.result)));t!==this.state_representation&&(this.state_representation=t,this.state_id++)}Calculate(t){if(this.dirty){for(const t of this.edges_in)if(t.dirty)return;this.UpdateState(),this.dirty=!1}}AddDependent(t){throw new Error("leaf vertex cannot have dependents")}}$t.type="leaf-vertex";const Zt=t=>{const e=4+t.data.length,r=new Float64Array(e);return r[0]=t.column,r[1]=t.row,r[2]=t.sheet_id,r[3]=t.data.length,r.set(t.data,4),r},Wt=t=>t.length===3+t[2]?{column:t[0],row:t[1],sheet_id:0,data:t.subarray(3)}:{column:t[0],row:t[1],sheet_id:t[2],data:t.subarray(4)};var Qt,Yt=r(691);!function(t){t[t.Null=0]="Null",t[t.Prep=1]="Prep",t[t.Simulation=2]="Simulation",t[t.Post=3]="Post"}(Qt||(Qt={}));class Kt{constructor(){this.address={row:0,column:0},this.volatile=!1,this.iteration=0,this.iterations=0,this.call_index=0,this.lhs=!1,this.state=Qt.Null,this.results=[],this.elapsed=0,this.trials=0,this.distributions=[],this.correlated_distributions={},this.functions={"Multivariate.Normal":{description:"Returns a sample from the multivariate normal distribution",simulation_volatile:!0,arguments:[{name:"range of values",description:"Set of Correlated Distributions (N)",address:!0},{name:"correlation",description:"Correlation Matrix (NxN)"},{name:"mean",description:"Distribution Mean",default:0},{name:"stdev",description:"Standard Deviation",default:1}],fn:this.multivariate_normal.bind(this),category:["RiskAMP Random Distributions"],extension:!0},"Multivariate.LogNormal":{description:"Returns a sample from the multivariate log-normal distribution",simulation_volatile:!0,arguments:[{name:"range of values",description:"Set of Correlated Distributions (N)",address:!0},{name:"correlation",description:"Correlation Matrix (NxN)"},{name:"mean",description:"Mean of underlying Normal distribution",default:0},{name:"stdev",description:"Standard Deviation of underlying Normal distribution",default:1}],fn:this.multivariate_lognormal.bind(this),category:["RiskAMP Random Distributions"],extension:!0},"Multivariate.Uniform":{description:"Returns a sample from the multivariate uniform distribution",simulation_volatile:!0,arguments:[{name:"range of values",description:"Set of Correlated Distributions (N)",address:!0},{name:"correlation",description:"Correlation Matrix (NxN)"},{name:"min",description:"Minimum Value",default:0},{name:"max",description:"Maximum Value",default:1}],fn:this.multivariate_uniform.bind(this),category:["RiskAMP Random Distributions"],extension:!0},"Multivariate.Beta":{description:"Returns a sample from the multivariate beta distribution",simulation_volatile:!0,arguments:[{name:"range of values",description:"Set of Correlated Distributions (N)",address:!0},{name:"correlation",description:"Correlation Matrix (NxN)"},{name:"w",description:"Shape Parameter"},{name:"v",description:"Shape Parameter"}],fn:this.multivariate_beta.bind(this),category:["RiskAMP Random Distributions"],extension:!0},"Multivariate.PERT":{description:"Returns a sample from the multivariate PERT distribution",simulation_volatile:!0,arguments:[{name:"range of values",description:"Set of Correlated Distributions (N)",address:!0},{name:"correlation",description:"Correlation Matrix (NxN)"},{name:"min",description:"Minimum Value"},{name:"mode",description:"Most-Likely Value"},{name:"max",description:"Maximum Value"},{name:"lambda",default:4}],fn:this.multivariate_pert.bind(this),category:["RiskAMP Random Distributions"],extension:!0},"Multivariate.Triangular":{description:"Returns a sample from the multivariate triangular distribution",simulation_volatile:!0,arguments:[{name:"range of values",description:"Set of Correlated Distributions (N)",address:!0},{name:"correlation",description:"Correlation Matrix (NxN)"},{name:"min",description:"Minimum Value"},{name:"mode",description:"Most-Likely Value"},{name:"max",description:"Maximum Value"}],fn:this.multivariate_triangular.bind(this),category:["RiskAMP Random Distributions"],extension:!0},UniformRangeSample:{description:"Returns one of a set of values, with equal probability and with replacement",simulation_volatile:!0,arguments:[{name:"range",description:"Range of Values"}],fn:this.uniformrangesample.bind(this),category:["RiskAMP Random Distributions"],extension:!0},SampleValue:{description:"Returns one of a set of values, with equal probability and with replacement",simulation_volatile:!0,arguments:[{name:"range",description:"Range of Values"}],fn:this.samplevalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},"SampleValue.Weighted":{description:"Returns one of a set of values, weighted by a second set of values",simulation_volatile:!0,arguments:[{name:"range",description:"Range of Values"},{name:"weights",description:"Range of Weights"}],fn:this.samplevalue_weighted.bind(this),category:["RiskAMP Random Distributions"],extension:!0},BernoulliValue:{description:"Returns true or false (boolean) based on the given probability",simulation_volatile:!0,arguments:[{name:"p",description:"Probability to return True",default:.5}],fn:this.bernoullivalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},ProbabilityValue:{description:"Returns true or false (boolean) based on the given probability",simulation_volatile:!0,arguments:[{name:"p",description:"Probability to return True",default:.5}],fn:this.probabilityvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},UniformValue:{description:"Returns a sample from the uniform distribution",simulation_volatile:!0,arguments:[{name:"min",description:"Minimum",default:0},{name:"max",description:"Maximum",default:1}],fn:this.uniformvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},BetaValue:{description:"Returns a sample from the beta distribution",simulation_volatile:!0,arguments:[{name:"w",description:"Shape Parameter"},{name:"v",description:"Shape Parameter"}],fn:this.betavalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},TruncatedNormalValue:{description:"Returns a sample from the normal distribution",simulation_volatile:!0,arguments:[{name:"mean",description:"Mean",default:0},{name:"stdev",description:"Standard Deviation",default:1},{name:"min",description:"Minimum Value"},{name:"max",description:"Maximum Value"}],fn:this.truncatednormalvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},NormalValue:{description:"Returns a sample from the normal distribution",simulation_volatile:!0,arguments:[{name:"mean",description:"Mean",default:0},{name:"stdev",description:"Standard Deviation",default:1}],fn:this.normalvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},PERTValue:{description:"Returns a sample from the beta-PERT distribution",simulation_volatile:!0,arguments:[{name:"min",description:"Minimum Value",default:0},{name:"mode",description:"Most-Likely Value",default:.5},{name:"max",description:"Maximum Value",default:1},{name:"lambda",default:4}],fn:this.pertvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},LognormalValue:{description:"Returns a sample from the log-normal distribution",simulation_volatile:!0,arguments:[{name:"mean",description:"Mean of underlying Normal distribution",default:0},{name:"stdev",description:"Standard Deviation of underlying Normal distribution",default:1}],fn:this.lognormalvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},SequentialValue:{description:"Returns one from a set of values, in order",simulation_volatile:!0,arguments:[{name:"values",description:"Data Array"},{name:"count",description:"Count",default:0}],fn:this.sequentialvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},IndexValue:{description:"Returns a monotonically increasing value",simulation_volatile:!0,arguments:[{name:"max",description:"Maximum",default:0}],fn:this.indexvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},"PERTValue.P":{description:"Returns a sample from the beta-PERT distribution",simulation_volatile:!0,arguments:[{name:"p10",description:"10th-Percentile Value",default:0},{name:"mode",description:"Most-Likely Value",default:.5},{name:"p90",description:"90th-Percentile Value",default:1},{name:"lambda",default:4}],fn:this.pertvalue_p.bind(this),category:["RiskAMP Random Distributions"],extension:!0},TriangularValue:{description:"Returns a sample from the triangular distribution",simulation_volatile:!0,arguments:[{name:"min",description:"Minimum Value",default:0},{name:"mode",description:"Most Likely Value",default:.5},{name:"max",description:"Maximum Value",default:1}],fn:this.triangularvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},SimulationCorrelation:{description:"Returns the correlation between the data from two cells in the simulation",arguments:[{name:"reference cell",description:"Cell 1",collector:!0},{name:"reference cell",description:"Cell 2",collector:!0}],fn:this.simulationcorrelation.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationRSquared:{description:"Returns the r-squared value (coefficient of correlation) of the data from two cells in the simulation",arguments:[{name:"dependent",description:"Dependent Value",collector:!0},{name:"independent",description:"Indepdendent Value",collector:!0}],fn:this.simulationrsquared.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationSkewness:{description:"Returns the skewness of data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationskewness.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationKurtosis:{description:"Returns the kurtosis (peakedness) of data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationkurtosis.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationPercentile:{description:"Returns the value of a cell at a given percentile in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0},{name:"percentile",description:"Percentile (as %)"}],fn:this.simulationpercentile.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationInterval:{description:"Returns the portion of results in the simulation that fall within some bounds (as a percentage)",arguments:[{name:"reference cell",description:"Source Cell",collector:!0},{name:"min",description:"Minimum Value (optional, inclusive)"},{name:"max",description:"Maximum Value (optional, inclusive)"}],fn:this.simulationinterval.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationMean:{description:"Returns the mean (average) value of the data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationmean.bind(this),extension:!0,category:["RiskAMP Simulation Functions"]},SimulationMedian:{description:"Returns the median value of the data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationmedian.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationValue:{description:"Returns the value of this cell in the simulation at the given trial number",arguments:[{name:"reference cell",description:"Source Cell",collector:!0},{name:"iteration",description:"Trial Number"}],fn:this.simulationvalue.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationValuesArray:{description:"Returns all values of this cell in the simulation, as an array",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationvaluesarray.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SortedSimulationIndex:{description:"Returns the iteration number of a sorted value for this cell",arguments:[{name:"reference cell",description:"Source Cell",collector:!0},{name:"index"}],fn:this.sortedsimulationindex.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},"SimulationValuesArray.Ordered":{description:"Returns all values of this cell in the simulation, as an array, ordered by a second cell",arguments:[{name:"reference cell",description:"Source Cell",collector:!0},{name:"order by",description:"Reference Cell for Ordering",collector:!0}],fn:this.simulationvaluesarray_ordered.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationMin:{description:"Returns the minimum value of the data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationmin.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationMax:{description:"Returns the maximum value of the data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationmax.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationStandardError:{description:"Returns the standard error of the mean from this cell in the simulation",arguments:[{name:"reference cell",collector:!0}],fn:this.simulationstandarderror.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationStandardDeviation:{description:"Returns the standard deviation of the data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationstandarddeviation.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationVariance:{description:"Returns the variance of the data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationvariance.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationTrials:{description:"Returns the number of trials from the last simulation",fn:this.simulationtrials.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationTime:{description:"Returns the elapsed time of the last simulation",fn:this.simulationtime.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},IsPosDef:{description:"Checks that a matrix is positive-definite",arguments:[{name:"matrix"}],fn:t=>{if(t.some((t=>t.some((t=>"number"!=typeof t)))))return et();const r=Yt.Matrix.FromArray(t);return{type:e.boolean,value:r.IsPosDef()}},extension:!0},MakePosDef:{description:"Returns a matrix that is positive-definite",arguments:[{name:"matrix"}],fn:t=>t.some((t=>t.some((t=>"number"!=typeof t))))?et():Yt.Matrix.FromArray(t).MakePosDef().ToArray().map((t=>t.map((t=>({type:e.number,value:t}))))),extension:!0},Cholesky:{arguments:[{name:"matrix"},{name:"transpose",default:!1}],fn:(t,r=!1)=>Yt.Matrix.FromArray(t).Cholesky(r).ToArray().map((t=>t.map((t=>({type:e.number,value:t}))))),extension:!0},EigenValues:{description:"Returns the eigenvalues of the matrix (as column vector)",arguments:[{name:"matrix"}],fn:t=>t.some((t=>t.some((t=>"number"!=typeof t))))?et():[Yt.Matrix.FromArray(t).EigenSystem().realvalues.map((t=>({type:e.number,value:t})))],extension:!0},EigenVectors:{description:"Returns the eigenvectors of the matrix (as matrix)",arguments:[{name:"matrix"}],fn:t=>t.some((t=>t.some((t=>"number"!=typeof t))))?et():Yt.Matrix.FromArray(t).EigenSystem().vectors.map((t=>Array.from(t).map((t=>({type:e.number,value:t}))))),extension:!0},MMult:{description:"Multiplies two matrices",arguments:[{name:"Matrix 1"},{name:"Matrix 2"}],fn:(t,r)=>{var s,i;if(!t||!r)return tt();const n=t.length||0,a=(null===(s=t[0])||void 0===s?void 0:s.length)||0,o=r.length||0,l=(null===(i=r[0])||void 0===i?void 0:i.length)||0;if(!(a&&l&&n&&o&&a===o&&n===l))return et();const h=Yt.Matrix.FromArray(t);return Yt.Matrix.FromArray(r).Multiply(h).ToArray().map((t=>t.map((t=>({type:e.number,value:t})))))}},MInverse:{description:"Returns the inverse matrix",arguments:[{name:"Matrix"}],fn:t=>{try{return Yt.Matrix.FromArray(t).Transpose().Inverse().ToArray(!0).map((t=>t.map((t=>({type:e.number,value:t})))))}catch(t){return console.warn(t),et()}}},"RiskAMP.Scale":{description:"Creates a uniform scale within a given range",arguments:[{name:"min"},{name:"max"}],fn:this.Scale.bind(this),extension:!0},"RiskAMP.HistogramTable":{description:"Creates a histogram table from a source cell",arguments:[{name:"reference cell",collector:!0}],fn:this.HistogramTable.bind(this),extension:!0}}}set seed(t){Yt.Random.Seed(t)}CorrelateDistributions(){for(const t of Object.keys(this.correlated_distributions)){const e=this.correlated_distributions[t],r=e.addresses.map((t=>this.distributions[t.sheet_id||0][t.column][t.row][t.call_index]));try{const t=Yt.MC.CorrelateCDM(e.correlation,r,!0);e.addresses.forEach(((e,r)=>{this.distributions[e.sheet_id||0][e.column][e.row][e.call_index]=t[r]}))}catch(t){console.warn(t)}}}InitDistribution(){if(!this.address)throw new Error("invalid address");if(!this.address.sheet_id)throw new Error("address missing sheet ID");this.distributions[this.address.sheet_id]||(this.distributions[this.address.sheet_id]=[]);const t=this.distributions[this.address.sheet_id];t[this.address.column]||(t[this.address.column]=[]);const e=t[this.address.column];e[this.address.row]||(e[this.address.row]=[])}StoreCellResults(t){if(t||(t=this.address),!t)return;if(!t.sheet_id)throw new Error("SCR called without sheet id");this.results[t.sheet_id]||(this.results[t.sheet_id]=[]),this.results[t.sheet_id][t.column]||(this.results[t.sheet_id][t.column]=[]);const e=this.results[t.sheet_id][t.column];return e[t.row]||(e[t.row]=[]),e[t.row]}PrepMultivariate(t,e){if(!this.correlated_distributions[t]){let r=Yt.CDMatrix.FromArray(e);if(!r.IsSymmetric()){for(let t=1;t<e.length;t++)for(let r=0;r<t;r++)if(e[t][r]){console.warn("invalid lower-triangular matrix");break}r=r.Symmetrize(!0)}this.correlated_distributions[t]={correlation:r,addresses:[]}}this.correlated_distributions[t].addresses.push({column:this.address.column,row:this.address.row,sheet_id:this.address.sheet_id,call_index:this.call_index}),this.InitDistribution()}ValidateCorrelationMatrix(t){let e=Yt.Matrix.FromArray(t);return e.IsSymmetric()||(e=e.Symmetrize(!0)),!(t.some((t=>t.some((t=>"number"!=typeof t&&void 0!==t))))||!e.IsPosDef())}multivariate_normal(t,r,s=0,i=1){if(this.state===Qt.Prep)this.PrepMultivariate(t,r),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Yt.MC.Normal(this.iterations,{mean:s,sd:i,lhs:this.lhs,ordered:!0});else if(this.state===Qt.Simulation)return{type:e.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return this.ValidateCorrelationMatrix(r)?{type:e.number,value:Yt.MC.Normal(1,{mean:s,sd:i})[0]}:K()}multivariate_lognormal(t,r,s=0,i=1){if(this.state===Qt.Prep)this.PrepMultivariate(t,r),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Yt.MC.LogNormal(this.iterations,{mean:s,sd:i,lhs:this.lhs,ordered:!0});else if(this.state===Qt.Simulation)return{type:e.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return this.ValidateCorrelationMatrix(r)?{type:e.number,value:Yt.MC.LogNormal(1,{mean:s,sd:i})[0]}:K()}multivariate_beta(t,r,s=1,i=2){if(this.state===Qt.Prep)this.PrepMultivariate(t,r),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Yt.MC.Beta(this.iterations,{a:s,b:i,lhs:this.lhs,ordered:!0});else if(this.state===Qt.Simulation)return{type:e.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return this.ValidateCorrelationMatrix(r)?{type:e.number,value:Yt.MC.Beta(1,{a:s,b:i})[0]}:K()}multivariate_uniform(t,r,s=0,i=1){if(this.state===Qt.Prep)this.PrepMultivariate(t,r),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Yt.MC.Uniform(this.iterations,{min:s,max:i,lhs:this.lhs,ordered:!0});else if(this.state===Qt.Simulation)return{type:e.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return this.ValidateCorrelationMatrix(r)?{type:e.number,value:Yt.MC.Uniform(1,{min:s,max:i})[0]}:K()}multivariate_pert(t,r,s=0,i=.5,n=1,a=4){if(this.state===Qt.Prep)this.PrepMultivariate(t,r),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Yt.MC.PERT(this.iterations,{a:s,b:n,c:i,lambda:a,lhs:this.lhs,ordered:!0});else if(this.state===Qt.Simulation)return{type:e.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return this.ValidateCorrelationMatrix(r)?{type:e.number,value:Yt.MC.PERT(1,{a:s,b:n,c:i,lambda:a})[0]}:K()}multivariate_triangular(t,r,s=0,i=.5,n=1){if(this.state===Qt.Prep)this.PrepMultivariate(t,r),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Yt.MC.Triangular(this.iterations,{a:s,b:n,c:i,lhs:this.lhs,ordered:!0});else if(this.state===Qt.Simulation)return{type:e.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return this.ValidateCorrelationMatrix(r)?{type:e.number,value:Yt.MC.Triangular(1,{a:s,b:n,c:i})[0]}:K()}uniformvalue(t=0,r=1){if(this.state===Qt.Prep)this.InitDistribution(),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Yt.MC.Uniform(this.iterations,{min:t,max:r,lhs:this.lhs});else if(this.state===Qt.Simulation)return{type:e.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return{type:e.number,value:Yt.MC.Uniform(1,{min:t,max:r})[0]}}bernoullivalue(t=.5){if(this.state===Qt.Prep)this.InitDistribution(),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Yt.MC.Bernoulli(this.iterations,{p:t,lhs:this.lhs});else if(this.state===Qt.Simulation)return{type:e.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return{type:e.boolean,value:Yt.MC.Bernoulli(1,{p:t})[0]}}probabilityvalue(t=.5){return this.bernoullivalue(t)}sequentialvalue(t,r=0){if(this.state===Qt.Prep)this.InitDistribution();else if(this.state===Qt.Simulation){let s=this.iteration;r>0&&(s=this.iteration%r);const i=t[0].length,n=Math.floor(s/i)%t.length,a=s%i;return{type:e.number,value:t[n][a]}}return{type:e.number,value:t[0][0]}}indexvalue(t=0){if(this.state===Qt.Prep)this.InitDistribution();else if(this.state===Qt.Simulation)return t>0?{type:e.number,value:this.iteration%t+1}:{type:e.number,value:this.iteration+1};return{type:e.number,value:1}}lognormalvalue(t=0,r=1){if(this.state===Qt.Prep)this.InitDistribution(),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Yt.MC.LogNormal(this.iterations,{mean:t,sd:r,lhs:this.lhs});else if(this.state===Qt.Simulation)return{type:e.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return{type:e.number,value:Yt.MC.LogNormal(1,{mean:t,sd:r})[0]}}truncatednormalvalue(t=0,r=1,s,i){if(this.state===Qt.Prep)this.InitDistribution(),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Yt.MC.TruncatedNormal(this.iterations,{mean:t,sd:r,lhs:this.lhs,min:s,max:i});else if(this.state===Qt.Simulation)return{type:e.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return{type:e.number,value:Yt.MC.TruncatedNormal(1,{mean:t,sd:r,min:s,max:i})[0]}}normalvalue(t=0,r=1){if(this.state===Qt.Prep)this.InitDistribution(),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Yt.MC.Normal(this.iterations,{mean:t,sd:r,lhs:this.lhs});else if(this.state===Qt.Simulation)return{type:e.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return{type:e.number,value:Yt.MC.Normal(1,{mean:t,sd:r})[0]}}pertvalue(t=0,r=.5,s=1,i=4){if(this.state===Qt.Prep)this.InitDistribution(),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Yt.MC.PERT(this.iterations,{a:t,b:s,c:r,lambda:i,lhs:this.lhs});else if(this.state===Qt.Simulation)return{type:e.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return{type:e.number,value:Yt.MC.PERT(1,{a:t,b:s,c:r,lambda:i})[0]}}pertvalue_p(t=0,r=.5,s=1,i=4){if(this.state===Qt.Prep){const e=Yt.MC.P80Pert(t,s,r,i);this.InitDistribution(),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Yt.MC.PERT(this.iterations,Object.assign(Object.assign({},e),{lambda:i,lhs:this.lhs}))}else if(this.state===Qt.Simulation)return{type:e.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};const n=Yt.MC.P80Pert(t,s,r,i);return{type:e.number,value:Yt.MC.PERT(1,Object.assign(Object.assign({},n),{lambda:i}))[0]}}CommonDistributionFunction(t,e,r){if(this.state===Qt.Prep)this.InitDistribution(),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=t.apply(e,[this.iterations].concat(r));else if(this.state===Qt.Simulation)return this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration];return t.apply(e,[1].concat(r))[0]}triangularvalue(t=0,r=.5,s=1){if(this.state===Qt.Prep)this.InitDistribution(),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Yt.MC.Triangular(this.iterations,{a:t,b:s,c:r,lhs:this.lhs});else if(this.state===Qt.Simulation)return{type:e.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return{type:e.number,value:Yt.MC.Triangular(1,{a:t,b:s,c:r})[0]}}betavalue(t=1,r=1){if(this.state===Qt.Prep)this.InitDistribution(),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Yt.MC.Beta(this.iterations,{a:t,b:r,lhs:this.lhs});else if(this.state===Qt.Simulation)return{type:e.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return{type:e.number,value:Yt.MC.Beta(1,{a:t,b:r})[0]}}samplevalue(t){return this.uniformrangesample(t)}samplevalue_weighted(t,r){if(this.state===Qt.Prep)this.InitDistribution(),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Yt.MC.Uniform(this.iterations,{min:0,max:1,lhs:this.lhs});else{const s=this.state===Qt.Simulation?this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]:Yt.MC.Uniform(1,{min:0,max:1})[0];if(!t||!t.length)return{type:e.undefined,value:void 0};const i=s*Ct(r).reduce(((t,e)=>void 0===e?t:t+Number(e)),0);let n=0;for(let s=0;s<t.length;s++)for(let a=0;a<t[s].length;a++)if(n+=r[s][a],n>=i)return{type:e.number,value:t[s][a]}}return{type:e.number,value:t[0][0]}}uniformrangesample(t){this.state===Qt.Prep&&(this.InitDistribution(),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Yt.MC.Uniform(this.iterations,{min:0,max:1,lhs:this.lhs}));const r=this.state===Qt.Simulation?this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]:Yt.MC.Uniform(1,{min:0,max:1})[0];if(!t||!t.length)return{type:e.undefined,value:void 0};const i=Math.floor(t[0].length*t.length*r),n=t[i%t.length][Math.floor(i/t.length)]||"";return{value:n,type:s(n)}}simulationtrials(){return{type:e.number,value:this.trials}}simulationtime(){return{type:e.number,value:this.elapsed/1e3}}simulationvaluesarray(t){if(this.state!==Qt.Null)return{type:e.number,value:0};if(!t||!t.length)return K();const r=[];for(let s=0;s<t.length;s++)r[s]={type:e.number,value:t[s]};return[r]}simulationvaluesarray_ordered(t,r){if(this.state!==Qt.Null)return{type:e.number,value:0};if(!t||!t.length||r&&!r.length)return K();if(!r)return[Array.prototype.slice.call(t,0).sort(((t,e)=>t-e)).map((t=>({type:e.number,value:t})))];const s=Array.from(t).map(((t,e)=>[t,r[e]]));return s.sort(((t,e)=>t[1]-e[1])),[s.map((t=>({type:e.number,value:t[0]})))]}simulationrsquared(t,r){return this.state!==Qt.Null?{type:e.number,value:0}:t&&t.length&&r&&r.length?{type:e.number,value:Yt.Stats.R2(t,r)}:K()}simulationcorrelation(t,r){return this.state!==Qt.Null?{type:e.number,value:0}:t&&t.length&&r&&r.length?{type:e.number,value:Yt.Stats.Correlation(t,r)}:K()}sortedsimulationindex(t,r=1){if(this.state!==Qt.Null)return{type:e.number,value:0};if(!t||!t.length)return K();if(r<1||r>t.length)return tt();const s=Array.from(t).map(((t,e)=>[t,e+1]));return s.sort(((t,e)=>t[0]-e[0])),{type:e.number,value:s[r-1][1]}}simulationvalue(t,r=1){return this.state!==Qt.Null?{type:e.number,value:0}:t&&t.length?r<1||r>t.length?tt():{type:e.number,value:t[r-1]}:K()}simulationpercentile(t,r=.5){return this.state!==Qt.Null?{type:e.number,value:0}:t&&t.length?{type:e.number,value:Yt.Stats.Percentile(t,r)}:K()}simulationstandarddeviation(t){if(this.state!==Qt.Null)return{type:e.number,value:0};if(!t||!t.length)return K();const r=Yt.Stats.Statistics(t);return{type:e.number,value:r.stdev}}simulationvariance(t){if(this.state!==Qt.Null)return{type:e.number,value:0};if(!t||!t.length)return K();const r=Yt.Stats.Statistics(t);return{type:e.number,value:r.variance}}simulationskewness(t){if(this.state!==Qt.Null)return{type:e.number,value:0};if(!t||!t.length)return K();const r=Yt.Stats.Statistics(t);return{type:e.number,value:r.skewness}}simulationkurtosis(t){if(this.state!==Qt.Null)return{type:e.number,value:0};if(!t||!t.length)return K();const r=Yt.Stats.Statistics(t);return{type:e.number,value:r.kurtosis}}simulationinterval(t,r,s){return this.state!==Qt.Null?{type:e.number,value:0}:t&&t.length?{type:e.number,value:Yt.Stats.Interval({data:t,min:r,max:s})}:K()}simulationstandarderror(t){if(this.state!==Qt.Null)return{type:e.number,value:0};if(!t||!t.length)return K();let r=0,s=0;for(const e of t)r+=e||0;const i=r/t.length;for(const e of t){const t=e-i;s+=t*t}return{type:e.number,value:Math.sqrt(s/t.length)/Math.sqrt(t.length)}}simulationmin(t){return this.state!==Qt.Null?{type:e.number,value:0}:t&&t.length?{type:e.number,value:Math.min.apply(0,t)}:K()}simulationmax(t){return this.state!==Qt.Null?{type:e.number,value:0}:t&&t.length?{type:e.number,value:Math.max.apply(0,t)}:K()}simulationmean(t){if(this.state!==Qt.Null)return{type:e.number,value:0};if(!t||!t.length)return K();let r=0;for(const e of t)r+=e;return{type:e.number,value:r/t.length}}simulationmedian(t){if(this.state!==Qt.Null)return{type:e.number,value:0};if(!t||!t.length)return K();const r=t.filter((t=>"number"==typeof t?t:0));return r.sort(((t,e)=>t-e)),{type:e.number,value:r[Math.round(r.length/2)]}}Scale(r,s){var i;let n,a=1,o=1;if(this.address.sheet_id)for(const t of(null===(i=this.model)||void 0===i?void 0:i.sheets)||[])if(t.id===this.address.sheet_id){t.cells.data[this.address.row]&&(n=t.cells.data[this.address.row][this.address.column]);break}if(!n)return tt();if(n.area){const e=new t(n.area.start,n.area.end);a=e.rows,o=e.columns}const l=Math.max(a,o),h=r>s?R(s,r,l-1,!0):R(r,s,l-1,!0);let u=h.min;const c=[[]];if(h.count<l-1&&(u=h.min-Math.floor((l-1-h.count)/2)*h.step),r>s)for(let t=0;t<l;t++){const r=u+t*h.step;c[0][l-1-t]={type:e.number,value:r}}else for(let t=0;t<l;t++){const r=u+t*h.step;c[0][t]={type:e.number,value:r}}return a<o?Mt(c):c}HistogramTable(r){var s;let i,n=1,a=1;if(this.address.sheet_id)for(const t of(null===(s=this.model)||void 0===s?void 0:s.sheets)||[])if(t.id===this.address.sheet_id){t.cells.data[this.address.row]&&(i=t.cells.data[this.address.row][this.address.column]);break}if(!i)return tt();if(i.area){const e=new t(i.area.start,i.area.end);n=e.rows,a=e.columns}const o=Math.max(n,a),l=Math.min(n,a);if(Array.isArray(r)||r instanceof Float64Array||r instanceof Float32Array){if(r.length<=1)return{type:e.number,value:0};Array.isArray(r)||(r=Array.prototype.slice.call(r)),r.sort(((t,e)=>t-e));const t=r[0]||0,s=r[r.length-1]||0;if(s===t)return{type:e.number,value:0};let i=[[],[]];const h=R(t,s,o,!0);let u=h.min,c=0;h.count<o&&(u=h.min-Math.ceil(o-h.count)/2*h.step);for(let t=0;t<o;t++){const s=u+(t+1)*h.step;let n=0;for(;c<r.length&&r[c]<s;c++,n++);i[1][t]={type:e.number,value:n},i[0][t]={type:e.number,value:s}}return 1===l&&(i=[i[1]]),a>n?Mt(i):i}return{type:e.number,value:0}}}class Xt extends xt{constructor(t,e){super(t,e),this.simulation_model=new Kt,this.context=this.simulation_model}CallExpression(t,r=!1){const s=this.library.Get(t.name);if(!s)return t=>st();const i=s.arguments||[];return this.simulation_model.state===Qt.Prep&&t.args.forEach(((t,e)=>{const r=i[e]||{};if(t&&r.collector)if("address"===t.type)this.simulation_model.StoreCellResults(t);else if("identifier"===t.type){const e=this.named_range_map[t.name.toUpperCase()];e&&this.simulation_model.StoreCellResults(e.start)}else if("call"===t.type){const e=this.CalculateExpression(t,!0);e&&bt(e)&&("address"===e.value.type?this.simulation_model.StoreCellResults(e.value):"range"===e.value.type&&this.simulation_model.StoreCellResults(e.value.start))}})),n=>{const a=this.call_index++;this.simulation_model.volatile=this.simulation_model.volatile||!!s.volatile||!!s.simulation_volatile&&this.simulation_model.state!==Qt.Null;const o="IF"===t.name.toUpperCase();let h,u=-1;const c=n.args.map(((t,r)=>{if(h)return;const s=i[Math.min(r,i.length-1)]||{};if(r===u)return s.boxed?l():void 0;if(void 0===t)return o&&0===r&&(u=1),s.boxed?l():void 0;if(s.address)return s.boxed?{type:e.string,value:this.parser.Render(t).replace(/\$/g,"")}:this.parser.Render(t).replace(/\$/g,"");if(s.metadata)return this.GetMetadata(t,((t,e)=>({simulation_data:this.simulation_model.state===Qt.Null?this.simulation_model.StoreCellResults(e):[]})));if(s.collector&&this.simulation_model.state===Qt.Null){if("address"===t.type)return this.simulation_model.StoreCellResults(t);if("range"===t.type)return this.simulation_model.StoreCellResults(t.start);if("identifier"===t.type){const e=this.named_range_map[t.name.toUpperCase()];if(e)return this.simulation_model.StoreCellResults(e.start)}else if("call"===t.type){const e=this.CalculateExpression(t,!0);if(e&&bt(e)){if("address"===e.value.type)return this.simulation_model.StoreCellResults(e.value);if("range"===e.value.type)return this.simulation_model.StoreCellResults(e.value.start)}}return h=rt(),h}{const i=this.CalculateExpression(t);if(!Array.isArray(i)&&i.type===e.error)return s.allow_error?i:void(h=i);if(o&&0===r&&!Array.isArray(i)){let t=!1;if(i.type===e.string){const e=i.value.toLowerCase().trim();t="false"!==e&&"f"!==e}else t=!!i.value;u=t?2:1}return s.boxed?i:Array.isArray(i)?i.map((t=>t.map((t=>t.value)))):i.value}}));if(h)return h;if(this.context.call_index=a,s.return_type===nt.reference){const t=s.fn.apply(null,c);if(r)return t;if(bt(t)){if("address"===t.value.type)return this.CellFunction2(t.value)();if("range"===t.value.type)return this.CellFunction4(t.value.start,t.value.end)}return t}return s.fn.apply(null,c)}}}class te extends class extends class{constructor(){this.vertices=[[]],this.volatile_list=[],this.cells_map={},this.leaf_vertices=[],this.dirty_list=[],this.loop_check_required=!1}IsSpreadsheetVertex(t){return t.type===Z.type}AttachData(t){this.model=t,this.cells_map={};for(const e of t.sheets)this.cells_map[e.id]=e.cells}FlushTree(){this.dirty_list=[],this.volatile_list=[],this.vertices=[[]],this.leaf_vertices=[],this.cells_map={},W.Clear()}ResolveArrayHead(t){if(!t.sheet_id)throw new Error("resolve array head with no sheet id");const e=this.cells_map[t.sheet_id];if(!e)throw new Error("no cells? sheet id "+t.sheet_id);const r=e.data[t.row];if(r){const e=r[t.column];if(e&&e.area){const r={row:e.area.start.row,column:e.area.start.column,sheet_id:t.sheet_id};return console.info("array head",t,r),r}}return t}GetVertex(t,e){if(!t.sheet_id)throw new Error("getvertex with no sheet id");const r=this.cells_map[t.sheet_id];if(!r)throw new Error("no cells? sheet id "+t.sheet_id);if(!this.vertices[t.sheet_id]){if(!e)return;this.vertices[t.sheet_id]=[]}if(this.vertices[t.sheet_id][t.column]){const r=this.vertices[t.sheet_id][t.column][t.row];if(r)return r;if(!e)return}else{if(!e)return;this.vertices[t.sheet_id][t.column]=[]}const s=new Z;return s.address={row:t.row,column:t.column,absolute_row:t.absolute_row,absolute_column:t.absolute_column,sheet_id:t.sheet_id},s.reference=r.EnsureCell(t),this.vertices[t.sheet_id][t.column][t.row]=s,W.CreateImplicitEdges(s,t),s}RemoveVertex(t){if(!t.sheet_id)throw new Error("removevertex with no sheet id");const e=this.GetVertex(t,!1);e&&(e.Reset(),this.vertices[t.sheet_id][t.column][t.row]=void 0)}ResetVertex(t){const e=this.GetVertex(t,!1);e&&e.Reset()}ResetInbound(t,e=!1,r=!0,s=!1){const i=this.GetVertex(t,r);if(i)i.ClearDependencies(),e&&this.SetVertexDirty(i),s&&this.RemoveVertex(t);else if(e){const e=W.GetContainingArrays(t);for(const t of e)this.SetVertexDirty(t)}}ResetLoopState(){for(const t of this.vertices)if(t)for(const e of t)if(e)for(const t of e)t&&(t.color=G.white);for(const t of this.leaf_vertices)t.edges_in.length&&(t.color=G.white)}LoopCheck(){if(!this.loop_check_required)return!1;const t=[];for(const e of this.vertices)if(e)for(const r of e)if(r)for(const e of r)e&&(e.color=G.white,t.push(e));const e=t=>{t.color=G.gray;for(const r of t.edges_out){if(r.color===G.gray)return this.loop_hint=this.RenderAddress(t.address),console.info("loop detected @",this.loop_hint),!0;if(r.color===G.white&&e(r))return!0}return t.color=G.black,!1};for(const r of t)if(r.color===G.white&&e(r))return!0;return this.loop_check_required=!1,this.loop_hint=void 0,!1}RenderAddress(e){if(!e)return"undefined";let r="";if(e.sheet_id&&this.model)for(const t of this.model.sheets)if(e.sheet_id===t.id){r=t.name+"!";break}return r+new t(e).spreadsheet_label}AddArrayEdge(t,e){if(!t.start.sheet_id)throw new Error("AddArrayEdge called without sheet ID");const r=this.GetVertex(e,!0),[s,i]=W.GetVertex(t);if(r.DependsOn(s),this.loop_check_required=!0,!i)return;const n=this.vertices[t.start.sheet_id];if(n)if(t.entire_row){for(let e=0;e<n.length;e++)if(n[e])for(let r=t.start.row;r<=t.end.row;r++){const t=n[e][r];t&&s.DependsOn(t)}console.groupEnd()}else if(t.entire_column){for(let e=t.start.column;e<=t.end.column;e++)if(n[e])for(const t of n[e])(null==t?void 0:t.address)&&s.DependsOn(t);console.groupEnd()}else for(let e=t.start.row;e<=t.end.row;e++)for(let r=t.start.column;r<=t.end.column;r++){const t=n[r][e];t&&s.DependsOn(t)}}AddEdge(t,e){const r=this.GetVertex(t,!0);this.GetVertex(e,!0).DependsOn(r),r.reference&&r.reference.area&&!r.array_head&&this.AddEdge(Object.assign(Object.assign({},t),{row:r.reference.area.start.row,column:r.reference.area.start.column}),t),this.loop_check_required=!0}RemoveEdge(t,e){const r=this.GetVertex(t,!1),s=this.GetVertex(e,!1);r&&s&&(r.RemoveDependent(s),s.RemoveDependency(r))}SetAreaDirty(t){if(t.start.column===1/0||t.end.column===1/0||t.start.row===1/0||t.end.row===1/0)throw new Error("don't iterate over infinite area");const e=t.start.sheet_id;if(!e)throw new Error("invalid area, missing sheet id");for(let r=t.start.column;r<=t.end.column;r++)for(let s=t.start.row;s<=t.end.row;s++){const t={row:s,column:r,sheet_id:e};this.GetVertex(t,!1)&&this.SetDirty(t)}}SetVertexDirty(t){if(!t.dirty){this.dirty_list.push(t),t.dirty=!0;for(const e of t.edges_out)this.SetVertexDirty(e)}}SetDirty(t){const e=this.GetVertex(t,!0);this.SetVertexDirty(e)}AddLeafVertex(t){for(const e of this.leaf_vertices)if(e===t)return;this.leaf_vertices.push(t)}RemoveLeafVertex(t){this.leaf_vertices=this.leaf_vertices.filter((e=>e!==t))}AddLeafVertexEdge(t,e){const r=this.GetVertex(t,!0);return e.DependsOn(r),J.OK}RemoveLeafVertexEdge(t,e){const r=this.GetVertex(t,!1);r&&(r.RemoveDependent(e),e.RemoveDependency(r))}InitializeGraph(){for(const t of this.dirty_list)this.IsSpreadsheetVertex(t)&&(t.TakeReferenceValue(),this.CheckVolatile(t)&&this.volatile_list.push(t)),t.dirty=!1;this.dirty_list=[]}Recalculate(){for(const t of this.volatile_list)this.SetVertexDirty(t);const t=this.dirty_list.slice(0);this.volatile_list=[],this.dirty_list=[],this.loop_check_required&&(this.ResetLoopState(),this.loop_check_required=!1);for(const e of t)e.Calculate(this)}}{constructor(){super(),this.library=new Rt,this.parser=new V,this.expression_calculator=new xt(this.library,this.parser),this.full_rebuild_required=!1,this.UpdateLocale(),this.library.Register(Ft,Gt,qt,jt,Jt);for(const t of Object.keys(Ht))this.library.Alias(t,Ht[t]);for(const t of Object.keys(Bt))this.library.Alias(t,Bt[t]);this.library.Register({CountIf:{arguments:[{name:"range"},{name:"criteria"}],fn:(t,r)=>{const s=Ct(t);"string"!=typeof r?r="="+(r||0).toString():(r=r.trim(),/^[=<>]/.test(r)||(r="="+r));const i=this.parser.Parse("{}"+r),n=i.expression;if(i.error||!n)return Y();if("binary"!==n.type)return Y();if("array"!==n.left.type)return Y();n.left.values=[s];const a=this.CalculateExpression(n);if(Array.isArray(a)){let t=0;for(const e of a)for(const r of e)r.value&&t++;return{type:e.number,value:t}}return a}},Offset:{arguments:[{name:"reference",description:"Base reference",metadata:!0},{name:"rows",description:"number of rows to offset"},{name:"columns",description:"number of columns to offset"}],return_type:nt.reference,volatile:!0,fn:((t,r=0,s=0,i=1,n=1)=>{if(!t)return tt();if(!wt(t))return rt();const a=this.DynamicDependencies(t.value.address,this.expression_calculator.context.address,!0,r,s,i,n);if(!a)return rt();if(a.dirty)return this.GetVertex(this.expression_calculator.context.address,!0).short_circuit=!0,{type:e.undefined,value:void 0};if(a.area){const t=Object.assign(Object.assign({type:"address"},a.area.start),{label:"",position:0,id:0}),r=Object.assign(Object.assign({type:"address"},a.area.end),{label:"",position:0,id:0}),s=1===a.area.count?t:{type:"range",start:t,end:r,label:"",position:0,id:0};return{type:e.object,value:s}}return et()}).bind(this)},Indirect:{arguments:[{name:"reference",description:"Cell reference (string)"}],return_type:nt.reference,volatile:!0,fn:(t=>{if(!t||"string"!=typeof t)return tt();const r=this.parser.Parse(t);if(r.error||!r.expression||"address"!==r.expression.type&&"range"!==r.expression.type)return rt();const s=this.DynamicDependencies(r.expression,this.expression_calculator.context.address);return s?s.dirty?(this.GetVertex(this.expression_calculator.context.address,!0).short_circuit=!0,{type:e.undefined,value:void 0}):{type:e.object,value:r.expression}:rt()}).bind(this)},Rows:{arguments:[{name:"reference",description:"Array or reference"}],volatile:!1,fn:t=>{if(!t)return tt();if(Array.isArray(t)){const r=t[0];return Array.isArray(r)?{type:e.number,value:r.length}:et()}return{type:e.number,value:1}}},Columns:{arguments:[{name:"reference",description:"Array or reference"}],volatile:!1,fn:t=>t?Array.isArray(t)?{type:e.number,value:t.length}:{type:e.number,value:1}:tt()},IsFormula:{description:"Returns true if the reference is a formula",arguments:[{name:"Reference",metadata:!0}],fn:St((t=>{var r,s;if(null===(r=null==t?void 0:t.value)||void 0===r?void 0:r.address)for(const r of(null===(s=this.model)||void 0===s?void 0:s.sheets)||[])if(r.id===t.value.address.sheet_id){const s=r.cells.GetCell(t.value.address,!1);return{type:e.boolean,value:(null==s?void 0:s.type)===e.formula}}return{type:e.boolean,value:!1}}))}})}SpreadCallback(t,r){if(!t.address||!t.address.sheet_id)throw new Error("spread callback called without sheet id");const s=this.cells_map[t.address.sheet_id];if(!s)throw new Error("spread callback called without cells");if(!t||!t.reference)return;const i=t.reference.area;if(i){const t=i.rows,n=i.columns;if(Array.isArray(r)){r=Mt(r);for(let a=0;a<t;a++)if(r[a]){let t=0;for(;t<n&&t<r[a].length;t++)s.data[a+i.start.row][t+i.start.column].SetCalculatedValue(r[a][t].value,r[a][t].type);for(;t<n;t++)s.data[a+i.start.row][t+i.start.column].SetCalculatedValue(void 0,e.undefined)}else for(let t=0;t<n;t++)s.data[a+i.start.row][t+i.start.column].SetCalculatedValue(void 0,e.undefined)}else for(let e=0;e<t;e++)for(let t=0;t<n;t++)s.data[e+i.start.row][t+i.start.column].SetCalculatedValue(r.value,r.type)}}CalculationCallback(t){if(!t.address)throw new Error("vertex missing address");return t.expression_error?{value:it()}:this.expression_calculator.Calculate(t.expression,t.address)}DynamicDependencies(e,r,s=!1,i=0,n=0,a=1,o=1){if(!this.model)return;let l=this.ResolveExpressionAddress(e,r);if(!l)return;let h=!1;l=this.model.active_sheet.RealArea(l);const u=l.start.sheet_id;s&&(l=new t({column:l.start.column+n,row:l.start.row+i,sheet_id:l.start.sheet_id},{column:l.start.column+n+a-1,row:l.start.row+i+o-1,sheet_id:l.end.sheet_id}));for(let t=l.start.row;t<=l.end.row;t++)for(let e=l.start.column;e<=l.end.column;e++){const r=this.GetVertex({row:t,column:e,sheet_id:u},!1);r&&r.dirty&&(this.AddEdge({row:t,column:e,sheet_id:u},this.expression_calculator.context.address),h=!0)}return{dirty:h,area:l}}UpdateLocale(){","===m.decimal_separator?(this.parser.decimal_mark=T.Comma,this.parser.argument_separator=E.Semicolon):(this.parser.decimal_mark=T.Period,this.parser.argument_separator=E.Comma)}GetFunction(t){return this.library.Get(t)}SupportedFunctions(){const t=this.library.List(),e=Object.keys(t).map((e=>{let r=t[e].canonical_name;return r||(r=e.replace(/_/g,".")),{name:r,description:t[e].description,arguments:(t[e].arguments||[]).map((t=>({name:t.name||""})))}}));if(this.model)for(const t of Object.keys(this.model.macro_functions)){const r=this.model.macro_functions[t];e.push({name:r.name,description:r.description,arguments:(r.argument_names||[]).map((t=>({name:t})))})}return e}RegisterFunction(t){for(const e of Object.keys(t)){const r=t[e],s=r.fn;r.fn=(...t)=>s.apply({address:Object.assign({},this.expression_calculator.context.address)},t),this.library.Register({[e]:r})}}AttachModel(t){this.AttachData(t),this.expression_calculator.SetModel(t)}Calculate(t,e){if(this.AttachModel(t),e&&!e.start.sheet_id)throw new Error("CalculateInternal called with subset w/out sheet ID");this.full_rebuild_required&&(e=void 0,this.UpdateAnnotations(),this.full_rebuild_required=!1),this.RebuildGraph(e);try{this.Recalculate()}catch(t){console.error(t),console.info("calculation error trapped")}}Reset(){this.FlushTree(),this.model&&this.AttachModel(this.model),this.full_rebuild_required=!0}CalculateExpression(t,e={row:-1,column:-1},r=!1){return this.expression_calculator.Calculate(t,e,r).value}RebuildClean(t,e=!1){this.full_rebuild_required=!1,this.AttachModel(t),this.RebuildGraph(),this.UpdateAnnotations(),this.InitializeGraph(),e&&this.volatile_list.length&&this.Recalculate()}FlattenCellList(e){const r={},s=[];for(const i of e){const e={column:i.column,row:i.row,sheet_id:i.sheet_id},n=t.CellAddressToLabel(e,!0);r[n]||(r[n]=n,s.push(e))}return s}MetadataReferences(t){const e=[];if(!this.model)return e;const r=this.parser.Parse(t);if(r.expression&&"call"===r.expression.type){const t=this.GetFunction(r.expression.name);if(!t||!t.arguments)return e;for(let s=0;s<t.arguments.length;s++){const i=t.arguments[s];if(!i||!i.metadata)continue;const n=r.expression.args[s];if(!n)continue;const a=this.ResolveExpressionAddress(n);a&&e.push(a.start)}}return e}RemoveAnnotation(t){const e=t.temp.vertex;e&&(e.Reset(),this.RemoveLeafVertex(e))}UpdateAnnotations(t){if(!t&&this.model&&(t=this.model.active_sheet.annotations),t){void 0===t||Array.isArray(t)||(t=[t]);for(const e of t)if(e.formula){e.temp.vertex||(e.temp.vertex=new $t);const t=e.temp.vertex;this.AddLeafVertex(t),this.UpdateLeafVertex(t,e.formula)}}}ResolveSheetID(t,e){if(!this.model)throw new Error("ResolveSheetID called without model");const r="address"===t.type?t:t.start;if(r.sheet_id)return!0;if(!r.sheet)return r.sheet_id=(null==e?void 0:e.sheet_id)||this.model.active_sheet.id,!0;{const t=r.sheet.toLowerCase();for(const e of this.model.sheets)if(e.name.toLowerCase()===t)return r.sheet_id=e.id,!0}return!1}ResolveExpressionAddress(e,r){switch(e.type){case"address":if(this.ResolveSheetID(e,r))return new t(e);break;case"range":if(this.ResolveSheetID(e,r))return new t(e.start,e.end);break;case"identifier":if(this.model){const r=this.model.named_ranges.Get(e.name.toUpperCase());if(r)return new t(r.start,r.end)}}}NamedRangeToAddressUnit(t){if(!this.model)return;const e=t.name.toUpperCase(),r=this.model.named_ranges.Get(e);return r?1===r.count?this.ConstructAddressUnit(r.start,e,t.id,t.position):{type:"range",start:this.ConstructAddressUnit(r.start,e,t.id,t.position),end:this.ConstructAddressUnit(r.end,e,t.id,t.position),label:e,id:t.id,position:t.position}:void 0}ConstructAddressUnit(t,e,r,s){return{type:"address",row:t.row,column:t.column,sheet_id:t.sheet_id,label:e,id:r,position:s}}RebuildDependencies(t,e,r,s={addresses:{},ranges:{}},i){if(!i&&(i={},this.model)){for(const t of this.model.sheets)i[t.name.toLowerCase()]=t.id;if(!r)for(const t of this.model.sheets)if(t.id===e){r=t.name;break}}switch(t.type){case"literal":case"missing":case"operator":break;case"identifier":{const e=this.NamedRangeToAddressUnit(t);e&&("address"===e.type?s.addresses[e.label]=e:s.ranges[e.label]=e)}break;case"address":t.sheet_id||(t.sheet_id=t.sheet?i[t.sheet.toLowerCase()]||0:e,t.sheet||(t.sheet=r)),s.addresses[t.sheet_id+"!"+t.label]=t;break;case"range":t.start.sheet_id||(t.start.sheet_id=t.start.sheet?i[t.start.sheet.toLowerCase()]||0:e,t.start.sheet||(t.start.sheet=r)),s.ranges[t.start.sheet_id+"!"+t.start.label+":"+t.end.label]=t;break;case"unary":this.RebuildDependencies(t.operand,e,r,s,i);break;case"binary":this.RebuildDependencies(t.left,e,r,s,i),this.RebuildDependencies(t.right,e,r,s,i);break;case"group":t.elements.forEach((t=>this.RebuildDependencies(t,e,r,s,i)));break;case"call":{const n=t.args.slice(0),a=this.library.Get(t.name);a&&a.arguments&&a.arguments.forEach(((t,s)=>{t&&t.address&&(this.RebuildDependencies(n[s],e,r,void 0,i),n[s]={type:"missing",id:-1})})),n.forEach((t=>this.RebuildDependencies(t,e,r,s,i)))}}return s}UpdateLeafVertex(e,r){if(!this.model)throw new Error("UpdateLeafVertex called without model");e.Reset();const s=this.parser.Parse(r);if(s.expression){const r=this.RebuildDependencies(s.expression,this.model.active_sheet.id,this.model.active_sheet.name);for(const s of Object.keys(r.ranges)){const i=r.ranges[s];new t(i.start,i.end).Iterate((t=>{this.AddLeafVertexEdge(t,e)}))}for(const t of Object.keys(r.addresses)){const s=r.addresses[t];this.AddLeafVertexEdge(s,e)}}e.expression=s.expression||{type:"missing",id:-1},e.expression_error=!s.valid}ApplyMacroFunctionInternal(t,e,r){switch(t.type){case"identifier":if(r[0]){const e=r[0][(t.name||"").toUpperCase()];if(e)return JSON.parse(JSON.stringify(e))}break;case"binary":t.left=this.ApplyMacroFunctionInternal(t.left,e,r),t.right=this.ApplyMacroFunctionInternal(t.right,e,r);break;case"unary":t.operand=this.ApplyMacroFunctionInternal(t.operand,e,r);break;case"group":t.elements=t.elements.map((t=>this.ApplyMacroFunctionInternal(t,e,r)));break;case"call":if(t.args=t.args.map((t=>this.ApplyMacroFunctionInternal(t,e,r))),!this.library.Get(t.name)){const s=e.macro_functions[t.name.toUpperCase()];if(s&&s.expression){const i=JSON.parse(JSON.stringify(s.expression)),n={};if(s.argument_names)for(let e=0;e<s.argument_names.length;e++)n[s.argument_names[e].toUpperCase()]=t.args[e]?t.args[e]:{type:"missing"};r.unshift(n);const a=this.ApplyMacroFunctionInternal(i,e,r);return r.shift(),a}}}return t}ApplyMacroFunctions(t){if(this.model)return Object.keys(this.model.macro_functions).length?this.ApplyMacroFunctionInternal(t,this.model,[]):void 0}RebuildGraphCell(r,s){if(r.area&&r.area.start.column===s.column&&r.area.start.row===s.row){const{start:t,end:e}=r.area,i=t.sheet_id||s.sheet_id;t.sheet_id||(t.sheet_id=i);for(let r=t.column;r<=e.column;r++)for(let s=t.row;s<=e.row;s++)this.ResetInbound({column:r,row:s,sheet_id:i},!0,!1);this.SetDirty(s);for(let r=t.column;r<=e.column;r++)for(let s=t.row;s<=e.row;s++)s===t.row&&r===t.column||this.AddEdge(t,Object.assign(Object.assign({},t),{row:s,column:r}))}if(r.type===e.formula){this.ResetInbound(s,!0);const e=this.parser.Parse(r.value);if(e.expression){if("call"===e.expression.type){const t=this.library.Get(e.expression.name);t&&(t.render||t.click)&&(r.render_function=t.render,r.click_function=t.click)}const i=this.RebuildDependencies(e.expression,s.sheet_id,"");for(const e of Object.keys(i.ranges)){const r=i.ranges[e],n=new t(r.start,r.end);n.entire_row||n.entire_column?this.AddArrayEdge(n,s):n.Iterate((t=>this.AddEdge(t,s)))}for(const t of Object.keys(i.addresses)){const e=i.addresses[t];this.AddEdge(e,s)}}const i=this.GetVertex(s,!0);i&&(i.expression=e.expression||{type:"missing",id:-1},i.expression_error=!e.valid)}else r.value!==r.calculated?this.ResetInbound(s,!0,!1):r.type===e.undefined?this.ResetInbound(s,!0,!1,!0):console.warn("UNHANDLED CASE",r)}RebuildGraph(t){var e;if(t){if(!t.start.sheet_id)throw new Error("subset missing sheet id");const e=this.cells_map[t.start.sheet_id];for(let r=t.start.row;r<=t.end.row;r++){const s=e.data[r];if(s)for(let e=t.start.column;e<=t.end.column;e++){const i=s[e];i&&this.RebuildGraphCell(i,{row:r,column:e,sheet_id:t.start.sheet_id})}}}else for(const t of(null===(e=this.model)||void 0===e?void 0:e.sheets)||[]){const e=t.cells.data.length;for(let r=0;r<e;r++){const e=t.cells.data[r];if(e){const s=e.length;for(let i=0;i<s;i++){const s=e[i];s&&this.RebuildGraphCell(s,{row:r,column:i,sheet_id:t.id})}}}}}IsNativeOrTypedArray(t){return Array.isArray(t)||t instanceof Float64Array||t instanceof Float32Array}CheckVolatile(t){if(!t.expression||t.expression_error)return!1;let e=!1;return this.parser.Walk(t.expression,(t=>{if("call"===t.type){const r=this.library.Get(t.name);r&&r.volatile&&(e=!0)}return!e})),e}}{constructor(){super(),this.expression_calculator=this.simulation_expression_calculator=new Xt(this.library,this.parser),this.library.Register(this.simulation_expression_calculator.simulation_model.functions)}InitSimulation(t,e,r,s,i){var n;const a=this.simulation_expression_calculator.simulation_model;if(a.iterations=t,a.results=[],a.lhs=e,a.correlated_distributions={},"number"==typeof i&&(a.seed=i),this.Reset(),this.AttachModel(r),s&&s.length)for(const t of s){if(!t.sheet_id)throw new Error("additional cell passed without sheet id");for(const e of(null===(n=this.model)||void 0===n?void 0:n.sheets)||[])if(e.id===t.sheet_id){e.cells.GetCell(t,!1)&&a.StoreCellResults(t);break}}if(this.RebuildGraph(),this.LoopCheck())throw new Error("Loop (circular dependency) found in graph");return a.state=Qt.Prep,a.iteration=0,this.Recalculate(),a.CorrelateDistributions(),a.state=Qt.Simulation,J.OK}GetResults(){return this.simulation_expression_calculator.simulation_model.results}SimulationTrial(t){const e=this.simulation_expression_calculator.simulation_model;e.iteration=t;try{this.Recalculate();for(const r in e.results){const s=this.cells_map[r];for(const i in e.results[r]){const n=e.results[r][i];for(const e in n){const r=s.GetCell({row:Number(e),column:Number(i)});if(r){const s=r.GetValue();switch(typeof s){case"number":n[e][t]=s;break;case"boolean":n[e][t]=s?1:0;break;default:n[e][t]=0}}}}}return{status:J.OK,reference:null}}catch(t){return console.info("calculation error trapped",t),{status:J.CalculationError,reference:null}}}FlattenedResults(){const t=this.simulation_expression_calculator.simulation_model,e=[];for(const r in t.results)for(const s in t.results[r]){const i=t.results[r][s];for(const t in i)e.push(Zt({row:Number(t),column:Number(s),sheet_id:Number(r),data:i[t]}).buffer)}return e}FlushSimulationResults(){const t=this.simulation_expression_calculator.simulation_model;t.results=[],t.elapsed=0,t.trials=0}ShiftSimulationResults(t,e,r,s){}UpdateResults(t,e=this.model,r=!0){if(!e)throw new Error("UpdateResults called without model");const s=this.simulation_expression_calculator.simulation_model;if(t){s.results=[],s.elapsed=t.elapsed,s.trials=t.trials;for(const i of t.results){const t=i instanceof ArrayBuffer?Wt(new Float64Array(i)):i;t.sheet_id||(t.sheet_id=e.active_sheet.id),s.results[t.sheet_id]||(s.results[t.sheet_id]=[]),s.results[t.sheet_id][t.column]||(s.results[t.sheet_id][t.column]=[]),s.results[t.sheet_id][t.column][t.row]=t.data,r&&this.SetDirty(t)}}else s.results=[],s.elapsed=0,s.trials=0}}const ee=self,re=new class{constructor(t){this.base_worker=t,this.trials=0,this.lhs=!1,this.data_model={active_sheet:D.Blank({}),sheets:[D.Blank({})],named_ranges:new P,macro_functions:{}},this.screen_updates=!1,this.calculator=new te,this.start_time=0,this.additional_cells=[],this.iteration=0}Timestamp(){return self.performance?performance.now():Date.now()}OnMessage(t){const e=t.data;if(e)switch(e.type){case"configure":if(e.locale&&e.locale!==m.locale&&(m.UpdateLocale(e.locale),this.calculator.UpdateLocale()),this.data_model.sheets=e.sheets.map((t=>D.FromJSON(t,{}))),this.data_model.active_sheet=this.data_model.sheets[0],e.additional_cells&&(this.additional_cells=e.additional_cells),this.data_model.named_ranges.Deserialize(e.named_ranges),this.data_model.macro_functions={},e.macro_functions)for(const t of e.macro_functions)this.data_model.macro_functions[t.name.toUpperCase()]=t;this.seed=e.seed;break;case"step":this.SimulationStep();break;case"start":this.trials=e.trials||1e3,this.lhs=!!e.lhs,this.screen_updates=!!e.screen_updates,this.Start()}}Post(t,e){this.base_worker.postMessage(t,e)}SimulationStep(){if(this.iteration>=this.trials)return;this.calculator.SimulationTrial(this.iteration);const t=Math.floor(this.iteration/this.trials*100);if(++this.iteration===this.trials)return void this.Finish();const e=this.calculator.FlattenedResults(),r=this.Timestamp()-this.start_time;this.Post({type:"update",percent_complete:t,cells:this.data_model.active_sheet.cells.toJSON(),trial_data:{results:e,trials:this.iteration,elapsed:r}},e)}Start(){if(!this.trials)throw new Error("invalid trial count");this.start_time=this.Timestamp();const t=this.calculator.InitSimulation(this.trials,this.lhs,this.data_model,this.additional_cells,this.seed);if(this.seed=void 0,t!==J.OK)throw new Error("graph failed");let e=0;if(this.screen_updates)this.iteration=0,this.SimulationStep();else{for(let t=0;t<this.trials;t++){this.calculator.SimulationTrial(t);const r=Math.floor(t/this.trials*100);r!==e&&(e=r,this.Post({type:"progress",percent_complete:e}))}this.Finish()}}Finish(){this.Post({type:"progress",percent_complete:100});const t=this.calculator.FlattenedResults(),e=this.Timestamp()-this.start_time;this.Post({type:"complete",trial_data:{results:t,trials:this.trials,elapsed:e}},t)}}(ee);ee.addEventListener("message",(t=>re.OnMessage(t)))})()})();