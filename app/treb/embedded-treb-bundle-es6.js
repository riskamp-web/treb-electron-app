/*! v10.12.12. Copyright 2018-2021 Structured Data, LLC. All rights reserved. CC BY-ND: https://treb.app/license */
(()=>{var t={742:(t,e)=>{"use strict";e.toByteArray=function(t){var e,s,o=function(t){var e=t.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var s=t.indexOf("=");return-1===s&&(s=e),[s,s===e?0:4-s%4]}(t),a=o[0],n=o[1],l=new r(function(t,e,s){return 3*(e+s)/4-s}(0,a,n)),h=0,c=n>0?a-4:a;for(s=0;s<c;s+=4)e=i[t.charCodeAt(s)]<<18|i[t.charCodeAt(s+1)]<<12|i[t.charCodeAt(s+2)]<<6|i[t.charCodeAt(s+3)],l[h++]=e>>16&255,l[h++]=e>>8&255,l[h++]=255&e;return 2===n&&(e=i[t.charCodeAt(s)]<<2|i[t.charCodeAt(s+1)]>>4,l[h++]=255&e),1===n&&(e=i[t.charCodeAt(s)]<<10|i[t.charCodeAt(s+1)]<<4|i[t.charCodeAt(s+2)]>>2,l[h++]=e>>8&255,l[h++]=255&e),l},e.fromByteArray=function(t){for(var e,i=t.length,r=i%3,o=[],a=16383,n=0,h=i-r;n<h;n+=a)o.push(l(t,n,n+a>h?h:n+a));return 1===r?(e=t[i-1],o.push(s[e>>2]+s[e<<4&63]+"==")):2===r&&(e=(t[i-2]<<8)+t[i-1],o.push(s[e>>10]+s[e>>4&63]+s[e<<2&63]+"=")),o.join("")};for(var s=[],i=[],r="undefined"!=typeof Uint8Array?Uint8Array:Array,o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a=0,n=o.length;a<n;++a)s[a]=o[a],i[o.charCodeAt(a)]=a;function l(t,e,i){for(var r,o,a=[],n=e;n<i;n+=3)r=(t[n]<<16&16711680)+(t[n+1]<<8&65280)+(255&t[n+2]),a.push(s[(o=r)>>18&63]+s[o>>12&63]+s[o>>6&63]+s[63&o]);return a.join("")}i["-".charCodeAt(0)]=62,i["_".charCodeAt(0)]=63},162:function(t,e,s){var i,r;void 0===(r="function"==typeof(i=function(){"use strict";function e(t,e,s){var i=new XMLHttpRequest;i.open("GET",t),i.responseType="blob",i.onload=function(){n(i.response,e,s)},i.onerror=function(){console.error("could not download file")},i.send()}function i(t){var e=new XMLHttpRequest;e.open("HEAD",t,!1);try{e.send()}catch(t){}return 200<=e.status&&299>=e.status}function r(t){try{t.dispatchEvent(new MouseEvent("click"))}catch(s){var e=document.createEvent("MouseEvents");e.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),t.dispatchEvent(e)}}var o="object"==typeof window&&window.window===window?window:"object"==typeof self&&self.self===self?self:"object"==typeof s.g&&s.g.global===s.g?s.g:void 0,a=o.navigator&&/Macintosh/.test(navigator.userAgent)&&/AppleWebKit/.test(navigator.userAgent)&&!/Safari/.test(navigator.userAgent),n=o.saveAs||("object"!=typeof window||window!==o?function(){}:"download"in HTMLAnchorElement.prototype&&!a?function(t,s,a){var n=o.URL||o.webkitURL,l=document.createElement("a");s=s||t.name||"download",l.download=s,l.rel="noopener","string"==typeof t?(l.href=t,l.origin===location.origin?r(l):i(l.href)?e(t,s,a):r(l,l.target="_blank")):(l.href=n.createObjectURL(t),setTimeout((function(){n.revokeObjectURL(l.href)}),4e4),setTimeout((function(){r(l)}),0))}:"msSaveOrOpenBlob"in navigator?function(t,s,o){if(s=s||t.name||"download","string"!=typeof t)navigator.msSaveOrOpenBlob(function(t,e){return void 0===e?e={autoBom:!1}:"object"!=typeof e&&(console.warn("Deprecated: Expected third argument to be a object"),e={autoBom:!e}),e.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(t.type)?new Blob(["\ufeff",t],{type:t.type}):t}(t,o),s);else if(i(t))e(t,s,o);else{var a=document.createElement("a");a.href=t,a.target="_blank",setTimeout((function(){r(a)}))}}:function(t,s,i,r){if((r=r||open("","_blank"))&&(r.document.title=r.document.body.innerText="downloading..."),"string"==typeof t)return e(t,s,i);var n="application/octet-stream"===t.type,l=/constructor/i.test(o.HTMLElement)||o.safari,h=/CriOS\/[\d]+/.test(navigator.userAgent);if((h||n&&l||a)&&"undefined"!=typeof FileReader){var c=new FileReader;c.onloadend=function(){var t=c.result;t=h?t:t.replace(/^data:[^;]*;/,"data:attachment/file;"),r?r.location.href=t:location=t,r=null},c.readAsDataURL(t)}else{var d=o.URL||o.webkitURL,u=d.createObjectURL(t);r?r.location=u:location.href=u,r=null,setTimeout((function(){d.revokeObjectURL(u)}),4e4)}});o.saveAs=n.saveAs=n,t.exports=n})?i.apply(e,[]):i)||(t.exports=r)},897:(t,e,s)=>{"use strict";s.r(e)},736:function(t,e){!function(t){"use strict";var e=new(function(){function t(t){void 0===t&&(t=0),this.m_w=0,this.m_z=0,this.Seed(t)}return t.prototype.Seed=function(t){void 0===t&&(t=0),t?(this.m_w=Math.round(2863311530&t)||1,this.m_z=Math.round(1431655765&t)||1):(this.m_w=Math.round(1e5*Math.random()),this.m_z=Math.round((new Date).getTime()))},t.prototype.Next=function(){return this.m_z=36969*(65535&this.m_z)+(this.m_z>>16)&4294967295,this.m_w=18e3*(65535&this.m_w)+(this.m_w>>16)&4294967295,.5+((this.m_z<<16)+this.m_w&4294967295)/4294967296},t.prototype.GetState=function(){return[this.m_w,this.m_z]},t}()),s=function(){function t(){}return t.Sort=function(t,e){this.QuickSort(t,e,0,t.length)},t.Partition=function(t,e,s,i){for(var r=t[i-1],o=s,a=s;a<i-1;a+=1)t[a]<=r&&(this.Swap(t,e,a,o),o+=1);return this.Swap(t,e,o,i-1),o},t.Swap=function(t,e,s,i){var r=t[s];t[s]=t[i],t[i]=r,r=e[s],e[s]=e[i],e[i]=r},t.QuickSort=function(t,e,s,i){if(s<i){var r=this.Partition(t,e,s,i);this.QuickSort(t,e,s,r),this.QuickSort(t,e,r+1,i)}},t}(),i=function(){return(i=Object.assign||function(t){for(var e,s=1,i=arguments.length;s<i;s++)for(var r in e=arguments[s])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)},r=function(){function t(){}return t.Sort=function(t){return this.QuickSort(t,0,t.length-1),t},t.Swap=function(t,e,s){var i=t[e];t[e]=t[s],t[s]=i},t.Partition=function(t,e,s){for(var i=t[Math.floor((s+e)/2)];e<=s;){for(;t[e]<i;)e++;for(;t[s]>i;)s--;e<=s&&(this.Swap(t,e,s),e++,s--)}return e},t.QuickSort=function(t,e,s){var i;return t.length>1&&(e<(i=this.Partition(t,e,s))-1&&this.QuickSort(t,e,i-1),i<s&&this.QuickSort(t,i,s)),t},t}(),o=function(){function t(){}return t.Correlation=function(t,e){for(var s=0,i=0,r=0,o=0,a=0,n=0,l=0;l<t.length;l++)i+=t[l]*e[l],r+=t[l],o+=e[l],a+=t[l]*t[l],n+=e[l]*e[l];return(s=t.length*i-r*o)&&(s/=Math.sqrt((t.length*a-r*r)*(t.length*n-o*o))),s},t.TickRange=function(t,e,s){var i=t/(e-1),r=Math.ceil(this.Log10(i)-1),o=Math.pow(10,r);return Math.ceil(i/o)*o},t.Log10=function(t){return Math.log(t)/Math.LN10},t.Log2=function(t){return Math.log(t)/Math.LN2},t.Percentiles=function(t,e){for(var s=r.Sort(t.slice(0)),i=s.length,o=new Array(101),a=0;a<100;a++)o[a]=s[Math.round(i*a/100)];return o[100]=s[i-1],o},t.Percentile=function(t,e){var s=r.Sort(t.slice(0)),i=s.length;return s[Math.max(0,Math.min(i-1,Math.round(i*e)))]},t.Interval=function(t){var e=0;if(!t.data||!t.data.length)return 0;if(void 0===t.min){if(void 0===t.max)return 1;for(var s=0,i=t.data;s<i.length;s++)(l=i[s])<=t.max&&e++}else if(void 0===t.max)for(var r=0,o=t.data;r<o.length;r++)(l=o[r])>=t.min&&e++;else for(var a=0,n=t.data;a<n.length;a++){var l;(l=n[a])>=t.min&&l<=t.max&&e++}return e/t.data.length},t.R2=function(t,e){for(var s=0,i=0,r=0,o=0,a=0,n=0,l=0,h=0,c=0;c<t.length;c++)o+=(i=e[c])*(r=t[c]),a+=i,n+=r,l+=i*i,h+=r*r;return(s=t.length*o-a*n)&&(s/=Math.sqrt((t.length*l-a*a)*(t.length*h-n*n))),s*s},t.ToSD=function(t,e){if(void 0===e&&(e=2),e=e||2,0===t)return t;var s=Math.pow(10,Math.floor(this.Log10(t))+1-e);return Math.round(t/s)*s},t.Statistics=function(t){for(var e=this.Range(t),s=t.length,o=0,a=0,n=0,l=0,h=r.Sort(t.slice(0)),c=h[Math.round(s/2)],d=0;d<s;d++)o+=t[d];var u=o/=s;for(d=0;d<s;d++){var m=t[d]-o;a+=m*m,l+=m*m*m,n+=m*m*m*m}var f=s,p=a/s,_=Math.sqrt(a/s),g=l/((s-1)*Math.pow(_,3)),y=n/((s-1)*Math.pow(_,4)),v=Math.sqrt(a/s)/Math.sqrt(s),b={};for(d=5;d<100;d+=5)b[d]=h[Math.round(s*d/100)];b[0]=h[0],b[100]=h[s-1];var w=this.Interval({data:t,max:0});return i(i({},e),{median:c,mean:u,N:f,variance:p,stdev:_,skewness:g,kurtosis:y,stderr:v,percentiles:b,zero:w})},t.Truncate=function(t,e,s){var i=r.Sort(t.slice(0));return i.slice(Math.round(i.length*e/100),Math.round(i.length*s/100))},t.Histogram=function(t,e){void 0===e&&(e="sturges");for(var s=!0,i=0;s&&i<t.length;i++)s=s&&t[i]===Math.round(t[i]);var r=this.Range(t);if("string"==typeof e||!e)if("fd"===e){var o=this.FD(t);e=0===o||0===r.range?1:Math.round(r.range/o+1)}else e=this.Sturges(t);var a=[],n=[];if(s&&e>r.range){for(e=r.range+1,i=0;i<e;i++)a[i]=0,n[i]=r.min+i;for(var l=0,h=t;l<h.length;l++)a[(_=h[l])-r.min]++}else{var c=this.TickRange(r.range,e),d=this.FirstBin(r.max,r.min,e,c),u=Math.ceil(this.Log10(c)-1);for(i=0;i<e;i++)a[i]=0,n[i]=(d+i*c).toFixed(Math.max(0,-u));for(var m=d-c,f=0,p=t;f<p.length;f++){var _=p[f];a[Math.floor((_-m)/c)]++}}return{bins:a,labels:n}},t.Sturges=function(t){return Math.ceil(this.Log2(t.length)+1)},t.IQR=function(t){var e=this.Quantiles(t,[.25,.75]);return e[1]-e[0]},t.Quantiles=function(t,e){void 0===e&&(e=[0,.25,.5,.75,1]);var s=r.Sort(t.slice(0));return e.map((function(t){return s[Math.floor((s.length-1)*t)]}))},t.FD=function(t){return 2*this.IQR(t)*Math.pow(t.length,-1/3)},t.FirstBin=function(t,e,s,i){var r=(Math.floor(e/i)+1)*i,o=Math.floor((r+(s-1)*i-t)/i);return o>=2?r-o/2*i:r},t.Range=function(t){for(var e=t.length,s=e>0?t[0]:0,i=e>0?t[0]:0,r=1;r<e;r++)t[r]>i&&(i=t[r]),t[r]<s&&(s=t[r]);return{min:s,max:i,range:i-s}},t.EPSILON_DOUBLE=2220446049250313e-31,t.QUIET_NAN=Number.NaN,t.s_undefined="undefined",t.s_object="object",t.s_number="number",t}(),a=function(){function t(){this.rows=0,this.columns=0,this.data=[]}return t.Zero=function(e,s){return void 0===s&&(s=e),(new t).Reset(e,s)},t.Identity=function(t){for(var e=this.Zero(t,t),s=0;s<t;s++)e.data[s][s]=1;return e},t.Clone=function(e){var s=new t;s.rows=e.rows,s.columns=e.columns;for(var i=0,r=e.data;i<r.length;i++){var o=r[i];s.data.push(new Float64Array(o))}return s},t.FromArray=function(t,e){void 0===e&&(e=!1);var s=t[0].length,i=t.length;if(e){for(var r=this.Zero(s,i),o=0;o<i;o++)for(var a=0;a<s;a++)r.data[o][a]=t[o][a];return r}for(r=this.Zero(i,s),o=0;o<i;o++)for(a=0;a<s;a++)r.data[a][o]=t[o][a]||0;return r},t.prototype.Reset=function(t,e){this.data=new Array(e);for(var s=0;s<e;s++)this.data[s]=new Float64Array(t);return this.rows=t,this.columns=e,this},t.prototype.CopyTo=function(t){t.rows=this.rows,t.columns=this.columns,t.data=new Array(this.columns);for(var e=0,s=this.data;e<s.length;e++){var i=s[e];t.data.push(new Float64Array(i))}return t},t.prototype.GetColumn=function(t){return this.data[t]},t.prototype.SetColumn=function(t,e){this.data[t]=new Float64Array(e)},t.prototype.Transpose=function(){for(var e=t.Zero(this.columns,this.rows),s=0;s<this.columns;s++)for(var i=0;i<this.rows;i++)e.data[s][i]=this.data[i][s];return e},t.prototype.Symmetrize=function(e){void 0===e&&(e=!1);var s=this.Transpose(),i=t.Clone(this);if(e)for(o=1;o<this.columns;o++)for(r=0;r<o;r++)i.data[r][o]=s.data[r][o];else for(var r=1;r<this.rows;r++)for(var o=0;o<r;o++)i.data[r][o]=s.data[r][o];return i},t.prototype.Cholesky=function(e){if(void 0===e&&(e=!1),this.rows!==this.columns)throw new Error("matrix not square");for(var s=this.rows,i=t.Zero(s),r=0;r<s;r++){for(var o=0,a=0;a<r;a++){for(var n=0,l=0;l<a;l++)n+=i.data[a][l]*i.data[r][l];if(i.data[r][a]=n=(this.data[r][a]-n)/i.data[a][a],o+=n*n,this.data[a][r]!==this.data[r][a])throw new Error("matrix not symmetrical")}if((o=this.data[r][r]-o)<=0)throw new Error("matrix not pos-def ("+o+")");for(i.data[r][r]=o>0?Math.sqrt(o):0,a=r+1;a<s;a++)i.data[r][a]=0}return e?i.Transpose():i},t.prototype.Multiply=function(e){for(var s=0,i=0,r=t.Zero(this.rows,e.columns),o=0;o<this.rows;o++)for(var a=0;a<e.columns;a++){for(i=s=0;s<this.columns;s++)i+=this.data[s][o]*e.data[a][s];r.data[a][o]=i}return r},t.prototype.Inverse=function(){if(this.rows!==this.columns)throw new Error("invalid matrix");for(var e=t.Clone(this),s=0,i=e.rows,r=1;r<i;r++)e.data[r][0]/=e.data[0][0];for(r=1;r<i;r++){for(var o=r;o<i;o++){s=0;for(var a=0;a<r;a++)s+=e.data[a][o]*e.data[r][a];e.data[r][o]-=s}if(r!==i-1)for(o=r+1;o<i;o++){for(s=0,a=0;a<r;a++)s+=e.data[a][r]*e.data[o][a];e.data[o][r]=(e.data[o][r]-s)/e.data[r][r]}}for(r=0;r<i;r++)for(o=r;o<i;o++){var n=1;if(r!==o)for(n=0,a=r;a<o;a++)n-=e.data[a][o]*e.data[r][a];e.data[r][o]=n/e.data[o][o]}for(r=0;r<i;r++)for(o=r;o<i;o++)if(r!==o){for(s=0,a=r;a<o;a++)s+=e.data[o][a]*(r===a?1:e.data[a][r]);e.data[o][r]=-s}for(r=0;r<i;r++)for(o=0;o<i;o++){for(s=0,a=r>o?r:o;a<i;a++)s+=(o===a?1:e.data[a][o])*e.data[r][a];e.data[r][o]=s}return e},t.prototype.SortColumns=function(e){void 0===e&&(e=!1);for(var s=t.Clone(this),i=e?function(t,e){return e-t}:function(t,e){return t-e},r=0,o=s.data;r<o.length;r++)o[r].sort(i);return s},t.prototype.Rank=function(e){void 0===e&&(e=!1);for(var i=t.Clone(this),r=new Int32Array(this.rows),o=0;o<this.rows;o++)r[o]=o;for(var a=0;a<this.columns;a++){var n=new Int32Array(r);for(s.Sort(i.data[a],n),e&&n.reverse(),o=0;o<this.rows;o++)i.data[a][n[o]]=o}return i},t.prototype.Rank2=function(e,i){void 0===e&&(e=!1);for(var r=t.Zero(this.rows,this.columns),o=new Int32Array(this.rows),a=0;a<this.rows;a++)o[a]=a;for(var n=0;n<this.columns;n++){var l=new Int32Array(o);for(s.Sort(this.data[n],l),e&&l.reverse(),a=0;a<this.rows;a++)r.data[n][l[a]]=i.data[n][a]}return r},t.prototype.Correl=function(){for(var e=t.Zero(this.columns,this.columns),s=0;s<this.columns;s++){e.data[s][s]=1;for(var i=0;i<s;i++)e.data[i][s]=o.Correlation(this.data[s],this.data[i])}return e.Symmetrize()},t.prototype.IsSymmetric=function(){if(this.rows!==this.columns)return!1;for(var t=0;t<this.columns;t++)for(var e=0;e<this.rows;e++)if(this.data[t][e]!==this.data[e][t])return!1;return!0},t.prototype.toString=function(t){var e="";t=t||2;for(var s=0;s<this.rows;s++){for(var i=0;i<this.columns;i++){var r=this.data[i][s];r>=0&&(e+=" "),e+=r.toFixed(t),e+=" "}e+="\n"}return e},t}();Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length,s=0;s<e;s++){if(arguments[s]===1/0||arguments[s]===-1/0)return 1/0;t+=arguments[s]*arguments[s]}return Math.sqrt(t)});var n=function(){function t(){}return t.Guid=function(){for(var t="",e=0;e<8;e++)t+=Math.round(256*Math.random()).toString(16);return t},t.Log10=function(t){return Math.log(t)/Math.LN10},t.ToSD=function(t,e){if(void 0===e&&(e=2),e=e||2,0===t)return t;var s=t<0?-1:1;t*=s;var i=Math.pow(10,Math.floor(this.Log10(t))+1-e);return Math.round(t/i)*i*s},t.ToSDCeil=function(t,e){if(void 0===e&&(e=2),e=e||2,0===t)return t;var s=t<0?-1:1;t*=s;var i=Math.pow(10,Math.floor(this.Log10(t))+1-e);return Math.ceil(t/i)*i*s},t.SuggestDecimals=function(t){if("number"!=typeof t){for(var e=t[0],s=t[0],i=0,r=t;i<r.length;i++){var o=r[i];e=Math.min(e,o),s=Math.max(s,o)}t=s-e}var a=Math.ceil(this.Log10(t));return console.log(a),a<=0?1-a:1},t.YearFraction=function(t){var e=new Date(t.getTime());return e.setMonth(11,31),(e.getTime()-t.getTime())/this.MILLIS_YEAR},t.DEFAULT_NUMBER_FORMAT="(0,0.00)",t.DEFAULT_PCT_FORMAT="0.00",t.DEFAULT_CURRENCY_FORMAT="(0,0)",t.MILLIS_YEAR=315576e5,t}(),l=function(){function t(t){this.order=0,this.realvalues=[],this.ivalues=[],this.vectors=[];var e=t.length;this.order=e,this.vectors=[];for(var s=!0,i=0;s&&i<e;i++){if(t[i].length!==e)throw new Error("not square");for(var r=0;r<e;r++)t[i][r]!==t[r][i]&&(s=!1)}if(s){for(i=0;i<e;i++)Array.isArray(t[i])?this.vectors.push(t[i].slice(0)):this.vectors.push(Array.from(t[i]));this.tred2(),this.tql2()}else{var o=[],a=[];for(i=0;i<e;i++){for(Array.isArray(t[i])?o.push(t[i].slice(0)):o.push(Array.from(t[i])),this.vectors.push([]),r=0;r<e;r++)this.vectors[i][r]=0;a.push(0)}this.orthes(o,a),this.hqr2(o,a)}}return t.prototype.GetDiagonal=function(){for(var t=[],e=0;e<this.order;e++){t.push([]);for(var s=0;s<this.order;s++)t[e][s]=0;t[e][e]=this.realvalues[e],this.ivalues[e]>0?t[e][e+1]=this.ivalues[e]:this.ivalues[e]<0&&(t[e][e-1]=this.ivalues[e])}return t},t.prototype.tred2=function(){for(var t=0,e=0,s=0,i=0,r=0,o=this.order,a=this.vectors,n=this.realvalues,l=this.ivalues,h=0;h<o;h++)n[h]=a[o-1][h];for(var c=o-1;c>0;c--){s=0,i=0;for(var d=0;d<c;d++)s+=Math.abs(n[d]);if(0===s)for(l[c]=n[c-1],h=0;h<c;h++)n[h]=a[c-1][h],a[c][h]=0,a[h][c]=0;else{for(d=0;d<c;d++)n[d]/=s,i+=n[d]*n[d];for(t=n[c-1],e=Math.sqrt(i),t>0&&(e=-e),l[c]=s*e,i-=t*e,n[c-1]=t-e,h=0;h<c;h++)l[h]=0;for(h=0;h<c;h++){t=n[h],a[h][c]=t;var u=l[h]+a[h][h]*t;for(d=h+1;d<=c-1;d++)u+=a[d][h]*n[d],l[d]+=a[d][h]*t;l[h]=u}for(t=0,h=0;h<c;h++)l[h]/=i,t+=l[h]*n[h];for(r=t/(i+i),h=0;h<c;h++)l[h]-=r*n[h];for(h=0;h<c;h++){for(t=n[h],e=l[h],d=h;d<=c-1;d++)a[d][h]-=t*l[d]+e*n[d];n[h]=a[c-1][h],a[c][h]=0}}n[c]=i}for(c=0;c<o-1;c++){if(a[o-1][c]=a[c][c],a[c][c]=1,0!==(i=n[c+1])){for(d=0;d<=c;d++)n[d]=a[d][c+1]/i;for(h=0;h<=c;h++){for(e=0,d=0;d<=c;d++)e+=a[d][c+1]*a[d][h];for(d=0;d<=c;d++)a[d][h]-=e*n[d]}}for(d=0;d<=c;d++)a[d][c+1]=0}for(h=0;h<o;h++)n[h]=a[o-1][h],a[o-1][h]=0;a[o-1][o-1]=1,l[0]=0},t.prototype.tql2=function(){var t,e,s,i,r,o,a,n,l,h,c,d,u,m,f,p,_,g,y,v=this.order,b=this.vectors,w=this.realvalues,C=this.ivalues;for(t=1;t<v;t++)C[t-1]=C[t];for(C[v-1]=0,a=0,n=0,l=Math.pow(2,-52),e=0;e<v;e++){for(n=Math.max(n,Math.abs(w[e])+Math.abs(C[e])),o=e;o<v&&!(Math.abs(C[o])<=l*n);)o++;if(o>e)do{for(h=w[e],i=(w[e+1]-h)/(2*C[e]),c=Math.hypot(i,1),i<0&&(c=-c),w[e]=C[e]/(i+c),w[e+1]=C[e]*(i+c),d=w[e+1],u=h-w[e],t=e+2;t<v;t++)w[t]-=u;for(a+=u,i=w[o],f=m=1,p=m,_=C[e+1],g=0,y=0,t=o-1;t>=e;t--)for(p=f,f=m,y=g,h=m*C[t],u=m*i,c=Math.hypot(i,C[t]),C[t+1]=g*c,g=C[t]/c,i=(m=i/c)*w[t]-g*h,w[t+1]=u+g*(m*h+g*w[t]),s=0;s<v;s++)u=b[s][t+1],b[s][t+1]=g*b[s][t]+m*u,b[s][t]=m*b[s][t]-g*u;i=-g*y*p*_*C[e]/d,C[e]=g*i,w[e]=m*i}while(Math.abs(C[e])>l*n);w[e]=w[e]+a,C[e]=0}for(t=0;t<v-1;t++){for(s=t,i=w[t],r=t+1;r<v;r++)w[r]<i&&(s=r,i=w[r]);if(s!==t)for(w[s]=w[t],w[t]=i,r=0;r<v;r++)i=b[r][t],b[r][t]=b[r][s],b[r][s]=i}},t.prototype.orthes=function(t,e){var s,i,r,o,a,n,l,h=this.order,c=this.vectors,d=(this.realvalues,this.ivalues,h-1);for(n=1;n<=d-1;n++){for(l=0,o=n;o<=d;o++)l+=Math.abs(t[o][n-1]);if(0!==l){for(r=0,o=d;o>=n;o--)e[o]=t[o][n-1]/l,r+=e[o]*e[o];for(i=Math.sqrt(r),e[n]>0&&(i=-i),r-=e[n]*i,e[n]=e[n]-i,a=n;a<h;a++){for(s=0,o=d;o>=n;o--)s+=e[o]*t[o][a];for(s/=r,o=n;o<=d;o++)t[o][a]-=s*e[o]}for(o=0;o<=d;o++){for(s=0,a=d;a>=n;a--)s+=e[a]*t[o][a];for(s/=r,a=n;a<=d;a++)t[o][a]-=s*e[a]}e[n]=l*e[n],t[n][n-1]=l*i}}for(o=0;o<h;o++)for(a=0;a<h;a++)c[o][a]=o===a?1:0;for(n=d-1;n>=1;n--)if(0!==t[n][n-1]){for(o=n+1;o<=d;o++)e[o]=t[o][n-1];for(a=n;a<=d;a++){for(i=0,o=n;o<=d;o++)i+=e[o]*c[o][a];for(i=i/e[n]/t[n][n-1],o=n;o<=d;o++)c[o][a]+=i*e[o]}}},t.prototype.cdiv=function(t,e,s,i){var r=0,o=0;return Math.abs(s)>Math.abs(i)?{r:(t+(r=i/s)*e)/(o=s+r*i),i:(e-r*t)/o}:{r:((r=s/i)*t+e)/(o=i+r*s),i:(r*e-t)/o}},t.prototype.hqr2=function(t,e){var s,i,r,o,a,n,l,h,c,d,u,m=this.order,f=this.vectors,p=this.realvalues,_=this.ivalues,g=m,y=g-1,v=g-1,b=Math.pow(2,-52),w=0,C=0,x=0,S=0,A=0,M=0,k=0;for(n=0;n<g;n++)for((n<0||n>v)&&(p[n]=t[n][n],_[n]=0),l=Math.max(n-1,0);l<g;l++)k+=Math.abs(t[n][l]);for(c=0;y>=0;){for(d=y;d>0&&(0===(A=Math.abs(t[d-1][d-1])+Math.abs(t[d][d]))&&(A=k),!(Math.abs(t[d][d-1])<b*A));)d--;if(d===y)t[y][y]=t[y][y]+w,p[y]=t[y][y],_[y]=0,y--,c=0;else if(d===y-1){if(i=t[y][y-1]*t[y-1][y],x=(C=(t[y-1][y-1]-t[y][y])/2)*C+i,M=Math.sqrt(Math.abs(x)),t[y][y]=t[y][y]+w,t[y-1][y-1]=t[y-1][y-1]+w,r=t[y][y],x>=0){for(M=C>=0?C+M:C-M,p[y-1]=r+M,p[y]=p[y-1],0!==M&&(p[y]=r-i/M),_[y-1]=0,_[y]=0,C=(r=t[y][y-1])/(A=Math.abs(r)+Math.abs(M)),x=M/A,C/=S=Math.sqrt(C*C+x*x),x/=S,l=y-1;l<g;l++)M=t[y-1][l],t[y-1][l]=x*M+C*t[y][l],t[y][l]=x*t[y][l]-C*M;for(n=0;n<=y;n++)M=t[n][y-1],t[n][y-1]=x*M+C*t[n][y],t[n][y]=x*t[n][y]-C*M;for(n=0;n<=v;n++)M=f[n][y-1],f[n][y-1]=x*M+C*f[n][y],f[n][y]=x*f[n][y]-C*M}else p[y-1]=r+C,p[y]=r+C,_[y-1]=M,_[y]=-M;y-=2,c=0}else{if(r=t[y][y],o=0,i=0,d<y&&(o=t[y-1][y-1],i=t[y][y-1]*t[y-1][y]),10===c){for(w+=r,n=0;n<=y;n++)t[n][n]-=r;r=o=.75*(A=Math.abs(t[y][y-1])+Math.abs(t[y-1][y-2])),i=-.4375*A*A}if(30===c&&(A=(A=(o-r)/2)*A+i)>0){for(A=Math.sqrt(A),o<r&&(A=-A),A=r-i/((o-r)/2+A),n=0;n<=y;n++)t[n][n]-=A;w+=A,r=o=i=.964}for(c+=1,u=y-2;u>=d&&(C=((S=r-(M=t[u][u]))*(A=o-M)-i)/t[u+1][u]+t[u][u+1],x=t[u+1][u+1]-M-S-A,S=t[u+2][u+1],C/=A=Math.abs(C)+Math.abs(x)+Math.abs(S),x/=A,S/=A,u!==d)&&!(Math.abs(t[u][u-1])*(Math.abs(x)+Math.abs(S))<b*(Math.abs(C)*(Math.abs(t[u-1][u-1])+Math.abs(M)+Math.abs(t[u+1][u+1]))));)u--;for(n=u+2;n<=y;n++)t[n][n-2]=0,n>u+2&&(t[n][n-3]=0);for(h=u;h<=y-1;h++){var R=h!==y-1;if(h!==u&&(C=t[h][h-1],x=t[h+1][h-1],S=R?t[h+2][h-1]:0,0!==(r=Math.abs(C)+Math.abs(x)+Math.abs(S))&&(C/=r,x/=r,S/=r)),0===r)break;if(A=Math.sqrt(C*C+x*x+S*S),C<0&&(A=-A),0!==A){for(h!==u?t[h][h-1]=-A*r:d!==u&&(t[h][h-1]=-t[h][h-1]),r=(C+=A)/A,o=x/A,M=S/A,x/=C,S/=C,l=h;l<g;l++)C=t[h][l]+x*t[h+1][l],R&&(C+=S*t[h+2][l],t[h+2][l]=t[h+2][l]-C*M),t[h][l]=t[h][l]-C*r,t[h+1][l]=t[h+1][l]-C*o;for(n=0;n<=Math.min(y,h+3);n++)C=r*t[n][h]+o*t[n][h+1],R&&(C+=M*t[n][h+2],t[n][h+2]=t[n][h+2]-C*S),t[n][h]=t[n][h]-C,t[n][h+1]=t[n][h+1]-C*x;for(n=0;n<=v;n++)C=r*f[n][h]+o*f[n][h+1],R&&(C+=M*f[n][h+2],f[n][h+2]=f[n][h+2]-C*S),f[n][h]=f[n][h]-C,f[n][h+1]=f[n][h+1]-C*x}}}}if(0!==k){for(y=g-1;y>=0;y--)if(C=p[y],0===(x=_[y]))for(d=y,t[y][y]=1,n=y-1;n>=0;n--){for(i=t[n][n]-C,S=0,l=d;l<=y;l++)S+=t[n][l]*t[l][y];if(_[n]<0)M=i,A=S;else if(d=n,0===_[n]?t[n][y]=0!==i?-S/i:-S/(b*k):(r=t[n][n+1],o=t[n+1][n],s=(r*A-M*S)/(x=(p[n]-C)*(p[n]-C)+_[n]*_[n]),t[n][y]=s,Math.abs(r)>Math.abs(M)?t[n+1][y]=(-S-i*s)/r:t[n+1][y]=(-A-o*s)/M),b*(s=Math.abs(t[n][y]))*s>1)for(l=n;l<=y;l++)t[l][y]=t[l][y]/s}else if(x<0)for(d=y-1,Math.abs(t[y][y-1])>Math.abs(t[y-1][y])?(t[y-1][y-1]=x/t[y][y-1],t[y-1][y]=-(t[y][y]-C)/t[y][y-1]):(a=this.cdiv(0,-t[y-1][y],t[y-1][y-1]-C,x),t[y-1][y-1]=a.r,t[y-1][y]=a.i),t[y][y-1]=0,t[y][y]=1,n=y-2;n>=0;n--){var L=void 0,E=void 0,T=void 0,D=void 0;for(L=0,E=0,l=d;l<=y;l++)L+=t[n][l]*t[l][y-1],E+=t[n][l]*t[l][y];if(i=t[n][n]-C,_[n]<0)M=i,S=L,A=E;else if(d=n,0===_[n]?(a=this.cdiv(-L,-E,i,x),t[n][y-1]=a.r,t[n][y]=a.i):(r=t[n][n+1],o=t[n+1][n],T=(p[n]-C)*(p[n]-C)+_[n]*_[n]-x*x,D=2*(p[n]-C)*x,0===T&&0===D&&(T=b*k*(Math.abs(i)+Math.abs(x)+Math.abs(r)+Math.abs(o)+Math.abs(M))),a=this.cdiv(r*S-M*L+x*E,r*A-M*E-x*L,T,D),t[n][y-1]=a.r,t[n][y]=a.i,Math.abs(r)>Math.abs(M)+Math.abs(x)?(t[n+1][y-1]=(-L-i*t[n][y-1]+x*t[n][y])/r,t[n+1][y]=(-E-i*t[n][y]-x*t[n][y-1])/r):(a=this.cdiv(-S-o*t[n][y-1],-A-o*t[n][y],M,x),t[n+1][y-1]=a.r,t[n+1][y]=a.i)),b*(s=Math.max(Math.abs(t[n][y-1]),Math.abs(t[n][y])))*s>1)for(l=n;l<=y;l++)t[l][y-1]=t[l][y-1]/s,t[l][y]=t[l][y]/s}for(n=0;n<g;n++)if(n<0||n>v)for(l=n;l<g;l++)f[n][l]=t[n][l];for(l=g-1;l>=0;l--)for(n=0;n<=v;n++){for(M=0,h=0;h<=Math.min(l,v);h++)M+=f[n][h]*t[h][l];f[n][l]=M}}},t}(),h=Math.pow(2,-52),c=function(){function t(){this.rows=0,this.columns=0,this._data=[]}return t.FromArray=function(t){for(var e=t[0].length,s=t.length,i=this.Zero(s,e),r=0;r<s;r++)for(var o=0;o<e;o++)i._data[r][o]=t[r][o]||0;return i},t.Zero=function(e,s){return void 0===s&&(s=e),(new t).Reset(e,s)},t.Identity=function(t){for(var e=this.Zero(t),s=0;s<t;s++)e._data[s][s]=1;return e},t.Clone=function(t){for(var e=this.Zero(t.rows,t.columns),s=0;s<t.rows;s++)e._data[s]=new Float64Array(t._data[s]);return e},t.prototype.Reset=function(t,e){void 0===e&&(e=t),this._data=new Array(t);for(var s=0;s<t;s++)this._data[s]=new Float64Array(e);return this.rows=t,this.columns=e,this},t.prototype.CopyTo=function(t){t.rows=this.rows,t.columns=this.columns,t._data=[];for(var e=0;e<this.rows;e++)t._data[e]=new Float64Array(this._data[e]);return t},t.prototype.Row=function(t,e){return void 0!==e&&(this._data[t]=new Float64Array(e)),Array.from(this._data[t])},t.prototype.Column=function(t,e){if(void 0!==e)for(var s=0;s<this.rows;s++)this._data[s][t]=arguments[1][s];var i=new Array(this.rows);for(s=0;s<this.rows;s++)i[s]=this._data[s][t];return i},t.prototype.Transpose=function(){for(var e=t.Zero(this.columns,this.rows),s=0;s<this.rows;s++)for(var i=0;i<this.columns;i++)e._data[i][s]=this._data[s][i];return e},t.prototype.ToArray=function(t){void 0===t&&(t=!1);var e=[];if(t)for(var s=0;s<this.columns;s++)e.push(this.Column(s));else for(var i=0;i<this.rows;i++)e.push(this.Row(i));return e},t.prototype.EigenSystem=function(){return new l(this._data)},t.prototype.IsPosDef=function(){return new l(this._data).realvalues.every((function(t){return t>0}))},t.prototype.MakePosDef=function(e){void 0===e&&(e=h);var s,i,r=new l(this._data),o=r.realvalues.length,a=t.Zero(o),n=t.Zero(o),c=0,d=t.Zero(o);for(r.vectors.forEach((function(t,e){return d.Row(e,t)})),s=0;s<o;s++){for(i=0;i<o;i++)a._data[s][i]=e;r.realvalues[s]>e&&(a._data[s][s]=r.realvalues[s])}for(s=0;s<o;s++){for(c=0,i=0;i<o;i++)n._data[s][i]=0,c+=r.vectors[s][i]*r.vectors[s][i]*a._data[i][i];n._data[s][s]=Math.sqrt(1/c)}for(s=0;s<o;s++)a._data[s][s]=Math.sqrt(a._data[s][s]);for(var u=n.Multiply(d.Multiply(a)),m=u.Multiply(u.Transpose()).Symmetrize(),f=0;f<m.rows;f++)m._data[f][f]=1;return m},t.prototype.Symmetrize=function(e){void 0===e&&(e=!1);var s,i,r=this.Transpose(),o=t.Clone(this);if(e)for(s=1;s<this.rows;s++)for(i=0;i<s;i++)o._data[s][i]=r._data[s][i];else for(i=1;i<this.columns;i++)for(s=0;s<i;s++)o._data[s][i]=r._data[s][i];return o},t.prototype.Cholesky=function(e){if(void 0===e&&(e=!1),this.rows!==this.columns)throw new Error("matrix not square");var s,i,r,o,a,n=this.rows,l=t.Zero(n);for(o=0;o<n;o++){for(i=0,a=0;a<o;a++){for(s=0,r=0;r<a;r++)s+=l._data[r][a]*l._data[r][o];if(l._data[a][o]=s=(this._data[a][o]-s)/l._data[a][a],i+=s*s,this._data[a][o]!=this._data[o][a])throw new Error("matrix not symmetrical")}if((i=this._data[o][o]-i)<=0)throw new Error("matrix not pos-def");for(l._data[o][o]=i>0?Math.sqrt(i):0,a=o+1;a<n;a++)l._data[a][o]=0}return e?l.Transpose():l},t.prototype.Multiply=function(e){var s,i,r,o,a=t.Zero(this.rows,e.columns);for(s=0;s<this.rows;s++)for(i=0;i<e.columns;i++){for(o=r=0;r<this.columns;r++)o+=this._data[s][r]*e._data[r][i];a._data[s][i]=o}return a},t.prototype.Inverse=function(){if(this.rows!==this.columns)throw new Error("invalid matrix");var e,s,i,r,o=t.Clone(this),a=o.rows;for(s=1;s<a;s++)o._data[0][s]/=o._data[0][0];for(s=1;s<a;s++){for(i=s;i<a;i++){for(e=0,r=0;r<s;r++)e+=o._data[i][r]*o._data[r][s];o._data[i][s]-=e}if(s!=a-1)for(i=s+1;i<a;i++){for(e=0,r=0;r<s;r++)e+=o._data[s][r]*o._data[r][i];o._data[s][i]=(o._data[s][i]-e)/o._data[s][s]}}for(s=0;s<a;s++)for(i=s;i<a;i++){var n=1;if(s!=i)for(n=0,r=s;r<i;r++)n-=o._data[i][r]*o._data[r][s];o._data[i][s]=n/o._data[i][i]}for(s=0;s<a;s++)for(i=s;i<a;i++)if(s!=i){for(e=0,r=s;r<i;r++)e+=o._data[r][i]*(s==r?1:o._data[s][r]);o._data[s][i]=-e}for(s=0;s<a;s++)for(i=0;i<a;i++){for(e=0,r=s>i?s:i;r<a;r++)e+=(i==r?1:o._data[i][r])*o._data[r][s];o._data[i][s]=e}return o},t.prototype.SortColumns=function(e){void 0===e&&(e=!1);for(var s=t.Clone(this),i=e?function(t,e){return e-t}:function(t,e){return t-e},r=0;r<this.columns;r++)s.Column(r,this.Column(r).sort(i));return s},t.prototype.Rank=function(e){void 0===e&&(e=!1);for(var i,r=t.Clone(this),o=new Array(this.rows),a=new Array(this.rows),n=0;n<this.columns;n++){for(i=0;i<this.rows;i++)a[i]=i,o[i]=this._data[i][n];for(s.Sort(o,a),e&&a.reverse(),i=0;i<this.rows;i++)r._data[a[i]][n]=i}return r},t.prototype.Correl=function(){for(var e=new Array(this.columns),s=0;s<this.columns;s++)e[s]=this.Column(s);for(var i=t.Zero(this.columns),r=0;r<this.columns;r++){i._data[r][r]=1;for(var a=0;a<r;a++)i._data[r][a]=o.Correlation(e[r],e[a])}return i.Symmetrize()},t.prototype.IsSymmetric=function(){if(this.rows!=this.columns)return!1;for(var t=0;t<this.rows;t++)for(var e=0;e<this.columns;e++)if(this._data[t][e]!==this._data[e][t])return!1;return!0},t}();Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length,s=0;s<e;s++){if(arguments[s]===1/0||arguments[s]===-1/0)return 1/0;t+=arguments[s]*arguments[s]}return Math.sqrt(t)});for(var d=function(){function t(){}return t.Normal=function(t,e){var s=this;void 0===e&&(e={});var r=i({mean:0,sd:1,lhs:!1,ordered:!1},e);return(r.lhs?this.LHSField(t,r.ordered):this.UniformField(t,r.ordered)).map((function(t){return s.InverseNormal2(t)*r.sd+r.mean}))},t.ReverseInverseNormal2=function(t,e){var s=this;void 0===e&&(e=40);for(var i=[0,Math.min(1,Math.max(0,.5+.125*t)),1],r=i.map((function(t){return s.InverseNormal2(t)})),o=0;o<e;o++){if(Math.abs(r[1]-t)<=1e-6)return i[1];r[1]<t?(i=[i[1],(i[1]+i[2])/2,i[2]],r=[r[1],this.InverseNormal2(i[1]),r[2]]):(i=[i[0],(i[0]+i[1])/2,i[1]],r=[r[0],this.InverseNormal2(i[1]),r[1]])}return i[1]},t.TruncatedNormal=function(t,e){var s=this;void 0===e&&(e={});var r=i({mean:0,sd:1,lhs:!1,ordered:!1},e),o=r.lhs?this.LHSField(t,r.ordered):this.UniformField(t,r.ordered),a=0,n=1;"number"==typeof r.min&&(a=this.ReverseInverseNormal2((r.min-r.mean)/r.sd,r.max_iterations)),"number"==typeof r.max&&(n=this.ReverseInverseNormal2((r.max-r.mean)/r.sd,r.max_iterations));var l=n-a;return(o=o.map((function(t){return t*l+a}))).map((function(t){return s.InverseNormal2(t)*r.sd+r.mean}))},t.LogNormal=function(t,e){void 0===e&&(e={});for(var s=i({mean:1,sd:1,lhs:!1,ordered:!1},e),r=s.lhs?this.LHSFieldDouble(t,s.ordered):this.UniformField(t,s.ordered),o=0;o<r.length;o++)r[o]=Math.exp(this.InverseNormal2(r[o])*s.sd+s.mean);return r},t.LogNormalReturn=function(t,e){void 0===e&&(e={});var s=i({mean:1,sd:1,lhs:!1,ordered:!1},e),r=s.lhs?this.LHSFieldDouble(t,s.ordered):this.UniformField(t,s.ordered);s.mean+=1;for(var o=s.mean*s.mean,a=s.sd*s.sd,n=Math.log(o/Math.sqrt(o+a)),l=Math.sqrt(Math.log((o+a)/o)),h=0;h<t;h++)r[h]=Math.exp(this.InverseNormal2(r[h])*l+n)-1;return r},t.Triangular=function(t,e){var s=this;void 0===e&&(e={});var r=i({a:0,b:1,c:.5,lhs:!1,ordered:!1,field:null},e);return(r.field||(r.lhs?this.LHSField(t,r.ordered):this.UniformField(t,r.ordered))).map((function(t){return s.InverseTriangular(t,r.a,r.b,r.c)}))},t.PERT=function(t,e){void 0===e&&(e={});var s=i({field:null,lhs:!1,a:0,b:1,c:.5,lambda:4,ordered:!1},e),r=s.field||(s.lhs?this.LHSField(t,s.ordered):this.UniformField(t,s.ordered));return this.InversePERTField(r,s.a,s.b,s.c,s.lambda)},t.Uniform=function(t,e){void 0===e&&(e={});for(var s=i({lhs:!1,min:0,max:1,ordered:!1},e),r=s.lhs?this.LHSFieldDouble(t,s.ordered):this.UniformField(t,s.ordered),o=s.max-s.min,a=0;a<r.length;a++)r[a]=r[a]*o+s.min;return r},t.Bernoulli=function(t,e){void 0===e&&(e={});var s=i({lhs:!1,p:.5},e);return this.Uniform(t,{lhs:s.lhs,min:0,max:1}).map((function(t){return t<=s.p}))},t.Beta=function(t,e){var s=this;void 0===e&&(e={});var r=i({lhs:!1,a:0,b:1,ordered:!1},e);return(r.lhs?this.LHSField(t,r.ordered):this.UniformField(t,r.ordered)).map((function(t){return s.InverseBeta(t,r.a,r.b)}))},t.Discretize=function(t,e){var s=t.slice(0);e=e||Math.round;for(var i=0;i<s.length;i++)s[i]=e(s[i]);return s},t.Constant=function(t,e){for(var s=new Array(t),i=0;i<t;i++)s[i]=e;return s},t.Fixed=function(t,e){void 0===e&&(e={}),e=i({value:0},e);for(var s=new Array(t),r=0;r<t;r++)s[r]=e.value;return s},t.Conditional=function(t,e,s,i,r,o){void 0===r&&(r=0);for(var a=o||this.Bernoulli(t,{lhs:!0,p:e}),n=s(Math.ceil(t*e),i),l=new Array(t),h=0,c=0;h<t;h++)l[h]=a[h]?n[c++]:r;return l},t.Correlate=function(t,e,s){void 0===s&&(s=!1);var i,r=e.length,o=e[0].length,a=c.Zero(o,r);for(i=0;i<r;i++)a.Column(i,this.VDWField(o));var n=a.Multiply(t.Cholesky(!0).Multiply(a.Correl().Cholesky(!0).Inverse()).Transpose()).Rank();return s?e.map((function(t,e){var s=new Array(t.length),r=n.Column(e);for(i=0;i<r.length;i++)s[i]=t[r[i]];return s})):e.map((function(t,e){var s=t.slice(0).sort((function(t,e){return t-e})),r=new Array(t.length),o=n.Column(e);for(i=0;i<o.length;i++)r[i]=s[o[i]];return r}))},t.CorrelateCDM=function(t,e,s){void 0===s&&(s=!1);var i,r=e.length,o=e[0].length,n=a.Zero(o,r);for(i=0;i<r;i++)n.SetColumn(i,this.VDWField(o));var l=new a;if(l.rows=o,l.columns=r,l.data=e.map((function(t){return new Float64Array(t)})),!s)throw new Error("E_NOTIMPL: correlateCDM !ordered");return n.Multiply(t.Cholesky(!0).Multiply(n.Correl().Cholesky(!0).Inverse()).Transpose()).Rank2(!1,l).data},t.P80Pert=function(t,e,s,i){var r=this.PERTParameters(t,e,s,i),o=(r.max-r.min)/(this.InverseBeta(.9,r.v,r.w)-this.InverseBeta(.1,r.v,r.w)),a=r.min-this.InverseBeta(.1,r.v,r.w)*o,n=r.max+(1-this.InverseBeta(.9,r.v,r.w))*o;return{a:a/r.scale,b:n/r.scale,c:s}},t.P80Triangular=function(t,e,s){var i,r=(s-t)/(e-t),o=r<.5;o&&(r=1-r);var a=2.1266864*r-.1596122-2.1742909*r*r+1.1087738*r*r*r;o&&(a=1-a);var n=(e-t)/(.6890868-.4434898*r+.35757*r*r);return{a:i=s-a*n,b:i+n,c:s}},t.BetaDensity=function(t,e,s){if("number"!=typeof t){for(var i=new Array(t.length),r=0;r<t.length;r++)t[r]<=0||t[r]>=1?i[r]=0:i[r]=Math.exp((e-1)*Math.log(t[r])+(s-1)*Math.log(1-t[r])-this.LnGamma(e)-this.LnGamma(s)+this.LnGamma(e+s));return i}return t<=0||t>=1?0:Math.exp((e-1)*Math.log(t)+(s-1)*Math.log(1-t)-this.LnGamma(e)-this.LnGamma(s)+this.LnGamma(e+s))},t.PERTDensity=function(t,e,s,i,r){void 0===r&&(r=4);var o,a,n=(e+s+r*i)/(r+2);return a=(o=i===n?r/2+1:(n-e)*(2*i-e-s)/((i-n)*(s-e)))*(s-n)/(n-e),this.BetaDensity(t,o,a)},t.NormalDensity=function(t){if("number"!=typeof t){for(var e=new Array(t.length),s=0;s<t.length;s++)e[s]=.398942280401433*Math.exp(-t[s]*t[s]/2);return e}return.398942280401433*Math.exp(-t*t/2)},t.Shuffle=function(t){var s,i,r;for(i=t.length-1;i>=0;i--)s=Math.floor(e.Next()*(i+1)),r=t[i],t[i]=t[s],t[s]=r;return t},t.VDWField=function(t){if(this.vdw_cache.length!==t){this.vdw_cache=new Float64Array(t);for(var e=0;e<t;e++)this.vdw_cache[e]=this.InverseNormal2((e+1)/(t+1))}var s=new Float64Array(this.vdw_cache);return this.Shuffle(s)},t.LHSFieldDouble=function(t,s){void 0===s&&(s=!1);for(var i=1/t,r=new Float64Array(t),o=0;o<t;o++)r[o]=e.Next()*i+o*i;return s||this.Shuffle(r),r},t.LHSField=function(t,s){void 0===s&&(s=!1);for(var i=1/t,r=new Array(t),o=0;o<t;o++)r[o]=e.Next()*i+o*i;return s||this.Shuffle(r),r},t.UniformField=function(t,s){void 0===s&&(s=!1);for(var i=new Array(t),r=0;r<t;r++)i[r]=e.Next();return s&&i.sort((function(t,e){return t-e})),i},t.InverseTriangular=function(t,e,s,i){return e===s?e:t<=(i-e)/(s-e)?e+Math.sqrt((s-e)*(i-e)*t):s-Math.sqrt((s-e)*(s-i)*(1-t))},t.InverseNormal=function(t){return.5===t?0:(e=t<1&&t>.5?1-t:t,i=(s=Math.sqrt(Math.log(1/Math.pow(e,2))))-(2.515517+.802853*s+.010328*Math.pow(s,2))/(1+1.432788*s+.189269*Math.pow(s,2)+.001308*Math.pow(s,3)),t>.5?i:-i);var e,s,i},t.InverseNormal2=function(t){var e,s,i=t-.5;return Math.abs(i)<=.425?i*(((((((2509.0809287301227*(s=.180625-i*i)+33430.57558358813)*s+67265.7709270087)*s+45921.95393154987)*s+13731.69376550946)*s+1971.5909503065513)*s+133.14166789178438)*s+3.3871328727963665)/(((((((5226.495278852854*s+28729.085735721943)*s+39307.89580009271)*s+21213.794301586597)*s+5394.196021424751)*s+687.1870074920579)*s+42.31333070160091)*s+1):(s=i<0?t:1-t)<=0?0:(e=(s=Math.sqrt(-Math.log(s)))<=5?(((((((.0007745450142783414*(s-=1.6)+.022723844989269184)*s+.2417807251774506)*s+1.2704582524523684)*s+3.6478483247632045)*s+5.769497221460691)*s+4.630337846156546)*s+1.4234371107496835)/(((((((1.0507500716444169e-9*s+.0005475938084995345)*s+.015198666563616457)*s+.14810397642748008)*s+.6897673349851)*s+1.6763848301838038)*s+2.053191626637759)*s+1):(((((((2.0103343992922881e-7*(s-=5)+27115555687434876e-21)*s+.0012426609473880784)*s+.026532189526576124)*s+.29656057182850487)*s+1.7848265399172913)*s+5.463784911164114)*s+6.657904643501103)/(((((((20442631033899397e-31*s+1.421511758316446e-7)*s+18463183175100548e-21)*s+.0007868691311456133)*s+.014875361290850615)*s+.1369298809227358)*s+.599832206555888)*s+1),i<0?-e:e)},t.Log1p=function(t){var e=1+t;return Math.log(e)-(e-1-t)/e},t.BetaContFrac=function(e,s,i,r){var o,a=2*Number.MIN_VALUE,n=0,l=1,h=1-(e+s)*i/(e+1);for(Math.abs(h)<a&&(h=t.QUIET_NAN),o=h=1/h;n<512;){var c,d=n+1,u=d*(s-d)*i/((e-1+2*d)*(e+2*d));if(h=1+u*h,l=1+u/l,Math.abs(h)<a&&(h=t.QUIET_NAN),Math.abs(l)<a&&(l=t.QUIET_NAN),o*=(h=1/h)*l,h=1+(u=-(e+d)*(e+s+d)*i/((e+2*d)*(e+2*d+1)))*h,l=1+u/l,Math.abs(h)<a&&(h=t.QUIET_NAN),Math.abs(l)<a&&(l=t.QUIET_NAN),o*=c=(h=1/h)*l,Math.abs(c-1)<2*t.EPSILON_DOUBLE)break;if(o*Math.abs(c-1)<r)break;++n}return n>=512?t.QUIET_NAN:o},t.BetaCDF=function(e,s,i){if(e<=0)return 0;if(e>=1)return 1;if(0===e)return 0;if(1===e)return 1;var r,o=-(this.LnGamma(s)+this.LnGamma(i)-this.LnGamma(s+i))+s*Math.log(e)+i*this.Log1p(-e),a=Math.exp(o);return e<(s+1)/(s+i+2)?(r=Math.abs(0/(1*a/s))*t.EPSILON_DOUBLE,a*this.BetaContFrac(s,i,e,r)/s*1+0):(r=Math.abs(1/(1*a/i))*t.EPSILON_DOUBLE,1*(1-a*this.BetaContFrac(i,s,1-e,r)/i)+0)},t.LnGamma=function(t){var e=t-1,s=e+5.5;s-=(e+.5)*Math.log(s);var i=1;return i+=76.18009173/(e+=1),i+=-86.50532033/(e+=1),i+=24.01409822/(e+=1),i+=-1.231739516/(e+=1),i+=.00120858003/(e+=1),i+=-536382e-11/(e+=1),-s+Math.log(2.50662827465*i)},t.BetaPDF=function(t,e,s){return t<0||t>1?0:Math.exp(this.LnGamma(e+s)-this.LnGamma(e)-this.LnGamma(s))*Math.pow(t,e-1)*Math.pow(1-t,s-1)},t.InverseBeta=function(t,e,s){var i,r,o,a,n,l,h,c,d=0;if(t<0||t>1||e<0||s<0)return 0;if(0===t)return 0;if(1===t)return 1;if(t>.5){var u=1-t;return u>.5?this.InverseBeta(1-u,e,s):1-this.InverseBeta(u,s,e)}if(r=e/(e+s),t<.1){var m=(Math.log(e)+this.LnGamma(e)+this.LnGamma(s)-this.LnGamma(e+s)+Math.log(t))/e;m<=0?(i=Math.exp(m),i*=Math.pow(1-i,-(s-1)/e)):i=r,i>r&&(i=r)}else i=r;do{if(a=t-this.BetaCDF(i,e,s),n=this.BetaPDF(i,e,s),0===a||d++>64)return i;c=-((e-1)/i-(s-1)/(1-i))*(o=a/Math.max(2*Math.abs(a/i),n))*o/2,l=h=o,Math.abs(c)<Math.abs(h)?l+=c:l*=2*Math.abs(h/c),i+l>0&&i+l<1?i+=l:i=Math.sqrt(i)*Math.sqrt(r)}while(Math.abs(h)>1e-10*i);return i},t.InversePERTField=function(t,e,s,i,r){var o=this;if(s<=e)return t.map((function(){return e}));try{var a=this.PERTParameters(e,s,i,r);return t.map((function(t){return(o.InverseBeta(t,a.v,a.w)*(a.max-a.min)+a.min)/a.scale}))}catch(i){return e===s?t.map((function(t){return e})):t.map((function(t){return 0}))}},t.PERTParameters=function(t,e,s,i){if(void 0===i&&(i=4),t>=e||i<0||s<t||s>e)throw new Error("Invalid parameters");for(var r,o,a=1;Math.abs(t)<1&&Math.abs(e)<1;)a*=10,t*=10,e*=10,s*=10;return r=(t+e+i*s)/(i+2),{v:o=(0===s?Math.abs(r-s):Math.abs((r-s)/s))<=1e-12?i/2+1:(r-t)*(2*s-t-e)/((s-r)*(e-t)),w:o*(e-r)/(r-t),min:t,max:e,scale:a}},t.InversePERT=function(t,e,s,i,r){void 0===r&&(r=4);var o=this.PERTParameters(e,s,i,r);return(this.InverseBeta(t,o.v,o.w)*(o.max-o.min)+o.min)/o.scale},t.EPSILON_DOUBLE=2220446049250313e-31,t.QUIET_NAN=Number.NaN,t.M_LN_SQRT_2PI=.9189385332046728,t.M_1_SQRT_2PI=.3989422804014327,t.vdw_cache=new Float64Array(0),t}(),u=new Array(256),m=0;m<256;++m)u[m]=(m+256).toString(16).substr(1);var f=function(){function t(){this.buffer=[],this.buffer=[];for(var t=0;t<16;t++)this.buffer[t]=Math.floor(256*e.Next())}return t.prototype.toString=function(){var t=0;return u[this.buffer[t++]]+u[this.buffer[t++]]+u[this.buffer[t++]]+u[this.buffer[t++]]+"-"+u[this.buffer[t++]]+u[this.buffer[t++]]+"-"+u[this.buffer[t++]]+u[this.buffer[t++]]+"-"+u[this.buffer[t++]]+u[this.buffer[t++]]+"-"+u[this.buffer[t++]]+u[this.buffer[t++]]+u[this.buffer[t++]]+u[this.buffer[t++]]+u[this.buffer[t++]]+u[this.buffer[t++]]},t}();t.CDMatrix=a,t.Eigensystem=l,t.MC=d,t.Matrix=c,t.QSort=r,t.QSort2=s,t.Random=e,t.Stats=o,t.UUID=f,t.Util=n,Object.defineProperty(t,"__esModule",{value:!0})}(e)}},e={};function s(i){var r=e[i];if(void 0!==r)return r.exports;var o=e[i]={exports:{}};return t[i].call(o.exports,o,o.exports,s),o.exports}s.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),s.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},(()=>{"use strict";function t(t,e){var s={};for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&e.indexOf(i)<0&&(s[i]=t[i]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(i=Object.getOwnPropertySymbols(t);r<i.length;r++)e.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(t,i[r])&&(s[i[r]]=t[i[r]])}return s}function e(t,e,s,i){return new(s||(s=Promise))((function(r,o){function a(t){try{l(i.next(t))}catch(t){o(t)}}function n(t){try{l(i.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(a,n)}l((i=i.apply(t,e||[])).next())}))}Object.create,Object.create;const i=t=>"object"==typeof t&&void 0!==t.row&&void 0!==t.column;class r{constructor(t,e=t,s=!1){this.end_=this.PatchNull(e),this.start_=this.PatchNull(t),s&&this.Normalize()}static FromColumn(t){return new r({row:1/0,column:t})}static FromRow(t){return new r({row:t,column:1/0})}static ColumnToLabel(t){let e=String.fromCharCode(65+t%26);for(;t>25;)t=Math.floor(t/26)-1,e=String.fromCharCode(65+t%26)+e;return e}static CellAddressToLabel(t,e=!1){return(e?`${t.sheet_id||0}!`:"")+(t.absolute_column?"$":"")+this.ColumnToLabel(t.column)+(t.absolute_row?"$":"")+(t.row+1)}static Join(t,...e){const s=new r(t.start,t.end);for(const t of e)t&&(s.ConsumeAddress(t.start),s.ConsumeAddress(t.end));return s}static Bleed(t,e=1){return new r({row:Math.max(0,t.start.row-e),column:Math.max(0,t.start.column-e)},{row:t.end.row+e,column:t.end.column+e})}get start(){return Object.assign({},this.start_)}set start(t){this.start_=t}get end(){return Object.assign({},this.end_)}set end(t){this.end_=t}get rows(){return this.start_.row===1/0||this.end_.row===1/0?1/0:this.end_.row-this.start_.row+1}get columns(){return this.start_.column===1/0||this.end_.column===1/0?1/0:this.end_.column-this.start_.column+1}get count(){return this.rows*this.columns}get entire_sheet(){return this.entire_row&&this.entire_column}get entire_column(){return this.start_.row===1/0}get entire_row(){return this.start_.column===1/0}PatchNull(t){const e=Object.assign({},t);return null===e.row&&(e.row=1/0),null===e.column&&(e.column=1/0),e}SetSheetID(t){this.start_.sheet_id=t}Normalize(){const t=Object.assign({},this.start_),e=Object.assign({},this.end_);t.row===1/0||e.row===1/0?t.row=e.row=1/0:t.row>e.row&&(t.row=this.end_.row,t.absolute_row=this.end_.absolute_row,e.row=this.start_.row,e.absolute_row=this.start_.absolute_row),t.column===1/0||e.column===1/0?t.column=e.column=1/0:t.column>e.column&&(t.column=this.end_.column,t.absolute_column=this.end_.absolute_column,e.column=this.start_.column,e.absolute_column=this.start_.absolute_column),this.start_=t,this.end_=e}TopLeft(){const t={row:0,column:0};return this.entire_row||(t.column=this.start.column),this.entire_column||(t.row=this.start.row),t}BottomRight(){const t={row:0,column:0};return this.entire_row||(t.column=this.end.column),this.entire_column||(t.row=this.end.row),t}ContainsRow(t){return this.entire_column||t>=this.start_.row&&t<=this.end_.row}ContainsColumn(t){return this.entire_row||t>=this.start_.column&&t<=this.end_.column}Contains(t){return(this.entire_column||t.row>=this.start_.row&&t.row<=this.end_.row)&&(this.entire_row||t.column>=this.start_.column&&t.column<=this.end_.column)}ContainsArea(t){return this.start.column<=t.start.column&&this.end.column>=t.end.column&&this.start.row<=t.start.row&&this.end.row>=t.end.row}Intersects(t){return!(t.start.column>this.end.column||this.start.column>t.end.column||t.start.row>this.end.row||this.start.row>t.end.row)}Equals(t){return t.start_.row===this.start_.row&&t.start_.column===this.start_.column&&t.end_.row===this.end_.row&&t.end_.column===this.end_.column}Clone(){return new r(this.start,this.end)}Array(){if(this.entire_column||this.entire_row)throw new Error("can't convert infinite area to array");const t=new Array(this.rows*this.columns),e=this.start_.sheet_id;let s=0;for(let i=this.start_.row;i<=this.end_.row;i++)for(let r=this.start_.column;r<=this.end_.column;r++)t[s++]={row:i,column:r,sheet_id:e};return t}get left(){const t=new r(this.start_,this.end_);return t.end_.column=t.start_.column,t}get right(){const t=new r(this.start_,this.end_);return t.start_.column=t.end_.column,t}get top(){const t=new r(this.start_,this.end_);return t.end_.row=t.start_.row,t}get bottom(){const t=new r(this.start_,this.end_);return t.start_.row=t.end_.row,t}Shift(t,e){return this.start_.row+=t,this.start_.column+=e,this.end_.row+=t,this.end_.column+=e,this}ConsumeAddress(t){this.entire_row||(t.column<this.start_.column&&(this.start_.column=t.column),t.column>this.end_.column&&(this.end_.column=t.column)),this.entire_column||(t.row<this.start_.row&&(this.start_.row=t.row),t.row>this.end_.row&&(this.end_.row=t.row))}ConsumeArea(t){this.ConsumeAddress(t.start),this.ConsumeAddress(t.end)}Resize(t,e){return this.end_.row=this.start_.row+t-1,this.end_.column=this.start_.column+e-1,this}Iterate(t){if(this.entire_column||this.entire_row)console.warn("don't iterate infinite area");else for(let e=this.start_.column;e<=this.end_.column;e++)for(let s=this.start_.row;s<=this.end_.row;s++)t({column:e,row:s,sheet_id:this.start_.sheet_id})}get spreadsheet_label(){let t;return this.entire_sheet?"":this.entire_column?(t=r.ColumnToLabel(this.start_.column),t+=":"+r.ColumnToLabel(this.end_.column),t):this.entire_row?(t=String(this.start_.row+1),t+=":"+(this.end_.row+1),t):(t=r.CellAddressToLabel(this.start_),this.columns>1||this.rows>1?t+":"+r.CellAddressToLabel(this.end_):t)}toJSON(){return{start:Object.assign({},this.start_),end:Object.assign({},this.end_)}}}var o;!function(t){t[t[void 0]=0]="undefined",t[t.formula=1]="formula",t[t.string=2]="string",t[t.number=3]="number",t[t.boolean=4]="boolean",t[t.object=5]="object",t[t.error=6]="error"}(o||(o={}));const a=t=>{switch(typeof t){case"undefined":return o.undefined;case"number":return o.number;case"boolean":return o.boolean;case"object":return null===t?o.undefined:o.object;case"string":return"="===t[0]?o.formula:o.string;default:return o.error}};var n;!function(t){t[t.List=0]="List",t[t.Date=1]="Date",t[t.Range=2]="Range",t[t.Number=3]="Number",t[t.Boolean=4]="Boolean"}(n||(n={}));class l{constructor(t,e){this.type=o.undefined,this.render_dirty=!0,void 0!==t&&this.Set(t,e)}static StringToColumn(t){let e=0;t=t.toUpperCase();for(let s=0;s<t.length;s++)e*=26,e+=t.charCodeAt(s)-64;return e-1}ValueIsNumber(){return this.type===o.number}ValueIsFormula(){return this.type===o.formula}ValueIsBoolean(){return this.type===o.boolean}FlushStyle(){this.formatted=this.rendered_type=this.style=void 0,this.render_dirty=!0}FlushArray(){this.area=void 0}FlushCache(){this.calculated=this.calculated_type=this.formatted=this.rendered_type=this.render_function=this.click_function=void 0,this.render_dirty=!0}Reset(){this.type=o.undefined,this.value=this.note=this.hyperlink=this.formatted=this.rendered_type=this.style=this.calculated=this.calculated_type=this.area=this.renderer_data=this.render_function=this.click_function=void 0,this.render_dirty=!0}Set(t,e=a(t)){this.value=t,this.type=e,this.formatted=this.rendered_type=this.style=this.calculated=this.calculated_type=this.render_function=this.click_function=this.area=void 0,this.render_dirty=!0}SetCalculatedValue(t,e=a(t)){this.calculated!==t&&(this.calculated=t,this.calculated_type=e,this.formatted=this.rendered_type=void 0,this.render_dirty=!0)}SetCalculatedValueOrError(t,e){void 0===e&&("object"==typeof t&&t.error?(e=o.error,t=t.error):e=a(t)),this.calculated!==t&&(this.calculated=t,this.calculated_type=e,this.formatted=this.rendered_type=void 0,this.render_dirty=!0)}GetValue(){return this.calculated_type?this.calculated:"string"==typeof this.value&&"'"===this.value[0]?this.value.slice(1):this.value}GetValue4(){return this.calculated_type?{type:this.calculated_type,value:this.calculated}:this.type===o.formula?{type:o.number,value:0}:{type:this.type,value:"string"==typeof this.value&&"'"===this.value[0]?this.value.slice(1):this.value}}SetNote(t){this.note=t,this.render_dirty=!0}SetCalculationError(t="ERR"){this.SetCalculatedValue(t,o.error)}SetArray(t){this.type=o.undefined,this.value=this.formatted=this.rendered_type=this.style=this.hyperlink=this.calculated=this.calculated_type=void 0,this.area=t,this.render_dirty=!0}SetArrayHead(t,e){this.type=a(e),this.value=e,this.formatted=this.rendered_type=this.style=this.calculated=this.calculated_type=void 0,this.area=t,this.render_dirty=!0}}const h=t=>t.type===o.formula,c=t=>t.type===o.object,d=()=>({type:o.undefined,value:void 0}),u=(t,e)=>(void 0===e&&(e=a(t)),{value:t,type:e}),m=t=>!t.cells,f=t=>!!t[0]&&m(t[0]),p=t=>!!t[0]&&void 0!==t[0].row;class _{constructor(){this.data=[],this.rows_=0,this.columns_=0}get rows(){return this.rows_}get columns(){return this.columns_}EnsureRow(t){this.rows_=Math.max(t+1,this.rows_)}EnsureColumn(t){this.columns_=Math.max(t+1,this.columns_)}InsertColumns(t=0,e=1){this.data=this.data.map((s=>{if(s.length>=t){const i=s.slice(0,t);let r=t+e;return s.slice(t).forEach((t=>i[r++]=t)),i}return s})),this.columns_+=e}DeleteColumns(t,e=1){this.data.forEach((s=>s.splice(t,e))),this.columns_-=e}DeleteRows(t,e=1){this.data.splice(t,e),this.rows_-=e}InsertRows(t=0,e=1){const s=[t,0,[]];for(let t=1;t<e;t++)s.push([]);Array.prototype.splice.apply(this.data,s),this.rows_+=e}GetCell(t,e){const{row:s,column:i}=t;if(!this.data[s]){if(!e)return;this.data[s]=[],this.rows_=Math.max(this.rows_,s+1)}return this.data[s][i]||e&&(this.data[s][i]=new l,this.columns_=Math.max(this.columns_,i+1)),this.data[s][i]}EnsureCell(t){const{row:e,column:s}=t;let i=this.data[e];i||(this.data[e]=i=[],this.rows_=Math.max(this.rows_,e+1));let r=i[s];return r||(r=i[s]=new l,this.columns_=Math.max(this.columns_,s+1)),r}FromArray(t=[],e=!1){this.data=[];let s=0,i=0;if(e){i=t.length;for(let e=0;e<i;e++){const i=t[e];s=Math.max(s,i.length);for(let t=0;t<i.length;t++)this.data[t]||(this.data[t]=[]),this.data[t][e]=new l(i[t])}}else{s=t.length;for(let e=0;e<s;e++){const s=[],r=t[e];i=Math.max(i,r.length);for(let t=0;t<r.length;t++)s[t]=new l(r[t]);this.data[e]=s}}this.rows_=s,this.columns_=i}FromJSON(t=[]){if(this.data=[],!f(t)){const e=[];if(p(t))for(const s of t)for(const t of s.cells)e.push(Object.assign(Object.assign({},t),{row:s.row}));else for(const s of t)for(const t of s.cells)e.push(Object.assign(Object.assign({},t),{column:s.column}));t=e}for(const e of t){this.data[e.row]||(this.data[e.row]=[]);const t=new l(e.value);if(void 0!==e.calculated&&t.SetCalculatedValue(e.calculated,e.calculated_type),void 0!==e.note&&(t.note=e.note),void 0!==e.hyperlink&&(t.hyperlink=e.hyperlink),this.data[e.row][e.column]&&this.data[e.row][e.column].area&&(t.area=this.data[e.row][e.column].area),this.data[e.row][e.column]=t,e.area){const t=new r(e.area.start,e.area.end);for(let e=t.start.row;e<=t.end.row;e++)for(let s=t.start.column;s<=t.end.column;s++)this.data[e]||(this.data[e]=[]),this.data[e][s]||(this.data[e][s]=new l),this.data[e][s].area=t}if(e.merge_area){const t=new r(e.merge_area.start,e.merge_area.end);for(let e=t.start.row;e<=t.end.row;e++)for(let s=t.start.column;s<=t.end.column;s++)this.data[e]||(this.data[e]=[]),this.data[e][s]||(this.data[e][s]=new l),this.data[e][s].merge_area=t}e.validation&&(t.validation=e.validation)}this.rows_=this.data.length,this.columns_=this.data.reduce(((t,e)=>Math.max(t,e.length)),0)}toJSON(e={}){let s,i=0,r=0,a=this.data.length-1;e.subset&&(i=e.subset.start.column,r=e.subset.start.row,a=e.subset.end.row);const n=[];let l=-1,h=-1;const c={},d={};for(let t=r;t<=a;t++)if(this.data[t]){const r=this.data[t];s=r.length-1,e.subset&&(s=e.subset.end.column);for(let a=i;a<=s;a++){const s=r[a],i=s&&s.merge_area&&s.merge_area.start.row===t&&s.merge_area.start.column===a,u=s&&s.area&&s.area.start.row===t&&s.area.start.column===a,m=!s||s.type===o.string&&!s.value;if(s&&(!m||e.preserve_empty_strings)&&(i||s.type||s.calculated_type&&e.expand_arrays||s.calculated_type&&e.calculated_value||s.validation||e.decorated_cells&&s.style&&(s.style.fill||s.style.border_bottom||s.style.border_top||s.style.border_left||s.style.border_right))){const i={row:t,column:a,value:s.value};s.note&&(i.note=s.note),s.hyperlink&&(i.hyperlink=s.hyperlink),e.preserve_type&&(i.type=s.type),e.sheet_id&&(i.sheet_id=e.sheet_id),e.calculated_value&&void 0!==s.calculated&&(i.calculated=s.calculated,(e.preserve_type||s.calculated_type===o.error)&&(i.calculated_type=s.calculated_type)),s.area&&u&&(i.area=s.area.toJSON()),s.merge_area&&(i.merge_area=s.merge_area.toJSON()),s.validation&&(i.validation=s.validation),e.cell_style_refs&&e.cell_style_refs[a]&&e.cell_style_refs[a][t]&&(i.style_ref=e.cell_style_refs[a][t],e.cell_style_refs[a][t]=0),c[t]=t,d[a]=a,l=Math.max(t,l),h=Math.max(a,h),n.push(i)}}}if(e.nested){const e=Object.keys(c),s=Object.keys(d);if(e.length<=s.length&&e.length){const s={},i=[];for(const e of n){const{row:i}=e,r=t(e,["row"]);s[e.row]||(s[e.row]=[]),s[e.row].push(r)}for(const t of e){const e=Number(t);i.push({row:e,cells:s[e]})}return{data:i,rows:l,columns:h+1}}if(s.length){const e={},i=[];for(const s of n){const{column:i}=s,r=t(s,["column"]);e[s.column]||(e[s.column]=[]),e[s.column].push(r)}for(const t of s){const s=Number(t);i.push({column:s,cells:e[s]})}return{data:i,rows:l,columns:h+1}}}return{data:n,rows:l+1,columns:h+1}}GetAll(t=!1){return this.GetRange({row:0,column:0},{row:this.rows_-1,column:this.columns_-1},t)}Normalize2(t,e){return t.column===1/0&&(t=Object.assign(Object.assign({},t),{column:0})),t.row===1/0&&(t=Object.assign(Object.assign({},t),{row:0})),e.column===1/0&&(e=Object.assign(Object.assign({},e),{column:this.columns_-1})),e.row===1/0&&(e=Object.assign(Object.assign({},e),{row:this.rows_-1})),{from:t,to:e}}Normalize1(t){return t.column===1/0&&(t=Object.assign(Object.assign({},t),{column:0})),t.row===1/0&&(t=Object.assign(Object.assign({},t),{row:0})),t}RawValue(t,e=t){if(({from:t,to:e}=this.Normalize2(t,e)),t.row===e.row&&t.column===e.column)return this.data[t.row]&&this.data[t.row][t.column]?this.data[t.row][t.column].value:void 0;const s=[],i=this.data.slice(t.row,e.row+1),r=t.column,o=e.column+1;for(const t of i){const e=[];for(let s=r,i=0;s<o;s++,i++){const i=t[s];e.push(i?i.value:void 0)}s.push(e)}return s}GetRange(t,e,s=!1){if(e?({from:t,to:e}=this.Normalize2(t,e)):t=this.Normalize1(t),!e||t===e||t.column===e.column&&t.row===e.row)return this.data[t.row]&&this.data[t.row][t.column]?this.data[t.row][t.column].GetValue():void 0;const i=[];if(s)for(let s=t.column;s<=e.column;s++){const r=[];for(let i=t.row;i<=e.row;i++)this.data[i]&&this.data[i][s]?r.push(this.data[i][s].GetValue()):r.push(void 0);i.push(r)}else for(let s=t.row;s<=e.row;s++){const r=[];for(let i=t.column;i<=e.column;i++)this.data[s]&&this.data[s][i]?r.push(this.data[s][i].GetValue()):r.push(void 0);i.push(r)}return i}GetRange4(t,e=t,s=!1){if(({from:t,to:e}=this.Normalize2(t,e)),t.row===e.row&&t.column===e.column)return this.data[t.row]&&this.data[t.row][t.column]?this.data[t.row][t.column].GetValue4():{value:void 0,type:o.undefined};const i=[];if(s)for(let s=t.column;s<=e.column;s++){const r=[];for(let i=t.row;i<=e.row;i++)this.data[i]&&this.data[i][s]?r.push(this.data[i][s].GetValue4()):r.push(d());i.push(r)}else for(let s=t.row;s<=e.row;s++){const r=[];for(let i=t.column;i<=e.column;i++)this.data[s]&&this.data[s][i]?r.push(this.data[s][i].GetValue4()):r.push(d());i.push(r)}return i}Apply(t,e,s=!1){if(i(t)&&(t=new r(t)),t.entire_column||t.entire_row)throw new Error("don't iterate infinite cells");const o=t.start,a=t.end;if(s)for(let t=o.row;t<=a.row;t++){this.data[t]||(this.data[t]=[]);const s=this.data[t];for(let i=o.column;i<=a.column;i++)s[i]||(s[i]=new l),e(s[i],i,t)}else for(let t=o.row;t<=a.row;t++)if(this.data[t]){const s=this.data[t];for(let i=o.column;i<=a.column;i++)s[i]&&e(s[i],i,t)}}SetArea(t,e){if(ArrayBuffer.isView(e))throw new Error("ABIV");if(Array.isArray(e))for(let s=t.start.row,i=0;s<=t.end.row;s++,i++){this.data[s]||(this.data[s]=[]);const r=this.data[s];if(e[i])for(let s=t.start.column,o=0;s<=t.end.column;s++,o++)r[s]||(r[s]=new l),r[s].Set(e[i][o])}else{const s=a(e);for(let i=t.start.row;i<=t.end.row;i++){this.data[i]||(this.data[i]=[]);const r=this.data[i];for(let i=t.start.column;i<=t.end.column;i++)r[i]||(r[i]=new l),r[i].Set(e,s)}}this.rows_=Math.max(this.rows_,t.end.row+1),this.columns_=Math.max(this.columns_,t.end.column+1)}IterateAll(t){for(const e of this.data)if(e)for(const s of e)s&&t(s)}FlushCellStyles(){for(const t of this.data)if(t)for(const e of t)e&&e.FlushStyle()}FlushCachedValues(){for(const t of this.data)if(t)for(const e of t)e&&e.FlushCache()}}class g{static UpdateLocale(t){var e;if(t)this.locale=t;else if("undefined"!=typeof self){const t=null===(e=null===self||void 0===self?void 0:self.document)||void 0===e?void 0:e.location;if(t&&t.search&&/locale=([^?&]+?)(?:\?|$|&)/.test(t.search)){const e=t.search.match(/locale=(.*?)(?:\?|$|&)/);e&&(this.locale=e[1]),console.info("override locale",this.locale)}else"undefined"!=typeof navigator&&(navigator.languages&&navigator.languages[0]?this.locale=navigator.languages[0]:this.locale=navigator.language)}const s=new Intl.NumberFormat(this.locale,{minimumFractionDigits:1}).format(3.3).replace(/\d/g,"");this.decimal_separator=","===s?",":".",","===this.decimal_separator&&(this.argument_separator=";",this.grouping_separator=" ");let i=new Date(2e3,0,2,12,0,0,0);this.UpdateDateComponent(0,0,i),i=new Date(2e3,1,7,12,0,0,0),this.UpdateDateComponent(1,1,i),i=new Date(2e3,2,7,12,0,0,0),this.UpdateDateComponent(2,2,i),i=new Date(2e3,3,5,12,0,0,0),this.UpdateDateComponent(3,3,i),i=new Date(2e3,4,4,12,0,0,0),this.UpdateDateComponent(4,4,i),i=new Date(2e3,5,2,12,0,0,0),this.UpdateDateComponent(5,5,i),i=new Date(2e3,6,1,12,0,0,0),this.UpdateDateComponent(6,6,i),i=new Date(2e3,7,1,12,0,0,0),this.UpdateDateComponent(7,-1,i),i=new Date(2e3,8,1,12,0,0,0),this.UpdateDateComponent(8,-1,i),i=new Date(2e3,9,1,12,0,0,0),this.UpdateDateComponent(9,-1,i),i=new Date(2e3,10,1,12,0,0,0),this.UpdateDateComponent(10,-1,i),i=new Date(2e3,11,1,12,0,0,0),this.UpdateDateComponent(11,-1,i)}static UpdateDateComponent(t,e,s){e>=0&&(this.date_components.short_days[e]=s.toLocaleString(this.locale,{weekday:"short"}),this.date_components.long_days[e]=s.toLocaleString(this.locale,{weekday:"long"})),t>=0&&(this.date_components.short_months[t]=s.toLocaleString(this.locale,{month:"short"}),this.date_components.long_months[t]=s.toLocaleString(this.locale,{month:"long"}))}}g.locale="en-us",g.decimal_separator=".",g.argument_separator=",",g.grouping_separator=",",g.date_components={short_days:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],long_days:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],short_months:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],long_months:["January","February","March","April","May","June","July","August","September","October","November","December"]},g.UpdateLocale();class y{constructor(t=0,e=0,s=0,i=0){this.left=t,this.top=e,this.width=s,this.height=i}get right(){return this.left+this.width}get bottom(){return this.top+this.height}static Create(t){return new y(t.left||0,t.top||0,t.width||0,t.height||0)}static IsRectangle(t){var e,s,i,r;return"object"==typeof t&&"number"==typeof(null===(e=t)||void 0===e?void 0:e.left)&&"number"==typeof(null===(s=t)||void 0===s?void 0:s.top)&&"number"==typeof(null===(i=t)||void 0===i?void 0:i.width)&&"number"==typeof(null===(r=t)||void 0===r?void 0:r.height)}Shift(t=0,e=0){return new y(this.left+t,this.top+e,this.width,this.height)}Scale(t=1,e=t){return new y(this.left*t,this.top*e,this.width*t,this.height*e)}Expand(t=0,e=0){return new y(this.left,this.top,this.width+t,this.height+e)}Combine(t){return new y(Math.min(this.left,t.left),Math.min(this.top,t.top),Math.max(this.right,t.right)-Math.min(this.left,t.left),Math.max(this.bottom,t.bottom)-Math.min(this.top,t.top))}CheckEdges(t,e,s=16){let i=0;return t-this.left<s&&(i|=1),this.right-t<s&&(i|=2),e-this.top<s&&(i|=4),this.bottom-e<s&&(i|=8),i}Contains(t,e,s=0){return t>=this.left-s&&t<=this.left+this.width+s&&e>=this.top-s&&e<=this.top+this.height+s}ContextFill(t){t.fillRect(this.left,this.top,this.width,this.height)}ContextStroke(t){t.strokeRect(this.left,this.top,this.width,this.height)}Clamp(t,e){return{x:t=Math.min(Math.max(t,this.left),this.right),y:e=Math.min(Math.max(e,this.top),this.bottom)}}ApplyStyle(t){t.style.top=this.top+"px",t.style.left=this.left+"px",t.style.width=this.width+"px",t.style.height=this.height+"px"}toJSON(){return{top:this.top,left:this.left,width:this.width,height:this.height}}}var v,b;!function(t){const e=JSON.stringify({});let s,i;!function(t){t[t.None=0]="None",t[t.Left=1]="Left",t[t.Center=2]="Center",t[t.Right=3]="Right"}(s=t.HorizontalAlign||(t.HorizontalAlign={})),function(t){t[t.None=0]="None",t[t.Top=1]="Top",t[t.Bottom=2]="Bottom",t[t.Middle=3]="Middle"}(i=t.VerticalAlign||(t.VerticalAlign={})),t.DefaultProperties={horizontal_align:s.None,vertical_align:i.None,number_format:"General",nan:"NaN",font_size_value:10,font_size_unit:"pt",font_face:"calibri",font_bold:!1,font_italic:!1,font_underline:!1,font_strike:!1,text:{theme:1},border_top:0,border_left:0,border_right:0,border_bottom:0},t.Merge=(t,e,s=!0)=>{const i=s?Object.assign(Object.assign({},t),e):Object.assign({},e);return JSON.parse(JSON.stringify(i))},t.Composite=t=>JSON.parse(JSON.stringify(t.reduce(((t,e)=>Object.assign(Object.assign({},t),e)),{}))),t.Empty=t=>JSON.stringify(t)===e,t.ValidColor=t=>!(!t||t.none||!t.text&&!t.theme&&0!==t.theme),t.Font=(t,e=1)=>{const s=[];return t.font_weight?s.push(t.font_weight.toString()):t.font_bold&&s.push("bold"),t.font_italic&&s.push("italic"),s.push(((t.font_size_value||0)*e).toFixed(2)+(t.font_size_unit||"pt")),s.push(t.font_face||""),s.join(" ")}}(v||(v={})),function(t){t[t.default=0]="default",t[t.hidden=1]="hidden",t[t.padded=2]="padded",t[t.date_component=3]="date_component",t[t.date_component_minutes=4]="date_component_minutes",t[t.literal=5]="literal",t[t.formatting=6]="formatting"}(b||(b={}));const w={grid_color:"red",note_marker_color:"#d2c500"},C=(t,e)=>x(t,e,0),x=(t,e,s)=>(null==e?void 0:e.text)?"none"===e.text?"":e.text:(null==e?void 0:e.theme)||0===(null==e?void 0:e.theme)?e.tint?((t,e,s)=>{t.tint_cache||(t.tint_cache=[]),t.tint_cache[e]||(t.tint_cache[e]={});let i=t.tint_cache[e][s];if(!i){const r=t.theme_colors_rgb?t.theme_colors_rgb[e]:[0,0,0];let o;o=s>0?A.Lighten(r[0],r[1],r[2],100*s,!0):A.Darken(r[0],r[1],r[2],100*-s,!0),i=`rgb(${o.r},${o.g},${o.b})`,t.tint_cache[e][s]=i}return i})(t,e.theme,e.tint):t.theme_colors?t.theme_colors[e.theme]:"":(s||0===s)&&t.theme_colors?t.theme_colors[s]:"",S=t=>{const{value:e,unit:s}=(t=>{let e=10,s="pt";const i=t.match(/^([\d.]+)(\D.*)$/);return i&&(e=Number(i[1]),s=i[2]),{value:e,unit:s}})(t.fontSize||""),i={fill:{text:t.backgroundColor},text:{text:t.color},font_size_unit:s,font_size_value:e,font_face:t.fontFamily};/italic/i.test(t.font)&&(i.font_italic=!0);const r=Number(t.fontWeight);return!isNaN(r)&&r&&(i.font_weight=r),i},A=new class{Darken(t,e,s,i,r=!1){let{h:o,s:a,l:n}=this.RGBToHSL(t,e,s);return n-=r?n*i/100:i/100,n=Math.max(0,Math.min(1,n)),this.HSLToRGB(o,a,n)}Lighten(t,e,s,i,r=!1){let{h:o,s:a,l:n}=this.RGBToHSL(t,e,s);return n+=r?n*i/100:i/100,n=Math.max(0,Math.min(1,n)),this.HSLToRGB(o,a,n)}RGBToHSL(t,e,s){t/=255,e/=255,s/=255;const i=Math.max(t,e,s),r=Math.min(t,e,s);let o=0,a=0;const n=(i+r)/2;if(i===r)o=a=0;else{const l=i-r;switch(a=n>.5?l/(2-i-r):l/(i+r),i){case t:o=(e-s)/l+(e<s?6:0);break;case e:o=(s-t)/l+2;break;case s:o=(t-e)/l+4}o/=6}return{h:360*o,s:a,l:n}}HSLToRGB(t,e,s){let i,r,o;if(0===e)i=r=o=s;else{t/=360;const a=s<.5?s*(1+e):s+e-s*e,n=2*s-a;i=this.HueToRGB(n,a,t+1/3),r=this.HueToRGB(n,a,t),o=this.HueToRGB(n,a,t-1/3)}return{r:Math.round(255*i),g:Math.round(255*r),b:Math.round(255*o)}}HueToRGB(t,e,s){return s<0&&(s+=1),s>1&&(s-=1),s<1/6?t+6*(e-t)*s:s<.5?e:s<2/3?t+(e-t)*(2/3-s)*6:t}};var M,k;!function(t){t.Comma=",",t.Semicolon=";"}(M||(M={})),function(t){t.Period=".",t.Comma=","}(k||(k={}));const R=/[\s-+=<>!()]/,L=/['*\\]/,E=48,T={"==":6,"!=":6,"<>":6,"=":6,"<":7,">":7,"<=":7,">=":7,"+":9,"-":9,"&":9,"*":10,"/":10,"^":11,":":13},D=Object.keys(T).sort(((t,e)=>e.length-t.length)),z={"-":100,"+":100};class N{constructor(){this.argument_separator=M.Comma,this.decimal_mark=k.Period,this.argument_separator_char=44,this.decimal_mark_char=46,this.id_counter=0,this.expression="",this.data=[],this.index=0,this.length=0,this.valid=!0,this.dependencies={addresses:{},ranges:{}},this.address_refcount={},this.full_reference_list=[]}Walk(t,e){switch(t.type){case"address":case"missing":case"literal":case"identifier":case"operator":return void e(t);case"range":return void(e(t)&&(this.Walk(t.start,e),this.Walk(t.end,e)));case"binary":return void(e(t)&&(this.Walk(t.left,e),this.Walk(t.right,e)));case"unary":return void(e(t)&&this.Walk(t.operand,e));case"group":return void(e(t)&&t.elements.forEach((t=>this.Walk(t,e))));case"call":e(t)&&t.args.forEach((t=>this.Walk(t,e)))}}Transpose(t){const e=t.length,s=[];let i=0;for(let s=0;s<e;s++)Array.isArray(t[s])&&(i=Math.max(i,t[s].length));for(let r=0;r<i;r++){s[r]=[];for(let i=0;i<e;i++)s[r][i]=t[i][r]}return s}Render(t,e={rows:0,columns:0},s="(missing)",i,r){let o=this.argument_separator+" ";r===M.Comma?o=", ":r===M.Semicolon&&(o="; ");const a=i===k.Comma?",":".",n=this.decimal_mark===k.Comma?/,/:/\./;switch(t.type){case"address":return this.AddressLabel(t,e);case"range":return this.AddressLabel(t.start,e)+":"+this.AddressLabel(t.end,e);case"missing":return s;case"array":return"{"+this.Transpose(t.values).map((t=>t.map((t=>"string"==typeof t?'"'+t+'"':t)).join(", "))).join("; ")+"}";case"binary":return this.Render(t.left,e,s,i,r)+" "+t.operator+" "+this.Render(t.right,e,s,i,r);case"unary":return t.operator+this.Render(t.operand,e,s,i,r);case"literal":if("string"==typeof t.value)return'"'+t.value.replace(/"/g,'""')+'"';if(i&&"number"==typeof t.value){if(t.text){let e=t.text;return i===k.Comma&&this.decimal_mark===k.Period&&(e=e.replace(/,/g,"")),e.replace(n,a)}return t.value.toString().replace(/\./,a)}return t.text?t.text:t.value.toString();case"identifier":return t.name;case"operator":return"["+t.operator+"]";case"group":return t.explicit?"("+t.elements.map((t=>this.Render(t,e,s,i,r))).join(o)+")":t.elements.map((t=>this.Render(t,e,s,i,r))).join(o);case"call":return t.name+"("+t.args.map((t=>this.Render(t,e,s,i,r))).join(o)+")"}return"??"}Parse(t){switch("="===(t=t.trim())[0]&&(t=t.substr(1).trim()),this.expression=t,this.data=[],this.length=t.length,this.index=0,this.valid=!0,this.error_position=void 0,this.error=void 0,this.dependencies.addresses={},this.dependencies.ranges={},this.address_refcount={},this.full_reference_list=[],this.id_counter=0,this.argument_separator){case M.Semicolon:this.argument_separator_char=59;break;default:this.argument_separator_char=44}switch(this.decimal_mark){case k.Comma:this.decimal_mark_char=44;break;default:this.decimal_mark_char=46}for(let e=0;e<this.length;e++)this.data[e]=t.charCodeAt(e);const e=this.ParseGeneric(),s={};for(const t of Object.keys(this.dependencies.addresses))this.address_refcount[t]&&(s[t]=this.dependencies.addresses[t]);return this.dependencies.addresses=s,{expression:e||void 0,valid:this.valid,error:this.error,error_position:this.error_position,dependencies:this.dependencies,separator:this.argument_separator,decimal_mark:this.decimal_mark,full_reference_list:this.full_reference_list.slice(0)}}ColumnLabel(t){if(t===1/0)return"";let e=String.fromCharCode(65+t%26);for(;t>25;)t=Math.floor(t/26)-1,e=String.fromCharCode(65+t%26)+e;return e}AddressLabel(t,e){let s=t.column;t.absolute_column||t.column===1/0||(s+=e.columns);let i=t.row;if(t.absolute_row||t.row===1/0||(i+=e.rows),i<0||s<0||i===1/0&&s===1/0)return"#REF";let r="";return t.sheet&&(r=(R.test(t.sheet)?"'"+t.sheet+"'":t.sheet)+"!"),i===1/0?r+(t.absolute_column?"$":"")+this.ColumnLabel(s):s===1/0?r+(t.absolute_row?"$":"")+(i+1):r+(t.absolute_column?"$":"")+this.ColumnLabel(s)+(t.absolute_row?"$":"")+(i+1)}ParseGeneric(t=[0]){const e=[];for(;this.index<this.length;){const s=this.ParseNext(0===e.length);if("number"==typeof s){if(t.some((t=>s===t)))break;if(40===s){this.index++;const t=this.ParseGeneric([41]);this.index++,t&&e.push({type:"group",id:this.id_counter++,elements:[t],explicit:!0})}else{const t=this.ConsumeOperator();t?e.push(t):(this.error=`unexpected character [1]: ${String.fromCharCode(s)}, ${s}`,this.valid=!1,this.index++)}}else e.push(s)}return 0===e.length?null:1===e.length?e[0]:this.BinaryToRange(this.ArrangeUnits(e))}UnitToAddress(t){if("literal"===t.type){if("number"==typeof t.value&&t.value>0&&!/\./.test(t.text||""))return{type:"address",position:t.position,label:t.value.toString(),row:t.value-1,id:this.id_counter++,column:1/0}}else{let e,s=t.name;const i=s.split("!");if(i.length>1&&(e=i.slice(0,i.length-1).join("!"),s=s.substr(e.length+1),"'"===e[0])){if(!(e.length>1&&"'"===e[e.length-1]))return;e=e.substr(1,e.length-2)}const r="$"===s[0];s=(r?s.substr(1):s).toUpperCase();const o=Number(s);if(isNaN(o)){if(/[A-Z]{1,3}/.test(s)){let i=-1;for(let t=0;t<s.length;t++)i=26*(1+i)+(s[t].charCodeAt(0)-65);return{type:"address",position:t.position,absolute_column:r,label:t.name,column:i,id:this.id_counter++,row:1/0,sheet:e}}}else if(o>0&&o!==1/0&&!/\./.test(s))return{type:"address",position:t.position,absolute_row:r,label:t.name,row:o-1,id:this.id_counter++,column:1/0,sheet:e}}}BinaryToRange(t){if("binary"===t.type){if(":"===t.operator){let e,s="";if("address"===t.left.type&&"address"===t.right.type){const i=t.left.position+t.left.label.length,r=t.right.position;e={type:"range",id:this.id_counter++,position:t.left.position,start:t.left,end:t.right,label:t.left.label+this.expression.substring(i,r)+t.right.label},s=e.start.label+":"+e.end.label,this.address_refcount[e.start.label]--,this.address_refcount[e.end.label]--;const o=[t.left.position,t.right.position];this.full_reference_list=this.full_reference_list.filter((t=>t.position!==o[0]&&t.position!==o[1]))}else if(!("literal"!==t.left.type&&"identifier"!==t.left.type||"literal"!==t.right.type&&"identifier"!==t.right.type)){const i=this.UnitToAddress(t.left),r=this.UnitToAddress(t.right);i&&r&&(i.column===1/0&&r.column===1/0||i.row===1/0&&r.row===1/0)&&(s=i.label+":"+r.label,e={type:"range",id:this.id_counter++,position:t.left.position,start:i,end:r,label:s})}if(e)return this.dependencies.ranges[s]=e,this.full_reference_list.push(e),e;this.error="unexpected character: :",this.valid=!1}t.left=this.BinaryToRange(t.left),t.right=this.BinaryToRange(t.right)}return t}ArrangeUnits(t){if(0===t.length)return{type:"missing",id:this.id_counter++};if(1===t.length)return t[0];const e=[];for(let s=0;s<t.length;s++){let i=t[s];if("operator"===i.type){if(0!==e.length&&"operator"!==e[e.length-1].type){e.push(i);continue}if(!z[i.operator])return this.error=`unexpected character [2]: ${i.operator}`,this.error_position=i.position,this.valid=!1,{type:"group",id:this.id_counter++,elements:t,explicit:!1};{const e=this.BinaryToRange(this.ArrangeUnits(t.slice(s+1)));if(!this.valid)return{type:"group",id:this.id_counter++,elements:t,explicit:!1};"binary"===e.type?(e.left={type:"unary",id:this.id_counter++,operator:i.operator,operand:e.left,position:i.position},i=e):i={type:"unary",id:this.id_counter++,operator:i.operator,operand:e,position:i.position},s=t.length}}if(e.length<2)e.push(i);else{if("operator"!==e[e.length-1].type)return this.error="multiple expressions",this.error_position=i.position,this.valid=!1,{type:"group",id:this.id_counter++,elements:t,explicit:!1};{const t=e[e.length-2],s=e[e.length-1],r=s.operator,o={type:"binary",id:this.id_counter++,left:t,operator:r,position:s.position,right:i};"binary"===t.type&&T[r]>T[t.operator]&&(o.left=t.left,o.operator=t.operator,o.position=t.position,o.right={type:"binary",id:this.id_counter++,left:t.right,right:i,operator:r,position:s.position}),e.splice(-2,2,o)}}}return e[0]}ParseNext(t=!0){this.ConsumeWhiteSpace();const e=this.data[this.index];if(34===e)return{type:"literal",id:this.id_counter++,position:this.index,value:this.ConsumeString()};if(e>=E&&e<=57||e===this.decimal_mark_char){const t=this.index,[e,s]=this.ConsumeNumber();return{type:"literal",id:this.id_counter++,position:t,value:e,text:s}}if(123===e)return this.ConsumeArray();if(!t||45!==e&&43!==e){if(e>=65&&e<=90||e>=97&&e<=122||95===e||39===e||36===e||e>=192&&e<=312)return this.ConsumeToken(e)}else{const t=this.data[this.index+1];if(t>=E&&t<=57||t===this.decimal_mark_char){const t=this.index,[e,s]=this.ConsumeNumber();return{type:"literal",id:this.id_counter++,position:t,value:e,text:s}}}return e}ConsumeArray(){const t={type:"array",id:this.id_counter++,values:[],position:this.index};this.index++;let e=0,s=0;for(;this.index<this.length;){const i=this.ParseNext(),r=this.index;if("number"==typeof i)switch(this.index++,i){case 59:s++,e=0;break;case 44:e++;break;case 125:return t;default:this.valid&&(this.error="invalid character in array literal",this.error_position=r,this.valid=!1)}else switch(i.type){case"literal":t.values[e]||(t.values[e]=[]),t.values[e][s]=i.value;break;default:this.valid&&(this.error="invalid value in array literal",this.error_position=r,this.valid=!1)}}return t}ConsumeOperator(){for(const t of D)if(this.expression.substr(this.index,t.length)===t){const e=this.index;return this.index+=t.length,{type:"operator",id:this.id_counter++,operator:t,position:e}}return null}ConsumeArguments(){this.index++;let t=0;const e=[];for(;this.index<this.length;){const s=this.ParseGeneric([this.argument_separator_char,41]);null!==s&&e.push(s);const i=this.data[this.index];if(i===this.argument_separator_char){this.index++,t++;for(let s=e.length;s<t;s++)e.push({type:"missing",id:this.id_counter++})}else if(41===i)return this.index++,e}return e}ConsumeToken(t){const e=[t],s=this.index;let i=39===t;for(++this.index;this.index<this.length;this.index++){const t=this.data[this.index];if(!(t>=65&&t<=90||t>=97&&t<=122||t>=192&&t<=312||95===t||36===t||46===t||33===t||i||t>=E&&t<=57))break;e.push(t),39===t&&(i=!1)}const r=e.map((t=>String.fromCharCode(t))).join("");if(i)return this.error="unbalanced single quote",this.error_position=s,this.valid=!1,{type:"identifier",id:this.id_counter++,name:r,position:s};if("true"===r.toLowerCase())return{type:"literal",id:this.id_counter++,value:!0,position:s};if("false"===r.toLowerCase())return{type:"literal",id:this.id_counter++,value:!1,position:s};if(this.ConsumeWhiteSpace(),40===this.data[this.index]){const t=this.ConsumeArguments();return{type:"call",id:this.id_counter++,name:r,args:t,position:s}}const o=this.ConsumeAddress(r,s);if(o)return o;const a={type:"identifier",id:this.id_counter++,name:r,position:s};return this.full_reference_list.push(a),a}ConsumeAddress(t,e){const s=e,i=t.length;let r;const o=t.split("!");o.length>1&&(r=o.slice(0,o.length-1).join("!"),e+=r.length+1);const a=this.ConsumeAddressColumn(e);if(!a)return null;e=a.position;const n=this.ConsumeAddressRow(e);if(!n)return null;e=n.position;const l=r?r+t.substr(r.length,e-s).toUpperCase():t.substr(0,e-s).toUpperCase();r&&"'"===r[0]&&(r=r.substr(1,r.length-2));const h={type:"address",id:this.id_counter++,label:l,row:n.row,column:a.column,absolute_row:n.absolute,absolute_column:a.absolute,position:s,sheet:r};return i!==e-s?null:(this.dependencies.addresses[h.label]=h,this.address_refcount[h.label]=(this.address_refcount[h.label]||0)+1,this.full_reference_list.push(h),h)}ConsumeAddressRow(t){const e=36===this.data[t];e&&t++;const s=t;let i=0;for(;;t++){const e=this.data[t];if(!(e>=E&&e<=57))break;i*=10,i+=e-E}return s!==t&&{absolute:e,row:i-1,position:t}}ConsumeAddressColumn(t){let e=-1,s=0;const i=36===this.data[t];for(i&&t++;;t++,s++){if(s>=4)return!1;const i=this.data[t];if(i>=65&&i<=90)e=26*(1+e)+(i-65);else{if(!(i>=97&&i<=122))break;e=26*(1+e)+(i-97)}}return!(e<0)&&{absolute:i,column:e,position:t}}ConsumeNumber(){let t=0,e=!1,s=!1,i=0,r=0,o=0,a="integer",n=0;const l=this.index;for(;this.index<this.length;this.index++,n++){const l=this.data[this.index];if(l===this.decimal_mark_char){if("integer"!==a)break;a="fraction"}else{if(37===l){i/=100,o/=100,this.index++;break}if(43===l||45===l){if(0!==n)break;45===l&&(s=!0)}else if(69===l||101===l){if("integer"!==a&&"fraction"!==a)break;a="exponent",this.index<this.length-1&&(43===this.data[this.index+1]?this.index++:45===this.data[this.index+1]&&(this.index++,e=!0))}else{if(!(l>=E&&l<=57))break;switch(a){case"integer":i=10*i+(l-E);break;case"fraction":o=10*o+(l-E),r++;break;case"exponent":t=10*t+(l-E)}}}}let h=i+o*Math.pow(10,-r);return"exponent"===a&&(h*=Math.pow(10,(e?-1:1)*t)),[s?-h:h,this.expression.substring(l,this.index)||""]}ConsumeString(){this.index++;const t=[];for(;this.index<this.length;this.index++){const e=this.data[this.index];if(34===e&&(this.index++,this.index>=this.length||34!==this.data[this.index]))break;t.push(e)}return t.map((t=>String.fromCharCode(t))).join("")}ConsumeWhiteSpace(){for(;this.index<this.length;){const t=this.data[this.index];if(32!==t&&9!==t&&10!==t&&13!==t&&160!==t)return;this.index++}}}var P;function F(t){return t?Promise.resolve().then(t):Promise.resolve()}!function(t){t[t.default=0]="default",t[t.quoted=1]="quoted"}(P||(P={}));let I,U=1e3;class O{constructor(t=!1,e="undefined"){this.verbose=t,this.log_id=e,this.queue=[],this.dispatched=!1,this.subscribers=[],this.pass_through=[]}Publish(t){this.verbose&&console.info(`es publish (${this.log_id})`,t),this.pass_through.forEach((e=>e.Publish(t))),Array.isArray(t)?this.queue.push(...t):this.queue.push(t),this.dispatched||(this.dispatched=!0,F().then((()=>{const t=this.queue.slice(0);this.dispatched=!1,this.queue=[];for(const e of t)for(const t of this.subscribers)t.subscriber(e)})))}Subscribe(t){const e=U++;return this.subscribers.push({subscriber:t,token:e}),e}Cancel(t){this.subscribers=this.subscribers.filter((e=>e.token!==t))}CancelAll(){this.subscribers=[],this.pass_through=[]}PassThrough(t){this.pass_through.push(t)}}class ${constructor(t,e,s,i=t){$.Create({container:t,node:e,resize_callback:s,layout_reference:i})}static Create(t){const e=document.createElement("div");if(e.classList.add("treb-embed-resize-handle"),(t.layout_reference||t.container).appendChild(e),!$.resize_mask){let t=document.querySelector(".treb-embed-mouse-mask");t||(t=document.createElement("div"),t.classList.add("treb-embed-mouse-mask"),document.body.appendChild(t)),$.resize_mask=t}if(!$.resize_rect){let t=document.querySelector(".treb-embed-resize-rect");t||(t=document.createElement("div"),t.classList.add("treb-embed-resize-rect"),$.resize_mask.appendChild(t)),$.resize_rect=t}let s,i,r={width:0,height:0},o={x:0,y:0},a={x:0,y:0};const n=()=>{if($.resize_mask.removeEventListener("mousemove",i),$.resize_mask.removeEventListener("mouseup",s),$.resize_mask.style.display="none",a.x||a.y){const e=t.container.getBoundingClientRect(),s=e.width+a.x,i=e.height+a.y;t.container.style.width=`${s}px`,t.container.style.height=`${i}px`,t.resize_callback&&t.resize_callback()}};i=t=>{t.buttons?(a.x!==t.clientX-o.x&&(a.x=t.clientX-o.x,$.resize_rect.style.width=`${r.width+a.x+4}px`),a.y!==t.clientY-o.y&&(a.y=t.clientY-o.y,$.resize_rect.style.height=`${r.height+a.y+4}px`)):n()},s=()=>{n()},e.addEventListener("mousedown",(e=>{e.stopPropagation(),e.preventDefault();const n=t.node.getBoundingClientRect();r={width:n.width,height:n.height},$.resize_rect&&($.resize_rect.style.top=n.top-2+"px",$.resize_rect.style.left=n.left-2+"px",$.resize_rect.style.width=`${n.width+4}px`,$.resize_rect.style.height=`${n.height+4}px`),o={x:e.clientX,y:e.clientY},a={x:0,y:0},$.resize_mask.style.display="block",$.resize_mask.addEventListener("mousemove",i),$.resize_mask.addEventListener("mouseup",s)}))}}class H{static MeasureColorARGB(t){const e=this.MeasureColor(t);let s="FF";for(let t=0;t<3;t++){const i=e[t].toString(16);0===i.length?s+="00":1===i.length?s+=`0${i}`:s+=i}return s.toUpperCase()}static MeasureColor(t){let e=this.color_cache[t];if(e)return e;this.color_measurement_canvas||(this.color_measurement_canvas=document.createElement("canvas"),this.color_measurement_canvas.width=1,this.color_measurement_canvas.height=1);const s=this.color_measurement_canvas.getContext("2d");return s?(s.fillStyle="#fff",s.fillRect(0,0,1,1),s.fillStyle=t,s.fillRect(0,0,1,1),e=s.getImageData(0,0,1,1).data,this.color_cache[t]=e,e):new Uint8ClampedArray(3)}static EnsureMeasurementNode(){if(!this.text_measurement_node){const t=document.querySelector(".treb-chart-measurement-node");t?this.text_measurement_node=t:(this.text_measurement_node=document.createElement("div"),this.text_measurement_node.classList.add("treb-chart-measurement-node"),this.text_measurement_node.style.margin="0px",this.text_measurement_node.style.padding="0px",this.text_measurement_node.style.whiteSpace="nowrap",this.text_measurement_node.style.position="fixed",this.text_measurement_node.style.border="0px",this.text_measurement_node.style.border="1px solid red",this.text_measurement_node.style.boxSizing="content-box",this.text_measurement_node.style.top=this.text_measurement_node.style.left="-1000px",document.body.appendChild(this.text_measurement_node))}}static FontLoaded(t,e=!1,s=400){const i=`${e?"italic":""} ${s} 20pt ${t}`,r=this.MeasureText(`${i}, sans-serif`,"check font"),o=this.MeasureText(`${i}, serif`,"check font"),a=this.MeasureText(`${i}, monospace`,"check font");return r.width===o.width&&o.width===a.width}static MeasureText(t,e,s=0){this.EnsureMeasurementNode(),this.text_measurement_node.style.font=t,/\n/.test(e)?(e=e.replace(/\n/g,"<BR/>"),this.text_measurement_node.innerHTML=e):this.text_measurement_node.textContent=e,this.text_measurement_node.style.lineHeight="1em",this.text_measurement_node.style.transform=s?`rotate(${s}deg)`:"";const i=this.text_measurement_node.getBoundingClientRect();return{width:i.width,height:i.height}}}H.color_cache={};const V=(t,e)=>{const s=t.cloneNode(!1),i=getComputedStyle(t),r=((t,e,s)=>{const i={};return Array.prototype.forEach.call(e,(t=>{e[t]!==s[t]&&(i[t]=e[t])})),(Object.keys(i).map((t=>`${t}: ${i[t]}`)).join("; ")+"; "+(t.getAttribute("style")||"")).trim().replace(/"/g,"'")})(t,i,e);return s.removeAttribute("class"),s.setAttribute("style",r),Array.prototype.forEach.call(t.childNodes,(e=>{switch(e.nodeType){case Node.ELEMENT_NODE:s.appendChild(V(e,i));break;case Node.TEXT_NODE:t.textContent&&s.appendChild(document.createTextNode(t.textContent));break;case Node.COMMENT_NODE:break;default:console.warn("unhandled node type in serialize",e)}})),s},j=(t,e,s=6.5,i=!1)=>{if(e===t)e++,t&&t--;else{const s=Math.round(1e5*e)/1e5;Math.abs(s-e)/(e-t)<1e-5&&(e=s)}const r=e-t,o=Math.log(r)/Math.log(10),a=Math.floor(Math.abs(o))*(o<0?-1:1)-1,n=[.1,.25,.5,1,2.5,5,10,25,50,100];let l=-1,h=0;for(const r of n){const o=r*Math.pow(10,a),n=Math.floor(t/o)*o,c=(Math.ceil(e/o)*o-n)/o,d=Math.abs(c-s);(l<0||d<h)&&(!i||c<=s)&&(h=d,l=o)}return t=Math.floor(t/l)*l,e=Math.ceil(e/l)*l,{scale:a,step:l,count:s=Math.round((e-t)/l),min:t,max:e}},G=(t,e,s)=>{[].forEach.call(t.children,(t=>{t.id&&(s[t.id]=t,t.id=`${e}-${t.id}`),t.children&&t.children.length&&G(t,e,s)}))},B=(t,...e)=>{const s=[];for(let i=0;i<t.length;i++)s.push(t[i]),e[i]&&s.push(e[i].toString());return s.join("")},Z=(t,...e)=>((t,e)=>{const s=Math.random().toString(36).substring(2,15),i=document.createElement("div");i.innerHTML=t;const r={};if(G(i,s,r),"string"==typeof e&&(e=document.querySelector(e)),e){const t=[].map.call(i.childNodes,(t=>t));for(const s of t)e.appendChild(s)}return r})(B(t,...e));class J{constructor(){this.date_format=!1,this.string_format=!1,this.fraction_format=!1,this.twelve_hour=!1,this.fraction_denominator=0,this.fraction_integer=!0,this.fraction_align=0,this.fraction_denominator_digits=0,this.integer_min_digits=0,this.decimal_min_digits=0,this.decimal_max_digits=0,this.grouping=!1,this.has_number_format=!1,this.prefix=[{text:""}],this.suffix=[{text:""}],this.scaling=0,this.percent=!1,this.exponential=!1,this.has_asterisk=!1}}var q;!function(t){t[t.Integer=0]="Integer",t[t.Decimal=1]="Decimal"}(q||(q={}));class W{static Parse(t){if(this.pattern=t,this.characters=t.split("").map((t=>t.charCodeAt(0))),this.char_index=0,this.current_section=new J,this.sections=[this.current_section],this.ParseDatePattern())return this.sections;for(this.char_index=0,this.current_section=new J,this.sections=[this.current_section];this.char_index<this.characters.length;)this.ConsumeChar();return this.sections}static ConsumeString(){let t="";for(this.preserve_formatting_characters&&(t+=this.pattern[this.char_index]),++this.char_index;this.char_index<this.characters.length;this.char_index++)switch(this.characters[this.char_index]){case 92:this.preserve_formatting_characters&&(t+=this.pattern[this.char_index]),this.char_index+1<this.characters.length&&(t+=this.pattern[++this.char_index]);break;case 34:return this.preserve_formatting_characters&&(t+=this.pattern[this.char_index]),this.char_index++,t;default:t+=this.pattern[this.char_index]}throw new Error("unterminated string")}static ConsumeFormatting(){let t="";for(++this.char_index;this.char_index<this.characters.length;this.char_index++)switch(this.characters[this.char_index]){case 92:throw new Error("invalid escape character in formatting block");case 93:return this.char_index++,t;default:t+=this.pattern[this.char_index]}throw new Error("unterminated format")}static ScanFractionFormat(){const t=this.pattern.substr(this.char_index).match(/^([#?]+ +){0,1}([#?]+)\/([#?0-9]+)(?:$|[^#?0-9])/);if(!t)return!1;const e=(t[1]||"").length+t[2].length+t[3].length+1;this.current_section.fraction_format=!0,this.current_section.fraction_integer=!!t[1];const s=Number(t[3]);return isNaN(s)||(this.current_section.fraction_denominator=s),this.current_section.decimal_max_digits=this.current_section.fraction_denominator_digits=t[3].length,this.char_index+=e,this.current_section.has_number_format=!0,!0}static ConsumeNumberFormat(){let t=q.Integer;for(this.char_index;this.char_index<this.characters.length;this.char_index++)switch(this.characters[this.char_index]){case this.group_separator:{let e=!1;for(let t=this.char_index+1;!e&&t<this.characters.length;t++){const s=this.characters[t];if(s===this.decimal_mark||35===s||48===s)e=!0;else if(44!==s)break}if(e){if(t===q.Decimal)throw new Error("invalid grouping in decimal part");this.current_section.grouping=!0}else this.current_section.scaling=1e3*(this.current_section.scaling||1)}break;case this.decimal_mark:if(t===q.Decimal)throw new Error("too many decimal marks");t=q.Decimal;break;case 35:t===q.Decimal?this.current_section.decimal_max_digits++:this.current_section.integer_min_digits&&this.current_section.integer_min_digits++;break;case 48:t===q.Decimal?(this.current_section.decimal_max_digits++,this.current_section.decimal_min_digits=this.current_section.decimal_max_digits):this.current_section.integer_min_digits++;break;default:return}}static AppendCharAsText(t=!0){this.current_section.has_number_format?this.current_section.suffix[this.current_section.suffix.length-1].text+=this.pattern[this.char_index]:this.current_section.prefix[this.current_section.prefix.length-1].text+=this.pattern[this.char_index],t&&this.char_index++}static AppendString(t){this.current_section.has_number_format?this.current_section.suffix[this.current_section.suffix.length-1].text+=t:this.current_section.prefix[this.current_section.prefix.length-1].text+=t}static AppendTextPart(t){this.current_section.has_number_format?(this.current_section.suffix.push(t),this.current_section.suffix.push({text:""})):(this.current_section.prefix.push(t),this.current_section.prefix.push({text:""}))}static ConsumeChar(){const t=this.characters[this.char_index];if(63!==t&&35!==t||this.current_section.has_number_format||this.current_section.string_format||!this.ScanFractionFormat())switch(t){case 59:this.char_index++,this.current_section=new J,3===this.sections.length&&(this.current_section.string_format=!0),this.sections.push(this.current_section);break;case 64:this.char_index++,this.AppendTextPart({text:"@",flag:b.literal}),this.current_section.string_format=!0;break;case 48:case 35:case 46:case 44:this.current_section.has_number_format||this.current_section.string_format?this.AppendCharAsText():(this.ConsumeNumberFormat(),this.current_section.has_number_format=!0);break;case 91:this.AppendTextPart({text:this.ConsumeFormatting(),flag:b.formatting});break;case 34:this.AppendString(this.ConsumeString());break;case 63:this.preserve_formatting_characters?this.AppendCharAsText():(this.AppendTextPart({text:"0",flag:b.hidden}),this.char_index++);break;case 95:if(this.preserve_formatting_characters)this.AppendCharAsText();else{if(++this.char_index>=this.characters.length)throw new Error("invalid pad character at end");this.AppendTextPart({text:this.pattern[this.char_index++],flag:b.hidden})}break;case 42:if(this.current_section.has_asterisk)throw new Error("we don't support multiple asterisks");if(this.preserve_formatting_characters)this.AppendCharAsText();else{if(++this.char_index>=this.characters.length)throw new Error("invalid pad character at end");this.AppendTextPart({text:this.pattern[this.char_index++],flag:b.padded}),this.current_section.has_asterisk=!0}break;case 101:case 69:this.current_section.percent||this.current_section.exponential||this.current_section.string_format?this.AppendCharAsText():(this.current_section.exponential=!0,this.char_index++);break;case 37:this.current_section.exponential||this.current_section.string_format||(this.current_section.percent=!0),this.AppendCharAsText();break;case 92:if(this.preserve_formatting_characters&&this.AppendCharAsText(!1),++this.char_index>=this.characters.length)throw new Error("invalid escape character at end");this.AppendCharAsText();break;default:this.AppendCharAsText()}}static ParseDatePattern(){for(this.date_pattern=!0;this.date_pattern&&this.char_index<this.pattern.length;)this.DatePatternConsumeChar();if(this.date_pattern){this.date_pattern=!1;for(const t of this.sections)for(const e of t.prefix)e.flag&&e.flag&(b.date_component|b.date_component_minutes)&&(this.date_pattern=!0)}return this.date_pattern&&(this.sections[0].date_format=!0,this.sections[0].prefix.forEach(((t,e)=>{if(t.flag===b.date_component&&("mm"===t.text||"m"===t.text)){if(e)for(let s=e-1;s;s--){const e=this.sections[0].prefix[s];if(e.flag===b.date_component){/h/i.test(e.text)&&(t.flag=b.date_component_minutes,t.text=t.text.toLowerCase());break}}if(e<this.sections[0].prefix.length-1)for(let s=e+1;s<this.sections[0].prefix.length;s++){const e=this.sections[0].prefix[s];if(e.flag===b.date_component){/s/i.test(e.text)&&(t.flag=b.date_component_minutes,t.text=t.text.toLowerCase());break}}}}))),this.date_pattern}static ConsumeDatePart(){const t=this.pattern[this.char_index++],e=t.toLowerCase(),s={text:t,flag:b.date_component};for(;this.pattern[this.char_index]&&this.pattern[this.char_index].toLowerCase()===e;)s.text+=this.pattern[this.char_index++];if("s"===e&&"."===this.pattern[this.char_index])for(s.text+=this.pattern[this.char_index++];"0"===this.pattern[this.char_index];)s.text+=this.pattern[this.char_index++];return s}static ConsumeAMPM(){let t=this.pattern.substr(this.char_index,5);return"am/pm"===t||"AM/PM"===t?(this.char_index+=5,this.sections[0].twelve_hour=!0,{text:t,flag:b.date_component}):(t=this.pattern.substr(this.char_index,3),"a/p"===t||"A/P"===t?(this.char_index+=3,this.sections[0].twelve_hour=!0,{text:t,flag:b.date_component}):void 0)}static DatePatternConsumeChar(){switch(this.characters[this.char_index]){case 59:this.char_index=this.characters.length;break;case 48:case 35:case 101:case 69:case 37:case 64:this.date_pattern=!1;break;case 72:case 104:case 77:case 109:case 83:case 115:case 68:case 100:case 89:case 121:this.AppendTextPart(this.ConsumeDatePart());break;case 65:case 97:{const t=this.ConsumeAMPM();t?this.AppendTextPart(t):this.AppendCharAsText()}break;case 34:this.AppendString(this.ConsumeString());break;case 63:this.preserve_formatting_characters?this.AppendCharAsText():(this.AppendTextPart({text:"0",flag:b.hidden}),this.char_index++);break;case 95:if(this.preserve_formatting_characters)this.AppendCharAsText();else{if(++this.char_index>=this.characters.length)throw new Error("invalid pad character at end");this.AppendTextPart({text:this.pattern[this.char_index++],flag:b.hidden})}break;case 42:if(this.current_section.has_asterisk)throw new Error("we don't support multiple asterisks");if(this.preserve_formatting_characters)this.AppendCharAsText();else{if(++this.char_index>=this.characters.length)throw new Error("invalid pad character at end");this.AppendTextPart({text:this.pattern[this.char_index++],flag:b.padded}),this.current_section.has_asterisk=!0}break;case 92:if(this.preserve_formatting_characters&&this.AppendCharAsText(!1),++this.char_index>=this.characters.length)throw new Error("invalid escape character at end");this.AppendCharAsText();break;default:this.AppendCharAsText()}}}W.date_pattern=!1,W.pattern="",W.char_index=0,W.characters=[],W.sections=[],W.current_section=new J,W.preserve_formatting_characters=!1,W.decimal_mark=46,W.group_separator=44;const K=t=>(t>=60&&t--,new Date(864e5*t-22090752e5)),X=(t,e=!0)=>{if(e){const e=new Date(t),s=new Date;s.setUTCMilliseconds(e.getUTCMilliseconds()),s.setUTCSeconds(e.getUTCSeconds()),s.setUTCMinutes(e.getUTCMinutes()),s.setUTCHours(e.getHours()),s.setUTCDate(e.getDate()),s.setUTCMonth(e.getMonth()),s.setUTCFullYear(e.getFullYear()),t=s.getTime()}return(t=(t+22090752e5)/864e5)>=60&&t++,t};class Y{constructor(t){if(this._pattern="",this.decimal_zero_regexp=[],this.cloned=[],this.magic_decimal=!1,this._pattern=t,this.sections=W.Parse(t),this.sections.length||(this.sections=[]),this.sections[0]||(this.sections[0]=new J),this.sections[1]||(this.sections[1]=Object.assign({},this.sections[0]),this.sections[1].prefix=JSON.parse(JSON.stringify(this.sections[1].prefix)),this.sections[1].suffix=JSON.parse(JSON.stringify(this.sections[1].suffix)),this.sections[1].prefix.push({text:"-"}),this.cloned[1]=!0),this.sections[2]||(this.sections[2]=Object.assign({},this.sections[0]),this.cloned[2]=!0),!this.sections[3])for(const t of this.sections[0].prefix)if(t.flag===b.literal){this.sections[3]=Object.assign({},this.sections[0]),this.sections[3].string_format=!0,this.cloned[3]=!0;break}this.decimal_zero_regexp=this.sections.map((t=>{if(t.decimal_max_digits>t.decimal_min_digits)return new RegExp(`0{1,${t.decimal_max_digits-t.decimal_min_digits}}(?:$|e)`)}))}static FormatPartsAsText(t,e=0){let s=-1;const i=t.map(((t,e)=>{switch(t.flag){case b.padded:return s=e,t.text;case b.hidden:return t.text.replace(/./g," ");case b.formatting:return"";default:return t.text}}));if(s>=0&&e){const t=i.reduce(((t,e,i)=>i===s?t:t+e.length),0);let r="";for(let o=0;o<e-t;o++)r+=i[s];i[s]=r}return i.join("")}get pattern(){return this._pattern}get date_format(){return this.sections[0]&&this.sections[0].date_format}IncreaseDecimal(){this.sections.forEach((t=>{t.decimal_min_digits++,t.decimal_max_digits=t.decimal_min_digits}))}DecreaseDecimal(){this.sections.forEach((t=>{t.decimal_min_digits=Math.max(0,t.decimal_min_digits-1),t.decimal_max_digits=t.decimal_min_digits}))}AddGrouping(){this.sections.forEach((t=>{t.grouping=!0}))}RemoveGrouping(){this.sections.forEach((t=>{t.grouping=!1}))}ToggleGrouping(){const t=!this.sections[0].grouping;this.sections.forEach((e=>{e.grouping=t}))}toString(){return this.sections[0].date_format?this._pattern:this.sections.filter(((t,e)=>!this.cloned[e])).map((t=>{let e="",s=0;if(t.fraction_format){t.fraction_integer&&(e+="? ");let s="";for(let e=0;e<t.fraction_denominator_digits;e++)s+="#";e+=s,e+="/",t.fraction_denominator?e+=t.fraction_denominator:e+=s}else if(t.has_number_format){for(s=0;s<t.integer_min_digits;s++)e+="0";if(t.grouping&&(e.length<4&&(e=("####"+e).slice(-4)),e=e.replace(/[\d#]{1,3}(?=([\d#]{3})+(?![\d#]))/g,"$&,")),t.decimal_max_digits||t.decimal_min_digits){for(e+=".",s=0;s<t.decimal_min_digits;s++)e+="0";for(;s<t.decimal_max_digits;s++)e+="#"}if(t.scaling){const i=Math.log10(t.scaling)/3;for(s=0;s<i;s++)e+=","}t.exponential&&(e+="e")}return t.prefix.map((t=>t.flag===b.hidden?"0"===t.text?"?":"_"+t.text:t.flag===b.padded?"*"+t.text:t.flag===b.formatting?"["+t.text+"]":t.text)).join("")+e+t.suffix.map((t=>t.flag===b.hidden?"0"===t.text?"?":"_"+t.text:t.flag===b.padded?"*"+t.text:t.text)).join("")})).join(";")}FormatParts(t){if("number"!=typeof t&&!this.sections[3])return[{text:t.toString()}];const{parts:e,section:s}=this.BaseFormat(t);let i=[];if(s.date_format||s.string_format)for(const t of e)"string"==typeof t?i.push({text:t}):i.push(t);else this.magic_decimal&&""===e[1]&&e.splice(1,1),i=[...s.prefix.map((t=>Object.assign({},t))),{text:s.has_number_format?e.join(g.decimal_separator):""},...s.suffix.map((t=>Object.assign({},t)))];for(let t=1;t<i.length;t++)i[t].flag===i[t-1].flag&&(i[t].text=i[t-1].text+i[t].text,i[t-1].text="");return i.filter((t=>t.text))}Format(t,e=0){return Y.FormatPartsAsText(this.FormatParts(t),e)}ZeroPad(t,e){for(;t.length<e;)t="0"+t;return t}DateFormat(t){const e=K(t),s=this.sections[0];let i=e.getUTCHours();return s.twelve_hour&&(i>12&&(i-=12),0===i&&(i=12)),{parts:s.prefix.map((t=>{if(t.flag===b.date_component_minutes)return"mm"===t.text?{text:this.ZeroPad(e.getUTCMinutes().toString(),2)}:{text:this.ZeroPad(e.getUTCMinutes().toString(),1)};if(t.flag===b.date_component){switch(t.text.toLowerCase()){case"am/pm":case"a/p":{const s=t.text.split("/");return{text:e.getUTCHours()>12?s[1]:s[0]}}case"mmmmm":return{text:g.date_components.long_months[e.getUTCMonth()][0]};case"mmmm":return"MMMM"===t.text?{text:g.date_components.long_months[e.getUTCMonth()].toUpperCase()}:{text:g.date_components.long_months[e.getUTCMonth()]};case"mmm":return"MMM"===t.text?{text:g.date_components.short_months[e.getUTCMonth()].toUpperCase()}:{text:g.date_components.short_months[e.getUTCMonth()]};case"mm":return{text:this.ZeroPad((e.getUTCMonth()+1).toString(),2)};case"m":return{text:this.ZeroPad((e.getUTCMonth()+1).toString(),1)};case"ddddd":case"dddd":return"DDDDD"===t.text||"DDDD"===t.text?{text:g.date_components.long_days[e.getUTCDay()].toUpperCase()}:{text:g.date_components.long_days[e.getUTCDay()]};case"ddd":return"DDD"===t.text?{text:g.date_components.short_days[e.getUTCDay()].toUpperCase()}:{text:g.date_components.short_days[e.getUTCDay()]};case"dd":return{text:this.ZeroPad(e.getUTCDate().toString(),2)};case"d":return{text:this.ZeroPad(e.getUTCDate().toString(),1)};case"yyyy":case"yyy":return{text:e.getUTCFullYear().toString()};case"yy":case"y":return{text:this.ZeroPad((e.getUTCFullYear()%100).toString(),2)};case"hh":return{text:this.ZeroPad(i.toString(),2)};case"h":return{text:this.ZeroPad(i.toString(),1)};case"ss":return{text:this.ZeroPad(e.getUTCSeconds().toString(),2)};case"s":return{text:this.ZeroPad(e.getUTCSeconds().toString(),1)}}const s=t.text.match(/^(s+)\.(0+)$/);if(s)return{text:this.ZeroPad(e.getUTCSeconds().toString(),s[1].length)+g.decimal_separator+(e.getUTCMilliseconds()/1e3).toFixed(s[2].length).substr(2)}}return Object.assign({},t)})),section:s}}StringFormat(t,e){const s=[];for(const i of e.prefix)i.flag===b.literal?s.push({text:t}):s.push(Object.assign({},i));return{parts:s,section:e}}Round2(t,e){const s=Math.pow(10,e);return Math.round(s*t)/s}FormatFraction(t,e){e.percent&&(t*=100);let s={denominator:1,numerator:Math.round(t),error:Math.abs(Math.round(t)-t)};if(e.fraction_denominator)s.denominator=e.fraction_denominator,s.numerator=Math.round(t*s.denominator);else if(s.error){const i=Y.fraction_limits[e.fraction_denominator_digits-1]||Y.fraction_limits[0];for(let e=2;e<=i;e++){const i=Math.round(t*e),r=Math.abs(i/e-t);if(r<s.error&&(s={numerator:i,denominator:e,error:r},!r))break}}const i=[];if(e.fraction_integer){const t=Math.floor(s.numerator/s.denominator);s.numerator%=s.denominator,!t&&s.numerator||(i.push(t.toString()),s.numerator&&i.push(" "))}else s.numerator||i.push("0");return s.numerator&&(i.push(s.numerator.toString()),i.push("/"),i.push(s.denominator.toString())),i.join("")}BaseFormat(t){if(this.sections[0].date_format)return this.DateFormat(Number(t));if("number"!=typeof t)return this.StringFormat(t.toString(),this.sections[3]);let e=this.sections[0],s=this.decimal_zero_regexp[0];t<0&&(e=this.sections[1]);const i=e.percent?e.decimal_max_digits+2:e.decimal_max_digits,r=Math.pow(10,-i)/2;let o=Math.abs(t);if(o<r&&(e=this.sections[2],s=this.decimal_zero_regexp[2]),e.scaling&&(o/=e.scaling,o<r&&(e=this.sections[2],s=this.decimal_zero_regexp[2])),e.string_format)return this.StringFormat(t.toString(),e);let a="";if(e.fraction_format)return{parts:[this.FormatFraction(o,e)],section:e};e.exponential?a=o.toExponential(e.decimal_max_digits):(e.percent&&(o*=100),a=this.Round2(o,e.decimal_max_digits).toFixed(e.decimal_max_digits)),s&&(a=a.replace(s,""));const n=a.split(".");for(;n[0].length<e.integer_min_digits;)n[0]=("0000000000000000"+n[0]).slice(-e.integer_min_digits);return 0===e.integer_min_digits&&"0"===n[0]&&(n[0]=""),e.grouping&&(n[0]=n[0].replace(Y.grouping_regexp,"$&"+g.grouping_separator)),{parts:n,section:e}}}Y.grouping_regexp=/\d{1,3}(?=(\d{3})+(?!\d))/g,Y.fraction_limits=[9,99,999,9999];class Q{static Get(t){const e=this.symbolc_name_map[t.toLowerCase()];let s=this.cache[e||t];return s||(s=new Y(t),this.cache[t]=s),s}static Equals(t,e){if(t===e)return!0;const s=this.Get(t),i=this.Get(e);return s.pattern===i.pattern}static Translate(t){const e=this.symbolc_name_map[t.toLowerCase()];return e?this.cache[e].toString():t}static SymbolicName(t){for(const e of Object.keys(this.base_formats))if(t===this.base_formats[e])return e;return null}static InitCache(){for(const t of Object.keys(this.base_formats))this.cache[t]=new Y(this.base_formats[t]),this.symbolc_name_map[t.toLowerCase()]=t;this.cache.General.magic_decimal=!0;for(const t of Object.keys(this.aliases))this.cache[t]=this.cache[this.aliases[t]],this.symbolc_name_map[t.toLowerCase()]=t}}var tt;Q.cache={},Q.symbolc_name_map={},Q.base_formats={Accounting:"_(#,##0.00_);(#,##0.00);-???",Number:"0.00",Integer:"0",Percent:"0.00%",General:"0.######",Fraction:"# ?/?",Dollar:"$* _(#,##0.00_);$* (#,##0.00);$* -???",Exponential:"0.000e","Short Date":"mm/dd/yy","Long Date":"dddd, mmm d yyyy",Timestamp:"mm-dd-yy hh:mm:ss"},Q.aliases={Scientific:"Exponential",Percentage:"Percent",Currency:"Dollar"},Q.InitCache(),function(t){t[t.None=0]="None",t[t.Nan=1]="Nan",t[t.Exponential=2]="Exponential",t[t.Percent=4]="Percent",t[t.Currency=8]="Currency",t[t.Grouping=16]="Grouping",t[t.Parens=32]="Parens",t[t.Date=64]="Date",t[t.Time=128]="Time"}(tt||(tt={}));const et=(new Date).getUTCFullYear(),st=new class{TestDate(t){const e=Date.parse(t);if(isNaN(e))return!1;const s=new Date(e),i=t.replace(/[\d\-\\/,.\s]+/g," ").toLocaleLowerCase().split(/\s+/).map((t=>t.trim())).filter((t=>!!t));if(!i.length)return e;if(!this.compare_month){this.compare_month={};for(let t=0;t<12;t++)this.compare_month[g.date_components.long_months[t].toLocaleLowerCase().replace(/\./,"")]=t,this.compare_month[g.date_components.short_months[t].toLocaleLowerCase().replace(/\./,"")]=t}if(!this.compare_day){this.compare_day={};for(let t=0;t<7;t++)this.compare_day[g.date_components.long_days[t].toLocaleLowerCase().replace(/\./,"")]=t,this.compare_day[g.date_components.short_days[t].toLocaleLowerCase().replace(/\./,"")]=t}let r=!1,o=!1;for(const t of i){let e=!1;for(const[i,o]of Object.entries(this.compare_month))if(t===i){if(r)return!1;if(s.getUTCMonth()!==o)return!1;e=!0,r=!0}if(!e)for(const[i,r]of Object.entries(this.compare_day))if(t===i){if(o)return!1;if(s.getUTCDay()!==r)return!1;e=!0,o=!0}if(!e)return!1}return!(o&&!r)&&e}TryParse(t=""){let e=tt.None;if("'"===t[0])return{value:t,type:o.string};if(""===t)return{value:t,type:o.string};if("NaN"===t)return{value:NaN,type:o.number,hints:tt.Nan};let s=t.trim();const i=s.match(/^[$](.*?)$/);i&&(s=i[1],e|=tt.Currency);const r=s.match(/^\((.*?)\)$/);r&&(s=r[1],e|=tt.Parens);const a=s.match(/^(.*?)%\s*$/);a&&(s=a[1],e|=tt.Percent),"."===g.decimal_separator?/,/.test(s)&&(s=s.replace(/,/g,""),e|=tt.Grouping):(s=s.replace(/(\d)\s+/g,"$1"),s=s.replace(/\./g,""),s=s.replace(/,/,"."));let n=Number(s);if(null===n||isNaN(n)){const s=t.toLowerCase();if("false"===s)return{value:!1,type:o.boolean};if("true"===s)return{value:!0,type:o.boolean};const i=this.TestDate(t);if(!1!==i&&!isNaN(i)){const t=new Date(i),s=t.getUTCFullYear();if(s>=et-200&&s<=et+200)return e=tt.Date,(t.getHours()||t.getMinutes()||t.getSeconds())&&(e|=tt.Time),{value:X(i),type:o.number,hints:e}}return{value:t,type:o.string}}if(r&&(n=-n),a){const t=n<0?-1:1,e=(t*n).toString().split(".");e[0]=("00"+e[0]).replace(/(\d\d)$/,".$1"),n=Number(e.join(""))*t}return/e/.test(t)&&(e|=tt.Exponential),{value:n,type:o.number,hints:e}}},it="http://www.w3.org/2000/svg";class rt{constructor(t,e,s={x:0,y:0}){this.theme=e,this.offset=s,this.g=document.createElementNS(it,"g"),this.g.setAttribute("transform",`translate(${s.x}, ${s.y})`),this.outline=document.createElementNS(it,"rect"),this.outline.setAttribute("class","outline"),t?(this.g.setAttribute("class","selection primary-selection"),this.fill=document.createElementNS(it,"path"),this.fill.setAttribute("class","fill"),this.nub=document.createElementNS(it,"rect"),this.nub.setAttribute("class","nub"),this.g.appendChild(this.fill),this.g.appendChild(this.outline),this.g.appendChild(this.nub)):(this.g.setAttribute("class","selection alternate-selection"),this.fill=document.createElementNS(it,"rect"),this.fill.setAttribute("class","fill"),this.g.appendChild(this.fill),this.g.appendChild(this.outline))}Offset(t){this.g.setAttribute("transform",`translate(${t.x}, ${t.y})`)}Show(t=!0){this.g.style.display=t?"block":"none"}SetOutline(t,e=!1){this.outline.setAttribute("x",(t.left-1).toString()),this.outline.setAttribute("y",(t.top-1).toString()),this.outline.setAttribute("width",(t.width+1).toString()),this.outline.setAttribute("height",(t.height+1).toString()),e&&this.fill&&(this.fill.setAttribute("x",t.left.toString()),this.fill.setAttribute("y",t.top.toString()),this.fill.setAttribute("width",t.width.toString()),this.fill.setAttribute("height",t.height.toString()))}SetFill(t,e){if(!this.fill)return;const s=[];s.push("M"+t.left+" "+t.top),s.push("L"+t.left+" "+t.bottom),s.push("L"+t.right+" "+t.bottom),s.push("L"+t.right+" "+t.top),s.push("Z"),s.push("M"+e.left+" "+e.top),s.push("L"+e.right+" "+e.top),s.push("L"+e.right+" "+e.bottom),s.push("L"+e.left+" "+e.bottom),s.push("Z"),this.fill.setAttribute("d",s.join(" "))}SetNub(t){this.nub&&(this.nub.setAttribute("x",(t.left+t.width-4).toString()),this.nub.setAttribute("y",(t.top+t.height-4).toString()),this.nub.setAttribute("width","7"),this.nub.setAttribute("height","7"))}}const ot="http://www.w3.org/2000/svg";var at;!function(t){t[t.Horizontal=0]="Horizontal",t[t.Vertical=1]="Vertical"}(at||(at={}));class nt{constructor(t,e,s){this.theme=t,this.container=e,this.orientation=s,this.g=document.createElementNS(ot,"g"),this.g.setAttribute("class","header-overlay"),this.overlay=document.createElementNS(ot,"rect"),this.overlay.setAttribute("class","overlay"),this.highlight=document.createElementNS(ot,"rect"),this.highlight.setAttribute("class","highlight"),this.g.style.display="none",this.g.appendChild(this.highlight),this.g.appendChild(this.overlay),e.appendChild(this.g)}Remove(){this.container.removeChild(this.g)}Hide(){this.g.style.display="none"}Show(t,e,s,i){this.overlay.setAttribute("x",t.toString()),this.overlay.setAttribute("y",e.toString()),this.overlay.setAttribute("width",s.toString()),this.overlay.setAttribute("height",i.toString()),this.orientation===at.Horizontal?(this.highlight.setAttribute("x",t.toString()),this.highlight.setAttribute("y",(e+i-2).toString()),this.highlight.setAttribute("width",s.toString()),this.highlight.setAttribute("height","2")):(this.highlight.setAttribute("x",(t+s-2).toString()),this.highlight.setAttribute("y",e.toString()),this.highlight.setAttribute("width","2"),this.highlight.setAttribute("height",i.toString())),this.g.style.display="block"}}class lt{constructor(t,e,s,i,r){this.theme=t,this.layout=e,this.model=s,this.primary_selection=i,this.additional_selections=r,this.nub_rectangle=new y(-1,-1,0,0),this.grid_selections=[],this.row_header_selections=[],this.column_header_selections=[],this.corner_selections=[],this.cached_additional_selections=""}Initialize(){this.row_overlay=new nt(this.theme,this.layout.row_header_selection,at.Horizontal),this.column_overlay=new nt(this.theme,this.layout.column_header_selection,at.Vertical),this.corner_row_overlay=new nt(this.theme,this.layout.corner_selection,at.Horizontal),this.corner_column_overlay=new nt(this.theme,this.layout.corner_selection,at.Vertical)}RenderSelections(t=!0,e=!0){const s=this.primary_selection.empty;t||(this.primary_selection.empty=!0);const i=[this.primary_selection].concat(this.additional_selections);this.RenderSelectionGroup(i,this.layout.grid_selection,void 0,void 0,this.grid_selections,void 0,e);let r=new y(-1,-1,0,0);if(!this.primary_selection.empty){const t=this.model.active_sheet.RealArea(this.primary_selection.area);r=this.layout.CellAddressToRectangle(t.start).Combine(this.layout.CellAddressToRectangle(t.end))}if(!this.primary_selection.empty&&this.layout.header_offset.y>2?(this.row_overlay.Show(r.left,0,r.width,this.layout.header_offset.y),this.corner_row_overlay.Show(r.left+this.layout.header_offset.x,0,r.width,this.layout.header_offset.y)):(this.row_overlay.Hide(),this.corner_row_overlay.Hide()),!this.primary_selection.empty&&this.layout.header_offset.x>2?(this.column_overlay.Show(0,r.top,this.layout.header_offset.x,r.height),this.corner_column_overlay.Show(0,r.top+this.layout.header_offset.y,this.layout.header_offset.x,r.height)):(this.column_overlay.Hide(),this.corner_column_overlay.Hide()),!this.model.active_sheet.freeze.columns&&!this.model.active_sheet.freeze.rows)return void(this.primary_selection.empty=s);const o=[],a=[];if(this.primary_selection.empty)o.push(!1),a.push(!1);else{const t=this.primary_selection.area.start;o.push(t.row<=this.model.active_sheet.freeze.rows||t.row===1/0),a.push(t.column<=this.model.active_sheet.freeze.columns||t.column===1/0)}for(const{area:t}of this.additional_selections)o.push(t.start.row<=this.model.active_sheet.freeze.rows||t.start.row===1/0),a.push(t.start.column<=this.model.active_sheet.freeze.columns||t.start.column===1/0);this.model.active_sheet.freeze.rows&&this.RenderSelectionGroup(i,this.layout.row_header_selection,o,void 0,this.row_header_selections,{x:0,y:this.layout.header_offset.y}),this.model.active_sheet.freeze.columns&&this.RenderSelectionGroup(i,this.layout.column_header_selection,a,void 0,this.column_header_selections,{x:this.layout.header_offset.x,y:0}),this.model.active_sheet.freeze.rows&&this.model.active_sheet.freeze.columns&&this.RenderSelectionGroup(i,this.layout.corner_selection,a,o,this.corner_selections,Object.assign({},this.layout.header_offset)),this.primary_selection.empty=s}RenderSelectionGroup(t,e,s,i,r,o,a=!0){for(let n=0;n<t.length;n++)if(t[n].area.start.sheet_id&&t[n].area.start.sheet_id!==this.model.active_sheet.id||t[n].empty||s&&!s[n]||i&&!i[n])r[n]&&r[n].Show(!1);else if(a||!t[n].rendered){const s=this.EnsureGridSelectionBlock(e,r,n,o);this.RenderSVGSelection(t[n],s,n)}for(let e=t.length;e<r.length;e++)r[e]&&r[e].Show(!1)}EnsureGridSelectionBlock(t,e,s,i){let r=e[s];if(!r)if(r=new rt(!s,this.theme),e[s]=r,s){let e=t.querySelector(".alternate-selections");e||(e=document.createElementNS("http://www.w3.org/2000/svg","g"),e.setAttribute("class","alternate-selections"),t.appendChild(e)),null==e||e.appendChild(r.g)}else t.appendChild(r.g);return i&&r.Offset(i),r}ClampEnd(t){return{row:Math.min(t.row,this.model.active_sheet.rows-1),column:Math.min(t.column,this.model.active_sheet.columns-1)}}RenderSVGSelection(t,e,s=0){const i=this.model.active_sheet.RealArea(t.area,!0);let r=this.layout.CellAddressToRectangle(i.start);if(i.count>1)r=r.Combine(this.layout.CellAddressToRectangle(i.end));else if(s){const e=this.model.active_sheet.CellData(t.target);e.merge_area&&(r=this.layout.CellAddressToRectangle(e.merge_area.start),r=r.Combine(this.layout.CellAddressToRectangle(e.merge_area.end)))}if(s||(this.nub_rectangle=new y(r.left+r.width-6,r.top+r.height-6,11,11)),0===r.top&&this.layout.header_offset.y<=1&&(r.top=1,r.height-=1),0===r.left&&this.layout.header_offset.x<=1&&(r.left=1,r.width-=1),r.height<=0||r.height<=0)e.Show(!1);else{if(e.SetOutline(r,!!s),s)t.rendered=!0;else{let s=this.layout.CellAddressToRectangle(t.target);const i=this.model.active_sheet.CellData(t.target);i.merge_area&&(s=this.layout.CellAddressToRectangle(i.merge_area.start),s=s.Combine(this.layout.CellAddressToRectangle(i.merge_area.end))),e.SetFill(s,r),e.SetNub(r)}e.Show()}}}function ht(t,e=[],s,i){let r;"string"==typeof e&&(e=[e]);const o=t=>{t.stopPropagation(),t.preventDefault(),r(),i&&i(t)},a=t=>{if(t.stopPropagation(),t.preventDefault(),!t.buttons)return r(),void(i&&i(t));s&&s(t)};r=()=>{t.style.display="none",t.removeEventListener("mousemove",a),t.removeEventListener("mouseup",o);for(const s of e)t.classList.remove(s)};for(const s of e)t.classList.add(s);t.style.display="block",s&&t.addEventListener("mousemove",a),i&&t.addEventListener("mouseup",o)}class ct extends O{constructor(t,e,s,i,r){super(),this.layout=t,this.model=e,this.options=s,this.theme=i,this.grid_container=r,this.scale=1,this.dragging=!1,this.double_click_data={},this._visible=!1,this.scale=this.options.initial_scale||1,this.Init(r)}get visible(){return this._visible}IsDoubleClick(t,e=300){return this.double_click_data.index===t?(clearTimeout(this.double_click_data.timeout),this.double_click_data.index=void 0,this.double_click_data.timeout=void 0,!0):(this.double_click_data.timeout&&clearTimeout(this.double_click_data.timeout),this.double_click_data.index=t,this.double_click_data.timeout=setTimeout((()=>{this.double_click_data.index=void 0,this.double_click_data.timeout=void 0}),e),!1)}Hide(){this.Show(!1)}Show(t=!0){var e,s;this.container&&(this._visible=t,t?(this.grid_container.classList.add("treb-tab-bar-layout"),null===(e=this.grid_container.parentElement)||void 0===e||e.classList.add("has-tab-bar"),this.container.style.display="flex"):(this.grid_container.classList.remove("treb-tab-bar-layout"),null===(s=this.grid_container.parentElement)||void 0===s||s.classList.remove("has-tab-bar"),this.container.style.display="none"))}SetActive(t,e){e?t.classList.add("selected"):t.classList.remove("selected")}UpdateScale(t){this.scale_label&&(this.scale=t,this.scale_label.textContent=Math.round(1e3*t)/10+"%")}Update(){var t;if(this.dragging)return;if(!this.node)return;if("auto"===this.options.tab_bar){if(this.model.sheets.reduce(((t,e)=>e.visible?t+1:t),0)<=1)return void this.Show(!1);this.Show(!0)}this.grid_container.classList.add("treb-tab-bar-layout"),null===(t=this.grid_container.parentElement)||void 0===t||t.classList.add("has-tab-bar");const e=this.node;let s=!1;const i=Array.prototype.map.call(e.children,(t=>t));for(const t of i)t.dataset.preserve?s=!0:e.removeChild(t);if(!s){let t=document.createElement("div");if(t.classList.add("tab-bar-spacer"),t.style.order="9998",t.dataset.preserve="true",e.appendChild(t),t=document.createElement("div"),t.classList.add("tab-bar-end"),t.style.order="9999",t.dataset.preserve="true",this.options.scale_control){const e=document.createElement("div");e.classList.add("treb-scale-control");let s=document.createElement("button");s.innerHTML="<svg viewBox='0 0 16 16'><path d='M4,8 h8'/></svg>",s.title="Decrease scale",s.addEventListener("click",(()=>this.Publish({type:"scale",action:"decrease"}))),e.appendChild(s),this.scale_label=document.createElement("div"),e.appendChild(this.scale_label),this.UpdateScale(this.scale),s=document.createElement("button"),s.innerHTML="<svg viewBox='0 0 16 16'><path d='M4,8 h8 M8,4 v8'/></svg>",s.title="Increase scale",s.addEventListener("click",(()=>this.Publish({type:"scale",action:"increase"}))),e.appendChild(s),t.appendChild(e)}e.appendChild(t)}if(this.options.delete_tab){const t=document.createElement("div");t.classList.add("delete-tab"),t.innerHTML="<svg viewbox='0 0 16 16'><path d='M4,4 L12,12 M12,4 L4,12'/></svg>",t.style.order=(-1).toString(),t.title="Delete current sheet",t.addEventListener("click",(()=>{this.Publish({type:"delete-sheet"})})),e.appendChild(t)}const r=[];for(const t of this.model.sheets){if(!t.visible)continue;const s=r.length,i=document.createElement("div");i.classList.add("tab"),i.style.order=(2*s).toString(),this.SetActive(i,t===this.model.active_sheet);const o=e=>{if(e.stopPropagation(),e.preventDefault(),this.IsDoubleClick(s))return;this.Publish({type:"activate-sheet",sheet:t});let o=r.map((t=>t.getBoundingClientRect())),a=2*s-1;const n=o[0].left,l=o[o.length-1].right,h=o[0].top,c=o[0].bottom,d=2*(o.length-1)+1;for(const t of r)this.SetActive(t,t===i);this.dragging=!0,ht(this.layout.mask,[],(t=>{const[e,u]=[t.clientX,t.clientY];if(u>h&&u<c){let t=a;if(e<n)t=-1;else if(e>l)t=d;else for(let i=0;i<o.length;i++){const r=o[i];if(e>=r.left&&e<=r.right){i!==s&&(t=e>=r.left+r.width/2?2*i+1:2*i-1);break}}t!==a&&(a=t,i.style.order=a.toString(),o=r.map((t=>t.getBoundingClientRect())))}}),(()=>{let t=s,e=(a+1)/2;this.dragging=!1;for(let s=0;s<this.model.sheets.length;s++)this.model.sheets[s].visible||(t>=s&&t++,e>=s&&e++);t===e||0===t&&e<=0||t===r.length-1&&e>=r.length-1||this.Publish({type:"reorder-sheet",index:t,move_before:e})}))},a=()=>{i.removeEventListener("mousedown",o),i.removeEventListener("dblclick",a),i.contentEditable="true";const e=window.getSelection();if(e){e.removeAllRanges();const t=document.createRange();t.selectNodeContents(i),e.addRange(t)}i.addEventListener("keydown",(e=>{switch(e.key){case"Enter":this.Publish({type:"rename-sheet",name:i.innerText.trim(),sheet:t});break;case"Escape":i.innerText=t.name,this.Publish({type:"cancel"});break;default:return}e.stopPropagation(),e.preventDefault()})),i.addEventListener("focusout",(()=>{const e=i.innerText.trim();this.Publish({type:"rename-sheet",name:e,sheet:t})})),i.focus()};i.textContent=t.name,i.addEventListener("dblclick",a),i.addEventListener("mousedown",o),e.appendChild(i),r.push(i)}if(this.options.add_tab){const t=document.createElement("a");t.classList.add("add-tab"),t.style.order=(2*this.model.sheets.length).toString(),t.innerText="+",t.title="Add sheet",t.addEventListener("click",(()=>{this.Publish({type:"add-sheet"})})),e.appendChild(t)}}Init(t){this.container=document.createElement("div"),this.container.classList.add("treb-tab-bar-container"),t.appendChild(this.container),this.node=document.createElement("div"),this.node.classList.add("treb-tab-bar"),this.container.appendChild(this.node)}}let dt=100;class ut{constructor(t={}){this.key_=dt++,this.data={},this.type="",this.temp={},this.inflated=!1,this.resizable=!0,this.movable=!0,this.removable=!0,this.selectable=!0,this.move_with_cells=!0,this.resize_with_cells=!0,this.formula="";for(const e of Object.keys(this))"layout"!==e&&t[e]&&(this[e]=t[e]);t.layout&&(this.layout=JSON.parse(JSON.stringify(t.layout))),t.rect&&(this.rect=y.Create(t.rect))}get key(){return this.key_}toJSON(){const t={};return this.data&&(t.data=this.data),this.formula&&(t.formula=this.formula),this.type&&(t.type=this.type),this.resizable||(t.resizable=this.resizable),this.movable||(t.movable=this.movable),this.removable||(t.removable=this.removable),this.selectable||(t.selectable=this.selectable),this.move_with_cells||(t.move_with_cells=this.move_with_cells),this.resize_with_cells||(t.resize_with_cells=this.resize_with_cells),this.layout&&(t.layout=this.layout),this.extent&&(t.extent=this.extent),t}}class mt{constructor(t){this.annotations=[],this.freeze={rows:0,columns:0},this.visible=!0,this.default_column_width=100,this.default_row_height=25,this.cells=new _,this.selection={target:{row:0,column:0},area:new r({row:0,column:0}),empty:!0},this.scroll_offset={x:0,y:0},this.name=mt.default_sheet_name,this.row_height_=[],this.column_width_=[],this.row_headers=[],this.column_headers=[],this.row_header_width=100,this.column_header_height=25,this.style_map=[],this.style_json_map=[],this.sheet_style={},this.row_styles={},this.column_styles={},this.row_pattern=[],this.cell_style=[],this.default_style_properties=t,this.default_column_width=100,this.row_header_width=60,this.UpdateDefaultRowHeight(),this.id_=mt.base_id++}static Reset(){this.base_id=100}static Blank(t,e,s=30,i=20){const r=new mt(t);return e&&(r.name=e),s=Math.max(s,1),i=Math.max(i,1),r.cells.EnsureCell({row:s-1,column:i-1}),r}static FromJSON(t,e,s){let i;i="string"==typeof t?JSON.parse(t):t;const r=(t,e)=>{Object.keys(e).forEach((s=>{const i=Number(s)||0;t[i]=e[s]}))};s||(s=new mt(e)),i.default_column_width&&(s.default_column_width=i.default_column_width),i.default_row_height&&(s.default_row_height=i.default_row_height),i.id&&(s.id=i.id),i.name&&(s.name=i.name);const o=t=>{const e=t;e.text_color&&("none"!==e.text_color&&(e.text={text:e.text_color}),e.text_color=void 0),e.background&&("none"!==e.background&&(e.fill={text:e.background}),e.background=void 0),e.border_top_color&&("none"!==e.border_top_color&&(e.border_top_fill={text:e.border_top_color}),e.border_top_color=void 0),e.border_left_color&&("none"!==e.border_left_color&&(e.border_left_fill={text:e.border_left_color}),e.border_left_color=void 0),e.border_bottom_color&&("none"!==e.border_bottom_color&&(e.border_bottom_fill={text:e.border_bottom_color}),e.border_bottom_color=void 0),e.border_right_color&&("none"!==e.border_right_color&&(e.border_right_fill={text:e.border_right_color}),e.border_right_color=void 0)},a=i.cell_style_refs;for(const t of a)o(t);if(s.cell_style=[],a&&(i.cell_styles||[]).forEach((t=>{"number"==typeof t.ref&&(t.style=JSON.parse(JSON.stringify(a[t.ref])))})),s.cells.FromJSON(i.data),i.rows&&s.cells.EnsureRow(i.rows-1),i.columns&&s.cells.EnsureColumn(i.columns-1),i.data)if(f(i.data))for(const t of i.data)t.style_ref&&(s.cell_style[t.column]||(s.cell_style[t.column]=[]),s.cell_style[t.column][t.row]=JSON.parse(JSON.stringify(a[t.style_ref])));else if(p(i.data))for(const t of i.data){const e=t.row;for(const i of t.cells){const t=i.column;i.style_ref&&(s.cell_style[t]||(s.cell_style[t]=[]),s.cell_style[t][e]=JSON.parse(JSON.stringify(a[i.style_ref])))}}else for(const t of i.data){const e=t.column;for(const i of t.cells){const t=i.row;i.style_ref&&(s.cell_style[e]||(s.cell_style[e]=[]),s.cell_style[e][t]=JSON.parse(JSON.stringify(a[i.style_ref])))}}s.freeze.rows=0,s.freeze.columns=0,i.freeze&&(s.freeze.rows=i.freeze.rows||0,s.freeze.columns=i.freeze.columns||0),s.scroll_offset=i.scroll?Object.assign({},i.scroll):{x:0,y:0};for(const t of i.cell_styles||[])t.style&&(s.cell_style[t.column]||(s.cell_style[t.column]=[]),s.cell_style[t.column][t.row]=t.style);s.sheet_style=i.sheet_style||{},s.row_styles=i.row_style,s.column_styles=i.column_style,s.row_pattern=i.row_pattern||[],o(s.sheet_style||{});for(const t of s.row_pattern)o(t);for(const t of Object.keys(s.column_styles))o(s.column_styles[t]);for(const t of Object.keys(s.row_styles))o(s.row_styles[t]);return s.row_height_=[],r(s.row_height_,i.row_height||{}),s.row_height_.length&&s.cells.EnsureRow(s.row_height_.length-1),s.column_width_=[],r(s.column_width_,i.column_width||{}),s.column_width_.length&&s.cells.EnsureColumn(s.column_width_.length-1),s.annotations=(i.annotations||[]).map((t=>new ut(t))),i.selection&&(s.selection=JSON.parse(JSON.stringify(i.selection))),s.visible=!0,void 0!==i.visible&&(s.visible=!!i.visible),s}get header_offset(){return{x:this.row_header_width,y:this.column_header_height}}get rows(){return this.cells.rows}get columns(){return this.cells.columns}get id(){return this.id_}set id(t){this.id_=t,this.id>=mt.base_id&&(mt.base_id=this.id+1)}MergeCells(t){t=t.Clone(),this.cells.Apply(t,((e,s,i)=>{e.merge_area=t,e.render_dirty=!0,s===t.start.column&&i===t.start.row||e.Reset()}),!0)}UnmergeCells(t){let e=!0;this.cells.Apply(t,(s=>{e=e&&!!s.merge_area&&t.Equals(s.merge_area)}),!1),e?this.cells.Apply(t,(t=>{t.merge_area=void 0,t.render_dirty=!0}),!1):console.warn("area mismatch")}StyleFontSize(t,e={}){let s=t.font_size_value||0,i=0;switch(t.font_size_unit){case"px":s*=.75;break;case"em":i=t.font_size_value||1;break;case"%":i=(t.font_size_value||100)/100}return i&&(s=i*(e.font_size_value||10),"px"===e.font_size_unit&&(s*=.75)),s||10}UpdateDefaultRowHeight(){const t=v.Composite([this.default_style_properties,this.sheet_style]);if("undefined"!=typeof window){const e=H.MeasureText(v.Font(t),"M"),s=Math.round(1.4*e.height);this.default_row_height<s&&(this.default_row_height=s)}}SetRowHeaders(t){this.row_headers=t.map((t=>void 0===t?"":t.toString())),this.row_headers&&this.cells.EnsureRow(this.row_headers.length-1)}SetColumnHeaders(t){this.column_headers=t.map((t=>void 0===t?"":t.toString())),t&&this.cells.EnsureColumn(t.length-1)}RowHeader(t){return this.row_headers?this.row_headers.length>t?this.row_headers[t]:"":t+1}ColumnHeader(t){let e="";if(this.column_headers)return this.column_headers.length>t?this.column_headers[t]:"";for(;;){const s=t%26;if(e=String.fromCharCode(65+s)+e,!(t=Math.floor(t/26)))break;t--}return e}GetRowHeight(t){const e=this.row_height_[t];return void 0===e?this.default_row_height:e}SetRowHeight(t,e){return this.row_height_[t]=e,this.cells.EnsureRow(t),e}GetColumnWidth(t){const e=this.column_width_[t];return void 0===e?this.default_column_width:e}SetColumnWidth(t,e){return this.column_width_[t]=e,this.cells.EnsureColumn(t),e}Delta(t,e){const s={},i=[...Object.keys(t),...Object.keys(e)];for(const r of i){const i=t[r],o=e[r];"object"==typeof i&&"object"==typeof o?JSON.stringify(i)!==JSON.stringify(o)&&(s[r]=o):i!==o&&(s[r]=o)}return s}UpdateCellStyle(t,e,s=!0){const{row:i,column:r}=t;this.cell_style[r]||(this.cell_style[r]=[]);const o=this.CompositeStyleForCell(t,!1,!1),a=v.Composite([this.default_style_properties,o,v.Merge(this.cell_style[r][i]||{},e,s)]),n=this.Delta(o,a);this.cell_style[r][i]=n,this.CellData(t).FlushStyle()}Invalidate(t){this.cells.Apply(this.RealArea(t),(t=>t.render_dirty=!0))}UpdateAreaStyle(t,e={},s=!0){if(t)if(t.entire_sheet)this.UpdateSheetStyle(e,s);else if(t.entire_column)for(let i=t.start.column;i<=t.end.column;i++)this.UpdateColumnStyle(i,e,s);else if(t.entire_row)for(let i=t.start.row;i<=t.end.row;i++)this.UpdateRowStyle(i,e,s);else t.Array().forEach((t=>this.UpdateCellStyle(t,e,s)))}HasCellStyle(t){return!!(this.cell_style[t.column]&&this.cell_style[t.column][t.row]||this.row_styles[t.row]||this.column_styles[t.column]||this.row_pattern.length)}NextVisibleColumn(t){for(++t;0===this.column_width_[t];t++);return t}PreviousVisibleColumn(t){for(--t;t>=0&&0===this.column_width_[t];t--);return t}NextVisibleRow(t){for(++t;0===this.row_height_[t];t++);return t}PreviousVisibleRow(t){for(--t;t>=0&&0===this.row_height_[t];t--);return t}SurroundingStyle(t){const e=[{},{},{},{},{},{},{},{},{},{}];let s=t.column+1,i=t.column-1,r=t.row+1,o=t.row-1;for(;0===this.column_width_[s];s++);for(;0===this.row_height_[r];r++);for(;i>=0&&0===this.column_width_[i];i--);for(;o>=0&&0===this.row_height_[o];o--);return i>=0&&o>=0&&(e[7]=this.CellStyleData({row:o,column:i})||{}),i>=0&&(e[4]=this.CellStyleData({row:t.row,column:i})||{},e[1]=this.CellStyleData({row:r,column:i})||{}),o>=0&&(e[8]=this.CellStyleData({row:o,column:t.column})||{},e[9]=this.CellStyleData({row:o,column:s})||{}),e[6]=this.CellStyleData({row:t.row,column:s})||{},e[2]=this.CellStyleData({row:r,column:t.column})||{},e[3]=this.CellStyleData({row:r,column:s})||{},e}CellStyleData(t){const e=this.cells.GetCell(t);if(e){if(!e.style){const s=this.GetStyleIndex(this.CompositeStyleForCell(t));e.style=this.style_map[s]}return e.style}}GetCopyStyle(t){return this.CompositeStyleForCell(t,!0,!1)}CellData(t){const e=this.cells.EnsureCell(t);if(e.rendered_type)return e;let s,i;if(e.calculated_type?(i=e.calculated,s=e.calculated_type):(i=e.value,s=e.type),!e.style){const s=this.GetStyleIndex(this.CompositeStyleForCell(t));e.style=this.style_map[s]}return s&&null!=i?s===o.number?(isNaN(i)?e.formatted=void 0===e.style.nan?"NaN":e.style.nan:e.formatted=this.FormatNumber(i,e.style.number_format),e.rendered_type=o.number):s===o.error?(e.formatted="#"+(i||"ERR?"),e.rendered_type=o.error):s===o.boolean?(e.formatted=i.toString().toUpperCase(),e.rendered_type=o.boolean):s===o.formula&&void 0===e.calculated?(e.formatted="",e.rendered_type=o.string):(e.formatted=this.FormatNumber(i,e.style.number_format),e.rendered_type=o.string):(e.formatted="",e.rendered_type=o.string),e}FormatNumber(t,e=""){const s=Q.Get(e).FormatParts(t);return s.length?1!==s.length||s[0].flag?s:s[0].text||"":""}SetHeaderSize(t=60,e=this.default_row_height){this.row_header_width=t,this.column_header_height=e}AutoSizeRow(t,e={}){let s=this.default_row_height;for(let i=0;i<this.cells.columns;i++){const r=this.CellData({row:t,column:i}),o=r.style;let a=r.formatted||"";if("string"!=typeof a&&(a=a.map((t=>t.text)).join("")),o&&a&&a.length){const t=a.split(/\n/),i=this.StyleFontSize(o,e);s=Math.max(s,((i||10)+9)*t.length)}}this.SetRowHeight(t,s)}AutoSizeColumn(t,e=!0){mt.measurement_canvas||(mt.measurement_canvas=document.createElement("canvas"));const s=mt.measurement_canvas.getContext("2d");if(!s)return;let i=12;e||(i=this.GetColumnWidth(t));for(let e=0;e<this.cells.rows;e++){const r=this.CellData({row:e,column:t});let o=r.formatted||"";"string"!=typeof o&&(o=o.map((t=>t.text)).join("")),o&&o.length&&(s.font=v.Font(r.style||{}),i=Math.max(i,Math.ceil(s.measureText(o).width)+8))}this.SetColumnWidth(t,i)}GetStyle(t){return this.style_map[t]}InsertRows(t=0,e=1){if(t)for(let e=0;e<this.cells.columns;e++){const s=this.cells.GetCell({row:t-1,column:e},!1);if(s&&s.area){const i=this.cells.GetCell({row:t,column:e},!1);if(i&&i.area&&i.area.Equals(s.area))return!1}}e<0?this.cells.DeleteRows(t,-e):this.cells.InsertRows(t,e);const s={},i={};for(let e=t;e<this.cells.rows;e++)for(let t=0;t<this.cells.columns;t++){const r=this.cells.GetCell({row:e,column:t},!1);r&&(r.area&&!i[r.area.spreadsheet_label]&&(i[r.area.spreadsheet_label]=r.area),r.merge_area&&!s[r.merge_area.spreadsheet_label]&&(s[r.merge_area.spreadsheet_label]=r.merge_area))}for(const t of Object.keys(i)){const s=i[t],o=new r({row:s.start.row+e,column:s.start.column},{row:s.end.row+e,column:s.end.column});o.Iterate((t=>{this.cells.GetCell(t,!0).area=o}))}for(const i of Object.keys(s)){const o=s[i],a={row:o.start.row,column:o.start.column};o.start.row>=t&&(a.row+=e);const n=new r(a,{row:o.end.row+e,column:o.end.column});n.Iterate((t=>{this.cells.GetCell(t,!0).merge_area=n}))}const o=Object.keys(this.row_styles),a={};o.forEach((s=>{const i=Number(s);i<t?a[i]=this.row_styles[i]:e<0&&i<t-e||(a[i+e]=this.row_styles[i])})),this.row_styles=a;let n=[];if(e<0)n=[t,-e];else{n=[t,0];for(let t=0;t<e;t++)n.push(void 0)}return this.cell_style.forEach((e=>{e&&e.length>=t&&e.splice.apply(e,n)})),this.row_height_.splice.apply(this.row_height_,n),this.FlushCellStyles(),!0}InsertColumns(t=0,e=1){if(t)for(let e=0;e<this.cells.rows;e++){const s=this.cells.GetCell({row:e,column:t-1},!1);if(s&&s.area){const i=this.cells.GetCell({row:e,column:t},!1);if(i&&i.area&&i.area.Equals(s.area))return!1}}e<0?this.cells.DeleteColumns(t,-e):this.cells.InsertColumns(t,e);const s={},i={};for(let e=t;e<this.cells.columns;e++)for(let t=0;t<this.cells.rows;t++){const r=this.cells.GetCell({row:t,column:e},!1);r&&(r.area&&!i[r.area.spreadsheet_label]&&(i[r.area.spreadsheet_label]=r.area),r.merge_area&&!s[r.merge_area.spreadsheet_label]&&(s[r.merge_area.spreadsheet_label]=r.merge_area))}for(const t of Object.keys(i)){const s=i[t],o=new r({row:s.start.row,column:s.start.column+e},{row:s.end.row,column:s.end.column+e});o.Iterate((t=>{this.cells.GetCell(t,!0).area=o}))}for(const i of Object.keys(s)){const o=s[i],a={row:o.start.row,column:o.start.column};o.start.column>=t&&(a.column+=e);const n=new r(a,{row:o.end.row,column:o.end.column+e});n.Iterate((t=>{this.cells.GetCell(t,!0).merge_area=n}))}const o=Object.keys(this.column_styles),a={};o.forEach((s=>{const i=Number(s);i<t?a[i]=this.column_styles[i]:e<0&&i<t-e||(a[i+e]=this.column_styles[i])})),this.column_styles=a;let n=[];if(e<0)n=[t,-e];else{n=[t,0];for(let t=0;t<e;t++)n.push(void 0)}return this.cell_style.splice.apply(this.cell_style,n),this.column_width_.splice.apply(this.column_width_,n),this.FlushCellStyles(),!0}ClearArea(t){t=this.RealArea(t),this.cells.Apply(t,(t=>t.Reset()))}SetAreaValues2(t,e){t=this.RealArea(t),this.cells.SetArea(t,e)}SetArrayValue(t,e){t=this.RealArea(t),this.cells.Apply(t,(e=>e.SetArray(t)),!0),this.cells.GetCell(t.start,!0).SetArrayHead(t,e)}SetCellValue(t,e){this.cells.GetCell(t,!0).Set(e)}RealArea(t,e=!1){const s=t.start,i=t.end;return t.entire_row&&(s.column=0,s.absolute_column=!1,i.column=this.cells.columns-1,i.absolute_column=!1),t.entire_column&&(s.row=0,s.absolute_row=!1,i.row=this.cells.rows-1,i.absolute_row=!1),e&&(i.row>=this.rows&&(i.row=this.rows-1,i.absolute_row=!1),i.column>=this.columns&&(i.column=this.columns-1,i.absolute_column=!1)),new r(s,i)}FormattedCellValue(t){const e=this.CellData(t);if(e)return"string"==typeof e.formatted?e.formatted:e.formatted?e.formatted.map((t=>{switch(t.flag){case 1:case 2:return" ";default:return t.text}})).join(""):e.value}GetFormattedRange(t,e=t){if(t.row===e.row&&t.column===e.column)return this.FormattedCellValue(t);const s=[];for(let i=t.row;i<=e.row;i++){const r=[];for(let s=t.column;s<=e.column;s++)r.push(this.FormattedCellValue({row:i,column:s}));s.push(r)}return s}NumberFormatsAndColors(t,e){const s=s=>{var i,r,o,a,n,l;s.number_format&&(e[s.number_format]=1),(null===(i=s.text)||void 0===i?void 0:i.text)&&"none"!==s.text.text&&(t[s.text.text]=1),(null===(r=s.fill)||void 0===r?void 0:r.text)&&(t[s.fill.text]=1),(null===(o=s.border_top_fill)||void 0===o?void 0:o.text)&&(t[s.border_top_fill.text]=1),(null===(a=s.border_left_fill)||void 0===a?void 0:a.text)&&(t[s.border_left_fill.text]=1),(null===(n=s.border_right_fill)||void 0===n?void 0:n.text)&&(t[s.border_right_fill.text]=1),(null===(l=s.border_bottom_fill)||void 0===l?void 0:l.text)&&(t[s.border_bottom_fill.text]=1)};s(this.sheet_style);for(const t in this.row_styles)s(this.row_styles[t]);for(const t in this.column_styles)s(this.column_styles[t]);for(const t of this.row_pattern)s(t);for(const t of this.cell_style)if(t)for(const e of t)e&&s(e)}toJSON(t={}){var e;const s=(t,e)=>{const s={};for(let i=0;i<t.length;i++)void 0!==t[i]&&t[i]!==e&&(s[i]=t[i]);if(Object.keys(s).length)return s};let i=[{}];const r={},o=[],a=JSON.stringify({});for(let t=0;t<this.cell_style.length;t++){const e=this.cell_style[t];if(e){o[t]=[];for(let s=0;s<e.length;s++)if(e[s]){const n=JSON.stringify(e[s]);if(n!==a){let a=r[n];"number"!=typeof a&&(r[n]=a=i.length,i.push(e[s])),o[t][s]=a}}}}i=JSON.parse(JSON.stringify(i));const n=JSON.parse(JSON.stringify(this.sheet_style)),l=JSON.parse(JSON.stringify(this.row_styles)),h=JSON.parse(JSON.stringify(this.column_styles)),c=JSON.parse(JSON.stringify(this.row_pattern)),d=(t={},e={})=>{const s=Object.assign(Object.assign({},e),t);return s.text?(s.text=H.MeasureColorARGB(s.text),s):"number"==typeof s.theme?s:void 0};if(t.export_colors){const t=[];for(const e of[l,h,i,[n],c])if(Array.isArray(e))for(const s of e)t.push(s);else for(const s of Object.keys(e))t.push(e[s]);for(const s of t)s.border_top_fill=d(s.border_top_fill,v.DefaultProperties.border_top_fill),s.border_left_fill=d(s.border_left_fill,v.DefaultProperties.border_top_fill),s.border_right_fill=d(s.border_right_fill,v.DefaultProperties.border_top_fill),s.border_bottom_fill=d(s.border_bottom_fill,v.DefaultProperties.border_top_fill),(null===(e=s.fill)||void 0===e?void 0:e.text)&&(s.fill.text=H.MeasureColorARGB(s.fill.text)),s.text&&s.text.text&&"none"!==s.text.text&&(s.text.text=H.MeasureColorARGB(s.text.text))}const u={calculated_value:!!t.rendered_values,preserve_type:!!t.preserve_type,expand_arrays:!!t.expand_arrays,decorated_cells:!!t.decorated_cells,nested:!0,cell_style_refs:o},m=this.cells.toJSON(u),f=m.data;let{rows:p,columns:_}=m;t.shrink?(p+=2,_+=1):(p=this.rows,_=this.columns);for(const t of this.annotations)t.extent||this.CalculateAnnotationExtent(t),t.extent&&(p=Math.max(p,t.extent.row+1),_=Math.max(_,t.extent.column+1));const g=[];for(let t=0;t<o.length;t++){const e=o[t];if(e)for(let s=0;s<e.length;s++)e[s]&&g.push({row:s,column:t,ref:e[s]})}const y={id:this.id,name:this.name,data:f,sheet_style:n,rows:p,columns:_,cell_styles:g,cell_style_refs:i,row_style:l,column_style:h,row_pattern:c.length?c:void 0,default_row_height:this.default_row_height,default_column_width:this.default_column_width,row_height:s(this.row_height_,this.default_row_height),column_width:s(this.column_width_,this.default_column_width),selection:JSON.parse(JSON.stringify(this.selection)),annotations:JSON.parse(JSON.stringify(this.annotations))};return this.visible||(y.visible=this.visible),(this.scroll_offset.x||this.scroll_offset.y)&&(y.scroll=this.scroll_offset),(this.freeze.rows||this.freeze.columns)&&(y.freeze=this.freeze),y}FlushCellStyles(){this.style_map=[],this.style_json_map=[],this.cells.FlushCellStyles()}ImportData(t){const e=t.styles,s=t.sheet_style;s&&this.UpdateAreaStyle(new r({row:1/0,column:1/0},{row:1/0,column:1/0}),e[s]);const i=t.column_styles;if(i)for(let t=0;t<i.length;t++)i[t]&&this.UpdateAreaStyle(new r({row:1/0,column:t},{row:1/0,column:t}),e[i[t]]);this.cells.FromJSON(t.cells),t.name&&(this.name=t.name||"");const o=this.cell_style;for(const s of t.cells)s.style_ref&&(o[s.column]||(o[s.column]=[]),o[s.column][s.row]=e[s.style_ref]);for(let e=0;e<t.column_widths.length;e++)void 0!==t.column_widths[e]&&this.SetColumnWidth(e,t.column_widths[e]);for(let e=0;e<t.row_heights.length;e++)void 0!==t.row_heights[e]&&this.SetRowHeight(e,t.row_heights[e]);for(const e of t.annotations||[])this.annotations.push(new ut(e));t.hidden&&(this.visible=!1)}CalculateAnnotationExtent(t){var e,s;if(t.layout)return void(t.extent=Object.assign({},t.layout.br.address));t.extent={row:0,column:0};let i=null===(e=t.rect)||void 0===e?void 0:e.right;if(i&&this.default_column_width)for(let e=0;i>=0&&e<1e3;e++)if(i-=this.GetColumnWidth(e),i<0){t.extent.column=e;break}let r=null===(s=t.rect)||void 0===s?void 0:s.bottom;if(r&&this.default_row_height)for(let e=0;r>=0&&e<1e3;e++)if(r-=this.GetRowHeight(e),r<0){t.extent.row=e;break}}UpdateSheetStyle(t,e=!0){this.sheet_style=v.Merge(this.sheet_style,t,e);const s=Object.keys(t);for(const t of this.cell_style)if(t)for(const e of t)e&&s.forEach((t=>delete e[t]));for(const t of Object.keys(this.row_styles))s.forEach((e=>delete this.row_styles[t][e]));for(const t of Object.keys(this.column_styles))s.forEach((e=>delete this.column_styles[t][e]));this.FlushCellStyles()}UpdateRowStyle(t,e,s=!0){this.row_styles[t]=v.Merge(this.row_styles[t]||{},e,s);const i=Object.keys(e);for(const e of this.cell_style)e&&e[t]&&i.forEach((s=>delete e[t][s]));for(let s=0;s<this.cells.columns;s++)if(this.column_styles[s]){const r=this.column_styles[s],o=this.cell_style[s]&&this.cell_style[s][t]||{};for(const t of i)void 0!==r[t]&&(o[t]=e[t]);Object.keys(o).length&&(this.cell_style[s]||(this.cell_style[s]=[]),this.cell_style[s][t]=JSON.parse(JSON.stringify(o)))}this.cells.Apply(this.RealArea(r.FromRow(t)),(t=>t.FlushStyle()))}FlattenStyles(){this.CompositeStyleForCell}UpdateColumnStyle(t,e,s=!0){this.column_styles[t]=v.Merge(this.column_styles[t]||{},e,s);const i=Object.keys(e);if(this.cell_style[t])for(const e of this.cell_style[t])e&&i.forEach((t=>delete e[t]));this.cells.Apply(this.RealArea(r.FromColumn(t)),(t=>t.FlushStyle()))}CompositeStyleForCell(t,e=!0,s=!0){const{row:i,column:r}=t,o=[this.default_style_properties,this.sheet_style];return s&&this.row_pattern.length&&o.push(this.row_pattern[i%this.row_pattern.length]),this.row_styles[i]&&o.push(this.row_styles[i]),this.column_styles[r]&&o.push(this.column_styles[r]),e&&this.cell_style[r]&&this.cell_style[r][i]&&o.push(this.cell_style[r][i]),v.Composite(o)}GetStyleIndex(t){const e=JSON.stringify(t);for(let t=0;t<this.style_json_map.length;t++)if(e===this.style_json_map[t])return t;const s=this.style_map.length;return this.style_map.push(JSON.parse(e)),this.style_json_map.push(e),s}}mt.base_id=100,mt.default_sheet_name="Sheet1";class ft{static CreateDiv(t="",e,s){return this.Create("div",t,e,s)}static Create(t="",e="",s,i){const r=document.createElement(t);return e&&r.setAttribute("class",e),i&&r.setAttribute(i,""),s&&s.appendChild(r),r}}const pt="http://www.w3.org/2000/svg",_t="http://www.w3.org/2000/svg";class gt extends class{constructor(t){this.model=t,this.grid_tiles=[],this.column_header_tiles=[],this.row_header_tiles=[],this.frozen_row_tiles=[],this.frozen_column_tiles=[],this.header_size={width:0,height:0},this.last_column=0,this.total_height=0,this.total_width=0,this.default_row_height=0,this.default_column_width=0,this.header_offset={x:0,y:0},this.dpr=Math.max(1,self.devicePixelRatio||1),this.scale=1,this.trident="undefined"!=typeof navigator&&navigator.userAgent&&/trident/i.test(navigator.userAgent),this.default_tile_size={width:1200,height:800},this.dropdown_caret_visible=!1,this.row_cache=[],this.column_cache=[],this.initialized=!1,this.mask=ft.CreateDiv("treb-mouse-mask"),this.tooltip=ft.CreateDiv("treb-tooltip"),this.dropdown_caret=document.createElementNS(pt,"svg"),this.dropdown_caret.setAttribute("class","treb-dropdown-caret"),this.dropdown_caret.setAttribute("viewBox","0 0 24 24"),this.dropdown_caret.tabIndex=-1;const e=document.createElementNS(pt,"path");e.setAttribute("d","M5,7 L12,17 L19,7"),this.dropdown_caret.appendChild(e),this.dropdown_caret.addEventListener("click",(t=>{t.stopPropagation(),t.preventDefault(),this.grid_cover.classList.remove("nub-select");const e=this.dropdown_caret.getAttribute("class")||"";/active/i.test(e)?this.dropdown_caret.setAttribute("class","treb-dropdown-caret"):(this.dropdown_caret.setAttribute("class","treb-dropdown-caret active"),this.dropdown_list.focus())})),this.dropdown_list=ft.CreateDiv("treb-dropdown-list"),this.dropdown_list.setAttribute("tabindex","-1"),this.dropdown_list.addEventListener("keydown",(t=>{var e;let s=0;switch(t.key){case"ArrowDown":s=1;break;case"ArrowUp":s=-1;break;case"Escape":case"Enter":break;default:return void console.info(t.key)}if(t.stopPropagation(),t.preventDefault(),"Escape"===t.key||"Enter"===t.key)null===(e=this.container)||void 0===e||e.focus(),this.dropdown_caret.setAttribute("class","treb-dropdown-caret"),"Enter"===t.key&&this.dropdown_callback&&this.dropdown_selected&&this.dropdown_callback.call(0,this.dropdown_selected.dropdown_value);else if(s&&this.dropdown_selected)if(s>0&&this.dropdown_selected.nextSibling){this.dropdown_selected.nextSibling.classList.add("selected"),this.dropdown_selected.classList.remove("selected"),this.dropdown_selected=this.dropdown_selected.nextSibling;const t=this.dropdown_selected.offsetTop+this.dropdown_selected.offsetHeight;t>this.dropdown_list.offsetHeight+this.dropdown_list.scrollTop&&(this.dropdown_list.scrollTop=t-this.dropdown_list.offsetHeight)}else s<0&&this.dropdown_selected.previousSibling&&(this.dropdown_selected.previousSibling.classList.add("selected"),this.dropdown_selected.classList.remove("selected"),this.dropdown_selected=this.dropdown_selected.previousSibling,this.dropdown_selected.offsetTop<this.dropdown_list.scrollTop&&(this.dropdown_list.scrollTop=this.dropdown_selected.offsetTop))})),this.dropdown_list.addEventListener("mousedown",(t=>{var e;const s=t.target;t.target!==this.dropdown_list&&(t.stopPropagation(),t.preventDefault(),null===(e=this.container)||void 0===e||e.focus(),this.dropdown_caret.setAttribute("class","treb-dropdown-caret"),this.dropdown_callback&&this.dropdown_callback.call(0,s.dropdown_value))})),this.dropdown_list.addEventListener("mousemove",(t=>{const e=t.target;e!==this.dropdown_selected&&(this.grid_cover.classList.remove("nub-select"),this.dropdown_selected&&this.dropdown_selected.classList.remove("selected"),e.classList.add("selected"),this.dropdown_selected=e)})),this.mock_selection=ft.CreateDiv("mock-selection-node"),this.mock_selection.innerHTML="&nbsp;",this.note_node=ft.CreateDiv("treb-note"),this.title_node=ft.CreateDiv("treb-hover-title"),this.HideNote()}get scroll_offset(){return this.scroll_reference_node?{x:this.scroll_reference_node.scrollLeft,y:this.scroll_reference_node.scrollTop}:{x:0,y:0}}set scroll_offset(t){this.scroll_reference_node&&(this.scroll_reference_node.scrollLeft=t.x,this.scroll_reference_node.scrollTop=t.y)}ColumnWidth(t){return Math.round(this.model.active_sheet.GetColumnWidth(t)*this.scale)}RowHeight(t){return Math.round(this.model.active_sheet.GetRowHeight(t)*this.scale)}SetRowHeight(t,e){this.model.active_sheet.SetRowHeight(t,Math.round(e/this.scale))}SetColumnWidth(t,e){this.model.active_sheet.SetColumnWidth(t,Math.round(e/this.scale))}ShowSelections(t=!0){this.grid_selection.style.display=t?"block":"none"}HideTitle(){this.title_node.style.opacity="0"}ShowTitle(t,e,s){if(this.title_node.textContent=t,!this.title_node.parentElement)return;this.title_node.getBoundingClientRect();const i=this.title_node.parentElement.getBoundingClientRect(),r=this.OffsetCellAddressToRectangle(e).Shift(this.header_size.width,this.header_size.height);this.title_node.style.left=i.left+r.left-this.scroll_reference_node.scrollLeft+0+"px",this.title_node.style.top=i.top+r.bottom-this.scroll_reference_node.scrollTop+8+"px",this.title_node.style.opacity="1"}HideNote(){this.note_node.style.opacity="0",this.note_node.style.pointerEvents="none"}ShowNote(t,e,s){if(this.note_node.textContent=t,!this.note_node.parentElement)return;const i=this.note_node.getBoundingClientRect(),r=this.note_node.parentElement.getBoundingClientRect(),o=this.OffsetCellAddressToRectangle(e).Shift(this.header_size.width,this.header_size.height);this.note_node.style.left=r.left+o.right-this.scroll_reference_node.scrollLeft+8+"px",this.note_node.style.top=r.top+o.top-this.scroll_reference_node.scrollTop-i.height/5-2+"px",this.note_node.style.opacity="1",this.note_node.style.pointerEvents="auto"}AnnotationLayoutOrder(t,e){var s;let i=-1;for(let e=0;e<this.model.active_sheet.annotations.length;e++)if(this.model.active_sheet.annotations[e]===t){i=e;break}if(i<0)return!1;const r=Math.min(Math.max(0,i+e),this.model.active_sheet.annotations.length-1);if(r===i)return!1;this.model.active_sheet.annotations.splice(i,1),this.model.active_sheet.annotations.splice(r,0,t);for(let t=0;t<this.model.active_sheet.annotations.length;t++){const e=this.model.active_sheet.annotations[t].key,i=null===(s=this.container)||void 0===s?void 0:s.querySelectorAll(`.annotation[data-key="${e}"]`);if(i)for(let e=0;e<(null==i?void 0:i.length);e++)i[e].style.zIndex=(t+1).toString()}return!0}PointToAnnotationCorner(t){const e=this.PointToAddress_Grid(t,void 0,!1),s=this.CellAddressToRectangle(e);return{address:e,offset:{x:(t.x-s.left)/s.width,y:(t.y-s.top)/s.height}}}RectToAnnotationLayout(t){return{tl:this.PointToAnnotationCorner({x:(t.left||0)+1,y:(t.top||0)+1}),br:this.PointToAnnotationCorner({x:t.right||t.left||100,y:t.bottom||t.top||100})}}AddressToAnnotationLayout(t,e){const s={tl:this.CellAddressToRectangle(t),br:this.CellAddressToRectangle(e)};return{tl:this.PointToAnnotationCorner({x:s.tl.left||0,y:s.tl.top||0}),br:this.PointToAnnotationCorner({x:s.br.right||s.tl.left||100,y:s.br.bottom||s.tl.left||100})}}AnnotationLayoutToRect(t){const e=this.CellAddressToRectangle(t.tl.address),s=this.CellAddressToRectangle(t.br.address),i=e.left+e.width*t.tl.offset.x-1,r=e.top+e.height*t.tl.offset.y-1;return new y(i,r,s.left+s.width*t.br.offset.x-i,s.top+s.height*t.br.offset.y-r)}UpdateAnnotation(t){Array.isArray(t)||(t=[t]);for(const e of t)if(e.node){if(e.node.dataset.scale=this.scale.toString(),e.node.style.fontSize=10*this.scale+"pt",e.rect&&!e.layout&&(e.scaled_rect=e.rect.Scale(this.scale),e.layout=this.RectToAnnotationLayout(e.scaled_rect)),e.layout){const t=this.AnnotationLayoutToRect(e.layout);t.ApplyStyle(e.node),e.scaled_rect=t}e.node.dataset.key=e.key.toString(),(this.model.active_sheet.freeze.rows||this.model.active_sheet.freeze.columns)&&this.CloneFrozenAnnotation(e)}}GetFrozenAnnotations(t){return[this.row_header_annotations,this.column_header_annotations,this.corner_annotations].map((e=>e.querySelector(`.annotation[data-key="${t.key}"]`))).filter((t=>null!==t))}CloneFrozenAnnotations(){for(const t of this.model.active_sheet.annotations)t.node&&t.key&&this.CloneFrozenAnnotation(t)}ClearFrozenAnnotations(){var t;for(const e of[this.row_header_annotations,this.column_header_annotations,this.corner_annotations]){const s=e.querySelectorAll(".annotation");for(let e=0;e<s.length;e++)null===(t=s[e].parentElement)||void 0===t||t.removeChild(s[e])}}RemoveFrozenAnnotation(t){var e;for(const s of[this.row_header_annotations,this.column_header_annotations,this.corner_annotations]){const i=s.querySelector(`.annotation[data-key="${t.key}"]`);i&&(null===(e=i.parentElement)||void 0===e||e.removeChild(i))}}CloneFrozenAnnotation(t){var e,s;for(const i of[this.row_header_annotations,this.column_header_annotations,this.corner_annotations]){let r=i.querySelector(`.annotation[data-key="${t.key}"]`);if(r&&(null===(e=r.parentElement)||void 0===e||e.removeChild(r)),r=null===(s=t.node)||void 0===s?void 0:s.cloneNode(!0),r){const e=r.querySelector(".annotation-move-target"),s=r.querySelector(".annotation-resize-target");r.addEventListener("mousedown",(i=>{const r=t.node;requestAnimationFrame((()=>{null==r||r.focus()})),this.AnnotationMouseDown(t,t.node,i,e,s)})),i.appendChild(r)}}}RemoveAnnotation(t){var e;t.node&&(null===(e=t.node.parentElement)||void 0===e||e.removeChild(t.node)),this.RemoveFrozenAnnotation(t)}RemoveAnnotationNodes(){const t=Array.prototype.map.call(this.annotation_container.children,(t=>t));for(const e of t)this.annotation_container.removeChild(e);(this.model.active_sheet.freeze.rows||this.model.active_sheet.freeze.columns)&&this.ClearFrozenAnnotations()}AddAnnotation(t){if(!t.node)throw new Error("annotation node missing");this.annotation_container.appendChild(t.node),this.UpdateAnnotation(t)}AnnotationMouseDown(t,e,s,i,r){const o=t.scaled_rect;return o?new Promise((a=>{var n;const l={left:o.left,top:o.top,width:o.width,height:o.height},h=this.scroll_reference_node,c=h.getBoundingClientRect(),d=e.getBoundingClientRect();if(s.target!==i)if(s.target!==r)a();else{s.stopPropagation(),s.preventDefault(),e.focus();let i=0;(null===(n=t.data)||void 0===n?void 0:n.original_size)&&t.data.original_size.width&&t.data.original_size.height&&(i=t.data.original_size.width/t.data.original_size.height);const h=e.getBoundingClientRect(),c={x:h.left+s.offsetX-o.width+r.offsetLeft,y:h.top+s.offsetY-o.height+r.offsetTop};ht(this.mask,"nw-resize",(s=>{const r=[e,...this.GetFrozenAnnotations(t)];if(o.height=s.offsetY-c.y,o.width=s.offsetX-c.x,s.shiftKey&&s.ctrlKey)i&&(Math.abs(o.width-l.width)<Math.abs(o.height-l.height)?o.width=i*o.height:o.height=o.width/i);else if(s.shiftKey)Math.abs(o.height-l.height)>Math.abs(o.width-l.width)?o.width=l.width:o.height=l.height;else if(s.ctrlKey){const t=this.ClampToGrid({x:o.right,y:o.bottom});o.width=t.x-o.left+1,o.height=t.y-o.top+1}for(const t of r)t.style.height=o.height+"px",t.style.width=o.width+"px"}),(()=>{t.extent=void 0,t.layout=this.RectToAnnotationLayout(o),a({type:"annotation",annotation:t,event:"resize"})}))}else{s.stopPropagation(),s.preventDefault(),e.focus();const i={x:d.left+s.offsetX-o.left,y:d.top+s.offsetY-o.top},r=[e,...this.GetFrozenAnnotations(t)],n=25,u=this.CellAddressToRectangle({row:0,column:0}).Combine(this.CellAddressToRectangle({row:this.model.active_sheet.rows-1,column:this.model.active_sheet.columns-1})).Expand(-1,-1);ht(this.mask,"move",(t=>{if(t.offsetY-c.top<this.header_offset.y){const t=Math.min(n,h.scrollTop);h.scrollTop-=t,i.y+=t}else if(t.offsetY-c.top>=c.height&&h.scrollTop+c.height<u.height){const t=n;h.scrollTop+=t,i.y-=t}if(t.offsetX-c.left<this.header_offset.x){const t=Math.min(n,h.scrollLeft);h.scrollLeft-=t,i.x+=t}else if(t.offsetX-c.left>=c.width&&h.scrollLeft+c.width<u.width){const t=n;h.scrollLeft+=t,i.x-=t}if(o.top=t.offsetY-i.y,o.left=t.offsetX-i.x,t.shiftKey&&(Math.abs(o.left-l.left)<=Math.abs(o.top-l.top)?o.left=l.left:o.top=l.top),t.ctrlKey){const t=this.ClampToGrid({x:o.left,y:o.top});o.left=t.x,o.top=t.y}for(const t of r)t.style.top=o.top+"px",t.style.left=o.left+"px"}),(()=>{t.extent=void 0,t.layout=this.RectToAnnotationLayout(o),a({type:"annotation",annotation:t,event:"move"})}))}})):(console.info("missing scaled rect!"),Promise.reject())}Initialize(t,e,s,i=!0){this.mask.parentElement||t.appendChild(this.mask),this.tooltip.parentElement||t.appendChild(this.tooltip),this.dropdown_caret.parentElement||t.appendChild(this.dropdown_caret),this.dropdown_list.parentElement||t.appendChild(this.dropdown_list),this.note_node.parentElement||t.appendChild(this.note_node),this.title_node.parentElement||t.appendChild(this.title_node),this.InitializeInternal(t,e),!i&&this.scroll_reference_node&&(this.scroll_reference_node.style.overflow="hidden"),this.dropdown_callback=s,this.initialized=!0}MockSelection(){if(!this.container)return;if(this.trident)return;const t=window.getSelection();if(t){const e=document.createRange();e.selectNodeContents(this.mock_selection),t.removeAllRanges(),t.addRange(e)}}CreateTile(t,e,s,i,r,o,a,n=!0){const l=document.createElement("canvas");return l.setAttribute("class",t),l.logical_size=e,l.width=e.width*this.dpr,l.height=e.height*this.dpr,l.style.width=`${e.width}px`,l.style.height=`${e.height}px`,l.tile_position=s,l.first_cell=i,this.UpdateTileGridPosition(l),l.last_cell={row:i.row+r.rows-1,column:i.column+r.columns-1},l.pixel_start=o,l.pixel_end={x:o.x+e.width,y:o.y+e.height},l.dirty=!!n,l.needs_full_repaint=!0,a.appendChild(l),l}ApplyTheme(t){var e,s;this.row_header.style.backgroundColor=this.column_header.style.backgroundColor=this.corner.style.backgroundColor=(null===(e=t.headers)||void 0===e?void 0:e.fill)?C(t,t.headers.fill):"",this.corner.style.borderColor=t.grid_color||"";for(const e of this.grid_tiles)for(const i of e)i.style.backgroundColor=C(t,null===(s=t.grid_cell)||void 0===s?void 0:s.fill)||"#fff";this.dropdown_list.style.font=v.Font(t.grid_cell||{})}UpdateTotalSize(){this.total_height=0;const t=this.model.active_sheet.rows;for(let e=0;e<t;e++)this.total_height+=this.RowHeight(e);this.total_width=0;const e=this.model.active_sheet.columns;for(let t=0;t<e;t++)this.total_width+=this.ColumnWidth(t)}UpdateContentsSize(){const t=this.row_header_tiles.reduce(((t,e)=>t+e.logical_size.height),0),e=this.column_header_tiles.reduce(((t,e)=>t+e.logical_size.width),0);this.column_header.style.width=this.contents.style.width=`${e}px`,this.row_header.style.height=this.contents.style.height=`${t}px`}HideTooltip(){this.tooltip.style.display="none",this.tooltip_state=void 0,this.tooltip.classList.remove("arrow-up"),this.tooltip.classList.remove("arrow-left")}ShowTooltip(t={}){t.up?(this.tooltip.classList.add("arrow-up"),this.tooltip_state="up"):t.left&&(this.tooltip.classList.add("arrow-left"),this.tooltip_state="left"),this.tooltip.style.display="block",this.UpdateTooltip(t)}ShowDropdownCaret(t,e,s){let i=this.OffsetCellAddressToRectangle(t.start);t.count>1&&(i=i.Combine(this.OffsetCellAddressToRectangle(t.end))),i=i.Shift(this.header_size.width,this.header_size.height);const r=Math.round(this.scale*Math.max(8,Math.min(20,i.height)));this.dropdown_caret.style.height=`${r}px`,this.dropdown_caret.style.width=`${r}px`,this.dropdown_caret.style.left=`${i.right+1}px`,this.dropdown_caret.style.top=i.bottom-r+"px",this.dropdown_list.style.top=`${i.bottom+2}px`,this.dropdown_list.style.left=`${i.left+2}px`,this.dropdown_list.style.minWidth=`${i.width}px`,this.dropdown_list.textContent="";for(const t of e){const e=ft.CreateDiv(void 0,this.dropdown_list);s===t&&(this.dropdown_selected=e,e.classList.add("selected")),e.dropdown_value=t,e.textContent=(null==t?void 0:t.toString())||""}this.dropdown_caret.setAttribute("class","treb-dropdown-caret"),this.dropdown_caret.style.display="block",this.dropdown_caret_visible=!0}HideDropdownCaret(){this.dropdown_caret_visible&&(this.dropdown_caret.setAttribute("class","treb-dropdown-caret"),this.dropdown_caret_visible=!1,this.dropdown_caret.style.display="none")}GetScrollOffset(){return{x:this.scroll_reference_node.scrollLeft+this.header_offset.x,y:this.scroll_reference_node.scrollTop+this.header_offset.y}}ScrollTo(t,e=!0,s=!0){const i=this.CellAddressToRectangle(t);s&&(this.scroll_reference_node.scrollTop=i.top),e&&(this.scroll_reference_node.scrollLeft=i.left)}ScrollIntoView(t){const e=this.CellAddressToRectangle(t),s=this.scroll_reference_node.clientWidth-this.row_header.offsetWidth,i=this.scroll_reference_node.clientHeight-this.column_header.offsetHeight,r={x:0,y:0},o={x:!1,y:!1},a=new y(this.scroll_reference_node.scrollLeft,this.scroll_reference_node.scrollTop,s,i);(this.model.active_sheet.freeze.rows||this.model.active_sheet.freeze.columns)&&(this.model.active_sheet.freeze.rows&&t.row>=this.model.active_sheet.freeze.rows?r.y=this.frozen_row_tiles[0].logical_size.height:this.model.active_sheet.freeze.rows&&(o.y=!0),this.model.active_sheet.freeze.columns&&t.column>=this.model.active_sheet.freeze.columns?r.x=this.frozen_column_tiles[0].logical_size.width:this.model.active_sheet.freeze.columns&&(o.x=!0)),t.row!==1/0&&(e.top<a.top+r.y&&!o.y?this.scroll_reference_node.scrollTop=e.top-r.y:e.bottom>a.bottom&&(this.scroll_reference_node.scrollTop=e.bottom-i)),t.column!==1/0&&(e.left<a.left+r.x&&!o.x?this.scroll_reference_node.scrollLeft=e.left-r.x:e.right>a.right&&(this.scroll_reference_node.scrollLeft=e.right-s))}UpdateTooltip(t={}){if(void 0!==t.text&&(this.tooltip.textContent=t.text),void 0!==t.x){let e=t.x||0;"up"===this.tooltip_state&&(e-=this.tooltip.offsetWidth/2),this.tooltip.style.left=Math.round(e)+"px"}if(void 0!==t.y){let e=t.y||0;"left"===this.tooltip_state&&(e-=this.tooltip.offsetHeight/2),this.tooltip.style.top=Math.round(e)+"px"}}CoordinateToRowHeader(t){const e={column:1/0,row:0};if(this.model.active_sheet.freeze.rows&&this.frozen_row_tiles[0].pixel_end.y>=t-this.scroll_reference_node.scrollTop){let s=0;t-=this.scroll_reference_node.scrollTop;for(let i=0;i<this.model.active_sheet.freeze.rows;i++)if(s+=this.RowHeight(i),s>=t)return e.row=i,e}for(const s of this.row_header_tiles)if(s.pixel_end.y>=t){let i=t-s.pixel_start.y,r=0;for(e.row=s.first_cell.row;e.row<=s.last_cell.row;e.row++,i-=r)if(r=this.RowHeight(e.row),r>i)return e;return e}return e}CoordinateToColumnHeader(t){const e={row:1/0,column:0};if(this.model.active_sheet.freeze.columns&&this.frozen_column_tiles[0].pixel_end.x>=t-this.scroll_reference_node.scrollLeft){let s=0;t-=this.scroll_reference_node.scrollLeft;for(let i=0;i<this.model.active_sheet.freeze.columns;i++)if(s+=this.ColumnWidth(i),s>=t)return e.column=i,e}for(const s of this.column_header_tiles)if(s.pixel_end.x>=t){let i=t-s.pixel_start.x,r=0;for(e.column=s.first_cell.column;e.column<=s.last_cell.column;e.column++,i-=r)if(r=this.ColumnWidth(e.column),r>i)return e;return e}return e}PointToAddress_Grid(t,e=!1,s=!0){if(s){if(this.model.active_sheet.freeze.rows){const e=this.frozen_row_tiles[0].logical_size.height;t.y-this.scroll_reference_node.scrollTop<e&&(t.y-=this.scroll_reference_node.scrollTop)}if(this.model.active_sheet.freeze.columns){const e=this.frozen_column_tiles[0].logical_size.width;t.x-this.scroll_reference_node.scrollLeft<e&&(t.x-=this.scroll_reference_node.scrollLeft)}}const i={row:0,column:0};for(const e of this.grid_tiles)if(e[0].pixel_start.x<=t.x&&e[0].pixel_end.x>=t.x){for(const s of e)if(s.pixel_start.y<=t.y&&s.pixel_end.y>=t.y){let e=t.x-s.pixel_start.x,r=t.y-s.pixel_start.y,o=0,a=0;for(i.row=s.first_cell.row,i.column=s.first_cell.column;i.column<=s.last_cell.column;i.column++,e-=o)if(o=this.ColumnWidth(i.column),o>e){for(;i.row<=s.last_cell.row;i.row++,r-=a)if(a=this.RowHeight(i.row),a>r)return i;return i}}return i}return i}AdjacentTile(t,e=0,s=0){if(!e&&!s)return t;const i=t.tile_position,r=t.tile_position.row+e,o=t.tile_position.column+s;return r<0||o<0?void 0:this.grid_tiles[i.column]&&this.grid_tiles[i.column][i.row]===t&&this.grid_tiles[o]?this.grid_tiles[o][r]:i.column||this.frozen_column_tiles[i.row]!==t?i.row||this.frozen_row_tiles[i.column]!==t?void 0:this.frozen_row_tiles[o]:this.frozen_column_tiles[r]}UpdateTiles(){if(!this.container)throw new Error("invalid container");this.grid_tiles.forEach((t=>{t.forEach((t=>{t.parentElement&&t.parentElement.removeChild(t)}))}));for(const t of[this.column_header_tiles,this.row_header_tiles,this.frozen_row_tiles,this.frozen_column_tiles])for(const e of t)e.parentElement&&e.parentElement.removeChild(e);this.frozen_row_tiles=[],this.frozen_column_tiles=[],this.row_header_tiles=[],this.column_header_tiles=[],this.grid_tiles=[];const t=this.model.active_sheet;this.default_row_height=Math.round(t.default_row_height*this.scale),this.default_column_width=Math.round(t.default_column_width*this.scale),this.header_offset={x:Math.round(t.header_offset.x*this.scale),y:Math.round(t.header_offset.y*this.scale)},this.UpdateContainingGrid();let e=this.model.active_sheet.rows,s=this.model.active_sheet.columns;e||(e=100),s||(s=40);let i=0,r=0;for(let t=0;t<e;t++)i+=this.RowHeight(t);for(let t=0;t<s;t++)r+=this.ColumnWidth(t);if(!r||!i)throw"unexpected missing total size";if(i||(i=this.default_row_height*e),r||(r=this.default_column_width*s),this.container.offsetWidth>r){const t=Math.ceil((this.container.offsetWidth-r)/this.default_column_width);r+=t*this.default_column_width,s+=t}if(this.last_column=s,this.container.offsetHeight>i){const t=Math.ceil((this.container.offsetHeight-i)/this.default_row_height);i+=t*this.default_row_height,e+=t}this.column_header.style.width=this.contents.style.width=`${r}px`,this.row_header.style.height=this.contents.style.height=`${i}px`;const o=[],a=[];let n=0,l=0;for(let t=0;t<s;t++){const e=this.ColumnWidth(t);n&&n+e>this.default_tile_size.width&&(o.push(n),a.push(l),l=t,n=0),n+=e}o.push(n),a.push(l);const h=[],c=[];let d=0,u=0;for(let t=0;t<e;t++){const e=this.RowHeight(t);d&&d+e>this.default_tile_size.height&&(h.push(d),c.push(u),d=0,u=t),d+=e}h.push(d),c.push(u);const m=o.length,f=h.length;let p=0,_=0,g=0,y=0;for(let t=0;t<this.model.active_sheet.freeze.rows;t++)g+=this.RowHeight(t);for(let t=0;t<this.model.active_sheet.freeze.columns;t++)y+=this.ColumnWidth(t);for(let t=0;t<m;t++){const i=[];p=0;const r=t===m-1?s-a[t]:a[t+1]-a[t];this.column_header_tiles.push(this.CreateTile("column-header-tile",{height:this.header_offset.y,width:o[t]},{row:0,column:t},{row:0,column:a[t]},{rows:0,columns:r},{x:_,y:0},this.column_header)),this.model.active_sheet.freeze.rows&&this.frozen_row_tiles.push(this.CreateTile("frozen-row-tile",{height:g,width:o[t]},{row:1,column:t},{row:0,column:a[t]},{rows:0,columns:r},{x:_,y:0},this.column_header));for(let s=0;s<f;s++){const n=s===f-1?e-c[s]:c[s+1]-c[s];t||(this.row_header_tiles.push(this.CreateTile("row-header-tile",{height:h[s],width:this.header_offset.x},{row:s,column:0},{row:c[s],column:0},{rows:n,columns:1},{x:0,y:p},this.row_header)),this.model.active_sheet.freeze.columns&&this.frozen_column_tiles.push(this.CreateTile("frozen-column-tile",{height:h[s],width:y},{row:s,column:1},{row:c[s],column:0},{rows:n,columns:1},{x:0,y:p},this.row_header))),i.push(this.CreateTile("grid-tile",{height:h[s],width:o[t]},{row:s,column:t},{row:c[s],column:a[t]},{rows:n,columns:r},{x:_,y:p},this.contents)),p+=h[s]}this.grid_tiles.push(i),_+=o[t]}this.total_height=i,this.total_width=r,this.ClearLayoutCaches(),this.UpdateGridTemplates(!0,!0)}ClearLayoutCaches(){this.row_cache=[],this.column_cache=[]}TileIndexForColumn(t){for(const e of this.column_header_tiles)if(e.first_cell.column<=t&&e.last_cell.column>=t)return e.tile_position.column;return-1}TileIndexForRow(t){for(const e of this.row_header_tiles)if(e.first_cell.row<=t&&e.last_cell.row>=t)return e.tile_position.row;return-1}DirtyHeaders(t){if(t){for(const e of this.column_header_tiles){if(e.dirty)continue;const s=new r({row:t.start.row,column:e.first_cell.column},{row:t.start.row,column:e.last_cell.column});(t.entire_row||s.Intersects(t))&&(e.dirty=!0)}for(const e of this.row_header_tiles){if(e.dirty)continue;const s=new r({column:t.start.column,row:e.first_cell.row},{column:t.start.column,row:e.last_cell.row});(t.entire_column||s.Intersects(t))&&(e.dirty=!0)}}}DirtyAll(){for(const t of this.grid_tiles)for(const e of t)e.dirty=!0}DirtyArea(t){if(!this.initialized)return;const e={row:0,column:0},s={row:this.grid_tiles[0].length-1,column:this.grid_tiles.length-1};t.start.column!==1/0&&(e.column=s.column=this.TileIndexForColumn(t.start.column),t.end.column!==t.start.column&&(s.column=this.TileIndexForColumn(t.end.column))),t.start.row!==1/0&&(e.row=s.row=this.TileIndexForRow(t.start.row),t.end.row!==t.start.row&&(s.row=this.TileIndexForRow(t.end.row)));for(let t=e.column;t<=s.column;t++)for(let i=e.row;i<=s.row;i++)this.grid_tiles[t][i].dirty=!0}VisibleTiles(){const t=[{row:0,column:0},{row:0,column:0}];if(!this.container||!this.grid_tiles.length||!this.grid_tiles[0].length)return new r(t[0],t[1]);const e=this.scroll_reference_node.scrollLeft,s=e+this.scroll_reference_node.offsetWidth,i=this.scroll_reference_node.scrollTop,o=i+this.scroll_reference_node.offsetHeight;for(const a of this.grid_tiles){let n=a[0];if(n.pixel_start.x<=e&&n.pixel_end.x>=e)for(n of a)if(n.pixel_start.y<=i&&n.pixel_end.y>=i){t[0]=n.tile_position;break}if(a===this.grid_tiles[this.grid_tiles.length-1]||n.pixel_start.x<=s&&n.pixel_end.x>=s)for(n of a)if(n===a[a.length-1]||n.pixel_start.y<=o&&n.pixel_end.y>=o)return t[1]=n.tile_position,new r(t[0],t[1])}return new r(t[0],t[1])}UpdateTileHeights(t=!0,e=-1){let s=0;for(let i=0;i<this.row_header_tiles.length;i++){const r=this.row_header_tiles[i];if(e>r.last_cell.row){s+=r.logical_size.height;continue}let o=0;for(let t=r.first_cell.row;t<=r.last_cell.row;t++)o+=this.RowHeight(t);const a=r.logical_size.height===o;if(r.pixel_start.y=s,s+=o,r.pixel_end.y=s,!a){if(r.logical_size.height=o,r.style.height=`${o}px`,r.height=this.dpr*o,this.model.active_sheet.freeze.columns){const t=this.frozen_column_tiles[i];t.logical_size.height=o,t.style.height=`${o}px`,t.height=this.dpr*o}t&&(r.dirty=!0,r.needs_full_repaint=!0)}for(const e of this.grid_tiles){const s=e[i];s.pixel_start.y=r.pixel_start.y,s.pixel_end.y=r.pixel_end.y,a||(s.logical_size.height=o,s.style.height=`${o}px`,s.height=this.dpr*o,t&&(s.dirty=!0,s.needs_full_repaint=!0))}}if(this.model.active_sheet.freeze.rows){let t=0;for(let e=0;e<this.model.active_sheet.freeze.rows;e++)t+=this.RowHeight(e);for(const e of this.frozen_row_tiles)e.style.height=`${t}px`,e.height=t*this.dpr;t+=this.header_offset.y,this.corner_canvas.style.height=`${t}px`,this.corner_canvas.height=t*this.dpr;for(const t of this.grid_tiles)t[0].dirty=!0}this.UpdateGridTemplates(!1,!0),this.row_header.style.height=this.contents.style.height=`${s}px`,this.ClearLayoutCaches()}UpdateTileWidths(t=!0,e=-1){let s=0;for(let i=0;i<this.column_header_tiles.length;i++){const r=this.column_header_tiles[i],o=this.grid_tiles[i];if(e>r.last_cell.column){s+=r.logical_size.width;continue}let a=0;for(let t=r.first_cell.column;t<=r.last_cell.column;t++)a+=this.ColumnWidth(t);const n=r.logical_size.width===a;if(r.pixel_start.x=s,s+=a,r.pixel_end.x=s,!n){if(r.logical_size.width=a,r.style.width=`${a}px`,r.width=this.dpr*a,this.model.active_sheet.freeze.rows){const t=this.frozen_row_tiles[i];t.logical_size.width=a,t.style.width=`${a}px`,t.width=this.dpr*a}t&&(r.dirty=!0,r.needs_full_repaint=!0)}for(const e of o)e.pixel_start.x=r.pixel_start.x,e.pixel_end.x=r.pixel_end.x,n||(e.logical_size.width=a,e.style.width=`${a}px`,e.width=this.dpr*a,t&&(e.dirty=!0,e.needs_full_repaint=!0))}if(this.model.active_sheet.freeze.columns){let t=0;for(let e=0;e<this.model.active_sheet.freeze.columns;e++)t+=this.ColumnWidth(e);for(const e of this.frozen_column_tiles)e.style.width=`${t}px`,e.width=t*this.dpr;t+=this.header_offset.x,this.corner_canvas.style.width=`${t}px`,this.corner_canvas.width=t*this.dpr;for(const t of this.grid_tiles[0])t.dirty=!0}this.UpdateGridTemplates(!0,!1),this.column_header.style.width=this.contents.style.width=`${s}px`,this.ClearLayoutCaches()}ClampToGrid(t){const e=this.PointToAddress_Grid(t),s=this.OffsetCellAddressToRectangle(e);return t.x>s.left+s.width/2?t.x=s.left+s.width-1:t.x=s.left-1,t.y>s.top+s.height/2?t.y=s.top+s.height-1:t.y=s.top-1,t}OffsetCellAddressToRectangle(t){let e=this.CellAddressToRectangle(t);return t.column>=0&&t.column<this.model.active_sheet.freeze.columns&&(e=e.Shift(this.scroll_reference_node.scrollLeft,0)),t.row>=0&&t.row<this.model.active_sheet.freeze.rows&&(e=e.Shift(0,this.scroll_reference_node.scrollTop)),e}CellAddressToRectangle(t){const e=t.row===1/0||t.row<0?0:t.row,s=t.column===1/0||t.column<0?0:t.column;if(this.column_cache.length<=s+1){this.column_cache.length||(this.column_cache[0]=0);for(let t=this.column_cache.length-1;t<=s;t++)this.column_cache[t+1]=this.column_cache[t]+this.ColumnWidth(t)}if(this.row_cache.length<=e+1){this.row_cache.length||(this.row_cache[0]=0);for(let t=this.row_cache.length-1;t<=e;t++)this.row_cache[t+1]=this.row_cache[t]+this.RowHeight(t)}const i=this.column_cache[s],r=this.row_cache[e];return new y(i,r,this.column_cache[s+1]-i,this.row_cache[e+1]-r)}ResizeTileWidth(t,e,s=!0){let i=this.column_header_tiles[t];const r=e-i.logical_size.width;i.logical_size.width=e,i.style.width=`${e}px`,i.width=this.dpr*e,i.pixel_end.x+=r,s&&(i.dirty=!0,i.needs_full_repaint=!0);for(let e=t+1;e<this.column_header_tiles.length;e++){this.column_header_tiles[e].pixel_start.x+=r,this.column_header_tiles[e].pixel_end.x+=r;for(const t of this.grid_tiles[e])t.pixel_start.x+=r,t.pixel_end.x+=r}const o=this.grid_tiles[t];for(i of o)i.logical_size.width=e,i.style.width=`${e}px`,i.width=this.dpr*e,i.pixel_end.x+=r,s&&(i.dirty=!0,i.needs_full_repaint=!0);this.UpdateTotalSize(),this.UpdateGridTemplates(!0,!1),this.UpdateContentsSize()}ResizeTileHeight(t,e,s=!0){let i=this.row_header_tiles[t];const r=e-i.logical_size.height;i.logical_size.height=e,i.style.height=`${e}px`,i.height=this.dpr*e,i.pixel_end.y+=r,s&&(i.dirty=!0,i.needs_full_repaint=!0);for(let e=t+1;e<this.row_header_tiles.length;e++)i=this.row_header_tiles[e],i.pixel_start.y+=r,i.pixel_end.y+=r;for(const o of this.grid_tiles){i=o[t],i.logical_size.height=e,i.style.height=`${e}px`,i.height=this.dpr*e,i.pixel_end.y+=r,s&&(i.dirty=!0,i.needs_full_repaint=!0);for(let e=t+1;e<o.length;e++)o[e].pixel_start.y+=r,o[e].pixel_end.y+=r}this.UpdateTotalSize(),this.UpdateGridTemplates(!1,!0),this.UpdateContentsSize()}}{constructor(t){super(t),this.column_header=ft.CreateDiv("top-header"),this.row_header=ft.CreateDiv("left-header"),this.corner=ft.CreateDiv("corner"),this.corner_canvas=document.createElement("canvas"),this.corner.appendChild(this.corner_canvas),this.contents=ft.CreateDiv("contents"),this.grid_selection=document.createElementNS(_t,"svg"),this.grid_selection.classList.add("grid-selection"),this.contents.appendChild(this.grid_selection),this.row_header_selection=document.createElementNS(_t,"svg"),this.row_header_selection.classList.add("frozen-selection"),this.row_header_selection.classList.add("frozen-selection-rows"),this.column_header.appendChild(this.row_header_selection),this.row_header_annotations=ft.CreateDiv("frozen-annotation-container frozen-annotation-container-rows",this.column_header),this.column_header_selection=document.createElementNS(_t,"svg"),this.column_header_selection.classList.add("frozen-selection"),this.column_header_selection.classList.add("frozen-selection-columns"),this.row_header.appendChild(this.column_header_selection),this.column_header_annotations=ft.CreateDiv("frozen-annotation-container frozen-annotation-container-columns",this.row_header),this.corner_selection=document.createElementNS(_t,"svg"),this.corner_selection.classList.add("frozen-selection"),this.corner.appendChild(this.corner_selection),this.corner_annotations=ft.CreateDiv("frozen-annotation-container frozen-annotation-container-corner",this.corner),this.annotation_container=ft.CreateDiv("annotation-container"),this.grid_cover=ft.CreateDiv("tile-cover grid-cover"),this.column_header_cover=ft.CreateDiv("tile-cover column-header-cover"),this.row_header_cover=ft.CreateDiv("tile-cover row-header-cover")}InitializeInternal(t,e){this.container=t,this.container.classList.add("grid-layout"),this.scroll_reference_node=this.container,t.appendChild(this.column_header),t.appendChild(this.row_header),t.appendChild(this.corner),t.appendChild(this.contents),t.appendChild(this.annotation_container),t.appendChild(this.grid_cover),t.appendChild(this.column_header_cover),t.appendChild(this.row_header_cover),t.appendChild(this.mock_selection),this.container.addEventListener("scroll",(()=>e()))}ResizeCursor(t){switch(t){case"row":this.row_header_cover.classList.add("resize");break;case"column":this.column_header_cover.classList.add("resize");break;default:this.row_header_cover.classList.remove("resize"),this.column_header_cover.classList.remove("resize")}}UpdateTileGridPosition(t){t.style.gridColumn=`${t.tile_position.column+1} / ${t.tile_position.column+2}`,t.style.gridRow=`${t.tile_position.row+1} / ${t.tile_position.row+2}`}UpdateContainingGrid(){if(!this.container)throw new Error("missing container");this.header_size.width=this.header_offset.x,this.header_size.height=this.header_offset.y;let t=this.header_offset.x,e=this.header_offset.y;if(this.model.active_sheet.freeze.columns)for(let e=0;e<this.model.active_sheet.freeze.columns;e++)t+=this.ColumnWidth(e);if(this.model.active_sheet.freeze.rows)for(let t=0;t<this.model.active_sheet.freeze.rows;t++)e+=this.RowHeight(t);this.container.style.gridTemplateColumns=`${this.header_offset.x}px auto`,this.container.style.gridTemplateRows=`${this.header_offset.y}px auto`,this.corner_canvas.setAttribute("width",""+this.dpr*t),this.corner_canvas.setAttribute("height",""+this.dpr*e),this.column_header.style.height=`${e}px`,this.corner_canvas.style.width=`${t}px`,this.corner_canvas.style.height=`${e}px`}UpdateGridTemplates(t=!0,e=!0){let s=0,i=0;this.column_header.style.gridTemplateColumns=this.contents.style.gridTemplateColumns=this.column_header_tiles.map((t=>(s+=t.logical_size.width,`${t.logical_size.width}px`))).join(" "),this.column_header.style.gridTemplateRows=`${this.header_offset.y}px auto`,this.row_header.style.gridTemplateRows=this.contents.style.gridTemplateRows=this.row_header_tiles.map((t=>(i+=t.logical_size.height,`${t.logical_size.height}px`))).join(" ");let r=this.header_offset.y;if(this.model.active_sheet.freeze.rows)for(let t=0;t<this.model.active_sheet.freeze.rows;t++)r+=this.RowHeight(t);this.column_header.style.height=`${r}px`,this.row_header_selection.style.display="block",this.row_header_selection.style.width=`${s}px`,this.corner_selection.style.height=this.row_header_selection.style.height=`${r}px`,this.corner_selection.style.top=this.row_header_selection.style.top="0px",this.row_header_selection.style.left="0px";let o=this.header_offset.x;if(this.model.active_sheet.freeze.columns)for(let t=0;t<this.model.active_sheet.freeze.columns;t++)o+=this.ColumnWidth(t);this.column_header_selection.style.display="block",this.corner_selection.style.width=this.column_header_selection.style.width=`${o}px`,this.column_header_selection.style.height=`${i}px`,this.column_header_selection.style.top="0px",this.corner_selection.style.left=this.column_header_selection.style.left="0px";const a=this.model.active_sheet.header_offset.x*this.scale,n=this.model.active_sheet.header_offset.y*this.scale,l=this.model.active_sheet.freeze;l.rows&&l.columns?(this.row_header_annotations.style.display="block",this.column_header_annotations.style.display="block",this.corner_annotations.style.display="block"):l.rows?(this.row_header_annotations.style.display="block",this.column_header_annotations.style.display="none",this.corner_annotations.style.display="none"):l.columns?(this.row_header_annotations.style.display="none",this.column_header_annotations.style.display="block",this.corner_annotations.style.display="none"):(this.row_header_annotations.style.display="none",this.column_header_annotations.style.display="none",this.corner_annotations.style.display="none"),this.row_header_annotations.style.width=`${s}px`,this.corner_annotations.style.height=this.row_header_annotations.style.height=r-n+"px",this.corner_annotations.style.top=this.row_header_annotations.style.top=`${n}px`,this.column_header_annotations.style.width=this.corner_annotations.style.width=o-a+"px",this.column_header_annotations.style.height=`${i}px`,this.corner_annotations.style.left=this.column_header_annotations.style.left=`${a}px`,this.corner_selection.style.display="block",this.grid_selection.style.width=`${s}px`,this.grid_selection.style.height=`${i}px`,this.grid_selection.style.top=`${this.header_offset.y}px`,this.grid_selection.style.left=`${this.header_offset.x}px`,this.annotation_container.style.width=`${s}px`,this.annotation_container.style.height=`${i}px`,this.annotation_container.style.top=`${this.header_offset.y}px`,this.annotation_container.style.left=`${this.header_offset.x}px`}}var yt;!function(t){t[t.Function=0]="Function",t[t.Token=1]="Token"}(yt||(yt={}));class vt{constructor(){this.function_names=[],this.function_map={},this.argument_separator=g.argument_separator.charCodeAt(0)}RemoveFunctions(t){Array.isArray(t)||(t=[t]);let e=Object.keys(this.function_map).map((t=>this.function_map[t]));for(const s of t)e=e.filter((t=>t.name!==s.name));this.SetFunctions(e)}AddFunctions(t){Array.isArray(t)||(t=[t]);const e=Object.keys(this.function_map).map((t=>this.function_map[t])).concat(...t);this.SetFunctions(e)}SetFunctions(t){this.function_map={},this.function_names=t.map((t=>(this.function_map[t.name.toLowerCase()]=t,t.name))).sort(((t,e)=>t.toLowerCase().localeCompare(e.toLowerCase())))}NormalizeIdentifier(t){const e=this.function_map[t.toLowerCase()];return e?e.name:void 0}Exec(t){if("="!==t.text[0])return{};let e,s={};if(t.cursor===t.text.length&&(e=t.text.match(/(?:^|[^A-Za-z_])([A-Za-z_][\w\d_.]*)\s*$/),e)){const i=e[1],r=new RegExp("^"+i.replace(".","\\."),"i");s={completions:this.function_names.filter((t=>r.test(t))).map((t=>this.function_map[t.toLowerCase()])),token:i,position:t.cursor-i.length}}const i=this.ParseTooltip(t.text.substr(0,t.cursor));if(i.function){const t=this.function_map[i.function.toLowerCase()];t&&(s.tooltip='<span class="notranslate">'+t.name+"</span>",s.arguments="("+(t.arguments||[]).map(((t,e)=>{const s=t.name||"argument";return e===i.argument?`<span class="active-argument">${s}</span>`:s})).join(g.argument_separator+" ")+")",s.description=t.description?`<span class="function-description">${t.description}</span>`:"",s.function_position=i.position||0)}return s}ParseTooltip(t){var e;const s=[];let i=0,r="",o=!1,a=0;for(const n of t){const t=n.charCodeAt(0);if(o)34===t&&(o=!1);else switch(t){case 40:s.push({buffer:r.trim(),argument:i,position:a-r.length}),r="",i=0;break;case this.argument_separator:i++;break;case 41:i=(null===(e=s.pop())||void 0===e?void 0:e.argument)||0;break;case 34:r="",o=!0;break;default:t>=97&&t<=122||t>=65&&t<=90||t>=48&&t<=57||95===t||46===t?r+=n:r=""}a++}const n=s.pop();return{function:(null==n?void 0:n.buffer)||void 0,position:(null==n?void 0:n.position)||0,argument:i}}}const bt="undefined"==typeof navigator?{is_edge:!1,is_ipad:!1,is_android:!1,is_firefox:!1,is_safari:!1,is_mac:!1,is_chrome:!1,trident:!1,is_windows:!1,is_modern:!0,is_node:!0,is_mobile:!1}:new class{constructor(){this.is_edge=/Edge/.test(navigator.appVersion),this.is_ipad=/iPad|iPhone/.test(navigator.userAgent),this.is_android=/android|samsung/i.test(navigator.userAgent),this.is_mobile=this.is_ipad||this.is_android,this.is_firefox=/firefox/i.test(navigator.userAgent),this.is_safari=/safari/i.test(navigator.userAgent),this.is_mac=/macintosh/i.test(navigator.userAgent),this.is_chrome=/Chrome/i.test(navigator.userAgent),this.trident="undefined"!=typeof navigator&&navigator.userAgent&&/trident/i.test(navigator.userAgent),this.is_windows=/win64|win32|windows\s+nt/i.test(navigator.userAgent),this.is_modern=!this.is_edge&&!(this.is_firefox&&this.is_android)&&/webkit|firefox/i.test(navigator.userAgent)}};class wt extends O{constructor(t,e,s){super(),this.theme=t,this.model=e,this.autocomplete=s,this.selecting_=!1,this.trident="undefined"!=typeof navigator&&navigator.userAgent&&/trident/i.test(navigator.userAgent),this.last_parse_string="",this.dependency_list=[],this.reference_index_map=[],this.last_reconstructed_text="",this.enable_reconstruct=!0,this.selection_={target:{row:0,column:0},area:new r({row:0,column:0})},this.measurement_node=document.createElement("div")}get selecting(){return this.selecting_}get selection(){return this.selection_}set selection(t){if(t){const e=t.target||t.area.start;this.selection_={target:{row:e.row,column:e.column},area:new r(t.area.start,t.area.end)}}else{const t={row:0,column:0};this.selection_={target:t,area:new r(t)}}}UpdateTheme(t){}InsertReference(t,e){if(!this.editor_node)return;if(!this.editor_insert_node){const t=window.getSelection();if(t){const e=t.getRangeAt(0);this.editor_insert_node=document.createElement("span"),e.insertNode(this.editor_insert_node),t.collapseToEnd()}}if(this.editor_insert_node&&(this.editor_insert_node.innerText=t,t.length)){const t=window.getSelection();if(t){const e=document.createRange();e.selectNodeContents(this.editor_insert_node),t.removeAllRanges(),t.addRange(e),t.collapseToEnd()}}const s=this.ListDependencies();this.Publish({type:"update",text:this.editor_node.textContent||void 0,dependencies:s})}Autocomplete(t,e){if(!this.container_node)return;let s;s=(null==e?void 0:e.nodeType)===Node.ELEMENT_NODE?e.getBoundingClientRect():this.container_node.getBoundingClientRect();const i=new y(Math.round(s.left),Math.round(s.top),s.width,s.height);this.autocomplete.Show(this.AcceptAutocomplete.bind(this),t,i)}FlushReference(){this.editor_insert_node=void 0}SubstringToCaret(t){const e=window.getSelection();if(!e)throw new Error("error getting selection");if(0===e.rangeCount)return console.warn("range count is 0"),"";const s=e.getRangeAt(0),i=s.cloneRange();return i.selectNodeContents(t),i.setEnd(s.endContainer,s.endOffset),this.measurement_node.textContent="",this.measurement_node.appendChild(i.cloneContents()),this.measurement_node.textContent}UpdateSelectState(t=!1){let e=!1,s=!1;if(!this.editor_node)return;const i=this.editor_node.textContent||"";if("="===i.trim()[0]){s=!0;const t=this.SubstringToCaret(this.editor_node).trim();if(t.length){const s=t[t.length-1];wt.FormulaChars.some((t=>s===t))&&(e=!0);const r=this.autocomplete_matcher;r&&F().then((()=>{const e=r.Exec({text:i,cursor:t.length}),s=this.NodeAtIndex(e.completions?e.position||0:e.function_position||0);this.Autocomplete(e,s)}))}}e!==this.selecting_?(this.selecting_=e,e||this.Reconstruct(),!t&&e||this.Publish({type:"end-selection"})):e&&t&&this.Publish({type:"end-selection"});const r=s?this.ListDependencies():void 0;this.Publish({type:"update",text:i,dependencies:r})}NodeAtIndex(t){var e,s;const i=(null===(e=this.editor_node)||void 0===e?void 0:e.childNodes)||[];for(let e=0;e<i.length;e++){const r=(null===(s=i[e].textContent)||void 0===s?void 0:s.length)||0;if(r>t)return i[e];t-=r}}Reconstruct(){if(!this.enable_reconstruct)return;if(!this.editor_node)return;if(this.ParseDependencies(),!this.reference_list)return;const t=this.editor_node.textContent||"";if("="!==t.trim()[0])return;if(this.editor_node.spellcheck=!1,this.selecting)return;if(t.trim()===this.last_reconstructed_text.trim())return;this.last_reconstructed_text=t;const e=this.SubstringToCaret(this.editor_node).length,s=document.createDocumentFragment();let i,r,o=0,a="";if(this.last_parse_result){let n=0,l="",h=0;const c=(t,r,a)=>{const n=document.createTextNode(r);if("text"===a)s.appendChild(n);else{const e=document.createElement("span");e.appendChild(n),e.dataset.position=t.toString(),e.dataset.type=a,("address"===a||"range"===a||"identifier"===a&&this.model.named_ranges.Get(r))&&e.classList.add("highlight-"+(this.reference_index_map[h++]%5+1)),s.appendChild(e)}return e>=t&&e<t+r.length&&(i=n,o=e-t),n};this.last_parse_result.expression&&wt.Parser.Walk(this.last_parse_result.expression,(e=>{switch(e.type){case"address":case"range":case"call":case"identifier":e.position!==n-1&&c(n,t.substring(n,e.position+1),"text"),l="call"===e.type||"identifier"===e.type?e.name:e.label,c(e.position+1,l,e.type),n=e.position+l.length+1}return"range"!==e.type})),a=t.substring(n)||"",r=c(n,a,"text")}if(!i)if(t.length===e){const t=document.createElement("span");s.appendChild(t),i=t,o=0}else i=r,o=Math.max(0,a.length-(t.length-e));if(this.editor_node.textContent="",this.editor_node.appendChild(s),i){const t=document.createRange(),e=window.getSelection();e&&(t.setStart(i,o),t.setEnd(i,o),t.collapse(!0),e.removeAllRanges(),e.addRange(t))}}ParseDependencies(){if(!this.editor_node)return;const t=this.editor_node.textContent||"";if(t!==this.last_parse_string||!this.reference_list){const e={};for(const t of this.model.sheets)e[t.name.toLowerCase()]=t.id;if(this.dependency_list=[],this.reference_index_map=[],t){const s=wt.Parser.Parse(t);if(this.last_parse_string=t,this.last_parse_result=s,this.reference_list=[],s.full_reference_list)for(const t of s.full_reference_list)if("address"===t.type||"range"===t.type){const s="address"===t.type?t:t.start;s.sheet_id||(s.sheet?s.sheet_id=e[s.sheet.toLowerCase()]||0:s.sheet_id=this.model.active_sheet.id),this.reference_list.push(t)}else{const e=this.model.named_ranges.Get(t.name);e&&(1===e.count?this.reference_list.push(Object.assign(Object.assign({type:"address"},e.start),{label:t.name,position:t.position,id:t.id})):this.reference_list.push({type:"range",start:Object.assign({type:"address",position:t.position,id:t.id,label:t.name},e.start),end:Object.assign({type:"address",position:t.position,label:t.name,id:t.id},e.end),label:t.name,position:t.position,id:t.id}))}if(this.reference_list){this.reference_list.sort(((t,e)=>t.position-e.position));for(const t of this.reference_list){let e;e="address"===t.type?new r({row:t.row,column:t.column,sheet_id:t.sheet_id}):new r({row:t.start.row,column:t.start.column,sheet_id:t.start.sheet_id},{row:t.end.row,column:t.end.column});const s=e.spreadsheet_label;this.dependency_list.some(((t,i)=>t.spreadsheet_label===s&&t.start.sheet_id===e.start.sheet_id&&(this.reference_index_map.push(i),!0)))||(this.reference_index_map.push(this.dependency_list.length),this.dependency_list.push(e))}}}else this.reference_list=void 0}}ListDependencies(){return this.ParseDependencies(),this.dependency_list||[]}AcceptAutocomplete(t){var e,s;if(!this.editor_node)return;let i=window.getSelection(),r=yt.Function;if(t.data&&t.data.completions)for(const s of t.data.completions)if(s.name.toLowerCase()===(null===(e=t.value)||void 0===e?void 0:e.toLowerCase())){r=s.type||yt.Function;break}if(!i)throw new Error("error getting selection");let o=i.getRangeAt(0);const a=o.cloneRange(),n=document.createElement("div");a.selectNodeContents(this.editor_node),a.setEnd(o.endContainer,o.endOffset),n.appendChild(a.cloneContents());const l=(n.textContent||"").substr(0,t.data?t.data.position:0)+t.value,h=r===yt.Token?l:l+"(";this.editor_node.textContent=h,this.autocomplete.Hide(),bt.is_firefox||this.Reconstruct(),i=window.getSelection(),o=document.createRange(),(null===(s=this.editor_node)||void 0===s?void 0:s.lastChild)&&o.setStartAfter(this.editor_node.lastChild),o.collapse(!0),null==i||i.removeAllRanges(),null==i||i.addRange(o),this.selecting_=!0,t.click&&this.UpdateSelectState()}}var Ct,xt;wt.Parser=new N,wt.FormulaChars=("$^&*(-+={[<>/~%"+g.argument_separator).split(""),function(t){t[t.not_handled=0]="not_handled",t[t.handled=1]="handled",t[t.commit=2]="commit",t[t.discard=3]="discard"}(xt||(xt={}));const St="function"==typeof(null===(Ct=null===document||void 0===document?void 0:document.body)||void 0===Ct?void 0:Ct.createTextRange);class At extends wt{constructor(t,e,s,i){super(e,s,i),this.container=t,this._editing=!1,this.scale=1,this.edit_container=document.createElement("div"),this.edit_container.classList.add("overlay-editor-container"),this.edit_container.classList.add("notranslate"),this.edit_container.translate=!1,this.edit_node=document.createElement("div"),this.edit_node.classList.add("overlay-editor"),this.edit_node.contentEditable="true",this.edit_node.tabIndex=-1,this.edit_node.spellcheck=!0,this.edit_node.inputMode="none",this.edit_node.addEventListener("input",(()=>{this.editing&&(this.Reconstruct(),this.UpdateSelectState())})),this.edit_node.addEventListener("keyup",(t=>{if(this.editing&&!this.autocomplete.HandleKey("keyup",t).handled){if(this.selecting_)switch(t.key){case"ArrowUp":case"ArrowDown":case"ArrowLeft":case"ArrowRight":case"Shift":case"Control":return}this.FlushReference(),this.UpdateSelectState(!0)}})),this.edit_inset=document.createElement("div"),this.edit_inset.classList.add("overlay-inset"),this.edit_container.appendChild(this.edit_inset),this.edit_inset.appendChild(this.edit_node),t.appendChild(this.edit_container),this.edit_container.style.opacity="0",this.editor_node=this.edit_node,this.container_node=this.edit_container,this.ClearContents()}get editing(){return this._editing}set editing(t){this._editing!==t&&(this._editing=t,t?(this.edit_container.style.opacity="1",this.edit_container.style.pointerEvents="initial"):(this.edit_container.style.opacity="0",this.edit_container.style.pointerEvents="none",bt.trident&&(this.edit_container.style.top="-200px")))}Focus(){this.edit_node!==document.activeElement&&(this.edit_container.style.top=`${this.container.scrollTop+2}px`,this.edit_container.style.left=`${this.container.scrollLeft+2}px`),this.edit_node.focus()}CloseEditor(){this.editing=!1,this.ClearContents(),this.edit_node.spellcheck=!0,this.autocomplete.Hide(),this.active_cell=void 0}ClearContents(){bt.is_firefox?this.edit_node.innerHTML="<span></span>":this.edit_node.textContent=""}Edit(t,e,s,i,r){this.Publish({type:"start-editing",editor:"ice"}),this.active_cell=s;const o=s.style||{};switch(this.edit_node.style.font=v.Font(o,this.scale),this.edit_node.style.color=x(this.theme,o.text,1),this.edit_inset.style.backgroundColor=C(this.theme,o.fill),o.horizontal_align){case v.HorizontalAlign.Right:this.edit_inset.classList.add("align-right"),this.edit_inset.classList.remove("align-center"),this.edit_inset.classList.remove("align-left");break;case v.HorizontalAlign.Center:this.edit_inset.classList.remove("align-right"),this.edit_inset.classList.add("align-center"),this.edit_inset.classList.remove("align-left");break;default:this.edit_inset.classList.remove("align-right"),this.edit_inset.classList.remove("align-center"),this.edit_inset.classList.add("align-left")}this.edit_node.style.paddingBottom=`${Math.max(0,(self.devicePixelRatio||1)-1)}px`;const a=(null==i?void 0:i.toString())||"";if(a&&"="===a[0]&&(this.edit_node.spellcheck=!1),this.autocomplete.ResetBlock(),this.FlushReference(),this.selection=t,void 0!==i){const t="="!==a[0]&&"%"===a[a.length-1],e=a.length;if(this.edit_node.textContent=a,St)F().then((()=>{const s=document.body.createTextRange();s.moveToElementText(this.editor_node),t?e>1&&(s.moveStart("character",e),s.move("character",-1),s.select()):(s.moveStart("character",e),s.select())}));else{const s=document.createRange(),i=window.getSelection();if(!i)throw new Error("invalid selection object");this.edit_node.lastChild&&(t?(s.setStart(this.edit_node.lastChild,e-1),s.setEnd(this.edit_node.lastChild,e-1)):s.setStartAfter(this.edit_node.lastChild)),s.collapse(!0),i.removeAllRanges(),i.addRange(s)}if(!r){const t=this.ListDependencies();this.Publish({type:"update",text:i.toString(),dependencies:t})}}e.ApplyStyle(this.edit_container),this.editing=!0,F().then((()=>{this.last_reconstructed_text="",this.Reconstruct()}))}HandleKeyDown(t){if(!this.editing)return xt.not_handled;const e=this.autocomplete.HandleKey("keydown",t);if(e.accept&&this.AcceptAutocomplete(e),e.handled)return xt.handled;switch(t.key){case"Enter":case"Tab":return this.selecting_=!1,xt.commit;case"Escape":case"Esc":return this.selecting_=!1,xt.discard;case"ArrowUp":case"ArrowDown":case"ArrowLeft":case"ArrowRight":case"Up":case"Down":case"Left":case"Right":return this.selecting_?xt.not_handled:xt.handled}return xt.handled}UpdateTheme(t){this.scale=t}}const Mt=new class{constructor(){this.cache={},this.canvas=document.createElement("canvas")}GetFirstIndex(t){for(let e=3,s=t.length;e<s;e+=4)if(t[e]>0)return(e-3)/4;return t.length}GetLastIndex(t){for(let e=t.length-1;e>=3;e-=4)if(t[e]>0)return e/4;return 0}Get(t){let e=this.cache[t];return e||(e=this.Measure(t),this.cache[t]=e,e)}Measure(t){let e=this.canvas.getContext("2d");if(!e)throw new Error("invalid context");e.font=t;const s=e.measureText("MMM"),i=Math.ceil(s.width);if(this.canvas.setAttribute("width",i.toString()),this.canvas.setAttribute("height",i.toString()),e=this.canvas.getContext("2d"),!e)throw new Error("invalid context");e.font=t,e.textAlign="center",e.textBaseline="alphabetic",e.fillStyle="#000";const r=Math.round(2*i/3),o=Math.round(i/2);e.clearRect(0,0,i,i);for(let t=32;t<=126;t++){const s=String.fromCharCode(t);e.fillText(s,o,r)}const a=e.getImageData(0,0,this.canvas.width,this.canvas.height).data,n=Math.floor(this.GetFirstIndex(a)/i),l=Math.floor(this.GetLastIndex(a)/i);return{ascender:r-n,descender:l-r,block:l-n+1,paren:e.measureText("(").width,hash:e.measureText("##").width-e.measureText("#").width}}},kt="bottom",Rt=/webkit/i.test((null===navigator||void 0===navigator?void 0:navigator.userAgent)||"")?1:0;class Lt{constructor(t,e,s,i){this.theme=t,this.layout=e,this.model=s,this.options=i,this.cell_edge_buffer=4,this.overflow_areas=[],this.buffer_canvas_size={width:256,height:256},this.buffer_canvas=document.createElement("canvas"),this.buffer_canvas.width=this.buffer_canvas_size.width,this.buffer_canvas.height=this.buffer_canvas_size.height;const r=this.buffer_canvas.getContext("2d",{alpha:!1});if(r){const t=this.layout.dpr;this.buffer_context=r,this.buffer_context.setTransform(t,0,0,t,0,0),this.buffer_context.textAlign="left",this.buffer_context.textBaseline=kt}}EnsureBuffer(t=0,e=0,s=0){const i=this.layout.dpr;if(e*=i,s*=i,(t*=i)>this.buffer_canvas_size.width||e>this.buffer_canvas_size.height){this.buffer_canvas_size.width=Math.max(256*Math.ceil(t/256),this.buffer_canvas_size.width),this.buffer_canvas_size.height=Math.max(256*Math.ceil(e/256),this.buffer_canvas_size.height),this.buffer_canvas.width=this.buffer_canvas_size.width,this.buffer_canvas.height=this.buffer_canvas_size.height;const s=this.buffer_canvas.getContext("2d",{alpha:!1});s&&(this.buffer_context=s,this.buffer_context.textAlign="left",this.buffer_context.textBaseline=kt)}this.buffer_context.setTransform(i,0,0,i,s,0)}OverflowDirty(t=!1){const e=[];for(const s of this.overflow_areas){const i=s.area.start.row;let r=t;if(!r)for(let t=s.area.start.column;!r&&t<=s.area.end.column;t++){const e=this.model.active_sheet.cells.GetCell({row:i,column:t},!1);r=!(!e||!e.render_dirty)}if(r){for(let t=s.area.start.column;t<=s.area.end.column;t++){const e=this.model.active_sheet.cells.GetCell({row:i,column:t},!1);e&&(e.render_dirty=!0,e.renderer_data&&e.renderer_data.overflowed&&(e.renderer_data=void 0))}s.tile.dirty=!0}else e.push(s)}this.overflow_areas=e}RenderCorner(){var t,e,s,i;const o=this.layout.corner_canvas.getContext("2d",{alpha:!1});if(!o)throw new Error("invalid context");const a=Mt.Get(v.Font(this.theme.headers||{},this.layout.scale)),n=this.layout.dpr,l=this.layout.header_offset;let h=l.x;for(let t=0;t<this.model.active_sheet.freeze.columns;t++)h+=this.layout.ColumnWidth(t);let c=l.y;for(let t=0;t<this.model.active_sheet.freeze.rows;t++)c+=this.layout.RowHeight(t);if(o.setTransform(n,0,0,n,0,0),o.fillStyle=(null===(t=this.theme.headers)||void 0===t?void 0:t.fill)?C(this.theme,this.theme.headers.fill):"",o.fillRect(0,0,h,l.y),o.fillRect(0,0,l.x,c),o.strokeStyle=this.theme.grid_color||"",o.beginPath(),o.moveTo(l.x-.5,0),o.lineTo(l.x-.5,c),o.moveTo(0,l.y-.5),o.lineTo(h,l.y-.5),o.stroke(),this.model.active_sheet.freeze.columns||this.model.active_sheet.freeze.rows){if(o.textAlign="center",o.textBaseline="middle",o.font=v.Font(this.theme.headers||{},this.layout.scale),o.fillStyle=C(this.theme,null===(e=this.theme.headers)||void 0===e?void 0:e.text),this.model.active_sheet.freeze.rows&&this.layout.header_offset.x>1){o.setTransform(n,0,0,n,0,0),o.translate(0,l.y),o.beginPath(),o.moveTo(0,-.5),o.lineTo(l.x,-.5);let t=0;for(;t<this.model.active_sheet.freeze.rows;t++){const e=this.layout.RowHeight(t);o.fillStyle=C(this.theme,null===(s=this.theme.headers)||void 0===s?void 0:s.text),e>=1.2*a.block&&o.fillText(`${t+1}`,l.x/2,e/2),o.moveTo(0,e-.5),o.lineTo(l.x,e-.5),o.translate(0,e)}o.strokeStyle=this.theme.grid_color||"",o.stroke()}if(this.model.active_sheet.freeze.columns&&this.layout.header_offset.y>1){o.strokeStyle=this.theme.grid_color||"",o.setTransform(n,0,0,n,0,0),o.translate(l.x,0),o.beginPath(),o.moveTo(-.5,0),o.lineTo(-.5,l.y);let t=0;for(;t<this.model.active_sheet.freeze.columns;t++){const e=this.layout.ColumnWidth(t),s=r.ColumnToLabel(t);e>o.measureText(s).width&&(o.fillStyle=C(this.theme,null===(i=this.theme.headers)||void 0===i?void 0:i.text),o.fillText(s,e/2,l.y/2)),o.moveTo(e-.5,0),o.lineTo(e-.5,l.y),o.translate(e,0)}o.stroke()}}}RenderHeaders(t,e=!1){var s,i,o,a,n,l;const h=this.layout.dpr,c=this.layout.header_offset,d=Mt.Get(v.Font(this.theme.headers||{},this.layout.scale));for(let a=t.start.column;a<=t.end.column;a++){const t=this.layout.column_header_tiles[a],n=t.getContext("2d",{alpha:!1});if(n&&(n.setTransform(h,0,0,h,0,0),t.dirty||e)){n.fillStyle=(null===(s=this.theme.headers)||void 0===s?void 0:s.fill)?C(this.theme,this.theme.headers.fill):"",n.fillRect(0,0,t.logical_size.width,this.layout.header_offset.y),n.textAlign="center",n.textBaseline="middle",n.font=v.Font(this.theme.headers||{},this.layout.scale),n.fillStyle=C(this.theme,null===(i=this.theme.headers)||void 0===i?void 0:i.text),n.strokeStyle=this.theme.grid_color||"",n.beginPath(),n.moveTo(0,c.y-.5),n.lineTo(t.logical_size.width,c.y-.5);let e=t.first_cell.column;for(;e<=t.last_cell.column;e++){const t=this.layout.ColumnWidth(e),s=r.ColumnToLabel(e);t>n.measureText(s).width&&(n.fillStyle=C(this.theme,null===(o=this.theme.headers)||void 0===o?void 0:o.text),n.fillText(s,t/2,c.y/2)),n.moveTo(t-.5,0),n.lineTo(t-.5,c.y),n.translate(t,0)}n.stroke(),t.dirty=!1}}for(let s=t.start.row;s<=t.end.row;s++){const t=this.layout.row_header_tiles[s];if(t.dirty||e){const e=t.getContext("2d",{alpha:!1});if(!e)continue;e.fillStyle=(null===(a=this.theme.headers)||void 0===a?void 0:a.fill)?C(this.theme,this.theme.headers.fill):"",e.setTransform(h,0,0,h,0,0),e.fillRect(0,0,this.layout.header_offset.x,t.logical_size.height),e.textAlign="center",e.textBaseline="middle",e.font=v.Font(this.theme.headers||{},this.layout.scale),e.fillStyle=C(this.theme,null===(n=this.theme.headers)||void 0===n?void 0:n.text),e.strokeStyle=this.theme.grid_color||"",e.beginPath(),e.moveTo(c.x-.5,0),e.lineTo(c.x-.5,t.logical_size.height);let s=t.first_cell.row;for(;s<=t.last_cell.row;s++){const t=this.layout.RowHeight(s);e.fillStyle=C(this.theme,null===(l=this.theme.headers)||void 0===l?void 0:l.text),t>=1.2*d.block&&e.fillText(`${s+1}`,c.x/2,t/2),e.moveTo(0,t-.5),e.lineTo(c.x,t-.5),e.translate(0,t)}e.strokeStyle=this.theme.grid_color||"",e.stroke(),t.dirty=!1}}(this.model.active_sheet.freeze.rows||this.model.active_sheet.freeze.columns)&&this.RenderCorner()}CopyToAdjacent(t,e,s,i,r,o,a){const n=this.layout.AdjacentTile(t,i,s);if(!n)return;let l=r,h=o;s>0?l=r-(t.pixel_end.x-t.pixel_start.x)*e:s<0&&(l=r+(n.pixel_end.x-n.pixel_start.x)*e),i>0&&(h=o-(t.pixel_end.y-t.pixel_start.y)*e);const c=n.getContext("2d",{alpha:!1});c&&(c.setTransform(e,0,0,e,l,h),c.drawImage(this.buffer_canvas,0,0,(a.width||0)*e,(a.height||0)*e,a.left||0,0,a.width||0,a.height||0))}Render(t){const e=t.getContext("2d",{alpha:!1});if(!e)return;e.textBaseline=kt;const s=this.layout.dpr;this.last_font=void 0,e.setTransform(s,0,0,s,0,0);let i=0,r=0;for(let o=t.first_cell.column;o<=t.last_cell.column;o++){const a=this.layout.ColumnWidth(o);if(a){r=0;for(let n=t.first_cell.row;n<=t.last_cell.row;n++){const l=this.layout.RowHeight(n);if(l){e.setTransform(s,0,0,s,i,r);const h=this.model.active_sheet.CellData({row:n,column:o});if(t.needs_full_repaint||h.render_dirty){const c=this.RenderCell(t,h,e,{row:n,column:o},a,l);c.tile_overflow_right&&this.CopyToAdjacent(t,s,1,0,i,r,c),c.tile_overflow_left&&this.CopyToAdjacent(t,s,-1,0,i,r,c),c.tile_overflow_bottom&&this.CopyToAdjacent(t,s,0,1,i,r,c)}}r+=l*s}i+=a*s}}if(!this.model.active_sheet.freeze.rows&&!this.model.active_sheet.freeze.columns)return;let o=0,a=0;if(t.first_cell.row<=this.model.active_sheet.freeze.rows-1)for(let e=t.first_cell.row;e<this.model.active_sheet.freeze.rows&&e<=t.last_cell.row;e++)o+=this.layout.RowHeight(e);if(t.first_cell.column<=this.model.active_sheet.freeze.columns-1)for(let e=t.first_cell.column;e<this.model.active_sheet.freeze.columns&&e<=t.last_cell.column;e++)a+=this.layout.ColumnWidth(e);if(o){const e=this.layout.frozen_row_tiles[t.tile_position.column];if(!e)throw new Error("can't find matching header tile");const i=e.getContext("2d",{alpha:!0});if(!i)throw new Error("header context failed");i.setTransform(s,0,0,s,0,0),i.drawImage(t,0,0,t.logical_size.width*s,o*s,0,0,t.logical_size.width,o)}if(a){const e=this.layout.frozen_column_tiles[t.tile_position.row];if(!e)throw new Error("can't find matching header tile");const i=e.getContext("2d",{alpha:!0});if(!i)throw new Error("header context failed");i.setTransform(s,0,0,s,0,0),i.drawImage(t,0,0,a*s,t.logical_size.height*s,0,0,a,t.logical_size.height)}if(a&&o){const e=this.layout.corner_canvas.getContext("2d",{alpha:"false"});if(!e)throw new Error("corner context failed");e.setTransform(s,0,0,s,this.layout.header_offset.x*s,this.layout.header_offset.y*s),e.drawImage(t,0,0,a*s,o*s,0,0,a,o)}}PrepText(t,e,s){const i=[],r=e.style||{};let a,n,l=0,h=0,c=!1,d=e.editing?"":e.formatted;if(Array.isArray(d)){for(const e of d){if(e.flag===b.formatting){n=e.text;continue}const s=t.measureText(e.text).width,r={width:s,text:e.text,hidden:e.flag===b.hidden};i.push(r),e.flag===b.padded?a=r:h+=s}if(a){const t=a.text,e=a.width,i=s-h-2*this.cell_edge_buffer;if(a.width=Math.max(0,i),i>0){const r=Math.floor(i/e);for(let e=1;e<r;e++)a.text+=t;h=s-2*this.cell_edge_buffer}else a.text=""}l=h,c=!0}else if(""===d)i.push({text:"",hidden:!1,width:0});else if(d){e.type===o.string&&"'"===d[0]&&(d=d.slice(1));let a=d.split(/\n/);if(r.wrap){const e=s-2*this.cell_edge_buffer,i=[];a.forEach((s=>{const r=s.match(/\S+\s*/g);if(r&&r.length){let s="";do{const o=(s+r[0]).trim();t.measureText(o).width<e?(s+=r[0],r.shift()):s?(i.push(s.trim()),s=""):(i.push(o.trim()),r.shift(),s="")}while(r.length);s&&i.push(s.trim())}else i.push("")})),a=i}for(const e of a){const s=t.measureText(e).width;l=Math.max(l,s),i.push({text:e,hidden:!1,width:s})}}return n?{strings:i,width:l,single:c,format:n}:{strings:i,width:l,single:c}}ResolveColors(t){const e=Object.assign({},t);return e.text={text:x(this.theme,t.text,1)},e}RenderCellBorders(t,e,s,i=0,r=0,o=0,a=0){var n,l,h,c;const d=this.model.active_sheet.SurroundingStyle(t);let u=x(this.theme,d[8].fill);u&&(e.fillStyle=u,e.fillRect(i+0,r-1,o,1)),u=x(this.theme,d[4].fill),u&&(e.fillStyle=u,e.fillRect(i-1,r,1,a)),u=x(this.theme,s.fill),u&&(e.fillStyle=u,e.fillRect(i-1,r-1,o+1,a+1)),u=x(this.theme,d[6].fill),u&&(e.fillStyle=u,e.fillRect(i+o-1,r-1,1,a+1)),u=x(this.theme,d[2].fill),u&&(e.fillStyle=u,e.fillRect(i-1,r+a-1,o+1,1)),d[6].border_top&&!d[6].border_left&&(e.fillStyle=x(this.theme,d[6].border_top_fill,1),e.fillRect(i+o-1,r-2+d[6].border_top,1,1)),d[9].border_left&&(e.fillStyle=x(this.theme,d[9].border_left_fill,1),e.fillRect(i+o-1,r-1,1,1)),d[9].border_bottom&&(e.fillStyle=x(this.theme,d[9].border_bottom_fill,1),e.fillRect(i+o-1,r-2+d[9].border_bottom,1,1)),d[4].border_top&&!d[4].border_right&&(e.fillStyle=x(this.theme,d[4].border_right_fill,1),e.fillRect(i-1,r-2+d[4].border_top,1,1)),d[7].border_right&&(e.fillStyle=x(this.theme,d[7].border_right_fill,1),e.fillRect(i-1,r-1,1,1)),d[7].border_bottom&&(e.fillStyle=x(this.theme,d[7].border_bottom_fill,1),e.fillRect(i-1,r-2+d[7].border_bottom,1,1)),d[6].border_bottom&&!d[6].border_left&&(e.fillStyle=x(this.theme,d[6].border_bottom_fill,1),e.fillRect(i+o-1,r+a-d[6].border_bottom,1,1)),d[3].border_left&&(e.fillStyle=x(this.theme,d[3].border_left_fill,1),e.fillRect(i+o-1,r+a-1,1,1)),d[3].border_top&&(e.fillStyle=x(this.theme,d[3].border_top_fill,1),e.fillRect(i+o-1,r+a-d[3].border_top,1,1)),d[4].border_bottom&&!d[4].border_right&&(e.fillStyle=x(this.theme,d[4].border_bottom_fill,1),e.fillRect(i-1,r+a-d[4].border_bottom,1,1)),d[1].border_right&&(e.fillStyle=x(this.theme,d[1].border_right_fill,1),e.fillRect(i-1,r+a-1,1,1)),d[1].border_top&&(e.fillStyle=x(this.theme,d[1].border_top_fill,1),e.fillRect(i-1,r+a-d[1].border_top,1,1)),d[8].border_bottom&&(e.fillStyle=x(this.theme,d[8].border_bottom_fill,1),2===d[8].border_bottom?(e.fillRect(i-1,r-2,o+1,1),e.fillRect(i-1,r-0,o+1,1),e.fillStyle=x(this.theme,d[8].fill)||C(this.theme,null===(n=this.theme.grid_cell)||void 0===n?void 0:n.fill)||"#fff",e.fillRect(i-1,r-1,o+1,1)):e.fillRect(i-1,r-1,o+1,1)),d[4].border_right&&(e.fillStyle=x(this.theme,d[4].border_right_fill,1),e.fillRect(i-1,r-1,1,a+1)),d[6].border_left&&(e.fillStyle=x(this.theme,d[4].border_left_fill,1),e.fillRect(i+o-1,r-1,1,a+1)),d[2].border_top&&(e.fillStyle=x(this.theme,d[2].border_top_fill,1),2===d[2].border_top?(e.fillRect(i-1,r+a-2,o+1,1),e.fillRect(i-1,r+a-0,o+1,1),e.fillStyle=x(this.theme,d[2].fill)||C(this.theme,null===(l=this.theme.grid_cell)||void 0===l?void 0:l.fill)||"#fff",e.fillRect(i-1,r+a-1,o+1,1)):e.fillRect(i-1,r+a-1,o+1,1)),s.border_top&&(e.fillStyle=x(this.theme,s.border_top_fill,1),2===s.border_top?(e.fillRect(i-1,r-2,o+1,1),e.fillRect(i-1,r+0,o+1,1),e.fillStyle=x(this.theme,s.fill)||C(this.theme,null===(h=this.theme.grid_cell)||void 0===h?void 0:h.fill)||"#fff",e.fillRect(i-1,r-1,o+1,1)):e.fillRect(i-1,r-1,o+1,1)),s.border_left&&(e.fillStyle=x(this.theme,s.border_left_fill,1),e.fillRect(i-1,r-1,1,a+1)),s.border_right&&(e.fillStyle=x(this.theme,s.border_right_fill,1),e.fillRect(i+o-1,r-1,1,a+1)),s.border_bottom&&(e.fillStyle=x(this.theme,s.border_bottom_fill,1),2===s.border_bottom?(e.fillRect(i-1,r+a-2,o+1,1),e.fillRect(i-1,r+a+0,o+1,1),e.fillStyle=x(this.theme,s.fill)||C(this.theme,null===(c=this.theme.grid_cell)||void 0===c?void 0:c.fill)||"#fff",e.fillRect(i-1,r+a-1,o+1,1)):e.fillRect(i-1,r+a-1,o+1,1))}RenderCellBackground(t,e,s,i,r,o){var a;s.fillStyle=this.theme.grid_color,s.fillRect(0,0,r,o);const n=x(this.theme,i.fill);if(n?(s.fillStyle=n,s.fillRect(0,0,r-1,o-1)):(s.fillStyle=C(this.theme,null===(a=this.theme.grid_cell)||void 0===a?void 0:a.fill)||"#fff",s.fillRect(0,0,r-1,o-1)),t){const t=2,e=1,i=8;s.fillStyle=this.theme.note_marker_color,s.beginPath(),s.moveTo(r-t,e),s.lineTo(r-t-i,e),s.lineTo(r-t,e+i),s.lineTo(r-t,e),s.fill()}this.RenderCellBorders(e,s,i,0,0,r,o)}RenderCell(t,e,s,i,a,n){var l,h,c;const d={},u=e.render_dirty;if(e.render_dirty=!1,t.needs_full_repaint&&(null===(l=e.renderer_data)||void 0===l?void 0:l.overflowed))return{};const m=e.style?Object.assign({},e.style):{};if(e.merge_area){if(i.row!==e.merge_area.start.row||i.column!==e.merge_area.start.column)return{};for(let t=e.merge_area.start.column+1;t<=e.merge_area.end.column;t++)a+=this.layout.ColumnWidth(t);for(let t=e.merge_area.start.row+1;t<=e.merge_area.end.row;t++)n+=this.layout.RowHeight(t);if(e.merge_area.count>1){const t=this.model.active_sheet.CellStyleData(e.merge_area.end);t&&(m.border_bottom=t.border_bottom,m.border_right=t.border_right,m.border_bottom_fill=t.border_bottom_fill,m.border_right_fill=t.border_right_fill)}e.merge_area.end.column>t.last_cell.column&&(d.tile_overflow_right=!0),e.merge_area.end.row>t.last_cell.row&&(d.tile_overflow_bottom=!0),(d.tile_overflow_bottom||d.tile_overflow_right)&&this.overflow_areas.push({tile:t,head:Object.assign({},i),area:new r(e.merge_area.start,e.merge_area.end)})}const f=!!e.hyperlink;if(e.render_function){this.RenderCellBackground(!!e.note,i,s,m,a,n),s.strokeStyle=s.fillStyle=x(this.theme,m.text,1);const t=this.ResolveColors(m);if(e.render_function.call(void 0,{width:a,height:n,context:s,cell:e,style:t,scale:this.layout.scale||1}).handled)return d}if(!e.formatted)return this.RenderCellBackground(!!e.note,i,d.tile_overflow_bottom||d.tile_overflow_right?this.buffer_context:s,m,a,n),d;const p=v.Font(m,this.layout.scale);p!==this.last_font&&(s.font=this.last_font=p),!u&&e.renderer_data&&e.renderer_data.width===a&&e.renderer_data.height===n||(e.renderer_data={text_data:this.PrepText(s,e,a),width:a,height:n});const _=e.renderer_data.text_data,g=_.width>a-2*this.cell_edge_buffer;let b=a,w=0,S=!1;const A=e.type===o.number||e.calculated_type===o.number;let M=m.horizontal_align;M===v.HorizontalAlign.None&&(M=A?v.HorizontalAlign.Right:v.HorizontalAlign.Left);const k=[];if(g)if(e.type===o.number||e.calculated_type===o.number||m.wrap||e.merge_area)S=!A;else{const e=_.width-a+this.cell_edge_buffer;let s=0,o=0;M===v.HorizontalAlign.Center?s=o=e/2:M===v.HorizontalAlign.Right?s=e:o=e;let l=i.column,h=i.column;for(;o>0&&l<this.layout.last_column;){l++;const t={row:i.row,column:l},e=this.model.active_sheet.CellData(t),s=this.layout.ColumnWidth(l);if(o-=s,!e||e.type||e.calculated_type){S=!0;break}k.push({address:t,cell:e,grid:new y(b,0,s,n),background:new y(b-1,0,s,n-1),border:new y(b,0,s,n)}),b+=s,e.render_dirty=!1,e.renderer_data={overflowed:!0}}for(l>t.last_cell.column&&(d.tile_overflow_right=!0);s>0&&h>=1;){h--;const t={row:i.row,column:h},e=this.model.active_sheet.CellData(t),r=this.layout.ColumnWidth(h);if(s-=r,!e||e.type||e.calculated_type){S=!0;break}w-=r,k.push({address:t,cell:e,grid:new y(w,0,r,n),background:new y(w,0,r,n-1),border:new y(w,0,r,n)})}h<t.first_cell.column&&(d.tile_overflow_left=!0),this.overflow_areas.push({head:Object.assign({},i),tile:t,area:new r({row:i.row,column:h},{row:i.row,column:l})})}let R=!1;const L=s;(d.tile_overflow_bottom||d.tile_overflow_left||d.tile_overflow_right)&&(R=!0,d.width=b-w,d.height=n,d.left=w,this.EnsureBuffer(d.width+1,n+1,-w),(s=this.buffer_context).font=p),this.RenderCellBackground(!!e.note,i,s,m,a,n);for(const t of k)(null===(h=t.cell.style)||void 0===h?void 0:h.fill)&&(t.cell.style.fill.text||t.cell.style.fill.theme||0===t.cell.style.fill.theme)&&!this.options.grid_over_background?(s.fillStyle=C(this.theme,t.cell.style.fill),s.fillRect(t.grid.left,t.grid.top,t.grid.width,t.grid.height)):(s.fillStyle=this.theme.grid_color||"",s.fillRect(t.grid.left,t.grid.top,t.grid.width,t.grid.height),s.fillStyle=(null===(c=this.theme.grid_cell)||void 0===c?void 0:c.fill)?C(this.theme,this.theme.grid_cell.fill):"",s.fillRect(t.background.left,t.background.top,t.background.width,t.background.height)),t.cell.style&&this.RenderCellBorders(t.address,s,t.cell.style,t.border.left,t.border.top,t.border.width,t.border.height);const E=Mt.Get(p);s.lineWidth=1,s.strokeStyle=s.fillStyle=_.format?_.format:x(this.theme,m.text,1),s.beginPath();let T=this.cell_edge_buffer;const D=1.3,z=_.single?1:_.strings.length,N=z*E.block*D;S=(S||N>=n)&&!R,S&&(s.save(),s.beginPath(),s.moveTo(w+1.5,0),s.lineTo(w+1.5,n),s.lineTo(b-1.5,n),s.lineTo(b-1.5,0),s.clip()),s.beginPath();let P=Math.round(n-2-E.block*D*(z-1)+Rt);switch(m.vertical_align){case v.VerticalAlign.Top:P=Math.round(E.block*D)+1;break;case v.VerticalAlign.Middle:P=Math.round((n-N)/2+E.block*D)}if(e.type!==o.number&&e.calculated_type!==o.number||!g)if(_.single){M===v.HorizontalAlign.Center?T=Math.round((a-_.width)/2):M===v.HorizontalAlign.Right&&(T=a-this.cell_edge_buffer-_.width);const t=P-.5-Rt,e=Math.round(P-E.ascender/2)+.5;for(const i of _.strings)i.hidden||(s.fillText(i.text,T,P),m.font_underline&&(s.moveTo(T,t),s.lineTo(T+i.width,t)),m.font_strike&&(s.moveTo(T,e),s.lineTo(T+i.width,e))),f&&(i.left=T,i.top=P-E.block,i.height=E.block),T+=i.width}else{let t=P,e=0;for(const i of _.strings){if(M===v.HorizontalAlign.Center?T=Math.round((a-i.width)/2):M===v.HorizontalAlign.Right&&(T=a-this.cell_edge_buffer-i.width),m.font_underline){const e=t-.5-Rt;s.moveTo(T,e),s.lineTo(T+i.width,e)}if(m.font_strike){const e=Math.round(t-E.ascender/2)+.5;s.moveTo(T,e),s.lineTo(T+i.width,e)}s.fillText(i.text,T,t),f&&(i.left=T,i.top=t-E.block,i.height=E.block),e++,t=Math.round(P+e*E.block*D)}}else{const t=Math.floor((a-2*this.cell_edge_buffer)/E.hash);let e="";for(let s=0;s<t;s++)e+="#";const i=s.measureText(e).width;M===v.HorizontalAlign.Center?T=Math.round((a-i)/2):M===v.HorizontalAlign.Right&&(T=a-this.cell_edge_buffer-i),s.fillText(e,T,P)}if(s.stroke(),S)s.restore();else if(R){const t=this.layout.dpr;L.drawImage(this.buffer_canvas,0,0,(d.width||0)*t,n*t,w,0,d.width||0,n)}return d}}class Et extends wt{constructor(t,e,s,i,r){super(e,s,r),this.container=t,this.options=i,this.focused_=!1,this.lines=1,this.last_formula="",this.label_update_timer=0;const o=ft.CreateDiv("treb-formula-bar-container notranslate",t),a=ft.CreateDiv("treb-formula-bar",o);this.address_label_container=ft.CreateDiv("address-label",a),this.address_label=ft.CreateDiv("",this.address_label_container),this.InitAddressLabel(),this.options.insert_function_button&&(this.button=ft.Create("button","formula-button",a),this.button.addEventListener("click",(()=>{const t=this.editor_node&&this.editor_node.textContent||"";this.Publish({type:"formula-button",formula:t})}))),this.container_node=ft.CreateDiv("editor-container",a),this.editor_node=ft.CreateDiv("formula-editor",this.container_node),this.editor_node.setAttribute("contenteditable","true"),this.editor_node.spellcheck=!0,this.editor_node.addEventListener("focusin",(()=>{if(!this.editor_node)return;let t=this.editor_node.textContent||"";"{"===t[0]&&"}"===t[t.length-1]&&(t=t.substr(1,t.length-2),this.editor_node.textContent=t,this.last_reconstructed_text=""),this.editor_node.spellcheck="="!==t[0],this.autocomplete.ResetBlock(),F().then((()=>{this.Reconstruct()}));const e=this.ListDependencies();this.Publish([{type:"start-editing",editor:"formula-bar"},{type:"update",text:t,cell:this.active_cell,dependencies:e},{type:"retain-focus",focus:!0}]),this.focused_=!0})),this.editor_node.addEventListener("focusout",(()=>{this.autocomplete.Hide(),this.Publish([{type:"stop-editing"},{type:"retain-focus",focus:!1}]),this.focused_=!1})),this.editor_node.addEventListener("keydown",(t=>this.FormulaKeyDown(t))),this.editor_node.addEventListener("keyup",(t=>this.FormulaKeyUp(t))),this.editor_node.addEventListener("input",(()=>{this.Reconstruct(),this.UpdateSelectState()})),this.options.expand_formula_button&&(this.expand_button=ft.Create("button","expand-button",a),this.expand_button.addEventListener("click",(t=>{t.stopPropagation(),t.preventDefault(),this.editor_node&&(this.editor_node.scrollTop=0),a.classList.toggle("expanded")})))}get focused(){return this.focused_}set formula(t){this.editor_node&&(this.editor_node.textContent=t,this.last_reconstructed_text=""),this.last_formula=t}get formula(){return this.editor_node&&this.editor_node.textContent||""}set label(t){t.trim().length?(this.address_label.textContent=t,this.label_update_timer||(this.label_update_timer=requestAnimationFrame((()=>{this.label_update_timer=0,this.address_label.scrollWidth>this.address_label.offsetWidth?this.address_label.setAttribute("title",t):this.address_label.removeAttribute("title")})))):(this.address_label.innerHTML="&nbsp;",this.address_label.removeAttribute("title"))}get label(){var t;return(null===(t=this.address_label)||void 0===t?void 0:t.textContent)||""}set editable(t){this.editor_node&&this.container_node&&(this.editor_node.setAttribute("contenteditable",t.toString()),t?this.container_node.classList.remove("locked"):this.container_node.classList.add("locked"))}IsElement(t){return t===this.editor_node}InitAddressLabel(){this.address_label.contentEditable="true",this.address_label.spellcheck=!1,this.address_label.addEventListener("focusin",(t=>{requestAnimationFrame((()=>{if(document.body.createTextRange){const t=document.body.createTextRange();t.moveToElementText(this.address_label),t.select()}else{const t=window.getSelection(),e=document.createRange();e.selectNodeContents(this.address_label),null==t||t.removeAllRanges(),null==t||t.addRange(e)}}))})),this.address_label.addEventListener("keydown",(t=>{switch(t.key){case"Enter":t.stopPropagation(),t.preventDefault(),this.Publish({type:"address-label-event",text:this.address_label.textContent||void 0});break;case"Esc":case"Escape":t.stopPropagation(),t.preventDefault(),this.Publish({type:"address-label-event"})}}))}FocusEditor(){this.editor_node&&this.editor_node.focus()}GetTextContent(t){const e=t.childNodes,s=[];for(let t=0;t<e.length;t++){const i=e[t];switch(i.nodeType){case Node.ELEMENT_NODE:s.push(...this.GetTextContent(i)),i instanceof Element&&"DIV"===i.tagName&&s.push("\n");break;case Node.TEXT_NODE:i.nodeValue&&s.push(i.nodeValue)}}return s}FormulaKeyDown(t){const e=this.autocomplete.HandleKey("keydown",t);if(e.accept&&this.AcceptAutocomplete(e),!e.handled){switch(t.key){case"Enter":case"Tab":{this.selecting_=!1;const e="Enter"===t.key&&t.ctrlKey&&t.shiftKey,s=(this.editor_node?this.GetTextContent(this.editor_node).join(""):"").trim();this.Publish({type:"commit",selection:this.selection,value:s,event:t,array:e}),this.FlushReference()}break;case"Escape":case"Esc":this.selecting_=!1,this.Publish({type:"discard"}),this.FlushReference();break;default:return}t.stopPropagation(),t.preventDefault()}}FormulaKeyUp(t){this.autocomplete.HandleKey("keyup",t).handled||(this.FlushReference(),this.trident&&(this.UpdateSelectState(),this.Reconstruct()))}}const Tt={scrollbars:!0,in_cell_editor:!0,formula_bar:!0,add_tab:!1,tab_bar:"auto",insert_function_button:!1,expand_formula_button:!1,expand:!0,repaint_on_cell_change:!0,grid_over_background:!1};var Dt,zt,Nt,Pt,Ft,It,Ut,Ot;!function(t){t.None="none",t.All="all",t.Outside="outside",t.Top="top",t.Bottom="bottom",t.Left="left",t.Right="right",t.DoubleTop="double-top",t.DoubleBottom="double-bottom"}(Dt||(Dt={}));class $t{constructor(t={}){this.options=t,this.completion_list_visible=!1,this.tooltip_visible=!1,this.selected_index=0,this.block=!1,this.autocomplete_data={},this.completion_list=ft.CreateDiv("treb-cell-editor-ac-list treb-autocomplete",t.container||document.body),this.completion_list.addEventListener("mousedown",(t=>this.ListMouseDown(t))),this.completion_list.addEventListener("mousemove",(t=>this.ListMouseMove(t))),this.tooltip=ft.CreateDiv("treb-cell-editor-ac-tooltip treb-autocomplete-tooltip",t.container||document.body)}Hide(){this.tooltip.style.top="-1000px",this.completion_list.style.top="-1000px",this.completion_list_visible=!1,this.tooltip_visible=!1,this.active_element=void 0}ResetBlock(){this.block=!1}ListMouseMove(t){const e=t.target;"A"===e.tagName&&e!==this.active_element&&this.active_element&&(this.active_element.classList.remove("selected"),this.active_element=e,this.active_element.classList.add("selected"),this.selected_index=Number(e.dataset.index||"0"),this.last_completion=e.textContent||"")}ListMouseDown(t){t.stopPropagation(),t.preventDefault();let e=t.target;for(;e;){if(e===this.completion_list)return;if("A"===e.tagName)break;e=e.parentElement}e&&(console.info(e),this.callback&&this.callback({handled:!0,accept:!0,value:e.textContent?e.textContent:void 0,data:this.autocomplete_data,click:!0}))}HandleKey(t,e){if(!this.completion_list_visible)return{handled:!1};let s=0,i=!1,r=!1;switch(e.key){case"Up":case"ArrowUp":s=-1;break;case"Down":case"ArrowDown":s=1;break;case"Tab":r=!0;break;case"Escape":case"Esc":i=!0;break;default:return{handled:!1}}if(e.stopPropagation(),e.preventDefault(),"keyup"===t)return{handled:!0};if(s){const t=this.completion_list.getBoundingClientRect();this.selected_index+=s,this.selected_index=Math.max(0,this.selected_index);const e=this.completion_list.querySelectorAll("a");this.selected_index=Math.min(this.selected_index,e.length-1);for(let s=0;s<e.length;s++){const i=e[s];if(s===this.selected_index){i.classList.add("selected"),this.active_element=i;const e=i.getBoundingClientRect();e.top<t.top?this.completion_list.scrollBy(0,-e.height):e.bottom>t.bottom&&this.completion_list.scrollBy(0,e.height),this.last_completion=i.textContent||void 0}else i.classList.remove("selected")}return{handled:!0}}return i?(this.block=!0,this.Hide(),{handled:!0}):r?{handled:!0,accept:!0,value:this.last_completion,data:this.autocomplete_data}:{handled:!1}}Show(t,e={},s){if(this.completion_list_visible=!1,this.tooltip_visible=!1,this.autocomplete_data=e,this.callback=t,!this.block)if(e.tooltip?(this.tooltip.innerHTML=e.tooltip+e.arguments+(e.description?"\n"+e.description:""),this.tooltip.style.left=s.left+"px",this.options.tooltip_prefer_top?this.tooltip.style.top=s.top-this.tooltip.offsetHeight-5+"px":this.tooltip.style.top=s.bottom+5+"px",this.tooltip_visible=!0):this.tooltip.style.top="-1000px",e.completions&&e.completions.length){this.tooltip.style.top="-1000px",this.selected_index=0,this.completion_list.innerHTML='<ul class="notranslate">'+e.completions.map(((t,e)=>(t.name===this.last_completion&&(this.selected_index=e),`<li><a data-index="${e}">${t.name}</a></li>`))).join("\n")+"<ul>";const t=this.completion_list.offsetHeight;let i=!1;this.options.autocomplete_prefer_top?i=s.top>=200:document.documentElement&&Math.max(document.documentElement.clientHeight,window.innerHeight||0)-s.bottom<200&&(i=!0),this.completion_list.style.top=i?s.top-t-5+"px":s.bottom+5+"px",this.completion_list.style.left=s.left+"px";const r=this.completion_list.querySelectorAll("a");this.active_element=r[this.selected_index],r[this.selected_index].classList.add("selected"),this.last_completion=r[this.selected_index].textContent||void 0,this.completion_list.scrollTop=this.active_element.offsetTop,this.completion_list_visible=!0}else this.completion_list.style.top="-1000px"}}!function(t){t[t.Null=0]="Null",t[t.InsertRows=1]="InsertRows",t[t.InsertColumns=2]="InsertColumns",t[t.ResizeRows=3]="ResizeRows",t[t.ResizeColumns=4]="ResizeColumns",t[t.Select=5]="Select",t[t.SetRange=6]="SetRange",t[t.UpdateStyle=7]="UpdateStyle",t[t.UpdateBorders=8]="UpdateBorders",t[t.MergeCells=9]="MergeCells",t[t.UnmergeCells=10]="UnmergeCells",t[t.Clear=11]="Clear",t[t.UpdateTheme=12]="UpdateTheme",t[t.SetNote=13]="SetNote",t[t.SetLink=14]="SetLink",t[t.Freeze=15]="Freeze",t[t.SetName=16]="SetName",t[t.ShowHeaders=17]="ShowHeaders",t[t.AddSheet=18]="AddSheet",t[t.DuplicateSheet=19]="DuplicateSheet",t[t.DeleteSheet=20]="DeleteSheet",t[t.ActivateSheet=21]="ActivateSheet",t[t.RenameSheet=22]="RenameSheet",t[t.ReorderSheet=23]="ReorderSheet",t[t.ShowSheet=24]="ShowSheet",t[t.DataValidation=25]="DataValidation"}(zt||(zt={}));class Ht{constructor(){this.forward={},this.backward=[]}Count(){return this.backward.length}Serialize(){return JSON.parse(JSON.stringify(this.Map()))}Deserialize(t){if(this.Reset(),t){for(const e of Object.keys(t))this.SetName(e,new r(t[e].start,t[e].end),!1);this.RebuildList()}}MatchSelection(t,e){if(!t.start.sheet_id)throw new Error("match selection without sheet id");let s;for(const i of this.List())if(i.range.start.sheet_id===t.start.sheet_id&&(i.range.Equals(t)&&(s=i.name),null==e?void 0:e.Equals(i.range)))return i.name;return s}SetName(t,e,s=!0){const i=this.ValidateNamed(t);return i?e.entire_column||e.entire_row?(console.warn("invalid range"),!1):(this.forward[i]=e,s&&this.RebuildList(),!0):(console.warn("invalid name"),!1)}SetNames(t){for(const e of Object.keys(t)){const s=t[e];this.SetName(e,new r(s.start,s.end),!1)}this.RebuildList()}ClearName(t,e=!0){delete this.forward[t],e&&this.RebuildList()}Reset(){this.forward={},this.backward=[]}Get(t){return this.forward[t.toUpperCase()]}Map(){return this.forward}List(){return this.backward}ValidateNamed(t){return!!(t=t.trim()).length&&!/^[A-Za-z]{1,3}\d+$/.test(t)&&!/[^A-Za-z\d_.]/.test(t)&&!/^[^A-Za-z_]/.test(t)&&t.toUpperCase()}PatchNamedRanges(t,e,s,i){const o=this.List().slice(0);for(const a of o){const o=a.name,n=a.range;if(e&&t<=n.end.column)if(e>0)t<=n.start.column?n.Shift(0,e):t>n.start.column&&t<=n.end.column?n.ConsumeAddress({row:n.end.row,column:n.end.column+e}):console.warn("PNR X case 1",t,e,JSON.stringify(n));else if(e<0)if(t-e<=n.start.column)n.Shift(0,e);else if(t<=n.start.column&&t-e>n.end.column)this.ClearName(o,!1);else if(t<=n.start.column){const s=t-e-1;this.SetName(o,new r({row:n.start.row,column:s+1+e},{row:n.end.row,column:n.end.column+e}),!1)}else t<=n.end.column?t-e-1>=n.end.column?this.SetName(o,new r({row:n.start.row,column:n.start.column},{row:n.end.row,column:t-1}),!1):this.SetName(o,new r({row:n.start.row,column:n.start.column},{row:n.end.row,column:n.start.column+n.columns+e-1}),!1):console.warn("PNR X case 2",t,e,JSON.stringify(n));if(i&&s<=n.end.row)if(i>0)s<=n.start.row?n.Shift(i,0):s>n.start.row&&s<=n.end.row?n.ConsumeAddress({row:n.end.row+i,column:n.end.column}):console.warn("PNR X case 3",s,i,JSON.stringify(n));else if(i<0)if(s-i<=n.start.row)n.Shift(i,0);else if(s<=n.start.row&&s-i>n.end.row)this.ClearName(o,!1);else if(s<=n.start.row){const t=s-i-1;this.SetName(o,new r({column:n.start.column,row:t+1+i},{column:n.end.column,row:n.end.row+i}),!1)}else s<=n.end.row?s-i-1>=n.end.row?this.SetName(o,new r({column:n.start.column,row:n.start.row},{column:n.end.column,row:s-1}),!1):this.SetName(o,new r({column:n.start.column,row:n.start.row},{column:n.end.column,row:n.start.row+n.rows+i-1}),!1):console.warn("PNR X case 4",s,i,JSON.stringify(n))}this.RebuildList()}RebuildList(){this.backward=[];for(const t of Object.keys(this.forward))this.backward.push({name:t,range:this.forward[t]})}}!function(t){t[t.NotEditing=0]="NotEditing",t[t.CellEditor=1]="CellEditor",t[t.FormulaBar=2]="FormulaBar"}(Nt||(Nt={}));class Vt{constructor(t={},e=w){this.grid_events=new O,this.command_log=new O,this.headless=!1,this.hover_data={},this.batch=!1,this.batch_events=[],this.editing_state=Nt.NotEditing,this.editing_cell={row:-1,column:-1,sheet_id:0},this.tile_update_pending=!1,this.parser=new N,this.decimal_separator_code=46,this.RESIZE_PIXEL_BUFFER=5,this.select_argument=!1,this.cell_resize={row:-1,column:-1},this.render_tiles=new r({row:0,column:0}),this.primary_selection={target:{row:0,column:0},area:new r({row:0,column:0}),empty:!0},this.active_selection={target:{row:0,column:0},area:new r({row:0,column:0}),empty:!0},this.nub_select_flag=!1,this.additional_selections=[],this.double_click_data={},this.layout_token=0,this.render_token=0,this.autocomplete_matcher=new vt,this.theme_style_properties=v.Composite([v.DefaultProperties]);const s=[mt.Blank(this.theme_style_properties)];var i;this.model={sheets:s,active_sheet:s[0],named_ranges:new Ht,macro_functions:{}},this.theme=JSON.parse(JSON.stringify(e)),this.options=Object.assign(Object.assign({},Tt),t),this.layout=(i=this.model,new gt(i)),t.initial_scale&&("string"==typeof t.initial_scale&&(t.initial_scale=Number(t.initial_scale)),this.layout.scale=t.initial_scale),this.tile_renderer=new Lt(this.theme,this.layout,this.model,this.options),this.selection_renderer=new lt(this.theme,this.layout,this.model,this.primary_selection,this.additional_selections),"."===g.decimal_separator?(this.parser.decimal_mark=k.Period,this.parser.argument_separator=M.Comma):(this.parser.decimal_mark=k.Comma,this.parser.argument_separator=M.Semicolon),this.decimal_separator_code=g.decimal_separator.charCodeAt(0)}get active_sheet(){return this.model.active_sheet}set active_sheet(t){this.model.active_sheet=t}SetNote(t,e){if(!t){if(this.primary_selection.empty)return;t=this.primary_selection.target}this.ExecCommand({key:zt.SetNote,address:t,note:e})}SetLink(t,e){if(!t){if(this.primary_selection.empty)return;t=this.primary_selection.target}this.ExecCommand({key:zt.SetLink,address:t,reference:e})}FindAnnotation(t){for(const e of this.active_sheet.annotations)if(e.node===t)return e}CreateAnnotation(t={},e=!0,s=!1,i){const r=new ut(t);if(s)if(!r.layout&&r.scaled_rect&&(r.layout=this.layout.RectToAnnotationLayout(r.scaled_rect)),r.layout){let t=this.layout.AnnotationLayoutToRect(r.layout).Shift(20,20),e=!0;for(;e;){e=!1;for(const s of this.active_sheet.annotations)if(s!==r&&s.scaled_rect&&s.scaled_rect.top===t.top&&s.scaled_rect.left===t.left){t=t.Shift(20,20),e=!0;break}}r.layout=this.layout.RectToAnnotationLayout(t)}else console.warn("can't offset annotation without layout");return i&&(y.IsRectangle(i)?(r.layout=void 0,r.rect=y.Create(i)):i.start&&(r.rect=void 0,r.layout=this.layout.AddressToAnnotationLayout(i.start,i.end||i.start))),e&&(this.active_sheet.annotations.some((t=>t===r))||this.active_sheet.annotations.push(r),this.AddAnnotation(r)),r}UpdateScale(t=1){var e,s;this.layout.scale=t,this.UpdateLayout(),this.UpdateAnnotationLayout(),this.layout.UpdateAnnotation(this.active_sheet.annotations),this.layout.ApplyTheme(this.theme),null===(e=this.overlay_editor)||void 0===e||e.UpdateTheme(t),null===(s=this.tab_bar)||void 0===s||s.UpdateScale(t),this.grid_events.Publish({type:"scale",scale:t});for(const t of this.model.sheets)for(const e of t.annotations)e.dirty=!0}UpdateAnnotationLayout(){}AddAnnotation(t,e=!1,s=!0){if(!t.node){t.node=document.createElement("div"),t.node.dataset.scale=this.layout.scale.toString(),t.node.style.fontSize=10*this.layout.scale+"pt",t.content_node=ft.CreateDiv("annotation-content",t.node);const e=ft.CreateDiv("annotation-move-target",t.node),s=ft.CreateDiv("annotation-resize-target",t.node);if(t.node){const i=t.node;i.setAttribute("tabindex","-1"),i.addEventListener("mousedown",(r=>{this.layout.AnnotationMouseDown(t,i,r,e,s).then((t=>{t&&this.grid_events.Publish(t)}))})),t.node.addEventListener("focusin",(()=>{for(const e of this.layout.GetFrozenAnnotations(t))e.classList.add("clone-focus");this.selected_annotation=t,this.primary_selection.empty=!0,this.primary_selection.target={row:-1,column:-1,sheet_id:this.active_sheet.id},this.HideGridSelection()})),t.node.addEventListener("focusout",(e=>{for(const e of this.layout.GetFrozenAnnotations(t))e.classList.remove("clone-focus");this.formula_bar&&this.formula_bar.IsElement(e.relatedTarget)?(this.primary_selection.empty=!0,this.RenderSelections(),this.editing_annotation=t,this.layout.ShowSelections(!0)):(this.selected_annotation===t&&(this.selected_annotation=void 0),this.ShowGridSelection())})),t.node.addEventListener("keydown",(e=>{const s=t.scaled_rect;if(!s)return void console.info("missing scaled rect!");const r=[i,...this.layout.GetFrozenAnnotations(t)],o={x:s.left,y:s.top};switch(e.key){case"ArrowUp":case"Up":e.ctrlKey?(this.layout.AnnotationLayoutOrder(t,1)&&this.grid_events.Publish({type:"annotation",event:"move",annotation:t}),i.focus()):o.y--;break;case"ArrowLeft":case"Left":if(e.ctrlKey)return;o.x--;break;case"ArrowRight":case"Right":if(e.ctrlKey)return;o.x++;break;case"ArrowDown":case"Down":e.ctrlKey?(this.layout.AnnotationLayoutOrder(t,-1)&&this.grid_events.Publish({type:"annotation",event:"move",annotation:t}),i.focus()):o.y++;break;case"Escape":case"Esc":this.Focus();break;case"Delete":case"Del":this.Focus(),this.RemoveAnnotation(t);break;default:return}if(e.stopPropagation(),e.preventDefault(),o.x=Math.max(o.x,0),o.y=Math.max(o.y,0),s.left!==o.x||s.top!==o.y){s.left=Math.round(o.x),s.top=Math.round(o.y);for(const t of r)t.style.top=s.top+"px",t.style.left=s.left+"px";t.extent=void 0,this.grid_events.Publish({type:"annotation",event:"move",annotation:t}),t.layout=this.layout.RectToAnnotationLayout(s)}}))}}t.node.classList.add("annotation"),s&&this.layout.AddAnnotation(t),e||this.grid_events.Publish({type:"annotation",annotation:t,event:"create"})}AnnotationUpdated(t){this.layout.CloneFrozenAnnotation(t)}RemoveAnnotation(t){for(let e=0;e<this.active_sheet.annotations.length;e++)if(t===this.active_sheet.annotations[e])return this.active_sheet.annotations.splice(e,1),this.layout.RemoveAnnotation(t),void this.grid_events.Publish({type:"annotation",annotation:t,event:"delete"})}RemoveAnnotationNodes(){this.layout.RemoveAnnotationNodes()}Serialize(t={}){this.active_sheet.selection=JSON.parse(JSON.stringify(this.primary_selection)),this.active_sheet.scroll_offset=this.layout.scroll_offset;const e=this.model.sheets.map((e=>e.toJSON(t)));let s;const i=Object.keys(this.model.macro_functions);if(i.length){s=[];for(const t of i)s.push(Object.assign(Object.assign({},this.model.macro_functions[t]),{expression:void 0}))}return{sheet_data:e,active_sheet:this.active_sheet.id,named_ranges:this.model.named_ranges.Count()?this.model.named_ranges.Serialize():void 0,macro_functions:s}}RealArea(t){return this.active_sheet.RealArea(t)}CellRenderData(t){return this.active_sheet.CellData(t)}Clear(){this.ExecCommand({key:zt.Clear})}FromCSV(t){const e=((t,e=",")=>{let s=P.default,i=[],r="";const o=[],a=t.length;if(/[\r\n"]/.test(e))throw new Error("invalid delimiter");for(let n=0;n<a;n++){const l=t[n];if(s===P.default)switch(l){case e:i.push(r),r="";break;case"\r":break;case"\n":i.push(r),r="",o.push(i),i=[];break;case'"':0===r.length?s=P.quoted:r+=l;break;default:r+=l}else'"'===l?n+1<a&&'"'===t[n+1]?(r+='"',n++):s=P.default:r+=l}return(i.length||r.length)&&(i.push(r),o.push(i)),o})(t).map((t=>t.map((t=>st.TryParse(t).value)))),s={row:Math.max(0,e.length-1),column:e.reduce(((t,e)=>Math.max(t,Math.max(0,e.length-1))),0)};this.ExecCommand([{key:zt.Clear},{key:zt.SetRange,area:{start:{row:0,column:0},end:s},value:e}])}ShowHeaders(t=!0){this.ExecCommand({key:zt.ShowHeaders,show:t})}FromImportData(t,e=!1){var s;this.RemoveAnnotationNodes();const i=t.sheets,o=i.map((()=>mt.Blank(this.theme_style_properties).toJSON()));let a;if("number"==typeof t.active_tab)a=null===(s=o[t.active_tab])||void 0===s?void 0:s.id;else for(let e=0;e<t.sheets.length;e++)if(!t.sheets[e].hidden){a=o[e].id;break}this.UpdateSheets(o,!0,a);const n={};this.model.macro_functions={},this.ClearSelection(this.primary_selection);for(let t=0;t<i.length;t++){const e=this.model.sheets[t];e.ImportData(i[t]),n[e.name]=e.id}if(this.model.named_ranges.Reset(),t.names){for(const e of Object.keys(t.names)){const s=t.names[e],i=this.parser.Parse(s);if(i.expression){if("range"===i.expression.type){const t=n[i.expression.start.sheet||""];t&&(i.expression.start.sheet_id=t,this.model.named_ranges.SetName(e,new r(i.expression.start,i.expression.end),!1))}if("address"===i.expression.type){const t=n[i.expression.sheet||""];t&&(i.expression.sheet_id=t,this.model.named_ranges.SetName(e,new r(i.expression),!1))}}}this.model.named_ranges.RebuildList()}for(const t of this.active_sheet.annotations)this.AddAnnotation(t,!0);this.QueueLayoutUpdate(),this.StyleDefaultFromTheme(),e&&this.Repaint(!1,!1),this.tab_bar&&this.tab_bar.Update()}ResetMetadata(){this.model.document_name=void 0,this.model.user_data=void 0}NextSheet(t=1){if(1!==this.model.sheets.length)for(let e=0;e<this.model.sheets.length;e++)if(this.model.sheets[e]===this.active_sheet){let s=(e+t)%this.model.sheets.length;for(;s<0;)s+=this.model.sheets.length;return void this.ActivateSheet(s)}}InsertSheet(t,e){if(void 0===t&&!this.model.sheets.some(((e,s)=>e===this.active_sheet&&(t=s+1,!0))))throw new Error("invalid index");this.ExecCommand({key:zt.AddSheet,insert_index:t,name:e})}DeleteSheet(t){if(void 0===t&&!this.model.sheets.some(((e,s)=>e===this.active_sheet&&(t=s,!0))))throw new Error("invalid index");this.ExecCommand({key:zt.DeleteSheet,index:t})}DuplicateSheet(t,e,s){const i={key:zt.DuplicateSheet,new_name:e,insert_before:s};void 0===t?i.id=this.active_sheet.id:i.index=t,this.ExecCommand(i)}AddSheet(t){this.ExecCommand({key:zt.AddSheet,name:t})}ActivateSheet(t){const e="number"==typeof t?t:void 0,s="string"==typeof t?t:void 0;this.ExecCommand({key:zt.ActivateSheet,index:e,name:s})}ActivateSheetID(t){this.ExecCommand({key:zt.ActivateSheet,id:t})}ShowAll(){const t=[];for(let e=0;e<this.model.sheets.length;e++)t.push({key:zt.ShowSheet,index:e,show:!0});this.ExecCommand(t)}ShowSheet(t=0,e=!0){const s={key:zt.ShowSheet,show:e};"string"==typeof t?s.name=t:s.index=t,this.ExecCommand(s)}UpdateSheets(t,e=!1,s){this.RemoveAnnotationNodes(),mt.Reset();const i=t.map((t=>mt.FromJSON(t,this.theme_style_properties)));if(0===i.length&&i.push(mt.Blank(this.theme_style_properties)),this.model.sheets=i,this.active_sheet=i[0],s)if("number"==typeof s){for(const t of this.model.sheets)if(s===t.id){this.active_sheet=t;break}}else if("string"==typeof s)for(const t of this.model.sheets)if(s===t.name){this.active_sheet=t;break}if(this.ClearSelection(this.primary_selection),t[0]&&t[0].primary_selection){const e=t[0].primary_selection;e.empty||this.Select(this.primary_selection,new r(e.area.start,e.area.end),e.target)}else if(!this.active_sheet.selection.empty){const t=this.active_sheet.selection;this.Select(this.primary_selection,new r(t.area.start,t.area.end),t.target)}this.ResetMetadata(),this.layout.ClearLayoutCaches();for(const t of this.model.sheets)for(const e of t.annotations)this.AddAnnotation(e,!0,t===this.active_sheet);this.QueueLayoutUpdate(),this.StyleDefaultFromTheme(),e&&this.Repaint(!1,!1),this.tab_bar&&this.tab_bar.Update()}UpdateLayout(){this.layout.UpdateTiles(),this.render_tiles=this.layout.VisibleTiles(),this.Repaint(!0)}ApplyTheme(){this.UpdateTheme(!0)}UpdateTheme(t=!1,e){var s;if(!t)for(const t of Object.keys(this.theme))delete this.theme[t];let i=JSON.parse(JSON.stringify(w));if(this.grid_container){const t=(t=>{var e,s,i;const r=JSON.parse(JSON.stringify(w)),o=(t,e)=>{const s=document.createElement("div");return s.setAttribute("class",e),t.appendChild(s),s},a=o(t,""),n=((t,e)=>window.getComputedStyle(o(t,e))).bind(0,a);let l=n("grid-cells");r.grid_cell=S(l),r.grid_color=l.stroke||"",l=n("grid-headers"),r.headers=S(l),l=n("note-marker"),r.note_marker_color=l.backgroundColor,a.style.color="rgba(1,2,3,.4)",l=n("");const h=l.color;r.theme_colors=[(null===(e=r.grid_cell.fill)||void 0===e?void 0:e.text)||"rgb(255, 255, 255)",(null===(s=r.grid_cell.text)||void 0===s?void 0:s.text)||"rgb(51, 51, 51)"];for(let t=1;t<32&&(l=n(`theme-color-${t}`),l.color&&l.color!==h);t++)r.theme_colors.push(l.color);const c=document.createElement("canvas");c.width=3,c.height=3;const d=c.getContext("2d");return d&&(r.theme_colors_rgb=r.theme_colors.map((t=>{d.fillStyle=t,d.fillRect(0,0,3,3);const e=d.getImageData(1,1,1,1);return Array.from(e.data)}))),null===(i=a.parentElement)||void 0===i||i.removeChild(a),r})(this.grid_container);i=Object.assign({},t)}i=Object.assign(Object.assign(Object.assign({},this.theme),i),e),Object.assign(this.theme,i),this.StyleDefaultFromTheme(),this.active_sheet.UpdateDefaultRowHeight(),this.active_sheet.FlushCellStyles(),this.layout.ApplyTheme(this.theme),t||(this.UpdateLayout(),null===(s=this.overlay_editor)||void 0===s||s.UpdateTheme(this.layout.scale),this.Repaint(!0,!0,!0))}Initialize(t,e=!1){this.grid_container=t,t.classList.add("treb-main"),bt.is_windows&&t.classList.add("treb-ua-windows"),t.classList.add("treb-theme"),this.ApplyTheme();const s=document.createElement("div"),i=document.createElement("div");let r;i.classList.add("treb-layout-master"),i.appendChild(s),t.appendChild(i),this.options.formula_bar&&(r||(r=new $t({theme:this.theme,container:s})),this.InitFormulaBar(t,r)),this.options.tab_bar&&(this.tab_bar=new ct(this.layout,this.model,this.options,this.theme,t),this.tab_bar.Subscribe((t=>{switch(t.type){case"cancel":break;case"scale":{let e=this.layout.scale;switch(t.action){case"increase":e+=.05;break;case"decrease":e-=.05;break;default:e=t.action}e=Math.round(100*e)/100,e=Math.min(2,Math.max(e,.5)),this.options.persist_scale_key&&localStorage.setItem(this.options.persist_scale_key,JSON.stringify({scale:e})),this.UpdateScale(e)}break;case"reorder-sheet":this.ReorderSheet(t.index,t.move_before);break;case"delete-sheet":this.DeleteSheet();break;case"add-sheet":this.AddSheet();break;case"rename-sheet":this.RenameSheet(t.sheet,t.name);break;case"activate-sheet":this.ActivateSheetID(t.sheet.id)}this.Focus()}))),this.container=s,this.container.classList.add("treb-grid"),bt.is_mac&&bt.is_safari&&this.container.classList.add("safari"),this.container.setAttribute("tabindex","-1"),this.layout.Initialize(s,(()=>this.OnScroll()),(t=>this.OnDropdownSelect(t)),this.options.scrollbars),this.selection_renderer.Initialize(),this.layout.UpdateTiles(),r||(r=new $t({theme:this.theme,container:s})),this.InitOverlayEditor(r),this.AttachListeners(),this.render_tiles=this.layout.VisibleTiles(),e||this.Repaint(!0)}MergeSelection(){this.primary_selection.empty||(this.layout.HideDropdownCaret(),this.ExecCommand({key:zt.MergeCells,area:this.primary_selection.area}))}UnmergeSelection(){this.primary_selection.empty||(this.layout.HideDropdownCaret(),this.ExecCommand({key:zt.UnmergeCells,area:this.primary_selection.area}))}Focus(){var t,e;bt.is_mobile?null===(t=this.container)||void 0===t||t.focus():null===(e=this.overlay_editor)||void 0===e||e.Focus()}SetValidation(t,e){if(!t){if(this.primary_selection.empty)throw new Error("invalid target in set validation");t=this.primary_selection.target}console.info("target",t);const s={key:zt.DataValidation,target:t};e&&(Array.isArray(e)?s.list=e:"object"==typeof e&&e.start&&e.end&&i(e.start)&&i(e.end)&&(s.range=e)),this.ExecCommand(s)}SetName(t,e){const s={key:zt.SetName,name:t};e&&(i(e)&&(e=new r(e)),e.start.sheet_id||(e=new r(Object.assign(Object.assign({},e.start),{sheet_id:this.active_sheet.id}),e.end)),s.area=new r(e.start,e.end)),this.ExecCommand(s)}GetNumberFormat(t){const e=this.active_sheet.CellStyleData(t);if(e&&e.number_format)return Q.Get(e.number_format).toString()}SelectAll(){this.Select(this.primary_selection,new r({row:1/0,column:1/0}),void 0,!0),this.RenderSelections()}SelectRange(t){this.Select(this.primary_selection,t),this.RenderSelections()}GetRange(t,e=!1,s=!1){let r=0;if(i(t)){r=t.sheet_id||this.active_sheet.id;for(const i of this.model.sheets)if(i.id===r)return e?i.cells.RawValue(t):s?i.GetFormattedRange(t):i.cells.GetRange(t)}else{r=t.start.sheet_id||this.active_sheet.id;for(const i of this.model.sheets)if(i.id===r)return e?i.cells.RawValue(t.start,t.end):s?i.GetFormattedRange(t.start,t.end):i.cells.GetRange(t.start,t.end)}}SetRange(t,e,s=!1,i=!1,r=!1){if(Array.isArray(e)){if(!((o=e)&&Array.isArray(o)&&Array.isArray(o[0])))if(s){const s=t.entire_column?this.active_sheet.rows:t.rows,i=t.entire_row?this.active_sheet.columns:t.columns,r=s*i;if(r>e.length){let t=e.slice(0);const s=Math.ceil(r/t.length);for(let i=1;i<s;i++)t=t.concat(e.slice(0));e=t}const o=[];for(let t=0,r=0;t<i;t++,r+=s)o[t]=e.slice(r,r+s);e=o}else e=[e];i&&(e=this.Transpose(e)),this.ExecCommand({key:zt.SetRange,area:t,value:e,array:r})}else s||r?this.ExecCommand({key:zt.SetRange,area:t,value:e,array:r}):this.ExecCommand({key:zt.SetRange,area:t.start,value:e,array:r});var o;!this.primary_selection.empty&&t.Contains(this.primary_selection.target)&&this.UpdateFormulaBarFormula()}SetRowHeight(t,e){this.ExecCommand({key:zt.ResizeRows,row:t,height:e})}SetColumnWidth(t,e=0){this.ExecCommand({key:zt.ResizeColumns,column:t,width:e})}ApplyStyle(t,e={},s=!0){if(!t){if(this.primary_selection.empty)return;t=this.primary_selection.area}this.ExecCommand({key:zt.UpdateStyle,area:t,style:e,delta:s}),this.UpdateFormulaBarFormula()}GetSelection(){return this.primary_selection}Update(t=!1,e){this.DelayedRender(t,e)}ApplyBorders(t,e=Dt.None,s,i=1){if(!t){if(this.primary_selection.empty)return;t=this.primary_selection.area}e===Dt.None&&(i=0),this.ExecCommand({key:zt.UpdateBorders,color:{text:s},area:t,borders:e,width:i})}ApplyBorders2(t,e=Dt.None,s,i=1){if(!t){if(this.primary_selection.empty)return;t=this.primary_selection.area}e===Dt.None&&(i=0),this.ExecCommand({key:zt.UpdateBorders,color:s,area:t,borders:e,width:i})}GetFreeze(){return Object.assign({},this.active_sheet.freeze)}Freeze(t=0,e=0,s=!0){this.ExecCommand({key:zt.Freeze,rows:t,columns:e,highlight_transition:s})}Batch(t,e=!0){this.batch=!0,t(),this.batch=!1;const s=this.batch_events.slice(0);return this.batch_events=[],e&&this.DelayedRender(!1),s}DeleteColumns(){if(this.primary_selection.empty)return;const t=this.primary_selection.area;if(t.entire_row)this.Clear();else{const e=t.start.column,s=-t.columns;this.ExecCommand({key:zt.InsertColumns,before_column:e,count:s})}}DeleteRows(){if(this.primary_selection.empty)return;const t=this.primary_selection.area;if(t.entire_column)this.Clear();else{const e=t.start.row,s=-t.rows;this.ExecCommand({key:zt.InsertRows,before_row:e,count:s})}}InsertColumn(){if(this.primary_selection.empty)return;const t=this.primary_selection.area,e=t.entire_row?0:t.start.column;this.InsertColumns(e,1)}InsertColumns(t=0,e=1){this.ExecCommand({key:zt.InsertColumns,before_column:t,count:e})}ReorderSheet(t,e){this.ExecCommand({key:zt.ReorderSheet,index:t,move_before:e})}RenameSheet(t=this.active_sheet,e){this.ExecCommand({key:zt.RenameSheet,new_name:e,id:t.id})}InsertRow(){if(this.primary_selection.empty)return;const t=this.primary_selection.area,e=t.entire_column?0:t.start.row;this.InsertRows(e,1)}InsertRows(t=0,e=1){this.ExecCommand({key:zt.InsertRows,before_row:t,count:e})}SetAutocompleteFunctions(t){const e=t.slice(0).concat(this.model.named_ranges.List().map((t=>({name:t.name,type:yt.Token}))));this.autocomplete_matcher.SetFunctions(e)}ScrollTo(t,e=!0,s=!0){this.layout.ScrollTo(t,e,s)}ScrollIntoView(t){this.options.scrollbars&&this.layout.ScrollIntoView(t)}GetScrollOffset(){return this.layout.GetScrollOffset()}DeleteSheetInternal(t){let e=!1,s=-1;const i=t.name?t.name.toLowerCase():"",r=this.model.sheets.filter(((r,o)=>o!==t.index&&r.id!==t.id&&r.name.toLowerCase()!==i||(e=r===this.active_sheet,s=o,!1)));if(r.length)if(r.every((t=>!t.visible)))r.unshift(mt.Blank(this.theme_style_properties)),s=0;else for(s>=r.length&&(s=0);!r[s].visible;)s++;else r.push(mt.Blank(this.theme_style_properties)),s=0;this.model.sheets=r,e&&this.ActivateSheetInternal({key:zt.ActivateSheet,index:s}),this.tab_bar&&this.tab_bar.Update()}AddSheetInternal(t=mt.default_sheet_name,e=-1){if(!this.options.add_tab)return void console.warn("add tab option not set or false");for(;this.model.sheets.some((e=>e.name===t));){const e=t.match(/^(.*?)(\d+)$/);e?t=e[1]+(Number(e[2])+1):t+="2"}const s=mt.Blank(this.theme_style_properties,t);return e>=0?this.model.sheets.splice(e,0,s):this.model.sheets.push(s),this.tab_bar&&this.tab_bar.Update(),s.id}DuplicateSheetInternal(t){if(!this.options.add_tab)return void console.warn("add tab option not set or false");const e=this.ResolveSheet(t),s=this.model.sheets.reduce(((t,e)=>Math.max(t,e.id)),0)+1;let i=-1;for(let t=0;t<this.model.sheets.length;t++)this.model.sheets[t]===e&&(i=t+1);if(!e||i<0)throw new Error("source sheet not found");if("number"==typeof t.insert_before)i=t.insert_before;else if("string"==typeof t.insert_before){const e=t.insert_before.toLowerCase();for(let t=0;t<this.model.sheets.length;t++)if(this.model.sheets[t].name.toLowerCase()===e){i=t;break}}const r=mt.FromJSON(e.toJSON({rendered_values:!0}),this.theme_style_properties);let o=t.new_name||e.name;for(;this.model.sheets.some((t=>t.name===o));){const t=o.match(/^(.*?)(\d+)$/);t?o=t[1]+(Number(t[2])+1):o+="2"}return r.name=o,r.id=s,this.model.sheets.splice(i,0,r),this.tab_bar&&this.tab_bar.Update(),r.id}ActivateSheetInternal(t){const e=this.SelectingArgument(),s=this.ResolveSheet(t)||this.model.sheets[0];if(this.active_sheet===s)return;if(!s.visible)throw new Error("cannot activate hidden sheet");this.HideHoverInfo(),this.active_sheet.selection=JSON.parse(JSON.stringify(this.primary_selection)),this.active_sheet.scroll_offset=this.layout.scroll_offset;const i=this.active_sheet;this.RemoveAnnotationNodes(),this.active_sheet=s,e?this.RenderSelections():(this.ClearSelection(this.primary_selection),s.selection&&!s.selection.empty&&this.Select(this.primary_selection,new r(s.selection.area.start,s.selection.area.end),s.selection.target));const o=this.active_sheet.annotations;for(const t of o)this.AddAnnotation(t,!0);this.QueueLayoutUpdate(),this.Repaint(!1,!1),this.grid_events.Publish({type:"sheet-change",deactivate:i,activate:this.active_sheet}),this.tab_bar&&this.tab_bar.Update(),this.layout.scroll_offset=this.active_sheet.scroll_offset}ResolveSheet(t){if(void 0!==t.index)return this.model.sheets[t.index];if(void 0!==t.name){const e=t.name.toLowerCase();for(const t of this.model.sheets)if(t.name.toLowerCase()===e)return t}if(t.id)for(const e of this.model.sheets)if(e.id===t.id)return e}ShowSheetInternal(t){const e=this.ResolveSheet(t);if(e&&e.visible!==t.show){if(!t.show){let t=0;for(const s of this.model.sheets)e.visible&&s!==e||t++;if(t>=this.model.sheets.length)throw new Error("can't hide all sheets")}if(e.visible=t.show,e===this.active_sheet)for(let t=0;t<this.model.sheets.length;t++)if(this.model.sheets[t]===this.active_sheet)return void this.ActivateSheetInternal({key:zt.ActivateSheet,index:t+1});this.tab_bar&&this.tab_bar.Update()}}StyleDefaultFromTheme(){var t,e,s;this.theme_style_properties.font_face=(null===(t=this.theme.grid_cell)||void 0===t?void 0:t.font_face)||"",this.theme_style_properties.font_size_unit=(null===(e=this.theme.grid_cell)||void 0===e?void 0:e.font_size_unit)||"pt",this.theme_style_properties.font_size_value=(null===(s=this.theme.grid_cell)||void 0===s?void 0:s.font_size_value)||10}HighlightFreezeArea(){for(const t of[this.layout.corner_selection,this.layout.row_header_selection,this.layout.column_header_selection]){const e=t.getAttribute("class")||"";bt.trident?t.setAttribute("class",e+" highlight-area"):t.classList.add("highlight-area"),setTimeout((()=>{bt.trident?t.setAttribute("class",e):t.classList.remove("highlight-area")}),400)}}QueueLayoutUpdate(){this.tile_update_pending=!0}HandleAddressLabelEvent(t){if(t){const e=(t="")=>{const e=t.toLowerCase();for(const t of this.model.sheets)if(t.name.toLowerCase()===e)return t.id;return this.active_sheet.id},s=t=>{for(const e of this.model.sheets)if(e.id===t)return e;return this.active_sheet};let i;const o=this.parser.Parse(t);if(o.expression)switch(o.expression.type){case"address":o.expression.sheet_id=e(o.expression.sheet),i=new r(o.expression);break;case"range":o.expression.start.sheet_id=e(o.expression.start.sheet),i=new r(o.expression.start,o.expression.end);break;case"identifier":i=this.model.named_ranges.Get(o.expression.name),i||this.primary_selection.empty||this.SetName(o.expression.name.toUpperCase(),this.primary_selection.area)}if(i){const t=s(i.start.sheet_id);if(t.columns>=i.end.column&&t.rows>=i.end.row)return void this.ExecCommand({key:zt.Select,area:i});console.warn("address out of range")}}this.UpdateAddressLabel(),this.Focus()}InitFormulaBar(t,e){this.formula_bar=new Et(t,this.theme,this.model,this.options,e),this.formula_bar.autocomplete_matcher=this.autocomplete_matcher,this.formula_bar.Subscribe((t=>{switch(t.type){case"address-label-event":this.HandleAddressLabelEvent(t.text);break;case"stop-editing":this.editing_state=Nt.NotEditing;break;case"start-editing":this.editing_state=Nt.FormulaBar,this.editing_cell=Object.assign({},this.primary_selection.target);break;case"discard":if(this.editing_state=Nt.NotEditing,this.editing_annotation)return this.ClearAdditionalSelections(),this.ClearSelection(this.active_selection),this.editing_annotation.node&&this.editing_annotation.node.focus(),this.editing_annotation=void 0,this.UpdateFormulaBarFormula(),void this.DelayedRender();this.container&&this.Focus(),this.ClearAdditionalSelections(),this.ClearSelection(this.active_selection),this.UpdateFormulaBarFormula(),this.DelayedRender();break;case"commit":if(this.active_sheet.id!==this.editing_cell.sheet_id&&this.editing_cell.sheet_id&&this.ActivateSheetID(this.editing_cell.sheet_id),this.editing_state=Nt.NotEditing,this.editing_annotation){const e=this.editing_annotation;return this.ClearAdditionalSelections(),this.ClearSelection(this.active_selection),e.formula=t.value?this.FixFormula(t.value):"",e.node&&e.node.focus(),this.grid_events.Publish({type:"annotation",event:"update",annotation:e}),this.editing_annotation=void 0,void this.DelayedRender()}this.container&&this.Focus(),this.SetInferredType(this.primary_selection,t.value,t.array),this.ClearAdditionalSelections(),this.ClearSelection(this.active_selection),this.options.repaint_on_cell_change&&this.DelayedRender(!1,this.primary_selection.area),t.event&&this.OverlayKeyDown(t.event);break;case"update":t.dependencies&&this.HighlightDependencies(t.dependencies)}}))}InitOverlayEditor(t){this.container&&(this.overlay_editor=new At(this.container,this.theme,this.model,t),this.overlay_editor.UpdateTheme(this.layout.scale),this.overlay_editor.autocomplete_matcher=this.autocomplete_matcher,this.overlay_editor.Subscribe((t=>{switch(t.type){case"stop-editing":this.editing_state=Nt.NotEditing;break;case"start-editing":this.editing_state=Nt.CellEditor,this.editing_cell=Object.assign({},this.primary_selection.target);break;case"update":t.dependencies&&this.HighlightDependencies(t.dependencies);break;case"end-selection":this.ClearSelection(this.active_selection),this.DelayedRender()}})))}DelayedRender(t=!1,e,s=!1){!this.tile_update_pending&&e?this.layout.DirtyArea(e):!this.tile_update_pending&&t&&this.layout.DirtyAll(),this.render_token||(this.render_token=1,F().then((()=>{this.render_token=0,this.Repaint(t,s)})))}Repaint(t=!1,e=!1,s=!1){if(this.headless)return;if(this.tile_update_pending&&(this.tile_update_pending=!1,this.layout.UpdateTiles(),this.render_tiles=this.layout.VisibleTiles(),this.layout.UpdateAnnotation(this.active_sheet.annotations)),this.layout_token=0,this.tile_renderer.OverflowDirty(e),t)for(const t of this.layout.grid_tiles)for(const e of t)e.dirty=!0;const i=this.render_tiles.start,r=this.render_tiles.end,o=[];for(let t=i.row;t<=r.row;t++)o.push(t);const a=[];for(let t=i.column;t<=r.column;t++)a.push(t);i.row>0&&this.active_sheet.freeze.rows&&o.push(0),i.column>0&&this.active_sheet.freeze.columns&&a.push(0);for(const e of a)for(const s of o){const i=this.layout.grid_tiles[e][s];(t||i.dirty||i.needs_full_repaint)&&(this.tile_renderer.Render(i),i.dirty=i.needs_full_repaint=!1)}this.tile_renderer.RenderHeaders(this.render_tiles,s),this.tile_renderer.RenderCorner(),this.RenderSelections()}MouseMove_RowHeader(t){const e=this.layout.CoordinateToRowHeader(t.offsetY),s=this.layout.OffsetCellAddressToRectangle({row:e.row,column:0});!this.hover_data.address||-1===this.hover_data.address.row&&-1===this.hover_data.address.column||this.HoverCell({row:-1,column:-1});let i=-1;t.offsetY-s.top<=this.RESIZE_PIXEL_BUFFER&&e.row>0?i=e.row-1:s.bottom-t.offsetY<=this.RESIZE_PIXEL_BUFFER&&(i=e.row),i>=0?this.layout.ResizeCursor("row"):this.cell_resize.row&&(this.cell_resize.row=-1,this.layout.ResizeCursor()),this.cell_resize.row=i}MouseMove_ColumnHeader(t){const e=this.layout.CoordinateToColumnHeader(t.offsetX),s=this.layout.OffsetCellAddressToRectangle({row:0,column:e.column});!this.hover_data.address||-1===this.hover_data.address.row&&-1===this.hover_data.address.column||this.HoverCell({row:-1,column:-1});let i=-1;t.offsetX-s.left<=this.RESIZE_PIXEL_BUFFER&&e.column>0?i=e.column-1:s.right-t.offsetX<=this.RESIZE_PIXEL_BUFFER&&(i=e.column),i>=0?this.layout.ResizeCursor("column"):this.cell_resize.column&&(this.cell_resize.column=-1,this.layout.ResizeCursor()),this.cell_resize.column=i}MouseDown_RowHeader(t){t.stopPropagation(),t.preventDefault();let e=this.layout.CoordinateToRowHeader(t.offsetY);const s=this.layout.row_header_cover.getBoundingClientRect(),i=(s.left,s.top);if(this.cell_resize.row>=0){const e=this.cell_resize.row,r=i+t.offsetY;if(this.layout.HideDropdownCaret(),this.IsDoubleClick({row:e,column:-1})){let t=[e];if(!this.primary_selection.empty&&this.primary_selection.area.rows>1&&this.primary_selection.area.start.column===1/0&&this.primary_selection.area.ContainsRow(e)){const e=this.active_sheet.RealArea(this.primary_selection.area);t=[];for(let s=e.start.row;s<=e.end.row;s++)t.push(s)}return void this.ExecCommand({key:zt.ResizeRows,row:t})}const o=this.layout.RowHeight(e);let a=o;const n=this.layout.OffsetCellAddressToRectangle({row:e,column:0}),l=i+n.bottom;this.layout.ShowTooltip({left:!0,text:`${a}px`,x:Math.round(s.right+10),y:l});const h=[],c=[];for(const t of this.active_sheet.annotations){const e=n.bottom-1;if(!t.scaled_rect||t.scaled_rect.bottom<e)continue;const s=[...this.layout.GetFrozenAnnotations(t)];t.node&&s.push(t.node),e<=t.scaled_rect.top&&t.move_with_cells?h.push({annotation:t,y:t.scaled_rect.top,nodes:s}):e>t.scaled_rect.top&&t.resize_with_cells&&c.push({annotation:t,height:t.scaled_rect.height,nodes:s})}ht(this.layout.mask,"row-resize",(t=>{const s=Math.max(-o,Math.round(t.offsetY-r));if(s+o!==a){a=s+o,this.layout.SetRowHeight(e,a),this.layout.UpdateTooltip({text:`${a}px`,y:l+s});for(const{annotation:t,y:e}of h)t.scaled_rect&&(t.scaled_rect.top=e+s);for(const{annotation:t,height:e}of c)t.scaled_rect&&(t.scaled_rect.height=e+s);requestAnimationFrame((()=>{for(const{annotation:t,nodes:e}of c)if(t.scaled_rect)for(const s of e)t.scaled_rect.ApplyStyle(s);for(const{annotation:t,nodes:e}of h)if(t.scaled_rect)for(const s of e)t.scaled_rect.ApplyStyle(s);this.layout.UpdateTileHeights(!0,e),this.Repaint(!1,!0),this.layout.UpdateAnnotation(this.active_sheet.annotations)}))}}),(()=>{this.layout.HideTooltip(),requestAnimationFrame((()=>{let t=[e];if(!this.primary_selection.empty&&this.primary_selection.area.rows>1&&this.primary_selection.area.start.column===1/0&&this.primary_selection.area.ContainsRow(e)){const e=this.active_sheet.RealArea(this.primary_selection.area);t=[];for(let s=e.start.row;s<=e.end.row;s++)t.push(s)}this.ExecCommand({key:zt.ResizeRows,row:t,height:a});for(const{annotation:t}of h)t.scaled_rect&&(t.layout=this.layout.RectToAnnotationLayout(t.scaled_rect));for(const{annotation:t}of c)t.scaled_rect&&(t.layout=this.layout.RectToAnnotationLayout(t.scaled_rect)),t.resize_callback&&t.resize_callback.call(void 0)}))}))}else{const s=this.SelectingArgument()?this.active_selection:this.primary_selection;if(this.SelectingArgument()||this.Focus(),t.shiftKey&&!s.empty){const t=s.target;this.Select(s,new r(s.target,e,!0),void 0,!0),e=t}else this.Select(s,new r(e),{column:0,row:e.row});this.RenderSelections(),ht(this.layout.mask,[],(t=>{const o=this.layout.CoordinateToRowHeader(t.offsetY-i),a=new r(o,e,!0);!s.empty&&a.Equals(s.area)||(this.Select(s,a,void 0,!0),this.RenderSelections())}),(()=>{}))}}MouseDown_ColumnHeader(t){t.stopPropagation(),t.preventDefault();let e=this.layout.CoordinateToColumnHeader(t.offsetX);const s=this.layout.column_header_cover.getBoundingClientRect(),i=s.left;if(s.top,this.cell_resize.column>=0){const e=this.cell_resize.column,r=i+t.offsetX;if(this.layout.HideDropdownCaret(),this.IsDoubleClick({row:-1,column:e})){let t=[e];if(!this.primary_selection.empty&&this.primary_selection.area.columns>1&&this.primary_selection.area.start.row===1/0&&this.primary_selection.area.ContainsColumn(e)){const e=this.active_sheet.RealArea(this.primary_selection.area);t=[];for(let s=e.start.column;s<=e.end.column;s++)t.push(s)}return void this.ExecCommand({key:zt.ResizeColumns,column:t})}const o=this.layout.ColumnWidth(e);let a=o;const n=this.layout.OffsetCellAddressToRectangle({row:0,column:e}),l=i+n.right;this.layout.ShowTooltip({up:!0,text:`${a}px`,x:l,y:Math.round(s.bottom+10)});const h=[],c=[];for(const t of this.active_sheet.annotations){const e=n.right-1;if(!t.scaled_rect||t.scaled_rect.right<e)continue;const s=[...this.layout.GetFrozenAnnotations(t)];t.node&&s.push(t.node),e<=t.scaled_rect.left&&t.move_with_cells?h.push({annotation:t,x:t.scaled_rect.left,nodes:s}):e>t.scaled_rect.left&&t.resize_with_cells&&c.push({annotation:t,width:t.scaled_rect.width,nodes:s})}ht(this.layout.mask,"column-resize",(t=>{const s=Math.max(-o,Math.round(t.offsetX-r));if(s+o!==a){a=s+o,this.layout.UpdateTooltip({text:`${a}px`,x:l+s}),this.layout.SetColumnWidth(e,a);for(const{annotation:t,x:e}of h)t.scaled_rect&&(t.scaled_rect.left=e+s);for(const{annotation:t,width:e}of c)t.scaled_rect&&(t.scaled_rect.width=e+s);requestAnimationFrame((()=>{for(const{annotation:t,nodes:e}of c)if(t.scaled_rect)for(const s of e)t.scaled_rect.ApplyStyle(s);for(const{annotation:t,nodes:e}of h)if(t.scaled_rect)for(const s of e)t.scaled_rect.ApplyStyle(s);this.layout.UpdateTileWidths(!0,e),this.Repaint(!1,!0)}))}}),(()=>{this.layout.HideTooltip(),requestAnimationFrame((()=>{const t=[e];if(!this.primary_selection.empty&&this.primary_selection.area.columns>1&&this.primary_selection.area.start.row===1/0&&this.primary_selection.area.ContainsColumn(e)){const e=this.active_sheet.RealArea(this.primary_selection.area);for(let s=e.start.column;s<=e.end.column;s++)t.push(s)}this.ExecCommand({key:zt.ResizeColumns,column:t,width:a});for(const{annotation:t}of h)t.scaled_rect&&(t.layout=this.layout.RectToAnnotationLayout(t.scaled_rect));for(const{annotation:t}of c)t.scaled_rect&&(t.layout=this.layout.RectToAnnotationLayout(t.scaled_rect)),t.resize_callback&&t.resize_callback.call(void 0)}))}))}else{const s=this.SelectingArgument()?this.active_selection:this.primary_selection;if(this.SelectingArgument()||this.Focus(),t.shiftKey&&!s.empty){const t=s.target;this.Select(s,new r(s.target,e,!0),void 0,!0),e=t}else this.Select(s,new r(e),{row:0,column:e.column});this.RenderSelections(),ht(this.layout.mask,[],(t=>{const o=this.layout.CoordinateToColumnHeader(t.offsetX-i),a=new r(o,e,!0);!s.empty&&a.Equals(s.area)||(this.Select(s,a,void 0,!0),this.RenderSelections())}))}}HoverCell(t,e){let s=this.active_sheet.cells.GetCell(t,!1);if(null==s?void 0:s.merge_area){const e=s.merge_area;t=e.start,s=this.active_sheet.cells.GetCell(t,!1),t={row:e.start.row,column:e.end.column}}(null==s?void 0:s.note)?(this.layout.ShowNote(s.note,t,e),this.hover_data.note=!0):this.hover_data.note&&(this.layout.HideNote(),this.hover_data.note=!1),(null==s?void 0:s.hyperlink)?(this.layout.ShowTitle("Link: "+s.hyperlink,t,e),this.hover_data.link=!0,this.hover_data.cell=s):this.hover_data.link&&(this.layout.HideTitle(),this.hover_data.cell=void 0),this.hover_data.address=Object.assign({},t)}HideHoverInfo(){this.layout.HideTitle(),this.layout.HideTooltip(),this.hover_data.note=this.hover_data.link=!1,this.hover_data.cell=void 0,this.hover_data.pointer&&this.layout.grid_cover.classList.remove("link-pointer"),this.hover_data.pointer=!1}MouseMove_Grid(t){var e;t.stopPropagation(),t.preventDefault(),(this.cell_resize.row>=0||this.cell_resize.column>=0)&&this.layout.ResizeCursor();const s={x:t.offsetX,y:t.offsetY};let i;if((null===(e=this.overlay_editor)||void 0===e?void 0:e.editing)||(i=this.layout.PointToAddress_Grid(s),this.hover_data.address&&this.hover_data.address.row===i.row&&this.hover_data.address.column===i.column||this.HoverCell(i,t)),this.hover_data.link&&i&&(this.hover_data.point=s,this.hover_data.handler||(this.hover_data.handler=requestAnimationFrame((()=>{const t=this.hover_data.address&&this.hover_data.point&&this.hover_data.cell&&this.PointInTextPart(this.hover_data.address,this.hover_data.point,this.hover_data.cell);t!==!!this.hover_data.pointer&&(this.hover_data.pointer=t,t?this.layout.grid_cover.classList.add("link-pointer"):this.layout.grid_cover.classList.remove("link-pointer")),this.hover_data.handler=void 0})))),this.primary_selection.empty||!this.selection_renderer.nub_rectangle)return void(this.nub_select_flag&&(this.layout.grid_cover.classList.remove("nub-select"),this.nub_select_flag=!1));const r=this.selection_renderer.nub_rectangle.Contains(t.offsetX,t.offsetY);r!==this.nub_select_flag&&(r?this.layout.grid_cover.classList.add("nub-select"):this.layout.grid_cover.classList.remove("nub-select"),this.nub_select_flag=r)}ClearDoubleClick(){this.double_click_data.address=void 0}IsDoubleClick(t,e=300){if(this.double_click_data.address&&this.double_click_data.address.row===t.row&&this.double_click_data.address.column===t.column)return clearTimeout(this.double_click_data.timeout),this.double_click_data.address=void 0,this.double_click_data.timeout=void 0,!0;this.double_click_data.timeout&&clearTimeout(this.double_click_data.timeout),this.double_click_data.address=Object.assign({},t),this.double_click_data.timeout=window.setTimeout((()=>{this.double_click_data.address=void 0,this.double_click_data.timeout=void 0}),e)}PointInTextPart(t,e,s){var i,r;let o=this.layout.CellAddressToRectangle(t);s.merge_area&&(o=o.Combine(this.layout.CellAddressToRectangle(s.merge_area.end)));const a=e.x-o.left,n=e.y-o.top,l=(null===(r=null===(i=s.renderer_data)||void 0===i?void 0:i.text_data)||void 0===r?void 0:r.strings)||[];for(const t of l)if("number"==typeof t.left&&"number"==typeof t.top&&"number"==typeof t.width&&"number"==typeof t.height&&a>=t.left&&n>=t.top&&a<=t.left+t.width&&n<=t.top+t.height)return!0;return!1}MouseDown_Grid(t){var e,s,i,o,a;t.stopPropagation(),t.preventDefault();const n=this.SelectingArgument();!n&&this.additional_selections.length&&this.ClearAdditionalSelections(),n&&(null===(e=this.formula_bar)||void 0===e?void 0:e.selecting)||this.Focus(),(null===(s=this.overlay_editor)||void 0===s?void 0:s.editing)&&!(null===(i=this.overlay_editor)||void 0===i?void 0:i.selecting)&&this.DismissEditor();const l={x:t.offsetX,y:t.offsetY};let h=this.layout.PointToAddress_Grid(l);const c=n?this.active_selection:this.primary_selection;if(!n&&this.IsDoubleClick(h))return bt.is_mobile&&(null===(a=null===(o=this.overlay_editor)||void 0===o?void 0:o.edit_node)||void 0===a||a.focus()),void this.OverlayEditCell({target:h,area:new r(h)},!1);let d=this.layout.grid_cover.getBoundingClientRect();const u={x:d.left,y:d.top},m=[];let f;if(t.shiftKey&&!c.empty){const t=c.target;this.Select(c,new r(h,c.target,!0),void 0,!0),h=t}else if(this.nub_select_flag)h=c.area.TopLeft(),m.push("nub-select"),f=this.active_sheet.RealArea(c.area);else{let t=h,e=this.active_sheet.CellData(t);if(e.merge_area&&(t=e.merge_area.start,e=this.active_sheet.CellData(e.merge_area.start)),e.hyperlink&&this.PointInTextPart(t,l,e)){const t=e.hyperlink;return F().then((()=>{this.grid_events.Publish({type:"cell-event",data:{type:"hyperlink",data:t}})})),void this.ClearDoubleClick()}if(e.click_function){let s=this.layout.CellAddressToRectangle(t);e.merge_area&&(s=s.Combine(this.layout.CellAddressToRectangle(e.merge_area.end)));const i=e.click_function.call(this,{cell:e,x:l.x-s.left,y:l.y-s.top,width:s.width,height:s.height});if(i.value&&this.ExecCommand({key:zt.SetRange,value:i.value,area:t}),i.block_selection)return this.ClearDoubleClick(),void(this.primary_selection.empty||this.primary_selection.target.row!==t.row||this.primary_selection.target.column!==t.column||this.UpdateFormulaBarFormula())}this.Select(c,new r(h),h)}this.RenderSelections(),n&&this.UpdateSelectedArgument(c);const p=this.layout.CellAddressToRectangle({row:0,column:0}).Combine(this.layout.CellAddressToRectangle({row:this.active_sheet.rows-1,column:this.active_sheet.columns-1})).Expand(-1,-1);ht(this.layout.mask,m,(t=>{const e={x:t.offsetX-u.x,y:t.offsetY-u.y},s=p.Clamp(e.x,e.y),i=this.layout.PointToAddress_Grid(s,!0),o=this.layout.scroll_reference_node;let a=!1;this.container&&this.options.scrollbars&&(e.x<o.scrollLeft?(o.scrollLeft-=25,a=!0):e.x>o.scrollLeft+this.container.clientWidth&&(o.scrollLeft+=25,a=!0),e.y<o.scrollTop?(o.scrollTop-=25,a=!0):e.y>o.scrollTop+this.container.clientHeight&&(o.scrollTop+=25,a=!0),a&&(d=this.layout.grid_cover.getBoundingClientRect(),u.x=d.left+document.body.scrollLeft,u.y=d.top+document.body.scrollTop));let l=new r(i,h,!0);if(f&&(l=f.Clone(),l.ConsumeAddress(i),l.rows!==f.rows&&l.columns!==f.columns)){const t={rows:i.row>f.end.row?i.row-f.end.row:f.start.row-i.row,columns:i.column>f.end.column?i.column-f.end.column:f.start.column-i.column};l=t.rows>=t.columns?new r({row:l.start.row,column:f.start.column},{row:l.end.row,column:f.end.column}):new r({row:f.start.row,column:l.start.column},{row:f.end.row,column:l.end.column})}!c.empty&&l.Equals(c.area)||(this.Select(c,l,void 0,!0),this.RenderSelections(),n?this.UpdateSelectedArgument(c):c.empty||c.area.entire_sheet||(c.area.entire_column?this.UpdateAddressLabel(void 0,c.area.columns+"C"):c.area.entire_row?this.UpdateAddressLabel(void 0,c.area.rows+"R"):c.area.count>1?this.UpdateAddressLabel(void 0,c.area.rows+"R x "+c.area.columns+"C"):this.UpdateAddressLabel(c)))}),(()=>{var t;this.UpdateAddressLabel(),n?(null===(t=this.overlay_editor)||void 0===t?void 0:t.editing)||this.select_argument||this.formula_bar&&this.formula_bar.FocusEditor():f&&this.RecycleNubArea(c.area,f)}))}Transpose(t){const e=[],s=t.length,i=t[0].length;for(let r=0;r<i;r++){e[r]=[];for(let i=0;i<s;i++)e[r][i]=t[i][r]}return e}RecycleNubArea(t,e){var s;if(t.Equals(e))return;let i=[];for(let t=0;t<e.rows;t++){i[t]=[];for(let s=0;s<e.columns;s++){const r={row:e.start.row+t,column:e.start.column+s};i[t][s]=this.active_sheet.CellData(r)}}if(i[0][0].area&&i[0][0].area.Equals(e))return void this.ExecCommand({key:zt.SetRange,value:i[0][0].value,array:!0,area:t});const r=[];let o=[],a=e.columns,n=t.rows,l=!1,h=!1;t.columns===e.columns?l=t.start.row<e.start.row:(a=e.rows,n=t.columns,l=t.start.column<e.start.column,i=this.Transpose(i),h=!0);for(let t=0;t<n;t++)r[t]=[],o[t]=[];for(let t=0;t<a;t++){let e=0;if(i.length>1){e=1;const s=[],r=[];for(let e=0;e<i.length;e++){const o=i[e][t];o.ValueIsNumber()&&(r.push(e),s.push(o.value))}if(s.length>1){const t=s.slice(1).map(((t,e)=>t-s[e]));t.every((e=>e===t[0]))&&(e=t[0])}s.length&&(e+=s[s.length-1]-s[0])}for(let a=0;a<i.length;a++){let h;const c=i[a][t];if(c.ValueIsFormula()){const t=this.parser.Parse(c.value);t.expression&&(null===(s=t.full_reference_list)||void 0===s?void 0:s.length)&&(h=t.expression)}let d=0,u=a,m=i.length,f=0,p=e;l&&(u=n-i.length+a,m=-i.length,p=-e);for(let e=u;e>=0&&e<n;e+=m,d+=m,f+=p){if(h)r[e][t]="="+this.parser.Render(h,{rows:d,columns:0});else{const s=i[a][t];s.ValueIsNumber()?r[e][t]=s.value+f:r[e][t]=s.value}o[e][t]=i[a][t].style||{}}}}const c=[{key:zt.SetRange,value:h?this.Transpose(r):r,array:!1,area:t}];h&&(o=this.Transpose(o));for(let e=0;e<o.length;e++)for(let s=0;s<o[e].length;s++)c.push({key:zt.UpdateStyle,area:{row:e+t.start.row,column:s+t.start.column},style:o[e][s],delta:!1});this.ExecCommand(c)}UpdateSelectedArgument(t){var e;const s=this.active_sheet.CellData(t.area.start),i=new r(s.merge_area?s.merge_area.start:t.target);let o=this.model.named_ranges.MatchSelection(t.area,i);if(!o&&(o=t.area.spreadsheet_label,s.merge_area&&s.merge_area.Equals(t.area)&&(o=r.CellAddressToLabel(s.merge_area.start)),this.active_sheet.id!==this.editing_cell.sheet_id)){const t=this.active_sheet.name;o=R.test(t)?`'${t}'!${o}`:`${t}!${o}`}(null===(e=this.overlay_editor)||void 0===e?void 0:e.editing)&&this.overlay_editor.selecting?this.overlay_editor.InsertReference(o,0):this.formula_bar&&this.formula_bar.selecting?this.formula_bar.InsertReference(o,0):this.select_argument&&this.grid_events.Publish({type:"alternate-selection",selection:this.active_selection})}SelectingArgument(){var t,e;return(null===(t=this.overlay_editor)||void 0===t?void 0:t.editing)&&(null===(e=this.overlay_editor)||void 0===e?void 0:e.selecting)||this.formula_bar&&this.formula_bar.selecting||this.select_argument}OverlayKeyDown(t){var e,s,i;let r=!1;if(this.overlay_editor&&this.overlay_editor.editing)switch(r=!0,this.overlay_editor.HandleKeyDown(t)){case xt.handled:return;case xt.discard:return this.editing_state=Nt.NotEditing,this.DismissEditor(),void this.DelayedRender();case xt.commit:if(this.active_sheet.id!==this.editing_cell.sheet_id&&this.editing_cell.sheet_id&&this.ActivateSheetID(this.editing_cell.sheet_id),this.editing_state=Nt.NotEditing,null===(e=this.overlay_editor)||void 0===e?void 0:e.selection){const e=(null===(s=this.overlay_editor)||void 0===s?void 0:s.edit_node.textContent)||void 0,i="Enter"===t.key&&t.ctrlKey&&t.shiftKey;this.SetInferredType(this.overlay_editor.selection,e,i)}this.DismissEditor(),this.options.repaint_on_cell_change&&this.DelayedRender(!1,(null===(i=this.overlay_editor)||void 0===i?void 0:i.selection.area)||void 0)}const o=this.SelectingArgument();if(this.formula_bar&&this.formula_bar.focused&&!o)return;if(this.selected_annotation&&!o)return;const a=o?this.active_selection:this.primary_selection,n={rows:0,columns:0};let l=!1,h=!1;if(t.ctrlKey||bt.is_mac&&t.metaKey){switch(t.key){case"ArrowDown":case"Down":n.rows++;break;case"ArrowUp":case"Up":n.rows--;break;case"ArrowLeft":case"Left":n.columns--;break;case"ArrowRight":case"Right":n.columns++;break;case"Delete":case"Del":t.stopPropagation(),t.preventDefault();for(let t=0;t<this.model.sheets.length;t++)if(this.model.sheets[t]===this.active_sheet){this.DeleteSheet(t);break}return;case"/":t.stopPropagation(),t.preventDefault(),this.SelectArray();break;default:if(t.shiftKey)return}if(n.columns||n.rows){if(t.stopPropagation(),t.preventDefault(),a.empty||!n.columns&&!n.rows)return;if(this.BlockSelection(a,!!t.shiftKey,n.columns,n.rows))return}else{const e={},s=this.primary_selection.empty?{}:this.active_sheet.CellData(this.primary_selection.target).style||{};switch(t.key.toLowerCase()){case"b":e.font_bold=!s.font_bold;break;case"i":e.font_italic=!s.font_italic;break;case"u":e.font_underline=!s.font_underline;break;case"a":this.SelectAll();break;case"0":if(!t.altKey)return;this.ClearSelection(this.primary_selection),this.RenderSelections();break;default:return void t.key}Object.keys(e).length&&this.ApplyStyle(void 0,e)}}else switch(t.key){case"Tab":t.shiftKey?n.columns--:n.columns++,l=!0;break;case"Enter":t.shiftKey?n.rows--:n.rows++,l=!0;break;case"ArrowDown":case"Down":n.rows++,h=t.shiftKey;break;case"ArrowUp":case"Up":n.rows--,h=t.shiftKey;break;case"ArrowLeft":case"Left":n.columns--,h=t.shiftKey;break;case"ArrowRight":case"Right":n.columns++,h=t.shiftKey;break;case"Delete":case"Del":a.empty||this.DeleteSelection(a);break;case"PageUp":case"PageDown":if(t.shiftKey){this.NextSheet("PageUp"===t.key?-1:1);break}return;case"Control":case"Shift":case"Alt":return;default:return void(a.empty||this.OverlayEditCell(a,!0,t))}t.stopPropagation(),t.preventDefault(),(n.rows||n.columns)&&this.AdvanceSelection(n,a,l,h,!r)}SelectArray(){if(this.primary_selection.empty)return;const t=this.active_sheet.CellData(this.primary_selection.target);t&&t.area&&(this.Select(this.primary_selection,t.area,t.area.start),this.RenderSelections())}RenderSelections(t=!0){const e=!this.editing_state||this.editing_cell.sheet_id===this.active_sheet.id;this.selection_renderer.RenderSelections(e,t)}BlockSelection(t,e,s,i,a=!0){if(t.empty)return!1;const n=Object.assign({},t.target);i>0?n.row=Math.max(n.row,t.area.end.row):i<0&&(n.row=Math.min(n.row,t.area.start.row)),s>0?n.column=Math.max(n.column,t.area.end.column):s<0&&(n.column=Math.min(n.column,t.area.start.column));const l=this.active_sheet.cells;let h=l.GetCell(t.target,!1);if(!h||h.type===o.undefined&&!h.area)return!1;let c=Object.assign({},n);for(;;){const e={row:c.row+i,column:c.column+s};if(e.column<0||e.row<0||e.column>=this.active_sheet.columns||e.row>=this.active_sheet.rows)break;let r=!1;if(i)for(let s=t.area.start.column;!r&&s<=t.area.end.column;s++)h=l.GetCell({row:e.row,column:s},!1),r=r||!!h&&(h.type!==o.undefined||!!h.area),!r&&h&&h.merge_area&&(h=l.GetCell(h.merge_area.start,!1),r=r||!!h&&(h.type!==o.undefined||!!h.area));else for(let s=t.area.start.row;!r&&s<=t.area.end.row;s++)h=l.GetCell({row:s,column:e.column},!1),r=r||!!h&&(h.type!==o.undefined||!!h.area),!r&&h&&h.merge_area&&(h=l.GetCell(h.merge_area.start,!1),r=r||!!h&&(h.type!==o.undefined||!!h.area));if(!r)break;c=e}if(e){i?(n.row=t.target.row,n.column=t.area.start.column,c.column=t.area.end.column):(n.column=t.target.column,n.row=t.area.start.row,c.row=t.area.end.row);const e=new r(n,c,!0);this.Select(t,e,t.target,!0)}else this.Select(t,new r(c));return this.ScrollIntoView(c),this.SelectingArgument()&&this.UpdateSelectedArgument(t),a&&this.DelayedRender(),!0}DeleteSelection(t){if(t.empty)return;const e=this.active_sheet.RealArea(t.area);this.ExecCommand({key:zt.Clear,area:e})}Error(t){console.info("Error",t),this.grid_events.Publish({type:"error",message:t})}SetInferredType(t,e,s=!1,i=!0){var r;let a=t.target||t.area.start;const l=this.active_sheet.CellData(a);if(l.area){if(!s&&l.area.count>1||!t.area||!t.area.Equals(l.area))return void this.Error("You can't change part of an array.")}else if(s){let e=!1;if(this.active_sheet.cells.Apply(t.area,(t=>{t.area&&(e=!0)}),!1),e)return void this.Error("You can't change part of an array.")}if(l.validation){let t;if(l.validation.type===n.List?t=l.validation.list:l.validation.type===n.Range&&(t=this.GetValidationRange(l.validation.area)),t&&t.length){let s=!1;if(e){const i=e.toUpperCase();for(const r of t)if(r&&r.toString().toUpperCase()===i){e=r.toString(),s=!0;break}}if(!s)return void this.Error("Invalid value (data validation).")}}l.merge_area&&(a=l.merge_area.start);const h="string"==typeof e&&"="===e.trim()[0],c=[];if(h&&(e=this.FixFormula(e||""),!this.active_sheet.HasCellStyle(a))){const i=this.parser.Parse(e);if(i){if("call"===(null===(r=i.expression)||void 0===r?void 0:r.type)&&(!l.style||!l.style.number_format||Q.Equals(l.style.number_format,"General"))){let e;switch(i.expression.name.toLowerCase()){case"today":e="Short Date";break;case"now":e="Timestamp"}e&&c.push({key:zt.UpdateStyle,area:s?t.area:a,style:{number_format:e},delta:!0})}if(i.dependencies){const e=i.dependencies;for(const i of Object.keys(e.addresses)){const r=e.addresses[i];if(this.active_sheet.HasCellStyle(Object.assign({},r))){const e=this.active_sheet.CellData(Object.assign({},r));if(e.style&&e.style.number_format){const i={number_format:e.style.number_format};c.push({key:zt.UpdateStyle,area:s?t.area:a,style:i,delta:!0})}break}}}}}const d=st.TryParse(e);if(!h&&d.type===o.number){let e="";const i=d.hints||tt.None;l.style&&l.style.number_format&&!Q.Equals(l.style.number_format,"General")||(i&tt.Date?e="Short Date":i&tt.Exponential?e="Exponential":i&tt.Percent?e="Percent":i&tt.Currency?e="Currency":(i&tt.Grouping||i&tt.Parens)&&(e="Accounting")),e&&c.push({key:zt.UpdateStyle,area:s?t.area:a,style:{number_format:e},delta:!0})}if(c.push({key:zt.SetRange,area:s?t.area:a,array:s,value:h?e:d.value}),!i)return c;this.ExecCommand(c)}FixFormula(t){if("="!==t.trim()[0])return t;let e=!1,s=!1,i=0,r=!1;const o=(t=t.replace(/^\s+/,"")).length;for(let a=0;a<o;a++){const o=t[a];if(!r)switch(o){case'"':e?'"'===t[a+1]?a++:e=!1:s||(e=!0);break;case"'":s?s=!1:e||(s=!0);break;case"\\":r=!0;break;case"(":e||s||i++;break;case")":e||s||i--}}for(e?t+='"':s&&(t+="'");i>0;)t+=")",i--;return this.NormalizeFormula(t)}NormalizeFormula(t){const e=this.parser.Parse(t);return e&&e.expression&&(this.parser.Walk(e.expression,(t=>{switch(t.type){case"call":t.name=this.autocomplete_matcher.NormalizeIdentifier(t.name)||t.name;break;case"identifier":this.model.named_ranges.Get(t.name)&&(t.name=t.name.toUpperCase())}return!0})),t="="+this.parser.Render(e.expression,void 0,"")),t}DismissEditor(){var t,e;(null===(t=this.overlay_editor)||void 0===t?void 0:t.active_cell)&&(this.overlay_editor.active_cell.editing=!1,this.overlay_editor.active_cell.render_dirty=!0,this.DelayedRender(void 0,this.overlay_editor.selection.area)),this.editing_state=Nt.NotEditing,this.Focus(),null===(e=this.overlay_editor)||void 0===e||e.CloseEditor(),this.ClearAdditionalSelections(),this.ClearSelection(this.active_selection)}NormalizeCellValue(t){let e=t.value;if(t.ValueIsNumber()&&t.style&&t.style.number_format)if(Q.Get(t.style.number_format).date_format){const s=K(t.value),i=s.getUTCHours()||s.getUTCMinutes()||s.getUTCSeconds()?"Timestamp":"Short Date";e=Q.Get(i).Format(e)}else if(/(?:%|percent)/i.test(t.style.number_format)){let s=0;const i=t.value.toString().match(/\.(.*?)$/);i&&i[1]&&(s=Math.max(0,i[1].length-2)),e=(100*t.value).toFixed(s)+"%",","===g.decimal_separator&&(e=e.replace(/\./,","))}else e&&","===g.decimal_separator&&(e=t.value.toString().replace(/\./,","));else{if(t.ValueIsBoolean())return t.value.toString().toUpperCase();t.ValueIsNumber()&&e&&","===g.decimal_separator&&(e=t.value.toString().replace(/\./,","))}return e}IsNumeric(t){return t>=48&&t<=57||t===this.decimal_separator_code||45===t||43===t}OverlayEditCell(t,e=!0,s){var i,r;if(!this.options.in_cell_editor)return;let a,n=t.target||t.area.start,l=this.active_sheet.CellData(n);if(this.HideHoverInfo(),l.merge_area?(a=this.layout.OffsetCellAddressToRectangle(l.merge_area.start).Combine(this.layout.OffsetCellAddressToRectangle(l.merge_area.end)),n=l.merge_area.start,l=this.active_sheet.CellData(n)):a=this.layout.OffsetCellAddressToRectangle(n),null===(i=l.style)||void 0===i?void 0:i.locked)return void console.info("cell is locked for editing");a=a.Shift(this.layout.header_size.width,this.layout.header_size.height);let h=l.value;h=e?l.type!==o.number&&l.rendered_type!==o.number||!l.style||!l.style.number_format||!/(?:%|percent)/i.test(l.style.number_format)||s&&!this.IsNumeric(s.key.charCodeAt(0))?void 0:"%":this.NormalizeCellValue(l),null===(r=this.overlay_editor)||void 0===r||r.Edit(t,a.Expand(-1,-1),l,h,s),l.editing=!0,l.render_dirty=!0,this.DelayedRender(!1,t.area)}BoundAddressArea(t,e){t.column>e.end.column?(t.row=this.StepVisibleRows(t.row,1),t.row>e.end.row&&(t.row=e.start.row),t.column=e.start.column):t.column<e.start.column?(t.row=this.StepVisibleRows(t.row,-1),t.row<e.start.row&&(t.row=e.end.row),t.column=e.end.column):t.row>e.end.row?(t.column=this.StepVisibleColumns(t.column,1),t.column>e.end.column&&(t.column=e.start.column),t.row=e.start.row):t.row<e.start.row&&(t.column=this.StepVisibleColumns(t.column,-1),t.column<e.start.column&&(t.column=e.end.column),t.row=e.end.row)}StepVisibleRows(t,e){if(e>0)for(let s=0;s<e;s++)this.layout.RowHeight(++t)||s--;else if(e<0)for(let s=0;s>e;s--)--t>=0&&!this.layout.RowHeight(t)&&s++;return t}StepVisibleColumns(t,e){if(e>0)for(let s=0;s<e;s++)this.layout.ColumnWidth(++t)||s--;else if(e<0)for(let s=0;s>e;s--)--t>=0&&!this.layout.ColumnWidth(t)&&s++;return t}AdvanceSelection(t,e,s=!1,i=!1,o=!0){const a=this.SelectingArgument();let n=!1;if(e.empty)if(a){const s={row:Math.max(0,this.StepVisibleRows(this.primary_selection.target.row,t.rows)),column:Math.max(0,this.StepVisibleColumns(this.primary_selection.target.column,t.columns))};this.Select(e,new r(s))}else this.Select(e,new r({row:0,column:0}));else{const a=this.active_sheet.CellData(e.target);if(a.merge_area&&s&&(s=!a.merge_area.Equals(e.area)),s&&e.area.count>1){const s=this.RealArea(e.area),i=e.target;for(;;){i.row=this.StepVisibleRows(i.row,t.rows),i.column=this.StepVisibleColumns(i.column,t.columns),this.BoundAddressArea(i,s);const e=this.active_sheet.CellData(i);if(!e.merge_area||e.merge_area.start.row===i.row&&e.merge_area.start.column===i.column)break}this.Select(e,s,i)}else if(i&&e&&e.target){const s=e.area,i=e.target,a=s.start,l=s.end,h={row:1/0,column:1/0};if(t.columns&&(1===s.columns?t.columns>0?(l.column=this.StepVisibleColumns(l.column,1),h.column=l.column):(a.column=this.StepVisibleColumns(a.column,-1),h.column=a.column):s.end.column>i.column?(l.column=this.StepVisibleColumns(l.column,t.columns),h.column=l.column):s.start.column<i.column&&(a.column=this.StepVisibleColumns(a.column,t.columns),h.column=a.column),l.column=Math.max(0,l.column),a.column=Math.max(0,a.column)),t.rows&&(1===s.rows?t.rows>0?(l.row=this.StepVisibleRows(l.row,1),h.row=l.row):(a.row=this.StepVisibleRows(a.row,-1),h.row=a.row):s.end.row>i.row?(l.row=this.StepVisibleRows(l.row,t.rows),h.row=l.row):s.start.row<i.row&&(a.row=this.StepVisibleRows(a.row,t.rows),h.row=a.row),l.row=Math.max(0,l.row),a.row=Math.max(0,a.row)),this.options.expand){for(const t of[a,l,h])t.row!==1/0&&(t.row=Math.max(0,t.row)),t.column!==1/0&&(t.column=Math.max(0,t.column));if(l.row!==1/0&&l.row>=this.active_sheet.rows&&this.options.expand){let t=this.active_sheet.rows;for(;l.row>=t;)t+=8;this.active_sheet.cells.EnsureRow(t),n=!0}if(l.column!==1/0&&l.column>=this.active_sheet.columns&&this.options.expand){let t=this.active_sheet.columns;for(;l.column>=t;)t+=8;this.active_sheet.cells.EnsureColumn(t),n=!0}n&&(this.layout.UpdateTiles(),this.layout.UpdateContentsSize(),this.Repaint(!0,!0),o=!0),this.ScrollIntoView(h),this.Select(e,new r(a,l),void 0,!0)}else{for(const t of[a,l,h])t.row!==1/0&&(t.row=Math.max(0,Math.min(t.row,this.active_sheet.rows-1))),t.column!==1/0&&(t.column=Math.max(0,Math.min(t.column,this.active_sheet.columns-1)));this.ScrollIntoView(h),this.Select(e,new r(a,l),void 0,!0)}}else{const s=e.target;if(a.merge_area?(t.columns<0?s.column=this.StepVisibleColumns(a.merge_area.start.column,-1):t.columns>0&&(s.column=this.StepVisibleColumns(a.merge_area.end.column,1)),t.rows<0?s.row=this.StepVisibleRows(a.merge_area.start.row,-1):t.rows>0&&(s.row=this.StepVisibleRows(a.merge_area.end.row,1))):(s.row=this.StepVisibleRows(s.row,t.rows),s.column=this.StepVisibleColumns(s.column,t.columns)),s.row>=this.active_sheet.rows&&this.options.expand){let t=this.active_sheet.rows;for(;s.row>=t;)t+=8;this.active_sheet.cells.EnsureRow(t),n=!0}if(s.column>=this.active_sheet.columns&&this.options.expand){let t=this.active_sheet.columns;for(;s.column>=t;)t+=8;this.active_sheet.cells.EnsureColumn(t),n=!0}n&&(this.layout.UpdateTiles(),this.layout.UpdateContentsSize(),this.Repaint(!0,!0),o=!0),this.Select(e,new r({row:Math.min(Math.max(0,s.row),this.active_sheet.rows-1),column:Math.min(Math.max(0,s.column),this.active_sheet.columns-1)})),this.RenderSelections(),this.ScrollIntoView(e.target)}}this.SelectingArgument()&&this.UpdateSelectedArgument(e),o&&this.DelayedRender()}HighlightDependencies(t,e=!0){let s=0;t:for(let e of t)if((e.start.row===1/0||e.start.row<this.active_sheet.rows)&&(e.start.column===1/0||e.start.column<this.active_sheet.columns)){e=this.active_sheet.RealArea(e);const t=e.spreadsheet_label;if(this.additional_selections[s]&&this.additional_selections[s].area.spreadsheet_label===t)s++;else{for(let i=0;i<s;i++)if(this.additional_selections[i].area.spreadsheet_label===t&&this.additional_selections[i].area.start.sheet_id===e.start.sheet_id)continue t;this.additional_selections[s++]={target:e.start,area:e}}}this.additional_selections.splice(s),e&&this.RenderSelections(!1)}AddAdditionalSelection(t,e){const s=e.spreadsheet_label;return!this.additional_selections.some((t=>t.area.spreadsheet_label===s))&&(this.additional_selections.push({target:t,area:e}),!0)}ClearAdditionalSelections(){this.additional_selections.splice(0,this.additional_selections.length)}ClearSelection(t){this.Select(t)}HideGridSelection(){this.UpdateAddressLabel(void 0,"");const t=this.selected_annotation&&this.selected_annotation.formula?this.selected_annotation.formula:"";this.UpdateFormulaBarFormula(t),this.layout.ShowSelections(!1)}ShowGridSelection(){this.UpdateAddressLabel(),this.UpdateFormulaBarFormula(),this.layout.ShowSelections(!0)}Select(t,e,s,i=!1){if(t.empty||i&&(s=t.target),e){let i=this.active_sheet.RealArea(e);s||(s=i.start);let o=!0;for(;o;)o=!1,this.active_sheet.cells.Apply(i,(t=>{t.merge_area&&!i.ContainsArea(t.merge_area)&&(e.ConsumeArea(t.merge_area),i=this.active_sheet.RealArea(e),o=!0)}));t.area=new r(Object.assign(Object.assign({},e.start),{sheet_id:this.active_sheet.id}),e.end),s&&(t.target=Object.assign(Object.assign({},s),{sheet_id:this.active_sheet.id})),t.empty=!1}else t.empty=!0;t===this.primary_selection&&(bt.is_edge&&this.Focus(),this.grid_events.Publish({type:"selection",selection:this.primary_selection}),this.UpdateAddressLabel(),this.UpdateFormulaBarFormula())}SetValidationInternal(t){let e,s;if(t.target.sheet_id&&t.target.sheet_id!==this.model.active_sheet.id){for(const s of this.model.sheets)if(s.id===t.target.sheet_id){e=s;break}}else e=this.model.active_sheet;if(e&&(s=e.cells.GetCell(t.target,!0)),!s)throw new Error("invalid cell in set validation");t.range?s.validation={type:n.Range,area:t.range}:t.list?s.validation={type:n.List,list:JSON.parse(JSON.stringify(t.list))}:s.validation=void 0}GetValidationRange(t){let e,s;if(t.start.sheet_id&&t.start.sheet_id!==this.model.active_sheet.id){for(const s of this.model.sheets)if(s.id===t.start.sheet_id){e=s;break}}else e=this.model.active_sheet;if(e){s=[];for(let i=(t=e.RealArea(new r(t.start,t.end),!0)).start.row;i<=t.end.row;i++)for(let r=t.start.column;r<=t.end.column;r++){const t=e.CellData({row:i,column:r});t&&t.formatted&&("string"==typeof t.formatted?s.push(t.formatted):s.push(Y.FormatPartsAsText(t.formatted)))}}return s}UpdateFormulaBarFormula(t){var e,s;if(this.formula_bar)if(t)this.formula_bar.formula=t;else if(this.primary_selection.empty)this.formula_bar.formula="";else{let t=this.active_sheet.CellData(this.primary_selection.target);const i=t.merge_area||t.area;i&&(i.start.column===this.primary_selection.target.column&&i.start.row===this.primary_selection.target.row||(t=this.active_sheet.CellData(i.start))),this.formula_bar.editable=!(null===(e=t.style)||void 0===e?void 0:e.locked);const o=this.NormalizeCellValue(t);if(t.validation&&!(null===(s=t.style)||void 0===s?void 0:s.locked)){let e;t.validation.type===n.List?e=t.validation.list:t.validation.type===n.Range&&(e=this.GetValidationRange(t.validation.area)),e&&e.length&&this.layout.ShowDropdownCaret(t.merge_area||new r(this.primary_selection.target),e,t.value)}else this.layout.HideDropdownCaret();t.area?this.formula_bar.formula="{"+(o||"")+"}":this.formula_bar.formula=void 0!==o?o.toString():""}}UpdateAddressLabel(t=this.primary_selection,e){if(this.formula_bar)if(void 0!==e)this.formula_bar.label=e;else if(t.empty)this.formula_bar.label="";else{const e=this.active_sheet.CellData(this.primary_selection.target),s=new r(e.merge_area?e.merge_area.start:t.target);this.formula_bar.label=this.model.named_ranges.MatchSelection(t.area,s)||r.CellAddressToLabel(s.start)}}OnDropdownSelect(t){if(void 0!==t){const e=st.TryParse(t.toString());e.type===o.number&&(t=e.value)}const e=this.active_sheet.CellData(this.primary_selection.target),s=e.merge_area?e.merge_area.start:this.primary_selection.target;this.ExecCommand({key:zt.SetRange,area:s,value:t}),this.UpdateFormulaBarFormula()}OnScroll(){const t=this.layout.VisibleTiles();t.Equals(this.render_tiles)||(this.render_tiles=t,this.layout_token||(this.layout_token=requestAnimationFrame((()=>this.Repaint()))))}AttachListeners(){var t;if(!this.container)throw new Error("invalid container");this.container.addEventListener("copy",this.HandleCopy.bind(this)),this.container.addEventListener("cut",this.HandleCut.bind(this)),this.container.addEventListener("paste",this.HandlePaste.bind(this)),this.layout.grid_cover.addEventListener("mousedown",(t=>this.MouseDown_Grid(t))),this.layout.column_header_cover.addEventListener("mousedown",(t=>this.MouseDown_ColumnHeader(t))),this.layout.row_header_cover.addEventListener("mousedown",(t=>this.MouseDown_RowHeader(t))),this.layout.column_header_cover.addEventListener("mousemove",(t=>this.MouseMove_ColumnHeader(t))),this.layout.row_header_cover.addEventListener("mousemove",(t=>this.MouseMove_RowHeader(t))),this.layout.grid_cover.addEventListener("mousemove",(t=>this.MouseMove_Grid(t))),null===(t=this.overlay_editor)||void 0===t||t.edit_node.addEventListener("keydown",(t=>this.OverlayKeyDown(t))),this.layout.corner.addEventListener("dblclick",(()=>{this.SelectAll()}))}HandleCopy(t){if(t.stopPropagation(),t.preventDefault(),this.primary_selection.empty){if(t.clipboardData&&t.clipboardData.clearData(),this.selected_annotation&&t.clipboardData){const e=JSON.stringify({data:this.selected_annotation,source:this.active_sheet.id});if(t.clipboardData.setData("text/x-treb-annotation",e),this.selected_annotation.node){const e=this.selected_annotation.node.firstChild;if(e){const s=(t=>{if(!I){const t={},e=document.createElement("iframe");e.style.width="10px",e.style.height="10px",e.style.position="absolute",e.style.left="-100px",document.body.appendChild(e);const s=e.contentDocument;if(s){const e=s.createElement("div");s.body.appendChild(e);const i=getComputedStyle(e);Array.prototype.forEach.call(i,(e=>t[e]=i[e]))}document.body.removeChild(e),I=t}return V(t,I)})(e).outerHTML,i="text/plain";t.clipboardData.setData(i,s)}}}}else{const e=this.active_sheet.RealArea(this.primary_selection.area),s=e.columns,i=e.rows,r=[],o=[];for(let t=0;t<i;t++){const i=[];for(let r=0;r<s;r++){const s={row:e.start.row+t,column:e.start.column+r},a=this.active_sheet.CellData(s);i.push(void 0===a.calculated?a.value:a.calculated);const n={address:s,data:a.value,type:a.type,style:this.active_sheet.GetCopyStyle(s)};a.area&&a.area.start.row===s.row&&a.area.start.column===s.column&&(n.array={rows:a.area.rows,columns:a.area.columns}),o.push(JSON.parse(JSON.stringify(n)))}r.push(i)}const a=r.map((t=>t.join("\t"))).join("\n");t.clipboardData&&(t.clipboardData.clearData(),t.clipboardData.setData("text/plain",a),t.clipboardData.setData("text/x-treb",JSON.stringify({source:e,data:o})))}}HandleCut(t){if(t.stopPropagation(),t.preventDefault(),this.HandleCopy(t),this.primary_selection.empty)this.selected_annotation&&this.RemoveAnnotation(this.selected_annotation);else{const t=this.active_sheet.RealArea(this.primary_selection.area);this.ExecCommand({key:zt.Clear,area:t})}}RecyclePasteAreas(t,e){const s=[];if(1===t.count)for(let t=e.start.row;t<=e.end.row;t++)for(let i=e.start.column;i<=e.end.column;i++)s.push(new r({row:t,column:i}));else if(t.columns===e.columns&&e.rows>=t.rows&&e.rows%t.rows==0)for(let i=e.start.row;i<=e.end.row;i+=t.rows)s.push(new r({row:i,column:e.start.column},{row:i+t.rows-1,column:e.end.column}));else if(t.rows===e.rows&&e.columns>=t.columns&&e.columns%t.columns==0)for(let i=e.start.column;i<=e.end.column;i+=t.columns)s.push(new r({column:i,row:e.start.row},{column:i+t.columns-1,row:e.end.row}));else s.push(e.Clone().Resize(t.rows,t.columns));return s}HandlePaste(t){var e;if(null===(e=this.overlay_editor)||void 0===e?void 0:e.editing)return;if(t.stopPropagation(),t.preventDefault(),!t.clipboardData)return;const s=t.clipboardData.getData("text/x-treb-annotation");if(s){try{const t=JSON.parse(s);if(t.source&&t.source!==this.active_sheet.id&&t.data&&t.data.formula){let e="";for(const s of this.model.sheets)if(s.id===t.source){e=s.name;break}if(e){const s=this.parser.Parse(t.data.formula);s.expression&&(this.parser.Walk(s.expression,(t=>("address"===t.type&&(t.sheet_id||t.sheet||(t.sheet=e)),!0))),t.data.formula="="+this.parser.Render(s.expression,void 0,""))}}const e=this.CreateAnnotation(t.data,!0,!0);if(e.node){const t=e.node;setTimeout((()=>{t.focus()}),1)}}catch(t){console.error(t)}return}if(this.primary_selection.empty)return;const i=this.active_sheet.RealArea(this.primary_selection.area),a=[],n=t.clipboardData.getData("text/x-treb");if(n)try{const t=JSON.parse(n),e=new r(t.source.start,t.source.end),s=this.RecyclePasteAreas(e,i);1===s.length&&i.Resize(s[0].rows,s[0].columns);const l=[];for(const i of s){this.active_sheet.cells.EnsureCell(i.end),a.push({key:zt.Clear,area:i});const s={rows:i.start.row-e.start.row,columns:i.start.column-e.start.column};t.data.forEach((t=>{let n=t.data;const h={row:t.address.row-e.start.row+i.start.row,column:t.address.column-e.start.column+i.start.column};if(t.type===o.formula){const t=this.parser.Parse(n);t.expression&&(n="="+this.parser.Render(t.expression,s,""))}if(t.array){const e={start:Object.assign({},h),end:{row:h.row+t.array.rows-1,column:h.column+t.array.columns-1}},s={key:zt.SetRange,value:n,array:!0,area:e};l.push(new r(e.start,e.end)),a.push(s)}else{let t=!1;for(const e of l)if(e.Contains(h)){t=!0;break}t||a.push({key:zt.SetRange,value:n,area:h})}a.push({key:zt.UpdateStyle,style:t.style||{},area:h})}))}}catch(t){return console.error("invalid treb data on clipboard"),void console.info(t)}else{const e=t.clipboardData.getData("text/plain");if(!e)return!0;const s=e.trim().split("\n").map((t=>t.split("\t").map((t=>t.trim())))),n=this.RecyclePasteAreas(new r({row:0,column:0},{row:s.length-1,column:s[0].length-1}),i);1===n.length&&(i.Resize(s.length,s[0].length),i.Resize(n[0].rows,n[0].columns));for(const t of n)for(let e=0;e<s.length;e++)for(let i=0;i<s[0].length;i++){const n=new r({row:e+t.start.row,column:i+t.start.column});if(this.active_sheet.cells.EnsureCell(n.end),s[e][i]){const t=this.SetInferredType({area:n,target:n.start,empty:!1},s[e][i],!1,!1);if(t)for(const e of t)a.push(e)}else{const t=this.active_sheet.cells.GetCell(n.start,!1);t&&t.type!==o.undefined&&a.push({key:zt.Clear,area:n.Clone()})}}}this.ExecCommand(a),this.Select(this.primary_selection,i)}AllSelections(t=!1){const e=[this.primary_selection,this.active_selection].concat(this.additional_selections);return t?e:e.filter((t=>!t.empty))}FreezeInternal(t){const e="boolean"!=typeof t.highlight_transition||t.highlight_transition;t.rows!==this.active_sheet.freeze.rows||t.columns!==this.active_sheet.freeze.columns?(this.active_sheet.freeze.rows=t.rows,this.active_sheet.freeze.columns=t.columns,this.QueueLayoutUpdate(),this.Repaint(),e&&this.HighlightFreezeArea(),t.rows||t.columns?this.layout.CloneFrozenAnnotations():this.layout.ClearFrozenAnnotations()):e&&this.HighlightFreezeArea()}RenameSheetInternal(t,e){if(!e||L.test(e))throw new Error("invalid sheet name");const s=e.toLowerCase();for(const e of this.model.sheets)if(e!==t&&e.name.toLowerCase()===s)throw new Error("sheet name already exists");const i=t.name.toLowerCase();t.name=e;for(const t of this.model.sheets){t.cells.IterateAll((t=>{if(t.ValueIsFormula()){let s=!1;const r=this.parser.Parse(t.value||"");r.expression&&(this.parser.Walk(r.expression,(t=>("address"===t.type&&t.sheet&&t.sheet.toLowerCase()===i&&(t.sheet=e,s=!0),!0))),s&&(t.value="="+this.parser.Render(r.expression,void 0,"")))}}));for(const s of t.annotations)if(s.formula){let t=!1;const r=this.parser.Parse(s.formula||"");r.expression&&(this.parser.Walk(r.expression,(s=>("address"===s.type&&s.sheet&&s.sheet.toLowerCase()===i&&(s.sheet=e,t=!0),!0))),t&&(s.formula="="+this.parser.Render(r.expression,void 0,"")))}}}PatchFormulasInternal(t,e,s,i,r,o,a){const n=this.parser.Parse(t||"");let l=!1;if(n.expression&&(this.parser.Walk(n.expression,(t=>{if("range"===t.type||"address"===t.type){const n=[];"range"===t.type?(t.start.sheet&&t.start.sheet.toLowerCase()===o||!t.start.sheet&&a)&&n.push(t.start,t.end):"address"===t.type&&(t.sheet&&t.sheet.toLowerCase()===o||!t.sheet&&a)&&n.push(t);for(const t of n)s&&t.row>=e&&(s<0&&t.row+s<e?t.column=t.row=-1:t.row+=s,l=!0),r&&t.column>=i&&(r<0&&t.column+r<i?t.column=t.row=-1:t.column+=r,l=!0);return!1}return!0})),l))return"="+this.parser.Render(n.expression,void 0,"")}InsertRowsInternal(t){if(!this.active_sheet.InsertRows(t.before_row,t.count))return void this.Error("You can't change part of an array.");this.model.named_ranges.PatchNamedRanges(0,0,t.before_row,t.count);const e=this.active_sheet.name.toLowerCase();for(const s of this.model.sheets){const i=s===this.active_sheet;s.cells.IterateAll((s=>{if(s.ValueIsFormula()){const r=this.PatchFormulasInternal(s.value||"",t.before_row,t.count,0,0,e,i);r&&(s.value=r)}}));for(const r of s.annotations)if(r.formula){const s=this.PatchFormulasInternal(r.formula||"",t.before_row,t.count,0,0,e,i);s&&(r.formula=s)}}const s=[],i=[];if(t.count>0){const e=this.layout.CellAddressToRectangle({row:t.before_row,column:0}),r=this.layout.default_row_height*t.count+1;for(const t of this.active_sheet.annotations)if(t.scaled_rect){if(e.top>=t.scaled_rect.bottom)continue;e.top<=t.scaled_rect.top?t.scaled_rect.top+=r-1:(t.scaled_rect.height+=r,i.push(t)),t.layout=this.layout.RectToAnnotationLayout(t.scaled_rect),s.push(t)}}else if(t.count<0){let e=this.layout.CellAddressToRectangle({row:t.before_row,column:0});t.count<-1&&(e=e.Combine(this.layout.CellAddressToRectangle({row:t.before_row-t.count-1,column:0})));for(const t of this.active_sheet.annotations)if(t.scaled_rect){if(t.scaled_rect.bottom<=e.top)continue;if(t.scaled_rect.top>=e.bottom-1)t.scaled_rect.top-=e.height;else if(t.scaled_rect.top<=e.top&&t.scaled_rect.bottom>=e.bottom)t.scaled_rect.height=Math.max(t.scaled_rect.height-e.height,10),i.push(t);else{if(t.scaled_rect.top>=e.top&&t.scaled_rect.bottom<=e.bottom)continue;if(t.scaled_rect.top>=e.top&&t.scaled_rect.bottom>e.bottom){const s=t.scaled_rect.top-e.top+1,r=e.height-s;t.scaled_rect.top-=s,t.scaled_rect.height=Math.max(t.scaled_rect.height-r,10),i.push(t)}else if(t.scaled_rect.top<e.top&&t.scaled_rect.bottom<=e.bottom){const s=t.scaled_rect.bottom-e.top;t.scaled_rect.height=Math.max(t.scaled_rect.height-s,10),i.push(t)}else console.info("unhandled case")}t.layout=this.layout.RectToAnnotationLayout(t.scaled_rect),s.push(t)}}if(t.count<0)for(const t of this.AllSelections())t.empty=!0;else for(const e of this.AllSelections())e.target.row>=t.before_row&&(e.target.row+=t.count),e.area.entire_column||(e.area.start.row>=t.before_row?e.area.Shift(t.count,0):e.area.end.row>=t.before_row&&e.area.ConsumeAddress({row:e.area.end.row+t.count,column:e.area.end.column}));if(this.QueueLayoutUpdate(),this.Repaint(),s.length){this.layout.UpdateAnnotation(s);for(const t of i)t.resize_callback&&t.resize_callback.call(void 0)}}InsertColumnsInternal(t){if(!this.active_sheet.InsertColumns(t.before_column,t.count))return void this.Error("You can't change part of an array.");this.model.named_ranges.PatchNamedRanges(t.before_column,t.count,0,0);const e=this.active_sheet.name.toLowerCase();for(const s of this.model.sheets){const i=s===this.active_sheet;s.cells.IterateAll((s=>{if(s.ValueIsFormula()){const r=this.PatchFormulasInternal(s.value||"",0,0,t.before_column,t.count,e,i);r&&(s.value=r)}}));for(const r of s.annotations)if(r.formula){const s=this.PatchFormulasInternal(r.formula,0,0,t.before_column,t.count,e,i);s&&(r.formula=s)}}const s=[],i=[];if(t.count>0){const e=this.layout.CellAddressToRectangle({row:0,column:t.before_column}),r=this.layout.default_column_width*t.count+1;for(const t of this.active_sheet.annotations)if(t.scaled_rect){if(e.left>=t.scaled_rect.right)continue;e.left<=t.scaled_rect.left?t.scaled_rect.left+=r-1:(t.scaled_rect.width+=r,i.push(t)),t.layout=this.layout.RectToAnnotationLayout(t.scaled_rect),s.push(t)}}else if(t.count<0){let e=this.layout.CellAddressToRectangle({row:0,column:t.before_column});t.count<-1&&(e=e.Combine(this.layout.CellAddressToRectangle({row:0,column:t.before_column-t.count-1})));for(const t of this.active_sheet.annotations)if(t.scaled_rect){if(t.scaled_rect.right<=e.left)continue;if(t.scaled_rect.left>=e.right-1)t.scaled_rect.left-=e.width;else if(t.scaled_rect.left<=e.left&&t.scaled_rect.right>=e.right)t.scaled_rect.width=Math.max(t.scaled_rect.width-e.width,10),i.push(t);else{if(t.scaled_rect.left>=e.left&&t.scaled_rect.right<=e.right)continue;if(t.scaled_rect.left>=e.left&&t.scaled_rect.right>e.right){const s=t.scaled_rect.left-e.left+1,r=e.width-s;t.scaled_rect.left-=s,t.scaled_rect.width=Math.max(t.scaled_rect.width-r,10),i.push(t)}else if(t.scaled_rect.left<e.left&&t.scaled_rect.right<=e.right){const s=t.scaled_rect.right-e.left;t.scaled_rect.width=Math.max(t.scaled_rect.width-s,10),i.push(t)}else console.info("unhandled case")}t.layout=this.layout.RectToAnnotationLayout(t.scaled_rect),s.push(t)}}if(t.count<0)for(const t of this.AllSelections())t.empty=!0;else for(const e of this.AllSelections())e.target.column>=t.before_column&&(e.target.column+=t.count),e.area.entire_row||(e.area.start.column>=t.before_column?e.area.Shift(0,t.count):e.area.end.column>=t.before_column&&e.area.ConsumeAddress({row:e.area.end.row,column:e.area.end.column+t.count}));if(this.QueueLayoutUpdate(),this.Repaint(),s.length){this.layout.UpdateAnnotation(s);for(const t of i)t.resize_callback&&t.resize_callback.call(void 0)}}ApplyBordersInternal(t){const e=t.borders,s=t.borders===Dt.None?0:t.width,i=new r(t.area.start,t.area.end);let o=this.active_sheet;if(t.area.start.sheet_id&&t.area.start.sheet_id!==this.active_sheet.id)for(const e of this.model.sheets)if(e.id===t.area.start.sheet_id){o=e;break}const a={border_top:s},n={border_bottom:s},l={border_left:s},h={border_right:s};return t.color&&(a.border_top_fill=Object.assign({},t.color),n.border_bottom_fill=Object.assign({},t.color),l.border_left_fill=Object.assign({},t.color),h.border_right_fill=Object.assign({},t.color)),e!==Dt.None&&e!==Dt.All||o.UpdateAreaStyle(i,Object.assign(Object.assign(Object.assign(Object.assign({},a),n),l),h),!0),e!==Dt.Top&&e!==Dt.Outside||i.entire_column||o.UpdateAreaStyle(i.top,Object.assign({},a),!0),e!==Dt.None&&e!==Dt.All&&e!==Dt.Outside&&e!==Dt.Top||i.entire_column||i.start.row&&o.UpdateAreaStyle(new r({row:i.start.row-1,column:i.start.column},{row:i.start.row-1,column:i.end.column}),Object.assign({},{border_bottom:0}),!0),e!==Dt.Bottom&&e!==Dt.Outside||i.entire_column||o.UpdateAreaStyle(i.bottom,Object.assign({},n),!0),e!==Dt.None&&e!==Dt.All&&e!==Dt.Outside&&e!==Dt.Bottom||i.entire_column||o.UpdateAreaStyle(new r({row:i.end.row+1,column:i.start.column},{row:i.end.row+1,column:i.end.column}),Object.assign({},{border_top:0}),!0),e!==Dt.Left&&e!==Dt.Outside||i.entire_row||o.UpdateAreaStyle(i.left,Object.assign({},l),!0),e!==Dt.None&&e!==Dt.All&&e!==Dt.Outside&&e!==Dt.Left||i.entire_row||i.start.column&&o.UpdateAreaStyle(new r({row:i.start.row,column:i.start.column-1},{row:i.end.row,column:i.start.column-1}),Object.assign({},{border_right:0}),!0),e!==Dt.Right&&e!==Dt.Outside||i.entire_row||o.UpdateAreaStyle(i.right,Object.assign({},h),!0),e!==Dt.None&&e!==Dt.All&&e!==Dt.Outside&&e!==Dt.Right||i.entire_row||o.UpdateAreaStyle(new r({row:i.start.row,column:i.end.column+1},{row:i.end.row,column:i.end.column+1}),Object.assign({},{border_left:0}),!0),r.Bleed(i)}SetRangeInternal(t){const e=i(t.area)?new r(t.area):new r(t.area.start,t.area.end);let s=this.active_sheet;if(e.start.sheet_id&&e.start.sheet_id!==this.active_sheet.id)for(const t of this.model.sheets)if(t.id===e.start.sheet_id){s=t;break}if(e.entire_row||e.entire_column||!(e.end.row>=s.rows||e.end.column>=s.columns)||(s.cells.EnsureCell(e.end),this.QueueLayoutUpdate()),i(t.area)){const i=s.CellData(t.area);if(i.area&&(i.area.rows>1||i.area.columns>1))return void this.Error("You can't change part of an array.");const r=Array.isArray(t.value)?Array.isArray(t.value[0])?t.value[0][0]:t.value[0]:t.value;return t.array?s.SetArrayValue(e,r):s.SetCellValue(t.area,r),e}if(t.array){const i=Array.isArray(t.value)?Array.isArray(t.value[0])?t.value[0][0]:t.value[0]:t.value;s.SetArrayValue(e,i)}else s.SetAreaValues2(e,t.value);return e}ClearAreaInternal(t){let e=!1;t=this.active_sheet.RealArea(t),this.active_sheet.cells.Apply(t,(s=>{s.area&&!t.ContainsArea(s.area)&&(e=!0)})),e?this.Error("You can't change part of an array."):this.active_sheet.ClearArea(t)}ExecCommand(t){let e,s,o,a=!1,n=!1;const l=[];Array.isArray(t)||(t=[t]),this.command_log.Publish({command:t,timestamp:(new Date).getTime()});for(const l of t)switch(l.key){case zt.Clear:if(l.area){const t=new r(l.area.start,l.area.end);this.ClearAreaInternal(t),s=r.Join(t,s),this.UpdateFormulaBarFormula()}else mt.Reset(),this.RemoveAnnotationNodes(),this.UpdateSheets([],!0),this.model.named_ranges.Reset(),this.model.macro_functions={},this.ClearSelection(this.primary_selection),this.ScrollIntoView({row:0,column:0}),this.QueueLayoutUpdate(),this.layout.HideNote();break;case zt.Select:l.area?(l.area.start.sheet_id&&l.area.start.sheet_id!==this.active_sheet.id&&this.ActivateSheetInternal({key:zt.ActivateSheet,id:l.area.start.sheet_id}),this.Select(this.primary_selection,new r(l.area.start,l.area.end)),this.RenderSelections()):this.ClearSelection(this.primary_selection);break;case zt.Freeze:this.FreezeInternal(l),a=!0;break;case zt.MergeCells:this.active_sheet.MergeCells(new r(l.area.start,l.area.end)),e=r.Join(l.area,e),a=!0,n=!0,s=r.Join(l.area,s);break;case zt.UnmergeCells:{const t={},i=new r(l.area.start,l.area.end);this.active_sheet.cells.Apply(i,(e=>{if(e.merge_area){const s=r.CellAddressToLabel(e.merge_area.start)+":"+r.CellAddressToLabel(e.merge_area.end);t[s]=e.merge_area}}),!1);const o=Object.keys(t);for(let e=0;e<o.length;e++)this.active_sheet.UnmergeCells(t[o[e]]);e=r.Join(l.area,e),s=r.Join(l.area,s),a=!0,n=!0}break;case zt.UpdateStyle:{let t,s=this.active_sheet;if(i(l.area)){if(t=new r(l.area),t.start.sheet_id&&t.start.sheet_id!==this.active_sheet.id)for(const e of this.model.sheets)if(e.id===t.start.sheet_id){s=e;break}s.UpdateCellStyle(l.area,l.style,!!l.delta)}else{if(t=new r(l.area.start,l.area.end),t.start.sheet_id&&t.start.sheet_id!==this.active_sheet.id)for(const e of this.model.sheets)if(e.id===t.start.sheet_id){s=e;break}s.UpdateAreaStyle(t,l.style,!!l.delta)}s===this.active_sheet&&(o=r.Join(t,o),(!l.delta||l.style.fill||l.style.border_top||l.style.border_left||l.style.border_right||l.style.border_bottom)&&(t=r.Bleed(t),this.active_sheet.Invalidate(t)),e=r.Join(t,e))}break;case zt.DataValidation:this.SetValidationInternal(l),e=r.Join(new r(l.target),e);break;case zt.SetName:l.area?(this.model.named_ranges.SetName(l.name,new r(l.area.start,l.area.end)),this.autocomplete_matcher.AddFunctions({type:yt.Token,name:l.name})):(this.model.named_ranges.ClearName(l.name),this.autocomplete_matcher.RemoveFunctions({type:yt.Token,name:l.name})),a=!0,n=!0;break;case zt.UpdateBorders:{const t=this.ApplyBordersInternal(l);e=r.Join(t,e),o=r.Join(t,o)}break;case zt.ShowSheet:this.ShowSheetInternal(l),a=!0;break;case zt.ReorderSheet:{const t=[],e=this.model.sheets[l.index];for(let s=0;s<this.model.sheets.length;s++)s!==l.index&&(s===l.move_before&&t.push(e),t.push(this.model.sheets[s]));l.move_before>=this.model.sheets.length&&t.push(e),this.model.sheets=t,this.tab_bar&&this.tab_bar.Update(),a=!0}break;case zt.RenameSheet:{const t=this.ResolveSheet(l);t&&(this.RenameSheetInternal(t,l.new_name),this.tab_bar&&this.tab_bar.Update(),a=!0)}break;case zt.ResizeRows:{let t=l.row;if(void 0===t){t=[];for(let e=0;e<this.active_sheet.rows;e++)t.push(e)}if("number"==typeof t&&(t=[t]),"number"==typeof l.height)for(const e of t)this.layout.SetRowHeight(e,l.height);else for(const e of t)this.active_sheet.AutoSizeRow(e,this.theme.grid_cell);this.layout.UpdateTotalSize(),this.layout.container&&this.layout.container.offsetHeight&&this.layout.container.offsetHeight>this.layout.total_height?this.UpdateLayout():(this.layout.UpdateTileHeights(!0),this.render_tiles=this.layout.VisibleTiles(),this.Repaint(!1,!0)),this.layout.UpdateAnnotation(this.active_sheet.annotations),a=!0,this.RenderSelections()}break;case zt.ResizeColumns:{let t=l.column;if(void 0===t){t=[];for(let e=0;e<this.active_sheet.columns;e++)t.push(e)}if("number"==typeof t&&(t=[t]),"number"==typeof l.width)for(const e of t)this.layout.SetColumnWidth(e,l.width);else for(const e of t)this.active_sheet.AutoSizeColumn(e,!1);this.layout.UpdateTotalSize(),this.layout.container&&this.layout.container.offsetWidth&&this.layout.container.offsetWidth>this.layout.total_width?this.UpdateLayout():(this.layout.UpdateTileWidths(!0),this.render_tiles=this.layout.VisibleTiles(),this.Repaint(!1,!0)),this.layout.UpdateAnnotation(this.active_sheet.annotations),a=!0,this.RenderSelections()}break;case zt.ShowHeaders:this.active_sheet.SetHeaderSize(l.show?void 0:1,l.show?void 0:1),this.QueueLayoutUpdate(),this.Repaint();break;case zt.InsertRows:this.InsertRowsInternal(l),a=!0,n=!0;break;case zt.InsertColumns:this.InsertColumnsInternal(l),a=!0,n=!0;break;case zt.SetLink:case zt.SetNote:{let t=this.active_sheet;if(l.address.sheet_id)for(const e of this.model.sheets)if(e.id===l.address.sheet_id){t=e;break}let s=t.cells.GetCell(l.address,!0);if(s){let i;s.merge_area?(i=new r(s.merge_area.start),s=t.cells.GetCell(s.merge_area.start,!0)):i=new r(l.address),l.key===zt.SetNote?s.SetNote(l.note):(s.hyperlink=l.reference||void 0,s.render_dirty=!0),t===this.active_sheet&&this.DelayedRender(!1,i),o=r.Join(i,o),e=r.Join(i,e)}}break;case zt.SetRange:{const t=this.SetRangeInternal(l);t&&(s=r.Join(t,s),this.options.repaint_on_cell_change&&(e=r.Join(t,e)))}break;case zt.DeleteSheet:this.DeleteSheetInternal(l),a=!0,n=!0;break;case zt.DuplicateSheet:this.DuplicateSheetInternal(l),a=!0,n=!0;break;case zt.AddSheet:this.ActivateSheetInternal({key:zt.ActivateSheet,id:this.AddSheetInternal(l.name,l.insert_index)}),a=!0;break;case zt.ActivateSheet:this.ActivateSheetInternal(l);break;default:console.warn(`unhandled command: ${zt[l.key]} (${l.key})`)}s&&(s.start.sheet_id||s.SetSheetID(this.active_sheet.id),l.push({type:"data",area:s})),o&&(o.start.sheet_id||o.SetSheetID(this.active_sheet.id),l.push({type:"style",area:o})),a&&l.push({type:"structure",rebuild_required:n}),this.batch?this.batch_events.push(...l):(this.grid_events.Publish(l),e&&this.DelayedRender(!1,e))}}!function(t){t[t.white=0]="white",t[t.gray=1]="gray",t[t.black=2]="black"}(Pt||(Pt={}));class jt{constructor(){this.type=jt.type,this.color=Pt.white,this.edges_in=[],this.edges_out=[]}get has_inbound_edges(){return this.edges_in.length>0}get has_outbound_edges(){return this.edges_out.length>0}Reset(){for(const t of this.edges_out)t.RemoveDependency(this);for(const t of this.edges_in)t.RemoveDependent(this);this.edges_out=[],this.edges_in=[]}ClearDependencies(){for(const t of this.edges_in)t.RemoveDependent(this);this.edges_in=[]}AddDependent(t){if(t!==this){for(const e of this.edges_out)if(e===t)return;this.edges_out.push(t)}}RemoveDependent(t){this.edges_out=this.edges_out.filter((e=>e!==t))}AddDependency(t){if(t!==this){for(const e of this.edges_in)if(e===t)return;this.edges_in.push(t)}}RemoveDependency(t){this.edges_in=this.edges_in.filter((e=>e!==t))}LinkTo(t){this.AddDependent(t),t.AddDependency(this)}DependsOn(t){this.AddDependency(t),t.AddDependent(this)}LoopCheck(){this.color=Pt.gray;for(const t of this.edges_out)if(t.color===Pt.gray||t.color===Pt.white&&t.LoopCheck())return this.color=Pt.white,!0;return this.color=Pt.black,!1}}jt.type="vertex";class Gt extends jt{constructor(){super(...arguments),this.dirty=!1}}!function(t){t[t.None=0]="None",t[t.CalculationError=1]="CalculationError"}(Ft||(Ft={}));class Bt extends Gt{constructor(){super(...arguments),this.error=Ft.None,this.result=d(),this.expression={type:"missing",id:-1},this.expression_error=!1,this.short_circuit=!1,this.type=Bt.type}get array_head(){return!!this.address&&!!this.reference&&!!this.reference.area&&this.reference.area.start.column===this.address.column&&this.reference.area.start.row===this.address.row}TakeReferenceValue(){this.reference&&(this.result=u(this.reference.GetValue()))}Calculate(t){if(this.dirty)if(this.color===Pt.white&&this.LoopCheck()&&(this.dirty=!1,this.edges_in.length)){this.reference&&(this.array_head||this.reference.type===o.formula)&&this.reference.SetCalculationError("LOOP");for(const e of this.edges_out)e.Calculate(t)}else{for(const t of this.edges_in)if(t.dirty)return;if(this.reference){if(this.reference.type===o.formula){this.short_circuit=!1;const e=t.CalculationCallback.call(t,this);if(this.result=e.value,this.short_circuit)return;e.volatile&&t.volatile_list.push(this)}else this.result=this.reference.GetValue4();if(this.array_head)t.SpreadCallback.call(t,this,this.result);else if(this.reference.type===o.formula){const t=Array.isArray(this.result)?this.result[0][0]:this.result;this.reference.SetCalculatedValue(t.value,t.type)}}else console.info("skip dirty constant? [or dangling...]");this.dirty=!1;for(const e of this.edges_out)e.dirty&&t.calculation_list.push(e)}}}Bt.type="spreadsheet-vertex";class Zt extends Gt{constructor(t){super(),this.type=Zt.type,this.area=t.Clone(),Zt.list.push(this)}static GetVertex(t){for(const e of this.list)if(e.area.start.sheet_id===t.start.sheet_id&&e.area.Equals(t))return[e,!1];return[new Zt(t),!0]}static Clear(){this.list=[]}static GetContainingArrays(t){const e=[];for(const s of this.list)s.area.start.sheet_id===t.sheet_id&&s.area.Contains(t)&&e.push(s);return e}static CreateImplicitEdges(t,e){for(const s of this.list)s.area.start.sheet_id===e.sheet_id&&s.area.Contains(e)&&s.DependsOn(t)}RemoveDependent(t){super.RemoveDependent(t),this.edges_out.length||(this.Reset(),Zt.list=Zt.list.filter((t=>t!==this)))}Calculate(t){if(this.dirty)if(this.color===Pt.white&&this.LoopCheck()&&(this.dirty=!1,this.edges_in.length))for(const e of this.edges_out)e.Calculate(t);else{for(const t of this.edges_in)if(t.dirty)return;this.dirty=!1;for(const e of this.edges_out)e.Calculate(t)}}}Zt.type="array-vertex",Zt.list=[],(Ot=It||(It={}))[Ot.OK=0]="OK",Ot[Ot.Loop=1]="Loop",Ot[Ot.CalculationError=2]="CalculationError",function(t){t.Argument="ARG",t.Data="DATA",t.Reference="REF",t.Name="NAME",t.Expression="EXPR",t.Value="VALUE",t.Unknown="UNK",t.NotImpl="NOTIMPL",t.Div0="DIV/0",t.NA="N/A"}(Ut||(Ut={}));const Jt={error:Ut.NotImpl},qt=()=>({type:o.error,value:Ut.Expression}),Wt=()=>({type:o.error,value:Ut.Data}),Kt=()=>({type:o.error,value:Ut.Div0}),Xt=()=>({type:o.error,value:Ut.Argument}),Yt=()=>({type:o.error,value:Ut.Value}),Qt=()=>({type:o.error,value:Ut.Reference}),te=()=>({type:o.error,value:Ut.Name}),ee=()=>({type:o.error,value:Ut.Unknown});var se;!function(t){t[t.value=0]="value",t[t.reference=1]="reference"}(se||(se={}));const ie=(t,e)=>{if(t.type===o.error)return[0,0,t];if(e.type===o.error)return[0,0,e];const s=[0,0];switch(t.type){case o.number:s[0]=t.value;break;case o.boolean:s[0]=t.value?1:0;break;case o.undefined:break;default:return[0,0,Yt()]}switch(e.type){case o.number:s[1]=e.value;break;case o.boolean:s[1]=e.value?1:0;break;case o.undefined:break;default:return[0,0,Yt()]}return s},re=(t,e)=>{const[s,i,r]=ie(t,e);return r||{value:s+i,type:o.number}},oe=(t,e)=>{const[s,i,r]=ie(t,e);return r||{value:s-i,type:o.number}},ae=(t,e)=>{const[s,i,r]=ie(t,e);return r||{value:Math.pow(s,i),type:o.number}},ne=(t,e)=>{const[s,i,r]=ie(t,e);return r||{value:s*i,type:o.number}},le=(t,e)=>{const[s,i,r]=ie(t,e);return r||(0===i?Kt():{value:s/i,type:o.number})},he=(t,e)=>{const[s,i,r]=ie(t,e);return r||(0===i?Kt():{value:s%i,type:o.number})},ce=(t,e)=>t.type===o.error?t:e.type===o.error?e:{type:o.string,value:`${t.type===o.undefined?"":t.value}${e.type===o.undefined?"":e.value}`},de=(t,e)=>t.type===o.error?t:e.type===o.error?e:t.type===o.undefined&&(""===e.value||0===e.value)||e.type===o.undefined&&(""===t.value||0===t.value)?{type:o.boolean,value:!0}:{type:o.boolean,value:t.value==e.value},ue=(t,e)=>t.type===o.error?t:e.type===o.error?e:t.type===o.undefined&&(""===e.value||0===e.value)||e.type===o.undefined&&(""===t.value||0===t.value)?{type:o.boolean,value:!1}:{type:o.boolean,value:t.value!=e.value},me=(t,e)=>t.type===o.error?t:e.type===o.error?e:{type:o.boolean,value:(t.value||0)>(e.value||0)},fe=(t,e)=>t.type===o.error?t:e.type===o.error?e:{type:o.boolean,value:t.value>=e.value},pe=(t,e)=>t.type===o.error?t:e.type===o.error?e:{type:o.boolean,value:t.value<e.value},_e=(t,e)=>t.type===o.error?t:e.type===o.error?e:{type:o.boolean,value:t.value<=e.value},ge=t=>!Array.isArray(t)&&t.type===o.object&&!!t.value.type,ye=t=>!Array.isArray(t)&&t.type===o.object&&"metadata"===t.value.type;class ve{constructor(t,e){this.library=t,this.parser=e,this.context={address:{row:-1,column:-1},volatile:!1,call_index:0},this.call_index=0,this.cells_map={},this.sheet_name_map={},this.named_range_map={}}SetModel(t){this.cells_map={},this.sheet_name_map={};for(const e of t.sheets)this.cells_map[e.id]=e.cells,this.sheet_name_map[e.name.toLowerCase()]=e.id;this.data_model=t,this.named_range_map=t.named_ranges.Map(),this.context.model=t}Calculate(t,e,s=!1){return s||(this.context.address=e,this.context.volatile=!1,this.context.call_index=0,this.call_index=0),{value:this.CalculateExpression(t),volatile:this.context.volatile}}CellFunction2(t){if(!t.sheet_id){if(!t.sheet)return()=>Qt();t.sheet_id=this.sheet_name_map[t.sheet.toLowerCase()]}const e=this.cells_map[t.sheet_id];if(!e)return console.warn("missing cells reference @ "+t.sheet_id),()=>Qt();const s=e.GetCell(t);return s?()=>s.GetValue4():()=>({type:o.undefined,value:void 0})}CellFunction4(t,e){if(!t.sheet_id)throw new Error("missing sheet id in CellFunction4");return this.cells_map[t.sheet_id].GetRange4(t,e,!0)}GetMetadata(t,e){let s,i;switch(t.type){case"address":s=t;break;case"range":i=t;break;case"identifier":{const e=this.named_range_map[t.name.toUpperCase()];e&&(1===e.count?s=e.start:i=e)}break;case"call":{const e=this.CalculateExpression(t,!0);if(!ge(e))return e;if("address"===e.value.type)s=e.value;else{if("range"!==e.value.type)return e;i=e.value}}break;default:return this.CalculateExpression(t)}if(s){let t=this.data_model.active_sheet;if(s.sheet_id&&s.sheet_id!==t.id)for(const e of this.data_model.sheets)if(e.id===s.sheet_id){t=e;break}const i=t.CellData(s),r=i.calculated_type?i.calculated:i.value,a=Object.assign({type:"metadata",address:Object.assign({},s),value:r,format:i.style?i.style.number_format:void 0},e(i,s));return{type:o.object,value:a}}if(i){if(i.start.row===1/0||i.start.column===1/0)return Qt();let t=this.data_model.active_sheet;if(i.start.sheet_id&&i.start.sheet_id!==t.id)for(const e of this.data_model.sheets)if(e.id===i.start.sheet_id){t=e;break}const r=[];for(let a=i.start.column;a<=i.end.column;a++){const n=[];for(let r=i.start.row;r<=i.end.row;r++){const l=t.CellData({row:r,column:a});s=Object.assign(Object.assign({},i.start),{row:r,column:a});const h=l.calculated_type?l.calculated:l.value,c=Object.assign({type:"metadata",address:s,value:h,format:l.style?l.style.number_format:void 0},e(l,s));n.push({type:o.object,value:c})}r.push(n)}return r}return this.CalculateExpression(t)}RewriteMacro(t,e){let s;switch(t.type){case"identifier":if(s=e[t.name.toUpperCase()],s)return JSON.parse(JSON.stringify(s));break;case"binary":t.left=this.RewriteMacro(t.left,e),t.right=this.RewriteMacro(t.right,e);break;case"unary":t.operand=this.RewriteMacro(t.operand,e);break;case"group":t.elements=t.elements.map((t=>this.RewriteMacro(t,e)));break;case"call":t.args=t.args.map((t=>this.RewriteMacro(t,e)))}return t}CallMacro(t,e){var s;if(!e.expression)return()=>qt();const i=JSON.stringify(e.expression),r={},o=(null===(s=e.argument_names)||void 0===s?void 0:s.map((t=>t.toUpperCase())))||[];return t=>{const e=JSON.parse(i);for(let e=0;e<o.length;e++)r[o[e]]=t.args[e]||{type:"missing"};return this.CalculateExpression(this.RewriteMacro(e,r))}}CallExpression(t,e=!1){const s=this.library.Get(t.name);return s?i=>{const r=this.call_index++;this.context.volatile=this.context.volatile||!!s.volatile;const a="if"===t.name.toLowerCase();let n,l=-1;const h=s.arguments||[],c=i.args.map(((t,e)=>{if(n)return;const s=h[Math.min(e,h.length-1)]||{};if(e===l)return s.boxed?d():void 0;if(void 0===t)return a&&0===e&&(l=1),s.boxed?d():void 0;if(s.address)return s.boxed?{type:o.string,value:this.parser.Render(t).replace(/\$/g,"")}:this.parser.Render(t).replace(/\$/g,"");if(s.metadata)return this.GetMetadata(t,(()=>({})));{const i=this.CalculateExpression(t);if(!Array.isArray(i)&&i.type===o.error)return s.allow_error?i:void(n=i);if(a&&0===e&&!Array.isArray(i)){let t=!1;if(i.type===o.string){const e=i.value.toLowerCase().trim();t="false"!==e&&"f"!==e}else t=!!i.value;l=t?2:1}return s.boxed?i:Array.isArray(i)?i.map((t=>t.map((t=>t.value)))):i.value}}));if(n)return n;if(this.context.call_index=r,s.return_type===se.reference){const t=s.fn.apply(null,c);if(e)return t;if(ge(t)){if("address"===t.value.type)return this.CellFunction2(t.value)();if("range"===t.value.type)return this.CellFunction4(t.value.start,t.value.end)}return t}return s.fn.apply(null,c)}:()=>te()}UnaryExpression(t){switch(t.operator){case"+":return t=>this.CalculateExpression(t.operand);case"-":{const t=oe,e={type:o.number,value:0};return s=>{const i=this.CalculateExpression(s.operand);return Array.isArray(i)?i.map((s=>s.map((s=>t(e,s))))):t(e,i)}}default:return()=>(console.warn("unexpected unary operator:",t.operator),qt())}}RecycleArray(t,e,s){if(t[0].length<s){const e=t[0].length;for(const i of t)for(let t=e;t<s;t++)i[t]=i[t%e]}if(t.length<e){const s=t.length;for(let i=s;i<e;i++)t[i]=t[i%s].slice(0)}return t}ElementwiseBinaryExpression(t,e,s){const i=Math.max(e.length,s.length),r=Math.max(e[0].length,s[0].length);e=this.RecycleArray(e,i,r),s=this.RecycleArray(s,i,r);const o=[];for(let a=0;a<i;a++){const i=[];for(let o=0;o<r;o++)i[o]=t(e[a][o],s[a][o]);o.push(i)}return o}BinaryExpression(t){const e=(t=>{switch(t){case"&":return ce;case"+":return re;case"-":return oe;case"*":return ne;case"/":return le;case"^":case"**":return ae;case"%":return he;case"=":case"==":return de;case"!=":case"<>":return ue;case">":return me;case">=":return fe;case"<":return pe;case"<=":return _e}})(t.operator);return e?t=>{const s=this.CalculateExpression(t.left),i=this.CalculateExpression(t.right);return Array.isArray(s)?Array.isArray(i)?this.ElementwiseBinaryExpression(e,s,i):this.ElementwiseBinaryExpression(e,s,[[i]]):Array.isArray(i)?this.ElementwiseBinaryExpression(e,[[s]],i):e(s,i)}:()=>(console.info(`(unexpected binary operator: ${t.operator})`),qt())}Identifier(t){const e=t.name,s=e.toUpperCase();switch(s){case"FALSE":case"F":return()=>({value:!1,type:o.boolean});case"TRUE":case"T":return()=>({value:!0,type:o.boolean});case"UNDEFINED":return()=>({value:void 0,type:o.undefined})}return()=>{const t=this.named_range_map[s];return t?1===t.count?this.CellFunction4(t.start,t.start):this.CellFunction4(t.start,t.end):(console.info("** identifier",e),te())}}GroupExpression(t){return t.elements&&1===t.elements.length?t=>this.CalculateExpression(t.elements[0]):(console.warn("Can't handle group !== 1"),()=>qt())}CalculateExpression(t,e=!1){if(t.user_data)return t.user_data(t);switch(t.type){case"call":{const s=this.data_model.macro_functions[t.name.toUpperCase()];return s?(t.user_data=this.CallMacro(t,s))(t):(t.user_data=this.CallExpression(t,e))(t)}case"address":return(t.user_data=this.CellFunction2(t))();case"range":return(t.user_data=t=>this.CellFunction4(t.start,t.end))(t);case"binary":return(t.user_data=this.BinaryExpression(t))(t);case"unary":return(t.user_data=this.UnaryExpression(t))(t);case"identifier":return(t.user_data=this.Identifier(t))();case"missing":return(t.user_data=()=>({value:void 0,type:o.undefined}))();case"literal":{const e={value:t.value,type:a(t.value)};return(t.user_data=()=>e)()}case"group":return(t.user_data=this.GroupExpression(t))(t);case"array":return(t.user_data=()=>t.values.map((t=>(Array.isArray(t)?t:[t]).map((t=>({value:t,type:a(t)}))))))();default:return console.warn("Unhandled parse expr:",t),ee()}}}const be=t=>{const e=[],s=t.length,i=t[0].length;for(let r=0;r<i;r++){e[r]=[];for(let i=0;i<s;i++)e[r][i]=t[i][r]}return e},we=t=>Array.isArray(t)?t.reduce(((t,e)=>void 0===e?t:Array.isArray(e)?t.concat(we(e)):e instanceof Float32Array||e instanceof Float64Array?t.concat(Array.from(e)):t.concat([e])),[]):[t],Ce=t=>(e,...s)=>Array.isArray(e)?e.map((e=>e.map((e=>t(e,...s))))):t(e,...s),xe=t=>(e,s,...i)=>Array.isArray(e)?Array.isArray(s)?e.map(((e,r)=>e.map(((e,o)=>t(e,s[r][o],...i))))):e.map((e=>e.map((e=>t(e,s,...i))))):t(e,s,...i);class Se{constructor(){this.functions={}}Register(...t){for(const e of t)for(const t of Object.keys(e)){if(/[^a-zA-Z0-9._]/.test(t))throw new Error("invalid function name (invalid character)");if(t.length>255)throw new Error("invalid function name (too long, > 255)");if(/^[^a-zA-Z]/.test(t))throw new Error("invalid function name (start with an ascii letter)");const s=t.toLowerCase();if(this.functions[s])throw new Error(`function name (${s}) is already in use`);const i=e[t];i.canonical_name=t,this.functions[s]=i}}Get(t){const e=t.toLowerCase();return this.functions[e]}List(){const t={};for(const e of Object.keys(this.functions))t[e]=this.functions[e];return t}Alias(t,e){const s=this.Get(e);if(!s)throw new Error(`referenced function ${e} does not exist`);this.Register({[t]:Object.assign({},s)})}}var Ae;!function(t){t[t.move=0]="move",t[t.line=1]="line"}(Ae||(Ae={}));class Me{static UnpackValues(t){if(Array.isArray(t)){const e=t[0];return Array.isArray(e)||e instanceof Float64Array||e instanceof Float32Array?t.reduce(((t,e)=>t.concat(this.UnpackValues(e))),[]):t.map((t=>isNaN(t)?void 0:t))}if(t instanceof Float32Array||t instanceof Float64Array)return Array.prototype.slice.call(t);if(t&&"object"==typeof t){const e=Object.keys(t).length;if(void 0!==t[0]&&void 0!==t[(e-1).toString()]){const s=[];for(let i=0;i<e;i++)s[i]=t[i.toString()];return s}}return[]}static SparklineCommon(t,e){var s;let i=[];const r=(null===(s=e.text)||void 0===s?void 0:s.text)||this.default_color,o=[r,r];return Array.isArray(t.calculated)&&(i=this.UnpackValues(t.calculated[0]),"string"==typeof t.calculated[1]&&(o[0]=t.calculated[1]),"string"==typeof t.calculated[2]&&(o[1]=t.calculated[2])),{values:i,colors:o}}static RenderLine(t,e,s,i,r){const{values:o,colors:a}=this.SparklineCommon(i,r);let n=1;Array.isArray(i.calculated)&&"number"==typeof i.calculated[2]&&(n=i.calculated[2]);let l=0,h=0,c=-1;for(let t=0;t<o.length;t++){const e=o[t];"number"==typeof e&&(c>=0?(l=Math.min(l,e),h=Math.max(h,e)):(c=t,l=h=e))}if(l!==h){const i=.9*t/(o.length-1),r=h-l,d=.8*e,u=.1*e;s.strokeStyle=a[0],s.lineWidth=n,s.lineCap="round",s.lineJoin="round",s.beginPath();let m=Ae.move;for(let a=c;a<o.length;a++){const n=o[a];if("number"==typeof n){const o=.05*t+i*a,h=e-(n-l)*d/r-u;m===Ae.move?(s.moveTo(o,h),m=Ae.line):s.lineTo(o,h)}else m=Ae.move}s.stroke()}}static RenderColumn(t,e,s,i,r){const{values:o,colors:a}=this.SparklineCommon(i,r);let n=0,l=0,h=!1;for(const t of o)"number"==typeof t&&(h?(n=Math.min(n,t),l=Math.max(l,t)):(h=!0,n=l=t));if(o.length){const i=(t-6-2)/(o.length-0),r=e-5,h=2.5;if(n!==l)if(n<0&&l>0){const t=l-n,e=h+l/t*r;for(let n=0;n<o.length;n++){const l=o[n];if("number"==typeof l){const o=3+n*i,h=Math.abs(l)/t*r;if(l>=0){s.fillStyle=a[0];const t=e-h;s.fillRect(o+2,t,i-2,h)}else{s.fillStyle=a[1];const t=e;s.fillRect(o+2,t,i-2,h)}}}}else if(l>0){s.fillStyle=a[0];const t=l-n;for(let a=0;a<o.length;a++){const l=o[a];if("number"==typeof l){const o=3+a*i,c=Math.max(1,(l-n)/t*r),d=e-h-c;s.fillRect(o+2,d,i-2,c)}}}else{s.fillStyle=a[1];const t=l-n;for(let e=0;e<o.length;e++){const a=o[e];if("number"==typeof a){const o=3+e*i,n=Math.max(1,Math.abs(l-a)/t*r),c=h;s.fillRect(o+2,c,i-2,n)}}}}}}Me.default_color="#888";const ke=t=>{const e=1/(1+.3275911*(t=Math.abs(t)));return 1-((((1.061405429*e-1.453152027)*e+1.421413741)*e-.284496736)*e+.254829592)*e*Math.exp(-1*t*t)},Re=t=>{if(.5===t)return 0;const e=t<1&&t>.5?1-t:t,s=Math.sqrt(Math.log(1/Math.pow(e,2))),i=s-(2.515517+.802853*s+.010328*Math.pow(s,2))/(1+1.432788*s+.189269*Math.pow(s,2)+.001308*Math.pow(s,3));return t>.5?i:-i},Le={type:o.boolean,value:!0},Ee={type:o.boolean,value:!1},Te={Rand:{volatile:!0,fn:()=>({type:o.number,value:Math.random()})},RandBetween:{arguments:[{name:"min"},{name:"max"}],volatile:!0,fn:(t=0,e=1)=>{if(t>e){const s=t;t=e,e=s}return{type:o.number,value:Math.random()*(e-t)+t}}},Sum:{description:"Adds arguments and ranges",arguments:[{boxed:!0,name:"values or ranges"}],fn:(...t)=>{let e=0;const s=we(t);for(const t of s)switch(t.type){case o.number:e+=t.value;break;case o.boolean:e+=t.value?1:0;break;case o.error:return t}return{type:o.number,value:e}}},Now:{description:"Returns current time",volatile:!0,fn:()=>({type:o.number,value:X((new Date).getTime())})},Today:{description:"Returns current day",volatile:!0,fn:()=>{const t=new Date;return t.setMilliseconds(0),t.setSeconds(0),t.setMinutes(0),t.setHours(12),{type:o.number,value:X(t.getTime())}}},IfError:{description:"Returns the original value, or the alternate value if the original value contains an error",arguments:[{name:"original value",allow_error:!0,boxed:!0},{name:"alternate value"}],fn:(t,e=0)=>t&&t.type===o.error?{value:e,type:a(e)}:t},IsError:{description:"Checks if another cell contains an error",arguments:[{name:"reference",allow_error:!0,boxed:!0}],fn:t=>{if(Array.isArray(t)){const e=we(t);for(const t of e)if(t.type===o.error)return{type:o.boolean,value:!0}}else if(t)return{type:o.boolean,value:t.type===o.error};return{type:o.boolean,value:!1}}},Cell:{description:"Returns data about a cell",arguments:[{name:"type",description:"Type of data to return"},{name:"reference",description:"Cell reference",metadata:!0}],fn:(t,e)=>{if(!ye(e))return Qt();if(t)switch(t.toString().toLowerCase()){case"format":return e.value.format?{type:o.string,value:e.value.format}:Qt();case"address":return{type:o.string,value:e.value.address.label.replace(/\$/g,"")}}return{type:o.error,value:Jt.error}}},Year:{description:"Returns year from date",arguments:[{name:"date"}],fn:t=>u(new Date(K(t)).getUTCFullYear())},Month:{description:"Returns month from date",arguments:[{name:"date"}],fn:t=>u(new Date(K(t)).getUTCMonth()+1)},Day:{description:"Returns day of month from date",arguments:[{name:"date"}],fn:t=>u(new Date(K(t)).getUTCDate())},Radians:{description:"Converts degrees to radians",arguments:[{name:"Degrees",description:"Angle in degrees"}],fn:Ce((t=>u(t*Math.PI/180)))},Degrees:{description:"Converts radians to degrees",arguments:[{name:"Radians",description:"Angle in radians"}],fn:Ce((t=>u(t/Math.PI*180)))},CountA:{description:"Counts cells that are not empty",fn:(...t)=>u(we(t).reduce(((t,e)=>void 0===e?t:t+1),0))},Count:{description:"Counts cells that contain numbers",fn:(...t)=>u(we(t).reduce(((t,e)=>"number"==typeof e?t+1:t),0))},Or:{fn:(...t)=>{let e=!1;t=we(t);for(const s of t)e=e||!!s;return u(e)}},And:{fn:(...t)=>{let e=!0;t=we(t);for(const s of t)e=e&&!!s;return u(e)}},Not:{fn:(...t)=>0===t.length?Xt():1===t.length?u(!t[0]):u(!0)},If:{arguments:[{name:"test value",boxed:!0},{name:"value if true",boxed:!0,allow_error:!0},{name:"value if false",boxed:!0,allow_error:!0}],fn:(t,e=Le,s=Ee)=>Array.isArray(t)?t.map(((t,i)=>t.map(((t,r)=>(h(t)?"false"!==t.value.toLowerCase()&&"f"!==t.value.toLowerCase():t.value)?Array.isArray(e)?e[i][r]:e:Array.isArray(s)?s[i][r]:s)))):(h(t)?"false"!==t.value.toLowerCase()&&"f"!==t.value.toLowerCase():t.value)?e:s},Fact:{description:"Returns the factorial of a number",arguments:[{name:"number"}],fn:Ce((t=>{t=Math.floor(t);let e=1;for(;t>1;)e*=t,t--;return{type:o.number,value:e}}))},Power:{fn:xe(((t,e)=>u(Math.pow(t,e))))},Mod:{fn:xe(((t,e)=>e?u(t%e):Kt()))},Sort:{arguments:[{name:"values"}],fn:(...t)=>((t=we(t)).every((t=>"number"==typeof t))?t.sort(((t,e)=>t-e)):t.sort(),[t.map((t=>u(t)))])},Transpose:{description:"Returns transpose of input matrix",arguments:[{name:"matrix",boxed:!0}],fn:t=>Array.isArray(t)?be(t):t},Max:{fn:(...t)=>({type:o.number,value:Math.max.apply(0,we(t).filter((t=>"number"==typeof t)))})},Min:{fn:(...t)=>({type:o.number,value:Math.min.apply(0,we(t).filter((t=>"number"==typeof t)))})},SumProduct:{description:"Returns the sum of pairwise products of two or more ranges",fn:(...t)=>{const e=t.map((t=>we(t))),s=Math.max.apply(0,e.map((t=>t.length)));let i=0;for(let t=0;t<s;t++)i+=e.reduce(((e,s)=>e*(s[t]||0)),1);return{type:o.number,value:i}}},VLookup:{fn:(t,e,s,i=!0)=>{if(s=Math.max(0,s-1),i){let i=Math.abs(t-e[0][0]),r=e[s][0];for(let o=1;o<e[0].length;o++){const a=Math.abs(e[0][o]-t);a<i&&(i=a,r=e[s][o])}return u(r)}for(let i=1;i<e[0].length;i++)if(e[0][i]==t)return e[s][i];return{type:o.error,value:Ut.NA}}},Product:{fn:(...t)=>({type:o.number,value:we(t).reduce(((t,e)=>void 0===e?t:t*Number(e)),1)})},Log:{fn:xe(((t,e=10)=>({type:o.number,value:Math.log(t)/Math.log(e)})))},Log10:{fn:Ce((t=>({type:o.number,value:Math.log(t)/Math.log(10)})))},Ln:{fn:Ce((t=>({type:o.number,value:Math.log(t)})))},Round:{fn:xe(((t,e=0)=>{const s=Math.pow(10,e);return{type:o.number,value:Math.round(s*t)/s}}))},RoundDown:{fn:xe(((t,e=0)=>{const s=Math.pow(10,e),i=t>=0;return{type:o.number,value:i?Math.floor(s*t)/s:Math.ceil(s*t)/s}}))},Reverse:{arguments:[{boxed:!0}],fn:t=>Array.isArray(t)?1===t.length?[t[0].reverse()]:t.reverse():{type:o.string,value:t.value.toString().split("").reverse().join("")}},Abs:{fn:Ce((t=>({type:o.number,value:Math.abs(t)})))},Simplify:{fn:xe(((t,e=2)=>{if(e=e||2,0===t)return{type:o.number,value:t};const s=t<0?-1:1;t*=s;const i=Math.pow(10,Math.floor(Math.log10(t))+1-e);return{type:o.number,value:Math.round(t/i)*i*s}}))},Erf:{fn:t=>({type:o.number,value:ke(t)})},NormsInv:{description:"Inverse of the normal cumulative distribution",arguments:[{name:"probability"}],fn:t=>({type:o.number,value:Re(t)})},"Norm.Inv":{description:"Inverse of the normal cumulative distribution",arguments:[{name:"probability"},{name:"mean",default:0},{name:"standard deviation",default:1}],fn:(t,e=0,s=1)=>({type:o.number,value:Re(t)*s+e})},"Norm.Dist":{description:"Cumulative normal distribution",arguments:[{name:"value"},{name:"mean",default:0},{name:"standard deviation",default:1}],fn:(t,e=0,s=1)=>{const i=t<e?-1:1;return{type:o.number,value:.5*(1+i*ke(Math.abs(t-e)/(s*Math.sqrt(2))))}}},HexToDec:{arguments:[{description:"hexadecimal string"}],fn:t=>({type:o.number,value:parseInt(t,16)})},DecToHex:{arguments:[{description:"number"}],fn:t=>({type:o.string,value:t.toString(16)})},Checkbox:{arguments:[{name:"checked"}],click:t=>{const{x:e,y:s,width:i,height:r,cell:o}=t,a={};if(o&&i&&r&&e&&s){const t={x:3,y:r-3-16};if(o.style){switch(o.style.vertical_align){case v.VerticalAlign.Top:t.y=3;break;case v.VerticalAlign.Middle:t.y=Math.round(r/2-8)}switch(o.style.horizontal_align){case v.HorizontalAlign.Right:t.x=Math.round(i-3-16);break;case v.HorizontalAlign.Center:t.x=Math.round(i/2-8)}}e>=t.x&&e<=t.x+16&&s>=t.y&&s<=t.y+16&&(a.value=`=Checkbox(${o.calculated?"FALSE":"TRUE"})`,a.block_selection=!0)}return a},render:t=>{const{context:e,width:s,height:i,cell:r}=t,o=t.scale||1;e.lineJoin="round",e.lineCap="round";const a=3*o;let n=a,l=i-a-16*o;if(r.style){switch(r.style.vertical_align){case v.VerticalAlign.Top:l=a;break;case v.VerticalAlign.Middle:l=Math.round(i/2-8*o)}switch(r.style.horizontal_align){case v.HorizontalAlign.Right:n=Math.round(s-a-16*o);break;case v.HorizontalAlign.Center:n=Math.round(s/2-8*o)}}if(r&&r.calculated){e.lineWidth=.5,e.fillStyle=e.strokeStyle,e.beginPath(),e.moveTo(n,l),e.lineTo(n+16*o,l),e.lineTo(n+16*o,l+16*o),e.lineTo(n,l+16*o),e.closePath(),e.moveTo(n+15*o,l+4*o);for(const t of[[13.59,2.58],[6,10.17],[2.41,6.59],[1,8],[6,13]])e.lineTo(n+t[0]*o,l+t[1]*o);e.closePath(),e.fill()}else e.lineWidth=Math.max(2,2*o),e.strokeRect(n,l,16*o,16*o);return{handled:!0}},fn:t=>({value:!!t,type:o.boolean})},"Sparkline.Column":{arguments:[{name:"data"},{name:"color"},{name:"negative color"}],render:t=>(Me.RenderColumn(t.width,t.height,t.context,t.cell,t.style),{handled:!0}),fn:(...t)=>({type:o.object,value:t})},"Sparkline.Line":{arguments:[{name:"data"},{name:"color"},{name:"line width"}],render:t=>(Me.RenderLine(t.width,t.height,t.context,t.cell,t.style),{handled:!0}),fn:(...t)=>({type:o.object,value:t})}},De={};for(const t of Object.keys(Te))De[t.toLowerCase()]=t;for(const t of Object.getOwnPropertyNames(Math)){if(De[t.toLowerCase()])continue;const e=Object.getOwnPropertyDescriptor(Math,t);if(!e)continue;const s=e.value,i=typeof s;switch(i){case"number":Te[t]={fn:()=>({type:o.number,value:s}),category:["Math Functions"]};break;case"function":Te[t]={fn:(...t)=>u(s(...t)),category:["Math Functions"]};break;default:console.info("unexpected type:",i,t)}}Math.log10||(Math.log10=t=>Math.log(t)/Math.log(10));const ze=(t,e,s=0,i=0,r=0)=>r?-s*(t/(1-Math.pow(1+t,-e)))/(1+t)-i*(1/((1+t)*((Math.pow(1+t,e)-1)/t))):-(s*t*Math.pow(1+t,e)+i*t)/(Math.pow(1+t,e)-1),Ne=(t,e,s,i=0,r=0)=>r?(1+t)*-s/t*(Math.pow(1+t,e)-1)-i*Math.pow(1+t,e):-s/t*(Math.pow(1+t,e)-1)-i*Math.pow(1+t,e),Pe=(t,e,s,i=0,r=0,o=0)=>{if(e<1)return NaN;if(1===e&&o)return 0;const a=ze(t,s,i,r,o),n=Ne(t,e-1,a,i,o)*t;return o?n/(1+t):n},Fe=(t,e,s,i=0,r=0,o=0)=>ze(t,s,i,r,o)-Pe(t,e,s,i,r,o),Ie={NPV:{description:"Returns the present value of a series of future cashflows",arguments:[{name:"Rate"},{name:"Cashflow"}],fn:(t=0,...e)=>{let s=0;const i=we(e);for(let e=0;e<i.length;e++){const r=i[e];"number"==typeof r&&(s+=Math.pow(1+t,-(e+1))*r)}return{type:o.number,value:s}}},IRR:{description:"Calculates the internal rate of return of a series of cashflows",arguments:[{name:"Cashflows"},{name:"Guess",default:.1}],fn:(t,e=.1)=>{const s=we(t).map((t=>"number"==typeof t?t:0)),i=[{found:!1,value:0},{found:!1,value:0}];for(let t=0;t<50;t++){let t=0;for(let i=0;i<s.length;i++)t+=Math.pow(1+e,-(i+1))*s[i];if(Math.abs(t)<=.00125)return{type:o.number,value:e};if(t>0){if(i[0].value=i[0].found?Math.max(i[0].value,e):e,i[0].found=!0,!i[1].found){e+=.1;continue}}else if(i[1].value=i[1].found?Math.min(i[1].value,e):e,i[1].found=!0,!i[0].found){e-=.1;continue}e=i[0].value+(i[1].value-i[0].value)/2}return{type:o.error,value:"NUM"}}},CUMPRINC:{description:"Returns cumulative principal paid on a loan between two periods",arguments:[{name:"Rate"},{name:"Periods"},{name:"Present Value"},{name:"Start Period"},{name:"End Period"},{name:"Type",default:0}],fn:(t,e,s,i,r,a=0)=>{let n=0;for(let o=i;o<=r;o++)n+=Fe(t,o,e,s,0,a);return{type:o.number,value:n}}},CUMIPMT:{description:"Returns cumulative interest paid on a loan between two periods",arguments:[{name:"Rate"},{name:"Periods"},{name:"Present Value"},{name:"Start Period"},{name:"End Period"},{name:"Type",default:0}],fn:(t,e,s,i,r,a=0)=>{let n=0;for(let o=i;o<=r;o++)n+=Pe(t,o,e,s,0,a);return{type:o.number,value:n}}},IPMT:{description:"Returns the interest portion of a payment",arguments:[{name:"Rate"},{name:"Period"},{name:"Periods"},{name:"Present Value",default:0},{name:"Future Value",default:0},{name:"Type",default:0}],fn:(t,e,s,i=0,r=0,a=0)=>({type:o.number,value:Pe(t,e,s,i,r,a)})},PPMT:{description:"Returns the principal portion of a payment",arguments:[{name:"Rate"},{name:"Period"},{name:"Periods"},{name:"Present Value",default:0},{name:"Future Value",default:0},{name:"Type",default:0}],fn:(t,e,s,i=0,r=0,a=0)=>({type:o.number,value:Fe(t,e,s,i,r,a)})},Rate:{description:"Returns the interest rate of a loan",arguments:[{name:"Periods"},{name:"Payment"},{name:"Present Value",default:0},{name:"Future Value",default:0},{name:"Type",default:0}],fn:(t,e,s=0,i=0,r=0)=>{let a=.25;const n=[-1,1];for(let l=0;l<32;l++){const l=ze(a,t,s,i,r);if(Math.abs(l-e)<=1e-6)return{type:o.number,value:a};const h=ze(n[1],t,s,i,r);e>=l&&e<=h||e>=h&&e<=l?n[0]=a:n[1]=a,a=n[0]+(n[1]-n[0])/2}return{type:o.number,value:a}}},FV:{description:"Returns the future value of an investment",arguments:[{name:"Rate"},{name:"Periods"},{name:"Payment"},{name:"Present Value",default:0},{name:"Type",default:0}],fn:(t,e,s,i=0,r=0)=>({type:o.number,value:Ne(t,e,s,i,r)})},PV:{description:"Returns the present value of an investment",arguments:[{name:"Rate"},{name:"Periods"},{name:"Payment"},{name:"Future Value",default:0},{name:"Type",default:0}],fn:(t,e,s,i=0,r=0)=>r?(s+=i*(1/((1+t)*((Math.pow(1+t,e)-1)/t))),{type:o.number,value:-(s+s/t*(1-Math.pow(1+t,-(e-1))))}):{type:o.number,value:-(i+s/t*(Math.pow(1+t,e)-1))/Math.pow(1+t,e)}},NPER:{description:"Returns the number of periods of an investment",arguments:[{name:"Rate"},{name:"Payment"},{name:"Present Value"},{name:"Future Value",default:0},{name:"Type",default:0}],fn:(t,e,s=0,i=0,r=0)=>r?{type:o.number,value:1+(-Math.log(1+t*(1-s/-e))+Math.log(1+i*t/(-e*(1+t))))/Math.log(1+t)}:{type:o.number,value:(Math.log(Math.pow(1-s*t/-e,-1))+Math.log(1+i*t/-e))/Math.log(1+t)}},PMT:{description:"Returns the periodic payment of a loan",arguments:[{name:"Rate"},{name:"Periods"},{name:"Present Value"},{name:"Future Value",default:0},{name:"Type",default:0}],fn:(t,e,s,i=0,r=0)=>({type:o.number,value:ze(t,e,s,i,r)})}},Ue={Char:{arguments:[{name:"number"}],fn:t=>({type:o.string,value:String.fromCodePoint(t||32)}),category:["text"]},Code:{arguments:[{name:"string"}],fn:t=>({type:o.number,value:t.codePointAt(0)}),category:["text"]},Text:{arguments:[{name:"value"},{name:"number format"}],fn:(t,e="0.00####")=>({type:o.string,value:Q.Get(e).Format(t||0)}),category:["text"]},Left:{arguments:[{name:"string"},{name:"count"}],fn:(t,e=1)=>({type:o.string,value:t.substr(0,e)}),category:["text"]},Right:{arguments:[{name:"string"},{name:"count"}],fn:(t,e=1)=>({type:o.string,value:t.slice(-e)}),category:["text"]},Mid:{arguments:[{name:"string"},{name:"left"},{name:"count"}],fn:(t,e=0,s=1)=>({type:o.string,value:t.substr(Math.max(0,e-1),s)}),category:["text"]},Search:{description:"Find a string (needle) in another string (haystack). Case-insensitive.",arguments:[{name:"Needle"},{name:"Haystack"},{name:"Start",default:1}],fn:(t,e,s=1)=>{if(s>=1){if(!t)return{type:o.number,value:s};const i=(t=>{const e=[],s=t.length,i="[\\^$.|?*+()";for(let r=0;r<s;r++){let s=t[r];switch(s){case"*":e.push(".","*");break;case"?":e.push(".");break;case"~":s=t[++r]||"";default:for(let t=0;t<i.length;t++)if(s===i[t]){e.push("\\");break}e.push(s)}}return e.join("")})(t),r=new RegExp(i,"i").exec(e.substr(s-1));if(r)return{type:o.number,value:r.index+s}}return Yt()}},Find:{description:"Find a string (needle) in another string (haystack). Case-sensitive.",arguments:[{name:"Needle"},{name:"Haystack"},{name:"Start",default:1}],fn:(t,e,s=1)=>{if(s>=1){if(!t)return{type:o.number,value:s};const i=new RegExp(t).exec(e.substr(s-1));if(i)return{type:o.number,value:i.index+s}}return Yt()}},Concat:{description:"Pastes strings together",fn:(...t)=>{const e=we(t).map((t=>{var e;const s=(null===(e=t)||void 0===e?void 0:e.toString())||"";return"number"==typeof t&&","===g.decimal_separator?s.replace(/\./,","):s})).join("");return{type:o.string,value:e}}}},Oe={Concatenate:"Concat"},$e={IsBlank:{description:"Returns true if the reference is blank",arguments:[{name:"Reference",metadata:!0}],fn:Ce((t=>({type:o.boolean,value:!(null==t?void 0:t.value)||void 0===t.value.value})))},IsNumber:{description:"Returns true if the reference is a number",arguments:[{name:"Reference",metadata:!0}],fn:Ce((t=>({type:o.boolean,value:(null==t?void 0:t.value)&&"number"==typeof t.value.value})))},IsLogical:{description:"Returns true if the reference is a logical TRUE or FALSE",arguments:[{name:"Reference",metadata:!0}],fn:Ce((t=>({type:o.boolean,value:(null==t?void 0:t.value)&&"boolean"==typeof t.value.value})))},IsText:{description:"Returns true if the reference is text",arguments:[{name:"Reference",metadata:!0}],fn:Ce((t=>({type:o.boolean,value:(null==t?void 0:t.value)&&"string"==typeof t.value.value})))}},He=(t,e=!1)=>{const s=t.length;let i=0,r=0;for(let e=0;e<s;e++)i+=t[e];i/=s;for(let e=0;e<s;e++){const s=t[e]-i;r+=s*s}return e?r/(s-1):r/s},Ve={StDev:{description:"Returns the standard deviation of a set of values, corresponding to a population",arguments:[{name:"data"}],fn:(...t)=>({type:o.number,value:Math.sqrt(He(we(t),!1))})},"StDev.S":{description:"Returns the standard deviation of a set of values, corresponding to a sample of a population",arguments:[{name:"data"}],fn:(...t)=>({type:o.number,value:Math.sqrt(He(we(t),!0))})},Var:{description:"Returns the variance of a set of values, corresponding to a population",arguments:[{name:"data"}],fn:(...t)=>({type:o.number,value:He(we(t),!1)})},"Var.S":{description:"Returns the variance of a set of values, corresponding to a sample of a population",arguments:[{name:"data"}],fn:(...t)=>({type:o.number,value:He(we(t),!0)})},Correl:{description:"Returns the correlation between two ranges of values",arguments:[{name:"A"},{name:"B"}],fn:(t,e)=>{if(!Array.isArray(t)||!Array.isArray(e))return Yt();if(!Array.isArray(t[0])||!Array.isArray(e[0]))return Yt();let s=0,i=0,r=0,a=0,n=0,l=0,h=0;for(let s=0;s<t.length;s++){if(!t[s]||!e[s])continue;const o=t[s].length;for(let c=0;c<o;c++){const o=Number(t[s][c]),d=Number(e[s][c]);isNaN(o)||isNaN(d)||(i+=o*d,r+=o,a+=d,n+=o*o,l+=d*d,h++)}}return s=h*i-r*a,s&&(s/=Math.sqrt((h*n-r*r)*(h*l-a*a))),{type:o.number,value:s}}},GeoMean:{fn:(...t)=>{t=we(t);let e=0,s=1;for(const i of t){if(void 0===i)continue;const t=Number(i);if(t<0)return Yt();e++,s*=t}return{type:o.number,value:Math.pow(s,1/e)}}},Average:{fn:(...t)=>{const e=(t=we(t)).reduce(((t,e)=>void 0===e?t:t+Number(e)),0)/t.length;return{type:o.number,value:e}}},Percentile:{description:"Returns the kth percentile value from the range of data",arguments:[{name:"range"},{name:"percentile"}],fn:(t,e)=>{const s=we(t).filter((t=>"number"==typeof t));s.sort(((t,e)=>t-e));const i=s.length,r=Math.pow(10,8),a=Math.round((1+(i-1)*e)*r)/r,n=Math.floor(a),l=Math.ceil(a);return{type:o.number,value:(s[n-1]+s[l-1])/2}}},Median:{description:"Returns the median value of the range of data",arguments:[{name:"range"}],fn:(...t)=>{const e=we(t).filter((t=>"number"==typeof t));e.sort(((t,e)=>t-e));const s=1+.5*(e.length-1),i=Math.floor(s),r=Math.ceil(s);return{type:o.number,value:(e[i-1]+e[r-1])/2}}}},je={Mean:"Average","StDev.P":"StDev","Var.P":"Var"};class Ge extends Bt{constructor(){super(...arguments),this.state_id=0,this.type=Ge.type,this.state_representation=""}UpdateState(){const t=JSON.stringify(this.edges_in.map((t=>t.result)));t!==this.state_representation&&(this.state_representation=t,this.state_id++)}Calculate(t){if(this.dirty){for(const t of this.edges_in)if(t.dirty)return;this.UpdateState(),this.dirty=!1}}AddDependent(t){throw new Error("leaf vertex cannot have dependents")}}Ge.type="leaf-vertex";class Be extends class{constructor(){this.vertices=[[]],this.volatile_list=[],this.calculation_list=[],this.cells_map={},this.leaf_vertices=[],this.dirty_list=[],this.loop_check_required=!1}IsSpreadsheetVertex(t){return t.type===Bt.type}AttachData(t){this.model=t,this.cells_map={};for(const e of t.sheets)this.cells_map[e.id]=e.cells}FlushTree(){this.dirty_list=[],this.volatile_list=[],this.vertices=[[]],this.leaf_vertices=[],this.cells_map={},Zt.Clear()}ResolveArrayHead(t){if(!t.sheet_id)throw new Error("resolve array head with no sheet id");const e=this.cells_map[t.sheet_id];if(!e)throw new Error("no cells? sheet id "+t.sheet_id);const s=e.data[t.row];if(s){const e=s[t.column];if(e&&e.area){const s={row:e.area.start.row,column:e.area.start.column,sheet_id:t.sheet_id};return console.info("array head",t,s),s}}return t}GetVertex(t,e){if(!t.sheet_id)throw new Error("getvertex with no sheet id");const s=this.cells_map[t.sheet_id];if(!s)throw new Error("no cells? sheet id "+t.sheet_id);if(!this.vertices[t.sheet_id]){if(!e)return;this.vertices[t.sheet_id]=[]}if(this.vertices[t.sheet_id][t.column]){const s=this.vertices[t.sheet_id][t.column][t.row];if(s)return s;if(!e)return}else{if(!e)return;this.vertices[t.sheet_id][t.column]=[]}const i=new Bt;return i.address={row:t.row,column:t.column,absolute_row:t.absolute_row,absolute_column:t.absolute_column,sheet_id:t.sheet_id},i.reference=s.EnsureCell(t),this.vertices[t.sheet_id][t.column][t.row]=i,Zt.CreateImplicitEdges(i,t),i}RemoveVertex(t){if(!t.sheet_id)throw new Error("removevertex with no sheet id");const e=this.GetVertex(t,!1);e&&(e.Reset(),this.vertices[t.sheet_id][t.column][t.row]=void 0)}ResetVertex(t){const e=this.GetVertex(t,!1);e&&e.Reset()}ResetInbound(t,e=!1,s=!0,i=!1){const r=this.GetVertex(t,s);if(r)r.ClearDependencies(),e&&this.SetVertexDirty(r),i&&this.RemoveVertex(t);else if(e){const e=Zt.GetContainingArrays(t);for(const t of e)this.SetVertexDirty(t)}}ResetLoopState(){for(const t of this.vertices)if(t)for(const e of t)if(e)for(const t of e)t&&(t.color=Pt.white);for(const t of this.leaf_vertices)t.edges_in.length&&(t.color=Pt.white)}LoopCheck(){if(!this.loop_check_required)return!1;const t=[];for(const e of this.vertices)if(e)for(const s of e)if(s)for(const e of s)e&&(e.color=Pt.white,t.push(e));const e=t=>{t.color=Pt.gray;for(const s of t.edges_out){if(s.color===Pt.gray)return this.loop_hint=this.RenderAddress(t.address),console.info("loop detected @",this.loop_hint),!0;if(s.color===Pt.white&&e(s))return!0}return t.color=Pt.black,!1};for(const s of t)if(s.color===Pt.white&&e(s))return!0;return this.loop_check_required=!1,this.loop_hint=void 0,!1}RenderAddress(t){if(!t)return"undefined";let e="";if(t.sheet_id&&this.model)for(const s of this.model.sheets)if(t.sheet_id===s.id){e=s.name+"!";break}return e+new r(t).spreadsheet_label}AddArrayEdge(t,e){if(!t.start.sheet_id)throw new Error("AddArrayEdge called without sheet ID");const s=this.GetVertex(e,!0),[i,r]=Zt.GetVertex(t);if(s.DependsOn(i),this.loop_check_required=!0,!r)return;const o=this.vertices[t.start.sheet_id];if(o)if(t.entire_row){for(let e=0;e<o.length;e++)if(o[e])for(let s=t.start.row;s<=t.end.row;s++){const t=o[e][s];t&&i.DependsOn(t)}console.groupEnd()}else if(t.entire_column){for(let e=t.start.column;e<=t.end.column;e++)if(o[e])for(const t of o[e])(null==t?void 0:t.address)&&i.DependsOn(t);console.groupEnd()}else for(let e=t.start.row;e<=t.end.row;e++)for(let s=t.start.column;s<=t.end.column;s++){const t=o[s][e];t&&i.DependsOn(t)}}AddEdge(t,e){const s=this.GetVertex(t,!0);this.GetVertex(e,!0).DependsOn(s),s.reference&&s.reference.area&&!s.array_head&&this.AddEdge(Object.assign(Object.assign({},t),{row:s.reference.area.start.row,column:s.reference.area.start.column}),e),this.loop_check_required=!0}RemoveEdge(t,e){const s=this.GetVertex(t,!1),i=this.GetVertex(e,!1);s&&i&&(s.RemoveDependent(i),i.RemoveDependency(s))}SetAreaDirty(t){if(t.start.column===1/0||t.end.column===1/0||t.start.row===1/0||t.end.row===1/0)throw new Error("don't iterate over infinite area");const e=t.start.sheet_id;if(!e)throw new Error("invalid area, missing sheet id");for(let s=t.start.column;s<=t.end.column;s++)for(let i=t.start.row;i<=t.end.row;i++){const t={row:i,column:s,sheet_id:e};this.GetVertex(t,!1)&&this.SetDirty(t)}}SetVertexDirty(t){if(!t.dirty){this.dirty_list.push(t),t.dirty=!0;for(const e of t.edges_out)this.SetVertexDirty(e)}}SetDirty(t){const e=this.GetVertex(t,!0);this.SetVertexDirty(e)}AddLeafVertex(t){for(const e of this.leaf_vertices)if(e===t)return;this.leaf_vertices.push(t)}RemoveLeafVertex(t){this.leaf_vertices=this.leaf_vertices.filter((e=>e!==t))}AddLeafVertexEdge(t,e){const s=this.GetVertex(t,!0);return e.DependsOn(s),It.OK}RemoveLeafVertexEdge(t,e){const s=this.GetVertex(t,!1);s&&(s.RemoveDependent(e),e.RemoveDependency(s))}InitializeGraph(){for(const t of this.dirty_list)this.IsSpreadsheetVertex(t)&&(t.TakeReferenceValue(),this.CheckVolatile(t)&&this.volatile_list.push(t)),t.dirty=!1;this.dirty_list=[]}Recalculate(){for(const t of this.volatile_list)this.SetVertexDirty(t);this.calculation_list=this.dirty_list.slice(0),this.volatile_list=[],this.dirty_list=[],this.loop_check_required&&(this.ResetLoopState(),this.loop_check_required=!1);for(let t=0;t<this.calculation_list.length;t++)this.calculation_list[t].Calculate(this);this.calculation_list=[]}}{constructor(){super(),this.library=new Se,this.parser=new N,this.expression_calculator=new ve(this.library,this.parser),this.full_rebuild_required=!1,this.UpdateLocale(),this.library.Register(Te,Ue,Ve,Ie,$e);for(const t of Object.keys(je))this.library.Alias(t,je[t]);for(const t of Object.keys(Oe))this.library.Alias(t,Oe[t]);this.library.Register({CountIf:{arguments:[{name:"range"},{name:"criteria"}],fn:(t,e)=>{const s=we(t);"string"!=typeof e?e="="+(e||0).toString():(e=e.trim(),/^[=<>]/.test(e)||(e="="+e));const i=this.parser.Parse("{}"+e),r=i.expression;if(i.error||!r)return qt();if("binary"!==r.type)return qt();if("array"!==r.left.type)return qt();r.left.values=[s];const a=this.CalculateExpression(r);if(Array.isArray(a)){let t=0;for(const e of a)for(const s of e)s.value&&t++;return{type:o.number,value:t}}return a}},Offset:{arguments:[{name:"reference",description:"Base reference",metadata:!0},{name:"rows",description:"number of rows to offset"},{name:"columns",description:"number of columns to offset"}],return_type:se.reference,volatile:!0,fn:((t,e=0,s=0,i=1,r=1)=>{if(!t)return Xt();if(!ye(t))return Qt();const a=this.DynamicDependencies(t.value.address,this.expression_calculator.context.address,!0,e,s,i,r);if(!a)return Qt();if(a.dirty)return this.GetVertex(this.expression_calculator.context.address,!0).short_circuit=!0,{type:o.undefined,value:void 0};if(a.area){const t=Object.assign(Object.assign({type:"address"},a.area.start),{label:"",position:0,id:0}),e=Object.assign(Object.assign({type:"address"},a.area.end),{label:"",position:0,id:0}),s=1===a.area.count?t:{type:"range",start:t,end:e,label:"",position:0,id:0};return{type:o.object,value:s}}return Yt()}).bind(this)},Indirect:{arguments:[{name:"reference",description:"Cell reference (string)"}],return_type:se.reference,volatile:!0,fn:(t=>{if(!t||"string"!=typeof t)return Xt();const e=this.parser.Parse(t);if(e.error||!e.expression||"address"!==e.expression.type&&"range"!==e.expression.type)return Qt();const s=this.DynamicDependencies(e.expression,this.expression_calculator.context.address);return s?s.dirty?(this.GetVertex(this.expression_calculator.context.address,!0).short_circuit=!0,{type:o.undefined,value:void 0}):{type:o.object,value:e.expression}:Qt()}).bind(this)},Rows:{arguments:[{name:"reference",description:"Array or reference"}],volatile:!1,fn:t=>{if(!t)return Xt();if(Array.isArray(t)){const e=t[0];return Array.isArray(e)?{type:o.number,value:e.length}:Yt()}return{type:o.number,value:1}}},Columns:{arguments:[{name:"reference",description:"Array or reference"}],volatile:!1,fn:t=>t?Array.isArray(t)?{type:o.number,value:t.length}:{type:o.number,value:1}:Xt()},IsFormula:{description:"Returns true if the reference is a formula",arguments:[{name:"Reference",metadata:!0}],fn:Ce((t=>{var e,s;if(null===(e=null==t?void 0:t.value)||void 0===e?void 0:e.address)for(const e of(null===(s=this.model)||void 0===s?void 0:s.sheets)||[])if(e.id===t.value.address.sheet_id){const s=e.cells.GetCell(t.value.address,!1);return{type:o.boolean,value:(null==s?void 0:s.type)===o.formula}}return{type:o.boolean,value:!1}}))}})}SpreadCallback(t,e){if(!t.address||!t.address.sheet_id)throw new Error("spread callback called without sheet id");const s=this.cells_map[t.address.sheet_id];if(!s)throw new Error("spread callback called without cells");if(!t||!t.reference)return;const i=t.reference.area;if(i){const t=i.rows,r=i.columns;if(Array.isArray(e)){e=be(e);for(let a=0;a<t;a++)if(e[a]){let t=0;for(;t<r&&t<e[a].length;t++)s.data[a+i.start.row][t+i.start.column].SetCalculatedValue(e[a][t].value,e[a][t].type);for(;t<r;t++)s.data[a+i.start.row][t+i.start.column].SetCalculatedValue(void 0,o.undefined)}else for(let t=0;t<r;t++)s.data[a+i.start.row][t+i.start.column].SetCalculatedValue(void 0,o.undefined)}else for(let o=0;o<t;o++)for(let t=0;t<r;t++)s.data[o+i.start.row][t+i.start.column].SetCalculatedValue(e.value,e.type)}}CalculationCallback(t){if(!t.address)throw new Error("vertex missing address");return t.expression_error?{value:ee()}:this.expression_calculator.Calculate(t.expression,t.address)}DynamicDependencies(t,e,s=!1,i=0,o=0,a=1,n=1){if(!this.model)return;let l=this.ResolveExpressionAddress(t,e);if(!l)return;let h=!1;l=this.model.active_sheet.RealArea(l);const c=l.start.sheet_id;s&&(l=new r({column:l.start.column+o,row:l.start.row+i,sheet_id:l.start.sheet_id},{column:l.start.column+o+a-1,row:l.start.row+i+n-1,sheet_id:l.end.sheet_id}));for(let t=l.start.row;t<=l.end.row;t++)for(let e=l.start.column;e<=l.end.column;e++){const s=this.GetVertex({row:t,column:e,sheet_id:c},!1);s&&s.dirty&&(this.AddEdge({row:t,column:e,sheet_id:c},this.expression_calculator.context.address),h=!0)}return{dirty:h,area:l}}UpdateLocale(){","===g.decimal_separator?(this.parser.decimal_mark=k.Comma,this.parser.argument_separator=M.Semicolon):(this.parser.decimal_mark=k.Period,this.parser.argument_separator=M.Comma)}GetFunction(t){return this.library.Get(t)}SupportedFunctions(){const t=this.library.List(),e=Object.keys(t).map((e=>{let s=t[e].canonical_name;return s||(s=e.replace(/_/g,".")),{name:s,description:t[e].description,arguments:(t[e].arguments||[]).map((t=>({name:t.name||""})))}}));if(this.model)for(const t of Object.keys(this.model.macro_functions)){const s=this.model.macro_functions[t];e.push({name:s.name,description:s.description,arguments:(s.argument_names||[]).map((t=>({name:t})))})}return e}RegisterFunction(t){for(const e of Object.keys(t)){const s=t[e],i=s.fn;s.fn=(...t)=>i.apply({address:Object.assign({},this.expression_calculator.context.address)},t),this.library.Register({[e]:s})}}AttachModel(t){this.AttachData(t),this.expression_calculator.SetModel(t)}Calculate(t,e){if(this.AttachModel(t),e&&!e.start.sheet_id)throw new Error("CalculateInternal called with subset w/out sheet ID");this.full_rebuild_required&&(e=void 0,this.UpdateAnnotations(),this.full_rebuild_required=!1),this.RebuildGraph(e);try{this.Recalculate()}catch(t){console.error(t),console.info("calculation error trapped")}}Reset(){this.FlushTree(),this.model&&this.AttachModel(this.model),this.full_rebuild_required=!0}CalculateExpression(t,e={row:-1,column:-1},s=!1){return this.expression_calculator.Calculate(t,e,s).value}RebuildClean(t,e=!1){this.full_rebuild_required=!1,this.AttachModel(t),this.RebuildGraph(),this.UpdateAnnotations(),this.InitializeGraph(),e&&this.volatile_list.length&&this.Recalculate()}FlattenCellList(t){const e={},s=[];for(const i of t){const t={column:i.column,row:i.row,sheet_id:i.sheet_id},o=r.CellAddressToLabel(t,!0);e[o]||(e[o]=o,s.push(t))}return s}MetadataReferences(t){const e=[];if(!this.model)return e;const s=this.parser.Parse(t);if(s.expression&&"call"===s.expression.type){const t=this.GetFunction(s.expression.name);if(!t||!t.arguments)return e;for(let i=0;i<t.arguments.length;i++){const r=t.arguments[i];if(!r||!r.metadata)continue;const o=s.expression.args[i];if(!o)continue;const a=this.ResolveExpressionAddress(o);a&&e.push(a.start)}}return e}RemoveAnnotation(t){const e=t.temp.vertex;e&&(e.Reset(),this.RemoveLeafVertex(e))}UpdateAnnotations(t){if(!t&&this.model&&(t=this.model.active_sheet.annotations),t){void 0===t||Array.isArray(t)||(t=[t]);for(const e of t)if(e.formula){e.temp.vertex||(e.temp.vertex=new Ge);const t=e.temp.vertex;this.AddLeafVertex(t),this.UpdateLeafVertex(t,e.formula)}}}ResolveSheetID(t,e){if(!this.model)throw new Error("ResolveSheetID called without model");const s="address"===t.type?t:t.start;if(s.sheet_id)return!0;if(!s.sheet)return s.sheet_id=(null==e?void 0:e.sheet_id)||this.model.active_sheet.id,!0;{const t=s.sheet.toLowerCase();for(const e of this.model.sheets)if(e.name.toLowerCase()===t)return s.sheet_id=e.id,!0}return!1}ResolveExpressionAddress(t,e){switch(t.type){case"address":if(this.ResolveSheetID(t,e))return new r(t);break;case"range":if(this.ResolveSheetID(t,e))return new r(t.start,t.end);break;case"identifier":if(this.model){const e=this.model.named_ranges.Get(t.name.toUpperCase());if(e)return new r(e.start,e.end)}}}NamedRangeToAddressUnit(t){if(!this.model)return;const e=t.name.toUpperCase(),s=this.model.named_ranges.Get(e);return s?1===s.count?this.ConstructAddressUnit(s.start,e,t.id,t.position):{type:"range",start:this.ConstructAddressUnit(s.start,e,t.id,t.position),end:this.ConstructAddressUnit(s.end,e,t.id,t.position),label:e,id:t.id,position:t.position}:void 0}ConstructAddressUnit(t,e,s,i){return{type:"address",row:t.row,column:t.column,sheet_id:t.sheet_id,label:e,id:s,position:i}}RebuildDependencies(t,e,s,i={addresses:{},ranges:{}},r){if(!r&&(r={},this.model)){for(const t of this.model.sheets)r[t.name.toLowerCase()]=t.id;if(!s)for(const t of this.model.sheets)if(t.id===e){s=t.name;break}}switch(t.type){case"literal":case"missing":case"operator":break;case"identifier":{const e=this.NamedRangeToAddressUnit(t);e&&("address"===e.type?i.addresses[e.label]=e:i.ranges[e.label]=e)}break;case"address":t.sheet_id||(t.sheet_id=t.sheet?r[t.sheet.toLowerCase()]||0:e,t.sheet||(t.sheet=s)),i.addresses[t.sheet_id+"!"+t.label]=t;break;case"range":t.start.sheet_id||(t.start.sheet_id=t.start.sheet?r[t.start.sheet.toLowerCase()]||0:e,t.start.sheet||(t.start.sheet=s)),i.ranges[t.start.sheet_id+"!"+t.start.label+":"+t.end.label]=t;break;case"unary":this.RebuildDependencies(t.operand,e,s,i,r);break;case"binary":this.RebuildDependencies(t.left,e,s,i,r),this.RebuildDependencies(t.right,e,s,i,r);break;case"group":t.elements.forEach((t=>this.RebuildDependencies(t,e,s,i,r)));break;case"call":{const o=t.args.slice(0),a=this.library.Get(t.name);a&&a.arguments&&a.arguments.forEach(((t,i)=>{t&&t.address&&(this.RebuildDependencies(o[i],e,s,void 0,r),o[i]={type:"missing",id:-1})})),o.forEach((t=>this.RebuildDependencies(t,e,s,i,r)))}}return i}UpdateLeafVertex(t,e){if(!this.model)throw new Error("UpdateLeafVertex called without model");t.Reset();const s=this.parser.Parse(e);if(s.expression){const e=this.RebuildDependencies(s.expression,this.model.active_sheet.id,this.model.active_sheet.name);for(const s of Object.keys(e.ranges)){const i=e.ranges[s];new r(i.start,i.end).Iterate((e=>{this.AddLeafVertexEdge(e,t)}))}for(const s of Object.keys(e.addresses)){const i=e.addresses[s];this.AddLeafVertexEdge(i,t)}}t.expression=s.expression||{type:"missing",id:-1},t.expression_error=!s.valid}ApplyMacroFunctionInternal(t,e,s){switch(t.type){case"identifier":if(s[0]){const e=s[0][(t.name||"").toUpperCase()];if(e)return JSON.parse(JSON.stringify(e))}break;case"binary":t.left=this.ApplyMacroFunctionInternal(t.left,e,s),t.right=this.ApplyMacroFunctionInternal(t.right,e,s);break;case"unary":t.operand=this.ApplyMacroFunctionInternal(t.operand,e,s);break;case"group":t.elements=t.elements.map((t=>this.ApplyMacroFunctionInternal(t,e,s)));break;case"call":if(t.args=t.args.map((t=>this.ApplyMacroFunctionInternal(t,e,s))),!this.library.Get(t.name)){const i=e.macro_functions[t.name.toUpperCase()];if(i&&i.expression){const r=JSON.parse(JSON.stringify(i.expression)),o={};if(i.argument_names)for(let e=0;e<i.argument_names.length;e++)o[i.argument_names[e].toUpperCase()]=t.args[e]?t.args[e]:{type:"missing"};s.unshift(o);const a=this.ApplyMacroFunctionInternal(r,e,s);return s.shift(),a}}}return t}ApplyMacroFunctions(t){if(this.model)return Object.keys(this.model.macro_functions).length?this.ApplyMacroFunctionInternal(t,this.model,[]):void 0}RebuildGraphCell(t,e){if(t.area&&t.area.start.column===e.column&&t.area.start.row===e.row){const{start:s,end:i}=t.area,r=s.sheet_id||e.sheet_id;s.sheet_id||(s.sheet_id=r);for(let t=s.column;t<=i.column;t++)for(let e=s.row;e<=i.row;e++)this.ResetInbound({column:t,row:e,sheet_id:r},!0,!1);this.SetDirty(e);for(let t=s.column;t<=i.column;t++)for(let e=s.row;e<=i.row;e++)e===s.row&&t===s.column||this.AddEdge(s,Object.assign(Object.assign({},s),{row:e,column:t}))}if(t.type===o.formula){this.ResetInbound(e,!0);const s=this.parser.Parse(t.value);if(s.expression){if("call"===s.expression.type){const e=this.library.Get(s.expression.name);e&&(e.render||e.click)&&(t.render_function=e.render,t.click_function=e.click)}const i=this.RebuildDependencies(s.expression,e.sheet_id,"");for(const t of Object.keys(i.ranges)){const s=i.ranges[t],o=new r(s.start,s.end);o.entire_row||o.entire_column?this.AddArrayEdge(o,e):o.Iterate((t=>this.AddEdge(t,e)))}for(const t of Object.keys(i.addresses)){const s=i.addresses[t];this.AddEdge(s,e)}}const i=this.GetVertex(e,!0);i&&(i.expression=s.expression||{type:"missing",id:-1},i.expression_error=!s.valid)}else t.value!==t.calculated?this.ResetInbound(e,!0,!1):t.type===o.undefined?this.ResetInbound(e,!0,!1,!0):console.warn("UNHANDLED CASE",t)}RebuildGraph(t){var e;if(t){if(!t.start.sheet_id)throw new Error("subset missing sheet id");const e=this.cells_map[t.start.sheet_id];for(let s=t.start.row;s<=t.end.row;s++){const i=e.data[s];if(i)for(let e=t.start.column;e<=t.end.column;e++){const r=i[e];r&&this.RebuildGraphCell(r,{row:s,column:e,sheet_id:t.start.sheet_id})}}}else for(const t of(null===(e=this.model)||void 0===e?void 0:e.sheets)||[]){const e=t.cells.data.length;for(let s=0;s<e;s++){const e=t.cells.data[s];if(e){const i=e.length;for(let r=0;r<i;r++){const i=e[r];i&&this.RebuildGraphCell(i,{row:s,column:r,sheet_id:t.id})}}}}}IsNativeOrTypedArray(t){return Array.isArray(t)||t instanceof Float64Array||t instanceof Float32Array}CheckVolatile(t){if(!t.expression||t.expression_error)return!1;let e=!1;return this.parser.Walk(t.expression,(t=>{if("call"===t.type){const s=this.library.Get(t.name);s&&s.volatile&&(e=!0)}return!e})),e}}var Ze;!function(t){t.default="",t.info="info",t.error="error",t.warning="warning",t.success="success",t.about="about",t.initial="initial"}(Ze||(Ze={}));class Je{constructor(t){this.parent_node=t,this.visible_=!1,this.pending_dialog_resoltion=[],this.options_={type:Ze.initial},this.event_handler=t=>{"Escape"!==t.key&&"Esc"!==t.key||(t.stopPropagation(),t.preventDefault(),this.visible=!1)},this.model=Z`<div id='mask' class='treb-embed-mask'><div id='dialog' class='treb-embed-dialog'><div id='left'><a href='https://treb.app' target='_blank'><svg width=48 height=48 viewBox='0 0 64 64'><path fill="#8CC63F" d="M37.913,14.323c-2.042,0-7.067,2.558-8.72,3.481c-0.959-1.012-1.065-2.522-1.243-4.475 c-0.959,0.994-0.337,4.014,0,5.115c-4.19,3.125-7.707,6.357-11.295,10.016c-1.225-1.936-2.06-3.517-2.344-7.033 c-1.243,2.664,0.355,6.163,1.278,8.098c-3.96,4.99-7.885,10.354-11.064,15.486C-10.001,14.323,34.344-3.916,63.327,8.641 c-17.955,11.952-22.59,49.672-54.13,39.639c-2.22,3.197-3.712,7.37-5.541,11.082c-1.527,0.107-2.593-0.675-2.983-1.278    c3.072-7.441,7.033-13.995,11.082-20.459c4.387,0.125,8.737,0.195,12.36-0.426c-3.144-0.834-6.908-0.319-10.655-1.278    c2.291-4.387,5.63-7.726,8.95-11.082c3.605,0.32,7.264,1.314,11.082,0.426c-3.32-0.586-6.535-0.799-9.377-1.705 C27.223,20.131,33.438,16.401,37.913,14.323z"/></svg></a></div><div id='middle'><div id='title' class='treb-embed-dialog-title'></div><div id='message' class='treb-embed-dialog-message'></div><div id='about' class='treb-embed-dialog-body'>TREB version ${"10.12.12"}<div class='smaller'><a target=_blank href='https://treb.app'>http://treb.app</a></div></div></div><div id='close' class='close-box'><svg viewBox='0 0 16 16'><path d='M11.854 4.146a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708-.708l7-7a.5.5 0 0 1 .708 0z'/><path d='M4.146 4.146a.5.5 0 0 0 0 .708l7 7a.5.5 0 0 0 .708-.708l-7-7a.5.5 0 0 0-.708 0z'/></svg></div></div></div>`,this.model.close.addEventListener("click",(t=>{t.stopPropagation(),t.preventDefault(),this.HideDialog()})),t.appendChild(this.model.mask)}set options(t){if(t.type===Ze.about&&(t.close_box=!0,t.icon=!0),this.options_.icon!==t.icon&&(this.model.left.style.display=t.icon?"block":"none"),this.options_.close_box!==t.close_box&&(this.model.close.style.display=t.close_box?"block":"none"),this.options_.message!==t.message&&(this.model.message.textContent=t.message||"",this.model.message.style.display=t.message?"block":"none"),this.options_.title!==t.title&&(this.model.title.textContent=t.title||"",this.model.title.style.display=t.title?"block":"none"),this.options_.type!==t.type){let e=this.model.dialog.className.replace(/dialog-type-\S+/g,"").trim();t.type&&(e+=` dialog-type-${t.type}`),this.model.dialog.className=e,"about"===t.type?this.model.about.style.display="block":this.model.about.style.display="none"}this.options_=t}set visible(t){var e,s;if(t!==this.visible_)if(this.visible_=t,t)null===(e=this.parent_node.firstChild)||void 0===e||e.classList.add("masked"),this.model.mask.classList.add("visible"),window.addEventListener("keydown",this.event_handler);else{null===(s=this.parent_node.firstChild)||void 0===s||s.classList.remove("masked"),this.model.mask.classList.remove("visible"),window.removeEventListener("keydown",this.event_handler);const t=this.pending_dialog_resoltion.slice(0);this.pending_dialog_resoltion=[],Promise.resolve().then((()=>{for(const e of t)e()}))}}get visible(){return this.visible_}Div(t,e){const s=document.createElement("div");return t&&s.setAttribute("class",t),e&&e.appendChild(s),s}Update(t,e=!0){e&&(t=Object.assign(Object.assign({},this.options_),t)),this.options=t}HideDialog(){this.visible=!1}ShowDialog(t){return new Promise((e=>{this.pending_dialog_resoltion.push(e),this.options=t,this.visible=!0,this.timeout&&(clearTimeout(this.timeout),this.timeout=0),t.timeout&&(this.timeout=setTimeout((()=>this.HideDialog()),t.timeout))}))}}const qe={delimiter:","},We={formula_bar:!0,in_cell_editor:!0,undo:!0,scrollbars:!0,dnd:!1,export:!0,fork:!1,popout:!0,tab_bar:"auto",add_tab:!1,max_workers:1,resizable:!0,default_trials:5e3,screen_updates:!1,lhs:!0,hyperlinks:"_blank",max_file_size:94208};var Ke,Xe,Ye;!function(t){t.json="json",t.treb="treb",t.csv="csv",t.tsv="tsv",t.xlsx="xlsx"}(Ke||(Ke={})),function(t){t.DRAG_AND_DROP="drag-and-drop",t.LOCAL_FILE="local-file",t.NETWORK_FILE="network-file",t.LOCAL_STORAGE="local-storage",t.UNDO="undo"}(Xe||(Xe={})),function(t){t.TREB="treb",t.CSV="csv",t.XLSX="xlsx"}(Ye||(Ye={}));const Qe={"fa/light/arrow-down-to-line":{viewbox:"0 0 384 512",paths:[{d:"M181 395C184 398 188 400 192 400S200 398 203 395L347 251C354 245 354 235 347 229S331 222 325 229L208 345V48C208 39 201 32 192 32S176 39 176 48V345L59 229C53 222 43 222 37 229S30 245 37 251L181 395ZM368 448H16C7 448 0 455 0 464S7 480 16 480H368C377 480 384 473 384 464S377 448 368 448Z",classes:["fa-light"]}]},"fa/light/arrow-up-to-line":{viewbox:"0 0 384 512",paths:[{d:"M203 117C200 114 196 112 192 112S184 114 181 117L37 261C30 267 30 277 37 283S53 290 59 283L176 167V464C176 473 183 480 192 480S208 473 208 464V167L325 283C331 290 341 290 347 283S354 267 347 261L203 117ZM368 32H16C7 32 0 39 0 48S7 64 16 64H368C377 64 384 57 384 48S377 32 368 32Z",classes:["fa-light"]}]},"fa/light/arrows-rotate":{viewbox:"0 0 512 512",paths:[{d:"M464 32C455 32 448 39 448 48V177C416 100 341 48 256 48C154 48 68 121 51 221C49 230 55 238 64 240C65 240 66 240 67 240C74 240 81 234 82 227C97 142 170 80 256 80C328 80 393 125 420 192H304C295 192 288 199 288 208S295 224 304 224H464C473 224 480 217 480 208V48C480 39 473 32 464 32ZM448 272C439 271 431 277 430 285C415 370 342 432 256 432C184 432 119 387 92 320H208C217 320 224 313 224 304S217 288 208 288H48C39 288 32 295 32 304V464C32 473 39 480 48 480S64 473 64 464V335C96 412 171 464 256 464C358 464 444 391 461 291C463 282 457 274 448 272Z",classes:["fa-light"]}]},"fa/light/border-all":{viewbox:"0 0 448 512",paths:[{d:"M400 32H48C22 32 0 54 0 80V432C0 458 22 480 48 480H400C426 480 448 458 448 432V80C448 54 426 32 400 32ZM32 80C32 71 39 64 48 64H208V240H32V80ZM48 448C39 448 32 441 32 432V272H208V448H48ZM416 432C416 441 409 448 400 448H240V272H416V432ZM416 240H240V64H400C409 64 416 71 416 80V240Z",classes:["fa-light"]}]},"fa/light/border-bottom":{viewbox:"0 0 448 512",paths:[{d:"M224 88C237 88 248 77 248 64C248 51 237 40 224 40S200 51 200 64C200 77 211 88 224 88ZM224 184C237 184 248 173 248 160C248 147 237 136 224 136S200 147 200 160C200 173 211 184 224 184ZM320 88C333 88 344 77 344 64C344 51 333 40 320 40S296 51 296 64C296 77 307 88 320 88ZM416 376C429 376 440 365 440 352C440 339 429 328 416 328S392 339 392 352C392 365 403 376 416 376ZM320 280C333 280 344 269 344 256C344 243 333 232 320 232S296 243 296 256C296 269 307 280 320 280ZM416 88C429 88 440 77 440 64C440 51 429 40 416 40S392 51 392 64C392 77 403 88 416 88ZM416 280C429 280 440 269 440 256C440 243 429 232 416 232S392 243 392 256C392 269 403 280 416 280ZM416 184C429 184 440 173 440 160C440 147 429 136 416 136S392 147 392 160C392 173 403 184 416 184ZM32 376C45 376 56 365 56 352C56 339 45 328 32 328S8 339 8 352C8 365 19 376 32 376ZM32 88C45 88 56 77 56 64C56 51 45 40 32 40S8 51 8 64C8 77 19 88 32 88ZM32 280C45 280 56 269 56 256C56 243 45 232 32 232S8 243 8 256C8 269 19 280 32 280ZM32 184C45 184 56 173 56 160C56 147 45 136 32 136S8 147 8 160C8 173 19 184 32 184ZM432 448H16C7 448 0 455 0 464S7 480 16 480H432C441 480 448 473 448 464S441 448 432 448ZM128 280C141 280 152 269 152 256C152 243 141 232 128 232S104 243 104 256C104 269 115 280 128 280ZM224 376C237 376 248 365 248 352C248 339 237 328 224 328S200 339 200 352C200 365 211 376 224 376ZM224 280C237 280 248 269 248 256C248 243 237 232 224 232S200 243 200 256C200 269 211 280 224 280ZM128 88C141 88 152 77 152 64C152 51 141 40 128 40S104 51 104 64C104 77 115 88 128 88Z",classes:["fa-light"]}]},"fa/light/border-inner":{viewbox:"0 0 448 512",paths:[{d:"M128 88C141 88 152 77 152 64C152 51 141 40 128 40S104 51 104 64C104 77 115 88 128 88ZM32 88C45 88 56 77 56 64C56 51 45 40 32 40S8 51 8 64C8 77 19 88 32 88ZM32 184C45 184 56 173 56 160C56 147 45 136 32 136S8 147 8 160C8 173 19 184 32 184ZM416 88C429 88 440 77 440 64C440 51 429 40 416 40S392 51 392 64C392 77 403 88 416 88ZM416 184C429 184 440 173 440 160C440 147 429 136 416 136S392 147 392 160C392 173 403 184 416 184ZM320 88C333 88 344 77 344 64C344 51 333 40 320 40S296 51 296 64C296 77 307 88 320 88ZM32 424C19 424 8 435 8 448C8 461 19 472 32 472S56 461 56 448C56 435 45 424 32 424ZM416 328C403 328 392 339 392 352C392 365 403 376 416 376S440 365 440 352C440 339 429 328 416 328ZM416 424C403 424 392 435 392 448C392 461 403 472 416 472S440 461 440 448C440 435 429 424 416 424ZM320 424C307 424 296 435 296 448C296 461 307 472 320 472S344 461 344 448C344 435 333 424 320 424ZM128 424C115 424 104 435 104 448C104 461 115 472 128 472S152 461 152 448C152 435 141 424 128 424ZM32 328C19 328 8 339 8 352C8 365 19 376 32 376S56 365 56 352C56 339 45 328 32 328ZM432 240H240V48C240 39 233 32 224 32S208 39 208 48V240H16C7 240 0 247 0 256S7 272 16 272H208V464C208 473 215 480 224 480S240 473 240 464V272H432C441 272 448 265 448 256S441 240 432 240Z",classes:["fa-light"]}]},"fa/light/border-left":{viewbox:"0 0 448 512",paths:[{d:"M128 40C115 40 104 51 104 64C104 77 115 88 128 88S152 77 152 64C152 51 141 40 128 40ZM224 424C211 424 200 435 200 448C200 461 211 472 224 472S248 461 248 448C248 435 237 424 224 424ZM224 328C211 328 200 339 200 352C200 365 211 376 224 376S248 365 248 352C248 339 237 328 224 328ZM224 232C211 232 200 243 200 256C200 269 211 280 224 280S248 269 248 256C248 243 237 232 224 232ZM416 88C429 88 440 77 440 64C440 51 429 40 416 40S392 51 392 64C392 77 403 88 416 88ZM224 136C211 136 200 147 200 160C200 173 211 184 224 184S248 173 248 160C248 147 237 136 224 136ZM128 232C115 232 104 243 104 256C104 269 115 280 128 280S152 269 152 256C152 243 141 232 128 232ZM128 424C115 424 104 435 104 448C104 461 115 472 128 472S152 461 152 448C152 435 141 424 128 424ZM416 136C403 136 392 147 392 160C392 173 403 184 416 184S440 173 440 160C440 147 429 136 416 136ZM416 424C403 424 392 435 392 448C392 461 403 472 416 472S440 461 440 448C440 435 429 424 416 424ZM416 328C403 328 392 339 392 352C392 365 403 376 416 376S440 365 440 352C440 339 429 328 416 328ZM416 232C403 232 392 243 392 256C392 269 403 280 416 280S440 269 440 256C440 243 429 232 416 232ZM320 232C307 232 296 243 296 256C296 269 307 280 320 280S344 269 344 256C344 243 333 232 320 232ZM320 40C307 40 296 51 296 64C296 77 307 88 320 88S344 77 344 64C344 51 333 40 320 40ZM320 424C307 424 296 435 296 448C296 461 307 472 320 472S344 461 344 448C344 435 333 424 320 424ZM224 40C211 40 200 51 200 64C200 77 211 88 224 88S248 77 248 64C248 51 237 40 224 40ZM16 32C7 32 0 39 0 48V464C0 473 7 480 16 480S32 473 32 464V48C32 39 25 32 16 32Z",classes:["fa-light"]}]},"fa/light/border-none":{viewbox:"0 0 448 512",paths:[{d:"M128 232C115 232 104 243 104 256C104 269 115 280 128 280S152 269 152 256C152 243 141 232 128 232ZM32 40C19 40 8 51 8 64C8 77 19 88 32 88S56 77 56 64C56 51 45 40 32 40ZM128 424C115 424 104 435 104 448C104 461 115 472 128 472S152 461 152 448C152 435 141 424 128 424ZM128 40C115 40 104 51 104 64C104 77 115 88 128 88S152 77 152 64C152 51 141 40 128 40ZM224 328C211 328 200 339 200 352C200 365 211 376 224 376S248 365 248 352C248 339 237 328 224 328ZM416 88C429 88 440 77 440 64C440 51 429 40 416 40S392 51 392 64C392 77 403 88 416 88ZM32 424C19 424 8 435 8 448C8 461 19 472 32 472S56 461 56 448C56 435 45 424 32 424ZM32 328C19 328 8 339 8 352C8 365 19 376 32 376S56 365 56 352C56 339 45 328 32 328ZM32 136C19 136 8 147 8 160C8 173 19 184 32 184S56 173 56 160C56 147 45 136 32 136ZM32 232C19 232 8 243 8 256C8 269 19 280 32 280S56 269 56 256C56 243 45 232 32 232ZM224 424C211 424 200 435 200 448C200 461 211 472 224 472S248 461 248 448C248 435 237 424 224 424ZM416 328C403 328 392 339 392 352C392 365 403 376 416 376S440 365 440 352C440 339 429 328 416 328ZM416 424C403 424 392 435 392 448C392 461 403 472 416 472S440 461 440 448C440 435 429 424 416 424ZM416 232C403 232 392 243 392 256C392 269 403 280 416 280S440 269 440 256C440 243 429 232 416 232ZM320 40C307 40 296 51 296 64C296 77 307 88 320 88S344 77 344 64C344 51 333 40 320 40ZM224 232C211 232 200 243 200 256C200 269 211 280 224 280S248 269 248 256C248 243 237 232 224 232ZM416 136C403 136 392 147 392 160C392 173 403 184 416 184S440 173 440 160C440 147 429 136 416 136ZM224 40C211 40 200 51 200 64C200 77 211 88 224 88S248 77 248 64C248 51 237 40 224 40ZM320 232C307 232 296 243 296 256C296 269 307 280 320 280S344 269 344 256C344 243 333 232 320 232ZM224 136C211 136 200 147 200 160C200 173 211 184 224 184S248 173 248 160C248 147 237 136 224 136ZM320 424C307 424 296 435 296 448C296 461 307 472 320 472S344 461 344 448C344 435 333 424 320 424Z",classes:["fa-light"]}]},"fa/light/border-outer":{viewbox:"0 0 448 512",paths:[{d:"M224 328C211 328 200 339 200 352C200 365 211 376 224 376S248 365 248 352C248 339 237 328 224 328ZM128 232C115 232 104 243 104 256C104 269 115 280 128 280S152 269 152 256C152 243 141 232 128 232ZM224 232C211 232 200 243 200 256C200 269 211 280 224 280S248 269 248 256C248 243 237 232 224 232ZM320 232C307 232 296 243 296 256C296 269 307 280 320 280S344 269 344 256C344 243 333 232 320 232ZM224 136C211 136 200 147 200 160C200 173 211 184 224 184S248 173 248 160C248 147 237 136 224 136ZM400 32H48C22 32 0 54 0 80V432C0 458 22 480 48 480H400C426 480 448 458 448 432V80C448 54 426 32 400 32ZM416 432C416 441 409 448 400 448H48C39 448 32 441 32 432V80C32 71 39 64 48 64H400C409 64 416 71 416 80V432Z",classes:["fa-light"]}]},"fa/light/border-right":{viewbox:"0 0 448 512",paths:[{d:"M120 40C107 40 96 51 96 64C96 77 107 88 120 88S144 77 144 64C144 51 133 40 120 40ZM24 136C11 136 0 147 0 160C0 173 11 184 24 184S48 173 48 160C48 147 37 136 24 136ZM120 424C107 424 96 435 96 448C96 461 107 472 120 472S144 461 144 448C144 435 133 424 120 424ZM120 232C107 232 96 243 96 256C96 269 107 280 120 280S144 269 144 256C144 243 133 232 120 232ZM24 40C11 40 0 51 0 64C0 77 11 88 24 88S48 77 48 64C48 51 37 40 24 40ZM24 424C11 424 0 435 0 448C0 461 11 472 24 472S48 461 48 448C48 435 37 424 24 424ZM24 328C11 328 0 339 0 352C0 365 11 376 24 376S48 365 48 352C48 339 37 328 24 328ZM24 232C11 232 0 243 0 256C0 269 11 280 24 280S48 269 48 256C48 243 37 232 24 232ZM216 328C203 328 192 339 192 352C192 365 203 376 216 376S240 365 240 352C240 339 229 328 216 328ZM216 40C203 40 192 51 192 64C192 77 203 88 216 88S240 77 240 64C240 51 229 40 216 40ZM312 232C299 232 288 243 288 256C288 269 299 280 312 280S336 269 336 256C336 243 325 232 312 232ZM216 424C203 424 192 435 192 448C192 461 203 472 216 472S240 461 240 448C240 435 229 424 216 424ZM312 40C299 40 288 51 288 64C288 77 299 88 312 88S336 77 336 64C336 51 325 40 312 40ZM312 424C299 424 288 435 288 448C288 461 299 472 312 472S336 461 336 448C336 435 325 424 312 424ZM216 232C203 232 192 243 192 256C192 269 203 280 216 280S240 269 240 256C240 243 229 232 216 232ZM216 136C203 136 192 147 192 160C192 173 203 184 216 184S240 173 240 160C240 147 229 136 216 136ZM424 32C415 32 408 39 408 48V464C408 473 415 480 424 480S440 473 440 464V48C440 39 433 32 424 32Z",classes:["fa-light"]}]},"fa/light/border-top":{viewbox:"0 0 448 512",paths:[{d:"M128 424C115 424 104 435 104 448S115 472 128 472C141 472 152 461 152 448S141 424 128 424ZM224 328C211 328 200 339 200 352S211 376 224 376C237 376 248 365 248 352S237 328 224 328ZM32 136C19 136 8 147 8 160S19 184 32 184C45 184 56 173 56 160S45 136 32 136ZM224 424C211 424 200 435 200 448S211 472 224 472C237 472 248 461 248 448S237 424 224 424ZM128 232C115 232 104 243 104 256S115 280 128 280C141 280 152 269 152 256S141 232 128 232ZM432 32H16C7 32 0 39 0 48S7 64 16 64H432C441 64 448 57 448 48S441 32 432 32ZM32 328C19 328 8 339 8 352S19 376 32 376C45 376 56 365 56 352S45 328 32 328ZM32 232C19 232 8 243 8 256S19 280 32 280C45 280 56 269 56 256S45 232 32 232ZM32 424C19 424 8 435 8 448S19 472 32 472C45 472 56 461 56 448S45 424 32 424ZM416 328C403 328 392 339 392 352S403 376 416 376C429 376 440 365 440 352S429 328 416 328ZM416 232C403 232 392 243 392 256S403 280 416 280C429 280 440 269 440 256S429 232 416 232ZM416 424C403 424 392 435 392 448S403 472 416 472C429 472 440 461 440 448S429 424 416 424ZM416 136C403 136 392 147 392 160S403 184 416 184C429 184 440 173 440 160S429 136 416 136ZM320 424C307 424 296 435 296 448S307 472 320 472C333 472 344 461 344 448S333 424 320 424ZM224 136C211 136 200 147 200 160S211 184 224 184C237 184 248 173 248 160S237 136 224 136ZM224 232C211 232 200 243 200 256S211 280 224 280C237 280 248 269 248 256S237 232 224 232ZM320 232C307 232 296 243 296 256S307 280 320 280C333 280 344 269 344 256S333 232 320 232Z",classes:["fa-light"]}]},"fa/light/check":{viewbox:"0 0 512 512",paths:[{d:"M475 123L203 395C200 398 196 400 192 400S184 398 181 395L37 251C30 245 30 235 37 229S53 222 59 229L192 361L453 101C459 94 469 94 475 101S482 117 475 123Z",classes:["fa-light"]}]},"fa/light/compress":{viewbox:"0 0 448 512",paths:[{d:"M144 320H16C7 320 0 327 0 336S7 352 16 352H128V464C128 473 135 480 144 480S160 473 160 464V336C160 327 153 320 144 320ZM304 192H432C441 192 448 185 448 176S441 160 432 160H320V48C320 39 313 32 304 32S288 39 288 48V176C288 185 295 192 304 192ZM432 320H304C295 320 288 327 288 336V464C288 473 295 480 304 480S320 473 320 464V352H432C441 352 448 345 448 336S441 320 432 320ZM144 32C135 32 128 39 128 48V160H16C7 160 0 167 0 176S7 192 16 192H144C153 192 160 185 160 176V48C160 39 153 32 144 32Z",classes:["fa-light"]}]},"fa/light/expand":{viewbox:"0 0 448 512",paths:[{d:"M144 32H16C7 32 0 39 0 48V176C0 185 7 192 16 192S32 185 32 176V64H144C153 64 160 57 160 48S153 32 144 32ZM144 448H32V336C32 327 25 320 16 320S0 327 0 336V464C0 473 7 480 16 480H144C153 480 160 473 160 464S153 448 144 448ZM432 320C423 320 416 327 416 336V448H304C295 448 288 455 288 464S295 480 304 480H432C441 480 448 473 448 464V336C448 327 441 320 432 320ZM432 32H304C295 32 288 39 288 48S295 64 304 64H416V176C416 185 423 192 432 192S448 185 448 176V48C448 39 441 32 432 32Z",classes:["fa-light"]}]},"fa/light/fill-drip":{viewbox:"0 0 576 512",paths:[{d:"M525 340C519 330 505 330 499 340C480 370 448 423 448 448C448 483 477 512 512 512S576 483 576 448C576 423 544 370 525 340ZM512 480C494 480 480 466 480 448C480 438 494 410 512 379C530 410 544 438 544 448C544 466 530 480 512 480ZM503 217L295 9C289 3 281 0 272 0C264 0 256 3 250 9L157 102L63 8C56 2 46 2 40 8C34 14 34 24 40 31L134 125L28 231C-9 268 -9 329 28 367L145 484C164 503 189 512 213 512C238 512 262 503 281 484L503 262C515 250 515 230 503 217ZM258 461C246 473 230 480 213 480C196 480 180 473 168 461L51 344C44 337 39 329 36 320H400L258 461ZM432 288H33C35 275 41 263 51 254L157 148L245 235C251 242 261 242 267 235C273 229 273 219 267 213L179 125L272 32L480 240L432 288Z",classes:["fa-light"]}]},"fa/light/font":{viewbox:"0 0 448 512",paths:[{d:"M432 448H411L239 41C234 29 214 29 209 41L37 448H16C7 448 0 455 0 464S7 480 16 480H96C105 480 112 473 112 464S105 448 96 448H72L113 352H335L376 448H352C343 448 336 455 336 464S343 480 352 480H432C441 480 448 473 448 464S441 448 432 448ZM126 320L224 88L322 320H126Z",classes:["fa-light"]}]},"fa/light/image-landscape":{viewbox:"0 0 576 512",paths:[{d:"M160 184C173 184 184 173 184 160S173 136 160 136C147 136 136 147 136 160S147 184 160 184ZM347 172C335 156 308 156 297 172L253 233L246 224C234 210 209 210 197 224L134 305C127 314 126 326 132 336C137 346 147 352 158 352H418C429 352 439 346 444 337C444 337 444 337 444 337C450 327 449 315 443 306L347 172ZM162 320L220 244L241 270C245 275 258 281 266 269L321 191L413 320H162ZM512 64H64C29 64 0 93 0 128V384C0 419 29 448 64 448H512C547 448 576 419 576 384V128C576 93 547 64 512 64ZM544 384C544 402 530 416 512 416H64C46 416 32 402 32 384V128C32 110 46 96 64 96H512C530 96 544 110 544 128V384Z",classes:["fa-light"]}]},"fa/light/image":{viewbox:"0 0 512 512",paths:[{d:"M325 158C314 140 285 141 274 158L200 268L184 246C173 230 146 230 134 246L70 335C63 344 62 357 67 367C73 378 83 384 95 384H417C429 384 439 378 444 368C450 358 449 346 443 336L325 158ZM96 352L158 265L188 306C191 310 196 313 201 313C207 312 212 310 214 305L298 175L415 352H96ZM448 32H64C29 32 0 61 0 96V416C0 451 29 480 64 480H448C483 480 512 451 512 416V96C512 61 483 32 448 32ZM480 416C480 434 466 448 448 448H64C46 448 32 434 32 416V96C32 78 46 64 64 64H448C466 64 480 78 480 96V416ZM144 192C170 192 192 170 192 144S170 96 144 96S96 118 96 144S118 192 144 192ZM144 128C153 128 160 135 160 144S153 160 144 160S128 153 128 144S135 128 144 128Z",classes:["fa-light"]}]},"fa/light/lock-keyhole":{viewbox:"0 0 512 512",paths:[{d:"M416 224H384V128C384 57 327 0 256 0S128 57 128 128V224H96C61 224 32 253 32 288V448C32 483 61 512 96 512H416C451 512 480 483 480 448V288C480 253 451 224 416 224ZM160 128C160 75 203 32 256 32S352 75 352 128V224H160V128ZM448 448C448 466 434 480 416 480H96C78 480 64 466 64 448V288C64 270 78 256 96 256H416C434 256 448 270 448 288V448ZM256 320C247 320 240 327 240 336V400C240 409 247 416 256 416S272 409 272 400V336C272 327 265 320 256 320Z",classes:["fa-light"]}]},"fa/light/message":{viewbox:"0 0 512 512",paths:[{d:"M448 0H64C29 0 0 29 0 64V352C0 387 29 416 64 416H160V500C160 510 171 515 179 510L304 416H448C483 416 512 387 512 352V64C512 29 483 0 448 0ZM480 352C480 370 466 384 448 384H304C297 384 290 386 285 390L192 460V400C192 391 185 384 176 384H64C46 384 32 370 32 352V64C32 46 46 32 64 32H448C466 32 480 46 480 64V352Z",classes:["fa-light"]}]},"fa/light/palette":{viewbox:"0 0 512 512",paths:[{d:"M112 264C99 264 88 275 88 288S99 312 112 312C125 312 136 301 136 288S125 264 112 264ZM144 152C131 152 120 163 120 176S131 200 144 200S168 189 168 176S157 152 144 152ZM256 0C239 0 222 2 204 5C105 24 25 104 5 203C-29 378 116 512 239 512C248 512 256 511 264 510C305 504 325 455 306 418C283 373 316 320 367 320H447C483 320 512 290 512 255C511 114 397 0 256 0ZM447 288H367C332 288 300 306 282 336C263 366 262 402 278 433C283 443 283 455 278 464C275 469 270 477 259 479C253 480 246 480 239 480C185 480 125 449 84 398C40 345 23 278 37 210C54 123 124 54 210 37C226 34 241 32 256 32C379 32 480 132 480 255C480 273 465 288 447 288ZM368 136C355 136 344 147 344 160S355 184 368 184S392 173 392 160S381 136 368 136ZM240 88C227 88 216 99 216 112S227 136 240 136C253 136 264 125 264 112S253 88 240 88Z",classes:["fa-light"]}]},"fa/light/save":{viewbox:"0 0 448 512",paths:[{d:"M434 130L350 46C341 37 329 32 316 32H64C29 32 0 61 0 96V416C0 451 29 480 64 480H384C419 480 448 451 448 416V164C448 151 443 139 434 130ZM96 64H288V160H96V64ZM416 416C416 434 402 448 384 448H64C46 448 32 434 32 416V80C32 71 39 64 48 64H64V160C64 178 78 192 96 192H288C306 192 320 178 320 160V65C322 64 321 64 322 64L411 153C414 155 416 160 416 164V416ZM224 240C180 240 144 276 144 320S180 400 224 400S304 364 304 320S268 240 224 240ZM224 368C198 368 176 346 176 320S198 272 224 272S272 294 272 320S250 368 224 368Z",classes:["fa-light"]}]},"fa/light/snowflake":{viewbox:"0 0 512 512",paths:[{d:"M478 384C475 389 470 392 464 392C461 392 459 391 456 390L392 353L406 403C408 412 403 421 394 423C393 423 392 423 390 423C383 423 377 419 375 412L353 331L272 284V377L331 437C338 443 338 453 331 459C328 462 324 464 320 464S312 462 309 459L272 423V496C272 505 265 512 256 512S240 505 240 496V423L203 459C197 466 187 466 181 459S174 443 181 437L240 377V284L159 331L137 412C135 419 129 423 122 423C120 423 119 423 118 423C109 421 104 412 106 403L120 353L56 390C54 391 51 392 48 392C42 392 37 389 34 384C30 376 32 367 40 362L104 325L53 312C45 310 40 301 42 292S53 279 62 281L143 303L224 256L143 209L62 231C60 231 59 231 58 231C51 231 44 227 42 220C40 211 45 202 53 200L104 187L40 150C32 145 30 136 34 128C39 120 48 118 56 122L120 159L106 109C104 100 109 91 118 89C126 87 135 92 137 100L159 181L240 228V135L181 75C174 69 174 59 181 53S197 46 203 53L240 89V16C240 7 247 0 256 0S272 7 272 16V89L309 53C315 46 325 46 331 53S338 69 331 75L272 135V228L353 181L375 100C377 92 386 87 395 89C403 91 408 100 406 109L392 159L456 122C464 118 473 120 478 128C482 136 480 145 472 150L408 187L459 200C467 202 472 211 470 220C468 227 462 231 454 231C453 231 452 231 450 231L369 209L288 256L369 303L450 281C459 279 468 284 470 292C472 301 467 310 459 312L408 325L472 362C480 367 482 376 478 384Z",classes:["fa-light"]}]},"fa/light/table-columns":{viewbox:"0 0 576 512",paths:[{d:"M480 32H96C61 32 32 61 32 96V416C32 451 61 480 96 480H480C515 480 544 451 544 416V96C544 61 515 32 480 32ZM272 448H96C78 448 64 434 64 416V192H272V448ZM512 416C512 434 498 448 480 448H304V192H512V416ZM512 160H64V96C64 78 78 64 96 64H480C498 64 512 78 512 96V160Z",classes:["fa-light"]}]},"bootstrap/arrows-collapse":{viewbox:"0 0 16 16",paths:[{d:"M1 8a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13A.5.5 0 0 1 1 8zm7-8a.5.5 0 0 1 .5.5v3.793l1.146-1.147a.5.5 0 0 1 .708.708l-2 2a.5.5 0 0 1-.708 0l-2-2a.5.5 0 1 1 .708-.708L7.5 4.293V.5A.5.5 0 0 1 8 0zm-.5 11.707l-1.146 1.147a.5.5 0 0 1-.708-.708l2-2a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 11.707V15.5a.5.5 0 0 1-1 0v-3.793z",classes:["bootstrap"]}]},"bootstrap/chat-left":{viewbox:"0 0 16 16",paths:[{d:"M14 1a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H4.414A2 2 0 0 0 3 11.586l-2 2V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12.793a.5.5 0 0 0 .854.353l2.853-2.853A1 1 0 0 1 4.414 12H14a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z",classes:["bootstrap"]}]},"bootstrap/text-center":{viewbox:"0 0 16 16",paths:[{d:"M4 12.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm-2-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5zm2-3a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm-2-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5z",classes:["bootstrap"]}]},"bootstrap/text-left":{viewbox:"0 0 16 16",paths:[{d:"M2 12.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm0-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5zm0-3a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm0-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5z",classes:["bootstrap"]}]},"bootstrap/text-right":{viewbox:"0 0 16 16",paths:[{d:"M6 12.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm-4-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5zm4-3a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm-4-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5z",classes:["bootstrap"]}]},"extra/border-double-bottom":{viewbox:"0 0 448 512",paths:[{d:"M224 88C237 88 248 77 248 64C248 51 237 40 224 40S200 51 200 64C200 77 211 88 224 88ZM224 184C237 184 248 173 248 160C248 147 237 136 224 136S200 147 200 160C200 173 211 184 224 184ZM320 88C333 88 344 77 344 64C344 51 333 40 320 40S296 51 296 64C296 77 307 88 320 88ZM416 376C429 376 440 365 440 352C440 339 429 328 416 328S392 339 392 352C392 365 403 376 416 376ZM320 280C333 280 344 269 344 256C344 243 333 232 320 232S296 243 296 256C296 269 307 280 320 280ZM416 88C429 88 440 77 440 64C440 51 429 40 416 40S392 51 392 64C392 77 403 88 416 88ZM416 280C429 280 440 269 440 256C440 243 429 232 416 232S392 243 392 256C392 269 403 280 416 280ZM416 184C429 184 440 173 440 160C440 147 429 136 416 136S392 147 392 160C392 173 403 184 416 184ZM32 376C45 376 56 365 56 352C56 339 45 328 32 328S8 339 8 352C8 365 19 376 32 376ZM32 88C45 88 56 77 56 64C56 51 45 40 32 40S8 51 8 64C8 77 19 88 32 88ZM32 280C45 280 56 269 56 256C56 243 45 232 32 232S8 243 8 256C8 269 19 280 32 280ZM32 184C45 184 56 173 56 160C56 147 45 136 32 136S8 147 8 160C8 173 19 184 32 184ZM432 448H16C7 448 0 455 0 464S7 480 16 480H432C441 480 448 473 448 464S441 448 432 448ZM128 280C141 280 152 269 152 256C152 243 141 232 128 232S104 243 104 256C104 269 115 280 128 280ZM224 376C237 376 248 365 248 352C248 339 237 328 224 328S200 339 200 352C200 365 211 376 224 376ZM224 280C237 280 248 269 248 256C248 243 237 232 224 232S200 243 200 256C200 269 211 280 224 280ZM128 88C141 88 152 77 152 64C152 51 141 40 128 40S104 51 104 64C104 77 115 88 128 88Z",classes:["extra"]}]},"extra/border-double-bottom2":{viewbox:"0 0 448 512",paths:[{d:"M432,477H16c-9,0-16,7-16,16s7,16,16,16h416c9,0,16-7,16-16S441,477,432,477z",classes:["extra"]},{d:"M128,36c-13,0-24,11-24,24s11,24,24,24s24-11,24-24S141,36,128,36z",classes:["extra"]},{d:"M128,228c-13,0-24,11-24,24s11,24,24,24s24-11,24-24S141,228,128,228z",classes:["extra"]},{d:"M224,324c-13,0-24,11-24,24s11,24,24,24s24-11,24-24S237,324,224,324z",classes:["extra"]},{d:"M32,228c-13,0-24,11-24,24s11,24,24,24s24-11,24-24S45,228,32,228z",classes:["extra"]},{d:"M224,228c-13,0-24,11-24,24s11,24,24,24s24-11,24-24S237,228,224,228z",classes:["extra"]},{d:"M32,132c-13,0-24,11-24,24s11,24,24,24s24-11,24-24S45,132,32,132z",classes:["extra"]},{d:"M32,36C19,36,8,47,8,60s11,24,24,24s24-11,24-24S45,36,32,36z",classes:["extra"]},{d:"M32,324c-13,0-24,11-24,24s11,24,24,24s24-11,24-24S45,324,32,324z",classes:["extra"]},{d:"M416,132c-13,0-24,11-24,24s11,24,24,24s24-11,24-24S429,132,416,132z",classes:["extra"]},{d:"M224,132c-13,0-24,11-24,24s11,24,24,24s24-11,24-24S237,132,224,132z",classes:["extra"]},{d:"M416,324c-13,0-24,11-24,24s11,24,24,24s24-11,24-24S429,324,416,324z",classes:["extra"]},{d:"M416,36c-13,0-24,11-24,24s11,24,24,24s24-11,24-24S429,36,416,36z",classes:["extra"]},{d:"M416,228c-13,0-24,11-24,24s11,24,24,24s24-11,24-24S429,228,416,228z",classes:["extra"]},{d:"M224,36c-13,0-24,11-24,24s11,24,24,24s24-11,24-24S237,36,224,36z",classes:["extra"]},{d:"M320,36c-13,0-24,11-24,24s11,24,24,24s24-11,24-24S333,36,320,36z",classes:["extra"]},{d:"M320,228c-13,0-24,11-24,24s11,24,24,24s24-11,24-24S333,228,320,228z",classes:["extra"]},{d:"M432,409H16c-9,0-16,7-16,16s7,16,16,16h416c9,0,16-7,16-16S441,409,432,409z",classes:["extra"]}]},"extra/wrap":{viewbox:"0 0 16 16",paths:[{d:"M4,5h8c0.276,0,0.5-0.224,0.5-0.5S12.276,4,12,4H4C3.724,4,3.5,4.224,3.5,4.5S3.724,5,4,5z",classes:["extra"]},{d:"M10,8H4C3.724,8,3.5,8.224,3.5,8.5S3.724,9,4,9h6c0.828,0,1.5,0.672,1.5,1.5S10.828,12,10,12v-1.203l-2.953,1.707 L10,14.203V13c1.381,0,2.5-1.119,2.5-2.5S11.381,8,10,8z",classes:["extra"]},{d:"M3.75,12.5c0,0.276,0.224,0.5,0.5,0.5H6v-1H4.25C3.974,12,3.75,12.224,3.75,12.5z",classes:["extra"]}]}},ts={"column-chart":{paths:[{d:"M6,19 L6,10"},{d:"M10,19 L10,13"},{d:"M14,19 L14,5"},{d:"M18,19 L18,9"}]},"donut-chart":{paths:[{d:"M12,4 A8,8,0,0,1,17.65685,6.34315"},{d:"M19.72741,9.92945 A8,8,75,0,1,12,20"},{d:"M8,18.9282 A8,8,75,0,1,8,5.0718"}]},"bar-chart":{paths:[{d:"M5,6 L14,6"},{d:"M5,10 L11,10"},{d:"M5,14 L19,14"},{d:"M5,18 L15,18"}]},"line-chart":{paths:[{d:"M5,15 L9,11 L13,15 L19,9"}]}};class es extends O{constructor(t,e,s){super(),this.number_formats=[],this.date_formats=[],this.colors=[],this.background_color={text:"yellow"},this.foreground_color={text:"blue"},this.border_color=void 0,this.theme_color_map=[];for(const t of[0,128,192,212,256])this.colors.push(`rgb(${t}, ${t}, ${t})`);for(const t of["red","orange","yellow","green","blue","indigo","violet"])this.colors.push(t);this.model=Z`<div id='root' class='treb-toolbar'><div class='group narrow'>${this.IconButton("bootstrap/text-left","text-align","align-left","Align left")}<button class='drop'></button><div class='drop-menu' tabindex='-1'><ul><li>${this.IconButton("bootstrap/text-left","align-left-drop","align-left","Align left","text-align")}</li><li>${this.IconButton("bootstrap/text-center","align-center-drop","align-center","Align center","text-align")}</li><li>${this.IconButton("bootstrap/text-right","align-right-drop","align-right","Align right","text-align")}</li></ul></div></div><div class='group narrow'>${this.IconButton("fa/light/arrow-up-to-line","vertical-align","align-top","Align top")}<button class='drop'></button><div class='drop-menu' tabindex='-1'><ul><li>${this.IconButton("fa/light/arrow-up-to-line","align-top-drop","align-top","Align top","vertical-align")}</li><li>${this.IconButton("bootstrap/arrows-collapse","align-middle-drop","align-middle","Align middle","vertical-align")}</li><li>${this.IconButton("fa/light/arrow-down-to-line","align-bottom-drop","align-bottom","Align bottom","vertical-align")}</li></ul></div></div>${e.file_menu?`<div class='group wide'><button title='File options' class='drop-button'>${this.Icon("fa/light/save")}</button><div class='drop-menu' tabindex='-1'><ul><li><button class='text' data-command='import-desktop'>Import file</button></li><li><button class='text' data-command='save-json'>Save as JSON</button></li><li><button class='text' data-command='export-xlsx'>Export XLSX</button></li><li><button class='text' data-command='reset'>Reset/clear</button></li></ul></div></div>`:""}<div class='group wide'>${this.IconButton("bootstrap/text-left","align-left",!0,"Align left")}${this.IconButton("bootstrap/text-center","align-center",!0,"Align center")}${this.IconButton("bootstrap/text-right","align-right",!0,"Align right")}</div><div class='group wide'>${this.IconButton("fa/light/arrow-up-to-line","align-top",!0,"Align top")}${this.IconButton("bootstrap/arrows-collapse","align-middle",!0,"Align middle")}${this.IconButton("fa/light/arrow-down-to-line","align-bottom",!0,"Align bottom")}</div><div class='group'><button id='wrap' data-command='wrap' title='Wrap text'>${this.Icon("extra/wrap")}</button><button id='merge' data-command='merge' title='Merge cells'>${this.Icon("fa/light/expand","active-icon")}${this.Icon("fa/light/compress","inactive-icon")}</button>${this.IconButton("fa/light/lock-keyhole","lock")}<button id='comment' class='drop-button' title='Comment'>${this.Icon("fa/light/message")}</button><div class='drop-menu' tabindex='-1'><div class='comment-editor'><div class='label' id='comment-label'></div><textarea id='comment-text' class='comment-textarea'></textarea><div class='comment-buttons'><button data-command='clear-comment'>Clear</button><button id='update-comment' data-command='update-comment'>Save</button></div></div></div></div><div class='group'><button class='color-button' data-command='background-color' title='Background color'>${this.Icon("fa/light/fill-drip")}<div id='background-color-bar' class='color-bar' ></div></button><button class='drop'></button><div class='drop-menu color-chooser' data-target='background' tabindex='-1'></div></div><div class='group'><button class='color-button' data-command='foreground-color' title='Text color'>${this.Icon("fa/light/font")}<div id='foreground-color-bar' class='color-bar' ></div></button><button class='drop'></button><div class='drop-menu color-chooser' data-target='foreground' tabindex='-1'></div></div><div class='group'>${this.IconButton("fa/light/border-bottom","update-border","border-bottom","Bottom border")}<button class='drop'></button><div class='drop-menu' tabindex='-1'><ul><li>${this.IconButton("fa/light/border-top","border-top",!0,"Top border","update-border")}</li><li>${this.IconButton("fa/light/border-left","border-left",!0,"Left border","update-border")}</li><li>${this.IconButton("fa/light/border-right","border-right",!0,"Right border","update-border")}</li><li>${this.IconButton("fa/light/border-bottom","border-bottom",!0,"Bottom border","update-border")}</li><li>${this.IconButton("extra/border-double-bottom2","border-double-bottom",!0,"Double bottom border","update-border")}</li><li>${this.IconButton("fa/light/border-all","border-all",!0,"All borders","update-border")}</li><li>${this.IconButton("fa/light/border-outer","border-outside",!0,"Outside borders","update-border")}</li><li>${this.IconButton("fa/light/border-none","border-none",!0,"Clear borders","update-border")}</li><hr/><li><button id='border-color' class='color-button drop-button' data-position='horizontal' title='Border color'>${this.Icon("fa/light/palette")}<div id='border-color-bar' class='color-bar'></div></button><div class='drop-menu color-chooser' data-target='border' tabindex='-1'></div></li></ul></div></div><!-- merge was here --><div class='group'><button id='layout' class='drop-button' title='Rows/columns'>${this.Icon("fa/light/table-columns")}</button><div class='drop-menu' tabindex='-1'><ul><li><button class='text' data-command='insert-row'>Insert row</button></li><li><button class='text' data-command='insert-column'>Insert column</button></li><li><button class='text' data-command='delete-row'>Delete row</button></li><li><button class='text' data-command='delete-column'>Delete column</button></li></ul>${e.add_tab?"<ul><hr/><li><button class='text' data-command='insert-sheet'>Insert sheet</button></li><li><button class='text' data-command='delete-sheet'>Delete sheet</button></li></ul>":""}</div></div><div class='group'>${this.IconButton("fa/light/snowflake","freeze")}<!-- lock was here --></div><div class='group'><div class='container'><input value='General' id='number-format-input'></div><button class='drop'></button><div class='drop-menu scroll' tabindex='-1' data-number-formats></div></div><div class='split-button'><button data-command='decrease-decimal' title='Decrease precision'><div>0${g.decimal_separator}0</div></button><button data-command='increase-decimal' title='Increase precision'><div>0${g.decimal_separator}00</div></button></div><div class='group'>${this.IconButton("column-chart","insert-annotation","column-chart","Insert column chart")}<button class='drop'></button><div class='drop-menu' tabindex='-1'><ul><li>${this.IconButton("column-chart","column-chart",!0,"Insert column chart","insert-annotation")}</li><li>${this.IconButton("donut-chart","donut-chart",!0,"Insert donut chart","insert-annotation")}</li><li>${this.IconButton("bar-chart","bar-chart",!0,"Insert bar chart","insert-annotation")}</li><li>${this.IconButton("line-chart","line-chart",!0,"Insert line chart","insert-annotation")}</li><hr/><li>${this.IconButton("fa/light/image","insert-image",!0,"Insert image","insert-annotation")}</li></ul></div></div>${e.toolbar_recalculate_button?`<div class='group end-group'><button data-command='recalculate' title='Recalculate'>${this.Icon("fa/light/arrows-rotate")}</button></div>`:""}<div class='staging'><div id='color-chooser' class='color-chooser-main'><div class='color-header'>Theme colors</div><div id='theme-color-list' class='color-list'></div><div class='color-header other-colors'>Other colors</div><div id='color-list' class='color-list'></div><div class='new-color'><input id='color-input' placeholder='New Color'><button id='color-button'>${this.Icon("fa/light/check")}</button></div></div></div></div>`,this.model["background-color-bar"].style.color="yellow",this.model["foreground-color-bar"].style.color="blue",this.model["border-color-bar"].style.color="#333";const i=this.model["color-button"],o=this.model["color-input"];this.UpdateTheme(s),i.addEventListener("click",(()=>{this.CommitColor({text:o.value||""})})),o.addEventListener("keydown",(t=>{"Enter"===t.key&&this.CommitColor({text:o.value||""})})),o.addEventListener("input",(()=>{i.style.backgroundColor="";const t=o.value||"";i.style.backgroundColor=t;const e=H.MeasureColor(t),s=A.RGBToHSL(e[0],e[1],e[2]);i.style.color=s.l>.5?"":"#fff"})),this.model["comment-text"].addEventListener("keydown",(t=>{if("Enter"===t.key&&t.ctrlKey)return t.stopPropagation(),t.preventDefault(),void this.model["update-comment"].click()}));let a="";const n=this.model["number-format-input"];n.addEventListener("focus",(()=>a=n.value||"")),n.addEventListener("keydown",(t=>{switch(t.key){case"Enter":this.Publish({type:"format",format:n.value||""});break;case"Escape":n.value=a,this.Publish({type:"cancel"});break;default:return}t.stopPropagation(),t.preventDefault()})),this.model.root.addEventListener("click",(t=>{var e,s,a,n,l,h,c,d,u,m,f;const p=t.target;let _=null===(e=null==p?void 0:p.dataset)||void 0===e?void 0:e.command;if(_){const t={};if(/^border-/.test(_))t.border=_,t.color=this.border_color,_="border";else switch(_){case"clear-comment":case"update-comment":(null===(s=this.state)||void 0===s?void 0:s.selection)&&!this.state.selection.empty&&(t.address=Object.assign({},this.state.selection.target)),t.comment=this.model["comment-text"].value||"";break;case"background-color":t.target="background",t.color=this.background_color;break;case"foreground-color":t.target="foreground",t.color=this.foreground_color;break;case"border-color":t.target="border",t.color=this.border_color}this.Publish({type:"button",command:_,data:t})}else if((null===(a=null==p?void 0:p.classList)||void 0===a?void 0:a.contains("drop"))||(null===(n=null==p?void 0:p.classList)||void 0===n?void 0:n.contains("drop-button"))){let t=p.parentElement;for(;t&&!t.classList.contains("group");){if(t===this.model.root)return;t=t.parentElement}if(t){let t;const e=p.nextSibling;(null===(l=null==e?void 0:e.classList)||void 0===l?void 0:l.contains("drop-menu"))&&(p===this.model.comment&&(this.model["comment-label"].textContent=(null===(c=null===(h=this.state)||void 0===h?void 0:h.selection)||void 0===c?void 0:c.target)?r.CellAddressToLabel(null===(d=this.state)||void 0===d?void 0:d.selection.target):"",this.model["comment-text"].value=(null===(u=this.state)||void 0===u?void 0:u.comment)||"",t=this.model["comment-text"]),void 0!==e.dataset.numberFormats&&this.RenderNumberFormats(e),e.classList.contains("color-chooser")&&(this.color_target=(null===(m=e.dataset)||void 0===m?void 0:m.target)||"",this.RenderColors(this.model["color-list"]),o.value="",i.style.backgroundColor="",i.style.color="",e.appendChild(this.model["color-chooser"])),"horizontal"===(null===(f=p.dataset)||void 0===f?void 0:f.position)?this.Focus(e,p.offsetWidth+12,p.offsetTop-8,t):this.Focus(e,0,p.offsetHeight+4,t))}}})),/narrow/i.test((e.toolbar||"").toString())&&this.model.root.classList.add("narrow"),t.appendChild(this.model.root)}ResolveColor(t,e){return t||(t=e),t.text?t.text:"number"==typeof t.theme&&this.theme_color_map[t.theme]||""}CommitColor(t){switch(this.color_target){case"background":this.model["background-color-bar"].style.color=this.ResolveColor(t,{theme:0}),this.background_color=t?Object.assign({},t):void 0;break;case"border":this.model["border-color-bar"].style.color=this.ResolveColor(t,{theme:1}),this.border_color=t?Object.assign({},t):void 0;break;case"foreground":t||(t={theme:1}),this.model["foreground-color-bar"].style.color=this.ResolveColor(t,{theme:1}),this.foreground_color=t?Object.assign({},t):void 0}this.Publish({type:"button",command:"color",data:{color:t?Object.assign({},t):void 0,target:this.color_target||""}})}Focus(t,e,s,i){t.style.left=e+"px",t.style.top=s+"px",t.classList.add("visible");const r=t=>{"Escape"===t.key&&(t.stopPropagation(),t.preventDefault(),this.Publish({type:"cancel"}))};window.addEventListener("keydown",r);const o=t=>{var e,s,i,r,o,a,n,l;const h=t.target;if(null===(e=h.dataset)||void 0===e?void 0:e.replace){const t=this.model[h.dataset.replace];t.innerHTML=h.innerHTML,t.setAttribute("title",h.getAttribute("title")||""),t.dataset.command=h.dataset.command||void 0}if("number-format"===(null===(s=h.dataset)||void 0===s?void 0:s.command)){const t=h.textContent||"General";this.model["number-format-input"].value=h.textContent||"",this.Publish({type:"format",format:t})}else{if((null===(i=h.dataset)||void 0===i?void 0:i.command)||(null===(r=h.classList)||void 0===r?void 0:r.contains("drop-button")))return;if(null===(o=h.classList)||void 0===o?void 0:o.contains("color-swatch"))if(void 0!==(null===(a=null==h?void 0:h.dataset)||void 0===a?void 0:a.theme)){let t=Number(null===(n=null==h?void 0:h.dataset)||void 0===n?void 0:n.theme);isNaN(t)&&(t=0),this.CommitColor({theme:t||0})}else{const t=(null===(l=null==h?void 0:h.dataset)||void 0===l?void 0:l.color)||"";this.CommitColor(t?{text:t}:void 0)}}t.stopPropagation()};t.addEventListener("click",o);const a=e=>{const s=e.relatedTarget;s&&t.contains(s)||(t.classList.remove("visible"),t.removeEventListener("focusout",a),t.removeEventListener("click",o),window.removeEventListener("keydown",r))};t.addEventListener("focusout",a),requestAnimationFrame((()=>(i||t).focus()))}UpdateState(t){var e,s,i,r,o,a,n,l;this.state=t;const h={"align-center":t.style&&(null===(e=t.style)||void 0===e?void 0:e.horizontal_align)===v.HorizontalAlign.Center,"align-left":t.style&&(null===(s=t.style)||void 0===s?void 0:s.horizontal_align)===v.HorizontalAlign.Left,"align-right":t.style&&(null===(i=t.style)||void 0===i?void 0:i.horizontal_align)===v.HorizontalAlign.Right,"align-top":t.style&&(null===(r=t.style)||void 0===r?void 0:r.vertical_align)===v.VerticalAlign.Top,"align-middle":t.style&&(null===(o=t.style)||void 0===o?void 0:o.vertical_align)===v.VerticalAlign.Middle,"align-bottom":t.style&&(null===(a=t.style)||void 0===a?void 0:a.vertical_align)===v.VerticalAlign.Bottom,wrap:t.style&&!!t.style.wrap,comment:!!t.comment},c=this.model.freeze;t.frozen?(c.classList.add("active"),c.setAttribute("title","Unfreeze panes")):(c.classList.remove("active"),c.setAttribute("title","Freeze panes")),(null===(n=t.style)||void 0===n?void 0:n.locked)?(this.model.lock.classList.add("active"),this.model.lock.setAttribute("title","Unlock cells")):(this.model.lock.classList.remove("active"),this.model.lock.setAttribute("title","Lock cells"));const d=this.model.merge;t.merge?(d.classList.add("active"),d.dataset.command="unmerge",d.setAttribute("title","Unmerge cells")):(d.classList.remove("active"),d.dataset.command="merge",d.setAttribute("title","Merge cells"));const u=(null===(l=t.style)||void 0===l?void 0:l.number_format)||"";this.model["number-format-input"].value=Q.SymbolicName(u)||u,Object.keys(h).forEach((t=>{var e,s;h[t]?null===(e=this.model[t])||void 0===e||e.classList.add("active"):null===(s=this.model[t])||void 0===s||s.classList.remove("active")}))}UpdateTheme(t){const e=this.model["theme-color-list"],s=[],i=["Background","Text","Background","Text","Accent","Accent","Accent","Accent","Accent","Accent"];let r=0;if(this.theme_color_map=[],t.theme_colors){for(s.push("<div class='color-list-row'>"),r=0;r<10;r++){const e=t.theme_colors[r]||"#000";s.push(`<button class='color-swatch' data-theme=${r} title='${i[r]}: ${e}' ></button>`),this.theme_color_map[r]=e}s.push("</div>")}if(e.innerHTML=s.join(""),t.theme_colors){const s=e.querySelectorAll("button.color-swatch");for(let e=0;e<s.length;e++)s[e].style.background=t.theme_colors[e]}}RenderColors(t){const e=["<div class='color-list-row'>","<button class='color-swatch default-color' data-color='' title='Default color'></button>"];let s=0;for(;s<9&&s<this.colors.length;s++){const t=this.colors[s];e.push(`<button class='color-swatch' data-color='${t}' title='${t}' ></button>`)}for(e.push("</div>");s<this.colors.length;){e.push("<div class='color-list-row'>");const t=s+10;for(;s<this.colors.length&&s<t;s++){const t=this.colors[s];e.push(`<button class='color-swatch' data-color='${t}' title='${t}' ></button>`)}e.push("</div>")}t.innerHTML=e.join("");const i=t.querySelectorAll("button.color-swatch");for(let t=0;t<i.length;t++){const e=i[t];e.style.background=e.dataset.color||""}}RenderNumberFormats(t){t.innerHTML=`<ul>${this.number_formats.map((t=>B`<li><button data-command='number-format' class='text'>${t}</button></li>`)).join("\n")}</ul><hr/><ul>${this.date_formats.map((t=>B`<li><button data-command='number-format' class='text'>${t}</button></li>`)).join("\n")}</ul>`}UpdateDocumentStyles(t,e,s){const i=["General","Number","Integer","Percent","Fraction","Accounting","Currency","Scientific"],r=["Timestamp","Long Date","Short Date"];for(const e of t)Q.SymbolicName(Q.Translate(e))||(Q.Get(e).date_format?r.push(e):i.push(e));this.number_formats=i,this.date_formats=r;const o=this.colors.map((t=>H.MeasureColor(t)));for(const t of e){const e=H.MeasureColor(t);o.some((t=>t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]))||(this.colors.push(t),o.push(e))}}IconButton(t,e,s=!0,i,r){return e&&!0===s&&(s=e),"<button"+(e?` id='${e}'`:"")+(r?` data-replace='${r}'`:"")+`${s?` data-command='${s}'`:""}${i?` title='${i}'`:""}>${this.Icon(t)}</button>`}Icon(t,e=""){let s=Qe[t],i="",r="";return s||(s=ts[t],i="symbol"),(e||i)&&(r=` class='${i} ${e}'`),s?`<svg${r} viewBox='${s.viewbox||"0 0 24 24"}'>${(s.paths||[]).map((t=>{let e=" ";return Array.isArray(t.classes)?e+=t.classes.join(" "):t.classes&&(e+=t.classes),`<path d='${t.d}' class='${e.trim()}'/>`})).join("")}</svg>`:(console.warn(t),"")}}class ss{constructor(t=0,e=0,s=100,i=100){this.left=t,this.top=e,this.right=s,this.bottom=i}get width(){return this.right-this.left}get height(){return this.bottom-this.top}get center(){return{x:this.left+this.width/2,y:this.top+this.height/2}}}var is,rs,os;!function(t){t[t.horizontal=0]="horizontal",t[t.vertical=1]="vertical"}(is||(is={})),function(t){t[t.top=0]="top",t[t.bottom=1]="bottom",t[t.left=2]="left",t[t.right=3]="right"}(rs||(rs={})),function(t){t[t.line=0]="line",t[t.marker=1]="marker"}(os||(os={}));const as="http://www.w3.org/2000/svg",ns=/trident/i.test((null===navigator||void 0===navigator?void 0:navigator.userAgent)||""),ls=(t,e={},s)=>{const i=document.createElementNS(as,t);for(const t of Object.keys(e))if(void 0!==e[t]){const s=e[t];i.setAttribute(t,Array.isArray(s)?s.join(" "):s.toString())}return s&&(i.textContent=s),i};class hs{constructor(){this.size={width:0,height:0},this.bounds=new ss,this.container_group=ls("g"),this.group=ls("g"),this.axis_group=ls("g",{class:"axis-group"}),this.label_group=ls("g",{class:"label-group"}),this.container_group.appendChild(this.axis_group),this.container_group.appendChild(this.group),this.container_group.appendChild(this.label_group)}Initialize(t){this.parent=t,this.svg_node=ls("svg",{class:"treb-chart"}),this.svg_node.style.overflow="hidden",this.svg_node.style.position="relative",this.svg_node.style.width="100%",this.svg_node.style.height="100%",this.svg_node.appendChild(this.container_group),this.parent.appendChild(this.svg_node),this.Resize()}Legend(t){const e=ls("g");this.group.appendChild(e);const s=ls("text");e.appendChild(s),e.setAttribute("class","legend");const i=[[]];let r=t.area.width,o=0,a=0;const n=t.area.width,l=t.style===os.marker?14:26,h=t.labels.map(((e,h)=>{s.textContent=e;const c=s.getBoundingClientRect(),d={width:c.width,height:c.height},u=d.width+l+10;return a=Math.max(a,d.height),t.layout===is.vertical?i[h]=[h]:u>r?0===i[o].length?(i[o].push(h),o++,i[o]=[],r=n):(o++,i[o]=[h],r=n-u):(i[o].push(h),r-=u),d}));e.removeChild(s);let c=a,d=t.layout||is.horizontal;d===is.horizontal&&i.every((t=>t.length<=1))&&(d=is.horizontal);for(let s=0;s<i.length;s++){const r=i[s].reduce(((t,e)=>t+h[e].width+l),10*(i[s].length-1));let o=0,a=d===is.horizontal?Math.round((n-r)/2):Math.round(5);for(let r=0;r<i[s].length;r++){const n=i[s][r],d=h[n],u=t.labels[n],m=c-1;e.appendChild(ls("text",{"dominant-baseline":"middle",x:a+l,y:c,dy:ns?".3em":void 0},u)),t.style===os.marker?e.appendChild(ls("rect",{class:`series-${n+1}`,x:a,y:m-4,width:8,height:8})):e.appendChild(ls("rect",{class:`series-${n+1}`,x:a,y:m-1,width:l-3,height:2})),o=Math.max(o,d.height),a+=d.width+l+10}c=Math.round(c+1.1*o)}const u=e.getBoundingClientRect(),m=u.width,f=u.height+a;switch(t.position){case rs.bottom:e.setAttribute("transform",`translate(${t.area.left}, ${t.area.bottom-f})`);break;case rs.left:e.setAttribute("transform",`translate(${t.area.left}, ${t.area.top})`);break;case rs.right:e.setAttribute("transform",`translate(${t.area.right-m}, ${t.area.top})`);break;case rs.top:default:e.setAttribute("transform",`translate(${t.area.left}, ${t.area.top})`)}t.position===rs.top?t.area.top+=f||0:t.position===rs.right?t.area.right-=(m||0)+8:t.position===rs.left?t.area.left+=(m||0)+8:t.area.bottom-=f||0}Clear(){this.group.textContent="",this.axis_group.textContent="",this.label_group.textContent=""}Resize(){const t=this.parent.getBoundingClientRect();this.svg_node.setAttribute("width",t.width.toString()),this.svg_node.setAttribute("height",t.height.toString()),this.size={width:t.width,height:t.height}}Prerender(){const t=this.svg_node.getBoundingClientRect();this.bounds.top=t.top,this.bounds.left=t.left,this.bounds.right=t.right,this.bounds.bottom=t.bottom}RenderTitle(t,e,s,i){const r=ls("text",{class:"chart-title",x:Math.round(e.width/2)},t);r.style.textAnchor="middle",this.group.appendChild(r);const o=r.getBoundingClientRect();switch(i){case"bottom":r.setAttribute("y",Math.round(e.bottom-o.height).toString()),e.bottom-=o.height+s;break;default:r.setAttribute("y",Math.round(e.top+s+o.height).toString()),e.top+=o.height+s}}MeasureText(t,e,s=!1){this.text_measurement_node||(this.text_measurement_node=ls("text",{x:"-100px",y:"-100px"}),this.svg_node.appendChild(this.text_measurement_node)),void 0!==e?("string"==typeof e&&(e=[e]),this.text_measurement_node.setAttribute("class",e.join(" "))):this.text_measurement_node.setAttribute("class",""),this.text_measurement_node.textContent=t;const i=this.text_measurement_node.getBoundingClientRect(),r={width:i.width,height:i.height,y_offset:i.height-(this.bounds.top-i.top-100)};return s&&(r.width=Math.ceil(r.width),r.height=Math.ceil(r.height),r.y_offset=Math.ceil(r.y_offset)),r}RenderTicks(t,e,s,i,r){const o=[],a=t.width/i;for(let r=0;r<i;r++){const i=Math.round(t.left+a/2+a*r)-.5;o.push(`M${i} ${e} L${i} ${s}`)}this.group.appendChild(ls("path",{d:o,class:r}))}RenderXAxisBar(t,e,s,i,r){const o=s.length;if(!o)return;const a=e?t.width/o:t.width/(o-1),n=e?a/2:0;let l=1,h=!0;for(;h;){h=!1;let e=0;for(let s=0;s<o;s+=l){const r=Math.round(t.left+n+a*s),o=r-i[s].width/2;if(e&&o<=e){l++,h=!0;break}e=r+i[s].width/2+4}}for(let e=0;e<o;e+=l){const i=Math.round(t.left+n+a*e);this.RenderText(this.axis_group,s[e],"center",{x:i,y:t.bottom},r)}}RenderXAxis(t,e,s,i,r){const o=s.length;if(!o)return;const a=e?t.width/o:t.width/(o-1),n=e?a/2:0;let l=1,h=!0;const c=(s.length-1)%2==0,d=(s.length-1)%3==0;for(;h;){h=!1;let e=0;for(let s=0;s<o;s+=l){const r=Math.round(t.left+n+a*s),o=r-i[s].width/2;if(e&&o<=e){l++,h=!0;break}e=r+i[s].width/2+4}}3===l&&!d&&c&&l++;for(let e=0;e<o;e+=l){const i=Math.round(t.left+n+a*e);this.RenderText(this.axis_group,s[e],"center",{x:i,y:t.bottom},r)}}RenderYAxisBar(t,e,s,i){(s=s.slice(0)).reverse();const r=s.length;if(!r)return;const o=t.height/r;let a=1,n=!0;for(;n;){n=!1;let e=0;for(let i=0;i<r;i+=a){const r=s[i],l=Math.round(t.bottom-o*(i+.5)+r.metrics.height/4);if(e&&l>=e){a++,n=!0;break}e=l-r.metrics.height}}for(let n=0;n<r;n+=a){const r=s[n],a=Math.round(t.bottom-o*(n+.5)+r.metrics.height/4);this.RenderText(this.axis_group,r.label,"right",{x:e,y:a},i)}}RenderYAxis(t,e,s,i){const r=s.length;if(!r)return;const o=t.height/(r-1);let a=1,n=!0;for(;n;){n=!1;let e=0;for(let i=0;i<r;i+=a){const r=s[i],l=Math.round(t.bottom-o*i+r.metrics.height/4);if(e&&l>=e){a++,n=!0;break}e=l-r.metrics.height}}for(let n=0;n<r;n+=a){const r=s[n],a=Math.round(t.bottom-o*n+r.metrics.height/4);this.RenderText(this.axis_group,r.label,"right",{x:e,y:a},i)}}LineProperties(t,e){const s=e.x-t.x,i=e.y-t.y;return{length:Math.sqrt(s*s+i*i),angle:Math.atan2(i,s)}}RenderSmoothLine(t,e,s=!1,i,r){const o=ls("g"),a=[],n=[],l=e.length,h=l-1,c=t.width/l/2,d=[],u=e.map(((e,s)=>{if(void 0!==e)return{x:Math.round(t.left+t.width/h*s),y:t.bottom-e}}));let m=[];const f=()=>{if(m.length<2)return;let e="";const i=m[0],r=m[m.length-1];2===m.length?e=`${m[0].x},${m[0].y} L${m[1].x},${m[1].y}`:m.length>2&&(e=""+this.CatmullRomChain(m).map((t=>`${t.x},${t.y}`)).join(" L")),e&&(a.push("M"+e),s&&(n.push(`M ${i.x},${t.bottom} L ${i.x},${i.y}`),n.push("L"+e),n.push(`L ${r.x},${t.bottom}`)))};for(const t of u)t?m.push(t):(f(),m=[]);if(m.length&&f(),s&&o.appendChild(ls("path",{class:"fill",d:n})),o.appendChild(ls("path",{class:"line",d:a})),void 0!==r&&("string"==typeof r&&(r=[r]),o.setAttribute("class",r.join(" "))),this.group.appendChild(o),i&&d.length){const t=document.createElementNS(as,"g");for(const e of d){const s=ls("circle",{cx:e.x,cy:e.y,r:c});s.addEventListener("mouseenter",(t=>{this.parent.setAttribute("title",i[e.i]||"")})),s.addEventListener("mouseleave",(t=>{this.parent.setAttribute("title","")})),t.appendChild(s)}t.setAttribute("class","mouse-layer"),this.group.appendChild(t)}}RenderLine(t,e,s=!1,i,r){const o=document.createElementNS(as,"g"),a=[],n=[],l=e.length,h=l-1,c=t.width/l/2,d=[];let u,m=0,f=!0;for(;m<l;m++){const i=e[m];if(void 0===i){f=!0,s&&void 0!==u&&n.push(`L${u} ${t.bottom}Z`),u=void 0;continue}const r=Math.round(+t.left+t.width/h*m);f?(s&&n.push(`M${r} ${t.bottom} L${r} ${t.bottom-i}`),a.push(`M${r} ${t.bottom-i}`)):(a.push(`L${r} ${t.bottom-i}`),n.push(`L${r} ${t.bottom-i}`)),d.push({x:r,y:t.bottom-i,i:m}),u=r,f=!1}if(s&&void 0!==u&&n.push(`L${u} ${t.bottom}Z`),s&&o.appendChild(ls("path",{class:"fill",d:n})),o.appendChild(ls("path",{class:"line",d:a})),void 0!==r&&("string"==typeof r&&(r=[r]),o.setAttribute("class",r.join(" "))),this.group.appendChild(o),i&&d.length){const t=document.createElementNS(as,"g");for(const e of d){const s=ls("circle",{cx:e.x,cy:e.y,r:c});s.addEventListener("mouseenter",(t=>{this.parent.setAttribute("title",i[e.i]||"")})),s.addEventListener("mouseleave",(t=>{this.parent.setAttribute("title","")})),t.appendChild(s)}t.setAttribute("class","mouse-layer"),this.group.appendChild(t)}}RenderBarGrid(t,e,s){const i=[],r=t.width/e;for(let s=0;s<=e;s++){const e=Math.round(t.left+r*s)-.5;i.push(`M${e} ${t.top} L${e} ${t.bottom}`)}this.group.appendChild(ls("path",{d:i,class:s}))}RenderGrid(t,e,s=0,i){const r=[];let o=t.height/e;for(let s=0;s<=e;s++){const e=Math.round(t.top+o*s)-.5;r.push(`M${t.left} ${e} L${t.right} ${e}`)}o=t.width/(s-1);for(let e=0;e<s;e++){const s=Math.round(t.left+o*e)-.5;r.push(`M${s} ${t.top} L${s} ${t.bottom}`)}this.group.appendChild(ls("path",{d:r,class:i}))}MultiplyPoint(t,e){return{x:t.x*e,y:t.y*e}}AddPoints(t,e){return{x:t.x+e.x,y:t.y+e.y}}CatmullRomSpline(t,e){let s=.5;s/=2;const i=(t,e,s)=>{const{x:i,y:r}=e,{x:o,y:a}=s;return Math.pow(Math.pow(o-i,2)+Math.pow(a-r,2),.25)+t},r=i(0,t[0],t[1]),o=i(r,t[1],t[2]),a=i(o,t[2],t[3]),n=(o-r)/e,l=[];for(let s=0;s<e;s++){const e=r+n*s,i=this.AddPoints(this.MultiplyPoint(t[0],(r-e)/(r-0)),this.MultiplyPoint(t[1],(e-0)/(r-0))),h=this.AddPoints(this.MultiplyPoint(t[1],(o-e)/(o-r)),this.MultiplyPoint(t[2],(e-r)/(o-r))),c=this.AddPoints(this.MultiplyPoint(t[2],(a-e)/(a-o)),this.MultiplyPoint(t[3],(e-o)/(a-o))),d=this.AddPoints(this.MultiplyPoint(i,(o-e)/(o-0)),this.MultiplyPoint(h,(e-0)/(o-0))),u=this.AddPoints(this.MultiplyPoint(h,(a-e)/(a-r)),this.MultiplyPoint(c,(e-r)/(a-r))),m=this.AddPoints(this.MultiplyPoint(d,(o-e)/(o-r)),this.MultiplyPoint(u,(e-r)/(o-r)));l.push(m)}return l}CatmullRomChain(t,e=30){const s=t.slice(0),i=[],r=s.length;if(r){let t=s[r-1].x-s[r-2].x,o=s[r-1].y-s[r-2].y;s.push({x:s[r-1].x+t,y:s[r-1].y+o}),s.push({x:s[r-1].x+t,y:s[r-1].y+o}),t=s[1].x-s[0].x,o=s[1].y-s[0].y,s.unshift({x:s[0].x-t,y:s[0].y-o});for(let t=0;t<s.length-4;t++){const r=s.slice(t,t+4),o=this.CatmullRomSpline(r,e);i.push(...o)}}return i}RenderDataLabels(t,e,s,i,r,o,a){const n=Math.max(e.length,s.length),l=i.max-i.min||1,h=r.max-r.min||1;for(let c=0;c<n;c++){const n=e[c],d=s[c];if(void 0!==n&&void 0!==d){const e={x:t.left+(n-i.min)/l*t.width,y:t.bottom-(d-r.min)/h*t.height},s=o[c];if(s){this.label_group.appendChild(ls("circle",{class:"label-target",cx:e.x,cy:e.y,r:10}));const i=ls("g",{class:"data-label",transform:`translate(${e.x+10},${e.y})`});this.label_group.appendChild(i);const r=ls("circle",{cx:-10,y:0,r:5,class:`marker-highlight series-${a}`});i.appendChild(r);const o=ls("text",{x:4,y:0},s);i.appendChild(o);const n=o.getBoundingClientRect(),l=n.height,h=n.width+8;h+15+e.x>=t.right&&(i.setAttribute("transform",`translate(${e.x-h-15},${e.y})`),r.setAttribute("cx",(h+15).toString()));const c=ls("path",{d:`M0,5 h${h} v-${l} h-${h} Z`});i.insertBefore(c,o)}}}}RenderScatterSeries(t,e,s,i,r,o=!0,a=!1,n=!1,l=!1,h){const c=Math.max(e.length,s.length),d=i.max-i.min||1,u=r.max-r.min||1,m=[],f=[],p=[],_=ls("g",{class:h});this.group.appendChild(_);for(let o=0;o<c;o++){const a=e[o],n=s[o];void 0===a||void 0===n?m.push(void 0):m.push({x:t.left+(a-i.min)/d*t.width,y:t.bottom-(n-r.min)/u*t.height})}if(o){let e=[];const s=l?()=>2===e.length?`${e[0].x},${e[0].y} L${e[1].x},${e[1].y}`:e.length>2?this.CatmullRomChain(e).map((t=>`${t.x},${t.y}`)).join(" L"):"":()=>e.map((t=>`${t.x},${t.y}`)).join(" L");for(const i of m)if(i)e.push(i);else{if(e.length>=2){const i=s();f.push("M"+i),p.push(`M${e[0].x},${t.bottom}L`+i+`L${e[e.length-1].x},${t.bottom}Z`)}e=[]}if(e.length>=2){const i=s();f.push("M"+i),p.push(`M${e[0].x},${t.bottom}L`+i+`L${e[e.length-1].x},${t.bottom}Z`)}}if(a&&_.appendChild(ls("path",{d:p,class:"fill"})),o&&_.appendChild(ls("path",{d:f,class:"line"})),n)for(const t of m)t&&_.appendChild(ls("circle",{cx:t.x,cy:t.y,r:3,class:"marker"}))}RenderPoints(t,e,s,i){const r=[];for(let i=0;i<e.length;i++){const o=e[i]*t.width+t.left,a=t.bottom-s[i]*t.height;r.push(`M${o-1},${a-1} L${o+1},${a+1}`),r.push(`M${o-1},${a+1} L${o+1},${a-1}`)}this.group.appendChild(ls("path",{d:r,class:i}))}RenderPoint(t,e,s){this.group.appendChild(ls("circle",{cx:t,cy:e,r:1,class:s}))}RenderRectangle(t,e,s,i,r,o){let a="";if(e)if(e[0]&&e[0]===e[1]&&e[0]>=t.height){const s=e[0],i=e[0]-t.height,r=Math.sqrt(s*s-i*i);a=`M${t.left+t.width/2-r},${t.bottom} a${s},${s} 0 0 1 ${2*r},0 z`}else if(e[1]&&e[1]===e[2]&&e[1]>=t.width){const s=e[1],i=e[1]-t.width,r=Math.sqrt(s*s-i*i);a=`M${t.left},${t.top+t.height/2-r} a${s},${s} 0 0 1 0,${2*r} z`}else a=`M${t.left},${t.top+e[0]} a${e[0]},${e[0]} 0 0 1 ${e[0]},${-e[0]} h${t.width-e[0]-e[1]} a${e[1]},${e[1]} 0 0 1 ${e[1]},${e[1]} v${t.height-e[1]-e[2]} a${e[2]},${e[2]} 0 0 1 ${-e[2]},${e[2]} h${-t.width+e[2]+e[3]} a${e[3]},${e[3]} 0 0 1 ${-e[3]},${-e[3]} v${-t.height+e[3]+e[0]} `;else a=`M${t.left},${t.top} h${t.width} v${t.height} h${-t.width} v${-t.height} `;const n=ls("path",{d:a,class:s});if(i&&(n.addEventListener("mouseenter",(t=>{this.parent.setAttribute("title",i)})),n.addEventListener("mouseleave",(t=>{this.parent.setAttribute("title","")}))),this.group.appendChild(n),r){this.label_group.appendChild(ls("path",{class:"label-target",d:a}));const e=o||{x:Math.round(t.left+t.width/2),y:Math.round(t.top-10)},s=ls("g",{class:"data-label",transform:`translate(${e.x},${e.y})`});this.label_group.appendChild(s);const i=ls("text",{x:0,y:0},r);s.appendChild(i);const n=i.getBoundingClientRect(),l=n.height,h=n.width+8;e.y-n.height<4&&(e.y-=e.y-n.height-4,s.setAttribute("transform",`translate(${e.x},${e.y})`)),i.setAttribute("x",Math.floor(-n.width/2).toString());const c=Math.ceil(.125*l),d=ls("rect",{rx:3,x:-h/2,y:Math.round(2*c/3-l),width:h,height:l+c});s.insertBefore(d,i)}}RenderText(t,e,s,i,r){const o=ls("text",{x:i.x,y:i.y,class:r},e);switch(s){case"right":o.style.textAnchor="end";break;case"center":o.style.textAnchor="middle";break;default:o.style.textAnchor="start"}(t||this.group).appendChild(o)}RenderDonut(t,e,s,i,r,o,a){let n=-Math.PI/2,l=0;o&&(s*=.8,i*=.7);const h=(t,e,s)=>[Math.cos(s)*e+t.x,Math.sin(s)*e+t.y];for(const o of t){const t=o.title||"",c=o.percent,d=o.index;let u=[],m=0;const f=h.bind(0,e,s),p=h.bind(0,e,i);if(c>.5){m=n+c/2*Math.PI*2,l=n+c*Math.PI*2;const t=m-n,e=l-m;u.push(`M${f(n)}`,`A${s},${s},${t},0,1,${f(m)}`,`A${s},${s},${e},0,1,${f(l)}`,`L${p(l)}`,`A${i},${i},${e},0,0,${p(m)}`,`A${i},${i},${t},0,0,${p(n)}`,"Z")}else{l=n+c*Math.PI*2,m=(l-n)/2+n;const t=l-n;u.push(`M${f(n)}`,`A${s},${s},${t},0,1,${f(l)}`,`L${p(l)}`,`A${i},${i},${t},0,0,${p(n)}`,"Z")}const _=ls("path",{d:u,class:void 0===d?void 0:`series-${d}`}),g=ls("g",{class:a});if(g.appendChild(_),this.group.appendChild(g),c>=.05&&t){u=[];const o=h(e,i+(s-i)/2+(s-i),m);u.push(`M${h(e,i+(s-i)/2,m)}`),u.push(`L${o}`),g.appendChild(ls("path",{d:u,class:"callout"}));const a=[],n=ls("text",{class:"callout-label"});g.appendChild(n);const l=m+Math.PI/2,c=t;n.textContent=c;let d=n.getBoundingClientRect();const f={width:d.width,height:d.height};let[p,_]=o;p+=f.height/2*Math.cos(m),_+=f.height/4+f.height/2*Math.sin(m);let y=!1;l>Math.PI?p-f.width<=r.left&&(y=!0):p+f.width>r.right&&(y=!0);const v=/[\s-\W]/;if(y&&v.test(c)){let t=-1,e=1;for(let s=0;s<c.length;s++)if(v.test(c[s])){const i=Math.abs(.5-s/c.length);i<e&&(e=i,t=s)}t>0&&(a.push(c.substr(0,t+1).trim()),a.push(c.substr(t+1).trim()))}if(a.length){let t=0,e=0;const s=a.map((t=>{n.textContent=t,d=n.getBoundingClientRect();const s={width:d.width,height:d.height};return e=Math.max(e,s.width),{text:t,metrics:s}}));n.textContent="";for(const i of s){const s=document.createElementNS(as,"tspan");s.textContent=i.text;const r=l>Math.PI?p-(e-i.metrics.width)/2:p+(e-i.metrics.width)/2;s.setAttribute("x",r.toString()),s.setAttribute("dy",t.toString()),n.appendChild(s),t=i.metrics.height}}const b=l>Math.PI?"end":"start";n.setAttribute("text-anchor",b),n.setAttribute("x",p.toString()),n.setAttribute("y",_.toString())}n=l}}}class cs{static Scale(t,e,s=6.5){return j(t,e,s)}static Range(t){let e,s;for(const i of t)void 0!==i&&((void 0===e||e>i)&&(e=i),(void 0===s||s<i)&&(s=i));return{min:e,max:s,range:void 0===e||void 0===s?0:s-e}}static ApplyScale(t,e,s){return e*(t-s.min)/(s.max-s.min)}static Flatten(t){let e=[];if(Array.isArray(t))for(const s of t)Array.isArray(s)?e=e.concat(this.Flatten(s)):e.push(s);else void 0!==t&&e.push(t);return e}}s(897);const ds="#,##0.00";class us{constructor(t=new hs){this.renderer=t,this.chart_data={type:"null"},this.margin={top:.025,left:.05,bottom:.025,right:.075}}Initialize(t){this.renderer.Initialize(t)}Exec(t,e=[]){switch(t.toLowerCase()){case"mc.histogram":this.CreateHistogram(e);break;case"mc.correlation":this.CreateScatter(e);break;case"column.chart":this.CreateColumnChart(e,"column");break;case"bar.chart":this.CreateColumnChart(e,"bar");break;case"line.chart":this.CreateLineChart(e,"line");break;case"area.chart":this.CreateLineChart(e,"area");break;case"donut.chart":case"pie.chart":this.CreateDonut(e,"pie.chart"===t.toLowerCase());break;case"scatter.plot":this.CreateScatterChart(e,"plot");break;case"scatter.line":this.CreateScatterChart(e,"line");break;default:this.Clear()}}Clear(){this.chart_data={type:"null"}}CreateColumnChart(t,e){var s,i;const r=Array.isArray(t[0])?this.TransformSeriesData(t[0]):[],a=this.CommonData(r);let n;if(t[1]){n=cs.Flatten(t[1]).map((t=>t?t.type===o.object&&"metadata"===t.value.type?"number"==typeof t.value.value?Q.Get(t.value.format||ds).Format(t.value.value):t.value.value:"number"==typeof t.value?Q.Get(t.format||ds).Format(t.value):t.value:""));const e=r.reduce(((t,e)=>Math.max(t,e.y.data.length)),0);for(e<n.length&&(n=n.slice(0,e));e>n.length;)n.push("")}const l=(null===(s=t[2])||void 0===s?void 0:s.toString())||void 0,h=(null===(i=t[3])||void 0===i?void 0:i.toString())||void 0;if(this.chart_data={type:e,legend:a.legend,legend_style:os.marker,series2:r,scale:a.y.scale,title:l,y_labels:"bar"===e?n:a.y.labels,x_labels:"bar"===e?a.y.labels:n},h){this.chart_data.round=/round/i.test(h),this.chart_data.data_labels=/labels/i.test(h);const t=h.match(/labels="(.*?)"/);t&&r&&this.ApplyLabels(r,t[1],n)}}ReadSeries(t){var e,s,i,r;const o={x:{data:[]},y:{data:[]}};if(t[0]){const i=cs.Flatten(t[0]);"object"==typeof i[0]?o.label=(null===(s=null===(e=i[0])||void 0===e?void 0:e.value)||void 0===s?void 0:s.toString())||"":o.label=i[0].toString()}if(t[2]&&Array.isArray(t[2])){const e=cs.Flatten(t[2]);if(o.y.data=e.map((t=>"number"==typeof t.value.value?t.value.value:void 0)),null===(i=e[0].value)||void 0===i?void 0:i.format){o.y.format=null===(r=e[0].value)||void 0===r?void 0:r.format;const t=Q.Get(o.y.format);o.y.labels=o.y.data.map((e=>void 0===e?void 0:t.Format(e)))}}if(t[1]&&Array.isArray(t[1])){const e=cs.Flatten(t[1]);o.x.data=e.map((t=>"number"==typeof t.value.value?t.value.value:void 0)),e[0].value.format&&(o.x.format=e[0].value.format)}for(const t of[o.x,o.y])if(t.data.length){const e=t.data.filter((t=>t||0===t));t.range={min:Math.min.apply(0,e),max:Math.max.apply(0,e)}}return o}ArrayToSeries(t){const e={x:{data:[]},y:{data:[]}},s=cs.Flatten(t);if(e.y.data=s.map((t=>"number"==typeof t.value.value?t.value.value:void 0)),s[0].value.format){e.y.format=s[0].value.format||"";const t=Q.Get(e.y.format||"");e.y.labels=e.y.data.map((e=>void 0===e?void 0:t.Format(e)))}const i=e.y.data.filter((t=>t||0===t));return e.y.range={min:Math.min.apply(0,i),max:Math.max.apply(0,i)},e}TransformSeriesData(t,e){const s=[];if(Array.isArray(t)){const e=t;if("group"===e._type){for(const t of e)if(Array.isArray(t))if("series"===t._type){const e=this.ReadSeries(t);s.push(e)}else{const e=this.ArrayToSeries(t);s.push(e)}}else if("series"===e._type){const t=this.ReadSeries(e);s.push(t)}else s.push(this.ArrayToSeries(e))}let i,r=0;if(e&&Array.isArray(e)){let t="0.00###";(e=cs.Flatten(e))[0]&&c(e[0])&&(t=e[0].value.format);const s=e.map((t=>t.type===o.number?t.value:c(t)?t.value.value:void 0)),r=s.filter((t=>"number"==typeof t));i={data:s,format:t,range:{min:Math.min.apply(0,r),max:Math.max.apply(0,r)}}}for(const t of s)r=Math.max(r,t.y.data.length),t.x.data.length&&(i||(i=t.x));if(!i){i={data:[],range:{min:0,max:Math.max(0,r-1)}};for(let t=0;t<r;t++)i.data.push(t)}for(const t of s)t.x.data.length||(t.x=i);return s}CommonData(t,e,s){let i,r="",o="";for(const e of t)e.y.format&&!o&&(o=e.y.format),e.x.format&&!r&&(r=e.x.format);t.some((t=>t.label&&t.label.length>0))&&(i=t.map(((t,e)=>t.label||`Series ${e+1}`)));const a=t.filter((t=>t.x.range)),n=Math.min.apply(0,a.map((t=>{var e;return(null===(e=t.x.range)||void 0===e?void 0:e.min)||0}))),l=Math.max.apply(0,a.map((t=>{var e;return(null===(e=t.x.range)||void 0===e?void 0:e.max)||0})));t.filter((t=>t.y.range));let h=Math.min.apply(0,a.map((t=>{var e;return(null===(e=t.y.range)||void 0===e?void 0:e.min)||0}))),c=Math.max.apply(0,a.map((t=>{var e;return(null===(e=t.y.range)||void 0===e?void 0:e.max)||0})));void 0!==e&&(h=Math.min(h,e)),void 0!==s&&(c=Math.max(c,s));const d=cs.Scale(n,l,7),u=cs.Scale(h,c,7);let m,f;if(r){m=[];const t=Q.Get(r);for(let e=0;e<=d.count;e++)m.push(t.Format(d.min+e*d.step))}if(o){f=[];const t=Q.Get(o);for(let e=0;e<=u.count;e++)f.push(t.Format(u.min+e*u.step))}return{x:{format:r,scale:d,labels:m},y:{format:o,scale:u,labels:f},legend:i}}CreateScatterChart(t,e="plot"){var s,i;const r=Array.isArray(t[0])?this.TransformSeriesData(t[0]):[],o=this.CommonData(r),a=(null===(s=t[1])||void 0===s?void 0:s.toString())||void 0,n=(null===(i=t[2])||void 0===i?void 0:i.toString())||void 0;if(this.chart_data={legend:o.legend,style:e,type:"scatter2",series:r,title:a,x_scale:o.x.scale,x_labels:o.x.labels,y_scale:o.y.scale,y_labels:o.y.labels,lines:!0},n){this.chart_data.markers=/marker/i.test(n),this.chart_data.smooth=/smooth/i.test(n),this.chart_data.data_labels=/labels/i.test(n);const t=n.match(/labels="(.*?)"/);t&&this.chart_data.series&&this.ApplyLabels(this.chart_data.series,t[1])}}ApplyLabels(t,e,s){for(const i of t){const t={x:Q.Get(i.x.format||""),y:Q.Get(i.y.format||"")};i.y.labels=[];for(let r=0;r<i.y.data.length;r++){const o=s?s[r]:"number"==typeof i.x.data[r]?t.x.Format(i.x.data[r]):"",a="number"==typeof i.y.data[r]?t.y.Format(i.y.data[r]):"";i.y.labels[r]=e.replace(/\bx\b/g,o).replace(/\by\b/g,a)}}}CreateLineChart(t,e){var s,i;const r=Array.isArray(t[0])?this.TransformSeriesData(t[0],t[1]):[],o=this.CommonData(r,0,0),a=(null===(s=t[2])||void 0===s?void 0:s.toString())||void 0,n=(null===(i=t[3])||void 0===i?void 0:i.toString())||void 0;this.chart_data={legend:o.legend,type:"scatter2",series:r,title:a,x_scale:o.x.scale,x_labels:o.x.labels,y_scale:o.y.scale,y_labels:o.y.labels,lines:!0,filled:"area"===e},n&&(this.chart_data.smooth=/smooth/i.test(n))}CreateDonut(t,e=!1){const s=t[0],i=cs.Flatten(s);let r=i.map((t=>"number"==typeof t.value.value?t.value.value:void 0));const o=cs.Flatten(t[1]).map((t=>{var e,s,i;if(t&&"object"==typeof t){const r=null===(e=t.value)||void 0===e?void 0:e.value;return"number"==typeof r&&(null===(s=t.value)||void 0===s?void 0:s.format)?Q.Get(null===(i=t.value)||void 0===i?void 0:i.format).Format(r):r?r.toString():""}return t?t.toString():""}));r=r.map((t=>t<0?(console.warn("pie/donut chart does not support negative values (omitted)"),0):t));const a=t[2]||"";let n=0;const l=r.map(((t,e)=>(void 0!==t&&(n+=t),{value:t,label:o[e]||"",index:e+1,percent:0})));if(n)for(const t of l)t.percent=(t.value||0)/n;const h=i.length&&i[0].format?i[0].format:"",c=Q.Get(h||ds),d=Q.Get("percent");void 0===t[4]&&t[1]&&(t[4]="label");const u=t[4]||"";if(u)for(const t of l){const e=c.Format(t.value||0),s=d.Format(t.percent);t.title=u.replace(/value%/gi,d.Format(t.value||0)).replace(/value/gi,e).replace(/percent/gi,s).replace(/label/gi,t.label||"").trim()}const m=(t[3]||"").toString().trim();/^(asc|inc)/i.test(m)?l.sort(((t,e)=>(t.value||0)-(e.value||0))):/^(desc|dec)/i.test(m)&&l.sort(((t,e)=>(e.value||0)-(t.value||0))),this.chart_data={type:e?"pie":"donut",slices:l,title:a}}CreateScatter(t){const e=[t[0],t[1]];if(!e[0]||e[0].type!==o.object||!this.IsCellData(e[0].value))return console.warn("invalid args [0]",t),void this.Clear();if(!e[1]||e[1].type!==o.object||!this.IsCellData(e[1].value))return console.warn("invalid args [1]",t),void this.Clear();const s=t[2]||"",i=e[0].value,r=e[1].value;let a=(i.simulation_data||[]).slice(0),n=(r.simulation_data||[]).slice(0);const l=Math.min.apply(0,a),h=Math.max.apply(0,a)-l;a=a.map((t=>(t-l)/h));const c=Math.min.apply(0,n),d=Math.max.apply(0,n)-c;n=n.map((t=>(t-c)/d));const u=Math.min(a.length,n.length);this.chart_data={type:"scatter",x:a,y:n,count:u,title:s}}CreateHistogram(t){var e,s;const i=[],r=[],a=Array.isArray(t[0])?t[0]:[t[0]];for(const e of a){if(!e||e.type!==o.object||!this.IsCellData(e.value))return console.warn("invalid args [0]",t),void this.Clear();const s=e.value.simulation_data||[];s.length&&(i.push(Math.min.apply(0,s)),r.push(Math.max.apply(0,s)))}if(!i.length||!r.length)return console.info("no data"),void this.Clear();let n=12;"number"==typeof t[3]&&(n=t[3]);const l=cs.Scale(Math.min.apply(0,i),Math.max.apply(0,r),n),h=[];for(let t=0;t<=l.count;t++)h[t]=l.min+t*l.step;const c=a.map((t=>{const e=t.value.simulation_data||[],s=[];for(let t=0;t<=l.count;t++)s[t]=0;for(const t of e)s[Math.round((t-l.min)/l.step)]++;const i=Q.Get("#,##0"),r=s.filter((t=>t||0===t)),o={y:{data:s,format:"#,##0",labels:s.map((t=>void 0===t?void 0:i.Format(t))),range:{min:Math.min.apply(0,r),max:Math.max.apply(0,r)}},x:{data:[],range:{min:0,max:Math.max(0,s.length-1)}}};for(let t=0;t<o.y.data.length;t++)o.x.data.push(t);return o})),d=this.CommonData(c),u=Q.Get((null===(e=a[0].value)||void 0===e?void 0:e.format)||"General"),m=h.map((t=>u.Format(t))),f=(null===(s=t[1])||void 0===s?void 0:s.toString())||void 0;c[0].y.labels=(c[0].y.labels||[]).map(((t,e)=>m[e]+" "+t)),this.chart_data={type:"column",series2:c,scale:d.y.scale,title:f,y_labels:d.y.labels,x_labels:m,data_labels:!0}}Resize(){this.renderer.Resize()}Update(){this.renderer.Resize(),this.renderer.Prerender(),this.renderer.Clear();const t=new ss(0,0,this.renderer.size.width,this.renderer.size.height),e={top:Math.round(t.height)*this.margin.top,bottom:Math.round(t.height)*this.margin.bottom,left:Math.round(t.width)*this.margin.left,right:Math.round(t.width)*this.margin.right},s=this.chart_data.title;if(s&&this.renderer.RenderTitle(s,t,e.top,this.chart_data.title_layout||"top"),t.top+=e.top,t.left+=e.left,t.bottom-=e.bottom,t.right-=e.right,this.chart_data.legend&&this.chart_data.legend.length){let e=rs.top;this.chart_data.title&&(this.chart_data.title_layout&&"top"!==this.chart_data.title_layout||(e=rs.bottom));const s=this.chart_data.legend_position||e;this.renderer.Legend({labels:this.chart_data.legend,position:s,style:this.chart_data.legend_style,layout:s===rs.top||s===rs.bottom?is.horizontal:is.vertical,area:t})}if("histogram"===this.chart_data.type||"line"===this.chart_data.type||"area"===this.chart_data.type||"column"===this.chart_data.type||"bar"===this.chart_data.type||"scatter2"===this.chart_data.type){let s=[],i=0;if(this.chart_data.x_labels&&this.chart_data.x_labels.length&&(s=this.chart_data.x_labels.map((t=>{const e=this.renderer.MeasureText(t,["axis-label","x-axis-label"],!0);return i=Math.max(i,e.height),e}))),this.chart_data.y_labels&&this.chart_data.y_labels.length){const r=[];let o=0,a=0;const n="scatter2"===this.chart_data.type?this.chart_data.y_scale:this.chart_data.scale,l="bar"===this.chart_data.type?this.chart_data.y_labels.length:n.count+1;for(let t=0;t<l;t++){const e=this.renderer.MeasureText(this.chart_data.y_labels[t],["axis-label","y-axis-label"]);r.push({label:this.chart_data.y_labels[t],metrics:e}),o=Math.max(o,e.width),a=Math.max(a,e.height)}t.bottom=Math.round(t.bottom-a/2),t.top=Math.round(t.top+a/2),s.length&&(t.bottom-=i+e.bottom),"bar"===this.chart_data.type?this.renderer.RenderYAxisBar(t,t.left+o,r,["axis-label","y-axis-label"]):this.renderer.RenderYAxis(t,t.left+o,r,["axis-label","y-axis-label"]),t.left+=o+e.left}s.length&&this.chart_data.x_labels&&this.chart_data.x_labels.length&&(this.chart_data.y_labels&&(t.bottom+=i+e.bottom),this.renderer.RenderXAxis(t,"line"!==this.chart_data.type&&"area"!==this.chart_data.type&&"bar"!==this.chart_data.type&&"scatter2"!==this.chart_data.type,this.chart_data.x_labels,s,["axis-label","x-axis-label"]),t.bottom-=i+e.bottom)}switch(this.chart_data.type){case"scatter":this.renderer.RenderPoints(t,this.chart_data.x,this.chart_data.y,"mc mc-correlation series-1");break;case"scatter2":if(this.renderer.RenderGrid(t,this.chart_data.y_scale.count,this.chart_data.x_scale.count+1,"chart-grid"),this.chart_data.series){for(let e=0;e<this.chart_data.series.length;e++){const s=this.chart_data.series[e];this.renderer.RenderScatterSeries(t,s.x.data,s.y.data,this.chart_data.x_scale,this.chart_data.y_scale,!!this.chart_data.lines,!!this.chart_data.filled,!!this.chart_data.markers,!!this.chart_data.smooth,`scatter-plot series-${e+1}`)}if(this.chart_data.data_labels)for(let e=0;e<this.chart_data.series.length;e++){const s=this.chart_data.series[e];s.y.labels&&this.renderer.RenderDataLabels(t,s.x.data,s.y.data,this.chart_data.x_scale,this.chart_data.y_scale,s.y.labels,e+1)}}break;case"pie":case"donut":{const e=Math.min(t.height,t.width)/2*.9,s="pie"===this.chart_data.type?0:.8*e;this.renderer.RenderDonut(this.chart_data.slices,t.center,e,s,t,!0,"donut")}break;case"line":case"area":{const e=this.chart_data.scale;if(this.chart_data.series){const s=this.chart_data.x_scale?this.chart_data.x_scale.max:Math.max.apply(0,this.chart_data.series.map((t=>t.length))),i=this.chart_data.smooth?this.renderer.RenderSmoothLine:this.renderer.RenderLine;this.renderer.RenderGrid(t,this.chart_data.scale.count,this.chart_data.x_scale?this.chart_data.x_scale.count+1:s,"chart-grid");let r=0;for(const o of this.chart_data.series){const a=o.map((s=>{if(void 0!==s)return cs.ApplyScale(s,t.height,e)}));if(a.length<s)for(let t=a.length;t<s;t++)a.push(void 0);const n=["area"===this.chart_data.type?"chart-area":"chart-line",`series-${r+1}`];i.call(this.renderer,t,a,"area"===this.chart_data.type,this.chart_data.titles,n),r++}}}break;case"bar":{let e;if(this.renderer.RenderBarGrid(t,this.chart_data.scale.count,"chart-grid"),this.chart_data.series2){let s=0;const i=this.chart_data.series2.length;for(const t of this.chart_data.series2)s=Math.max(s,t.y.data.length);const r=t.height/s;let o=.7;"number"==typeof this.chart_data.space&&(o=Math.max(0,Math.min(1,1-this.chart_data.space)));const a=r*(1-o)/2,n=(r-2*a)/i;let l=0;if(this.chart_data.scale.min<0&&(l=cs.ApplyScale(0,t.width,this.chart_data.scale)),this.chart_data.round){const t=Math.floor(n/2);e=[0,t,t,0]}for(let s=0;s<i;s++){const i=this.chart_data.series2[s];for(let o=0;o<i.y.data.length;o++){const h=i.y.data[o];if("number"==typeof h){const i=Math.round(t.top+o*r+a)+s*n;let c=0,d=0,u=!1;l?h>0?(d=cs.ApplyScale(h+this.chart_data.scale.min,t.width,this.chart_data.scale),c=t.left+l):(d=cs.ApplyScale(this.chart_data.scale.min-h,t.width,this.chart_data.scale),c=t.left+l-d,u=!0):(d=cs.ApplyScale(h,t.width,this.chart_data.scale),c=t.left);const m=void 0;d&&this.renderer.RenderRectangle(new ss(c,i,c+d,i+n),e,["chart-column",`series-${s+1}`],m||void 0)}}}}}break;case"column":if(this.renderer.RenderGrid(t,this.chart_data.scale.count,0,"chart-grid"),this.chart_data.series2){let e=0;const s=this.chart_data.series2.length;for(const t of this.chart_data.series2)e=Math.max(e,t.y.data.length);const i=t.width/e;let r=.7;"number"==typeof this.chart_data.space&&(r=Math.max(0,Math.min(1,1-this.chart_data.space)));const o=i*(1-r)/2,a=(i-2*o)/s;let n,l=0;if(this.chart_data.scale.min<0&&(l=cs.ApplyScale(0,t.height,this.chart_data.scale)),this.chart_data.round){const t=Math.floor(a/2);n=[t,t,0,0]}for(let e=0;e<s;e++){const s=this.chart_data.series2[e];for(let r=0;r<s.y.data.length;r++){const h=s.y.data[r];if("number"==typeof h){const c=Math.round(t.left+r*i+o)+e*a;let d=0,u=0,m=!1;l?h>0?(d=cs.ApplyScale(h+this.chart_data.scale.min,t.height,this.chart_data.scale),u=t.bottom-d-l):(d=cs.ApplyScale(this.chart_data.scale.min-h,t.height,this.chart_data.scale),u=t.bottom-l,m=!0):(d=cs.ApplyScale(h,t.height,this.chart_data.scale),u=t.bottom-d);const f=void 0;if(d){const t=this.chart_data.data_labels&&s.y.labels?s.y.labels[r]:"",i={x:Math.round(c+a/2),y:Math.round(u-10)};this.renderer.RenderRectangle(new ss(c,u,c+a,u+d),n,["chart-column",`series-${e+1}`],f||void 0,t,i)}}}}}break;case"histogram":{this.renderer.RenderGrid(t,this.chart_data.scale.count,0,"chart-grid");const e=t.width/this.chart_data.count,s=e*(1-this.chart_data.column_width)/2;for(let i=0;i<this.chart_data.count;i++){const r=Math.round(t.left+i*e+s),o=e-2*s,a=cs.ApplyScale(this.chart_data.bins[i],t.height,this.chart_data.scale),n=t.bottom-a,l=this.chart_data.titles?this.chart_data.titles[i]:void 0;this.renderer.RenderRectangle(new ss(r,n,r+o,n+a),void 0,"chart-column series-1",l||void 0)}}}}IsCellData(t){return"object"==typeof t&&"object"==typeof t.address&&"number"==typeof t.address.row&&"number"==typeof t.address.column}}us.functions_registered=!1;const ms=(...t)=>t,fs={Group:{arguments:[{name:"Array...",metadata:!0}],fn:(...t)=>(t._type="group",t)},Series:{arguments:[{name:"Label"},{name:"X",metadata:!0},{name:"Y",metadata:!0}],fn:(...t)=>(t._type="series",t)},"Bar.Chart":{arguments:[{name:"Data",metadata:!0},{name:"Categories",metadata:!0},{name:"ChartTitle"}],fn:ms},"Line.Chart":{arguments:[{name:"y",metadata:!0},{name:"x",metadata:!0},{name:"ChartTitle"}],fn:ms},"Area.Chart":{arguments:[{name:"y",metadata:!0},{name:"x",metadata:!0},{name:"ChartTitle"}],fn:ms},"Pie.Chart":{arguments:[{name:"Values",metadata:!0},{name:"Labels"},{name:"Title"},{name:"Sort"},{name:"Label"}],fn:ms},"Donut.Chart":{arguments:[{name:"Values",metadata:!0},{name:"Labels",metadata:!0},{name:"Title"},{name:"Sort"},{name:"Label"}],fn:ms},"MC.Histogram":{arguments:[{name:"Reference Cell",metadata:!0},{name:"Title"}],fn:ms},"MC.Correlation":{arguments:[{name:"Reference Cell 1",metadata:!0},{name:"Reference Cell 2",metadata:!0},{name:"Title"}],fn:ms},"Scatter.Line":{arguments:[{name:"Data",metadata:!0},{name:"ChartTitle"}],fn:ms},"Column.Chart":{arguments:[{name:"Data",metadata:!0},{name:"Categories",metadata:!0},{name:"Chart Title"}],fn:ms}};var ps,_s=s(162);!function(t){t[t.automatic=0]="automatic",t[t.manual=1]="manual"}(ps||(ps={}));class gs extends O{constructor(t){super(),this.loaded=!1,this.calculation=ps.automatic,this.file_version=0,this.last_save_version=0,this.registered_libraries={},this.undo_pointer=0,this.undo_stack=[],this.options=Object.assign(Object.assign({},We),t);let e,s,i,r=this.options.network_document;this.options.storage_key&&!this.options.toll_initial_load&&(e=localStorage.getItem(this.options.storage_key)||void 0,e&&(s=Xe.LOCAL_STORAGE),!e&&this.options.alternate_document&&(r=this.options.alternate_document),window.addEventListener("beforeunload",(()=>{this.options.storage_key&&this.SaveLocalStorage(this.options.storage_key)}))),"string"==typeof t.container?i=document.getElementById(t.container):t.container&&(i=t.container);const o={expand:!1,insert_function_button:!1,in_cell_editor:!0,repaint_on_cell_change:!1};if(this.options.scale&&(o.initial_scale=this.options.scale),void 0!==this.options.formula_bar&&(o.formula_bar=this.options.formula_bar),this.options.expand_formula_button&&(o.expand_formula_button=this.options.expand_formula_button),this.options.scrollbars&&(o.scrollbars=this.options.scrollbars),void 0!==this.options.tab_bar&&(o.tab_bar=this.options.tab_bar),this.options.scale_control&&(o.scale_control=!0,o.tab_bar=!0,this.options.persist_scale)){!0===this.options.persist_scale?o.persist_scale_key="spreadsheet-scale":o.persist_scale_key="spreadsheet-scale-"+this.options.persist_scale;const t=localStorage.getItem(o.persist_scale_key);if(t)try{const e=JSON.parse(t);o.initial_scale=e.scale||1}catch(t){}}if(this.options.add_tab&&(o.add_tab=this.options.add_tab),this.options.delete_tab&&(o.delete_tab=this.options.add_tab),this.options.expand&&(o.expand=!0),this.grid=new Vt(o),t.headless&&(this.grid.headless=!0),i){this.node=document.createElement("div"),i.appendChild(this.node),i.addEventListener("keydown",this.HandleKeyDown.bind(this));const s=!(!e&&!t.network_document);this.grid.Initialize(this.node,s),this.options.dnd&&(this.node.addEventListener("dragenter",(t=>this.HandleDrag(t))),this.node.addEventListener("dragover",(t=>this.HandleDrag(t))),this.node.addEventListener("drop",(t=>this.HandleDrop(t)))),this.grid.grid_events.Subscribe((t=>{var e;switch(t.type){case"error":null===(e=this.dialog)||void 0===e||e.ShowDialog({type:Ze.error,message:t.message,title:t.title,timeout:3e3,close_box:!0});break;case"selection":this.UpdateSelection(t.selection),this.UpdateSelectionStyle(t.selection);break;case"sheet-change":this.OnSheetChange(t),this.UpdateSelectionStyle();break;case"data":{const e=this.last_selection;(this.calculation===ps.automatic?this.Recalculate(t):Promise.resolve()).then((()=>{this.DocumentChange(e)}))}break;case"style":this.DocumentChange(),this.UpdateDocumentStyles(!1),this.UpdateSelectionStyle();break;case"scale":this.RebuildAllAnnotations();break;case"annotation":if(t.annotation)switch(this.DocumentChange(),t.event){case"create":this.InflateAnnotation(t.annotation),this.calculator.UpdateAnnotations(t.annotation),this.grid.AnnotationUpdated(t.annotation);break;case"delete":this.calculator.RemoveAnnotation(t.annotation);break;case"update":t.annotation.update_callback?(t.annotation.update_callback(),this.grid.AnnotationUpdated(t.annotation)):console.info("annotation update event without update callback"),this.calculator.UpdateAnnotations(t.annotation);break;case"resize":t.annotation.resize_callback&&(t.annotation.resize_callback(),this.grid.AnnotationUpdated(t.annotation))}else console.info("annotation event without annotation");break;case"structure":this.DocumentChange(),t.rebuild_required&&this.calculator.Reset(),this.UpdateSelectionStyle();break;case"cell-event":this.HandleCellEvent(t)}})),this.options.prompt_save&&window.addEventListener("beforeunload",(t=>{this.last_save_version!==this.file_version&&(t.preventDefault(),t.returnValue="")}))}else console.info("not initializing grid; don't call UI functions"),this.grid.headless=!0;if(this.calculator=this.InitCalculator(),e?this.LoadDocument(JSON.parse(e),void 0,void 0,!!t.recalculate,void 0,void 0,s):r||this.calculator.RebuildClean(this.grid.model,!0),this.FlushUndo(),void 0!==t.show_headers&&this.grid.ShowHeaders(t.show_headers),this.options.scroll&&!this.options.network_document){const t=this.options.scroll;requestAnimationFrame((()=>{this.ScrollTo(t)}))}this.grid.SetAutocompleteFunctions(this.calculator.SupportedFunctions()),this.options.global_name&&(self[this.options.global_name]=this),r&&this.LoadNetworkDocument(r,this.options),i&&(this.dialog=new Je(i))}static SniffPath(){const t=document.querySelectorAll("script"),e=new RegExp("embedded-treb-bundle");for(let s=0;s<t.length;s++){const i=t[s].src;if(i&&e.test(i))return i&&/\?.*?engine/i.test(i)&&(this.enable_engine=!0),i&&/\?.*?format/i.test(i)&&(this.enable_formatter=!0),this.treb_embedded_script_path=i,void(this.treb_base_path=i.replace(new RegExp("embedded-treb-bundle.*$"),""))}}get modified(){return 1!==this.undo_stack.length}get document_name(){return this.grid.model.document_name}set document_name(t){this.grid.model.document_name=t,this.DocumentChange()}get user_data(){return this.grid.model.user_data}set user_data(t){this.grid.model.user_data=t,this.DocumentChange()}get parser(){return this.calculator.parser}get script_path(){let t="embedded-treb-bundle";gs.treb_language&&(t+="-"+gs.treb_language),/\.js$/.test(t)||(t+=".js");let e=gs.treb_base_path;return e&&(/\/$/.test(e)||(e+="/"),t=e+t),t}HandleCellEvent(t){var e;if("hyperlink"===(null===(e=t.data)||void 0===e?void 0:e.type)){const e="hyperlink invalid target",s=t.data.data||"";if("string"==typeof s){if(/^https{0,1}:\/\//i.test(s)){if(!this.options.hyperlinks)return void console.warn("hyperlinks are disabled");const t=document.createElement("a");return t.setAttribute("target",this.options.hyperlinks),t.setAttribute("href",s),t.setAttribute("noreferrer","true"),t.setAttribute("nofollow","true"),void t.click()}{const t=this.parser.Parse(s);if(t.expression){if("address"===t.expression.type)return(t.expression.sheet||t.expression.sheet_id)&&this.ActivateSheet(t.expression.sheet||t.expression.sheet_id),void this.Select(s);if("range"===t.expression.type)return(t.expression.start.sheet||t.expression.start.sheet_id)&&this.ActivateSheet(t.expression.start.sheet||t.expression.start.sheet_id),void this.Select(s)}}return void console.warn(e,2)}}}Batch(t,s=!1){return e(this,void 0,void 0,(function*(){const e=this.last_selection,i=this.grid.Batch(t,s);let r=!1,o=!1;for(const t of i)"data"===t.type?r=!0:"structure"===t.type&&t.rebuild_required&&(o=!0);o&&this.calculator.Reset(),(r||o)&&(yield this.Recalculate(),this.DocumentChange(e))}))}OnSheetChange(t){for(const e of t.activate.annotations)this.InflateAnnotation(e),this.calculator.UpdateAnnotations(e);this.UpdateAnnotations()}HandleDrag(t){if(t.dataTransfer&&t.dataTransfer.types)if(t.dataTransfer.types.some&&t.dataTransfer.types.some((t=>"Files"===t)))t.preventDefault();else for(let e=0;e<t.dataTransfer.types.length;e++)if("files"===t.dataTransfer.types[e])return void t.preventDefault()}HandleDrop(t){if(t.dataTransfer&&t.dataTransfer.files&&t.dataTransfer.files.length){t.preventDefault();const e=t.dataTransfer.files[0];/^image/.test(e.type)?this.InsertImage(e):this.LoadFileInternal(e,Xe.DRAG_AND_DROP).then((()=>{})).catch((t=>{var e;null===(e=this.dialog)||void 0===e||e.ShowDialog({title:"Error reading file",close_box:!0,message:"Please make sure your file is a valid XLSX, CSV or TREB file.",type:Ze.error,timeout:3e3}),console.error(t)}))}}Freeze(t=0,e=0){this.grid.Freeze(t,e,!0)}FreezeSelection(){const t=this.grid.GetSelection();if(t.empty)this.grid.Freeze(0,0);else{const e=t.area;e.entire_sheet||(e.entire_row?this.grid.Freeze(e.end.row+1,0):e.entire_column?this.grid.Freeze(0,e.end.column+1):this.grid.Freeze(e.end.row+1,e.end.column+1))}}GetFreeze(){return this.grid.GetFreeze()}UpdateTheme(t){this.grid.UpdateTheme(void 0,t),this.toolbar&&this.toolbar.UpdateTheme(this.grid.theme)}PostDocument(t,e){let s=!1,i=0;const r=JSON.stringify(this.SerializeDocument(!1,!0)),o=t=>{"ack"===t.data&&(s=!0,window.removeEventListener("message",o))};window.addEventListener("message",o);const a=(o=100)=>{if(i++>30)console.warn("timeout");else{try{t.postMessage(r,e)}catch(t){console.error(t)}setTimeout((()=>{s||a(o)}),o)}};t.focus(),a()}SetRange(t,e,s=!1,o=!1,a=!1){let n;if("string"==typeof t){const e=this.grid.model.named_ranges.Get(t);if(e)n=e.Clone();else{const e=t.split(":");n=e.length<2?new r(this.EnsureAddress(e[0])):new r(this.EnsureAddress(e[0]),this.EnsureAddress(e[1]))}}else n=i(t)?new r(t):new r(t.start,t.end);this.grid.SetRange(n,e,s,o,a)}ParseNumber(t){return st.TryParse(t).value}FormatNumber(t,e){return Q.Get(e).Format(t)}SetScale(t=1){this.grid.UpdateScale(t)}CreateChart(){return this.registered_libraries["treb-charts"]||(this.calculator.RegisterFunction(fs),this.registered_libraries["treb-charts"]=!0,this.grid.SetAutocompleteFunctions(this.calculator.SupportedFunctions())),new us}Evaluate(t){const e=this.parser.Parse(t);if(e&&e.expression){this.parser.Walk(e.expression,(t=>("address"!==t.type&&"range"!==t.type||this.calculator.ResolveSheetID(t),!0)));const t=this.calculator.CalculateExpression(e.expression);return Array.isArray(t)?t.map((t=>t.map((t=>t.value)))):t.value}}GetSheetID(t){if("number"==typeof t){const e=this.grid.model.sheets[t];if(e)return e.id}else{const e=t.toUpperCase();for(const t of this.grid.model.sheets)if(t.name.toUpperCase()===e)return t.id}}GetRange(t,e=!1,s=!1){if("string"==typeof t){const i=this.grid.model.named_ranges.Get(t);if(i)return this.grid.GetRange(i,e,s);{const i=t.split(":");return i.length<2?this.grid.GetRange(new r(this.EnsureAddress(i[0])),e,s):this.grid.GetRange(new r(this.EnsureAddress(i[0]),this.EnsureAddress(i[1])),e,s)}}return i(t)?this.grid.GetRange(t,e,s):this.grid.GetRange(new r(t.start,t.end),e,s)}DeleteSheet(t){if(t){t=t.toLowerCase();for(let e=0;e<this.grid.model.sheets.length;e++)if(this.grid.model.sheets[e].name.toLowerCase()===t){this.grid.DeleteSheet(e);break}}else this.grid.DeleteSheet();this.calculator.Reset()}AddSheet(t){this.grid.AddSheet(t),this.calculator.Reset()}InsertAnnotation(t,e="treb-chart",s){let i;if(s)if(y.IsRectangle(s))i=s;else if("string"==typeof s){let t;if(t=this.grid.model.named_ranges.Get(s),!t){const e=s.split(":");t=e.length<2?new r(this.EnsureAddress(e[0])):new r(this.EnsureAddress(e[0]),this.EnsureAddress(e[1]))}t&&(i=t)}const{x:o,y:a}=this.grid.GetScrollOffset(),n=this.grid.layout.scale||1;this.grid.CreateAnnotation({type:e,formula:t},void 0,void 0,i||{top:a/n+30,left:o/n+30,width:300,height:300})}InsertImage(t){var s;return e(this,void 0,void 0,(function*(){if(t||(t=yield this.SelectFile(".png, .jpg, .jpeg, .gif, .svg")),!t)return;if(this.options.max_file_size&&t.size>this.options.max_file_size)return void(null===(s=this.dialog)||void 0===s||s.ShowDialog({type:Ze.error,message:"This file exceeds the allowed image size. Please try a smaller image.",title:"Error adding image",timeout:3e3,close_box:!0}));const e=t;yield new Promise(((t,s)=>{const i=new FileReader;i.onload=()=>{try{if(i.result){let t;if("string"==typeof i.result)t=i.result;else{t="";const e=new Uint8Array(i.result);for(let s=0;s<e.byteLength;s++)t+=String.fromCharCode(e[s])}const e=document.createElement("img");e.src=t;const s=this.grid.CreateAnnotation({type:"image",formula:""},void 0,void 0,{top:30,left:30,width:e.width||300,height:e.height||300});s.data.src=t,s.data.original_size={width:e.width||300,height:e.height||300}}t()}catch(t){s(t)}},i.onabort=()=>{s("Aborted")},i.onerror=()=>{s("File error")},setTimeout((()=>{i.readAsDataURL(e)}),100)}))}))}SetLink(t,e=""){t=this.EnsureAddress(t),this.grid.SetLink(t,e)}ShowSheet(t=0,e=!0){this.grid.ShowSheet(t,e)}ActivateSheet(t){this.grid.ActivateSheet(t)}SetColumnWidth(t,e){this.grid.SetColumnWidth(t,e)}SetRowHeight(t,e){this.grid.SetRowHeight(t,e)}EnsureAddress(t){const e={row:0,column:0};if("string"==typeof t){const s=this.parser.Parse(t);if(s.expression&&"address"===s.expression.type)this.calculator.ResolveSheetID(s.expression),e.row=s.expression.row,e.column=s.expression.column,e.sheet_id=s.expression.sheet_id;else if(s.expression&&"range"===s.expression.type)this.calculator.ResolveSheetID(s.expression),e.row=s.expression.start.row,e.column=s.expression.start.column,e.sheet_id=s.expression.start.sheet_id;else if(s.expression&&"identifier"===s.expression.type){const t=this.grid.model.named_ranges.Get(s.expression.name);if(t)return t.start}}else e.row=t.row||0,e.column=t.column||0;return e}ScrollTo(t,e=!0,s=!0){this.grid.ScrollTo(this.EnsureAddress(t),e,s)}InsertRow(){this.grid.InsertRow()}InsertColumn(){this.grid.InsertColumn()}DeleteRows(){this.grid.DeleteRows()}DeleteColumns(){this.grid.DeleteColumns()}ApplyBorders(t,e=1){this.grid.ApplyBorders(void 0,t,void 0,e)}MergeCells(){this.grid.MergeSelection()}UnmergeCells(){this.grid.UnmergeSelection()}ImportXLSX(t,s){return e(this,void 0,void 0,(function*(){if(!this.export_worker){const t="embedded-treb-export-worker";this.export_worker=yield this.LoadWorker(t)}return new Promise(((e,i)=>{var r;this.export_worker?(null===(r=this.dialog)||void 0===r||r.ShowDialog({message:"Importing XLSX..."}),this.export_worker.onmessage=t=>{var r;return t.data?"error"===t.data.status?i(t.data.error||"unknown error"):(this.grid.FromImportData(t.data.results),this.ResetInternal(),this.grid.Update(),this.calculator.AttachModel(this.grid.model),this.Publish({type:"load",source:s}),this.UpdateDocumentStyles(),this.InflateAnnotations(),null===(r=this.dialog)||void 0===r||r.HideDialog(),void e()):i("unknown error (missing data)")},this.export_worker.onerror=t=>{console.error("import worker error"),console.info(t),i(t)},this.export_worker.postMessage({command:"import",data:t})):i("worker failed")}))}))}ExportBlob(){return e(this,void 0,void 0,(function*(){if(!this.export_worker){const t="embedded-treb-export-worker";this.export_worker=yield this.LoadWorker(t)}return new Promise(((t,e)=>{if(this.export_worker){this.export_worker.onmessage=e=>{t(e.data?e.data.blob:void 0)},this.export_worker.onerror=t=>{console.error("export worker error"),console.info(t),e(t)};const s=this.grid.Serialize({rendered_values:!0,expand_arrays:!0,export_colors:!0,decorated_cells:!0});s.decimal_mark=g.decimal_separator,this.export_worker.postMessage({command:"export",sheet:s})}else e("worker failed")}))}))}Export(){this.ExportBlob().then((t=>{let e="export";this.grid.model.document_name&&(e=this.grid.model.document_name.toLowerCase().replace(/\s+/g,"-")),t&&(_s.saveAs(t,e+".xlsx",{autoBom:!1}),this.last_save_version=this.file_version)})).catch((t=>{var e;throw/invalid uri/i.test(t.message)&&(null===(e=this.dialog)||void 0===e||e.ShowDialog({title:"Error exporting file",close_box:!0,message:"The worker cannot run from the filesystem, please use a web server.",timeout:3e3,type:Ze.error})),t}))}GetSelection(t=!1){const e=this.grid.GetSelection();if(e.empty)return"";const s=e.area.spreadsheet_label;if(t){const t=this.grid.active_sheet.name;return R.test(t)?`'${t}'!${s}`:`${t}!${s}`}return s}GetSelectionReference(){return this.grid.GetSelection()}Focus(){this.grid.Focus()}Resize(){this.grid.UpdateLayout(),this.Publish({type:"resize"})}ResetInternal(){this.calculator.Reset(),this.FlushUndo(),this.file_version=this.last_save_version=0}Reset(){this.grid.Clear(),this.ResetInternal(),this.calculator.AttachModel(this.grid.model),this.Publish({type:"reset"})}Select(t){let e;if(t)if("string"==typeof t){const s=this.grid.model.named_ranges.Get(t);if(s)e=s.Clone();else{const s=t.split(":");e=s.length<2?new r(this.EnsureAddress(s[0])):new r(this.EnsureAddress(s[0]),this.EnsureAddress(s[1]))}}else e=i(t)?new r(t):new r(t.start,t.end);this.grid.SelectRange(e)}ApplyStyle(t,e={},s=!0){let o;if(t)if("string"==typeof t){const e=this.grid.model.named_ranges.Get(t);if(e)o=e.Clone();else{const e=t.split(":");o=e.length<2?new r(this.EnsureAddress(e[0])):new r(this.EnsureAddress(e[0]),this.EnsureAddress(e[1]))}}else o=i(t)?new r(t):new r(t.start,t.end);this.grid.ApplyStyle(o,e,s)}Fetch(t){return e(this,void 0,void 0,(function*(){return new Promise(((e,s)=>{const i=new XMLHttpRequest;i.onload=()=>e(i.response),i.onerror=()=>s("load error"),i.ontimeout=()=>s("timeout"),i.open("GET",t),i.send()}))}))}LoadFromLocalStorage(t){this.options.storage_key=t;const e=localStorage.getItem(t);if(e)try{const t=JSON.parse(e);return this.LoadDocument(t,void 0,void 0,void 0,void 0,void 0,Xe.LOCAL_STORAGE),!0}catch(t){console.error(t)}return!1}LoadNetworkDocument(t,s){var i;return e(this,void 0,void 0,(function*(){const e=s?s.scroll:void 0,r=!!s&&!!s.recalculate,o=s?s.sheet:void 0,a=/csv(?:$|\?|&)/i.test(t),n=/tsv(?:$|\?|&)/i.test(t);try{let s=yield this.Fetch(t);if("string"==typeof s)if(a)this.LoadCSV(s,Xe.NETWORK_FILE);else{if(n)throw new Error("tsv not supported (TODO)");{"&&&START&&&"===s.substr(0,11)?s=s.substr(11):"for(;;);"===s.substr(0,8)&&(s=s.substr(8));const t=JSON.parse(s);this.LoadDocument(t,e,void 0,r,o,void 0,Xe.NETWORK_FILE)}}}catch(e){console.info("error loading network document",t),console.error(e),null===(i=this.dialog)||void 0===i||i.ShowDialog({title:"Error loading file",close_box:!0,message:"The network document returned an error",type:Ze.error,timeout:3e3}),this.Reset()}}))}SelectFile(t){return new Promise((e=>{const s=document.createElement("input");let i,r;s.type="file",t&&(s.accept=t);const o=()=>{window.removeEventListener("focus",o),r=setTimeout(i,250)},a=()=>{r&&clearTimeout(r),i(s.files?s.files[0]:void 0)};i=t=>{s.removeEventListener("change",a),window.removeEventListener("focus",o),e(t)},s.addEventListener("change",a),window.addEventListener("focus",o),s.click()}))}LoadLocalFile(){var t;return e(this,void 0,void 0,(function*(){const e=yield this.SelectFile(".treb, .csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/json");if(e)try{return yield this.LoadFileInternal(e,Xe.LOCAL_FILE),!0}catch(e){return null===(t=this.dialog)||void 0===t||t.ShowDialog({title:"Error reading file",close_box:!0,message:"Please make sure your file is a valid XLSX, CSV or TREB file.",type:Ze.error,timeout:3e3}),!1}return!1}))}LoadFileInternal(t,e){if(!t)return Promise.resolve();const s=new FileReader;return new Promise(((i,r)=>{const o=t=>{s.onload=null,s.onabort=null,s.onerror=null,t?r(t):i()};s.onload=()=>{try{if(s.result)if(/\.csv$/i.test(t.name))this.LoadCSV(s.result,e);else{if(/\.xls[xm]$/i.test(t.name)){let t;if("string"==typeof s.result)t=s.result;else{t="";const e=new Uint8Array(s.result);for(let s=0;s<e.byteLength;s++)t+=String.fromCharCode(e[s])}return void this.ImportXLSX(t,e).then((()=>o())).catch((t=>o(t)))}{const t=JSON.parse(s.result);this.LoadDocument(t,void 0,void 0,void 0,void 0,void 0,e)}}o()}catch(t){o(t)}},s.onabort=()=>{o("Aborted")},s.onerror=()=>{o("File error")},setTimeout((()=>{/\.xlsx$/i.test(t.name)?s.readAsBinaryString?s.readAsBinaryString(t):s.readAsArrayBuffer(t):s.readAsText(t)}),100)}))}ExportDelimited(t={}){if(!(t=Object.assign(Object.assign({},qe),t)).delimiter||","!==t.delimiter&&"\t"!==t.delimiter)throw new Error("invalid delimiter");let e=this.grid.model.active_sheet;switch(typeof t.sheet){case"undefined":break;case"string":e=void 0;for(const s of this.grid.model.sheets)s.name===t.sheet&&(e=s);break;case"number":e=this.grid.model.sheets[t.sheet];break;default:e=void 0}if(!e)throw new Error("invalid sheet identifier");const s=e.cells.toJSON({nested:!1,expand_arrays:!0,calculated_value:!0}),i=[];for(let t=0;t<s.columns;t++)i.push("");const r=[];for(let t=0;t<s.rows;t++)r.push(i.slice(0));const o=new RegExp(`[\t\n\r"${t.delimiter}]`);if(f(s.data))for(const e of s.data){let s="";t.formulas||void 0===e.calculated?"string"==typeof e.value&&"'"===e.value[0]?s=e.value.substr(1):void 0!==e.value&&(s=e.value.toString()):s=e.calculated.toString(),o.test(s)&&(s=s.replace(/"/g,'""'),s='"'+s+'"'),r[e.row][e.column]=s}return r.map((e=>e.join(t.delimiter))).join("\r\n")}SaveLocalFile(t=Ke.treb,e=!0,s=!1,i){const r=this.grid.model.document_name||"document";let o,a;const n=t.split(/\./).filter((t=>t.trim().length)),l=n.length?n[n.length-1].toLowerCase():Ke.treb;switch(n.length<=1&&(t=(l===Ke.csv||l===Ke.tsv)&&this.grid.model.sheets.length>1?(r+"-"+this.grid.model.active_sheet.name).toLowerCase().replace(/\W+/g,"-")+"."+l:r.toLowerCase().replace(/\W+/g,"-")+"."+l),l){case Ke.csv:a=this.ExportDelimited({delimiter:","});break;case Ke.tsv:a=this.ExportDelimited({delimiter:"\t"});break;case Ke.treb:case Ke.json:o=this.SerializeDocument(e,void 0,i),a=JSON.stringify(o,void 0,s?2:void 0),this.last_save_version=this.file_version;break;default:throw new Error("invalid file type")}if(a&&t){const e=new Blob([a],{type:"text/plain;charset=utf-8"});_s.saveAs(e,t,{autoBom:!1})}}LoadCSV(t,e){this.grid.FromCSV(t),this.ResetInternal(),this.grid.Update(!0),this.Publish({type:"load",source:e}),this.UpdateDocumentStyles()}LoadDocument(t,e,s=!0,i=!1,r,o,a){if(o&&t.sheet_data){const e=Array.isArray(t.sheet_data)?t.sheet_data:[t.sheet_data];for(const t of e)if(t.id===o.target.sheet_id){t.selection=o;break}}this.ImportDocumentData(t,r),this.calculator.Reset(),t.rendered_values&&!i?(this.grid.Update(),this.calculator.RebuildClean(this.grid.model,!0)):(console.info("load recalc"),this.Recalculate()),this.InflateAnnotations(),s&&this.FlushUndo(),this.Publish({type:"load",source:a}),this.UpdateDocumentStyles(),this.loaded=!0,e&&F().then((()=>{this.ScrollTo(e)}))}SetNote(t){this.grid.SetNote(void 0,t)}ClearName(t){this.grid.SetName(t)}DefineName(t,e){if(e)this.grid.SetName(t,new r(e.start,e.end));else{const e=this.grid.GetSelection();e.empty||this.grid.SetName(t,e.area)}}RemoveFunction(t){const e=t.toUpperCase(),s=Object.keys(this.grid.model.macro_functions);for(const t of s)t.toUpperCase()===e&&delete this.grid.model.macro_functions[t];this.grid.SetAutocompleteFunctions(this.calculator.SupportedFunctions())}DefineFunction(t,e="",s="0"){if(!t.length||/^[^A-Za-z]/.test(t)||/[^\w_.]/.test(t))throw new Error("invalid function name");"string"==typeof e&&(e=e?e.split(this.parser.argument_separator).map((t=>t.trim())):[]);for(const t of e)if(!t.length||/^[^A-Za-z]/.test(t)||/[^\w_.]/.test(t))throw new Error("invalid argument name");this.RemoveFunction(t),this.grid.model.macro_functions[t.toUpperCase()]={name:t,function_def:s,argument_names:e,expression:this.parser.Parse(s).expression},this.grid.SetAutocompleteFunctions(this.calculator.SupportedFunctions())}UpdateAnnotations(){for(const t of this.grid.model.active_sheet.annotations)if(t.temp.vertex){const e=t.temp.vertex;e.state_id!==t.temp.state&&(t.temp.state=e.state_id,t.update_callback&&t.update_callback(),this.grid.AnnotationUpdated(t))}}SetHeadless(t=!0){this.grid.headless!==t&&(this.grid.headless=t,t||(this.grid.Update(!0),this.RebuildAllAnnotations()))}RebuildAllAnnotations(){for(const t of this.grid.model.active_sheet.annotations)this.InflateAnnotation(t),t.resize_callback&&t.resize_callback(),t.update_callback&&t.update_callback()}InflateAnnotations(){for(const t of this.grid.model.active_sheet.annotations)this.InflateAnnotation(t)}InflateAnnotation(t){var e;if(!this.grid.headless)if(t.inflated)t.dirty&&(t.resize_callback&&t.resize_callback(),t.dirty=!1);else if(t.inflated=!0,t.dirty&&(t.dirty=!1),t.content_node&&t.data)if("treb-chart"===t.type){const s=new us;s.Initialize(t.content_node),this.registered_libraries["treb-charts"]||(this.calculator.RegisterFunction(fs),this.registered_libraries["treb-charts"]=!0,this.grid.SetAutocompleteFunctions(this.calculator.SupportedFunctions()));const i=()=>{if(t.formula){const e=this.parser.Parse(t.formula);if(e&&e.expression&&"call"===e.expression.type){this.parser.Walk(e.expression,(t=>("address"!==t.type&&"range"!==t.type||this.calculator.ResolveSheetID(t),!0)));const t=e.expression.name.toLowerCase(),i=this.calculator.CalculateExpression(e.expression);s.Exec(t,i)}}s.Update()};t.resize_callback=()=>{this.grid.headless||(s.Resize(),s.Update())},t.update_callback=()=>{this.grid.headless||i()},(null===(e=t.node)||void 0===e?void 0:e.parentElement)&&(this.grid.headless||i())}else if("image"===t.type){const e=document.createElement("img");"string"==typeof t.data.src&&/^data:image/i.test(t.data.src)&&e.setAttribute("src",t.data.src),e.style.width="100%",e.style.height="100%",t.content_node.appendChild(e)}}SerializeDocument(t=!0,e=!0,s={}){const i=Object.assign(Object.assign({shrink:!0},s),{rendered_values:e}),r=this.grid.Serialize(i),o=Object.assign({app:"treb",version:"10.12.12",name:this.grid.model.document_name,user_data:this.grid.model.user_data,decimal_mark:g.decimal_separator},r);return e&&(o.rendered_values=!0),o}Recalculate(t){return e(this,void 0,void 0,(function*(){let e;t&&"data"===t.type&&t.area&&(e=t.area),yield this.calculator.Calculate(this.grid.model,e),this.grid.Update(!0),this.UpdateAnnotations(),this.Publish({type:"data"})}))}SaveLocalStorage(t){if(t||(t=this.options.storage_key),!t)return void console.info("not saving, no key");const e=JSON.stringify(this.SerializeDocument(!0,!0,{rendered_values:!0,expand_arrays:!0}));localStorage.setItem(t,e)}DocumentChange(t){F().then((()=>{const e=JSON.stringify(this.SerializeDocument(!1,!0,{rendered_values:!0,expand_arrays:!0}));this.options.storage_key&&localStorage.setItem(this.options.storage_key,e),this.options.undo&&this.PushUndo(e,t),this.Publish({type:"document-change"})}))}PushUndo(t,e){const s=e||this.last_selection;this.undo_stack[this.undo_pointer-1]&&(this.undo_stack[this.undo_pointer-1].selection=s),t||(t=JSON.stringify(this.SerializeDocument(!1,!0,{rendered_values:!0,expand_arrays:!0}))),this.undo_stack[this.undo_pointer++]={data:t,selection:void 0};const i=this.undo_stack.length;if(i>16){const t=i-16;this.undo_stack=this.undo_stack.slice(t),this.undo_pointer-=t}this.file_version++}FlushUndo(t=!0){this.undo_stack=[],this.undo_pointer=0,t&&this.PushUndo(),this.last_save_version=this.file_version=0}Undo(){if(this.undo_pointer<=1)return void console.warn("nothing to undo");const t=this.undo_stack[--this.undo_pointer-1],e=t.selection?JSON.parse(t.selection):void 0;this.LoadDocument(JSON.parse(t.data),void 0,!1,void 0,void 0,e,Xe.UNDO),this.file_version--}UpdateSelection(t){this.last_selection=JSON.stringify(t),this.Publish({type:"selection"})}About(){var t;null===(t=this.dialog)||void 0===t||t.ShowDialog({type:Ze.about})}CreateToolbar(t){return this.toolbar=new es(t,this.options,this.grid.theme),this.toolbar.Subscribe((t=>{var e,s,i,r,o,a,n;let l={};const h=t=>{const e=this.grid.GetSelection();if(e&&!e.empty){const s=e.area.spreadsheet_label;this.InsertAnnotation(`=${t}(${s},,"${s}")`)}};if("format"===t.type)l.number_format=t.format||"General";else if("button"===t.type)switch(t.command){case"update-comment":this.SetNote((null===(e=t.data)||void 0===e?void 0:e.comment)||"");break;case"clear-comment":this.SetNote("");break;case"border":{let e=1,r=((null===(s=t.data)||void 0===s?void 0:s.border)||"").replace(/^border-/,"");"double-bottom"===r&&(r="bottom",e=2),r&&this.grid.ApplyBorders2(void 0,r,(null===(i=t.data)||void 0===i?void 0:i.color)||void 0,e)}break;case"color":case"background-color":case"foreground-color":case"border-color":switch(null===(r=t.data)||void 0===r?void 0:r.target){case"border":l.border_top_fill=l.border_bottom_fill=l.border_left_fill=l.border_right_fill=(null===(o=t.data)||void 0===o?void 0:o.color)||{};break;case"foreground":l.text=(null===(a=t.data)||void 0===a?void 0:a.color)||{theme:1};break;case"background":l.fill=(null===(n=t.data)||void 0===n?void 0:n.color)||{}}break;case"insert-row":this.grid.InsertRow();break;case"insert-column":this.grid.InsertColumn();break;case"delete-row":this.grid.DeleteRows();break;case"delete-column":this.grid.DeleteColumns();break;case"insert-sheet":this.grid.InsertSheet();break;case"delete-sheet":this.grid.DeleteSheet();break;case"freeze":{const t=this.grid.GetFreeze();t.rows||t.columns?this.Freeze(0,0):this.FreezeSelection()}break;case"insert-image":this.InsertImage();break;case"donut-chart":h("Donut.Chart");break;case"column-chart":h("Column.Chart");break;case"bar-chart":h("Bar.Chart");break;case"line-chart":h("Line.Chart");break;case"increase-decimal":case"decrease-decimal":if(this.active_selection_style){const e=Q.Get(this.active_selection_style.number_format||"General");if(e.date_format)break;const s=new Y(e.pattern);"increase-decimal"===t.command?s.IncreaseDecimal():s.DecreaseDecimal(),l.number_format=s.toString()}break;case"merge":this.grid.MergeSelection();break;case"unmerge":this.grid.UnmergeSelection();break;case"lock":l={locked:!this.active_selection_style||!this.active_selection_style.locked};break;case"wrap":l={wrap:!this.active_selection_style||!this.active_selection_style.wrap};break;case"align-left":l={horizontal_align:v.HorizontalAlign.Left};break;case"align-center":l={horizontal_align:v.HorizontalAlign.Center};break;case"align-right":l={horizontal_align:v.HorizontalAlign.Right};break;case"align-top":l={vertical_align:v.VerticalAlign.Top};break;case"align-middle":l={vertical_align:v.VerticalAlign.Middle};break;case"align-bottom":l={vertical_align:v.VerticalAlign.Bottom};break;case"reset":this.Reset();break;case"import-desktop":this.LoadLocalFile();break;case"save-json":this.SaveLocalFile();break;case"save-csv":this.SaveLocalFile(Ke.csv);break;case"export-xlsx":this.Export();break;case"recalculate":this.Recalculate();break;default:console.info("unhandled",t.command)}Object.keys(l).length&&this.grid.ApplyStyle(void 0,l,!0),this.Focus()})),this.UpdateDocumentStyles(!1),this.UpdateSelectionStyle(void 0,!1),this.toolbar}UpdateSelectionStyle(t,e=!0){var s;const i=this.grid.GetFreeze(),r={frozen:!!i.rows||!!i.columns};if(t||(t=this.grid.GetSelection()),t&&!t.empty){r.selection=t,r.merge=!1;let e=this.grid.model.active_sheet.CellData(t.target);r.merge=!!e.merge_area,r.merge&&e.merge_area&&(e.merge_area.start.row!==t.target.row||e.merge_area.start.column!==t.target.column)&&(e=this.grid.model.active_sheet.CellData(e.merge_area.start)),this.active_selection_style=e.style,r.comment=e.note,r.style=e.style?Object.assign({},e.style):void 0}else this.active_selection_style={};null===(s=this.toolbar)||void 0===s||s.UpdateState(r)}UpdateDocumentStyles(t=!0){if(!this.toolbar)return;const e={},s={};for(const t of this.grid.model.sheets)t.NumberFormatsAndColors(s,e);this.toolbar.UpdateDocumentStyles(Object.keys(e),Object.keys(s),t)}InitCalculator(){return new Be}ConvertLocale(t){var e;const s=new N;let i,r;"."===t.decimal_mark?(s.decimal_mark=k.Period,s.argument_separator=M.Comma,i=k.Comma,r=M.Semicolon):(s.decimal_mark=k.Comma,s.argument_separator=M.Semicolon,i=k.Period,r=M.Comma);const o=t=>{const e=s.Parse(t);if(e.expression)return"="+s.Render(e.expression,void 0,"",i,r)};if(t.macro_functions)for(const e of t.macro_functions){const t=o(e.function_def);t&&(e.function_def=t)}if(t.sheet_data){const s=Array.isArray(t.sheet_data)?t.sheet_data:[t.sheet_data];for(const t of s){if(t.annotations)for(const e of t.annotations)if(e.formula){const t=o(e.formula);t&&(e.formula=t)}if(null===(e=t.data)||void 0===e?void 0:e.length)for(const e of t.data){const t=m(e)?[e]:e.cells;for(const e of t)if(e.value&&"string"==typeof e.value&&"="===e.value[0]){const t=o(e.value.slice(1));t&&(e.value=t)}}}}}CompareVersions(t="",e=""){const s=t.split(".").map((t=>Number(t)||0)).concat([0,0,0]),i=e.split(".").map((t=>Number(t)||0)).concat([0,0,0]),r=["major","minor","patch"],o={match:0};for(let t=0;t<3;t++)if(s[t]!==i[t]){o.match=s[t]>i[t]?1:-1,o.level=r[t];break}return o}ImportDocumentData(t,e){let s=[];const i=this.CompareVersions(t.version,"10.12.12");i.match>0&&("major"!==i.level&&"minor"!==i.level||console.warn(`The file you are opening was created with a newer version of TREB (${t.version} vs 10.12.12).\nYou may encounter compatibility errors.`)),t.sheet_data&&(Array.isArray(t.sheet_data)?s=t.sheet_data:s.push(t.sheet_data)),t.decimal_mark&&t.decimal_mark!==g.decimal_separator&&this.ConvertLocale(t),this.grid.UpdateSheets(s,void 0,e||t.active_sheet);const r=this.grid.model;r.document_name=t.name,r.user_data=t.user_data,r.named_ranges.Reset();let o=t.named_ranges;if(!o&&s[0]&&s[0].named_ranges&&(o=s[0].named_ranges),o&&r.named_ranges.Deserialize(o),r.macro_functions={},t.macro_functions)for(const e of t.macro_functions)r.macro_functions[e.name.toUpperCase()]=Object.assign(Object.assign({},e),{expression:this.parser.Parse(e.function_def||"").expression})}LoadWorker(t){return e(this,void 0,void 0,(function*(){let e;gs.treb_language&&(t+="-"+gs.treb_language),/\.js$/.test(t)||(t+="-10.12.12.js");let s=gs.treb_base_path;if(s&&(/\/$/.test(s)||(s+="/"),t=s+t),/^(http:|https:|\/\/)/.test(t)){const s=yield this.Fetch(t);e=new Worker(URL.createObjectURL(new Blob([s],{type:"application/javascript"})))}else{if(/^file:/.test(t))throw new Error("invalid URI");e=new Worker(t)}return e}))}HandleKeyDown(t){!t.ctrlKey||"KeyZ"!==t.code&&"z"!==t.key||(t.stopPropagation(),t.preventDefault(),this.Undo())}}gs.treb_base_path="",gs.treb_language="",gs.treb_script_host="",gs.treb_embedded_script_path="",gs.enable_engine=!1,gs.enable_formatter=!1;const ys=t=>{const e=4+t.data.length,s=new Float64Array(e);return s[0]=t.column,s[1]=t.row,s[2]=t.sheet_id,s[3]=t.data.length,s.set(t.data,4),s},vs=t=>t.length===3+t[2]?{column:t[0],row:t[1],sheet_id:0,data:t.subarray(3)}:{column:t[0],row:t[1],sheet_id:t[2],data:t.subarray(4)},bs=t=>{if(1===t.length)return t[0];let e=0,s=0;for(const i of t)e=Math.max(e,i.elapsed),s+=i.trials;const i=t[0],r=i.results.map((t=>{const e=new Float64Array(4+s);return e.set(new Float64Array(t)),e}));let o=i.trials+4;for(let e=1;e<t.length;e++){const s=t[e];s.results.forEach(((t,e)=>{const s=new Float64Array(t),i=r[e];if(i[0]!==s[0]||i[1]!==s[1]||i[2]!==s[2])throw new Error("mismatch in result address");i.set(s.subarray(4),o)})),o+=s.trials}return{elapsed:e,trials:s,results:r.map((t=>t.buffer))}};var ws,Cs=s(736);!function(t){t[t.Null=0]="Null",t[t.Prep=1]="Prep",t[t.Simulation=2]="Simulation",t[t.Post=3]="Post"}(ws||(ws={}));const xs=t=>{const e=Cs.MC.Uniform(t),s=[];for(let e=0;e<t;e++)s[e]=e;for(let i=0;i<t;i++){const r=i+Math.floor(e[i]*(t-i)),o=s[i];s[i]=s[r],s[r]=o}return s};class Ss{constructor(){this.address={row:0,column:0},this.volatile=!1,this.iteration=0,this.iterations=0,this.call_index=0,this.lhs=!1,this.state=ws.Null,this.results=[],this.elapsed=0,this.trials=0,this.distributions=[],this.correlated_distributions={},this.functions={"Multivariate.Normal":{description:"Returns a sample from the multivariate normal distribution",simulation_volatile:!0,arguments:[{name:"range of values",description:"Set of Correlated Distributions (N)",address:!0},{name:"correlation",description:"Correlation Matrix (NxN)"},{name:"mean",description:"Distribution Mean",default:0},{name:"stdev",description:"Standard Deviation",default:1}],fn:this.multivariate_normal.bind(this),category:["RiskAMP Random Distributions"],extension:!0},"Multivariate.LogNormal":{description:"Returns a sample from the multivariate log-normal distribution",simulation_volatile:!0,arguments:[{name:"range of values",description:"Set of Correlated Distributions (N)",address:!0},{name:"correlation",description:"Correlation Matrix (NxN)"},{name:"mean",description:"Mean of underlying Normal distribution",default:0},{name:"stdev",description:"Standard Deviation of underlying Normal distribution",default:1}],fn:this.multivariate_lognormal.bind(this),category:["RiskAMP Random Distributions"],extension:!0},"Multivariate.Uniform":{description:"Returns a sample from the multivariate uniform distribution",simulation_volatile:!0,arguments:[{name:"range of values",description:"Set of Correlated Distributions (N)",address:!0},{name:"correlation",description:"Correlation Matrix (NxN)"},{name:"min",description:"Minimum Value",default:0},{name:"max",description:"Maximum Value",default:1}],fn:this.multivariate_uniform.bind(this),category:["RiskAMP Random Distributions"],extension:!0},"Multivariate.Beta":{description:"Returns a sample from the multivariate beta distribution",simulation_volatile:!0,arguments:[{name:"range of values",description:"Set of Correlated Distributions (N)",address:!0},{name:"correlation",description:"Correlation Matrix (NxN)"},{name:"w",description:"Shape Parameter"},{name:"v",description:"Shape Parameter"}],fn:this.multivariate_beta.bind(this),category:["RiskAMP Random Distributions"],extension:!0},"Multivariate.PERT":{description:"Returns a sample from the multivariate PERT distribution",simulation_volatile:!0,arguments:[{name:"range of values",description:"Set of Correlated Distributions (N)",address:!0},{name:"correlation",description:"Correlation Matrix (NxN)"},{name:"min",description:"Minimum Value"},{name:"mode",description:"Most-Likely Value"},{name:"max",description:"Maximum Value"},{name:"lambda",default:4}],fn:this.multivariate_pert.bind(this),category:["RiskAMP Random Distributions"],extension:!0},"Multivariate.Triangular":{description:"Returns a sample from the multivariate triangular distribution",simulation_volatile:!0,arguments:[{name:"range of values",description:"Set of Correlated Distributions (N)",address:!0},{name:"correlation",description:"Correlation Matrix (NxN)"},{name:"min",description:"Minimum Value"},{name:"mode",description:"Most-Likely Value"},{name:"max",description:"Maximum Value"}],fn:this.multivariate_triangular.bind(this),category:["RiskAMP Random Distributions"],extension:!0},UniformRangeSample:{description:"Returns one of a set of values, with equal probability and with replacement",simulation_volatile:!0,arguments:[{name:"range",description:"Range of Values"}],fn:this.uniformrangesample.bind(this),category:["RiskAMP Random Distributions"],extension:!0},SampleValue:{description:"Returns one of a set of values, with equal probability and with replacement",simulation_volatile:!0,arguments:[{name:"range",description:"Range of Values"}],fn:this.samplevalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},"SampleValue.Weighted":{description:"Returns one of a set of values, weighted by a second set of values",simulation_volatile:!0,arguments:[{name:"range",description:"Range of Values"},{name:"weights",description:"Range of Weights"}],fn:this.samplevalue_weighted.bind(this),category:["RiskAMP Random Distributions"],extension:!0},BernoulliValue:{description:"Returns true or false (boolean) based on the given probability",simulation_volatile:!0,arguments:[{name:"p",description:"Probability to return True",default:.5}],fn:this.bernoullivalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},ProbabilityValue:{description:"Returns true or false (boolean) based on the given probability",simulation_volatile:!0,arguments:[{name:"p",description:"Probability to return True",default:.5}],fn:this.probabilityvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},UniformValue:{description:"Returns a sample from the uniform distribution",simulation_volatile:!0,arguments:[{name:"min",description:"Minimum",default:0},{name:"max",description:"Maximum",default:1}],fn:this.uniformvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},BetaValue:{description:"Returns a sample from the beta distribution",simulation_volatile:!0,arguments:[{name:"w",description:"Shape Parameter"},{name:"v",description:"Shape Parameter"}],fn:this.betavalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},TruncatedNormalValue:{description:"Returns a sample from the normal distribution",simulation_volatile:!0,arguments:[{name:"mean",description:"Mean",default:0},{name:"stdev",description:"Standard Deviation",default:1},{name:"min",description:"Minimum Value"},{name:"max",description:"Maximum Value"}],fn:this.truncatednormalvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},NormalValue:{description:"Returns a sample from the normal distribution",simulation_volatile:!0,arguments:[{name:"mean",description:"Mean",default:0},{name:"stdev",description:"Standard Deviation",default:1}],fn:this.normalvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},PERTValue:{description:"Returns a sample from the beta-PERT distribution",simulation_volatile:!0,arguments:[{name:"min",description:"Minimum Value",default:0},{name:"mode",description:"Most-Likely Value",default:.5},{name:"max",description:"Maximum Value",default:1},{name:"lambda",default:4}],fn:this.pertvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},LognormalValue:{description:"Returns a sample from the log-normal distribution",simulation_volatile:!0,arguments:[{name:"mean",description:"Mean of underlying Normal distribution",default:0},{name:"stdev",description:"Standard Deviation of underlying Normal distribution",default:1}],fn:this.lognormalvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},SequentialValue:{description:"Returns one from a set of values, in order",simulation_volatile:!0,arguments:[{name:"values",description:"Data Array"},{name:"count",description:"Count",default:0}],fn:this.sequentialvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},IndexValue:{description:"Returns a monotonically increasing value",simulation_volatile:!0,arguments:[{name:"max",description:"Maximum",default:0}],fn:this.indexvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},"PERTValue.P":{description:"Returns a sample from the beta-PERT distribution",simulation_volatile:!0,arguments:[{name:"p10",description:"10th-Percentile Value",default:0},{name:"mode",description:"Most-Likely Value",default:.5},{name:"p90",description:"90th-Percentile Value",default:1},{name:"lambda",default:4}],fn:this.pertvalue_p.bind(this),category:["RiskAMP Random Distributions"],extension:!0},TriangularValue:{description:"Returns a sample from the triangular distribution",simulation_volatile:!0,arguments:[{name:"min",description:"Minimum Value",default:0},{name:"mode",description:"Most Likely Value",default:.5},{name:"max",description:"Maximum Value",default:1}],fn:this.triangularvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},SimulationCorrelation:{description:"Returns the correlation between the data from two cells in the simulation",arguments:[{name:"reference cell",description:"Cell 1",collector:!0},{name:"reference cell",description:"Cell 2",collector:!0}],fn:this.simulationcorrelation.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationRSquared:{description:"Returns the r-squared value (coefficient of correlation) of the data from two cells in the simulation",arguments:[{name:"dependent",description:"Dependent Value",collector:!0},{name:"independent",description:"Indepdendent Value",collector:!0}],fn:this.simulationrsquared.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationSkewness:{description:"Returns the skewness of data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationskewness.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationKurtosis:{description:"Returns the kurtosis (peakedness) of data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationkurtosis.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationPercentile:{description:"Returns the value of a cell at a given percentile in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0},{name:"percentile",description:"Percentile (as %)"}],fn:this.simulationpercentile.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationInterval:{description:"Returns the portion of results in the simulation that fall within some bounds (as a percentage)",arguments:[{name:"reference cell",description:"Source Cell",collector:!0},{name:"min",description:"Minimum Value (optional, inclusive)"},{name:"max",description:"Maximum Value (optional, inclusive)"}],fn:this.simulationinterval.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationMean:{description:"Returns the mean (average) value of the data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationmean.bind(this),extension:!0,category:["RiskAMP Simulation Functions"]},SimulationMedian:{description:"Returns the median value of the data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationmedian.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationValue:{description:"Returns the value of this cell in the simulation at the given trial number",arguments:[{name:"reference cell",description:"Source Cell",collector:!0},{name:"iteration",description:"Trial Number"}],fn:this.simulationvalue.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationValuesArray:{description:"Returns all values of this cell in the simulation, as an array",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationvaluesarray.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SortedSimulationIndex:{description:"Returns the iteration number of a sorted value for this cell",arguments:[{name:"reference cell",description:"Source Cell",collector:!0},{name:"index"}],fn:this.sortedsimulationindex.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},"SimulationValuesArray.Ordered":{description:"Returns all values of this cell in the simulation, as an array, ordered by a second cell",arguments:[{name:"reference cell",description:"Source Cell",collector:!0},{name:"order by",description:"Reference Cell for Ordering",collector:!0}],fn:this.simulationvaluesarray_ordered.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationMin:{description:"Returns the minimum value of the data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationmin.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationMax:{description:"Returns the maximum value of the data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationmax.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationStandardError:{description:"Returns the standard error of the mean from this cell in the simulation",arguments:[{name:"reference cell",collector:!0}],fn:this.simulationstandarderror.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationStandardDeviation:{description:"Returns the standard deviation of the data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationstandarddeviation.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationVariance:{description:"Returns the variance of the data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationvariance.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationTrials:{description:"Returns the number of trials from the last simulation",fn:this.simulationtrials.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationTime:{description:"Returns the elapsed time of the last simulation",fn:this.simulationtime.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},IsPosDef:{description:"Checks that a matrix is positive-definite",arguments:[{name:"matrix"}],fn:t=>{if(t.some((t=>t.some((t=>"number"!=typeof t)))))return Yt();const e=Cs.Matrix.FromArray(t);return{type:o.boolean,value:e.IsPosDef()}},extension:!0},MakePosDef:{description:"Returns a matrix that is positive-definite",arguments:[{name:"matrix"}],fn:t=>t.some((t=>t.some((t=>"number"!=typeof t))))?Yt():Cs.Matrix.FromArray(t).MakePosDef().ToArray().map((t=>t.map((t=>({type:o.number,value:t}))))),extension:!0},Cholesky:{arguments:[{name:"matrix"},{name:"transpose",default:!1}],fn:(t,e=!1)=>Cs.Matrix.FromArray(t).Cholesky(e).ToArray().map((t=>t.map((t=>({type:o.number,value:t}))))),extension:!0},EigenValues:{description:"Returns the eigenvalues of the matrix (as column vector)",arguments:[{name:"matrix"}],fn:t=>t.some((t=>t.some((t=>"number"!=typeof t))))?Yt():[Cs.Matrix.FromArray(t).EigenSystem().realvalues.map((t=>({type:o.number,value:t})))],extension:!0},EigenVectors:{description:"Returns the eigenvectors of the matrix (as matrix)",arguments:[{name:"matrix"}],fn:t=>t.some((t=>t.some((t=>"number"!=typeof t))))?Yt():Cs.Matrix.FromArray(t).EigenSystem().vectors.map((t=>Array.from(t).map((t=>({type:o.number,value:t}))))),extension:!0},MMult:{description:"Multiplies two matrices",arguments:[{name:"Matrix 1"},{name:"Matrix 2"}],fn:(t,e)=>{var s,i;if(!t||!e)return Xt();const r=t.length||0,a=(null===(s=t[0])||void 0===s?void 0:s.length)||0,n=e.length||0,l=(null===(i=e[0])||void 0===i?void 0:i.length)||0;if(!(a&&l&&r&&n&&a===n&&r===l))return Yt();const h=Cs.Matrix.FromArray(t);return Cs.Matrix.FromArray(e).Multiply(h).ToArray().map((t=>t.map((t=>({type:o.number,value:t})))))}},MInverse:{description:"Returns the inverse matrix",arguments:[{name:"Matrix"}],fn:t=>{try{return Cs.Matrix.FromArray(t).Transpose().Inverse().ToArray(!0).map((t=>t.map((t=>({type:o.number,value:t})))))}catch(t){return console.warn(t),Yt()}}},"RiskAMP.Scale":{description:"Creates a uniform scale within a given range",arguments:[{name:"min"},{name:"max"}],fn:this.Scale.bind(this),extension:!0},"RiskAMP.HistogramTable":{description:"Creates a histogram table from a source cell",arguments:[{name:"reference cell",collector:!0}],fn:this.HistogramTable.bind(this),extension:!0},"RiskAMP.Permutation":{description:"Creates a random permutation of source data",arguments:[{name:"range",boxed:!0}],fn:this.Permutation.bind(this),extension:!0,simulation_volatile:!0}}}set seed(t){Cs.Random.Seed(t)}CallerArea(){var t;let e,s=1,i=1;if(this.address.sheet_id)for(const s of(null===(t=this.model)||void 0===t?void 0:t.sheets)||[])if(s.id===this.address.sheet_id){s.cells.data[this.address.row]&&(e=s.cells.data[this.address.row][this.address.column]);break}return(null==e?void 0:e.area)&&(s=e.area.rows,i=e.area.columns),{rows:s,columns:i}}CorrelateDistributions(){for(const t of Object.keys(this.correlated_distributions)){const e=this.correlated_distributions[t],s=e.addresses.map((t=>this.distributions[t.sheet_id||0][t.column][t.row][t.call_index]));try{const t=Cs.MC.CorrelateCDM(e.correlation,s,!0);e.addresses.forEach(((e,s)=>{this.distributions[e.sheet_id||0][e.column][e.row][e.call_index]=t[s]}))}catch(t){console.warn(t)}}}InitDistribution(){if(!this.address)throw new Error("invalid address");if(!this.address.sheet_id)throw new Error("address missing sheet ID");this.distributions[this.address.sheet_id]||(this.distributions[this.address.sheet_id]=[]);const t=this.distributions[this.address.sheet_id];t[this.address.column]||(t[this.address.column]=[]);const e=t[this.address.column];e[this.address.row]||(e[this.address.row]=[])}StoreCellResults(t){if(t||(t=this.address),!t)return;if(!t.sheet_id)throw new Error("SCR called without sheet id");this.results[t.sheet_id]||(this.results[t.sheet_id]=[]),this.results[t.sheet_id][t.column]||(this.results[t.sheet_id][t.column]=[]);const e=this.results[t.sheet_id][t.column];return e[t.row]||(e[t.row]=[]),e[t.row]}PrepMultivariate(t,e){if(!this.correlated_distributions[t]){let s=Cs.CDMatrix.FromArray(e);if(!s.IsSymmetric()){for(let t=1;t<e.length;t++)for(let s=0;s<t;s++)if(e[t][s]){console.warn("invalid lower-triangular matrix");break}s=s.Symmetrize(!0)}this.correlated_distributions[t]={correlation:s,addresses:[]}}this.correlated_distributions[t].addresses.push({column:this.address.column,row:this.address.row,sheet_id:this.address.sheet_id,call_index:this.call_index}),this.InitDistribution()}ValidateCorrelationMatrix(t){let e=Cs.Matrix.FromArray(t);return e.IsSymmetric()||(e=e.Symmetrize(!0)),!(t.some((t=>t.some((t=>"number"!=typeof t&&void 0!==t))))||!e.IsPosDef())}multivariate_normal(t,e,s=0,i=1){if(this.state===ws.Prep)this.PrepMultivariate(t,e),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Cs.MC.Normal(this.iterations,{mean:s,sd:i,lhs:this.lhs,ordered:!0});else if(this.state===ws.Simulation)return{type:o.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return this.ValidateCorrelationMatrix(e)?{type:o.number,value:Cs.MC.Normal(1,{mean:s,sd:i})[0]}:Wt()}multivariate_lognormal(t,e,s=0,i=1){if(this.state===ws.Prep)this.PrepMultivariate(t,e),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Cs.MC.LogNormal(this.iterations,{mean:s,sd:i,lhs:this.lhs,ordered:!0});else if(this.state===ws.Simulation)return{type:o.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return this.ValidateCorrelationMatrix(e)?{type:o.number,value:Cs.MC.LogNormal(1,{mean:s,sd:i})[0]}:Wt()}multivariate_beta(t,e,s=1,i=2){if(this.state===ws.Prep)this.PrepMultivariate(t,e),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Cs.MC.Beta(this.iterations,{a:s,b:i,lhs:this.lhs,ordered:!0});else if(this.state===ws.Simulation)return{type:o.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return this.ValidateCorrelationMatrix(e)?{type:o.number,value:Cs.MC.Beta(1,{a:s,b:i})[0]}:Wt()}multivariate_uniform(t,e,s=0,i=1){if(this.state===ws.Prep)this.PrepMultivariate(t,e),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Cs.MC.Uniform(this.iterations,{min:s,max:i,lhs:this.lhs,ordered:!0});else if(this.state===ws.Simulation)return{type:o.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return this.ValidateCorrelationMatrix(e)?{type:o.number,value:Cs.MC.Uniform(1,{min:s,max:i})[0]}:Wt()}multivariate_pert(t,e,s=0,i=.5,r=1,a=4){if(this.state===ws.Prep)this.PrepMultivariate(t,e),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Cs.MC.PERT(this.iterations,{a:s,b:r,c:i,lambda:a,lhs:this.lhs,ordered:!0});else if(this.state===ws.Simulation)return{type:o.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return this.ValidateCorrelationMatrix(e)?{type:o.number,value:Cs.MC.PERT(1,{a:s,b:r,c:i,lambda:a})[0]}:Wt()}multivariate_triangular(t,e,s=0,i=.5,r=1){if(this.state===ws.Prep)this.PrepMultivariate(t,e),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Cs.MC.Triangular(this.iterations,{a:s,b:r,c:i,lhs:this.lhs,ordered:!0});else if(this.state===ws.Simulation)return{type:o.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return this.ValidateCorrelationMatrix(e)?{type:o.number,value:Cs.MC.Triangular(1,{a:s,b:r,c:i})[0]}:Wt()}uniformvalue(t=0,e=1){if(this.state===ws.Prep)this.InitDistribution(),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Cs.MC.Uniform(this.iterations,{min:t,max:e,lhs:this.lhs});else if(this.state===ws.Simulation)return{type:o.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return{type:o.number,value:Cs.MC.Uniform(1,{min:t,max:e})[0]}}bernoullivalue(t=.5){if(this.state===ws.Prep)this.InitDistribution(),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Cs.MC.Bernoulli(this.iterations,{p:t,lhs:this.lhs});else if(this.state===ws.Simulation)return{type:o.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return{type:o.boolean,value:Cs.MC.Bernoulli(1,{p:t})[0]}}probabilityvalue(t=.5){return this.bernoullivalue(t)}sequentialvalue(t,e=0){if(this.state===ws.Prep)this.InitDistribution();else if(this.state===ws.Simulation){let s=this.iteration;e>0&&(s=this.iteration%e);const i=t[0].length,r=Math.floor(s/i)%t.length,a=s%i;return{type:o.number,value:t[r][a]}}return{type:o.number,value:t[0][0]}}indexvalue(t=0){if(this.state===ws.Prep)this.InitDistribution();else if(this.state===ws.Simulation)return t>0?{type:o.number,value:this.iteration%t+1}:{type:o.number,value:this.iteration+1};return{type:o.number,value:1}}lognormalvalue(t=0,e=1){if(this.state===ws.Prep)this.InitDistribution(),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Cs.MC.LogNormal(this.iterations,{mean:t,sd:e,lhs:this.lhs});else if(this.state===ws.Simulation)return{type:o.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return{type:o.number,value:Cs.MC.LogNormal(1,{mean:t,sd:e})[0]}}truncatednormalvalue(t=0,e=1,s,i){if(this.state===ws.Prep)this.InitDistribution(),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Cs.MC.TruncatedNormal(this.iterations,{mean:t,sd:e,lhs:this.lhs,min:s,max:i});else if(this.state===ws.Simulation)return{type:o.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return{type:o.number,value:Cs.MC.TruncatedNormal(1,{mean:t,sd:e,min:s,max:i})[0]}}normalvalue(t=0,e=1){if(this.state===ws.Prep)this.InitDistribution(),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Cs.MC.Normal(this.iterations,{mean:t,sd:e,lhs:this.lhs});else if(this.state===ws.Simulation)return{type:o.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return{type:o.number,value:Cs.MC.Normal(1,{mean:t,sd:e})[0]}}pertvalue(t=0,e=.5,s=1,i=4){if(this.state===ws.Prep)this.InitDistribution(),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Cs.MC.PERT(this.iterations,{a:t,b:s,c:e,lambda:i,lhs:this.lhs});else if(this.state===ws.Simulation)return{type:o.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return{type:o.number,value:Cs.MC.PERT(1,{a:t,b:s,c:e,lambda:i})[0]}}pertvalue_p(t=0,e=.5,s=1,i=4){if(this.state===ws.Prep){const r=Cs.MC.P80Pert(t,s,e,i);this.InitDistribution(),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Cs.MC.PERT(this.iterations,Object.assign(Object.assign({},r),{lambda:i,lhs:this.lhs}))}else if(this.state===ws.Simulation)return{type:o.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};const r=Cs.MC.P80Pert(t,s,e,i);return{type:o.number,value:Cs.MC.PERT(1,Object.assign(Object.assign({},r),{lambda:i}))[0]}}CommonDistributionFunction(t,e,s){if(this.state===ws.Prep)this.InitDistribution(),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=t.apply(e,[this.iterations].concat(s));else if(this.state===ws.Simulation)return this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration];return t.apply(e,[1].concat(s))[0]}triangularvalue(t=0,e=.5,s=1){if(this.state===ws.Prep)this.InitDistribution(),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Cs.MC.Triangular(this.iterations,{a:t,b:s,c:e,lhs:this.lhs});else if(this.state===ws.Simulation)return{type:o.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return{type:o.number,value:Cs.MC.Triangular(1,{a:t,b:s,c:e})[0]}}betavalue(t=1,e=1){if(this.state===ws.Prep)this.InitDistribution(),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Cs.MC.Beta(this.iterations,{a:t,b:e,lhs:this.lhs});else if(this.state===ws.Simulation)return{type:o.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return{type:o.number,value:Cs.MC.Beta(1,{a:t,b:e})[0]}}samplevalue(t){return this.uniformrangesample(t)}samplevalue_weighted(t,e){if(this.state===ws.Prep)this.InitDistribution(),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Cs.MC.Uniform(this.iterations,{min:0,max:1,lhs:this.lhs});else{const s=this.state===ws.Simulation?this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]:Cs.MC.Uniform(1,{min:0,max:1})[0];if(!t||!t.length)return{type:o.undefined,value:void 0};const i=s*we(e).reduce(((t,e)=>void 0===e?t:t+Number(e)),0);let r=0;for(let s=0;s<t.length;s++)for(let a=0;a<t[s].length;a++)if(r+=e[s][a],r>=i)return{type:o.number,value:t[s][a]}}return{type:o.number,value:t[0][0]}}uniformrangesample(t){this.state===ws.Prep&&(this.InitDistribution(),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Cs.MC.Uniform(this.iterations,{min:0,max:1,lhs:this.lhs}));const e=this.state===ws.Simulation?this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]:Cs.MC.Uniform(1,{min:0,max:1})[0];if(!t||!t.length)return{type:o.undefined,value:void 0};const s=Math.floor(t[0].length*t.length*e),i=t[s%t.length][Math.floor(s/t.length)]||"";return{value:i,type:a(i)}}simulationtrials(){return{type:o.number,value:this.trials}}simulationtime(){return{type:o.number,value:this.elapsed/1e3}}simulationvaluesarray(t){if(this.state!==ws.Null)return{type:o.number,value:0};if(!t||!t.length)return Wt();const e=[];for(let s=0;s<t.length;s++)e[s]={type:o.number,value:t[s]};return[e]}simulationvaluesarray_ordered(t,e){if(this.state!==ws.Null)return{type:o.number,value:0};if(!t||!t.length||e&&!e.length)return Wt();if(!e)return[Array.prototype.slice.call(t,0).sort(((t,e)=>t-e)).map((t=>({type:o.number,value:t})))];const s=Array.from(t).map(((t,s)=>[t,e[s]]));return s.sort(((t,e)=>t[1]-e[1])),[s.map((t=>({type:o.number,value:t[0]})))]}simulationrsquared(t,e){return this.state!==ws.Null?{type:o.number,value:0}:t&&t.length&&e&&e.length?{type:o.number,value:Cs.Stats.R2(t,e)}:Wt()}simulationcorrelation(t,e){return this.state!==ws.Null?{type:o.number,value:0}:t&&t.length&&e&&e.length?{type:o.number,value:Cs.Stats.Correlation(t,e)}:Wt()}sortedsimulationindex(t,e=1){if(this.state!==ws.Null)return{type:o.number,value:0};if(!t||!t.length)return Wt();if(e<1||e>t.length)return Xt();const s=Array.from(t).map(((t,e)=>[t,e+1]));return s.sort(((t,e)=>t[0]-e[0])),{type:o.number,value:s[e-1][1]}}simulationvalue(t,e=1){return this.state!==ws.Null?{type:o.number,value:0}:t&&t.length?e<1||e>t.length?Xt():{type:o.number,value:t[e-1]}:Wt()}simulationpercentile(t,e=.5){return this.state!==ws.Null?{type:o.number,value:0}:t&&t.length?{type:o.number,value:Cs.Stats.Percentile(t,e)}:Wt()}simulationstandarddeviation(t){if(this.state!==ws.Null)return{type:o.number,value:0};if(!t||!t.length)return Wt();const e=Cs.Stats.Statistics(t);return{type:o.number,value:e.stdev}}simulationvariance(t){if(this.state!==ws.Null)return{type:o.number,value:0};if(!t||!t.length)return Wt();const e=Cs.Stats.Statistics(t);return{type:o.number,value:e.variance}}simulationskewness(t){if(this.state!==ws.Null)return{type:o.number,value:0};if(!t||!t.length)return Wt();const e=Cs.Stats.Statistics(t);return{type:o.number,value:e.skewness}}simulationkurtosis(t){if(this.state!==ws.Null)return{type:o.number,value:0};if(!t||!t.length)return Wt();const e=Cs.Stats.Statistics(t);return{type:o.number,value:e.kurtosis}}simulationinterval(t,e,s){return this.state!==ws.Null?{type:o.number,value:0}:t&&t.length?{type:o.number,value:Cs.Stats.Interval({data:t,min:e,max:s})}:Wt()}simulationstandarderror(t){if(this.state!==ws.Null)return{type:o.number,value:0};if(!t||!t.length)return Wt();let e=0,s=0;for(const s of t)e+=s||0;const i=e/t.length;for(const e of t){const t=e-i;s+=t*t}return{type:o.number,value:Math.sqrt(s/t.length)/Math.sqrt(t.length)}}simulationmin(t){return this.state!==ws.Null?{type:o.number,value:0}:t&&t.length?{type:o.number,value:Math.min.apply(0,t)}:Wt()}simulationmax(t){return this.state!==ws.Null?{type:o.number,value:0}:t&&t.length?{type:o.number,value:Math.max.apply(0,t)}:Wt()}simulationmean(t){if(this.state!==ws.Null)return{type:o.number,value:0};if(!t||!t.length)return Wt();let e=0;for(const s of t)e+=s;return{type:o.number,value:e/t.length}}simulationmedian(t){if(this.state!==ws.Null)return{type:o.number,value:0};if(!t||!t.length)return Wt();const e=t.filter((t=>"number"==typeof t?t:0));return e.sort(((t,e)=>t-e)),{type:o.number,value:e[Math.round(e.length/2)]}}Permutation(t){if(!t){const{rows:t,columns:e}=this.CallerArea(),s=t*e;if(s<=0)return Xt();const i=xs(s),r=[];let a=0;for(let s=0;s<e;s++){const e=[];for(let s=0;s<t;s++)e.push({type:o.number,value:i[a++]});r.push(e)}return r}if(Array.isArray(t)){const e=t.length,s=t[0].length;if(!e||!s)return Xt();const i=t.reduce(((t,e)=>e.concat(t)),[]),r=e*s;if(i.length!==r)throw console.info("invalid?",r,t,i),new Error("invalid length");const o=xs(r),a=[];let n=0;for(let t=0;t<e;t++){const t=[];for(let e=0;e<s;e++){const e=o[n++];t.push(Object.assign({},i[e]))}a.push(t)}return a}return Object.assign({},t)}Scale(t,e){const{rows:s,columns:i}=this.CallerArea(),r=Math.max(s,i),a=t>e?j(e,t,r-1,!0):j(t,e,r-1,!0);let n=a.min;const l=[[]];if(a.count<r-1&&(n=a.min-Math.floor((r-1-a.count)/2)*a.step),t>e)for(let t=0;t<r;t++){const e=n+t*a.step;l[0][r-1-t]={type:o.number,value:e}}else for(let t=0;t<r;t++){const e=n+t*a.step;l[0][t]={type:o.number,value:e}}return s<i?be(l):l}HistogramTable(t){const{rows:e,columns:s}=this.CallerArea(),i=Math.max(e,s),r=Math.min(e,s);if(Array.isArray(t)||t instanceof Float64Array||t instanceof Float32Array){if(t.length<=1)return{type:o.number,value:0};Array.isArray(t)||(t=Array.prototype.slice.call(t)),t.sort(((t,e)=>t-e));const a=t[0]||0,n=t[t.length-1]||0;if(n===a)return{type:o.number,value:0};let l=[[],[]];const h=j(a,n,i,!0);let c=h.min,d=0;h.count<i&&(c=h.min-Math.ceil(i-h.count)/2*h.step);for(let e=0;e<i;e++){const s=c+(e+1)*h.step;let i=0;for(;d<t.length&&t[d]<s;d++,i++);l[1][e]={type:o.number,value:i},l[0][e]={type:o.number,value:s}}return 1===r&&(l=[l[1]]),s>e?be(l):l}return{type:o.number,value:0}}}class As extends ve{constructor(t,e){super(t,e),this.simulation_model=new Ss,this.context=this.simulation_model}CallExpression(t,e=!1){const s=this.library.Get(t.name);if(!s)return t=>te();const i=s.arguments||[];return this.simulation_model.state===ws.Prep&&t.args.forEach(((t,e)=>{const s=i[e]||{};if(t&&s.collector)if("address"===t.type)this.simulation_model.StoreCellResults(t);else if("identifier"===t.type){const e=this.named_range_map[t.name.toUpperCase()];e&&this.simulation_model.StoreCellResults(e.start)}else if("call"===t.type){const e=this.CalculateExpression(t,!0);e&&ge(e)&&("address"===e.value.type?this.simulation_model.StoreCellResults(e.value):"range"===e.value.type&&this.simulation_model.StoreCellResults(e.value.start))}})),r=>{const a=this.call_index++;this.simulation_model.volatile=this.simulation_model.volatile||!!s.volatile||!!s.simulation_volatile&&this.simulation_model.state!==ws.Null;const n="IF"===t.name.toUpperCase();let l,h=-1;const c=r.args.map(((t,e)=>{if(l)return;const s=i[Math.min(e,i.length-1)]||{};if(e===h)return s.boxed?d():void 0;if(void 0===t)return n&&0===e&&(h=1),s.boxed?d():void 0;if(s.address)return s.boxed?{type:o.string,value:this.parser.Render(t).replace(/\$/g,"")}:this.parser.Render(t).replace(/\$/g,"");if(s.metadata)return this.GetMetadata(t,((t,e)=>({simulation_data:this.simulation_model.state===ws.Null?this.simulation_model.StoreCellResults(e):[]})));if(s.collector&&this.simulation_model.state===ws.Null){if("address"===t.type)return this.simulation_model.StoreCellResults(t);if("range"===t.type)return this.simulation_model.StoreCellResults(t.start);if("identifier"===t.type){const e=this.named_range_map[t.name.toUpperCase()];if(e)return this.simulation_model.StoreCellResults(e.start)}else if("call"===t.type){const e=this.CalculateExpression(t,!0);if(e&&ge(e)){if("address"===e.value.type)return this.simulation_model.StoreCellResults(e.value);if("range"===e.value.type)return this.simulation_model.StoreCellResults(e.value.start)}}return l=Qt(),l}{const i=this.CalculateExpression(t);if(!Array.isArray(i)&&i.type===o.error)return s.allow_error?i:void(l=i);if(n&&0===e&&!Array.isArray(i)){let t=!1;if(i.type===o.string){const e=i.value.toLowerCase().trim();t="false"!==e&&"f"!==e}else t=!!i.value;h=t?2:1}return s.boxed?i:Array.isArray(i)?i.map((t=>t.map((t=>t.value)))):i.value}}));if(l)return l;if(this.context.call_index=a,s.return_type===se.reference){const t=s.fn.apply(null,c);if(e)return t;if(ge(t)){if("address"===t.value.type)return this.CellFunction2(t.value)();if("range"===t.value.type)return this.CellFunction4(t.value.start,t.value.end)}return t}return s.fn.apply(null,c)}}}class Ms extends Be{constructor(){super(),this.expression_calculator=this.simulation_expression_calculator=new As(this.library,this.parser),this.library.Register(this.simulation_expression_calculator.simulation_model.functions)}InitSimulation(t,e,s,i,r){var o;const a=this.simulation_expression_calculator.simulation_model;if(a.iterations=t,a.results=[],a.lhs=e,a.correlated_distributions={},"number"==typeof r&&(a.seed=r),this.Reset(),this.AttachModel(s),i&&i.length)for(const t of i){if(!t.sheet_id)throw new Error("additional cell passed without sheet id");for(const e of(null===(o=this.model)||void 0===o?void 0:o.sheets)||[])if(e.id===t.sheet_id){e.cells.GetCell(t,!1)&&a.StoreCellResults(t);break}}if(this.RebuildGraph(),this.LoopCheck())throw new Error("Loop (circular dependency) found in graph");return a.state=ws.Prep,a.iteration=0,this.Recalculate(),a.CorrelateDistributions(),a.state=ws.Simulation,It.OK}GetResults(){return this.simulation_expression_calculator.simulation_model.results}SimulationTrial(t){const e=this.simulation_expression_calculator.simulation_model;e.iteration=t;try{this.Recalculate();for(const s in e.results){const i=this.cells_map[s];for(const r in e.results[s]){const o=e.results[s][r];for(const e in o){const s=i.GetCell({row:Number(e),column:Number(r)});if(s){const i=s.GetValue();switch(typeof i){case"number":o[e][t]=i;break;case"boolean":o[e][t]=i?1:0;break;default:o[e][t]=0}}}}}return{status:It.OK,reference:null}}catch(t){return console.info("calculation error trapped",t),{status:It.CalculationError,reference:null}}}FlattenedResults(){const t=this.simulation_expression_calculator.simulation_model,e=[];for(const s in t.results)for(const i in t.results[s]){const r=t.results[s][i];for(const t in r)e.push(ys({row:Number(t),column:Number(i),sheet_id:Number(s),data:r[t]}).buffer)}return e}FlushSimulationResults(){const t=this.simulation_expression_calculator.simulation_model;t.results=[],t.elapsed=0,t.trials=0}ShiftSimulationResults(t,e,s,i){}UpdateResults(t,e=this.model,s=!0){if(!e)throw new Error("UpdateResults called without model");const i=this.simulation_expression_calculator.simulation_model;if(t){i.results=[],i.elapsed=t.elapsed,i.trials=t.trials;for(const r of t.results){const t=r instanceof ArrayBuffer?vs(new Float64Array(r)):r;t.sheet_id||(t.sheet_id=e.active_sheet.id),i.results[t.sheet_id]||(i.results[t.sheet_id]=[]),i.results[t.sheet_id][t.column]||(i.results[t.sheet_id][t.column]=[]),i.results[t.sheet_id][t.column][t.row]=t.data,s&&this.SetDirty(t)}}else i.results=[],i.elapsed=0,i.trials=0}}var ks=s(742),Rs=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z",".","-",":","+","=","^","!","/","*","?","&","<",">","(",")","[","]","{","}","@","%","$","#"],Ls=[0,68,0,84,83,82,72,0,75,76,70,65,0,63,62,69,0,1,2,3,4,5,6,7,8,9,64,0,73,66,74,71,81,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,77,0,78,67,0,0,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,79,0,80,0,0];function Es(t){if(t.length%4)return null;for(var e="",s=0,i=0,r="string"==typeof t?function(t,e){return t.charCodeAt(e)}:function(t,e){return t[e]};s<t.length;)if(i=256*i+r(t,s++),s%4==0){for(var o=52200625;o>=1;)e+=Rs[Math.floor(i/o)%85],o/=85;i=0}return e}function Ts(t){if(t.length%5)return null;for(var e=new Uint8Array(4*t.length/5),s=0,i=0,r=0;i<t.length;){if(!Rs.includes(t.charAt(i)))return null;var o=t.charCodeAt(i++)-32;if(r=85*r+Ls[o],i%5==0){for(var a=16777216;a>=1;)e[s++]=r/a%256,a/=256;r=0}}return e}class Ds extends gs{constructor(){super(...arguments),this.replay_buffer=[],this.simulation_resolution=[],this.workers=[],this.simulation_status={running:!1,threads:0,results:[],completed:0,progress:[],aggregate_progress:0}}ResetInternal(){super.ResetInternal(),this.FlushSimulationResults()}SimulationData(t){(t=this.EnsureAddress(t)).sheet_id||(t.sheet_id=this.grid.model.active_sheet.id);const e=this.calculator.GetResults();if(!e)return;if(!e[t.sheet_id])return;if(!e[t.sheet_id][t.column])return;const s=e[t.sheet_id][t.column][t.row];return s?Array.isArray(s)?s.slice(0):Array.from(s):void 0}FlushSimulationResults(){this.calculator.FlushSimulationResults(),this.last_simulation_data=void 0}SerializeDocument(t=!0,e=!0,s={}){const i=super.SerializeDocument(t,e,s);return t&&this.last_simulation_data&&(i.simulation_data={elapsed:this.last_simulation_data.elapsed,trials:this.last_simulation_data.trials,results:void 0},s.use_float32?(i.simulation_data.bitness=32,i.simulation_data.results=(this.last_simulation_data.results||[]).map((t=>{const e=Float32Array.from(new Float64Array(t));return s.use_z85?Es(new Uint8Array(e.buffer)):ks.fromByteArray(new Uint8Array(e.buffer))}))):i.simulation_data.results=(this.last_simulation_data.results||[]).map((t=>s.use_z85?Es(new Uint8Array(t)):ks.fromByteArray(new Uint8Array(t)))),s.use_z85&&(i.simulation_data.encoding="z85")),i}InitWorkers(t=this.options.max_workers){return e(this,void 0,void 0,(function*(){if(t=t||1,this.workers.length){for(const t of this.workers)t.terminate();this.workers=[]}let e=Math.max(1,t);"number"==typeof navigator.hardwareConcurrency&&(e=Math.min(e,navigator.hardwareConcurrency)),console.info(`creating ${e} thread${1===e?"":"s"}`);for(let t=0;t<e;t++)this.workers[t]=yield this.LoadWorker("embedded-treb-worker"),this.workers[t].onmessage=e=>{const s=e.data;this.HandleWorkerMessage(s,t)},this.workers[t].onerror=e=>{var s;console.error(`worker error (worker #${t})`),console.info(e);const i=e.message||"Worker error.";null===(s=this.dialog)||void 0===s||s.ShowDialog({title:"Calculation failed",message:i,close_box:!0,type:Ze.error,timeout:3e3});for(const t of this.simulation_resolution)t.call(this);this.simulation_resolution=[],this.simulation_status.running=!1;for(const t of this.workers)t.terminate();this.workers=[]}}))}RunSimulation(t=this.options.default_trials||5e3,s={}){var i,r,o;return e(this,void 0,void 0,(function*(){const{lhs:e,stepped:a,abort_on_dialog_close:n}=Object.assign({abort_on_dialog_close:!0,lhs:!!this.options.lhs,stepped:!!this.options.screen_updates},s);let l,h=s.additional_cells||[];if(this.simulation_status.running)throw new Error("simulation already running");if("number"==typeof s.seed&&Cs.Random.Seed(s.seed),null===(i=this.dialog)||void 0===i||i.ShowDialog({title:"Running Monte Carlo simulation",message:"Starting"}).then((()=>{this.simulation_status.running&&n&&this.AbortSimulation()})),!this.workers.length)try{yield this.InitWorkers()}catch(t){throw null===(r=this.dialog)||void 0===r||r.ShowDialog({title:"Calculation failed",message:"Worker not initialized.",close_box:!0,type:Ze.error,timeout:3e3}),new Error("worker not initialized")}if(!this.workers[0])throw null===(o=this.dialog)||void 0===o||o.ShowDialog({title:"Calculation failed",message:"Worker not initialized.",close_box:!0,type:Ze.error,timeout:3e3}),new Error("worker not initialized");this.Publish({type:"running-simulation",trials:t}),this.simulation_status.running=!0,this.simulation_status.threads=this.workers.length,this.simulation_status.progress=[],this.simulation_status.results=[],this.simulation_status.aggregate_progress=0,this.simulation_status.completed=0;for(let t=0;t<this.workers.length;t++)this.simulation_status.progress.push(0);for(const t of this.grid.model.active_sheet.annotations)t.formula&&(h=h.concat(this.calculator.MetadataReferences(t.formula)));if(h=this.calculator.FlattenCellList(h),this.grid.model.macro_functions){l=[];const t=Object.keys(this.grid.model.macro_functions);for(const e of t){const t=this.grid.model.macro_functions[e];l.push(JSON.parse(JSON.stringify(t)))}}const c=this.workers.map((()=>1e14*Cs.Random.Next()));s.replay&&this.replay_buffer.map(((t,e)=>c[e]=t));for(let t=0;t<this.workers.length;t++)this.workers[t].postMessage({type:"configure",seed:c[t],locale:g.locale,sheets:this.grid.model.sheets.map((t=>t.toJSON({rendered_values:!0,preserve_type:!0}))),named_ranges:this.grid.model.named_ranges.Serialize(),macro_functions:l,additional_cells:h});this.replay_buffer=c,Cs.Random.Seed(c[0]);let d=t,u=this.workers.length;for(const t of this.workers){const s=Math.floor(d/u--);t.postMessage({type:"start",trials:s,lhs:e,screen_updates:a}),d-=s}yield new Promise((t=>{this.simulation_resolution.push(t)}))}))}InitCalculator(){return new Ms}ImportDocumentData(t,e){if(super.ImportDocumentData(t,e),t.simulation_data){const e="z85"===t.simulation_data.encoding;this.last_simulation_data=t.simulation_data,32===t.simulation_data.bitness?this.last_simulation_data.results=(this.last_simulation_data.results||[]).map((t=>{if(e){const e=Ts(t);return e?Float64Array.from(e).buffer:(new Float64Array).buffer}{const e=new Float32Array(ks.toByteArray(t).buffer);return Float64Array.from(e).buffer}})):this.last_simulation_data.results=(this.last_simulation_data.results||[]).map((t=>{if(e){const e=Ts(t);return e?e.buffer:(new Uint8Array).buffer}return ks.toByteArray(t).buffer})),this.calculator.UpdateResults(this.last_simulation_data,this.grid.model,!1)}else this.FlushSimulationResults()}UpdateProgress(t,e){var s;this.simulation_status.progress[e]=t||0;const i=Math.round(this.simulation_status.progress.reduce(((t,e)=>t+e),0)/this.simulation_status.threads);i!==this.simulation_status.aggregate_progress&&(this.simulation_status.aggregate_progress=i,null===(s=this.dialog)||void 0===s||s.Update({message:`${i}% complete`}),this.Publish({type:"simulation-progress",progress:i}))}HandleWorkerMessage(t,e){switch(t.type){case"update":this.UpdateProgress(t.percent_complete,e),this.simulation_status.results[e]=t.trial_data,this.last_simulation_data=bs(this.simulation_status.results.filter((t=>!!t))),this.calculator.UpdateResults(this.last_simulation_data),this.Recalculate().then((()=>{this.workers[e].postMessage({type:"step"})}));break;case"progress":this.UpdateProgress(t.percent_complete,e);break;case"complete":this.simulation_status.progress[e]=100,this.simulation_status.results[e]=t.trial_data,this.simulation_status.completed++,this.simulation_status.completed===this.simulation_status.threads?(this.simulation_status.running=!1,this.last_simulation_data=bs(this.simulation_status.results),requestAnimationFrame((()=>{this.calculator.UpdateResults(this.last_simulation_data),this.Recalculate().then((()=>{this.grid.headless||this.Focus()})),setTimeout((()=>{var t,e,s;null===(t=this.dialog)||void 0===t||t.HideDialog(),this.Publish({type:"simulation-complete",elapsed:(null===(e=this.last_simulation_data)||void 0===e?void 0:e.elapsed)||0,trials:(null===(s=this.last_simulation_data)||void 0===s?void 0:s.trials)||0});for(const t of this.simulation_resolution)t.call(this);this.simulation_resolution=[]}),500)}))):this.UpdateProgress(100,e);break;default:console.info("unhandled worker message",t)}}AbortSimulation(){console.warn("aborting simulation");for(const t of this.workers)t.terminate();this.workers=[],this.simulation_status.running=!1,requestAnimationFrame((()=>{this.Recalculate().then((()=>{this.grid.headless||this.Focus()})),this.Publish({type:"simulation-aborted"});for(const t of this.simulation_resolution)t.call(this);this.simulation_resolution=[]}))}}const zs={"treb-popout-icon":{viewbox:"0 0 28 28",paths:["M22 14.5v5c0 2.484-2.016 4.5-4.5 4.5h-13c-2.484 0-4.5-2.016-4.5-4.5v-13c0-2.484 2.016-4.5 4.5-4.5h11c0.281 0 0.5 0.219 0.5 0.5v1c0 0.281-0.219 0.5-0.5 0.5h-11c-1.375 0-2.5 1.125-2.5 2.5v13c0 1.375 1.125 2.5 2.5 2.5h13c1.375 0 2.5-1.125 2.5-2.5v-5c0-0.281 0.219-0.5 0.5-0.5h1c0.281 0 0.5 0.219 0.5 0.5zM28 1v8c0 0.547-0.453 1-1 1-0.266 0-0.516-0.109-0.703-0.297l-2.75-2.75-10.187 10.187c-0.094 0.094-0.234 0.156-0.359 0.156s-0.266-0.063-0.359-0.156l-1.781-1.781c-0.094-0.094-0.156-0.234-0.156-0.359s0.063-0.266 0.156-0.359l10.187-10.187-2.75-2.75c-0.187-0.187-0.297-0.438-0.297-0.703 0-0.547 0.453-1 1-1h8c0.547 0 1 0.453 1 1z"]},"treb-toolbar-icon":{viewbox:"0 0 24 28",paths:["M5.5 22v2h-5.5v-2h5.5zM11 20c0.547 0 1 0.453 1 1v4c0 0.547-0.453 1-1 1h-4c-0.547 0-1-0.453-1-1v-4c0-0.547 0.453-1 1-1h4zM13.5 14v2h-13.5v-2h13.5zM3.5 6v2h-3.5v-2h3.5zM24 22v2h-11.5v-2h11.5zM9 4c0.547 0 1 0.453 1 1v4c0 0.547-0.453 1-1 1h-4c-0.547 0-1-0.453-1-1v-4c0-0.547 0.453-1 1-1h4zM19 12c0.547 0 1 0.453 1 1v4c0 0.547-0.453 1-1 1h-4c-0.547 0-1-0.453-1-1v-4c0-0.547 0.453-1 1-1h4zM24 14v2h-3.5v-2h3.5zM24 6v2h-13.5v-2h13.5z"]},"treb-export-icon":{viewbox:"0 0 26 28",paths:["M20 21c0-0.547-0.453-1-1-1s-1 0.453-1 1 0.453 1 1 1 1-0.453 1-1zM24 21c0-0.547-0.453-1-1-1s-1 0.453-1 1 0.453 1 1 1 1-0.453 1-1zM26 17.5v5c0 0.828-0.672 1.5-1.5 1.5h-23c-0.828 0-1.5-0.672-1.5-1.5v-5c0-0.828 0.672-1.5 1.5-1.5h7.266l2.109 2.125c0.578 0.562 1.328 0.875 2.125 0.875s1.547-0.313 2.125-0.875l2.125-2.125h7.25c0.828 0 1.5 0.672 1.5 1.5zM20.922 8.609c0.156 0.375 0.078 0.812-0.219 1.094l-7 7c-0.187 0.203-0.453 0.297-0.703 0.297s-0.516-0.094-0.703-0.297l-7-7c-0.297-0.281-0.375-0.719-0.219-1.094 0.156-0.359 0.516-0.609 0.922-0.609h4v-7c0-0.547 0.453-1 1-1h4c0.547 0 1 0.453 1 1v7h4c0.406 0 0.766 0.25 0.922 0.609z"]},"treb-reset-icon":{viewbox:"0 0 24 28",paths:["M23.609 16.5c0 0.031 0 0.078-0.016 0.109-1.328 5.531-5.891 9.391-11.656 9.391-3.047 0-6-1.203-8.219-3.313l-2.016 2.016c-0.187 0.187-0.438 0.297-0.703 0.297-0.547 0-1-0.453-1-1v-7c0-0.547 0.453-1 1-1h7c0.547 0 1 0.453 1 1 0 0.266-0.109 0.516-0.297 0.703l-2.141 2.141c1.469 1.375 3.422 2.156 5.437 2.156 2.781 0 5.359-1.437 6.813-3.813 0.375-0.609 0.562-1.203 0.828-1.828 0.078-0.219 0.234-0.359 0.469-0.359h3c0.281 0 0.5 0.234 0.5 0.5zM24 4v7c0 0.547-0.453 1-1 1h-7c-0.547 0-1-0.453-1-1 0-0.266 0.109-0.516 0.297-0.703l2.156-2.156c-1.484-1.375-3.437-2.141-5.453-2.141-2.781 0-5.359 1.437-6.813 3.813-0.375 0.609-0.562 1.203-0.828 1.828-0.078 0.219-0.234 0.359-0.469 0.359h-3.109c-0.281 0-0.5-0.234-0.5-0.5v-0.109c1.344-5.547 5.953-9.391 11.719-9.391 3.063 0 6.047 1.219 8.266 3.313l2.031-2.016c0.187-0.187 0.438-0.297 0.703-0.297 0.547 0 1 0.453 1 1z"]},"treb-about-icon":{viewbox:"0 0 24 28",paths:["M14 21.5v-3c0-0.281-0.219-0.5-0.5-0.5h-3c-0.281 0-0.5 0.219-0.5 0.5v3c0 0.281 0.219 0.5 0.5 0.5h3c0.281 0 0.5-0.219 0.5-0.5zM18 11c0-2.859-3-5-5.688-5-2.547 0-4.453 1.094-5.797 3.328-0.141 0.219-0.078 0.5 0.125 0.656l2.063 1.563c0.078 0.063 0.187 0.094 0.297 0.094 0.141 0 0.297-0.063 0.391-0.187 0.734-0.938 1.047-1.219 1.344-1.437 0.266-0.187 0.781-0.375 1.344-0.375 1 0 1.922 0.641 1.922 1.328 0 0.812-0.422 1.219-1.375 1.656-1.109 0.5-2.625 1.797-2.625 3.313v0.562c0 0.281 0.219 0.5 0.5 0.5h3c0.281 0 0.5-0.219 0.5-0.5v0c0-0.359 0.453-1.125 1.188-1.547 1.188-0.672 2.812-1.578 2.812-3.953zM24 14c0 6.625-5.375 12-12 12s-12-5.375-12-12 5.375-12 12-12 12 5.375 12 12z"]},"treb-simulation-icon":{viewbox:"0 0 24 28",paths:["M18.5 14c0 0.359-0.187 0.688-0.5 0.859l-8.5 5c-0.156 0.094-0.328 0.141-0.5 0.141s-0.344-0.047-0.5-0.125c-0.313-0.187-0.5-0.516-0.5-0.875v-10c0-0.359 0.187-0.688 0.5-0.875 0.313-0.172 0.703-0.172 1 0.016l8.5 5c0.313 0.172 0.5 0.5 0.5 0.859z","M20.5 14c0-4.688-3.813-8.5-8.5-8.5s-8.5 3.813-8.5 8.5 3.813 8.5 8.5 8.5 8.5-3.813 8.5-8.5zM24 14c0 6.625-5.375 12-12 12s-12-5.375-12-12 5.375-12 12-12 12 5.375 12 12z"]},"treb-fork-icon":{viewbox:"0 0 16 28",paths:["M4.5 23c0-0.828-0.672-1.5-1.5-1.5s-1.5 0.672-1.5 1.5 0.672 1.5 1.5 1.5 1.5-0.672 1.5-1.5zM4.5 5c0-0.828-0.672-1.5-1.5-1.5s-1.5 0.672-1.5 1.5 0.672 1.5 1.5 1.5 1.5-0.672 1.5-1.5zM14.5 7c0-0.828-0.672-1.5-1.5-1.5s-1.5 0.672-1.5 1.5 0.672 1.5 1.5 1.5 1.5-0.672 1.5-1.5zM16 7c0 1.109-0.609 2.078-1.5 2.594-0.047 5.641-4.047 6.891-6.703 7.734-2.484 0.781-3.297 1.156-3.297 2.672v0.406c0.891 0.516 1.5 1.484 1.5 2.594 0 1.656-1.344 3-3 3s-3-1.344-3-3c0-1.109 0.609-2.078 1.5-2.594v-12.812c-0.891-0.516-1.5-1.484-1.5-2.594 0-1.656 1.344-3 3-3s3 1.344 3 3c0 1.109-0.609 2.078-1.5 2.594v7.766c0.797-0.391 1.641-0.656 2.406-0.891 2.906-0.922 4.562-1.609 4.594-4.875-0.891-0.516-1.5-1.484-1.5-2.594 0-1.656 1.344-3 3-3s3 1.344 3 3z"]},"treb-chevron-left-icon":{viewbox:"0 0 21 28",paths:["M18.297 4.703l-8.297 8.297 8.297 8.297c0.391 0.391 0.391 1.016 0 1.406l-2.594 2.594c-0.391 0.391-1.016 0.391-1.406 0l-11.594-11.594c-0.391-0.391-0.391-1.016 0-1.406l11.594-11.594c0.391-0.391 1.016-0.391 1.406 0l2.594 2.594c0.391 0.391 0.391 1.016 0 1.406z"]},"treb-chevron-right-icon":{viewbox:"0 0 19 28",paths:["M17.297 13.703l-11.594 11.594c-0.391 0.391-1.016 0.391-1.406 0l-2.594-2.594c-0.391-0.391-0.391-1.016 0-1.406l8.297-8.297-8.297-8.297c-0.391-0.391-0.391-1.016 0-1.406l2.594-2.594c0.391-0.391 1.016-0.391 1.406 0l11.594 11.594c0.391 0.391 0.391 1.016 0 1.406z"]}},Ns="sidebar-open",Ps="toolbar-open",Fs="http://www.w3.org/2000/svg";class Is{constructor(t){const e="string"==typeof t.container?document.querySelector(t.container):t.container;if(!e)throw new Error("missing container");this.options=Object.assign(Object.assign({},We),t),this.outer_container=e,"static"===window.getComputedStyle(e).position&&(e.style.position="relative");const s=this.outer_container.getBoundingClientRect();this.options.headless||s.width&&s.height||this.outer_container.classList.add("default-spreadsheet-size"),this.inner_container=document.createElement("div"),this.inner_container.classList.add("embedded-spreadsheet-container"),this.options.collapsed||this.outer_container.classList.add("sidebar-open"),"show"!==this.options.toolbar&&"show-narrow"!==this.options.toolbar||this.outer_container.classList.add("toolbar-open"),this.outer_container.appendChild(this.inner_container),this.sheet=new Ds(Object.assign(Object.assign({},this.options),{container:this.inner_container,resizable:!1})),this.sidebar=document.createElement("div"),this.sidebar.classList.add("embedded-spreadsheet-sidebar"),Is.EnsureSymbols(),this.options.mc&&this.AddSidebarButton({icon:"treb-simulation-icon",title:"Run Simulation",click:()=>this.sheet.RunSimulation()}),this.AddSidebarButton({icon:"treb-reset-icon",title:"Recalculate",click:()=>this.sheet.Recalculate()}),this.options.toolbar&&(this.toolbar_container=document.createElement("div"),this.toolbar_container.classList.add("toolbar-container"),this.toolbar_button=this.AddSidebarButton({icon:"treb-toolbar-icon",title:"Show Toolbar",click:()=>this.ToggleToolbar()}),this.outer_container.appendChild(this.toolbar_container),this.sheet.toolbar_ctl={Show:t=>this.ShowToolbar(t)}),this.options.export&&this.AddSidebarButton({icon:"treb-export-icon",title:"Download as XLSX",click:()=>this.sheet.Export()}),this.options.popout&&this.AddSidebarButton({icon:"treb-popout-icon",title:"Open in New Tab",click:()=>this.Popout()}),this.options.fork&&this.AddSidebarButton({icon:"treb-fork-icon",title:"Fork and Edit",click:()=>{const t="https://treb.app",e=window.open(t+"/edit?fork");e&&this.sheet.PostDocument(e,t)}}),this.AddSidebarButton({icon:"treb-about-icon",title:"What's This?",click:()=>this.sheet.About()});const i=document.createElement("div");i.classList.add("sidebar-spacer"),this.sidebar.appendChild(i),this.AddSidebarButton({icon:"treb-chevron-right-icon",classes:"smaller",title:"Hide Sidebar",click:()=>this.HideSidebar()}),this.outer_container.appendChild(this.sidebar);const r=this.AddSidebarButton({icon:"treb-chevron-left-icon",classes:["smaller","show-sidebar-button"],title:"Show Sidebar",click:()=>this.ShowSidebar()},void 0);if(this.outer_container.appendChild(r),this.options.resizable){const t=e.querySelector(".treb-grid"),s=e.querySelector(".treb-layout-master");t&&$.Create({container:this.outer_container,node:t,resize_callback:()=>this.sheet.Resize(),layout_reference:s||void 0})}"show"!==this.options.toolbar&&"show-narrow"!==this.options.toolbar||this.ShowToolbar(!0),t.container._spreadsheet=this.sheet}static EnsureSymbols(){if(this.symbols_injected)return;this.symbols_injected=!0;const t=document.createElementNS(Fs,"svg");t.setAttribute("aria-hidden","true"),t.style.position="absolute",t.style.width="0",t.style.height="0",t.style.overflow="hidden";const e=document.createElementNS(Fs,"defs");t.appendChild(e);for(const t of Object.keys(zs)){const s=zs[t],i=document.createElementNS(Fs,"symbol");i.setAttribute("id",t),s.viewbox&&i.setAttribute("viewBox",s.viewbox);for(const t of s.paths||[]){const e=document.createElementNS(Fs,"path");e.setAttribute("d",t),i.appendChild(e)}e.appendChild(i)}document.body.insertBefore(t,document.body.firstChild||null)}static Create(t){return new Is(t).sheet}Popout(){const t=window.open("","_blank");if(!t)return;t.document.head.innerHTML=`<title>${this.sheet.document_name?`TREB: ${this.sheet.document_name}`:"TREB: Untitled Document"}</title><meta charset='utf-8'><meta http-equiv='X-UA-Compatible' content='IE=edge'><meta name='viewport' content='width=device-width,initial-scale=1'><link rel='icon' type='image/svg+xml' href='https://treb.app/leaf.svg'>`;const e=t.document.createElement("script");e.src=this.sheet.script_path,e.setAttribute("type","text/javascript"),t.document.body.appendChild(e);const s=JSON.stringify(this.sheet.SerializeDocument(!0,!0)),i=t.document.createElement("style");i.setAttribute("type","text/css"),i.textContent="*{box-sizing:border-box;padding:0;margin:0;}body,html{height:100%;width:100%;position:relative;}.treb{top:0;left:0;right:0;bottom:0;position:absolute;background:#fff;}",t.document.head.appendChild(i);const r=t.document.createElement("div");r.setAttribute("class","treb treb-fullscreen-padding"),t.document.body.appendChild(r);const o=window.screen.availWidth>=1200,a=t.document.createElement("script"),n=Object.assign(Object.assign({},this.options),{container:void 0,network_document:void 0,storage_key:void 0,resizable:!1,export:!0,scroll:void 0,toolbar:!o||"show",file_menu:!0,prompt_save:!0,expand_formula_button:o,popout:!1,add_tab:!0,tab_bar:"auto",headless:!1,dnd:!0,collapsed:!o});a.textContent=`(${((t,e)=>{let s=0;const i=()=>{t.container=document.querySelector(".treb"),t.container&&window.TREB?(window.sheet=window.TREB.CreateSpreadsheet(t),window.sheet.LoadDocument(e)):++s<32&&setTimeout((()=>i()),100)};i()}).toString()})(${JSON.stringify(n)},${s})`,t.document.body.appendChild(a),t.document.close()}AddSidebarButton(t={},e=this.sidebar){const s=document.createElement("div");if(s.classList.add("sidebar-button"),t.classes){const e="string"==typeof t.classes?[t.classes]:t.classes;for(const t of e)s.classList.add(t)}if(t.title&&s.setAttribute("title",t.title),t.text&&(s.textContent=t.text),t.click){const e=t.click;s.addEventListener("click",(()=>e()))}if(t.icon){const e=document.createElementNS(Fs,"svg");s.appendChild(e);const i=document.createElementNS(Fs,"use");i.setAttributeNS("http://www.w3.org/1999/xlink","href","#"+t.icon),e.appendChild(i)}return e&&e.appendChild(s),s}ToggleSidebar(){this.outer_container.classList.toggle(Ns)}ShowSidebar(t=!0){t?this.outer_container.classList.add(Ns):this.outer_container.classList.remove(Ns)}HideSidebar(){this.ShowSidebar(!1)}ToggleToolbar(){this.ShowToolbar(!this.outer_container.classList.contains(Ps))}ShowToolbar(t=!0){let e="Hide Toolbar";t?(this.toolbar_container&&!this.toolbar&&(this.toolbar=this.sheet.CreateToolbar(this.toolbar_container)),this.outer_container.classList.add(Ps)):(this.outer_container.classList.remove(Ps),e="Show Toolbar"),this.toolbar_button&&this.toolbar_button.setAttribute("title",e)}HideToolbar(){this.ShowToolbar(!1)}}Is.symbols_injected=!1;class Us{static Run(){const t=document.querySelectorAll("div[data-treb]");for(let e=0;e<t.length;e++){const s=t[e];if(s._spreadsheet)continue;const i=s.dataset||{},r={container:s,network_document:i.treb||void 0},o=i.options;if(o){const t=o.split(/,/g);for(const e of t){const[t,s]=e.split("=");t&&(void 0===s?r[t]=!0:/^(?:true|false)/i.test(s)?r[t]="false"!==s.toLowerCase():isNaN(s)?r[t]=s:r[t]=Number(s))}}const a=Is.Create(r),n=r.load||i.load;if(n){const t=self;t[n]?t[n](a,s):console.warn(`function ${n} not found`)}}}}(()=>{const t=self.TREB||{};t.CreateSpreadsheet||(gs.SniffPath(),t.version="10.12.12",gs.enable_engine&&(t.CreateEngine=(t={})=>new Ds(t)),t.CreateSpreadsheet=t=>Is.Create(t),gs.enable_formatter&&(t.Format={format:(t,e)=>Q.Get(e).Format(t),parse:t=>st.TryParse(t).value}),self.TREB=t,document.addEventListener("DOMContentLoaded",(()=>Us.Run())),document.addEventListener("readystatechange",(()=>{"complete"===document.readyState&&Us.Run()})))})(),gs.treb_language="es6"})()})();