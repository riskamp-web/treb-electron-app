/*! v11.7.2. Copyright 2018-2021 Structured Data, LLC. All rights reserved. CC BY-ND: https://treb.app/license */
(()=>{var e={742:(e,t)=>{"use strict";t.b$=function(e){var t,s,o=function(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var s=e.indexOf("=");return-1===s&&(s=t),[s,s===t?0:4-s%4]}(e),a=o[0],n=o[1],l=new r(function(e,t,s){return 3*(t+s)/4-s}(0,a,n)),h=0,c=n>0?a-4:a;for(s=0;s<c;s+=4)t=i[e.charCodeAt(s)]<<18|i[e.charCodeAt(s+1)]<<12|i[e.charCodeAt(s+2)]<<6|i[e.charCodeAt(s+3)],l[h++]=t>>16&255,l[h++]=t>>8&255,l[h++]=255&t;return 2===n&&(t=i[e.charCodeAt(s)]<<2|i[e.charCodeAt(s+1)]>>4,l[h++]=255&t),1===n&&(t=i[e.charCodeAt(s)]<<10|i[e.charCodeAt(s+1)]<<4|i[e.charCodeAt(s+2)]>>2,l[h++]=t>>8&255,l[h++]=255&t),l},t.JQ=function(e){for(var t,i=e.length,r=i%3,o=[],a=16383,n=0,h=i-r;n<h;n+=a)o.push(l(e,n,n+a>h?h:n+a));return 1===r?(t=e[i-1],o.push(s[t>>2]+s[t<<4&63]+"==")):2===r&&(t=(e[i-2]<<8)+e[i-1],o.push(s[t>>10]+s[t>>4&63]+s[t<<2&63]+"=")),o.join("")};for(var s=[],i=[],r="undefined"!=typeof Uint8Array?Uint8Array:Array,o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a=0,n=o.length;a<n;++a)s[a]=o[a],i[o.charCodeAt(a)]=a;function l(e,t,i){for(var r,o,a=[],n=t;n<i;n+=3)r=(e[n]<<16&16711680)+(e[n+1]<<8&65280)+(255&e[n+2]),a.push(s[(o=r)>>18&63]+s[o>>12&63]+s[o>>6&63]+s[63&o]);return a.join("")}i["-".charCodeAt(0)]=62,i["_".charCodeAt(0)]=63},162:function(e,t,s){var i,r;void 0===(r="function"==typeof(i=function(){"use strict";function t(e,t,s){var i=new XMLHttpRequest;i.open("GET",e),i.responseType="blob",i.onload=function(){n(i.response,t,s)},i.onerror=function(){console.error("could not download file")},i.send()}function i(e){var t=new XMLHttpRequest;t.open("HEAD",e,!1);try{t.send()}catch(e){}return 200<=t.status&&299>=t.status}function r(e){try{e.dispatchEvent(new MouseEvent("click"))}catch(s){var t=document.createEvent("MouseEvents");t.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),e.dispatchEvent(t)}}var o="object"==typeof window&&window.window===window?window:"object"==typeof self&&self.self===self?self:"object"==typeof s.g&&s.g.global===s.g?s.g:void 0,a=o.navigator&&/Macintosh/.test(navigator.userAgent)&&/AppleWebKit/.test(navigator.userAgent)&&!/Safari/.test(navigator.userAgent),n=o.saveAs||("object"!=typeof window||window!==o?function(){}:"download"in HTMLAnchorElement.prototype&&!a?function(e,s,a){var n=o.URL||o.webkitURL,l=document.createElement("a");s=s||e.name||"download",l.download=s,l.rel="noopener","string"==typeof e?(l.href=e,l.origin===location.origin?r(l):i(l.href)?t(e,s,a):r(l,l.target="_blank")):(l.href=n.createObjectURL(e),setTimeout((function(){n.revokeObjectURL(l.href)}),4e4),setTimeout((function(){r(l)}),0))}:"msSaveOrOpenBlob"in navigator?function(e,s,o){if(s=s||e.name||"download","string"!=typeof e)navigator.msSaveOrOpenBlob(function(e,t){return void 0===t?t={autoBom:!1}:"object"!=typeof t&&(console.warn("Deprecated: Expected third argument to be a object"),t={autoBom:!t}),t.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)?new Blob(["\ufeff",e],{type:e.type}):e}(e,o),s);else if(i(e))t(e,s,o);else{var a=document.createElement("a");a.href=e,a.target="_blank",setTimeout((function(){r(a)}))}}:function(e,s,i,r){if((r=r||open("","_blank"))&&(r.document.title=r.document.body.innerText="downloading..."),"string"==typeof e)return t(e,s,i);var n="application/octet-stream"===e.type,l=/constructor/i.test(o.HTMLElement)||o.safari,h=/CriOS\/[\d]+/.test(navigator.userAgent);if((h||n&&l||a)&&"undefined"!=typeof FileReader){var c=new FileReader;c.onloadend=function(){var e=c.result;e=h?e:e.replace(/^data:[^;]*;/,"data:attachment/file;"),r?r.location.href=e:location=e,r=null},c.readAsDataURL(e)}else{var d=o.URL||o.webkitURL,u=d.createObjectURL(e);r?r.location=u:location.href=u,r=null,setTimeout((function(){d.revokeObjectURL(u)}),4e4)}});o.saveAs=n.saveAs=n,e.exports=n})?i.apply(t,[]):i)||(e.exports=r)},897:(e,t,s)=>{"use strict";s.r(t)},691:function(e,t){!function(e){"use strict";var t=new(function(){function e(e){void 0===e&&(e=0),this.m_w=0,this.m_z=0,this.Seed(e)}return e.prototype.Seed=function(e){void 0===e&&(e=0),e?(this.m_w=Math.round(2863311530&e)||1,this.m_z=Math.round(1431655765&e)||1):(this.m_w=Math.round(1e5*Math.random()),this.m_z=Math.round((new Date).getTime()))},e.prototype.Next=function(){return this.m_z=36969*(65535&this.m_z)+(this.m_z>>16)&4294967295,this.m_w=18e3*(65535&this.m_w)+(this.m_w>>16)&4294967295,.5+((this.m_z<<16)+this.m_w&4294967295)/4294967296},e.prototype.GetState=function(){return[this.m_w,this.m_z]},e}()),s=function(){function e(){}return e.Sort=function(e,t){this.QuickSort(e,t,0,e.length)},e.Partition=function(e,t,s,i){for(var r=e[i-1],o=s,a=s;a<i-1;a+=1)e[a]<=r&&(this.Swap(e,t,a,o),o+=1);return this.Swap(e,t,o,i-1),o},e.Swap=function(e,t,s,i){var r=e[s];e[s]=e[i],e[i]=r,r=t[s],t[s]=t[i],t[i]=r},e.QuickSort=function(e,t,s,i){if(s<i){var r=this.Partition(e,t,s,i);this.QuickSort(e,t,s,r),this.QuickSort(e,t,r+1,i)}},e}(),i=function(){return(i=Object.assign||function(e){for(var t,s=1,i=arguments.length;s<i;s++)for(var r in t=arguments[s])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)},r=function(){function e(){}return e.Sort=function(e){return this.QuickSort(e,0,e.length-1),e},e.Swap=function(e,t,s){var i=e[t];e[t]=e[s],e[s]=i},e.Partition=function(e,t,s){for(var i=e[Math.floor((s+t)/2)];t<=s;){for(;e[t]<i;)t++;for(;e[s]>i;)s--;t<=s&&(this.Swap(e,t,s),t++,s--)}return t},e.QuickSort=function(e,t,s){var i;return e.length>1&&(t<(i=this.Partition(e,t,s))-1&&this.QuickSort(e,t,i-1),i<s&&this.QuickSort(e,i,s)),e},e}(),o=function(){function e(){}return e.Correlation=function(e,t){for(var s=0,i=0,r=0,o=0,a=0,n=0,l=0;l<e.length;l++)i+=e[l]*t[l],r+=e[l],o+=t[l],a+=e[l]*e[l],n+=t[l]*t[l];return(s=e.length*i-r*o)&&(s/=Math.sqrt((e.length*a-r*r)*(e.length*n-o*o))),s},e.TickRange=function(e,t,s){var i=e/(t-1),r=Math.ceil(this.Log10(i)-1),o=Math.pow(10,r);return Math.ceil(i/o)*o},e.Log10=function(e){return Math.log(e)/Math.LN10},e.Log2=function(e){return Math.log(e)/Math.LN2},e.Percentiles=function(e,t){for(var s=r.Sort(e.slice(0)),i=s.length,o=new Array(101),a=0;a<100;a++)o[a]=s[Math.round(i*a/100)];return o[100]=s[i-1],o},e.Percentile=function(e,t){var s=r.Sort(e.slice(0)),i=s.length;return s[Math.max(0,Math.min(i-1,Math.round(i*t)))]},e.Interval=function(e){var t=0;if(!e.data||!e.data.length)return 0;if(void 0===e.min){if(void 0===e.max)return 1;for(var s=0,i=e.data;s<i.length;s++)(l=i[s])<=e.max&&t++}else if(void 0===e.max)for(var r=0,o=e.data;r<o.length;r++)(l=o[r])>=e.min&&t++;else for(var a=0,n=e.data;a<n.length;a++){var l;(l=n[a])>=e.min&&l<=e.max&&t++}return t/e.data.length},e.R2=function(e,t){for(var s=0,i=0,r=0,o=0,a=0,n=0,l=0,h=0,c=0;c<e.length;c++)o+=(i=t[c])*(r=e[c]),a+=i,n+=r,l+=i*i,h+=r*r;return(s=e.length*o-a*n)&&(s/=Math.sqrt((e.length*l-a*a)*(e.length*h-n*n))),s*s},e.ToSD=function(e,t){if(void 0===t&&(t=2),t=t||2,0===e)return e;var s=Math.pow(10,Math.floor(this.Log10(e))+1-t);return Math.round(e/s)*s},e.Statistics=function(e){for(var t=this.Range(e),s=e.length,o=0,a=0,n=0,l=0,h=r.Sort(e.slice(0)),c=h[Math.round(s/2)],d=0;d<s;d++)o+=e[d];var u=o/=s;for(d=0;d<s;d++){var m=e[d]-o;a+=m*m,l+=m*m*m,n+=m*m*m*m}var f=s,p=a/s,_=Math.sqrt(a/s),g=l/((s-1)*Math.pow(_,3)),y=n/((s-1)*Math.pow(_,4)),v=Math.sqrt(a/s)/Math.sqrt(s),b={};for(d=5;d<100;d+=5)b[d]=h[Math.round(s*d/100)];b[0]=h[0],b[100]=h[s-1];var w=this.Interval({data:e,max:0});return i(i({},t),{median:c,mean:u,N:f,variance:p,stdev:_,skewness:g,kurtosis:y,stderr:v,percentiles:b,zero:w})},e.Truncate=function(e,t,s){var i=r.Sort(e.slice(0));return i.slice(Math.round(i.length*t/100),Math.round(i.length*s/100))},e.Histogram=function(e,t){void 0===t&&(t="sturges");for(var s=!0,i=0;s&&i<e.length;i++)s=s&&e[i]===Math.round(e[i]);var r=this.Range(e);if("string"==typeof t||!t)if("fd"===t){var o=this.FD(e);t=0===o||0===r.range?1:Math.round(r.range/o+1)}else t=this.Sturges(e);var a=[],n=[];if(s&&t>r.range){for(t=r.range+1,i=0;i<t;i++)a[i]=0,n[i]=r.min+i;for(var l=0,h=e;l<h.length;l++)a[(_=h[l])-r.min]++}else{var c=this.TickRange(r.range,t),d=this.FirstBin(r.max,r.min,t,c),u=Math.ceil(this.Log10(c)-1);for(i=0;i<t;i++)a[i]=0,n[i]=(d+i*c).toFixed(Math.max(0,-u));for(var m=d-c,f=0,p=e;f<p.length;f++){var _=p[f];a[Math.floor((_-m)/c)]++}}return{bins:a,labels:n}},e.Sturges=function(e){return Math.ceil(this.Log2(e.length)+1)},e.IQR=function(e){var t=this.Quantiles(e,[.25,.75]);return t[1]-t[0]},e.Quantiles=function(e,t){void 0===t&&(t=[0,.25,.5,.75,1]);var s=r.Sort(e.slice(0));return t.map((function(e){return s[Math.floor((s.length-1)*e)]}))},e.FD=function(e){return 2*this.IQR(e)*Math.pow(e.length,-1/3)},e.FirstBin=function(e,t,s,i){var r=(Math.floor(t/i)+1)*i,o=Math.floor((r+(s-1)*i-e)/i);return o>=2?r-o/2*i:r},e.Range=function(e){for(var t=e.length,s=t>0?e[0]:0,i=t>0?e[0]:0,r=1;r<t;r++)e[r]>i&&(i=e[r]),e[r]<s&&(s=e[r]);return{min:s,max:i,range:i-s}},e.EPSILON_DOUBLE=2220446049250313e-31,e.QUIET_NAN=Number.NaN,e.s_undefined="undefined",e.s_object="object",e.s_number="number",e}(),a=function(){function e(){this.rows=0,this.columns=0,this.data=[]}return e.Zero=function(t,s){return void 0===s&&(s=t),(new e).Reset(t,s)},e.Identity=function(e){for(var t=this.Zero(e,e),s=0;s<e;s++)t.data[s][s]=1;return t},e.Clone=function(t){var s=new e;s.rows=t.rows,s.columns=t.columns;for(var i=0,r=t.data;i<r.length;i++){var o=r[i];s.data.push(new Float64Array(o))}return s},e.FromArray=function(e,t){void 0===t&&(t=!1);var s=e[0].length,i=e.length;if(t){for(var r=this.Zero(s,i),o=0;o<i;o++)for(var a=0;a<s;a++)r.data[o][a]=e[o][a];return r}for(r=this.Zero(i,s),o=0;o<i;o++)for(a=0;a<s;a++)r.data[a][o]=e[o][a]||0;return r},e.prototype.Reset=function(e,t){this.data=new Array(t);for(var s=0;s<t;s++)this.data[s]=new Float64Array(e);return this.rows=e,this.columns=t,this},e.prototype.CopyTo=function(e){e.rows=this.rows,e.columns=this.columns,e.data=new Array(this.columns);for(var t=0,s=this.data;t<s.length;t++){var i=s[t];e.data.push(new Float64Array(i))}return e},e.prototype.GetColumn=function(e){return this.data[e]},e.prototype.SetColumn=function(e,t){this.data[e]=new Float64Array(t)},e.prototype.Transpose=function(){for(var t=e.Zero(this.columns,this.rows),s=0;s<this.columns;s++)for(var i=0;i<this.rows;i++)t.data[s][i]=this.data[i][s];return t},e.prototype.Symmetrize=function(t){void 0===t&&(t=!1);var s=this.Transpose(),i=e.Clone(this);if(t)for(o=1;o<this.columns;o++)for(r=0;r<o;r++)i.data[r][o]=s.data[r][o];else for(var r=1;r<this.rows;r++)for(var o=0;o<r;o++)i.data[r][o]=s.data[r][o];return i},e.prototype.Cholesky=function(t){if(void 0===t&&(t=!1),this.rows!==this.columns)throw new Error("matrix not square");for(var s=this.rows,i=e.Zero(s),r=0;r<s;r++){for(var o=0,a=0;a<r;a++){for(var n=0,l=0;l<a;l++)n+=i.data[a][l]*i.data[r][l];if(i.data[r][a]=n=(this.data[r][a]-n)/i.data[a][a],o+=n*n,this.data[a][r]!==this.data[r][a])throw new Error("matrix not symmetrical")}if((o=this.data[r][r]-o)<=0)throw new Error("matrix not pos-def ("+o+")");for(i.data[r][r]=o>0?Math.sqrt(o):0,a=r+1;a<s;a++)i.data[r][a]=0}return t?i.Transpose():i},e.prototype.Multiply=function(t){for(var s=0,i=0,r=e.Zero(this.rows,t.columns),o=0;o<this.rows;o++)for(var a=0;a<t.columns;a++){for(i=s=0;s<this.columns;s++)i+=this.data[s][o]*t.data[a][s];r.data[a][o]=i}return r},e.prototype.Inverse=function(){if(this.rows!==this.columns)throw new Error("invalid matrix");for(var t=e.Clone(this),s=0,i=t.rows,r=1;r<i;r++)t.data[r][0]/=t.data[0][0];for(r=1;r<i;r++){for(var o=r;o<i;o++){s=0;for(var a=0;a<r;a++)s+=t.data[a][o]*t.data[r][a];t.data[r][o]-=s}if(r!==i-1)for(o=r+1;o<i;o++){for(s=0,a=0;a<r;a++)s+=t.data[a][r]*t.data[o][a];t.data[o][r]=(t.data[o][r]-s)/t.data[r][r]}}for(r=0;r<i;r++)for(o=r;o<i;o++){var n=1;if(r!==o)for(n=0,a=r;a<o;a++)n-=t.data[a][o]*t.data[r][a];t.data[r][o]=n/t.data[o][o]}for(r=0;r<i;r++)for(o=r;o<i;o++)if(r!==o){for(s=0,a=r;a<o;a++)s+=t.data[o][a]*(r===a?1:t.data[a][r]);t.data[o][r]=-s}for(r=0;r<i;r++)for(o=0;o<i;o++){for(s=0,a=r>o?r:o;a<i;a++)s+=(o===a?1:t.data[a][o])*t.data[r][a];t.data[r][o]=s}return t},e.prototype.SortColumns=function(t){void 0===t&&(t=!1);for(var s=e.Clone(this),i=t?function(e,t){return t-e}:function(e,t){return e-t},r=0,o=s.data;r<o.length;r++)o[r].sort(i);return s},e.prototype.Rank=function(t){void 0===t&&(t=!1);for(var i=e.Clone(this),r=new Int32Array(this.rows),o=0;o<this.rows;o++)r[o]=o;for(var a=0;a<this.columns;a++){var n=new Int32Array(r);for(s.Sort(i.data[a],n),t&&n.reverse(),o=0;o<this.rows;o++)i.data[a][n[o]]=o}return i},e.prototype.Rank2=function(t,i){void 0===t&&(t=!1);for(var r=e.Zero(this.rows,this.columns),o=new Int32Array(this.rows),a=0;a<this.rows;a++)o[a]=a;for(var n=0;n<this.columns;n++){var l=new Int32Array(o);for(s.Sort(this.data[n],l),t&&l.reverse(),a=0;a<this.rows;a++)r.data[n][l[a]]=i.data[n][a]}return r},e.prototype.Correl=function(){for(var t=e.Zero(this.columns,this.columns),s=0;s<this.columns;s++){t.data[s][s]=1;for(var i=0;i<s;i++)t.data[i][s]=o.Correlation(this.data[s],this.data[i])}return t.Symmetrize()},e.prototype.IsSymmetric=function(){if(this.rows!==this.columns)return!1;for(var e=0;e<this.columns;e++)for(var t=0;t<this.rows;t++)if(this.data[e][t]!==this.data[t][e])return!1;return!0},e.prototype.toString=function(e){var t="";e=e||2;for(var s=0;s<this.rows;s++){for(var i=0;i<this.columns;i++){var r=this.data[i][s];r>=0&&(t+=" "),t+=r.toFixed(e),t+=" "}t+="\n"}return t},e}();Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length,s=0;s<t;s++){if(arguments[s]===1/0||arguments[s]===-1/0)return 1/0;e+=arguments[s]*arguments[s]}return Math.sqrt(e)});var n=function(){function e(){}return e.Guid=function(){for(var e="",t=0;t<8;t++)e+=Math.round(256*Math.random()).toString(16);return e},e.Log10=function(e){return Math.log(e)/Math.LN10},e.ToSD=function(e,t){if(void 0===t&&(t=2),t=t||2,0===e)return e;var s=e<0?-1:1;e*=s;var i=Math.pow(10,Math.floor(this.Log10(e))+1-t);return Math.round(e/i)*i*s},e.ToSDCeil=function(e,t){if(void 0===t&&(t=2),t=t||2,0===e)return e;var s=e<0?-1:1;e*=s;var i=Math.pow(10,Math.floor(this.Log10(e))+1-t);return Math.ceil(e/i)*i*s},e.SuggestDecimals=function(e){if("number"!=typeof e){for(var t=e[0],s=e[0],i=0,r=e;i<r.length;i++){var o=r[i];t=Math.min(t,o),s=Math.max(s,o)}e=s-t}var a=Math.ceil(this.Log10(e));return console.log(a),a<=0?1-a:1},e.YearFraction=function(e){var t=new Date(e.getTime());return t.setMonth(11,31),(t.getTime()-e.getTime())/this.MILLIS_YEAR},e.DEFAULT_NUMBER_FORMAT="(0,0.00)",e.DEFAULT_PCT_FORMAT="0.00",e.DEFAULT_CURRENCY_FORMAT="(0,0)",e.MILLIS_YEAR=315576e5,e}(),l=function(){function e(e){this.order=0,this.realvalues=[],this.ivalues=[],this.vectors=[];var t=e.length;this.order=t,this.vectors=[];for(var s=!0,i=0;s&&i<t;i++){if(e[i].length!==t)throw new Error("not square");for(var r=0;r<t;r++)e[i][r]!==e[r][i]&&(s=!1)}if(s){for(i=0;i<t;i++)Array.isArray(e[i])?this.vectors.push(e[i].slice(0)):this.vectors.push(Array.from(e[i]));this.tred2(),this.tql2()}else{var o=[],a=[];for(i=0;i<t;i++){for(Array.isArray(e[i])?o.push(e[i].slice(0)):o.push(Array.from(e[i])),this.vectors.push([]),r=0;r<t;r++)this.vectors[i][r]=0;a.push(0)}this.orthes(o,a),this.hqr2(o,a)}}return e.prototype.GetDiagonal=function(){for(var e=[],t=0;t<this.order;t++){e.push([]);for(var s=0;s<this.order;s++)e[t][s]=0;e[t][t]=this.realvalues[t],this.ivalues[t]>0?e[t][t+1]=this.ivalues[t]:this.ivalues[t]<0&&(e[t][t-1]=this.ivalues[t])}return e},e.prototype.tred2=function(){for(var e=0,t=0,s=0,i=0,r=0,o=this.order,a=this.vectors,n=this.realvalues,l=this.ivalues,h=0;h<o;h++)n[h]=a[o-1][h];for(var c=o-1;c>0;c--){s=0,i=0;for(var d=0;d<c;d++)s+=Math.abs(n[d]);if(0===s)for(l[c]=n[c-1],h=0;h<c;h++)n[h]=a[c-1][h],a[c][h]=0,a[h][c]=0;else{for(d=0;d<c;d++)n[d]/=s,i+=n[d]*n[d];for(e=n[c-1],t=Math.sqrt(i),e>0&&(t=-t),l[c]=s*t,i-=e*t,n[c-1]=e-t,h=0;h<c;h++)l[h]=0;for(h=0;h<c;h++){e=n[h],a[h][c]=e;var u=l[h]+a[h][h]*e;for(d=h+1;d<=c-1;d++)u+=a[d][h]*n[d],l[d]+=a[d][h]*e;l[h]=u}for(e=0,h=0;h<c;h++)l[h]/=i,e+=l[h]*n[h];for(r=e/(i+i),h=0;h<c;h++)l[h]-=r*n[h];for(h=0;h<c;h++){for(e=n[h],t=l[h],d=h;d<=c-1;d++)a[d][h]-=e*l[d]+t*n[d];n[h]=a[c-1][h],a[c][h]=0}}n[c]=i}for(c=0;c<o-1;c++){if(a[o-1][c]=a[c][c],a[c][c]=1,0!==(i=n[c+1])){for(d=0;d<=c;d++)n[d]=a[d][c+1]/i;for(h=0;h<=c;h++){for(t=0,d=0;d<=c;d++)t+=a[d][c+1]*a[d][h];for(d=0;d<=c;d++)a[d][h]-=t*n[d]}}for(d=0;d<=c;d++)a[d][c+1]=0}for(h=0;h<o;h++)n[h]=a[o-1][h],a[o-1][h]=0;a[o-1][o-1]=1,l[0]=0},e.prototype.tql2=function(){var e,t,s,i,r,o,a,n,l,h,c,d,u,m,f,p,_,g,y,v=this.order,b=this.vectors,w=this.realvalues,x=this.ivalues;for(e=1;e<v;e++)x[e-1]=x[e];for(x[v-1]=0,a=0,n=0,l=Math.pow(2,-52),t=0;t<v;t++){for(n=Math.max(n,Math.abs(w[t])+Math.abs(x[t])),o=t;o<v&&!(Math.abs(x[o])<=l*n);)o++;if(o>t)do{for(h=w[t],i=(w[t+1]-h)/(2*x[t]),c=Math.hypot(i,1),i<0&&(c=-c),w[t]=x[t]/(i+c),w[t+1]=x[t]*(i+c),d=w[t+1],u=h-w[t],e=t+2;e<v;e++)w[e]-=u;for(a+=u,i=w[o],f=m=1,p=m,_=x[t+1],g=0,y=0,e=o-1;e>=t;e--)for(p=f,f=m,y=g,h=m*x[e],u=m*i,c=Math.hypot(i,x[e]),x[e+1]=g*c,g=x[e]/c,i=(m=i/c)*w[e]-g*h,w[e+1]=u+g*(m*h+g*w[e]),s=0;s<v;s++)u=b[s][e+1],b[s][e+1]=g*b[s][e]+m*u,b[s][e]=m*b[s][e]-g*u;i=-g*y*p*_*x[t]/d,x[t]=g*i,w[t]=m*i}while(Math.abs(x[t])>l*n);w[t]=w[t]+a,x[t]=0}for(e=0;e<v-1;e++){for(s=e,i=w[e],r=e+1;r<v;r++)w[r]<i&&(s=r,i=w[r]);if(s!==e)for(w[s]=w[e],w[e]=i,r=0;r<v;r++)i=b[r][e],b[r][e]=b[r][s],b[r][s]=i}},e.prototype.orthes=function(e,t){var s,i,r,o,a,n,l,h=this.order,c=this.vectors,d=(this.realvalues,this.ivalues,h-1);for(n=1;n<=d-1;n++){for(l=0,o=n;o<=d;o++)l+=Math.abs(e[o][n-1]);if(0!==l){for(r=0,o=d;o>=n;o--)t[o]=e[o][n-1]/l,r+=t[o]*t[o];for(i=Math.sqrt(r),t[n]>0&&(i=-i),r-=t[n]*i,t[n]=t[n]-i,a=n;a<h;a++){for(s=0,o=d;o>=n;o--)s+=t[o]*e[o][a];for(s/=r,o=n;o<=d;o++)e[o][a]-=s*t[o]}for(o=0;o<=d;o++){for(s=0,a=d;a>=n;a--)s+=t[a]*e[o][a];for(s/=r,a=n;a<=d;a++)e[o][a]-=s*t[a]}t[n]=l*t[n],e[n][n-1]=l*i}}for(o=0;o<h;o++)for(a=0;a<h;a++)c[o][a]=o===a?1:0;for(n=d-1;n>=1;n--)if(0!==e[n][n-1]){for(o=n+1;o<=d;o++)t[o]=e[o][n-1];for(a=n;a<=d;a++){for(i=0,o=n;o<=d;o++)i+=t[o]*c[o][a];for(i=i/t[n]/e[n][n-1],o=n;o<=d;o++)c[o][a]+=i*t[o]}}},e.prototype.cdiv=function(e,t,s,i){var r=0,o=0;return Math.abs(s)>Math.abs(i)?{r:(e+(r=i/s)*t)/(o=s+r*i),i:(t-r*e)/o}:{r:((r=s/i)*e+t)/(o=i+r*s),i:(r*t-e)/o}},e.prototype.hqr2=function(e,t){var s,i,r,o,a,n,l,h,c,d,u,m=this.order,f=this.vectors,p=this.realvalues,_=this.ivalues,g=m,y=g-1,v=g-1,b=Math.pow(2,-52),w=0,x=0,C=0,S=0,A=0,M=0,k=0;for(n=0;n<g;n++)for((n<0||n>v)&&(p[n]=e[n][n],_[n]=0),l=Math.max(n-1,0);l<g;l++)k+=Math.abs(e[n][l]);for(c=0;y>=0;){for(d=y;d>0&&(0===(A=Math.abs(e[d-1][d-1])+Math.abs(e[d][d]))&&(A=k),!(Math.abs(e[d][d-1])<b*A));)d--;if(d===y)e[y][y]=e[y][y]+w,p[y]=e[y][y],_[y]=0,y--,c=0;else if(d===y-1){if(i=e[y][y-1]*e[y-1][y],C=(x=(e[y-1][y-1]-e[y][y])/2)*x+i,M=Math.sqrt(Math.abs(C)),e[y][y]=e[y][y]+w,e[y-1][y-1]=e[y-1][y-1]+w,r=e[y][y],C>=0){for(M=x>=0?x+M:x-M,p[y-1]=r+M,p[y]=p[y-1],0!==M&&(p[y]=r-i/M),_[y-1]=0,_[y]=0,x=(r=e[y][y-1])/(A=Math.abs(r)+Math.abs(M)),C=M/A,x/=S=Math.sqrt(x*x+C*C),C/=S,l=y-1;l<g;l++)M=e[y-1][l],e[y-1][l]=C*M+x*e[y][l],e[y][l]=C*e[y][l]-x*M;for(n=0;n<=y;n++)M=e[n][y-1],e[n][y-1]=C*M+x*e[n][y],e[n][y]=C*e[n][y]-x*M;for(n=0;n<=v;n++)M=f[n][y-1],f[n][y-1]=C*M+x*f[n][y],f[n][y]=C*f[n][y]-x*M}else p[y-1]=r+x,p[y]=r+x,_[y-1]=M,_[y]=-M;y-=2,c=0}else{if(r=e[y][y],o=0,i=0,d<y&&(o=e[y-1][y-1],i=e[y][y-1]*e[y-1][y]),10===c){for(w+=r,n=0;n<=y;n++)e[n][n]-=r;r=o=.75*(A=Math.abs(e[y][y-1])+Math.abs(e[y-1][y-2])),i=-.4375*A*A}if(30===c&&(A=(A=(o-r)/2)*A+i)>0){for(A=Math.sqrt(A),o<r&&(A=-A),A=r-i/((o-r)/2+A),n=0;n<=y;n++)e[n][n]-=A;w+=A,r=o=i=.964}for(c+=1,u=y-2;u>=d&&(x=((S=r-(M=e[u][u]))*(A=o-M)-i)/e[u+1][u]+e[u][u+1],C=e[u+1][u+1]-M-S-A,S=e[u+2][u+1],x/=A=Math.abs(x)+Math.abs(C)+Math.abs(S),C/=A,S/=A,u!==d)&&!(Math.abs(e[u][u-1])*(Math.abs(C)+Math.abs(S))<b*(Math.abs(x)*(Math.abs(e[u-1][u-1])+Math.abs(M)+Math.abs(e[u+1][u+1]))));)u--;for(n=u+2;n<=y;n++)e[n][n-2]=0,n>u+2&&(e[n][n-3]=0);for(h=u;h<=y-1;h++){var R=h!==y-1;if(h!==u&&(x=e[h][h-1],C=e[h+1][h-1],S=R?e[h+2][h-1]:0,0!==(r=Math.abs(x)+Math.abs(C)+Math.abs(S))&&(x/=r,C/=r,S/=r)),0===r)break;if(A=Math.sqrt(x*x+C*C+S*S),x<0&&(A=-A),0!==A){for(h!==u?e[h][h-1]=-A*r:d!==u&&(e[h][h-1]=-e[h][h-1]),r=(x+=A)/A,o=C/A,M=S/A,C/=x,S/=x,l=h;l<g;l++)x=e[h][l]+C*e[h+1][l],R&&(x+=S*e[h+2][l],e[h+2][l]=e[h+2][l]-x*M),e[h][l]=e[h][l]-x*r,e[h+1][l]=e[h+1][l]-x*o;for(n=0;n<=Math.min(y,h+3);n++)x=r*e[n][h]+o*e[n][h+1],R&&(x+=M*e[n][h+2],e[n][h+2]=e[n][h+2]-x*S),e[n][h]=e[n][h]-x,e[n][h+1]=e[n][h+1]-x*C;for(n=0;n<=v;n++)x=r*f[n][h]+o*f[n][h+1],R&&(x+=M*f[n][h+2],f[n][h+2]=f[n][h+2]-x*S),f[n][h]=f[n][h]-x,f[n][h+1]=f[n][h+1]-x*C}}}}if(0!==k){for(y=g-1;y>=0;y--)if(x=p[y],0===(C=_[y]))for(d=y,e[y][y]=1,n=y-1;n>=0;n--){for(i=e[n][n]-x,S=0,l=d;l<=y;l++)S+=e[n][l]*e[l][y];if(_[n]<0)M=i,A=S;else if(d=n,0===_[n]?e[n][y]=0!==i?-S/i:-S/(b*k):(r=e[n][n+1],o=e[n+1][n],s=(r*A-M*S)/(C=(p[n]-x)*(p[n]-x)+_[n]*_[n]),e[n][y]=s,Math.abs(r)>Math.abs(M)?e[n+1][y]=(-S-i*s)/r:e[n+1][y]=(-A-o*s)/M),b*(s=Math.abs(e[n][y]))*s>1)for(l=n;l<=y;l++)e[l][y]=e[l][y]/s}else if(C<0)for(d=y-1,Math.abs(e[y][y-1])>Math.abs(e[y-1][y])?(e[y-1][y-1]=C/e[y][y-1],e[y-1][y]=-(e[y][y]-x)/e[y][y-1]):(a=this.cdiv(0,-e[y-1][y],e[y-1][y-1]-x,C),e[y-1][y-1]=a.r,e[y-1][y]=a.i),e[y][y-1]=0,e[y][y]=1,n=y-2;n>=0;n--){var L=void 0,E=void 0,T=void 0,D=void 0;for(L=0,E=0,l=d;l<=y;l++)L+=e[n][l]*e[l][y-1],E+=e[n][l]*e[l][y];if(i=e[n][n]-x,_[n]<0)M=i,S=L,A=E;else if(d=n,0===_[n]?(a=this.cdiv(-L,-E,i,C),e[n][y-1]=a.r,e[n][y]=a.i):(r=e[n][n+1],o=e[n+1][n],T=(p[n]-x)*(p[n]-x)+_[n]*_[n]-C*C,D=2*(p[n]-x)*C,0===T&&0===D&&(T=b*k*(Math.abs(i)+Math.abs(C)+Math.abs(r)+Math.abs(o)+Math.abs(M))),a=this.cdiv(r*S-M*L+C*E,r*A-M*E-C*L,T,D),e[n][y-1]=a.r,e[n][y]=a.i,Math.abs(r)>Math.abs(M)+Math.abs(C)?(e[n+1][y-1]=(-L-i*e[n][y-1]+C*e[n][y])/r,e[n+1][y]=(-E-i*e[n][y]-C*e[n][y-1])/r):(a=this.cdiv(-S-o*e[n][y-1],-A-o*e[n][y],M,C),e[n+1][y-1]=a.r,e[n+1][y]=a.i)),b*(s=Math.max(Math.abs(e[n][y-1]),Math.abs(e[n][y])))*s>1)for(l=n;l<=y;l++)e[l][y-1]=e[l][y-1]/s,e[l][y]=e[l][y]/s}for(n=0;n<g;n++)if(n<0||n>v)for(l=n;l<g;l++)f[n][l]=e[n][l];for(l=g-1;l>=0;l--)for(n=0;n<=v;n++){for(M=0,h=0;h<=Math.min(l,v);h++)M+=f[n][h]*e[h][l];f[n][l]=M}}},e}(),h=Math.pow(2,-52),c=function(){function e(){this.rows=0,this.columns=0,this._data=[]}return e.FromArray=function(e){for(var t=e[0].length,s=e.length,i=this.Zero(s,t),r=0;r<s;r++)for(var o=0;o<t;o++)i._data[r][o]=e[r][o]||0;return i},e.Zero=function(t,s){return void 0===s&&(s=t),(new e).Reset(t,s)},e.Identity=function(e){for(var t=this.Zero(e),s=0;s<e;s++)t._data[s][s]=1;return t},e.Clone=function(e){for(var t=this.Zero(e.rows,e.columns),s=0;s<e.rows;s++)t._data[s]=new Float64Array(e._data[s]);return t},e.prototype.Reset=function(e,t){void 0===t&&(t=e),this._data=new Array(e);for(var s=0;s<e;s++)this._data[s]=new Float64Array(t);return this.rows=e,this.columns=t,this},e.prototype.CopyTo=function(e){e.rows=this.rows,e.columns=this.columns,e._data=[];for(var t=0;t<this.rows;t++)e._data[t]=new Float64Array(this._data[t]);return e},e.prototype.Row=function(e,t){return void 0!==t&&(this._data[e]=new Float64Array(t)),Array.from(this._data[e])},e.prototype.Column=function(e,t){if(void 0!==t)for(var s=0;s<this.rows;s++)this._data[s][e]=arguments[1][s];var i=new Array(this.rows);for(s=0;s<this.rows;s++)i[s]=this._data[s][e];return i},e.prototype.Transpose=function(){for(var t=e.Zero(this.columns,this.rows),s=0;s<this.rows;s++)for(var i=0;i<this.columns;i++)t._data[i][s]=this._data[s][i];return t},e.prototype.ToArray=function(e){void 0===e&&(e=!1);var t=[];if(e)for(var s=0;s<this.columns;s++)t.push(this.Column(s));else for(var i=0;i<this.rows;i++)t.push(this.Row(i));return t},e.prototype.EigenSystem=function(){return new l(this._data)},e.prototype.IsPosDef=function(){return new l(this._data).realvalues.every((function(e){return e>0}))},e.prototype.MakePosDef=function(t){void 0===t&&(t=h);var s,i,r=new l(this._data),o=r.realvalues.length,a=e.Zero(o),n=e.Zero(o),c=0,d=e.Zero(o);for(r.vectors.forEach((function(e,t){return d.Row(t,e)})),s=0;s<o;s++){for(i=0;i<o;i++)a._data[s][i]=t;r.realvalues[s]>t&&(a._data[s][s]=r.realvalues[s])}for(s=0;s<o;s++){for(c=0,i=0;i<o;i++)n._data[s][i]=0,c+=r.vectors[s][i]*r.vectors[s][i]*a._data[i][i];n._data[s][s]=Math.sqrt(1/c)}for(s=0;s<o;s++)a._data[s][s]=Math.sqrt(a._data[s][s]);for(var u=n.Multiply(d.Multiply(a)),m=u.Multiply(u.Transpose()).Symmetrize(),f=0;f<m.rows;f++)m._data[f][f]=1;return m},e.prototype.Symmetrize=function(t){void 0===t&&(t=!1);var s,i,r=this.Transpose(),o=e.Clone(this);if(t)for(s=1;s<this.rows;s++)for(i=0;i<s;i++)o._data[s][i]=r._data[s][i];else for(i=1;i<this.columns;i++)for(s=0;s<i;s++)o._data[s][i]=r._data[s][i];return o},e.prototype.Cholesky=function(t){if(void 0===t&&(t=!1),this.rows!==this.columns)throw new Error("matrix not square");var s,i,r,o,a,n=this.rows,l=e.Zero(n);for(o=0;o<n;o++){for(i=0,a=0;a<o;a++){for(s=0,r=0;r<a;r++)s+=l._data[r][a]*l._data[r][o];if(l._data[a][o]=s=(this._data[a][o]-s)/l._data[a][a],i+=s*s,this._data[a][o]!=this._data[o][a])throw new Error("matrix not symmetrical")}if((i=this._data[o][o]-i)<=0)throw new Error("matrix not pos-def");for(l._data[o][o]=i>0?Math.sqrt(i):0,a=o+1;a<n;a++)l._data[a][o]=0}return t?l.Transpose():l},e.prototype.Multiply=function(t){var s,i,r,o,a=e.Zero(this.rows,t.columns);for(s=0;s<this.rows;s++)for(i=0;i<t.columns;i++){for(o=r=0;r<this.columns;r++)o+=this._data[s][r]*t._data[r][i];a._data[s][i]=o}return a},e.prototype.Inverse=function(){if(this.rows!==this.columns)throw new Error("invalid matrix");var t,s,i,r,o=e.Clone(this),a=o.rows;for(s=1;s<a;s++)o._data[0][s]/=o._data[0][0];for(s=1;s<a;s++){for(i=s;i<a;i++){for(t=0,r=0;r<s;r++)t+=o._data[i][r]*o._data[r][s];o._data[i][s]-=t}if(s!=a-1)for(i=s+1;i<a;i++){for(t=0,r=0;r<s;r++)t+=o._data[s][r]*o._data[r][i];o._data[s][i]=(o._data[s][i]-t)/o._data[s][s]}}for(s=0;s<a;s++)for(i=s;i<a;i++){var n=1;if(s!=i)for(n=0,r=s;r<i;r++)n-=o._data[i][r]*o._data[r][s];o._data[i][s]=n/o._data[i][i]}for(s=0;s<a;s++)for(i=s;i<a;i++)if(s!=i){for(t=0,r=s;r<i;r++)t+=o._data[r][i]*(s==r?1:o._data[s][r]);o._data[s][i]=-t}for(s=0;s<a;s++)for(i=0;i<a;i++){for(t=0,r=s>i?s:i;r<a;r++)t+=(i==r?1:o._data[i][r])*o._data[r][s];o._data[i][s]=t}return o},e.prototype.SortColumns=function(t){void 0===t&&(t=!1);for(var s=e.Clone(this),i=t?function(e,t){return t-e}:function(e,t){return e-t},r=0;r<this.columns;r++)s.Column(r,this.Column(r).sort(i));return s},e.prototype.Rank=function(t){void 0===t&&(t=!1);for(var i,r=e.Clone(this),o=new Array(this.rows),a=new Array(this.rows),n=0;n<this.columns;n++){for(i=0;i<this.rows;i++)a[i]=i,o[i]=this._data[i][n];for(s.Sort(o,a),t&&a.reverse(),i=0;i<this.rows;i++)r._data[a[i]][n]=i}return r},e.prototype.Correl=function(){for(var t=new Array(this.columns),s=0;s<this.columns;s++)t[s]=this.Column(s);for(var i=e.Zero(this.columns),r=0;r<this.columns;r++){i._data[r][r]=1;for(var a=0;a<r;a++)i._data[r][a]=o.Correlation(t[r],t[a])}return i.Symmetrize()},e.prototype.IsSymmetric=function(){if(this.rows!=this.columns)return!1;for(var e=0;e<this.rows;e++)for(var t=0;t<this.columns;t++)if(this._data[e][t]!==this._data[t][e])return!1;return!0},e}();Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length,s=0;s<t;s++){if(arguments[s]===1/0||arguments[s]===-1/0)return 1/0;e+=arguments[s]*arguments[s]}return Math.sqrt(e)});for(var d=function(){function e(){}return e.Normal=function(e,t){var s=this;void 0===t&&(t={});var r=i({mean:0,sd:1,lhs:!1,ordered:!1},t);return(r.lhs?this.LHSField(e,r.ordered):this.UniformField(e,r.ordered)).map((function(e){return s.InverseNormal2(e)*r.sd+r.mean}))},e.ReverseInverseNormal2=function(e,t){var s=this;void 0===t&&(t=40);for(var i=[0,Math.min(1,Math.max(0,.5+.125*e)),1],r=i.map((function(e){return s.InverseNormal2(e)})),o=0;o<t;o++){if(Math.abs(r[1]-e)<=1e-6)return i[1];r[1]<e?(i=[i[1],(i[1]+i[2])/2,i[2]],r=[r[1],this.InverseNormal2(i[1]),r[2]]):(i=[i[0],(i[0]+i[1])/2,i[1]],r=[r[0],this.InverseNormal2(i[1]),r[1]])}return i[1]},e.TruncatedNormal=function(e,t){var s=this;void 0===t&&(t={});var r=i({mean:0,sd:1,lhs:!1,ordered:!1},t),o=r.lhs?this.LHSField(e,r.ordered):this.UniformField(e,r.ordered),a=0,n=1;"number"==typeof r.min&&(a=this.ReverseInverseNormal2((r.min-r.mean)/r.sd,r.max_iterations)),"number"==typeof r.max&&(n=this.ReverseInverseNormal2((r.max-r.mean)/r.sd,r.max_iterations));var l=n-a;return(o=o.map((function(e){return e*l+a}))).map((function(e){return s.InverseNormal2(e)*r.sd+r.mean}))},e.LogNormal=function(e,t){void 0===t&&(t={});for(var s=i({mean:1,sd:1,lhs:!1,ordered:!1},t),r=s.lhs?this.LHSFieldDouble(e,s.ordered):this.UniformField(e,s.ordered),o=0;o<r.length;o++)r[o]=Math.exp(this.InverseNormal2(r[o])*s.sd+s.mean);return r},e.LogNormalReturn=function(e,t){void 0===t&&(t={});var s=i({mean:1,sd:1,lhs:!1,ordered:!1},t),r=s.lhs?this.LHSFieldDouble(e,s.ordered):this.UniformField(e,s.ordered);s.mean+=1;for(var o=s.mean*s.mean,a=s.sd*s.sd,n=Math.log(o/Math.sqrt(o+a)),l=Math.sqrt(Math.log((o+a)/o)),h=0;h<e;h++)r[h]=Math.exp(this.InverseNormal2(r[h])*l+n)-1;return r},e.Triangular=function(e,t){var s=this;void 0===t&&(t={});var r=i({a:0,b:1,c:.5,lhs:!1,ordered:!1,field:null},t);return(r.field||(r.lhs?this.LHSField(e,r.ordered):this.UniformField(e,r.ordered))).map((function(e){return s.InverseTriangular(e,r.a,r.b,r.c)}))},e.PERT=function(e,t){void 0===t&&(t={});var s=i({field:null,lhs:!1,a:0,b:1,c:.5,lambda:4,ordered:!1},t),r=s.field||(s.lhs?this.LHSField(e,s.ordered):this.UniformField(e,s.ordered));return this.InversePERTField(r,s.a,s.b,s.c,s.lambda)},e.Uniform=function(e,t){void 0===t&&(t={});for(var s=i({lhs:!1,min:0,max:1,ordered:!1},t),r=s.lhs?this.LHSFieldDouble(e,s.ordered):this.UniformField(e,s.ordered),o=s.max-s.min,a=0;a<r.length;a++)r[a]=r[a]*o+s.min;return r},e.Bernoulli=function(e,t){void 0===t&&(t={});var s=i({lhs:!1,p:.5},t);return this.Uniform(e,{lhs:s.lhs,min:0,max:1}).map((function(e){return e<=s.p}))},e.Beta=function(e,t){var s=this;void 0===t&&(t={});var r=i({lhs:!1,a:0,b:1,ordered:!1},t);return(r.lhs?this.LHSField(e,r.ordered):this.UniformField(e,r.ordered)).map((function(e){return s.InverseBeta(e,r.a,r.b)}))},e.Discretize=function(e,t){var s=e.slice(0);t=t||Math.round;for(var i=0;i<s.length;i++)s[i]=t(s[i]);return s},e.Constant=function(e,t){for(var s=new Array(e),i=0;i<e;i++)s[i]=t;return s},e.Fixed=function(e,t){void 0===t&&(t={}),t=i({value:0},t);for(var s=new Array(e),r=0;r<e;r++)s[r]=t.value;return s},e.Conditional=function(e,t,s,i,r,o){void 0===r&&(r=0);for(var a=o||this.Bernoulli(e,{lhs:!0,p:t}),n=s(Math.ceil(e*t),i),l=new Array(e),h=0,c=0;h<e;h++)l[h]=a[h]?n[c++]:r;return l},e.Correlate=function(e,t,s){void 0===s&&(s=!1);var i,r=t.length,o=t[0].length,a=c.Zero(o,r);for(i=0;i<r;i++)a.Column(i,this.VDWField(o));var n=a.Multiply(e.Cholesky(!0).Multiply(a.Correl().Cholesky(!0).Inverse()).Transpose()).Rank();return s?t.map((function(e,t){var s=new Array(e.length),r=n.Column(t);for(i=0;i<r.length;i++)s[i]=e[r[i]];return s})):t.map((function(e,t){var s=e.slice(0).sort((function(e,t){return e-t})),r=new Array(e.length),o=n.Column(t);for(i=0;i<o.length;i++)r[i]=s[o[i]];return r}))},e.CorrelateCDM=function(e,t,s){void 0===s&&(s=!1);var i,r=t.length,o=t[0].length,n=a.Zero(o,r);for(i=0;i<r;i++)n.SetColumn(i,this.VDWField(o));var l=new a;if(l.rows=o,l.columns=r,l.data=t.map((function(e){return new Float64Array(e)})),!s)throw new Error("E_NOTIMPL: correlateCDM !ordered");return n.Multiply(e.Cholesky(!0).Multiply(n.Correl().Cholesky(!0).Inverse()).Transpose()).Rank2(!1,l).data},e.P80Pert=function(e,t,s,i){var r=this.PERTParameters(e,t,s,i),o=(r.max-r.min)/(this.InverseBeta(.9,r.v,r.w)-this.InverseBeta(.1,r.v,r.w)),a=r.min-this.InverseBeta(.1,r.v,r.w)*o,n=r.max+(1-this.InverseBeta(.9,r.v,r.w))*o;return{a:a/r.scale,b:n/r.scale,c:s}},e.P80Triangular=function(e,t,s){var i,r=(s-e)/(t-e),o=r<.5;o&&(r=1-r);var a=2.1266864*r-.1596122-2.1742909*r*r+1.1087738*r*r*r;o&&(a=1-a);var n=(t-e)/(.6890868-.4434898*r+.35757*r*r);return{a:i=s-a*n,b:i+n,c:s}},e.BetaDensity=function(e,t,s){if("number"!=typeof e){for(var i=new Array(e.length),r=0;r<e.length;r++)e[r]<=0||e[r]>=1?i[r]=0:i[r]=Math.exp((t-1)*Math.log(e[r])+(s-1)*Math.log(1-e[r])-this.LnGamma(t)-this.LnGamma(s)+this.LnGamma(t+s));return i}return e<=0||e>=1?0:Math.exp((t-1)*Math.log(e)+(s-1)*Math.log(1-e)-this.LnGamma(t)-this.LnGamma(s)+this.LnGamma(t+s))},e.PERTDensity=function(e,t,s,i,r){void 0===r&&(r=4);var o,a,n=(t+s+r*i)/(r+2);return a=(o=i===n?r/2+1:(n-t)*(2*i-t-s)/((i-n)*(s-t)))*(s-n)/(n-t),this.BetaDensity(e,o,a)},e.NormalDensity=function(e){if("number"!=typeof e){for(var t=new Array(e.length),s=0;s<e.length;s++)t[s]=.398942280401433*Math.exp(-e[s]*e[s]/2);return t}return.398942280401433*Math.exp(-e*e/2)},e.Shuffle=function(e){var s,i,r;for(i=e.length-1;i>=0;i--)s=Math.floor(t.Next()*(i+1)),r=e[i],e[i]=e[s],e[s]=r;return e},e.VDWField=function(e){if(this.vdw_cache.length!==e){this.vdw_cache=new Float64Array(e);for(var t=0;t<e;t++)this.vdw_cache[t]=this.InverseNormal2((t+1)/(e+1))}var s=new Float64Array(this.vdw_cache);return this.Shuffle(s)},e.LHSFieldDouble=function(e,s){void 0===s&&(s=!1);for(var i=1/e,r=new Float64Array(e),o=0;o<e;o++)r[o]=t.Next()*i+o*i;return s||this.Shuffle(r),r},e.LHSField=function(e,s){void 0===s&&(s=!1);for(var i=1/e,r=new Array(e),o=0;o<e;o++)r[o]=t.Next()*i+o*i;return s||this.Shuffle(r),r},e.UniformField=function(e,s){void 0===s&&(s=!1);for(var i=new Array(e),r=0;r<e;r++)i[r]=t.Next();return s&&i.sort((function(e,t){return e-t})),i},e.InverseTriangular=function(e,t,s,i){return t===s?t:e<=(i-t)/(s-t)?t+Math.sqrt((s-t)*(i-t)*e):s-Math.sqrt((s-t)*(s-i)*(1-e))},e.InverseNormal=function(e){return.5===e?0:(t=e<1&&e>.5?1-e:e,i=(s=Math.sqrt(Math.log(1/Math.pow(t,2))))-(2.515517+.802853*s+.010328*Math.pow(s,2))/(1+1.432788*s+.189269*Math.pow(s,2)+.001308*Math.pow(s,3)),e>.5?i:-i);var t,s,i},e.InverseNormal2=function(e){var t,s,i=e-.5;return Math.abs(i)<=.425?i*(((((((2509.0809287301227*(s=.180625-i*i)+33430.57558358813)*s+67265.7709270087)*s+45921.95393154987)*s+13731.69376550946)*s+1971.5909503065513)*s+133.14166789178438)*s+3.3871328727963665)/(((((((5226.495278852854*s+28729.085735721943)*s+39307.89580009271)*s+21213.794301586597)*s+5394.196021424751)*s+687.1870074920579)*s+42.31333070160091)*s+1):(s=i<0?e:1-e)<=0?0:(t=(s=Math.sqrt(-Math.log(s)))<=5?(((((((.0007745450142783414*(s-=1.6)+.022723844989269184)*s+.2417807251774506)*s+1.2704582524523684)*s+3.6478483247632045)*s+5.769497221460691)*s+4.630337846156546)*s+1.4234371107496835)/(((((((1.0507500716444169e-9*s+.0005475938084995345)*s+.015198666563616457)*s+.14810397642748008)*s+.6897673349851)*s+1.6763848301838038)*s+2.053191626637759)*s+1):(((((((2.0103343992922881e-7*(s-=5)+27115555687434876e-21)*s+.0012426609473880784)*s+.026532189526576124)*s+.29656057182850487)*s+1.7848265399172913)*s+5.463784911164114)*s+6.657904643501103)/(((((((20442631033899397e-31*s+1.421511758316446e-7)*s+18463183175100548e-21)*s+.0007868691311456133)*s+.014875361290850615)*s+.1369298809227358)*s+.599832206555888)*s+1),i<0?-t:t)},e.Log1p=function(e){var t=1+e;return Math.log(t)-(t-1-e)/t},e.BetaContFrac=function(t,s,i,r){var o,a=2*Number.MIN_VALUE,n=0,l=1,h=1-(t+s)*i/(t+1);for(Math.abs(h)<a&&(h=e.QUIET_NAN),o=h=1/h;n<512;){var c,d=n+1,u=d*(s-d)*i/((t-1+2*d)*(t+2*d));if(h=1+u*h,l=1+u/l,Math.abs(h)<a&&(h=e.QUIET_NAN),Math.abs(l)<a&&(l=e.QUIET_NAN),o*=(h=1/h)*l,h=1+(u=-(t+d)*(t+s+d)*i/((t+2*d)*(t+2*d+1)))*h,l=1+u/l,Math.abs(h)<a&&(h=e.QUIET_NAN),Math.abs(l)<a&&(l=e.QUIET_NAN),o*=c=(h=1/h)*l,Math.abs(c-1)<2*e.EPSILON_DOUBLE)break;if(o*Math.abs(c-1)<r)break;++n}return n>=512?e.QUIET_NAN:o},e.BetaCDF=function(t,s,i){if(t<=0)return 0;if(t>=1)return 1;if(0===t)return 0;if(1===t)return 1;var r,o=-(this.LnGamma(s)+this.LnGamma(i)-this.LnGamma(s+i))+s*Math.log(t)+i*this.Log1p(-t),a=Math.exp(o);return t<(s+1)/(s+i+2)?(r=Math.abs(0/(1*a/s))*e.EPSILON_DOUBLE,a*this.BetaContFrac(s,i,t,r)/s*1+0):(r=Math.abs(1/(1*a/i))*e.EPSILON_DOUBLE,1*(1-a*this.BetaContFrac(i,s,1-t,r)/i)+0)},e.LnGamma=function(e){var t=e-1,s=t+5.5;s-=(t+.5)*Math.log(s);var i=1;return i+=76.18009173/(t+=1),i+=-86.50532033/(t+=1),i+=24.01409822/(t+=1),i+=-1.231739516/(t+=1),i+=.00120858003/(t+=1),i+=-536382e-11/(t+=1),-s+Math.log(2.50662827465*i)},e.BetaPDF=function(e,t,s){return e<0||e>1?0:Math.exp(this.LnGamma(t+s)-this.LnGamma(t)-this.LnGamma(s))*Math.pow(e,t-1)*Math.pow(1-e,s-1)},e.InverseBeta=function(e,t,s){var i,r,o,a,n,l,h,c,d=0;if(e<0||e>1||t<0||s<0)return 0;if(0===e)return 0;if(1===e)return 1;if(e>.5){var u=1-e;return u>.5?this.InverseBeta(1-u,t,s):1-this.InverseBeta(u,s,t)}if(r=t/(t+s),e<.1){var m=(Math.log(t)+this.LnGamma(t)+this.LnGamma(s)-this.LnGamma(t+s)+Math.log(e))/t;m<=0?(i=Math.exp(m),i*=Math.pow(1-i,-(s-1)/t)):i=r,i>r&&(i=r)}else i=r;do{if(a=e-this.BetaCDF(i,t,s),n=this.BetaPDF(i,t,s),0===a||d++>64)return i;c=-((t-1)/i-(s-1)/(1-i))*(o=a/Math.max(2*Math.abs(a/i),n))*o/2,l=h=o,Math.abs(c)<Math.abs(h)?l+=c:l*=2*Math.abs(h/c),i+l>0&&i+l<1?i+=l:i=Math.sqrt(i)*Math.sqrt(r)}while(Math.abs(h)>1e-10*i);return i},e.InversePERTField=function(e,t,s,i,r){var o=this;if(s<=t)return e.map((function(){return t}));try{var a=this.PERTParameters(t,s,i,r);return e.map((function(e){return(o.InverseBeta(e,a.v,a.w)*(a.max-a.min)+a.min)/a.scale}))}catch(i){return t===s?e.map((function(e){return t})):e.map((function(e){return 0}))}},e.PERTParameters=function(e,t,s,i){if(void 0===i&&(i=4),e>=t||i<0||s<e||s>t)throw new Error("Invalid parameters");for(var r,o,a=1;Math.abs(e)<1&&Math.abs(t)<1;)a*=10,e*=10,t*=10,s*=10;return r=(e+t+i*s)/(i+2),{v:o=(0===s?Math.abs(r-s):Math.abs((r-s)/s))<=1e-12?i/2+1:(r-e)*(2*s-e-t)/((s-r)*(t-e)),w:o*(t-r)/(r-e),min:e,max:t,scale:a}},e.InversePERT=function(e,t,s,i,r){void 0===r&&(r=4);var o=this.PERTParameters(t,s,i,r);return(this.InverseBeta(e,o.v,o.w)*(o.max-o.min)+o.min)/o.scale},e.EPSILON_DOUBLE=2220446049250313e-31,e.QUIET_NAN=Number.NaN,e.M_LN_SQRT_2PI=.9189385332046728,e.M_1_SQRT_2PI=.3989422804014327,e.vdw_cache=new Float64Array(0),e}(),u=new Array(256),m=0;m<256;++m)u[m]=(m+256).toString(16).substr(1);var f=function(){function e(){this.buffer=[],this.buffer=[];for(var e=0;e<16;e++)this.buffer[e]=Math.floor(256*t.Next())}return e.prototype.toString=function(){var e=0;return u[this.buffer[e++]]+u[this.buffer[e++]]+u[this.buffer[e++]]+u[this.buffer[e++]]+"-"+u[this.buffer[e++]]+u[this.buffer[e++]]+"-"+u[this.buffer[e++]]+u[this.buffer[e++]]+"-"+u[this.buffer[e++]]+u[this.buffer[e++]]+"-"+u[this.buffer[e++]]+u[this.buffer[e++]]+u[this.buffer[e++]]+u[this.buffer[e++]]+u[this.buffer[e++]]+u[this.buffer[e++]]},e}();e.CDMatrix=a,e.Eigensystem=l,e.MC=d,e.Matrix=c,e.QSort=r,e.QSort2=s,e.Random=t,e.Stats=o,e.UUID=f,e.Util=n,Object.defineProperty(e,"__esModule",{value:!0})}(t)}},t={};function s(i){var r=t[i];if(void 0!==r)return r.exports;var o=t[i]={exports:{}};return e[i].call(o.exports,o,o.exports,s),o.exports}s.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),s.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{"use strict";function e(e,t){var s={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(s[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(s[i[r]]=e[i[r]])}return s}function t(e,t,s,i){return new(s||(s=Promise))((function(r,o){function a(e){try{l(i.next(e))}catch(e){o(e)}}function n(e){try{l(i.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(a,n)}l((i=i.apply(e,t||[])).next())}))}Object.create,Object.create;const i=e=>"object"==typeof e&&void 0!==e.row&&void 0!==e.column;class r{constructor(e,t=e,s=!1){this.end_=this.PatchNull(t),this.start_=this.PatchNull(e),s&&this.Normalize()}static FromColumn(e){return new r({row:1/0,column:e})}static FromRow(e){return new r({row:e,column:1/0})}static ColumnToLabel(e){let t=String.fromCharCode(65+e%26);for(;e>25;)e=Math.floor(e/26)-1,t=String.fromCharCode(65+e%26)+t;return t}static CellAddressToLabel(e,t=!1){return(t?`${e.sheet_id||0}!`:"")+(e.absolute_column?"$":"")+this.ColumnToLabel(e.column)+(e.absolute_row?"$":"")+(e.row+1)}static Join(e,...t){const s=new r(e.start,e.end);for(const e of t)e&&(s.ConsumeAddress(e.start),s.ConsumeAddress(e.end));return s}static Bleed(e,t=1){return new r({row:Math.max(0,e.start.row-t),column:Math.max(0,e.start.column-t)},{row:e.end.row+t,column:e.end.column+t})}get start(){return Object.assign({},this.start_)}set start(e){this.start_=e}get end(){return Object.assign({},this.end_)}set end(e){this.end_=e}get rows(){return this.start_.row===1/0||this.end_.row===1/0?1/0:this.end_.row-this.start_.row+1}get columns(){return this.start_.column===1/0||this.end_.column===1/0?1/0:this.end_.column-this.start_.column+1}get count(){return this.rows*this.columns}get entire_sheet(){return this.entire_row&&this.entire_column}get entire_column(){return this.start_.row===1/0}get entire_row(){return this.start_.column===1/0}PatchNull(e){const t=Object.assign({},e);return null===t.row&&(t.row=1/0),null===t.column&&(t.column=1/0),t}SetSheetID(e){this.start_.sheet_id=e}Normalize(){const e=Object.assign({},this.start_),t=Object.assign({},this.end_);e.row===1/0||t.row===1/0?e.row=t.row=1/0:e.row>t.row&&(e.row=this.end_.row,e.absolute_row=this.end_.absolute_row,t.row=this.start_.row,t.absolute_row=this.start_.absolute_row),e.column===1/0||t.column===1/0?e.column=t.column=1/0:e.column>t.column&&(e.column=this.end_.column,e.absolute_column=this.end_.absolute_column,t.column=this.start_.column,t.absolute_column=this.start_.absolute_column),this.start_=e,this.end_=t}TopLeft(){const e={row:0,column:0};return this.entire_row||(e.column=this.start.column),this.entire_column||(e.row=this.start.row),e}BottomRight(){const e={row:0,column:0};return this.entire_row||(e.column=this.end.column),this.entire_column||(e.row=this.end.row),e}ContainsRow(e){return this.entire_column||e>=this.start_.row&&e<=this.end_.row}ContainsColumn(e){return this.entire_row||e>=this.start_.column&&e<=this.end_.column}Contains(e){return(this.entire_column||e.row>=this.start_.row&&e.row<=this.end_.row)&&(this.entire_row||e.column>=this.start_.column&&e.column<=this.end_.column)}ContainsArea(e){return this.start.column<=e.start.column&&this.end.column>=e.end.column&&this.start.row<=e.start.row&&this.end.row>=e.end.row}Intersects(e){return!(e.start.column>this.end.column||this.start.column>e.end.column||e.start.row>this.end.row||this.start.row>e.end.row)}Equals(e){return e.start_.row===this.start_.row&&e.start_.column===this.start_.column&&e.end_.row===this.end_.row&&e.end_.column===this.end_.column}Clone(){return new r(this.start,this.end)}Array(){if(this.entire_column||this.entire_row)throw new Error("can't convert infinite area to array");const e=new Array(this.rows*this.columns),t=this.start_.sheet_id;let s=0;for(let i=this.start_.row;i<=this.end_.row;i++)for(let r=this.start_.column;r<=this.end_.column;r++)e[s++]={row:i,column:r,sheet_id:t};return e}get left(){const e=new r(this.start_,this.end_);return e.end_.column=e.start_.column,e}get right(){const e=new r(this.start_,this.end_);return e.start_.column=e.end_.column,e}get top(){const e=new r(this.start_,this.end_);return e.end_.row=e.start_.row,e}get bottom(){const e=new r(this.start_,this.end_);return e.start_.row=e.end_.row,e}Shift(e,t){return this.start_.row+=e,this.start_.column+=t,this.end_.row+=e,this.end_.column+=t,this}ConsumeAddress(e){this.entire_row||(e.column<this.start_.column&&(this.start_.column=e.column),e.column>this.end_.column&&(this.end_.column=e.column)),this.entire_column||(e.row<this.start_.row&&(this.start_.row=e.row),e.row>this.end_.row&&(this.end_.row=e.row))}ConsumeArea(e){this.ConsumeAddress(e.start),this.ConsumeAddress(e.end)}Resize(e,t){return this.end_.row=this.start_.row+e-1,this.end_.column=this.start_.column+t-1,this}Iterate(e){if(this.entire_column||this.entire_row)console.warn("don't iterate infinite area");else for(let t=this.start_.column;t<=this.end_.column;t++)for(let s=this.start_.row;s<=this.end_.row;s++)e({column:t,row:s,sheet_id:this.start_.sheet_id})}get spreadsheet_label(){let e;return this.entire_sheet?"":this.entire_column?(e=r.ColumnToLabel(this.start_.column),e+=":"+r.ColumnToLabel(this.end_.column),e):this.entire_row?(e=String(this.start_.row+1),e+=":"+(this.end_.row+1),e):(e=r.CellAddressToLabel(this.start_),this.columns>1||this.rows>1?e+":"+r.CellAddressToLabel(this.end_):e)}toJSON(){return{start:Object.assign({},this.start_),end:Object.assign({},this.end_)}}}const o=e=>"object"==typeof e&&!!e&&"number"==typeof e.real&&"number"==typeof e.imaginary;var a;!function(e){e[e[void 0]=0]="undefined",e[e.formula=1]="formula",e[e.string=2]="string",e[e.number=3]="number",e[e.boolean=4]="boolean",e[e.object=5]="object",e[e.error=6]="error",e[e.complex=7]="complex",e[e.array=8]="array"}(a||(a={}));const n=e=>{switch(typeof e){case"undefined":return a.undefined;case"number":return a.number;case"boolean":return a.boolean;case"object":return null===e?a.undefined:o(e)?a.complex:a.object;case"string":return"="===e[0]?a.formula:a.string;default:return a.error}};var l;!function(e){e[e.List=0]="List",e[e.Date=1]="Date",e[e.Range=2]="Range",e[e.Number=3]="Number",e[e.Boolean=4]="Boolean"}(l||(l={}));class h{constructor(e,t){this.type=a.undefined,this.render_dirty=!0,void 0!==e&&this.Set(e,t)}static StringToColumn(e){let t=0;e=e.toUpperCase();for(let s=0;s<e.length;s++)t*=26,t+=e.charCodeAt(s)-64;return t-1}ValueIsNumber(){return this.type===a.number}ValueIsFormula(){return this.type===a.formula}ValueIsBoolean(){return this.type===a.boolean}ValueIsComplex(){return this.type===a.complex}FlushStyle(){this.formatted=this.rendered_type=this.style=void 0,this.render_dirty=!0}FlushArray(){this.area=void 0}FlushCache(){this.calculated=this.calculated_type=this.formatted=this.rendered_type=this.render_function=this.click_function=void 0,this.render_dirty=!0}Reset(){this.type=a.undefined,this.value=this.note=this.hyperlink=this.formatted=this.rendered_type=this.style=this.calculated=this.calculated_type=this.area=this.renderer_data=this.render_function=this.click_function=void 0,this.render_dirty=!0}Set(e,t=n(e)){this.value=e,this.type=t,this.formatted=this.rendered_type=this.style=this.calculated=this.calculated_type=this.render_function=this.click_function=this.area=void 0,this.render_dirty=!0}SetCalculatedValue(e,t=n(e)){this.calculated!==e&&(this.calculated=e,this.calculated_type=t,this.formatted=this.rendered_type=void 0,this.render_dirty=!0)}SetCalculatedValueOrError(e,t){void 0===t&&("object"==typeof e&&e.error?(t=a.error,e=e.error):t=n(e)),this.calculated!==e&&(this.calculated=e,this.calculated_type=t,this.formatted=this.rendered_type=void 0,this.render_dirty=!0)}GetValue(){return this.calculated_type?this.calculated:"string"==typeof this.value&&"'"===this.value[0]?this.value.slice(1):this.value}GetValue4(){return this.calculated_type?{type:this.calculated_type,value:this.calculated}:this.type===a.formula?{type:a.number,value:0}:{type:this.type,value:"string"==typeof this.value&&"'"===this.value[0]?this.value.slice(1):this.value}}SetNote(e){this.note=e,this.render_dirty=!0}SetCalculationError(e="ERR"){this.SetCalculatedValue(e,a.error)}SetArray(e){this.type=a.undefined,this.value=this.formatted=this.rendered_type=this.style=this.hyperlink=this.calculated=this.calculated_type=void 0,this.area=e,this.render_dirty=!0}SetArrayHead(e,t){this.type=n(t),this.value=t,this.formatted=this.rendered_type=this.style=this.calculated=this.calculated_type=void 0,this.area=e,this.render_dirty=!0}}const c=e=>!e.cells,d=e=>!!e[0]&&c(e[0]),u=e=>!!e[0]&&void 0!==e[0].row;class m{constructor(){this.data=[],this.rows_=0,this.columns_=0}get rows(){return this.rows_}get columns(){return this.columns_}EnsureRow(e){this.rows_=Math.max(e+1,this.rows_)}EnsureColumn(e){this.columns_=Math.max(e+1,this.columns_)}InsertColumns(e=0,t=1){this.data=this.data.map((s=>{if(s.length>=e){const i=s.slice(0,e);let r=e+t;return s.slice(e).forEach((e=>i[r++]=e)),i}return s})),this.columns_+=t}DeleteColumns(e,t=1){this.data.forEach((s=>s.splice(e,t))),this.columns_-=t}DeleteRows(e,t=1){this.data.splice(e,t),this.rows_-=t}InsertRows(e=0,t=1){const s=[e,0,[]];for(let e=1;e<t;e++)s.push([]);Array.prototype.splice.apply(this.data,s),this.rows_+=t}GetCell(e,t){const{row:s,column:i}=e;if(!this.data[s]){if(!t)return;this.data[s]=[],this.rows_=Math.max(this.rows_,s+1)}return this.data[s][i]||t&&(this.data[s][i]=new h,this.columns_=Math.max(this.columns_,i+1)),this.data[s][i]}EnsureCell(e){const{row:t,column:s}=e;let i=this.data[t];i||(this.data[t]=i=[],this.rows_=Math.max(this.rows_,t+1));let r=i[s];return r||(r=i[s]=new h,this.columns_=Math.max(this.columns_,s+1)),r}FromArray(e=[],t=!1){this.data=[];let s=0,i=0;if(t){i=e.length;for(let t=0;t<i;t++){const i=e[t];s=Math.max(s,i.length);for(let e=0;e<i.length;e++)this.data[e]||(this.data[e]=[]),this.data[e][t]=new h(i[e])}}else{s=e.length;for(let t=0;t<s;t++){const s=[],r=e[t];i=Math.max(i,r.length);for(let e=0;e<r.length;e++)s[e]=new h(r[e]);this.data[t]=s}}this.rows_=s,this.columns_=i}FromJSON(e=[],t){if(this.data=[],!d(e)){const t=[];if(u(e))for(const s of e)for(const e of s.cells)t.push(Object.assign(Object.assign({},e),{row:s.row}));else for(const s of e)for(const e of s.cells)t.push(Object.assign(Object.assign({},e),{column:s.column}));e=t}for(const s of e){this.data[s.row]||(this.data[s.row]=[]);const e=new h(s.value);if(void 0!==s.calculated&&e.SetCalculatedValue(s.calculated,s.calculated_type),t&&void 0!==s.style_ref&&(e.style=t[s.style_ref]),void 0!==s.note&&(e.note=s.note),void 0!==s.hyperlink&&(e.hyperlink=s.hyperlink),this.data[s.row][s.column]&&this.data[s.row][s.column].area&&(e.area=this.data[s.row][s.column].area),this.data[s.row][s.column]=e,s.area){const e=new r(s.area.start,s.area.end);for(let t=e.start.row;t<=e.end.row;t++)for(let s=e.start.column;s<=e.end.column;s++)this.data[t]||(this.data[t]=[]),this.data[t][s]||(this.data[t][s]=new h),this.data[t][s].area=e}if(s.merge_area){const e=new r(s.merge_area.start,s.merge_area.end);for(let t=e.start.row;t<=e.end.row;t++)for(let s=e.start.column;s<=e.end.column;s++)this.data[t]||(this.data[t]=[]),this.data[t][s]||(this.data[t][s]=new h),this.data[t][s].merge_area=e}s.validation&&(e.validation=s.validation)}this.rows_=this.data.length,this.columns_=this.data.reduce(((e,t)=>Math.max(e,t.length)),0)}toJSON(t={}){let s,i=0,r=0,o=this.data.length-1;t.subset&&(i=t.subset.start.column,r=t.subset.start.row,o=t.subset.end.row);const n=[];let l=-1,h=-1;const c={},d={};for(let e=r;e<=o;e++)if(this.data[e]){const r=this.data[e];s=r.length-1,t.subset&&(s=t.subset.end.column);for(let o=i;o<=s;o++){const s=r[o],i=s&&s.merge_area&&s.merge_area.start.row===e&&s.merge_area.start.column===o,u=s&&s.area&&s.area.start.row===e&&s.area.start.column===o,m=!s||s.type===a.string&&!s.value;if(s&&(!m||t.preserve_empty_strings)&&(i||s.type||s.calculated_type&&t.expand_arrays||s.calculated_type&&t.calculated_value||s.validation||t.decorated_cells&&s.style&&(s.style.fill||s.style.border_bottom||s.style.border_top||s.style.border_left||s.style.border_right))){const i={row:e,column:o,value:s.value};s.note&&(i.note=s.note),s.hyperlink&&(i.hyperlink=s.hyperlink),t.preserve_type&&(i.type=s.type),t.sheet_id&&(i.sheet_id=t.sheet_id),t.calculated_value&&void 0!==s.calculated&&(i.calculated=s.calculated,(t.preserve_type||s.calculated_type===a.error)&&(i.calculated_type=s.calculated_type)),s.area&&u&&(i.area=s.area.toJSON()),s.merge_area&&(i.merge_area=s.merge_area.toJSON()),s.validation&&(i.validation=s.validation),t.cell_style_refs&&t.cell_style_refs[o]&&t.cell_style_refs[o][e]&&(i.style_ref=t.cell_style_refs[o][e],t.cell_style_refs[o][e]=0),c[e]=e,d[o]=o,l=Math.max(e,l),h=Math.max(o,h),n.push(i)}}}if(t.nested){const t=Object.keys(c),s=Object.keys(d);if(t.length<=s.length&&t.length){const s={},i=[];for(const t of n){const{row:i}=t,r=e(t,["row"]);s[t.row]||(s[t.row]=[]),s[t.row].push(r)}for(const e of t){const t=Number(e);i.push({row:t,cells:s[t]})}return{data:i,rows:l,columns:h+1}}if(s.length){const t={},i=[];for(const s of n){const{column:i}=s,r=e(s,["column"]);t[s.column]||(t[s.column]=[]),t[s.column].push(r)}for(const e of s){const s=Number(e);i.push({column:s,cells:t[s]})}return{data:i,rows:l,columns:h+1}}}return{data:n,rows:l+1,columns:h+1}}GetAll(e=!1){return this.GetRange({row:0,column:0},{row:this.rows_-1,column:this.columns_-1},e)}Normalize2(e,t){return e.column===1/0&&(e=Object.assign(Object.assign({},e),{column:0})),e.row===1/0&&(e=Object.assign(Object.assign({},e),{row:0})),t.column===1/0&&(t=Object.assign(Object.assign({},t),{column:this.columns_-1})),t.row===1/0&&(t=Object.assign(Object.assign({},t),{row:this.rows_-1})),{from:e,to:t}}Normalize1(e){return e.column===1/0&&(e=Object.assign(Object.assign({},e),{column:0})),e.row===1/0&&(e=Object.assign(Object.assign({},e),{row:0})),e}RawValue(e,t=e){if(({from:e,to:t}=this.Normalize2(e,t)),e.row===t.row&&e.column===t.column)return this.data[e.row]&&this.data[e.row][e.column]?this.data[e.row][e.column].value:void 0;const s=[],i=this.data.slice(e.row,t.row+1),r=e.column,o=t.column+1;for(const e of i){const t=[];for(let s=r,i=0;s<o;s++,i++){const i=e[s];t.push(i?i.value:void 0)}s.push(t)}return s}GetRange(e,t,s=!1){if(t?({from:e,to:t}=this.Normalize2(e,t)):e=this.Normalize1(e),!t||e===t||e.column===t.column&&e.row===t.row)return this.data[e.row]&&this.data[e.row][e.column]?this.data[e.row][e.column].GetValue():void 0;const i=[];if(s)for(let s=e.column;s<=t.column;s++){const r=[];for(let i=e.row;i<=t.row;i++)this.data[i]&&this.data[i][s]?r.push(this.data[i][s].GetValue()):r.push(void 0);i.push(r)}else for(let s=e.row;s<=t.row;s++){const r=[];for(let i=e.column;i<=t.column;i++)this.data[s]&&this.data[s][i]?r.push(this.data[s][i].GetValue()):r.push(void 0);i.push(r)}return i}GetRange4(e,t=e,s=!1){if(({from:e,to:t}=this.Normalize2(e,t)),e.row===t.row&&e.column===t.column)return this.data[e.row]&&this.data[e.row][e.column]?this.data[e.row][e.column].GetValue4():{value:void 0,type:a.undefined};const i=[];if(s)for(let s=e.column;s<=t.column;s++){const r=[];for(let i=e.row;i<=t.row;i++)this.data[i]&&this.data[i][s]?r.push(this.data[i][s].GetValue4()):r.push({type:a.undefined});i.push(r)}else for(let s=e.row;s<=t.row;s++){const r=[];for(let i=e.column;i<=t.column;i++)this.data[s]&&this.data[s][i]?r.push(this.data[s][i].GetValue4()):r.push({type:a.undefined});i.push(r)}return{type:a.array,value:i}}Apply(e,t,s=!1){if(i(e)&&(e=new r(e)),e.entire_column||e.entire_row)throw new Error("don't iterate infinite cells");const o=e.start,a=e.end;if(s)for(let e=o.row;e<=a.row;e++){this.data[e]||(this.data[e]=[]);const s=this.data[e];for(let i=o.column;i<=a.column;i++)s[i]||(s[i]=new h),t(s[i],i,e)}else for(let e=o.row;e<=a.row;e++)if(this.data[e]){const s=this.data[e];for(let i=o.column;i<=a.column;i++)s[i]&&t(s[i],i,e)}}SetArea(e,t){if(ArrayBuffer.isView(t))throw new Error("ABIV");if(Array.isArray(t))for(let s=e.start.row,i=0;s<=e.end.row;s++,i++){this.data[s]||(this.data[s]=[]);const r=this.data[s];if(t[i])for(let s=e.start.column,o=0;s<=e.end.column;s++,o++)r[s]||(r[s]=new h),r[s].Set(t[i][o])}else{const s=n(t);for(let i=e.start.row;i<=e.end.row;i++){this.data[i]||(this.data[i]=[]);const r=this.data[i];for(let i=e.start.column;i<=e.end.column;i++)r[i]||(r[i]=new h),r[i].Set(t,s)}}this.rows_=Math.max(this.rows_,e.end.row+1),this.columns_=Math.max(this.columns_,e.end.column+1)}IterateAll(e){for(const t of this.data)if(t)for(const s of t)s&&e(s)}FlushCellStyles(){for(const e of this.data)if(e)for(const t of e)t&&t.FlushStyle()}FlushCachedValues(){for(const e of this.data)if(e)for(const t of e)t&&t.FlushCache()}}class f{static UpdateLocale(e){var t;if(e)this.locale=e;else if("undefined"!=typeof self){const e=null===(t=null===self||void 0===self?void 0:self.document)||void 0===t?void 0:t.location;if(e&&e.search&&/locale=([^?&]+?)(?:\?|$|&)/.test(e.search)){const t=e.search.match(/locale=(.*?)(?:\?|$|&)/);t&&(this.locale=t[1]),console.info("override locale",this.locale)}else"undefined"!=typeof navigator&&(navigator.languages&&navigator.languages[0]?this.locale=navigator.languages[0]:this.locale=navigator.language)}const s=new Intl.NumberFormat(this.locale,{minimumFractionDigits:1}).format(3.3).replace(/\d/g,"");this.decimal_separator=","===s?",":".",","===this.decimal_separator&&(this.argument_separator=";",this.grouping_separator=" ");let i=new Date(2e3,0,2,12,0,0,0);this.UpdateDateComponent(0,0,i),i=new Date(2e3,1,7,12,0,0,0),this.UpdateDateComponent(1,1,i),i=new Date(2e3,2,7,12,0,0,0),this.UpdateDateComponent(2,2,i),i=new Date(2e3,3,5,12,0,0,0),this.UpdateDateComponent(3,3,i),i=new Date(2e3,4,4,12,0,0,0),this.UpdateDateComponent(4,4,i),i=new Date(2e3,5,2,12,0,0,0),this.UpdateDateComponent(5,5,i),i=new Date(2e3,6,1,12,0,0,0),this.UpdateDateComponent(6,6,i),i=new Date(2e3,7,1,12,0,0,0),this.UpdateDateComponent(7,-1,i),i=new Date(2e3,8,1,12,0,0,0),this.UpdateDateComponent(8,-1,i),i=new Date(2e3,9,1,12,0,0,0),this.UpdateDateComponent(9,-1,i),i=new Date(2e3,10,1,12,0,0,0),this.UpdateDateComponent(10,-1,i),i=new Date(2e3,11,1,12,0,0,0),this.UpdateDateComponent(11,-1,i)}static UpdateDateComponent(e,t,s){t>=0&&(this.date_components.short_days[t]=s.toLocaleString(this.locale,{weekday:"short"}),this.date_components.long_days[t]=s.toLocaleString(this.locale,{weekday:"long"})),e>=0&&(this.date_components.short_months[e]=s.toLocaleString(this.locale,{month:"short"}),this.date_components.long_months[e]=s.toLocaleString(this.locale,{month:"long"}))}}f.locale="en-us",f.decimal_separator=".",f.argument_separator=",",f.grouping_separator=",",f.date_components={short_days:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],long_days:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],short_months:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],long_months:["January","February","March","April","May","June","July","August","September","October","November","December"]},f.UpdateLocale();class p{constructor(e=0,t=0,s=0,i=0){this.left=e,this.top=t,this.width=s,this.height=i}get right(){return this.left+this.width}get bottom(){return this.top+this.height}static Create(e){return new p(e.left||0,e.top||0,e.width||0,e.height||0)}static IsRectangle(e){var t,s,i,r;return"object"==typeof e&&"number"==typeof(null===(t=e)||void 0===t?void 0:t.left)&&"number"==typeof(null===(s=e)||void 0===s?void 0:s.top)&&"number"==typeof(null===(i=e)||void 0===i?void 0:i.width)&&"number"==typeof(null===(r=e)||void 0===r?void 0:r.height)}Shift(e=0,t=0){return new p(this.left+e,this.top+t,this.width,this.height)}Scale(e=1,t=e){return new p(this.left*e,this.top*t,this.width*e,this.height*t)}Expand(e=0,t=0){return new p(this.left,this.top,this.width+e,this.height+t)}Combine(e){return new p(Math.min(this.left,e.left),Math.min(this.top,e.top),Math.max(this.right,e.right)-Math.min(this.left,e.left),Math.max(this.bottom,e.bottom)-Math.min(this.top,e.top))}CheckEdges(e,t,s=16){let i=0;return e-this.left<s&&(i|=1),this.right-e<s&&(i|=2),t-this.top<s&&(i|=4),this.bottom-t<s&&(i|=8),i}Contains(e,t,s=0){return e>=this.left-s&&e<=this.left+this.width+s&&t>=this.top-s&&t<=this.top+this.height+s}ContextFill(e){e.fillRect(this.left,this.top,this.width,this.height)}ContextStroke(e){e.strokeRect(this.left,this.top,this.width,this.height)}Clamp(e,t){return{x:e=Math.min(Math.max(e,this.left),this.right),y:t=Math.min(Math.max(t,this.top),this.bottom)}}ApplyStyle(e){e.style.top=this.top+"px",e.style.left=this.left+"px",e.style.width=this.width+"px",e.style.height=this.height+"px"}toJSON(){return{top:this.top,left:this.left,width:this.width,height:this.height}}}var _,g;!function(e){const t=JSON.stringify({});let s,i;!function(e){e[e.None=0]="None",e[e.Left=1]="Left",e[e.Center=2]="Center",e[e.Right=3]="Right"}(s=e.HorizontalAlign||(e.HorizontalAlign={})),function(e){e[e.None=0]="None",e[e.Top=1]="Top",e[e.Bottom=2]="Bottom",e[e.Middle=3]="Middle"}(i=e.VerticalAlign||(e.VerticalAlign={})),e.DefaultProperties={horizontal_align:s.None,vertical_align:i.None,number_format:"General",nan:"NaN",font_size_value:10,font_size_unit:"pt",font_face:"calibri",font_bold:!1,font_italic:!1,font_underline:!1,font_strike:!1,text:{theme:1},border_top:0,border_left:0,border_right:0,border_bottom:0},e.Merge=(e,t,s=!0)=>{const i=s?Object.assign(Object.assign({},e),t):Object.assign({},t);return JSON.parse(JSON.stringify(i))},e.Composite=e=>JSON.parse(JSON.stringify(e.reduce(((e,t)=>Object.assign(Object.assign({},e),t)),{}))),e.Empty=e=>JSON.stringify(e)===t,e.ValidColor=e=>!(!e||e.none||!e.text&&!e.theme&&0!==e.theme),e.ParseFontSize=(e="",t="em")=>{const s=e.match(/(-*[\d.]+)\s*(\S*)/);if(s){const e=Number(s[1]);if(!e||isNaN(e)||e<0)return{};let i=s[2].toLowerCase()||t;if("pt"===i||"em"===i||"%"===i||"px"===i)return{font_size_unit:i,font_size_value:e}}return{}},e.RelativeFontSize=(e,t)=>{let s=12,i=12;switch(e.font_size_unit){case"pt":if(!e.font_size_value)return 1;i=e.font_size_value;break;case"px":if(!e.font_size_value)return 1;i=Math.round(300*e.font_size_value/4)/100;break;case"em":return e.font_size_value||1;case"%":return(e.font_size_value||100)/100;default:return 1}switch(t.font_size_unit){case"pt":if(!t.font_size_value)return 1;s=t.font_size_value;break;case"px":if(!t.font_size_value)return 1;s=Math.round(300*t.font_size_value/4)/100;break;default:return 1}return i/s},e.FontSize=(e,t=!0)=>{let s=e.font_size_value;switch(e.font_size_unit){case"pt":return(s||12)+"pt";case"px":return t?Math.round(300*(s||16)/4)/100+"pt":(s||16)+"px";case"em":return(s||1)+"em";case"%":return(s||100)+"%"}return""},e.Font=(e,t=1)=>{const s=[];return e.font_weight?s.push(e.font_weight.toString()):e.font_bold&&s.push("bold"),e.font_italic&&s.push("italic"),s.push(((e.font_size_value||0)*t).toFixed(2)+(e.font_size_unit||"pt")),s.push(e.font_face||""),s.join(" ")}}(_||(_={})),function(e){e[e.default=0]="default",e[e.hidden=1]="hidden",e[e.padded=2]="padded",e[e.date_component=3]="date_component",e[e.date_component_minutes=4]="date_component_minutes",e[e.literal=5]="literal",e[e.formatting=6]="formatting"}(g||(g={}));const y=(e,t)=>(void 0===t&&(t=n(e)),{value:e,type:t}),v=e=>e.imaginary?{type:a.complex,value:e}:{type:a.number,value:e.real},b=new class{Darken(e,t,s,i,r=!1){let{h:o,s:a,l:n}=this.RGBToHSL(e,t,s);return n-=r?n*i/100:i/100,n=Math.max(0,Math.min(1,n)),this.HSLToRGB(o,a,n)}Lighten(e,t,s,i,r=!1){let{h:o,s:a,l:n}=this.RGBToHSL(e,t,s);return n+=r?n*i/100:i/100,n=Math.max(0,Math.min(1,n)),this.HSLToRGB(o,a,n)}RGBToHSL(e,t,s){e/=255,t/=255,s/=255;const i=Math.max(e,t,s),r=Math.min(e,t,s);let o=0,a=0;const n=(i+r)/2;if(i===r)o=a=0;else{const l=i-r;switch(a=n>.5?l/(2-i-r):l/(i+r),i){case e:o=(t-s)/l+(t<s?6:0);break;case t:o=(s-e)/l+2;break;case s:o=(e-t)/l+4}o/=6}return{h:360*o,s:a,l:n}}HSLToRGB(e,t,s){let i,r,o;if(0===t)i=r=o=s;else{e/=360;const a=s<.5?s*(1+t):s+t-s*t,n=2*s-a;i=this.HueToRGB(n,a,e+1/3),r=this.HueToRGB(n,a,e),o=this.HueToRGB(n,a,e-1/3)}return{r:Math.round(255*i),g:Math.round(255*r),b:Math.round(255*o)}}HueToRGB(e,t,s){return s<0&&(s+=1),s>1&&(s-=1),s<1/6?e+6*(t-e)*s:s<.5?t:s<2/3?e+(t-e)*(2/3-s)*6:e}},w={grid_color:"red",note_marker_color:"#d2c500"},x=(e,t)=>C(e,t,0),C=(e,t,s)=>(null==t?void 0:t.text)?"none"===t.text?"":t.text:(null==t?void 0:t.theme)||0===(null==t?void 0:t.theme)?t.tint?((e,t,s)=>{e.tint_cache||(e.tint_cache=[]),e.tint_cache[t]||(e.tint_cache[t]={});let i=e.tint_cache[t][s];if(!i){const r=e.theme_colors_rgb?e.theme_colors_rgb[t]:[0,0,0];let o;o=s>0?b.Lighten(r[0],r[1],r[2],100*s,!0):b.Darken(r[0],r[1],r[2],100*-s,!0),i=`rgb(${o.r},${o.g},${o.b})`,e.tint_cache[t][s]=i}return i})(e,t.theme,t.tint):e.theme_colors?e.theme_colors[t.theme]:"":(s||0===s)&&e.theme_colors?e.theme_colors[s]:"",S=e=>{const{value:t,unit:s}=(e=>{let t=10,s="pt";const i=e.match(/^([\d.]+)(\D.*)$/);return i&&(t=Number(i[1]),s=i[2]),{value:t,unit:s}})(e.fontSize||""),i={fill:{text:e.backgroundColor},text:{text:e.color},font_size_unit:s,font_size_value:t,font_face:e.fontFamily};/italic/i.test(e.font)&&(i.font_italic=!0);const r=Number(e.fontWeight);return!isNaN(r)&&r&&(i.font_weight=r),i};var A,M;!function(e){e.Comma=",",e.Semicolon=";"}(A||(A={})),function(e){e.Period=".",e.Comma=","}(M||(M={}));const k=/[\s-+=<>!()]/,R=/['*\\]/,L=48,E={"==":6,"!=":6,"<>":6,"=":6,"<":7,">":7,"<=":7,">=":7,"+":9,"-":9,"&":9,"*":10,"/":10,"^":11,":":13},T=Object.keys(E).sort(((e,t)=>t.length-e.length)),D={"-":100,"+":100};class z{constructor(){this.argument_separator=A.Comma,this.decimal_mark=M.Period,this.argument_separator_char=44,this.decimal_mark_char=46,this.imaginary_char=105,this.imaginary_number="i",this.id_counter=0,this.expression="",this.data=[],this.index=0,this.length=0,this.valid=!0,this.dependencies={addresses:{},ranges:{}},this.address_refcount={},this.full_reference_list=[]}Walk(e,t){switch(e.type){case"address":case"missing":case"literal":case"complex":case"identifier":case"operator":return void t(e);case"range":return void(t(e)&&(this.Walk(e.start,t),this.Walk(e.end,t)));case"binary":return void(t(e)&&(this.Walk(e.left,t),this.Walk(e.right,t)));case"unary":return void(t(e)&&this.Walk(e.operand,t));case"group":return void(t(e)&&e.elements.forEach((e=>this.Walk(e,t))));case"call":t(e)&&e.args.forEach((e=>this.Walk(e,t)))}}Transpose(e){const t=e.length,s=[];let i=0;for(let s=0;s<t;s++)Array.isArray(e[s])&&(i=Math.max(i,e[s].length));for(let r=0;r<i;r++){s[r]=[];for(let i=0;i<t;i++)s[r][i]=e[i][r]}return s}Render(e,t={rows:0,columns:0},s="(missing)",i,r,o){let a=this.argument_separator+" ";r===A.Comma?a=", ":r===A.Semicolon&&(a="; ");let n=this.imaginary_number;o&&(n=o);const l=i===M.Comma?",":".",h=this.decimal_mark===M.Comma?/,/:/\./;switch(e.type){case"address":return this.AddressLabel(e,t);case"range":return this.AddressLabel(e.start,t)+":"+this.AddressLabel(e.end,t);case"missing":return s;case"array":return"{"+this.Transpose(e.values).map((e=>e.map((e=>"string"==typeof e?'"'+e+'"':e)).join(", "))).join("; ")+"}";case"binary":return this.Render(e.left,t,s,i,r)+" "+e.operator+" "+this.Render(e.right,t,s,i,r);case"unary":return e.operator+this.Render(e.operand,t,s,i,r);case"complex":if(e.real){const t=Math.abs(e.imaginary);return`${e.real||0}${e.imaginary<0?" - ":" + "}${1===t?"":t}i`}return-1===e.imaginary?"-i":1===e.imaginary?"i":`${e.imaginary}i`;case"literal":if("string"==typeof e.value)return'"'+e.value.replace(/"/g,'""')+'"';if(i&&"number"==typeof e.value){if(e.text){let t=e.text;return i===M.Comma&&this.decimal_mark===M.Period&&(t=t.replace(/,/g,"")),t.replace(h,l)}return e.value.toString().replace(/\./,l)}return e.text?e.text:e.value.toString();case"identifier":return e.name;case"operator":return"["+e.operator+"]";case"group":return e.explicit?"("+e.elements.map((e=>this.Render(e,t,s,i,r))).join(a)+")":e.elements.map((e=>this.Render(e,t,s,i,r))).join(a);case"call":return e.name+"("+e.args.map((e=>this.Render(e,t,s,i,r))).join(a)+")"}return"??"}Parse(e){switch("="===(e=e.trim())[0]&&(e=e.substr(1).trim()),this.expression=e,this.data=[],this.length=e.length,this.index=0,this.valid=!0,this.error_position=void 0,this.error=void 0,this.dependencies.addresses={},this.dependencies.ranges={},this.address_refcount={},this.full_reference_list=[],this.id_counter=0,this.argument_separator){case A.Semicolon:this.argument_separator_char=59;break;default:this.argument_separator_char=44}switch(this.decimal_mark){case M.Comma:this.decimal_mark_char=44;break;default:this.decimal_mark_char=46}for(let t=0;t<this.length;t++)this.data[t]=e.charCodeAt(t);const t=this.ParseGeneric(),s={};for(const e of Object.keys(this.dependencies.addresses))this.address_refcount[e]&&(s[e]=this.dependencies.addresses[e]);return this.dependencies.addresses=s,{expression:t||void 0,valid:this.valid,error:this.error,error_position:this.error_position,dependencies:this.dependencies,separator:this.argument_separator,decimal_mark:this.decimal_mark,full_reference_list:this.full_reference_list.slice(0)}}ColumnLabel(e){if(e===1/0)return"";let t=String.fromCharCode(65+e%26);for(;e>25;)e=Math.floor(e/26)-1,t=String.fromCharCode(65+e%26)+t;return t}AddressLabel(e,t){let s=e.column;e.absolute_column||e.column===1/0||(s+=t.columns);let i=e.row;if(e.absolute_row||e.row===1/0||(i+=t.rows),i<0||s<0||i===1/0&&s===1/0)return"#REF";let r="";return e.sheet&&(r=(k.test(e.sheet)?"'"+e.sheet+"'":e.sheet)+"!"),i===1/0?r+(e.absolute_column?"$":"")+this.ColumnLabel(s):s===1/0?r+(e.absolute_row?"$":"")+(i+1):r+(e.absolute_column?"$":"")+this.ColumnLabel(s)+(e.absolute_row?"$":"")+(i+1)}ParseGeneric(e=[0]){let t=[];for(;this.index<this.length;){const s=this.ParseNext(0===t.length);if("number"==typeof s){if(e.some((e=>s===e)))break;if(40===s){this.index++;const e=this.ParseGeneric([41]);this.index++,e&&t.push({type:"group",id:this.id_counter++,elements:[e],explicit:!0})}else{const e=this.ConsumeOperator();e?t.push(e):(this.error=`unexpected character [1]: ${String.fromCharCode(s)}, ${s}`,this.valid=!1,this.index++)}}else t.push(s)}return t.length&&(t=this.BinaryToRange2(t),t=t.map((e=>"identifier"===e.type&&e.name===this.imaginary_number?{type:"complex",real:0,imaginary:1,position:e.position,text:e.name,id:this.id_counter++}:e))),0===t.length?null:1===t.length?t[0]:this.BinaryToComplex(this.ArrangeUnits(t))}UnitToAddress(e){if("literal"===e.type){if("number"==typeof e.value&&e.value>0&&!/\./.test(e.text||""))return{type:"address",position:e.position,label:e.value.toString(),row:e.value-1,id:this.id_counter++,column:1/0}}else{let t,s=e.name;const i=s.split("!");if(i.length>1&&(t=i.slice(0,i.length-1).join("!"),s=s.substr(t.length+1),"'"===t[0])){if(!(t.length>1&&"'"===t[t.length-1]))return;t=t.substr(1,t.length-2)}const r="$"===s[0];s=(r?s.substr(1):s).toUpperCase();const o=Number(s);if(isNaN(o)){if(/[A-Z]{1,3}/.test(s)){let i=-1;for(let e=0;e<s.length;e++)i=26*(1+i)+(s[e].charCodeAt(0)-65);return{type:"address",position:e.position,absolute_column:r,label:e.name,column:i,id:this.id_counter++,row:1/0,sheet:t}}}else if(o>0&&o!==1/0&&!/\./.test(s))return{type:"address",position:e.position,absolute_row:r,label:e.name,row:o-1,id:this.id_counter++,column:1/0,sheet:t}}}BinaryToRange2(e){const t=[];for(let s=0;s<e.length;s++){const i=e[s],r=e[s+1],o=e[s+2];let a,n,l="";if(i&&r&&o&&"operator"===r.type&&":"===r.operator)if("address"===i.type&&"address"===o.type){const e=i.position+i.label.length,t=o.position;a={type:"range",id:this.id_counter++,position:i.position,start:i,end:o,label:i.label+this.expression.substring(e,t)+o.label},l=a.start.label+":"+a.end.label,this.address_refcount[a.start.label]--,this.address_refcount[a.end.label]--;const s=[i.position,o.position];this.full_reference_list=this.full_reference_list.filter((e=>e.position!==s[0]&&e.position!==s[1]))}else if(!("literal"!==i.type&&"identifier"!==i.type||"literal"!==o.type&&"identifier"!==o.type)){let e=this.UnitToAddress(i);if(!e&&"literal"===i.type&&"number"==typeof i.value&&i.value<0){const t=Object.assign(Object.assign({},i),{text:(i.text||"").replace(/^-/,""),position:i.position+1,value:-i.value});e=this.UnitToAddress(t),e&&(n={type:"operator",operator:"-",position:i.position,id:this.id_counter++})}const t=this.UnitToAddress(o);e&&t&&(e.column===1/0&&t.column===1/0||e.row===1/0&&t.row===1/0)&&(l=e.label+":"+t.label,a={type:"range",id:this.id_counter++,position:e.position,start:e,end:t,label:l})}a?(n&&t.push(n),t.push(a),this.dependencies.ranges[l]=a,this.full_reference_list.push(a),s+=2):t.push(i)}return t}BinaryToComplex(e){var t;if("binary"===e.type){if(!("+"!==e.operator&&"-"!==e.operator||"literal"!==e.left.type||"number"!=typeof e.left.value||"complex"!==e.right.type||e.right.composited)){let s="";s=this.expression.substring(e.left.position,e.right.position+((null===(t=e.right.text)||void 0===t?void 0:t.length)||0));let i=e.right.imaginary;return"-"===e.operator&&(i=-i),{type:"complex",position:e.left.position,text:s,id:this.id_counter++,imaginary:i,real:e.left.value,composited:!0}}e.left=this.BinaryToComplex(e.left),e.right=this.BinaryToComplex(e.right)}else if("unary"===e.type&&("-"===e.operator||"+"===e.operator)&&"complex"===e.operand.type&&e.operand.text===this.imaginary_number)return Object.assign(Object.assign({},e.operand),{position:e.position,text:this.expression.substring(e.position,e.operand.position+(e.operand.text||"").length),imaginary:e.operand.imaginary*("-"===e.operator?-1:1)});return e}BinaryToRangeX(e){if("binary"===e.type){if(":"===e.operator){let t,s="";if("address"===e.left.type&&"address"===e.right.type){const i=e.left.position+e.left.label.length,r=e.right.position;t={type:"range",id:this.id_counter++,position:e.left.position,start:e.left,end:e.right,label:e.left.label+this.expression.substring(i,r)+e.right.label},s=t.start.label+":"+t.end.label,this.address_refcount[t.start.label]--,this.address_refcount[t.end.label]--;const o=[e.left.position,e.right.position];this.full_reference_list=this.full_reference_list.filter((e=>e.position!==o[0]&&e.position!==o[1]))}else if(!("literal"!==e.left.type&&"identifier"!==e.left.type||"literal"!==e.right.type&&"identifier"!==e.right.type)){const i=this.UnitToAddress(e.left),r=this.UnitToAddress(e.right);i&&r&&(i.column===1/0&&r.column===1/0||i.row===1/0&&r.row===1/0)&&(s=i.label+":"+r.label,t={type:"range",id:this.id_counter++,position:e.left.position,start:i,end:r,label:s})}if(t)return this.dependencies.ranges[s]=t,this.full_reference_list.push(t),t;this.error="unexpected character: :",this.valid=!1}e.left=this.BinaryToRangeX(e.left),e.right=this.BinaryToRangeX(e.right)}return e}ArrangeUnits(e){if(0===e.length)return{type:"missing",id:this.id_counter++};if(1===e.length)return e[0];const t=[];for(let s=0;s<e.length;s++){let i=e[s];if("operator"===i.type){if(0!==t.length&&"operator"!==t[t.length-1].type){t.push(i);continue}if(!D[i.operator])return this.error=`unexpected character [2]: ${i.operator}`,this.error_position=i.position,this.valid=!1,{type:"group",id:this.id_counter++,elements:e,explicit:!1};{const t=this.BinaryToComplex(this.ArrangeUnits(e.slice(s+1)));if(!this.valid)return{type:"group",id:this.id_counter++,elements:e,explicit:!1};"binary"===t.type?(t.left={type:"unary",id:this.id_counter++,operator:i.operator,operand:t.left,position:i.position},i=t):i={type:"unary",id:this.id_counter++,operator:i.operator,operand:t,position:i.position},s=e.length}}if(t.length<2)t.push(i);else{if("operator"!==t[t.length-1].type)return this.error="multiple expressions",this.error_position=i.position,this.valid=!1,{type:"group",id:this.id_counter++,elements:e,explicit:!1};{const e=t[t.length-2],s=t[t.length-1],r=s.operator,o={type:"binary",id:this.id_counter++,left:e,operator:r,position:s.position,right:i};"binary"===e.type&&E[r]>E[e.operator]&&(o.left=e.left,o.operator=e.operator,o.position=e.position,o.right={type:"binary",id:this.id_counter++,left:e.right,right:i,operator:r,position:s.position}),t.splice(-2,2,o)}}}return t[0]}ParseNext(e=!0){this.ConsumeWhiteSpace();const t=this.data[this.index];if(34===t)return{type:"literal",id:this.id_counter++,position:this.index,value:this.ConsumeString()};if(t>=L&&t<=57||t===this.decimal_mark_char)return this.ConsumeNumber();if(123===t)return this.ConsumeArray();if(!e||45!==t&&43!==t){if(t>=65&&t<=90||t>=97&&t<=122||95===t||39===t||36===t||t>=192&&t<=312)return this.ConsumeToken(t)}else{const e=this.data[this.index+1];if(e>=L&&e<=57||e===this.decimal_mark_char)return this.ConsumeNumber()}return t}ConsumeArray(){const e={type:"array",id:this.id_counter++,values:[],position:this.index};this.index++;let t=0,s=0;for(;this.index<this.length;){const i=this.ParseNext(),r=this.index;if("number"==typeof i)switch(this.index++,i){case 59:s++,t=0;break;case 44:t++;break;case 125:return e;default:this.valid&&(this.error="invalid character in array literal",this.error_position=r,this.valid=!1)}else switch(i.type){case"literal":e.values[t]||(e.values[t]=[]),e.values[t][s]=i.value;break;default:this.valid&&(this.error="invalid value in array literal",this.error_position=r,this.valid=!1)}}return e}ConsumeOperator(){for(const e of T)if(this.expression.substr(this.index,e.length)===e){const t=this.index;return this.index+=e.length,{type:"operator",id:this.id_counter++,operator:e,position:t}}return null}ConsumeArguments(){this.index++;let e=0;const t=[];for(;this.index<this.length;){const s=this.ParseGeneric([this.argument_separator_char,41]);null!==s&&t.push(s);const i=this.data[this.index];if(i===this.argument_separator_char){this.index++,e++;for(let s=t.length;s<e;s++)t.push({type:"missing",id:this.id_counter++})}else if(41===i)return this.index++,t}return t}ConsumeToken(e){const t=[e],s=this.index;let i=39===e;for(++this.index;this.index<this.length;this.index++){const e=this.data[this.index];if(!(e>=65&&e<=90||e>=97&&e<=122||e>=192&&e<=312||95===e||36===e||46===e||33===e||i||e>=L&&e<=57))break;t.push(e),39===e&&(i=!1)}const r=t.map((e=>String.fromCharCode(e))).join("");if(i)return this.error="unbalanced single quote",this.error_position=s,this.valid=!1,{type:"identifier",id:this.id_counter++,name:r,position:s};if("true"===r.toLowerCase())return{type:"literal",id:this.id_counter++,value:!0,position:s};if("false"===r.toLowerCase())return{type:"literal",id:this.id_counter++,value:!1,position:s};if(this.ConsumeWhiteSpace(),40===this.data[this.index]){const e=this.ConsumeArguments();return{type:"call",id:this.id_counter++,name:r,args:e,position:s}}const o=this.ConsumeAddress(r,s);if(o)return o;const a={type:"identifier",id:this.id_counter++,name:r,position:s};return this.full_reference_list.push(a),a}ConsumeAddress(e,t){const s=t,i=e.length;let r;const o=e.split("!");o.length>1&&(r=o.slice(0,o.length-1).join("!"),t+=r.length+1);const a=this.ConsumeAddressColumn(t);if(!a)return null;t=a.position;const n=this.ConsumeAddressRow(t);if(!n)return null;t=n.position;const l=r?r+e.substr(r.length,t-s).toUpperCase():e.substr(0,t-s).toUpperCase();r&&"'"===r[0]&&(r=r.substr(1,r.length-2));const h={type:"address",id:this.id_counter++,label:l,row:n.row,column:a.column,absolute_row:n.absolute,absolute_column:a.absolute,position:s,sheet:r};return i!==t-s?null:(this.dependencies.addresses[h.label]=h,this.address_refcount[h.label]=(this.address_refcount[h.label]||0)+1,this.full_reference_list.push(h),h)}ConsumeAddressRow(e){const t=36===this.data[e];t&&e++;const s=e;let i=0;for(;;e++){const t=this.data[e];if(!(t>=L&&t<=57))break;i*=10,i+=t-L}return s!==e&&{absolute:t,row:i-1,position:e}}ConsumeAddressColumn(e){let t=-1,s=0;const i=36===this.data[e];for(i&&e++;;e++,s++){if(s>=4)return!1;const i=this.data[e];if(i>=65&&i<=90)t=26*(1+t)+(i-65);else{if(!(i>=97&&i<=122))break;t=26*(1+t)+(i-97)}}return!(t<0)&&{absolute:i,column:t,position:e}}ConsumeNumber(){const e=this.index;let t=0,s=!1,i=!1,r=0,o=0,a=0,n="integer",l=0,h=!1;const c=this.index;for(;this.index<this.length;this.index++,l++){const e=this.data[this.index];if(e===this.decimal_mark_char){if("integer"!==n)break;n="fraction"}else{if(37===e){r/=100,a/=100,this.index++;break}if(43===e||45===e){if(0!==l)break;45===e&&(i=!0)}else if(69===e||101===e){if("integer"!==n&&"fraction"!==n)break;n="exponent",this.index<this.length-1&&(43===this.data[this.index+1]?this.index++:45===this.data[this.index+1]&&(this.index++,s=!0))}else if(e===this.imaginary_char){if("integer"===n||"fraction"===n){this.index++,h=!0;break}}else{if(!(e>=L&&e<=57))break;switch(n){case"integer":r=10*r+(e-L);break;case"fraction":a=10*a+(e-L),o++;break;case"exponent":t=10*t+(e-L)}}}}let d=r+a/Math.pow(10,o);return"exponent"===n&&(d*=Math.pow(10,(s?-1:1)*t)),h?{type:"complex",id:this.id_counter++,position:e,imaginary:i?-d:d,real:0,text:this.expression.substring(c,this.index)||""}:{type:"literal",id:this.id_counter++,position:e,value:i?-d:d,text:this.expression.substring(c,this.index)||""}}ConsumeString(){this.index++;const e=[];for(;this.index<this.length;this.index++){const t=this.data[this.index];if(34===t&&(this.index++,this.index>=this.length||34!==this.data[this.index]))break;e.push(t)}return e.map((e=>String.fromCharCode(e))).join("")}ConsumeWhiteSpace(){for(;this.index<this.length;){const e=this.data[this.index];if(32!==e&&9!==e&&10!==e&&13!==e&&160!==e)return;this.index++}}}var N;!function(e){e[e.default=0]="default",e[e.quoted=1]="quoted"}(N||(N={}));class P{constructor(){}static get instance(){return this._instance}IsWhitespace(e){return" "===e||"\t"===e}IsNewline(e){return"\r"===e||"\n"===e}IsDelimeter(e){return"*"===e||"_"===e}Dummy(e=""){return e.split(/\n/).map((e=>[{text:e}]))}Parse(e=""){const t=this.Tokenize(e);for(let e=0;e<t.length;e++){const s=t[e];if("delimeter"===s.type){const i=t[e-1],r=t[e+1],o=!i||"whitespace"===i.type||"newline"===i.type,a=i&&"text"===i.type&&/[^\w\d]$/.test(i.text),n=!r||"whitespace"===r.type||"newline"===r.type,l=r&&"text"===r.type&&/^[^\w\d]/.test(r.text);s.left_flanking=!n&&(!l||o),s.right_flanking=!o&&(!a||n)}}return this.ApplyFormatting(t),this.Consolidate(t)}Consolidate(e){const t=[],s={};let i=[],r={type:"text",text:""};for(const o of e)if("newline"===o.type)r.text.length&&i.push(r),r=Object.assign(Object.assign({},s),{text:"",type:"text"}),t.push(i),i=[];else switch(!!s.strong==!!o.strong&&!!s.emphasis==!!o.emphasis||(s.strong=!!o.strong,s.emphasis=!!o.emphasis,r.text.length&&i.push(r),r=Object.assign(Object.assign({},s),{text:"",type:"text"})),o.type){case"text":case"whitespace":r.text+=o.text;break;case"delimeter":for(let e=0;e<o.length;e++)r.text+=o.char}return r.text.length&&i.push(r),i.length&&t.push(i),t}ApplyFormatting(e,t){let s=0;const i=e.length;for(s=0;s<i;s++){const i=e[s];if("delimeter"===i.type){if(t&&i.right_flanking&&t.char===i.char&&i.length>0)return{index:s,token:i};if(i.left_flanking){const t=this.ApplyFormatting(e.slice(s+1),i);if(t.token){const r=Math.min(t.token.length,i.length),o=!!(r%2),a=r>=2;for(let i=s+1;i<=s+t.index;i++)e[i].strong=!!e[i].strong||a,e[i].emphasis=!!e[i].emphasis||o;t.token.length-=r,i.length-=r,i.length>0?s--:s+=t.index}}}}return{index:s}}Tokenize(e=""){const t=[],s=e.length;let i=0,r=!1,o="";for(i=0;i<s;i++){const s=e[i];if(this.IsWhitespace(s)){o&&t.push({type:"text",text:o});let a=s;for(;;){const t=e[i+1];if(!this.IsWhitespace(t))break;a+=t,i++}t.push({type:"whitespace",text:a}),r=!1,o=""}else if(this.IsNewline(s)){o&&t.push({type:"text",text:o});let a=s;for(;;){const t=e[i+1];if(!this.IsNewline(t))break;a+=t,i++}t.push({type:"newline",text:a}),r=!1,o=""}else if(r)o+=s,r=!1;else if(this.IsDelimeter(s)){o&&t.push({type:"text",text:o});let a=s;for(;;){const t=e[i+1];if(t!==s)break;a+=t,i++}t.push({type:"delimeter",text:a,char:s,length:a.length}),r=!1,o=""}else"\\"===s?r=!0:o+=s}return o&&t.push({type:"text",text:o}),t}}function F(e){return e?Promise.resolve().then(e):Promise.resolve()}P._instance=new P;let I,O=1e3;class U{constructor(e=!1,t="undefined"){this.verbose=e,this.log_id=t,this.queue=[],this.dispatched=!1,this.subscribers=[],this.pass_through=[]}Publish(e){this.verbose&&console.info(`es publish (${this.log_id})`,e),this.pass_through.forEach((t=>t.Publish(e))),Array.isArray(e)?this.queue.push(...e):this.queue.push(e),this.dispatched||(this.dispatched=!0,F().then((()=>{const e=this.queue.slice(0);this.dispatched=!1,this.queue=[];for(const t of e)for(const e of this.subscribers)e.subscriber(t)})))}Subscribe(e){const t=O++;return this.subscribers.push({subscriber:e,token:t}),t}Cancel(e){this.subscribers=this.subscribers.filter((t=>t.token!==e))}CancelAll(){this.subscribers=[],this.pass_through=[]}PassThrough(e){this.pass_through.push(e)}}class ${constructor(e,t,s,i=e){$.Create({container:e,node:t,resize_callback:s,layout_reference:i})}static Create(e){const t=document.createElement("div");if(t.classList.add("treb-embed-resize-handle"),(e.layout_reference||e.container).appendChild(t),!$.resize_mask){let e=document.querySelector(".treb-embed-mouse-mask");e||(e=document.createElement("div"),e.classList.add("treb-embed-mouse-mask"),document.body.appendChild(e)),$.resize_mask=e}if(!$.resize_rect){let e=document.querySelector(".treb-embed-resize-rect");e||(e=document.createElement("div"),e.classList.add("treb-embed-resize-rect"),$.resize_mask.appendChild(e)),$.resize_rect=e}let s,i,r={width:0,height:0},o={x:0,y:0},a={x:0,y:0};const n=()=>{if($.resize_mask.removeEventListener("mousemove",i),$.resize_mask.removeEventListener("mouseup",s),$.resize_mask.style.display="none",a.x||a.y){const t=e.container.getBoundingClientRect(),s=t.width+a.x,i=t.height+a.y;e.container.style.width=`${s}px`,e.container.style.height=`${i}px`,e.resize_callback&&e.resize_callback()}};i=e=>{e.buttons?(a.x!==e.clientX-o.x&&(a.x=e.clientX-o.x,$.resize_rect.style.width=`${r.width+a.x+4}px`),a.y!==e.clientY-o.y&&(a.y=e.clientY-o.y,$.resize_rect.style.height=`${r.height+a.y+4}px`)):n()},s=()=>{n()},t.addEventListener("mousedown",(t=>{t.stopPropagation(),t.preventDefault();const n=e.node.getBoundingClientRect();r={width:n.width,height:n.height},$.resize_rect&&($.resize_rect.style.top=n.top-2+"px",$.resize_rect.style.left=n.left-2+"px",$.resize_rect.style.width=`${n.width+4}px`,$.resize_rect.style.height=`${n.height+4}px`),o={x:t.clientX,y:t.clientY},a={x:0,y:0},$.resize_mask.style.display="block",$.resize_mask.addEventListener("mousemove",i),$.resize_mask.addEventListener("mouseup",s)}))}}class H{static MeasureColorARGB(e){const t=this.MeasureColor(e);let s="FF";for(let e=0;e<3;e++){const i=t[e].toString(16);0===i.length?s+="00":1===i.length?s+=`0${i}`:s+=i}return s.toUpperCase()}static MeasureColor(e){let t=this.color_cache[e];if(t)return t;this.color_measurement_canvas||(this.color_measurement_canvas=document.createElement("canvas"),this.color_measurement_canvas.width=1,this.color_measurement_canvas.height=1);const s=this.color_measurement_canvas.getContext("2d");return s?(s.fillStyle="#fff",s.fillRect(0,0,1,1),s.fillStyle=e,s.fillRect(0,0,1,1),t=s.getImageData(0,0,1,1).data,this.color_cache[e]=t,t):new Uint8ClampedArray(3)}static EnsureMeasurementNode(){if(!this.text_measurement_node){const e=document.querySelector(".treb-chart-measurement-node");e?this.text_measurement_node=e:(this.text_measurement_node=document.createElement("div"),this.text_measurement_node.classList.add("treb-chart-measurement-node"),this.text_measurement_node.style.margin="0px",this.text_measurement_node.style.padding="0px",this.text_measurement_node.style.whiteSpace="nowrap",this.text_measurement_node.style.position="fixed",this.text_measurement_node.style.border="0px",this.text_measurement_node.style.border="1px solid red",this.text_measurement_node.style.boxSizing="content-box",this.text_measurement_node.style.top=this.text_measurement_node.style.left="-1000px",document.body.appendChild(this.text_measurement_node))}}static FontLoaded(e,t=!1,s=400){const i=`${t?"italic":""} ${s} 20pt ${e}`,r=this.MeasureText(`${i}, sans-serif`,"check font"),o=this.MeasureText(`${i}, serif`,"check font"),a=this.MeasureText(`${i}, monospace`,"check font");return r.width===o.width&&o.width===a.width}static MeasureText(e,t,s=0){this.EnsureMeasurementNode(),this.text_measurement_node.style.font=e,/\n/.test(t)?(t=t.replace(/\n/g,"<BR/>"),this.text_measurement_node.innerHTML=t):this.text_measurement_node.textContent=t,this.text_measurement_node.style.lineHeight="1em",this.text_measurement_node.style.transform=s?`rotate(${s}deg)`:"";const i=this.text_measurement_node.getBoundingClientRect();return{width:i.width,height:i.height}}}H.color_cache={};const V=(e,t)=>{const s=e.cloneNode(!1),i=getComputedStyle(e),r=((e,t,s)=>{const i={};return Array.prototype.forEach.call(t,(e=>{t[e]!==s[e]&&(i[e]=t[e])})),(Object.keys(i).map((e=>`${e}: ${i[e]}`)).join("; ")+"; "+(e.getAttribute("style")||"")).trim().replace(/"/g,"'")})(e,i,t);return s.removeAttribute("class"),s.setAttribute("style",r),Array.prototype.forEach.call(e.childNodes,(t=>{switch(t.nodeType){case Node.ELEMENT_NODE:s.appendChild(V(t,i));break;case Node.TEXT_NODE:e.textContent&&s.appendChild(document.createTextNode(e.textContent));break;case Node.COMMENT_NODE:break;default:console.warn("unhandled node type in serialize",t)}})),s},j=(e,t,s=6.5,i=!1)=>{if(t===e)t++,e&&e--;else{const s=Math.round(1e5*t)/1e5;Math.abs(s-t)/(t-e)<1e-5&&(t=s)}const r=t-e,o=Math.log(r)/Math.log(10),a=Math.floor(Math.abs(o))*(o<0?-1:1)-1,n=[.1,.25,.5,1,2.5,5,10,25,50,100];let l=-1,h=0;for(const r of n){const o=r*Math.pow(10,a),n=Math.floor(e/o)*o,c=(Math.ceil(t/o)*o-n)/o,d=Math.abs(c-s);(l<0||d<h)&&(!i||c<=s)&&(h=d,l=o)}return e=Math.floor(e/l)*l,t=Math.ceil(t/l)*l,{scale:a,step:l,count:s=Math.round((t-e)/l),min:e,max:t}},G=(e,t,s)=>{[].forEach.call(e.children,(e=>{e.id&&(s[e.id]=e,e.id=`${t}-${e.id}`),e.children&&e.children.length&&G(e,t,s)}))},B=(e,...t)=>{const s=[];for(let i=0;i<e.length;i++)s.push(e[i]),t[i]&&s.push(t[i].toString());return s.join("")},Z=(e,...t)=>((e,t)=>{const s=Math.random().toString(36).substring(2,15),i=document.createElement("div");i.innerHTML=e;const r={};if(G(i,s,r),"string"==typeof t&&(t=document.querySelector(t)),t){const e=[].map.call(i.childNodes,(e=>e));for(const s of e)t.appendChild(s)}return r})(B(e,...t));class J{constructor(){this.date_format=!1,this.string_format=!1,this.fraction_format=!1,this.twelve_hour=!1,this.fraction_denominator=0,this.fraction_integer=!0,this.fraction_align=0,this.fraction_denominator_digits=0,this.integer_min_digits=0,this.decimal_min_digits=0,this.decimal_max_digits=0,this.grouping=!1,this.has_number_format=!1,this.prefix=[{text:""}],this.suffix=[{text:""}],this.scaling=0,this.percent=!1,this.exponential=!1,this.has_asterisk=!1}}var q;!function(e){e[e.Integer=0]="Integer",e[e.Decimal=1]="Decimal"}(q||(q={}));class W{static Parse(e){if(this.pattern=e,this.characters=e.split("").map((e=>e.charCodeAt(0))),this.char_index=0,this.current_section=new J,this.sections=[this.current_section],this.ParseDatePattern())return this.sections;for(this.char_index=0,this.current_section=new J,this.sections=[this.current_section];this.char_index<this.characters.length;)this.ConsumeChar();return this.sections}static ConsumeString(){let e="";for(this.preserve_formatting_characters&&(e+=this.pattern[this.char_index]),++this.char_index;this.char_index<this.characters.length;this.char_index++)switch(this.characters[this.char_index]){case 92:this.preserve_formatting_characters&&(e+=this.pattern[this.char_index]),this.char_index+1<this.characters.length&&(e+=this.pattern[++this.char_index]);break;case 34:return this.preserve_formatting_characters&&(e+=this.pattern[this.char_index]),this.char_index++,e;default:e+=this.pattern[this.char_index]}throw new Error("unterminated string")}static ConsumeFormatting(){let e="";for(++this.char_index;this.char_index<this.characters.length;this.char_index++)switch(this.characters[this.char_index]){case 92:throw new Error("invalid escape character in formatting block");case 93:return this.char_index++,e;default:e+=this.pattern[this.char_index]}throw new Error("unterminated format")}static ScanFractionFormat(){const e=this.pattern.substr(this.char_index).match(/^([#?]+ +){0,1}([#?]+)\/([#?0-9]+)(?:$|[^#?0-9])/);if(!e)return!1;const t=(e[1]||"").length+e[2].length+e[3].length+1;this.current_section.fraction_format=!0,this.current_section.fraction_integer=!!e[1];const s=Number(e[3]);return isNaN(s)||(this.current_section.fraction_denominator=s),this.current_section.decimal_max_digits=this.current_section.fraction_denominator_digits=e[3].length,this.char_index+=t,this.current_section.has_number_format=!0,!0}static ConsumeNumberFormat(){let e=q.Integer;for(this.char_index;this.char_index<this.characters.length;this.char_index++)switch(this.characters[this.char_index]){case this.group_separator:{let t=!1;for(let e=this.char_index+1;!t&&e<this.characters.length;e++){const s=this.characters[e];if(s===this.decimal_mark||35===s||48===s)t=!0;else if(44!==s)break}if(t){if(e===q.Decimal)throw new Error("invalid grouping in decimal part");this.current_section.grouping=!0}else this.current_section.scaling=1e3*(this.current_section.scaling||1)}break;case this.decimal_mark:if(e===q.Decimal)throw new Error("too many decimal marks");e=q.Decimal;break;case 35:e===q.Decimal?this.current_section.decimal_max_digits++:this.current_section.integer_min_digits&&this.current_section.integer_min_digits++;break;case 48:e===q.Decimal?(this.current_section.decimal_max_digits++,this.current_section.decimal_min_digits=this.current_section.decimal_max_digits):this.current_section.integer_min_digits++;break;default:return}}static AppendCharAsText(e=!0){this.current_section.has_number_format?this.current_section.suffix[this.current_section.suffix.length-1].text+=this.pattern[this.char_index]:this.current_section.prefix[this.current_section.prefix.length-1].text+=this.pattern[this.char_index],e&&this.char_index++}static AppendString(e){this.current_section.has_number_format?this.current_section.suffix[this.current_section.suffix.length-1].text+=e:this.current_section.prefix[this.current_section.prefix.length-1].text+=e}static AppendTextPart(e){this.current_section.has_number_format?(this.current_section.suffix.push(e),this.current_section.suffix.push({text:""})):(this.current_section.prefix.push(e),this.current_section.prefix.push({text:""}))}static ConsumeChar(){const e=this.characters[this.char_index];if(63!==e&&35!==e||this.current_section.has_number_format||this.current_section.string_format||!this.ScanFractionFormat())switch(e){case 59:this.char_index++,this.current_section=new J,3===this.sections.length&&(this.current_section.string_format=!0),this.sections.push(this.current_section);break;case 64:this.char_index++,this.AppendTextPart({text:"@",flag:g.literal}),this.current_section.string_format=!0;break;case 48:case 35:case 46:case 44:this.current_section.has_number_format||this.current_section.string_format?this.AppendCharAsText():(this.ConsumeNumberFormat(),this.current_section.has_number_format=!0);break;case 91:this.AppendTextPart({text:this.ConsumeFormatting(),flag:g.formatting});break;case 34:this.AppendString(this.ConsumeString());break;case 63:this.preserve_formatting_characters?this.AppendCharAsText():(this.AppendTextPart({text:"0",flag:g.hidden}),this.char_index++);break;case 95:if(this.preserve_formatting_characters)this.AppendCharAsText();else{if(++this.char_index>=this.characters.length)throw new Error("invalid pad character at end");this.AppendTextPart({text:this.pattern[this.char_index++],flag:g.hidden})}break;case 42:if(this.current_section.has_asterisk)throw new Error("we don't support multiple asterisks");if(this.preserve_formatting_characters)this.AppendCharAsText();else{if(++this.char_index>=this.characters.length)throw new Error("invalid pad character at end");this.AppendTextPart({text:this.pattern[this.char_index++],flag:g.padded}),this.current_section.has_asterisk=!0}break;case 101:case 69:this.current_section.percent||this.current_section.exponential||this.current_section.string_format?this.AppendCharAsText():(this.current_section.exponential=!0,this.char_index++);break;case 37:this.current_section.exponential||this.current_section.string_format||(this.current_section.percent=!0),this.AppendCharAsText();break;case 92:if(this.preserve_formatting_characters&&this.AppendCharAsText(!1),++this.char_index>=this.characters.length)throw new Error("invalid escape character at end");this.AppendCharAsText();break;default:this.AppendCharAsText()}}static ParseDatePattern(){for(this.date_pattern=!0;this.date_pattern&&this.char_index<this.pattern.length;)this.DatePatternConsumeChar();if(this.date_pattern){this.date_pattern=!1;for(const e of this.sections)for(const t of e.prefix)t.flag&&t.flag&(g.date_component|g.date_component_minutes)&&(this.date_pattern=!0)}return this.date_pattern&&(this.sections[0].date_format=!0,this.sections[0].prefix.forEach(((e,t)=>{if(e.flag===g.date_component&&("mm"===e.text||"m"===e.text)){if(t)for(let s=t-1;s;s--){const t=this.sections[0].prefix[s];if(t.flag===g.date_component){/h/i.test(t.text)&&(e.flag=g.date_component_minutes,e.text=e.text.toLowerCase());break}}if(t<this.sections[0].prefix.length-1)for(let s=t+1;s<this.sections[0].prefix.length;s++){const t=this.sections[0].prefix[s];if(t.flag===g.date_component){/s/i.test(t.text)&&(e.flag=g.date_component_minutes,e.text=e.text.toLowerCase());break}}}}))),this.date_pattern}static ConsumeDatePart(){const e=this.pattern[this.char_index++],t=e.toLowerCase(),s={text:e,flag:g.date_component};for(;this.pattern[this.char_index]&&this.pattern[this.char_index].toLowerCase()===t;)s.text+=this.pattern[this.char_index++];if("s"===t&&"."===this.pattern[this.char_index])for(s.text+=this.pattern[this.char_index++];"0"===this.pattern[this.char_index];)s.text+=this.pattern[this.char_index++];return s}static ConsumeAMPM(){let e=this.pattern.substr(this.char_index,5);return"am/pm"===e||"AM/PM"===e?(this.char_index+=5,this.sections[0].twelve_hour=!0,{text:e,flag:g.date_component}):(e=this.pattern.substr(this.char_index,3),"a/p"===e||"A/P"===e?(this.char_index+=3,this.sections[0].twelve_hour=!0,{text:e,flag:g.date_component}):void 0)}static DatePatternConsumeChar(){switch(this.characters[this.char_index]){case 59:this.char_index=this.characters.length;break;case 48:case 35:case 101:case 69:case 37:case 64:this.date_pattern=!1;break;case 72:case 104:case 77:case 109:case 83:case 115:case 68:case 100:case 89:case 121:this.AppendTextPart(this.ConsumeDatePart());break;case 65:case 97:{const e=this.ConsumeAMPM();e?this.AppendTextPart(e):this.AppendCharAsText()}break;case 34:this.AppendString(this.ConsumeString());break;case 63:this.preserve_formatting_characters?this.AppendCharAsText():(this.AppendTextPart({text:"0",flag:g.hidden}),this.char_index++);break;case 95:if(this.preserve_formatting_characters)this.AppendCharAsText();else{if(++this.char_index>=this.characters.length)throw new Error("invalid pad character at end");this.AppendTextPart({text:this.pattern[this.char_index++],flag:g.hidden})}break;case 42:if(this.current_section.has_asterisk)throw new Error("we don't support multiple asterisks");if(this.preserve_formatting_characters)this.AppendCharAsText();else{if(++this.char_index>=this.characters.length)throw new Error("invalid pad character at end");this.AppendTextPart({text:this.pattern[this.char_index++],flag:g.padded}),this.current_section.has_asterisk=!0}break;case 92:if(this.preserve_formatting_characters&&this.AppendCharAsText(!1),++this.char_index>=this.characters.length)throw new Error("invalid escape character at end");this.AppendCharAsText();break;default:this.AppendCharAsText()}}}W.date_pattern=!1,W.pattern="",W.char_index=0,W.characters=[],W.sections=[],W.current_section=new J,W.preserve_formatting_characters=!1,W.decimal_mark=46,W.group_separator=44;const X=e=>(e>=60&&e--,new Date(864e5*e-22090752e5)),K=(e,t=!0)=>{if(t){const t=new Date(e),s=new Date;s.setUTCMilliseconds(t.getUTCMilliseconds()),s.setUTCSeconds(t.getUTCSeconds()),s.setUTCMinutes(t.getUTCMinutes()),s.setUTCHours(t.getHours()),s.setUTCDate(t.getDate()),s.setUTCMonth(t.getMonth()),s.setUTCFullYear(t.getFullYear()),e=s.getTime()}return(e=(e+22090752e5)/864e5)>=60&&e++,e};class Y{constructor(e){if(this._pattern="",this.decimal_zero_regexp=[],this.cloned=[],this.magic_decimal=!1,this._pattern=e,this.sections=W.Parse(e),this.sections.length||(this.sections=[]),this.sections[0]||(this.sections[0]=new J),this.sections[1]||(this.sections[1]=Object.assign({},this.sections[0]),this.sections[1].prefix=JSON.parse(JSON.stringify(this.sections[1].prefix)),this.sections[1].suffix=JSON.parse(JSON.stringify(this.sections[1].suffix)),this.sections[1].prefix.push({text:"-"}),this.cloned[1]=!0),this.sections[2]||(this.sections[2]=Object.assign({},this.sections[0]),this.cloned[2]=!0),!this.sections[3])for(const e of this.sections[0].prefix)if(e.flag===g.literal){this.sections[3]=Object.assign({},this.sections[0]),this.sections[3].string_format=!0,this.cloned[3]=!0;break}this.decimal_zero_regexp=this.sections.map((e=>{if(e.decimal_max_digits>e.decimal_min_digits)return new RegExp(`0{1,${e.decimal_max_digits-e.decimal_min_digits}}(?:$|e)`)}))}static FormatPartsAsText(e,t=0){let s=-1;const i=e.map(((e,t)=>{switch(e.flag){case g.padded:return s=t,e.text;case g.hidden:return e.text.replace(/./g," ");case g.formatting:return"";default:return e.text}}));if(s>=0&&t){const e=i.reduce(((e,t,i)=>i===s?e:e+t.length),0);let r="";for(let o=0;o<t-e;o++)r+=i[s];i[s]=r}return i.join("")}get pattern(){return this._pattern}get date_format(){return this.sections[0]&&this.sections[0].date_format}IncreaseDecimal(){this.sections.forEach((e=>{e.fraction_format?e.fraction_denominator||(e.fraction_denominator_digits=Math.min(e.fraction_denominator_digits+1,4)):(e.decimal_min_digits++,e.decimal_max_digits=e.decimal_min_digits)}))}DecreaseDecimal(){this.sections.forEach((e=>{e.fraction_format?e.fraction_denominator||(e.fraction_denominator_digits=Math.max(e.fraction_denominator_digits-1,1)):(e.decimal_min_digits=Math.max(0,e.decimal_min_digits-1),e.decimal_max_digits=e.decimal_min_digits)}))}AddGrouping(){this.sections.forEach((e=>{e.grouping=!0}))}RemoveGrouping(){this.sections.forEach((e=>{e.grouping=!1}))}ToggleGrouping(){const e=!this.sections[0].grouping;this.sections.forEach((t=>{t.grouping=e}))}toString(){return this.sections[0].date_format?this._pattern:this.sections.filter(((e,t)=>!this.cloned[t])).map((e=>{let t="",s=0;if(e.fraction_format){e.fraction_integer&&(t+="? ");let s="";for(let t=0;t<e.fraction_denominator_digits;t++)s+="#";t+=s,t+="/",e.fraction_denominator?t+=e.fraction_denominator:t+=s}else if(e.has_number_format){for(s=0;s<e.integer_min_digits;s++)t+="0";if(e.grouping&&(t.length<4&&(t=("####"+t).slice(-4)),t=t.replace(/[\d#]{1,3}(?=([\d#]{3})+(?![\d#]))/g,"$&,")),e.decimal_max_digits||e.decimal_min_digits){for(t+=".",s=0;s<e.decimal_min_digits;s++)t+="0";for(;s<e.decimal_max_digits;s++)t+="#"}if(e.scaling){const i=Math.log10(e.scaling)/3;for(s=0;s<i;s++)t+=","}e.exponential&&(t+="e")}return e.prefix.map((e=>e.flag===g.hidden?"0"===e.text?"?":"_"+e.text:e.flag===g.padded?"*"+e.text:e.flag===g.formatting?"["+e.text+"]":e.text)).join("")+t+e.suffix.map((e=>e.flag===g.hidden?"0"===e.text?"?":"_"+e.text:e.flag===g.padded?"*"+e.text:e.text)).join("")})).join(";")}FormatComplex(e){let t=[],s=[],i=!!e.imaginary;i&&(t=this.FormatParts(e.imaginary),i=t.some((e=>/[1-9]/.test(e.text))));let r=!!e.real;r&&(s=this.FormatParts(e.real),r=s.some((e=>/[1-9]/.test(e.text))));const o=[];return r||!r&&!i?(o.push(...this.FormatParts(e.real)),i&&(Math.abs(e.imaginary),o.push({text:e.imaginary<0?` ${Y.minus_character} `:" + "}),o.push(...this.FormatParts(Math.abs(e.imaginary)),{text:Y.imaginary_character}))):i&&o.push(...this.FormatParts(e.imaginary),{text:Y.imaginary_character}),o}FormatParts(e){if("number"!=typeof e&&!this.sections[3])return[{text:e.toString()}];const{parts:t,section:s}=this.BaseFormat(e);let i=[];if(s.date_format||s.string_format)for(const e of t)"string"==typeof e?i.push({text:e}):i.push(e);else this.magic_decimal&&""===t[1]&&t.splice(1,1),i=[...s.prefix.map((e=>Object.assign({},e))),{text:s.has_number_format?t.join(f.decimal_separator):""},...s.suffix.map((e=>Object.assign({},e)))];for(let e=1;e<i.length;e++)i[e].flag===i[e-1].flag&&(i[e].text=i[e-1].text+i[e].text,i[e-1].text="");return i.filter((e=>e.text))}Format(e,t=0){return Y.FormatPartsAsText(this.FormatParts(e),t)}ZeroPad(e,t){for(;e.length<t;)e="0"+e;return e}DateFormat(e){const t=X(e),s=this.sections[0];let i=t.getUTCHours();return s.twelve_hour&&(i>12&&(i-=12),0===i&&(i=12)),{parts:s.prefix.map((e=>{if(e.flag===g.date_component_minutes)return"mm"===e.text?{text:this.ZeroPad(t.getUTCMinutes().toString(),2)}:{text:this.ZeroPad(t.getUTCMinutes().toString(),1)};if(e.flag===g.date_component){switch(e.text.toLowerCase()){case"am/pm":case"a/p":{const s=e.text.split("/");return{text:t.getUTCHours()>12?s[1]:s[0]}}case"mmmmm":return{text:f.date_components.long_months[t.getUTCMonth()][0]};case"mmmm":return"MMMM"===e.text?{text:f.date_components.long_months[t.getUTCMonth()].toUpperCase()}:{text:f.date_components.long_months[t.getUTCMonth()]};case"mmm":return"MMM"===e.text?{text:f.date_components.short_months[t.getUTCMonth()].toUpperCase()}:{text:f.date_components.short_months[t.getUTCMonth()]};case"mm":return{text:this.ZeroPad((t.getUTCMonth()+1).toString(),2)};case"m":return{text:this.ZeroPad((t.getUTCMonth()+1).toString(),1)};case"ddddd":case"dddd":return"DDDDD"===e.text||"DDDD"===e.text?{text:f.date_components.long_days[t.getUTCDay()].toUpperCase()}:{text:f.date_components.long_days[t.getUTCDay()]};case"ddd":return"DDD"===e.text?{text:f.date_components.short_days[t.getUTCDay()].toUpperCase()}:{text:f.date_components.short_days[t.getUTCDay()]};case"dd":return{text:this.ZeroPad(t.getUTCDate().toString(),2)};case"d":return{text:this.ZeroPad(t.getUTCDate().toString(),1)};case"yyyy":case"yyy":return{text:t.getUTCFullYear().toString()};case"yy":case"y":return{text:this.ZeroPad((t.getUTCFullYear()%100).toString(),2)};case"hh":return{text:this.ZeroPad(i.toString(),2)};case"h":return{text:this.ZeroPad(i.toString(),1)};case"ss":return{text:this.ZeroPad(t.getUTCSeconds().toString(),2)};case"s":return{text:this.ZeroPad(t.getUTCSeconds().toString(),1)}}const s=e.text.match(/^(s+)\.(0+)$/);if(s)return{text:this.ZeroPad(t.getUTCSeconds().toString(),s[1].length)+f.decimal_separator+(t.getUTCMilliseconds()/1e3).toFixed(s[2].length).substr(2)}}return Object.assign({},e)})),section:s}}StringFormat(e,t){const s=[];for(const i of t.prefix)i.flag===g.literal?s.push({text:e}):s.push(Object.assign({},i));return{parts:s,section:t}}Round2(e,t){const s=Math.pow(10,t);return Math.round(s*e)/s}FormatFraction(e,t){t.percent&&(e*=100);let s={denominator:1,numerator:Math.round(e),error:Math.abs(Math.round(e)-e)};if(t.fraction_denominator)s.denominator=t.fraction_denominator,s.numerator=Math.round(e*s.denominator);else if(s.error){const i=Y.fraction_limits[t.fraction_denominator_digits-1]||Y.fraction_limits[0];for(let t=2;t<=i;t++){const i=Math.round(e*t),r=Math.abs(i/t-e);if(r<s.error&&(s={numerator:i,denominator:t,error:r},!r))break}}const i=[];if(t.fraction_integer){const e=Math.floor(s.numerator/s.denominator);s.numerator%=s.denominator,!e&&s.numerator||(i.push(e.toString()),s.numerator&&i.push(" "))}else s.numerator||i.push("0");return s.numerator&&(i.push(s.numerator.toString()),i.push("/"),i.push(s.denominator.toString())),i.join("")}BaseFormat(e){if(this.sections[0].date_format)return this.DateFormat(Number(e));if("number"!=typeof e)return this.StringFormat(e.toString(),this.sections[3]);let t=this.sections[0],s=this.decimal_zero_regexp[0];e<0&&(t=this.sections[1]);const i=t.percent?t.decimal_max_digits+2:t.decimal_max_digits,r=Math.pow(10,-i)/2;let o=Math.abs(e);if(o<r&&(t=this.sections[2],s=this.decimal_zero_regexp[2]),t.scaling&&(o/=t.scaling,o<r&&(t=this.sections[2],s=this.decimal_zero_regexp[2])),t.string_format)return this.StringFormat(e.toString(),t);let a="";if(t.fraction_format)return{parts:[this.FormatFraction(o,t)],section:t};t.exponential?a=o.toExponential(t.decimal_max_digits):(t.percent&&(o*=100),a=this.Round2(o,t.decimal_max_digits).toFixed(t.decimal_max_digits)),s&&(a=a.replace(s,""));const n=a.split(".");for(;n[0].length<t.integer_min_digits;)n[0]=("0000000000000000"+n[0]).slice(-t.integer_min_digits);return 0===t.integer_min_digits&&"0"===n[0]&&(n[0]=""),t.grouping&&(n[0]=n[0].replace(Y.grouping_regexp,"$&"+f.grouping_separator)),{parts:n,section:t}}}Y.grouping_regexp=/\d{1,3}(?=(\d{3})+(?!\d))/g,Y.fraction_limits=[9,99,999,9999],Y.imaginary_character="𝑖",Y.minus_character="-";class Q{static Get(e,t=!1){if(t&&"General"===e)return this.complex_general;const s=this.symbolc_name_map[e.toLowerCase()];let i=this.cache[s||e];return i||(i=new Y(e),this.cache[e]=i),i}static Equals(e,t){if(e===t)return!0;const s=this.Get(e),i=this.Get(t);return s.pattern===i.pattern}static Translate(e){const t=this.symbolc_name_map[e.toLowerCase()];return t?this.cache[t].toString():e}static SymbolicName(e){for(const t of Object.keys(this.base_formats))if(e===this.base_formats[t])return t;return null}static InitCache(){for(const e of Object.keys(this.base_formats))this.cache[e]=new Y(this.base_formats[e]),this.symbolc_name_map[e.toLowerCase()]=e;this.cache.General.magic_decimal=!0,this.complex_general=new Y("0.###"),this.complex_general.magic_decimal=!0;for(const e of Object.keys(this.aliases))this.cache[e]=this.cache[this.aliases[e]],this.symbolc_name_map[e.toLowerCase()]=e}}var ee;Q.cache={},Q.symbolc_name_map={},Q.base_formats={Accounting:"_(#,##0.00_);(#,##0.00);-???",Number:"0.00",Integer:"0",Percent:"0.00%",General:"0.######",Fraction:"# ?/?",Dollar:"$* _(#,##0.00_);$* (#,##0.00);$* -???",Exponential:"0.000e","Short Date":"mm/dd/yy","Long Date":"dddd, mmm d yyyy",Timestamp:"mm-dd-yy hh:mm:ss"},Q.aliases={Scientific:"Exponential",Percentage:"Percent",Currency:"Dollar"},Q.InitCache(),function(e){e[e.None=0]="None",e[e.Nan=1]="Nan",e[e.Exponential=2]="Exponential",e[e.Percent=4]="Percent",e[e.Currency=8]="Currency",e[e.Grouping=16]="Grouping",e[e.Parens=32]="Parens",e[e.Date=64]="Date",e[e.Time=128]="Time"}(ee||(ee={}));const te=(new Date).getUTCFullYear(),se=new class{TestDate(e){const t=Date.parse(e);if(isNaN(t))return!1;const s=new Date(t),i=e.replace(/[\d\-\\/,.\s]+/g," ").toLocaleLowerCase().split(/\s+/).map((e=>e.trim())).filter((e=>!!e));if(!i.length)return t;if(!this.compare_month){this.compare_month={};for(let e=0;e<12;e++)this.compare_month[f.date_components.long_months[e].toLocaleLowerCase().replace(/\./,"")]=e,this.compare_month[f.date_components.short_months[e].toLocaleLowerCase().replace(/\./,"")]=e}if(!this.compare_day){this.compare_day={};for(let e=0;e<7;e++)this.compare_day[f.date_components.long_days[e].toLocaleLowerCase().replace(/\./,"")]=e,this.compare_day[f.date_components.short_days[e].toLocaleLowerCase().replace(/\./,"")]=e}let r=!1,o=!1;for(const e of i){let t=!1;for(const[i,o]of Object.entries(this.compare_month))if(e===i){if(r)return!1;if(s.getUTCMonth()!==o)return!1;t=!0,r=!0}if(!t)for(const[i,r]of Object.entries(this.compare_day))if(e===i){if(o)return!1;if(s.getUTCDay()!==r)return!1;t=!0,o=!0}if(!t)return!1}return!(o&&!r)&&t}TryParse(e=""){let t=ee.None;if("'"===e[0])return{value:e,type:a.string};if(""===e)return{value:e,type:a.string};if("NaN"===e)return{value:NaN,type:a.number,hints:ee.Nan};let s=e.trim();const i=s.match(/^[$](.*?)$/);i&&(s=i[1],t|=ee.Currency);const r=s.match(/^\((.*?)\)$/);r&&(s=r[1],t|=ee.Parens);const o=s.match(/^(.*?)%\s*$/);o&&(s=o[1],t|=ee.Percent),"."===f.decimal_separator?/,/.test(s)&&(s=s.replace(/,/g,""),t|=ee.Grouping):(s=s.replace(/(\d)\s+/g,"$1"),s=s.replace(/\./g,""),s=s.replace(/,/,"."));let n=Number(s);if(null===n||isNaN(n)){const s=e.toLowerCase();if("false"===s)return{value:!1,type:a.boolean};if("true"===s)return{value:!0,type:a.boolean};const i=this.TestDate(e);if(!1!==i&&!isNaN(i)){const e=new Date(i),s=e.getUTCFullYear();if(s>=te-200&&s<=te+200)return t=ee.Date,(e.getHours()||e.getMinutes()||e.getSeconds())&&(t|=ee.Time),{value:K(i),type:a.number,hints:t}}return{value:e,type:a.string}}if(r&&(n=-n),o){const e=n<0?-1:1,t=(e*n).toString().split(".");t[0]=("00"+t[0]).replace(/(\d\d)$/,".$1"),n=Number(t.join(""))*e}return/e/.test(e)&&(t|=ee.Exponential),{value:n,type:a.number,hints:t}}},ie="http://www.w3.org/2000/svg";class re{constructor(e,t,s={x:0,y:0}){this.theme=t,this.offset=s,this.g=document.createElementNS(ie,"g"),this.g.setAttribute("transform",`translate(${s.x}, ${s.y})`),this.outline=document.createElementNS(ie,"rect"),this.outline.setAttribute("class","outline"),e?(this.g.setAttribute("class","selection primary-selection"),this.fill=document.createElementNS(ie,"path"),this.fill.setAttribute("class","fill"),this.nub=document.createElementNS(ie,"rect"),this.nub.setAttribute("class","nub"),this.g.appendChild(this.fill),this.g.appendChild(this.outline),this.g.appendChild(this.nub)):(this.g.setAttribute("class","selection alternate-selection"),this.fill=document.createElementNS(ie,"rect"),this.fill.setAttribute("class","fill"),this.g.appendChild(this.fill),this.g.appendChild(this.outline))}Offset(e){this.g.setAttribute("transform",`translate(${e.x}, ${e.y})`)}Show(e=!0){this.g.style.display=e?"block":"none"}SetOutline(e,t=!1){this.outline.setAttribute("x",(e.left-1).toString()),this.outline.setAttribute("y",(e.top-1).toString()),this.outline.setAttribute("width",(e.width+1).toString()),this.outline.setAttribute("height",(e.height+1).toString()),t&&this.fill&&(this.fill.setAttribute("x",e.left.toString()),this.fill.setAttribute("y",e.top.toString()),this.fill.setAttribute("width",e.width.toString()),this.fill.setAttribute("height",e.height.toString()))}SetFill(e,t){if(!this.fill)return;const s=[];s.push("M"+e.left+" "+e.top),s.push("L"+e.left+" "+e.bottom),s.push("L"+e.right+" "+e.bottom),s.push("L"+e.right+" "+e.top),s.push("Z"),s.push("M"+t.left+" "+t.top),s.push("L"+t.right+" "+t.top),s.push("L"+t.right+" "+t.bottom),s.push("L"+t.left+" "+t.bottom),s.push("Z"),this.fill.setAttribute("d",s.join(" "))}SetNub(e){this.nub&&(this.nub.setAttribute("x",(e.left+e.width-4).toString()),this.nub.setAttribute("y",(e.top+e.height-4).toString()),this.nub.setAttribute("width","7"),this.nub.setAttribute("height","7"))}}const oe="http://www.w3.org/2000/svg";var ae;!function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical"}(ae||(ae={}));class ne{constructor(e,t,s){this.theme=e,this.container=t,this.orientation=s,this.g=document.createElementNS(oe,"g"),this.g.setAttribute("class","header-overlay"),this.overlay=document.createElementNS(oe,"rect"),this.overlay.setAttribute("class","overlay"),this.highlight=document.createElementNS(oe,"rect"),this.highlight.setAttribute("class","highlight"),this.g.style.display="none",this.g.appendChild(this.highlight),this.g.appendChild(this.overlay),t.appendChild(this.g)}Remove(){this.container.removeChild(this.g)}Hide(){this.g.style.display="none"}Show(e,t,s,i){this.overlay.setAttribute("x",e.toString()),this.overlay.setAttribute("y",t.toString()),this.overlay.setAttribute("width",s.toString()),this.overlay.setAttribute("height",i.toString()),this.orientation===ae.Horizontal?(this.highlight.setAttribute("x",e.toString()),this.highlight.setAttribute("y",(t+i-2).toString()),this.highlight.setAttribute("width",s.toString()),this.highlight.setAttribute("height","2")):(this.highlight.setAttribute("x",(e+s-2).toString()),this.highlight.setAttribute("y",t.toString()),this.highlight.setAttribute("width","2"),this.highlight.setAttribute("height",i.toString())),this.g.style.display="block"}}class le{constructor(e,t,s,i,r){this.theme=e,this.layout=t,this.model=s,this.primary_selection=i,this.additional_selections=r,this.nub_rectangle=new p(-1,-1,0,0),this.grid_selections=[],this.row_header_selections=[],this.column_header_selections=[],this.corner_selections=[],this.cached_additional_selections=""}Initialize(){this.row_overlay=new ne(this.theme,this.layout.row_header_selection,ae.Horizontal),this.column_overlay=new ne(this.theme,this.layout.column_header_selection,ae.Vertical),this.corner_row_overlay=new ne(this.theme,this.layout.corner_selection,ae.Horizontal),this.corner_column_overlay=new ne(this.theme,this.layout.corner_selection,ae.Vertical)}RenderSelections(e=!0,t=!0){const s=this.primary_selection.empty;e||(this.primary_selection.empty=!0);const i=[this.primary_selection].concat(this.additional_selections);this.RenderSelectionGroup(i,this.layout.grid_selection,void 0,void 0,this.grid_selections,void 0,t);let r=new p(-1,-1,0,0);if(!this.primary_selection.empty){const e=this.model.active_sheet.RealArea(this.primary_selection.area);r=this.layout.CellAddressToRectangle(e.start).Combine(this.layout.CellAddressToRectangle(e.end))}if(!this.primary_selection.empty&&this.layout.header_offset.y>2?(this.row_overlay.Show(r.left,0,r.width,this.layout.header_offset.y),this.corner_row_overlay.Show(r.left+this.layout.header_offset.x,0,r.width,this.layout.header_offset.y)):(this.row_overlay.Hide(),this.corner_row_overlay.Hide()),!this.primary_selection.empty&&this.layout.header_offset.x>2?(this.column_overlay.Show(0,r.top,this.layout.header_offset.x,r.height),this.corner_column_overlay.Show(0,r.top+this.layout.header_offset.y,this.layout.header_offset.x,r.height)):(this.column_overlay.Hide(),this.corner_column_overlay.Hide()),!this.model.active_sheet.freeze.columns&&!this.model.active_sheet.freeze.rows)return void(this.primary_selection.empty=s);const o=[],a=[];if(this.primary_selection.empty)o.push(!1),a.push(!1);else{const e=this.primary_selection.area.start;o.push(e.row<=this.model.active_sheet.freeze.rows||e.row===1/0),a.push(e.column<=this.model.active_sheet.freeze.columns||e.column===1/0)}for(const{area:e}of this.additional_selections)o.push(e.start.row<=this.model.active_sheet.freeze.rows||e.start.row===1/0),a.push(e.start.column<=this.model.active_sheet.freeze.columns||e.start.column===1/0);this.model.active_sheet.freeze.rows&&this.RenderSelectionGroup(i,this.layout.row_header_selection,o,void 0,this.row_header_selections,{x:0,y:this.layout.header_offset.y}),this.model.active_sheet.freeze.columns&&this.RenderSelectionGroup(i,this.layout.column_header_selection,a,void 0,this.column_header_selections,{x:this.layout.header_offset.x,y:0}),this.model.active_sheet.freeze.rows&&this.model.active_sheet.freeze.columns&&this.RenderSelectionGroup(i,this.layout.corner_selection,a,o,this.corner_selections,Object.assign({},this.layout.header_offset)),this.primary_selection.empty=s}RenderSelectionGroup(e,t,s,i,r,o,a=!0){for(let n=0;n<e.length;n++)if(e[n].area.start.sheet_id&&e[n].area.start.sheet_id!==this.model.active_sheet.id||e[n].empty||s&&!s[n]||i&&!i[n])r[n]&&r[n].Show(!1);else if(a||!e[n].rendered){const s=this.EnsureGridSelectionBlock(t,r,n,o);this.RenderSVGSelection(e[n],s,n)}for(let t=e.length;t<r.length;t++)r[t]&&r[t].Show(!1)}EnsureGridSelectionBlock(e,t,s,i){let r=t[s];if(!r)if(r=new re(!s,this.theme),t[s]=r,s){let t=e.querySelector(".alternate-selections");t||(t=document.createElementNS("http://www.w3.org/2000/svg","g"),t.setAttribute("class","alternate-selections"),e.appendChild(t)),null==t||t.appendChild(r.g)}else e.appendChild(r.g);return i&&r.Offset(i),r}ClampEnd(e){return{row:Math.min(e.row,this.model.active_sheet.rows-1),column:Math.min(e.column,this.model.active_sheet.columns-1)}}RenderSVGSelection(e,t,s=0){const i=this.model.active_sheet.RealArea(e.area,!0);let r=this.layout.CellAddressToRectangle(i.start);if(i.count>1)r=r.Combine(this.layout.CellAddressToRectangle(i.end));else if(s){const t=this.model.active_sheet.CellData(e.target);t.merge_area&&(r=this.layout.CellAddressToRectangle(t.merge_area.start),r=r.Combine(this.layout.CellAddressToRectangle(t.merge_area.end)))}if(s||(this.nub_rectangle=new p(r.left+r.width-6,r.top+r.height-6,11,11)),0===r.top&&this.layout.header_offset.y<=1&&(r.top=1,r.height-=1),0===r.left&&this.layout.header_offset.x<=1&&(r.left=1,r.width-=1),r.height<=0||r.height<=0)t.Show(!1);else{if(t.SetOutline(r,!!s),s)e.rendered=!0;else{let s=this.layout.CellAddressToRectangle(e.target);const i=this.model.active_sheet.CellData(e.target);i.merge_area&&(s=this.layout.CellAddressToRectangle(i.merge_area.start),s=s.Combine(this.layout.CellAddressToRectangle(i.merge_area.end))),t.SetFill(s,r),t.SetNub(r)}t.Show()}}}function he(e,t=[],s,i){let r;"string"==typeof t&&(t=[t]);const o=e=>{e.stopPropagation(),e.preventDefault(),r(),i&&i(e)},a=e=>{if(e.stopPropagation(),e.preventDefault(),!e.buttons)return r(),void(i&&i(e));s&&s(e)};r=()=>{e.style.display="none",e.removeEventListener("mousemove",a),e.removeEventListener("mouseup",o);for(const s of t)e.classList.remove(s)};for(const s of t)e.classList.add(s);e.style.display="block",s&&e.addEventListener("mousemove",a),i&&e.addEventListener("mouseup",o)}class ce extends U{constructor(e,t,s,i,r){super(),this.layout=e,this.model=t,this.options=s,this.theme=i,this.grid_container=r,this.scale=1,this.dragging=!1,this.double_click_data={},this._visible=!1,this.scale=this.options.initial_scale||1,this.Init(r)}get visible(){return this._visible}IsDoubleClick(e,t=300){return this.double_click_data.index===e?(clearTimeout(this.double_click_data.timeout),this.double_click_data.index=void 0,this.double_click_data.timeout=void 0,!0):(this.double_click_data.timeout&&clearTimeout(this.double_click_data.timeout),this.double_click_data.index=e,this.double_click_data.timeout=setTimeout((()=>{this.double_click_data.index=void 0,this.double_click_data.timeout=void 0}),t),!1)}Hide(){this.Show(!1)}Show(e=!0){var t,s;this.container&&(this._visible=e,e?(this.grid_container.classList.add("treb-tab-bar-layout"),null===(t=this.grid_container.parentElement)||void 0===t||t.classList.add("has-tab-bar"),this.container.style.display="flex"):(this.grid_container.classList.remove("treb-tab-bar-layout"),null===(s=this.grid_container.parentElement)||void 0===s||s.classList.remove("has-tab-bar"),this.container.style.display="none"))}SetActive(e,t){t?e.classList.add("selected"):e.classList.remove("selected")}UpdateScale(e){this.scale_label&&(this.scale=e,this.scale_label.textContent=Math.round(1e3*e)/10+"%")}Update(){var e;if(this.dragging)return;if(!this.node)return;if("auto"===this.options.tab_bar){if(this.model.sheets.reduce(((e,t)=>t.visible?e+1:e),0)<=1)return void this.Show(!1);this.Show(!0)}this.grid_container.classList.add("treb-tab-bar-layout"),null===(e=this.grid_container.parentElement)||void 0===e||e.classList.add("has-tab-bar");const t=this.node;let s=!1;const i=Array.prototype.map.call(t.children,(e=>e));for(const e of i)e.dataset.preserve?s=!0:t.removeChild(e);if(!s){let e=document.createElement("div");if(e.classList.add("tab-bar-spacer"),e.style.order="9998",e.dataset.preserve="true",t.appendChild(e),e=document.createElement("div"),e.classList.add("tab-bar-end"),e.style.order="9999",e.dataset.preserve="true",this.options.scale_control){const t=document.createElement("div");t.classList.add("treb-scale-control");let s=document.createElement("button");s.innerHTML="<svg viewBox='0 0 16 16'><path d='M4,8 h8'/></svg>",s.title="Decrease scale",s.addEventListener("click",(()=>this.Publish({type:"scale",action:"decrease"}))),t.appendChild(s),this.scale_label=document.createElement("div"),t.appendChild(this.scale_label),this.UpdateScale(this.scale),s=document.createElement("button"),s.innerHTML="<svg viewBox='0 0 16 16'><path d='M4,8 h8 M8,4 v8'/></svg>",s.title="Increase scale",s.addEventListener("click",(()=>this.Publish({type:"scale",action:"increase"}))),t.appendChild(s),e.appendChild(t)}t.appendChild(e)}if(this.options.delete_tab){const e=document.createElement("div");e.classList.add("delete-tab"),e.innerHTML="<svg viewbox='0 0 16 16'><path d='M4,4 L12,12 M12,4 L4,12'/></svg>",e.style.order=(-1).toString(),e.title="Delete current sheet",e.addEventListener("click",(()=>{this.Publish({type:"delete-sheet"})})),t.appendChild(e)}const r=[];for(const e of this.model.sheets){if(!e.visible)continue;const s=r.length,i=document.createElement("div");i.classList.add("tab"),i.style.order=(2*s).toString(),this.SetActive(i,e===this.model.active_sheet);const o=t=>{if(t.stopPropagation(),t.preventDefault(),this.IsDoubleClick(s))return;this.Publish({type:"activate-sheet",sheet:e});let o=r.map((e=>e.getBoundingClientRect())),a=2*s-1;const n=o[0].left,l=o[o.length-1].right,h=o[0].top,c=o[0].bottom,d=2*(o.length-1)+1;for(const e of r)this.SetActive(e,e===i);this.dragging=!0,he(this.layout.mask,[],(e=>{const[t,u]=[e.clientX,e.clientY];if(u>h&&u<c){let e=a;if(t<n)e=-1;else if(t>l)e=d;else for(let i=0;i<o.length;i++){const r=o[i];if(t>=r.left&&t<=r.right){i!==s&&(e=t>=r.left+r.width/2?2*i+1:2*i-1);break}}e!==a&&(a=e,i.style.order=a.toString(),o=r.map((e=>e.getBoundingClientRect())))}}),(()=>{let e=s,t=(a+1)/2;this.dragging=!1;for(let s=0;s<this.model.sheets.length;s++)this.model.sheets[s].visible||(e>=s&&e++,t>=s&&t++);e===t||0===e&&t<=0||e===r.length-1&&t>=r.length-1||this.Publish({type:"reorder-sheet",index:e,move_before:t})}))},a=()=>{i.removeEventListener("mousedown",o),i.removeEventListener("dblclick",a),i.contentEditable="true";const t=window.getSelection();if(t){t.removeAllRanges();const e=document.createRange();e.selectNodeContents(i),t.addRange(e)}i.addEventListener("keydown",(t=>{switch(t.key){case"Enter":this.Publish({type:"rename-sheet",name:i.innerText.trim(),sheet:e});break;case"Escape":i.innerText=e.name,this.Publish({type:"cancel"});break;default:return}t.stopPropagation(),t.preventDefault()})),i.addEventListener("focusout",(()=>{const t=i.innerText.trim();this.Publish({type:"rename-sheet",name:t,sheet:e})})),i.focus()};i.textContent=e.name,i.addEventListener("dblclick",a),i.addEventListener("mousedown",o),t.appendChild(i),r.push(i)}if(this.options.add_tab){const e=document.createElement("a");e.classList.add("add-tab"),e.style.order=(2*this.model.sheets.length).toString(),e.innerText="+",e.title="Add sheet",e.addEventListener("click",(()=>{this.Publish({type:"add-sheet"})})),t.appendChild(e)}}Init(e){this.container=document.createElement("div"),this.container.classList.add("treb-tab-bar-container"),e.appendChild(this.container),this.node=document.createElement("div"),this.node.classList.add("treb-tab-bar"),this.container.appendChild(this.node)}}let de=100;class ue{constructor(e={}){this.key_=de++,this.data={},this.type="",this.temp={},this.inflated=!1,this.resizable=!0,this.movable=!0,this.removable=!0,this.selectable=!0,this.move_with_cells=!0,this.resize_with_cells=!0,this.formula="";for(const t of Object.keys(this))"layout"!==t&&e[t]&&(this[t]=e[t]);e.layout&&(this.layout=JSON.parse(JSON.stringify(e.layout))),e.rect&&(this.rect=p.Create(e.rect))}get key(){return this.key_}toJSON(){const e={};return this.data&&(e.data=this.data),this.formula&&(e.formula=this.formula),this.type&&(e.type=this.type),this.resizable||(e.resizable=this.resizable),this.movable||(e.movable=this.movable),this.removable||(e.removable=this.removable),this.selectable||(e.selectable=this.selectable),this.move_with_cells||(e.move_with_cells=this.move_with_cells),this.resize_with_cells||(e.resize_with_cells=this.resize_with_cells),this.layout&&(e.layout=this.layout),this.extent&&(e.extent=this.extent),e}}class me{constructor(e){this.annotations=[],this.freeze={rows:0,columns:0},this.visible=!0,this.default_column_width=100,this.default_row_height=25,this.cells=new m,this.selection={target:{row:0,column:0},area:new r({row:0,column:0}),empty:!0},this.scroll_offset={x:0,y:0},this.name=me.default_sheet_name,this.row_height_=[],this.column_width_=[],this.row_headers=[],this.column_headers=[],this.row_header_width=100,this.column_header_height=25,this.style_map=[],this.style_json_map=[],this.sheet_style={},this.row_styles={},this.column_styles={},this.row_pattern=[],this.cell_style=[],this.default_style_properties=e,this.default_column_width=100,this.row_header_width=60,this.UpdateDefaultRowHeight(),this.id_=me.base_id++}static Reset(){this.base_id=100}static Blank(e,t,s=30,i=20){const r=new me(e);return t&&(r.name=t),s=Math.max(s,1),i=Math.max(i,1),r.cells.EnsureCell({row:s-1,column:i-1}),r}static FromJSON(e,t,s){let i;i="string"==typeof e?JSON.parse(e):e;const r=(e,t)=>{Object.keys(t).forEach((s=>{const i=Number(s)||0;e[i]=t[s]}))};s||(s=new me(t)),i.default_column_width&&(s.default_column_width=i.default_column_width),i.default_row_height&&(s.default_row_height=i.default_row_height),i.id&&(s.id=i.id),i.name&&(s.name=i.name);const o=e=>{const t=e;t.text_color&&("none"!==t.text_color&&(t.text={text:t.text_color}),t.text_color=void 0),t.background&&("none"!==t.background&&(t.fill={text:t.background}),t.background=void 0),t.border_top_color&&("none"!==t.border_top_color&&(t.border_top_fill={text:t.border_top_color}),t.border_top_color=void 0),t.border_left_color&&("none"!==t.border_left_color&&(t.border_left_fill={text:t.border_left_color}),t.border_left_color=void 0),t.border_bottom_color&&("none"!==t.border_bottom_color&&(t.border_bottom_fill={text:t.border_bottom_color}),t.border_bottom_color=void 0),t.border_right_color&&("none"!==t.border_right_color&&(t.border_right_fill={text:t.border_right_color}),t.border_right_color=void 0)},a=i.cell_style_refs;for(const e of a)o(e);if(s.cell_style=[],a&&(i.cell_styles||[]).forEach((e=>{"number"==typeof e.ref&&(e.style=JSON.parse(JSON.stringify(a[e.ref])))})),s.cells.FromJSON(i.data),i.rows&&s.cells.EnsureRow(i.rows-1),i.columns&&s.cells.EnsureColumn(i.columns-1),i.data)if(d(i.data))for(const e of i.data)e.style_ref&&(s.cell_style[e.column]||(s.cell_style[e.column]=[]),s.cell_style[e.column][e.row]=JSON.parse(JSON.stringify(a[e.style_ref])));else if(u(i.data))for(const e of i.data){const t=e.row;for(const i of e.cells){const e=i.column;i.style_ref&&(s.cell_style[e]||(s.cell_style[e]=[]),s.cell_style[e][t]=JSON.parse(JSON.stringify(a[i.style_ref])))}}else for(const e of i.data){const t=e.column;for(const i of e.cells){const e=i.row;i.style_ref&&(s.cell_style[t]||(s.cell_style[t]=[]),s.cell_style[t][e]=JSON.parse(JSON.stringify(a[i.style_ref])))}}s.freeze.rows=0,s.freeze.columns=0,i.freeze&&(s.freeze.rows=i.freeze.rows||0,s.freeze.columns=i.freeze.columns||0),s.scroll_offset=i.scroll?Object.assign({},i.scroll):{x:0,y:0};for(const e of i.cell_styles||[])e.style&&(s.cell_style[e.column]||(s.cell_style[e.column]=[]),s.cell_style[e.column][e.row]=e.style);s.sheet_style=i.sheet_style||{},s.row_styles=i.row_style,s.column_styles=i.column_style,s.row_pattern=i.row_pattern||[],o(s.sheet_style||{});for(const e of s.row_pattern)o(e);for(const e of Object.keys(s.column_styles))o(s.column_styles[e]);for(const e of Object.keys(s.row_styles))o(s.row_styles[e]);return s.row_height_=[],r(s.row_height_,i.row_height||{}),s.row_height_.length&&s.cells.EnsureRow(s.row_height_.length-1),s.column_width_=[],r(s.column_width_,i.column_width||{}),s.column_width_.length&&s.cells.EnsureColumn(s.column_width_.length-1),s.annotations=(i.annotations||[]).map((e=>new ue(e))),i.selection&&(s.selection=JSON.parse(JSON.stringify(i.selection))),s.visible=!0,void 0!==i.visible&&(s.visible=!!i.visible),s}get header_offset(){return{x:this.row_header_width,y:this.column_header_height}}get rows(){return this.cells.rows}get columns(){return this.cells.columns}get id(){return this.id_}set id(e){this.id_=e,this.id>=me.base_id&&(me.base_id=this.id+1)}MergeCells(e){e=e.Clone(),this.cells.Apply(e,((t,s,i)=>{t.merge_area=e,t.render_dirty=!0,s===e.start.column&&i===e.start.row||t.Reset()}),!0)}UnmergeCells(e){let t=!0;this.cells.Apply(e,(s=>{t=t&&!!s.merge_area&&e.Equals(s.merge_area)}),!1),t?this.cells.Apply(e,(e=>{e.merge_area=void 0,e.render_dirty=!0}),!1):console.warn("area mismatch")}StyleFontSize(e,t={}){let s=e.font_size_value||0,i=0;switch(e.font_size_unit){case"px":s*=.75;break;case"em":i=e.font_size_value||1;break;case"%":i=(e.font_size_value||100)/100}return i&&(s=i*(t.font_size_value||10),"px"===t.font_size_unit&&(s*=.75)),s||10}UpdateDefaultRowHeight(){const e=_.Composite([this.default_style_properties,this.sheet_style]);if("undefined"!=typeof window){const t=H.MeasureText(_.Font(e),"M"),s=Math.round(1.4*t.height);this.default_row_height<s&&(this.default_row_height=s)}}SetRowHeaders(e){this.row_headers=e.map((e=>void 0===e?"":e.toString())),this.row_headers&&this.cells.EnsureRow(this.row_headers.length-1)}SetColumnHeaders(e){this.column_headers=e.map((e=>void 0===e?"":e.toString())),e&&this.cells.EnsureColumn(e.length-1)}RowHeader(e){return this.row_headers?this.row_headers.length>e?this.row_headers[e]:"":e+1}ColumnHeader(e){let t="";if(this.column_headers)return this.column_headers.length>e?this.column_headers[e]:"";for(;;){const s=e%26;if(t=String.fromCharCode(65+s)+t,!(e=Math.floor(e/26)))break;e--}return t}GetRowHeight(e){const t=this.row_height_[e];return void 0===t?this.default_row_height:t}SetRowHeight(e,t){return this.row_height_[e]=t,this.cells.EnsureRow(e),t}GetColumnWidth(e){const t=this.column_width_[e];return void 0===t?this.default_column_width:t}SetColumnWidth(e,t){return this.column_width_[e]=t,this.cells.EnsureColumn(e),t}Delta(e,t){const s={},i=[...Object.keys(e),...Object.keys(t)];for(const r of i){const i=e[r],o=t[r];"object"==typeof i&&"object"==typeof o?JSON.stringify(i)!==JSON.stringify(o)&&(s[r]=o):i!==o&&(s[r]=o)}return s}UpdateCellStyle(e,t,s=!0){const{row:i,column:r}=e;this.cell_style[r]||(this.cell_style[r]=[]);const o=this.CompositeStyleForCell(e,!1,!1),a=_.Composite([this.default_style_properties,o,_.Merge(this.cell_style[r][i]||{},t,s)]),n=this.Delta(o,a);this.cell_style[r][i]=n,this.CellData(e).FlushStyle()}Invalidate(e){this.cells.Apply(this.RealArea(e),(e=>e.render_dirty=!0))}UpdateAreaStyle(e,t={},s=!0){if(e)if(e.entire_sheet)this.UpdateSheetStyle(t,s);else if(e.entire_column)for(let i=e.start.column;i<=e.end.column;i++)this.UpdateColumnStyle(i,t,s);else if(e.entire_row)for(let i=e.start.row;i<=e.end.row;i++)this.UpdateRowStyle(i,t,s);else e.Array().forEach((e=>this.UpdateCellStyle(e,t,s)))}HasCellStyle(e){return!!(this.cell_style[e.column]&&this.cell_style[e.column][e.row]||this.row_styles[e.row]||this.column_styles[e.column]||this.row_pattern.length)}NextVisibleColumn(e){for(++e;0===this.column_width_[e];e++);return e}PreviousVisibleColumn(e){for(--e;e>=0&&0===this.column_width_[e];e--);return e}NextVisibleRow(e){for(++e;0===this.row_height_[e];e++);return e}PreviousVisibleRow(e){for(--e;e>=0&&0===this.row_height_[e];e--);return e}SurroundingStyle(e){const t=[{},{},{},{},{},{},{},{},{},{}];let s=e.column+1,i=e.column-1,r=e.row+1,o=e.row-1;for(;0===this.column_width_[s];s++);for(;0===this.row_height_[r];r++);for(;i>=0&&0===this.column_width_[i];i--);for(;o>=0&&0===this.row_height_[o];o--);return i>=0&&o>=0&&(t[7]=this.CellStyleData({row:o,column:i})||{}),i>=0&&(t[4]=this.CellStyleData({row:e.row,column:i})||{},t[1]=this.CellStyleData({row:r,column:i})||{}),o>=0&&(t[8]=this.CellStyleData({row:o,column:e.column})||{},t[9]=this.CellStyleData({row:o,column:s})||{}),t[6]=this.CellStyleData({row:e.row,column:s})||{},t[2]=this.CellStyleData({row:r,column:e.column})||{},t[3]=this.CellStyleData({row:r,column:s})||{},t}CellStyleData(e){const t=this.cells.GetCell(e);if(t){if(!t.style){const s=this.GetStyleIndex(this.CompositeStyleForCell(e));t.style=this.style_map[s]}return t.style}}GetCopyStyle(e){return this.CompositeStyleForCell(e,!0,!1)}CellData(e){const t=this.cells.EnsureCell(e);if(t.rendered_type)return t;let s,i;if(t.calculated_type?(i=t.calculated,s=t.calculated_type):(i=t.value,s=t.type),!t.style){const s=this.GetStyleIndex(this.CompositeStyleForCell(e));t.style=this.style_map[s]}if(s&&null!=i)if(s===a.number)isNaN(i)?t.formatted=void 0===t.style.nan?"NaN":t.style.nan:t.formatted=this.FormatNumber(i,t.style.number_format),t.rendered_type=a.number;else if(s===a.error)t.formatted="#"+(i||"ERR?"),t.rendered_type=a.error;else if(s===a.boolean)t.formatted=i.toString().toUpperCase(),t.rendered_type=a.boolean;else if(s===a.formula&&void 0===t.calculated)t.formatted="",t.rendered_type=a.string;else if(s===a.complex){const e=i;if(isNaN(e.real)||isNaN(e.imaginary))t.formatted=void 0===t.style.nan?"NaN":t.style.nan;else{const s=Q.Get(t.style.number_format||"",!0);t.formatted=s.FormatComplex(e)}t.rendered_type=a.complex}else t.formatted=this.FormatNumber(i,t.style.number_format),t.rendered_type=a.string;else t.formatted="",t.rendered_type=a.string;return t}FormatNumber(e,t=""){const s=Q.Get(t).FormatParts(e);return s.length?1!==s.length||s[0].flag?s:s[0].text||"":""}SetHeaderSize(e=60,t=this.default_row_height){this.row_header_width=e,this.column_header_height=t}AutoSizeRow(e,t={},s=!0){let i=this.default_row_height;for(let s=0;s<this.cells.columns;s++){const r=this.CellData({row:e,column:s}),o=r.style;let a=r.formatted||"";if("string"!=typeof a&&(a=a.map((e=>e.text)).join("")),o&&a&&a.length){const e=a.split(/\n/),s=Math.round(1.5*this.StyleFontSize(o,t));i=Math.max(i,((s||10)+9)*e.length)}}!s&&this.GetRowHeight(e)>=i||this.SetRowHeight(e,i)}AutoSizeColumn(e,t=!0){me.measurement_canvas||(me.measurement_canvas=document.createElement("canvas"));const s=me.measurement_canvas.getContext("2d");if(!s)return;let i=12;t||(i=this.GetColumnWidth(e));for(let t=0;t<this.cells.rows;t++){const r=this.CellData({row:t,column:e});let o=r.formatted||"";"string"!=typeof o&&(o=o.map((e=>e.text)).join("")),o&&o.length&&(s.font=_.Font(r.style||{}),i=Math.max(i,Math.ceil(s.measureText(o).width)+8))}this.SetColumnWidth(e,i)}GetStyle(e){return this.style_map[e]}InsertRows(e=0,t=1){if(e)for(let t=0;t<this.cells.columns;t++){const s=this.cells.GetCell({row:e-1,column:t},!1);if(s&&s.area){const i=this.cells.GetCell({row:e,column:t},!1);if(i&&i.area&&i.area.Equals(s.area))return!1}}t<0?this.cells.DeleteRows(e,-t):this.cells.InsertRows(e,t);const s={},i={};for(let t=e;t<this.cells.rows;t++)for(let e=0;e<this.cells.columns;e++){const r=this.cells.GetCell({row:t,column:e},!1);r&&(r.area&&!i[r.area.spreadsheet_label]&&(i[r.area.spreadsheet_label]=r.area),r.merge_area&&!s[r.merge_area.spreadsheet_label]&&(s[r.merge_area.spreadsheet_label]=r.merge_area))}for(const e of Object.keys(i)){const s=i[e],o=new r({row:s.start.row+t,column:s.start.column},{row:s.end.row+t,column:s.end.column});o.Iterate((e=>{this.cells.GetCell(e,!0).area=o}))}for(const i of Object.keys(s)){const o=s[i],a={row:o.start.row,column:o.start.column};o.start.row>=e&&(a.row+=t);const n=new r(a,{row:o.end.row+t,column:o.end.column});n.Iterate((e=>{this.cells.GetCell(e,!0).merge_area=n}))}const o=Object.keys(this.row_styles),a={};o.forEach((s=>{const i=Number(s);i<e?a[i]=this.row_styles[i]:t<0&&i<e-t||(a[i+t]=this.row_styles[i])})),this.row_styles=a;let n=[];if(t<0)n=[e,-t];else{n=[e,0];for(let e=0;e<t;e++)n.push(void 0)}return this.cell_style.forEach((t=>{t&&t.length>=e&&t.splice.apply(t,n)})),this.row_height_.splice.apply(this.row_height_,n),this.FlushCellStyles(),!0}InsertColumns(e=0,t=1){if(e)for(let t=0;t<this.cells.rows;t++){const s=this.cells.GetCell({row:t,column:e-1},!1);if(s&&s.area){const i=this.cells.GetCell({row:t,column:e},!1);if(i&&i.area&&i.area.Equals(s.area))return!1}}t<0?this.cells.DeleteColumns(e,-t):this.cells.InsertColumns(e,t);const s={},i={};for(let t=e;t<this.cells.columns;t++)for(let e=0;e<this.cells.rows;e++){const r=this.cells.GetCell({row:e,column:t},!1);r&&(r.area&&!i[r.area.spreadsheet_label]&&(i[r.area.spreadsheet_label]=r.area),r.merge_area&&!s[r.merge_area.spreadsheet_label]&&(s[r.merge_area.spreadsheet_label]=r.merge_area))}for(const e of Object.keys(i)){const s=i[e],o=new r({row:s.start.row,column:s.start.column+t},{row:s.end.row,column:s.end.column+t});o.Iterate((e=>{this.cells.GetCell(e,!0).area=o}))}for(const i of Object.keys(s)){const o=s[i],a={row:o.start.row,column:o.start.column};o.start.column>=e&&(a.column+=t);const n=new r(a,{row:o.end.row,column:o.end.column+t});n.Iterate((e=>{this.cells.GetCell(e,!0).merge_area=n}))}const o=Object.keys(this.column_styles),a={};o.forEach((s=>{const i=Number(s);i<e?a[i]=this.column_styles[i]:t<0&&i<e-t||(a[i+t]=this.column_styles[i])})),this.column_styles=a;let n=[];if(t<0)n=[e,-t];else{n=[e,0];for(let e=0;e<t;e++)n.push(void 0)}return this.cell_style.splice.apply(this.cell_style,n),this.column_width_.splice.apply(this.column_width_,n),this.FlushCellStyles(),!0}ClearArea(e){e=this.RealArea(e),this.cells.Apply(e,(e=>e.Reset()))}SetAreaValues2(e,t){e=this.RealArea(e),this.cells.SetArea(e,t)}SetArrayValue(e,t){e=this.RealArea(e),this.cells.Apply(e,(t=>t.SetArray(e)),!0),this.cells.GetCell(e.start,!0).SetArrayHead(e,t)}SetCellValue(e,t){this.cells.GetCell(e,!0).Set(t)}RealArea(e,t=!1){const s=e.start,i=e.end;return e.entire_row&&(s.column=0,s.absolute_column=!1,i.column=this.cells.columns-1,i.absolute_column=!1),e.entire_column&&(s.row=0,s.absolute_row=!1,i.row=this.cells.rows-1,i.absolute_row=!1),t&&(i.row>=this.rows&&(i.row=this.rows-1,i.absolute_row=!1),i.column>=this.columns&&(i.column=this.columns-1,i.absolute_column=!1)),new r(s,i)}FormattedCellValue(e){const t=this.CellData(e);if(t)return"string"==typeof t.formatted?t.formatted:t.formatted?t.formatted.map((e=>{switch(e.flag){case 1:case 2:return" ";default:return e.text}})).join(""):t.value}GetFormattedRange(e,t=e){if(e.row===t.row&&e.column===t.column)return this.FormattedCellValue(e);const s=[];for(let i=e.row;i<=t.row;i++){const r=[];for(let s=e.column;s<=t.column;s++)r.push(this.FormattedCellValue({row:i,column:s}));s.push(r)}return s}NumberFormatsAndColors(e,t){const s=s=>{var i,r,o,a,n,l;s.number_format&&(t[s.number_format]=1),(null===(i=s.text)||void 0===i?void 0:i.text)&&"none"!==s.text.text&&(e[s.text.text]=1),(null===(r=s.fill)||void 0===r?void 0:r.text)&&(e[s.fill.text]=1),(null===(o=s.border_top_fill)||void 0===o?void 0:o.text)&&(e[s.border_top_fill.text]=1),(null===(a=s.border_left_fill)||void 0===a?void 0:a.text)&&(e[s.border_left_fill.text]=1),(null===(n=s.border_right_fill)||void 0===n?void 0:n.text)&&(e[s.border_right_fill.text]=1),(null===(l=s.border_bottom_fill)||void 0===l?void 0:l.text)&&(e[s.border_bottom_fill.text]=1)};s(this.sheet_style);for(const e in this.row_styles)s(this.row_styles[e]);for(const e in this.column_styles)s(this.column_styles[e]);for(const e of this.row_pattern)s(e);for(const e of this.cell_style)if(e)for(const t of e)t&&s(t)}toJSON(e={}){var t;const s=(e,t)=>{const s={};for(let i=0;i<e.length;i++)void 0!==e[i]&&e[i]!==t&&(s[i]=e[i]);if(Object.keys(s).length)return s};let i=[{}];const r={},o=[],a=JSON.stringify({});for(let e=0;e<this.cell_style.length;e++){const t=this.cell_style[e];if(t){o[e]=[];for(let s=0;s<t.length;s++)if(t[s]){const n=JSON.stringify(t[s]);if(n!==a){let a=r[n];"number"!=typeof a&&(r[n]=a=i.length,i.push(t[s])),o[e][s]=a}}}}i=JSON.parse(JSON.stringify(i));const n=JSON.parse(JSON.stringify(this.sheet_style)),l=JSON.parse(JSON.stringify(this.row_styles)),h=JSON.parse(JSON.stringify(this.column_styles)),c=JSON.parse(JSON.stringify(this.row_pattern)),d=(e={},t={})=>{const s=Object.assign(Object.assign({},t),e);return s.text?(s.text=H.MeasureColorARGB(s.text),s):"number"==typeof s.theme?s:void 0};if(e.export_colors){const e=[];for(const t of[l,h,i,[n],c])if(Array.isArray(t))for(const s of t)e.push(s);else for(const s of Object.keys(t))e.push(t[s]);for(const s of e){let e=d(s.border_top_fill,_.DefaultProperties.border_top_fill);void 0!==e&&(s.border_top_fill=e),e=d(s.border_left_fill,_.DefaultProperties.border_left_fill),void 0!==e&&(s.border_left_fill=e),e=d(s.border_right_fill,_.DefaultProperties.border_right_fill),void 0!==e&&(s.border_right_fill=e),e=d(s.border_bottom_fill,_.DefaultProperties.border_bottom_fill),void 0!==e&&(s.border_bottom_fill=e),(null===(t=s.fill)||void 0===t?void 0:t.text)&&(s.fill.text=H.MeasureColorARGB(s.fill.text)),s.text&&s.text.text&&"none"!==s.text.text&&(s.text.text=H.MeasureColorARGB(s.text.text))}}const u={calculated_value:!!e.rendered_values,preserve_type:!!e.preserve_type,expand_arrays:!!e.expand_arrays,decorated_cells:!!e.decorated_cells,nested:!0,cell_style_refs:o},m=this.cells.toJSON(u),f=m.data;let{rows:p,columns:g}=m;e.shrink?(p+=2,g+=1):(p=this.rows,g=this.columns);for(const e of this.annotations)e.extent||this.CalculateAnnotationExtent(e),e.extent&&(p=Math.max(p,e.extent.row+1),g=Math.max(g,e.extent.column+1));const y=[];for(let e=0;e<o.length;e++){const t=o[e];if(t)for(let s=0;s<t.length;s++)t[s]&&y.push({row:s,column:e,ref:t[s]})}const v={id:this.id,name:this.name,data:f,sheet_style:n,rows:p,columns:g,cell_styles:y,cell_style_refs:i,row_style:l,column_style:h,row_pattern:c.length?c:void 0,default_row_height:this.default_row_height,default_column_width:this.default_column_width,row_height:s(this.row_height_,this.default_row_height),column_width:s(this.column_width_,this.default_column_width),selection:JSON.parse(JSON.stringify(this.selection)),annotations:JSON.parse(JSON.stringify(this.annotations))};return this.visible||(v.visible=this.visible),(this.scroll_offset.x||this.scroll_offset.y)&&(v.scroll=this.scroll_offset),(this.freeze.rows||this.freeze.columns)&&(v.freeze=this.freeze),v}FlushCellStyles(){this.style_map=[],this.style_json_map=[],this.cells.FlushCellStyles()}ImportData(e){const t=e.styles,s=e.sheet_style;s&&this.UpdateAreaStyle(new r({row:1/0,column:1/0},{row:1/0,column:1/0}),t[s]);const i=e.column_styles;if(i)for(let e=0;e<i.length;e++)i[e]&&this.UpdateAreaStyle(new r({row:1/0,column:e},{row:1/0,column:e}),t[i[e]]);this.cells.FromJSON(e.cells),e.name&&(this.name=e.name||"");const o=this.cell_style;for(const s of e.cells)s.style_ref&&(o[s.column]||(o[s.column]=[]),o[s.column][s.row]=t[s.style_ref]);for(let t=0;t<e.column_widths.length;t++)void 0!==e.column_widths[t]&&this.SetColumnWidth(t,e.column_widths[t]);for(let t=0;t<e.row_heights.length;t++)void 0!==e.row_heights[t]&&this.SetRowHeight(t,e.row_heights[t]);for(const t of e.annotations||[])this.annotations.push(new ue(t));e.hidden&&(this.visible=!1)}CalculateAnnotationExtent(e){var t,s;if(e.layout)return void(e.extent=Object.assign({},e.layout.br.address));e.extent={row:0,column:0};let i=null===(t=e.rect)||void 0===t?void 0:t.right;if(i&&this.default_column_width)for(let t=0;i>=0&&t<1e3;t++)if(i-=this.GetColumnWidth(t),i<0){e.extent.column=t;break}let r=null===(s=e.rect)||void 0===s?void 0:s.bottom;if(r&&this.default_row_height)for(let t=0;r>=0&&t<1e3;t++)if(r-=this.GetRowHeight(t),r<0){e.extent.row=t;break}}UpdateSheetStyle(e,t=!0){this.sheet_style=_.Merge(this.sheet_style,e,t);const s=Object.keys(e);for(const e of this.cell_style)if(e)for(const t of e)t&&s.forEach((e=>delete t[e]));for(const e of Object.keys(this.row_styles))s.forEach((t=>delete this.row_styles[e][t]));for(const e of Object.keys(this.column_styles))s.forEach((t=>delete this.column_styles[e][t]));this.FlushCellStyles()}UpdateRowStyle(e,t,s=!0){this.row_styles[e]=_.Merge(this.row_styles[e]||{},t,s);const i=Object.keys(t);for(const t of this.cell_style)t&&t[e]&&i.forEach((s=>delete t[e][s]));for(let s=0;s<this.cells.columns;s++)if(this.column_styles[s]){const r=this.column_styles[s],o=this.cell_style[s]&&this.cell_style[s][e]||{};for(const e of i)void 0!==r[e]&&(o[e]=t[e]);Object.keys(o).length&&(this.cell_style[s]||(this.cell_style[s]=[]),this.cell_style[s][e]=JSON.parse(JSON.stringify(o)))}this.cells.Apply(this.RealArea(r.FromRow(e)),(e=>e.FlushStyle()))}FlattenStyles(){this.CompositeStyleForCell}UpdateColumnStyle(e,t,s=!0){this.column_styles[e]=_.Merge(this.column_styles[e]||{},t,s);const i=Object.keys(t);if(this.cell_style[e])for(const t of this.cell_style[e])t&&i.forEach((e=>delete t[e]));this.cells.Apply(this.RealArea(r.FromColumn(e)),(e=>e.FlushStyle()))}CompositeStyleForCell(e,t=!0,s=!0){const{row:i,column:r}=e,o=[this.default_style_properties,this.sheet_style];return s&&this.row_pattern.length&&o.push(this.row_pattern[i%this.row_pattern.length]),this.row_styles[i]&&o.push(this.row_styles[i]),this.column_styles[r]&&o.push(this.column_styles[r]),t&&this.cell_style[r]&&this.cell_style[r][i]&&o.push(this.cell_style[r][i]),_.Composite(o)}GetStyleIndex(e){const t=JSON.stringify(e);for(let e=0;e<this.style_json_map.length;e++)if(t===this.style_json_map[e])return e;const s=this.style_map.length;return this.style_map.push(JSON.parse(t)),this.style_json_map.push(t),s}}me.base_id=100,me.default_sheet_name="Sheet1";class fe{static CreateDiv(e="",t,s){return this.Create("div",e,t,s)}static Create(e="",t="",s,i){const r=document.createElement(e);return t&&r.setAttribute("class",t),i&&r.setAttribute(i,""),s&&s.appendChild(r),r}}const pe="http://www.w3.org/2000/svg",_e="http://www.w3.org/2000/svg";class ge extends class{constructor(e){this.model=e,this.grid_tiles=[],this.column_header_tiles=[],this.row_header_tiles=[],this.frozen_row_tiles=[],this.frozen_column_tiles=[],this.header_size={width:0,height:0},this.last_column=0,this.total_height=0,this.total_width=0,this.default_row_height=0,this.default_column_width=0,this.header_offset={x:0,y:0},this.dpr=Math.max(1,self.devicePixelRatio||1),this.scale=1,this.trident="undefined"!=typeof navigator&&navigator.userAgent&&/trident/i.test(navigator.userAgent),this.default_tile_size={width:1200,height:800},this.dropdown_caret_visible=!1,this.row_cache=[],this.column_cache=[],this.initialized=!1,this.mask=fe.CreateDiv("treb-mouse-mask"),this.tooltip=fe.CreateDiv("treb-tooltip"),this.dropdown_caret=document.createElementNS(pe,"svg"),this.dropdown_caret.setAttribute("class","treb-dropdown-caret"),this.dropdown_caret.setAttribute("viewBox","0 0 24 24"),this.dropdown_caret.tabIndex=-1;const t=document.createElementNS(pe,"path");t.setAttribute("d","M5,7 L12,17 L19,7"),this.dropdown_caret.appendChild(t),this.dropdown_caret.addEventListener("click",(e=>{e.stopPropagation(),e.preventDefault(),this.grid_cover.classList.remove("nub-select");const t=this.dropdown_caret.getAttribute("class")||"";/active/i.test(t)?this.dropdown_caret.setAttribute("class","treb-dropdown-caret"):(this.dropdown_caret.setAttribute("class","treb-dropdown-caret active"),this.dropdown_list.focus())})),this.dropdown_list=fe.CreateDiv("treb-dropdown-list"),this.dropdown_list.setAttribute("tabindex","-1"),this.dropdown_list.addEventListener("keydown",(e=>{var t;let s=0;switch(e.key){case"ArrowDown":s=1;break;case"ArrowUp":s=-1;break;case"Escape":case"Enter":break;default:return void console.info(e.key)}if(e.stopPropagation(),e.preventDefault(),"Escape"===e.key||"Enter"===e.key)null===(t=this.container)||void 0===t||t.focus(),this.dropdown_caret.setAttribute("class","treb-dropdown-caret"),"Enter"===e.key&&this.dropdown_callback&&this.dropdown_selected&&this.dropdown_callback.call(0,this.dropdown_selected.dropdown_value);else if(s&&this.dropdown_selected)if(s>0&&this.dropdown_selected.nextSibling){this.dropdown_selected.nextSibling.classList.add("selected"),this.dropdown_selected.classList.remove("selected"),this.dropdown_selected=this.dropdown_selected.nextSibling;const e=this.dropdown_selected.offsetTop+this.dropdown_selected.offsetHeight;e>this.dropdown_list.offsetHeight+this.dropdown_list.scrollTop&&(this.dropdown_list.scrollTop=e-this.dropdown_list.offsetHeight)}else s<0&&this.dropdown_selected.previousSibling&&(this.dropdown_selected.previousSibling.classList.add("selected"),this.dropdown_selected.classList.remove("selected"),this.dropdown_selected=this.dropdown_selected.previousSibling,this.dropdown_selected.offsetTop<this.dropdown_list.scrollTop&&(this.dropdown_list.scrollTop=this.dropdown_selected.offsetTop))})),this.dropdown_list.addEventListener("mousedown",(e=>{var t;const s=e.target;e.target!==this.dropdown_list&&(e.stopPropagation(),e.preventDefault(),null===(t=this.container)||void 0===t||t.focus(),this.dropdown_caret.setAttribute("class","treb-dropdown-caret"),this.dropdown_callback&&this.dropdown_callback.call(0,s.dropdown_value))})),this.dropdown_list.addEventListener("mousemove",(e=>{const t=e.target;t!==this.dropdown_selected&&(this.grid_cover.classList.remove("nub-select"),this.dropdown_selected&&this.dropdown_selected.classList.remove("selected"),t.classList.add("selected"),this.dropdown_selected=t)})),this.mock_selection=fe.CreateDiv("mock-selection-node"),this.mock_selection.innerHTML="&nbsp;",this.note_node=fe.CreateDiv("treb-note"),this.title_node=fe.CreateDiv("treb-hover-title"),this.HideNote()}get scroll_offset(){return this.scroll_reference_node?{x:this.scroll_reference_node.scrollLeft,y:this.scroll_reference_node.scrollTop}:{x:0,y:0}}set scroll_offset(e){this.scroll_reference_node&&(this.scroll_reference_node.scrollLeft=e.x,this.scroll_reference_node.scrollTop=e.y)}ColumnWidth(e){return Math.round(this.model.active_sheet.GetColumnWidth(e)*this.scale)}RowHeight(e){return Math.round(this.model.active_sheet.GetRowHeight(e)*this.scale)}SetRowHeight(e,t){this.model.active_sheet.SetRowHeight(e,Math.round(t/this.scale))}SetColumnWidth(e,t){this.model.active_sheet.SetColumnWidth(e,Math.round(t/this.scale))}ShowSelections(e=!0){this.grid_selection.style.display=e?"block":"none"}HideTitle(){this.title_node.style.opacity="0"}ShowTitle(e,t,s){if(this.title_node.textContent=e,!this.title_node.parentElement)return;this.title_node.getBoundingClientRect();const i=this.title_node.parentElement.getBoundingClientRect(),r=this.OffsetCellAddressToRectangle(t).Shift(this.header_size.width,this.header_size.height);this.title_node.style.left=i.left+r.left-this.scroll_reference_node.scrollLeft+0+"px",this.title_node.style.top=i.top+r.bottom-this.scroll_reference_node.scrollTop+8+"px",this.title_node.style.opacity="1"}HideNote(){this.note_node.style.opacity="0",this.note_node.style.pointerEvents="none"}ShowNote(e,t,s){if(this.note_node.textContent=e,!this.note_node.parentElement)return;const i=this.note_node.getBoundingClientRect(),r=this.note_node.parentElement.getBoundingClientRect(),o=this.OffsetCellAddressToRectangle(t).Shift(this.header_size.width,this.header_size.height);this.note_node.style.left=r.left+o.right-this.scroll_reference_node.scrollLeft+8+"px",this.note_node.style.top=r.top+o.top-this.scroll_reference_node.scrollTop-i.height/5-2+"px",this.note_node.style.opacity="1",this.note_node.style.pointerEvents="auto"}AnnotationLayoutOrder(e,t){var s;let i=-1;for(let t=0;t<this.model.active_sheet.annotations.length;t++)if(this.model.active_sheet.annotations[t]===e){i=t;break}if(i<0)return!1;const r=Math.min(Math.max(0,i+t),this.model.active_sheet.annotations.length-1);if(r===i)return!1;this.model.active_sheet.annotations.splice(i,1),this.model.active_sheet.annotations.splice(r,0,e);for(let e=0;e<this.model.active_sheet.annotations.length;e++){const t=this.model.active_sheet.annotations[e].key,i=null===(s=this.container)||void 0===s?void 0:s.querySelectorAll(`.annotation[data-key="${t}"]`);if(i)for(let t=0;t<(null==i?void 0:i.length);t++)i[t].style.zIndex=(e+1).toString()}return!0}PointToAnnotationCorner(e){const t=this.PointToAddress_Grid(e,void 0,!1),s=this.CellAddressToRectangle(t);return{address:t,offset:{x:(e.x-s.left)/s.width,y:(e.y-s.top)/s.height}}}RectToAnnotationLayout(e){return{tl:this.PointToAnnotationCorner({x:(e.left||0)+1,y:(e.top||0)+1}),br:this.PointToAnnotationCorner({x:e.right||e.left||100,y:e.bottom||e.top||100})}}AddressToAnnotationLayout(e,t){const s={tl:this.CellAddressToRectangle(e),br:this.CellAddressToRectangle(t)};return{tl:this.PointToAnnotationCorner({x:s.tl.left||0,y:s.tl.top||0}),br:this.PointToAnnotationCorner({x:s.br.right||s.tl.left||100,y:s.br.bottom||s.tl.left||100})}}AnnotationLayoutToRect(e){const t=this.CellAddressToRectangle(e.tl.address),s=this.CellAddressToRectangle(e.br.address),i=t.left+t.width*e.tl.offset.x-1,r=t.top+t.height*e.tl.offset.y-1;return new p(i,r,s.left+s.width*e.br.offset.x-i,s.top+s.height*e.br.offset.y-r)}UpdateAnnotation(e){Array.isArray(e)||(e=[e]);for(const t of e)if(t.node){if(t.node.dataset.scale=this.scale.toString(),t.node.style.fontSize=10*this.scale+"pt",t.rect&&!t.layout&&(t.scaled_rect=t.rect.Scale(this.scale),t.layout=this.RectToAnnotationLayout(t.scaled_rect)),t.layout){const e=this.AnnotationLayoutToRect(t.layout);e.ApplyStyle(t.node),t.scaled_rect=e}t.node.dataset.key=t.key.toString(),(this.model.active_sheet.freeze.rows||this.model.active_sheet.freeze.columns)&&this.CloneFrozenAnnotation(t)}}GetFrozenAnnotations(e){return[this.row_header_annotations,this.column_header_annotations,this.corner_annotations].map((t=>t.querySelector(`.annotation[data-key="${e.key}"]`))).filter((e=>null!==e))}CloneFrozenAnnotations(){for(const e of this.model.active_sheet.annotations)e.node&&e.key&&this.CloneFrozenAnnotation(e)}ClearFrozenAnnotations(){var e;for(const t of[this.row_header_annotations,this.column_header_annotations,this.corner_annotations]){const s=t.querySelectorAll(".annotation");for(let t=0;t<s.length;t++)null===(e=s[t].parentElement)||void 0===e||e.removeChild(s[t])}}RemoveFrozenAnnotation(e){var t;for(const s of[this.row_header_annotations,this.column_header_annotations,this.corner_annotations]){const i=s.querySelector(`.annotation[data-key="${e.key}"]`);i&&(null===(t=i.parentElement)||void 0===t||t.removeChild(i))}}CloneFrozenAnnotation(e){var t,s;for(const i of[this.row_header_annotations,this.column_header_annotations,this.corner_annotations]){let r=i.querySelector(`.annotation[data-key="${e.key}"]`);if(r&&(null===(t=r.parentElement)||void 0===t||t.removeChild(r)),r=null===(s=e.node)||void 0===s?void 0:s.cloneNode(!0),r){const t=r.querySelector(".annotation-move-target"),s=r.querySelector(".annotation-resize-target");r.addEventListener("mousedown",(i=>{const r=e.node;requestAnimationFrame((()=>{null==r||r.focus()})),this.AnnotationMouseDown(e,e.node,i,t,s)})),i.appendChild(r)}}}RemoveAnnotation(e){var t;e.node&&(null===(t=e.node.parentElement)||void 0===t||t.removeChild(e.node)),this.RemoveFrozenAnnotation(e)}RemoveAnnotationNodes(){const e=Array.prototype.map.call(this.annotation_container.children,(e=>e));for(const t of e)this.annotation_container.removeChild(t);(this.model.active_sheet.freeze.rows||this.model.active_sheet.freeze.columns)&&this.ClearFrozenAnnotations()}AddAnnotation(e){if(!e.node)throw new Error("annotation node missing");this.annotation_container.appendChild(e.node),this.UpdateAnnotation(e)}AnnotationMouseDown(e,t,s,i,r){const o=e.scaled_rect;return o?new Promise((a=>{var n;const l={left:o.left,top:o.top,width:o.width,height:o.height},h=this.scroll_reference_node,c=h.getBoundingClientRect(),d=t.getBoundingClientRect();if(s.target!==i)if(s.target!==r)a();else{s.stopPropagation(),s.preventDefault(),t.focus();let i=0;(null===(n=e.data)||void 0===n?void 0:n.original_size)&&e.data.original_size.width&&e.data.original_size.height&&(i=e.data.original_size.width/e.data.original_size.height);const h=t.getBoundingClientRect(),c={x:h.left+s.offsetX-o.width+r.offsetLeft,y:h.top+s.offsetY-o.height+r.offsetTop};he(this.mask,"nw-resize",(s=>{const r=[t,...this.GetFrozenAnnotations(e)];if(o.height=s.offsetY-c.y,o.width=s.offsetX-c.x,s.shiftKey&&s.ctrlKey)i&&(Math.abs(o.width-l.width)<Math.abs(o.height-l.height)?o.width=i*o.height:o.height=o.width/i);else if(s.shiftKey)Math.abs(o.height-l.height)>Math.abs(o.width-l.width)?o.width=l.width:o.height=l.height;else if(s.ctrlKey){const e=this.ClampToGrid({x:o.right,y:o.bottom});o.width=e.x-o.left+1,o.height=e.y-o.top+1}for(const e of r)e.style.height=o.height+"px",e.style.width=o.width+"px"}),(()=>{e.extent=void 0,e.layout=this.RectToAnnotationLayout(o),a({type:"annotation",annotation:e,event:"resize"})}))}else{s.stopPropagation(),s.preventDefault(),t.focus();const i={x:d.left+s.offsetX-o.left,y:d.top+s.offsetY-o.top},r=[t,...this.GetFrozenAnnotations(e)],n=25,u=this.CellAddressToRectangle({row:0,column:0}).Combine(this.CellAddressToRectangle({row:this.model.active_sheet.rows-1,column:this.model.active_sheet.columns-1})).Expand(-1,-1);he(this.mask,"move",(e=>{if(e.offsetY-c.top<this.header_offset.y){const e=Math.min(n,h.scrollTop);h.scrollTop-=e,i.y+=e}else if(e.offsetY-c.top>=c.height&&h.scrollTop+c.height<u.height){const e=n;h.scrollTop+=e,i.y-=e}if(e.offsetX-c.left<this.header_offset.x){const e=Math.min(n,h.scrollLeft);h.scrollLeft-=e,i.x+=e}else if(e.offsetX-c.left>=c.width&&h.scrollLeft+c.width<u.width){const e=n;h.scrollLeft+=e,i.x-=e}if(o.top=e.offsetY-i.y,o.left=e.offsetX-i.x,e.shiftKey&&(Math.abs(o.left-l.left)<=Math.abs(o.top-l.top)?o.left=l.left:o.top=l.top),e.ctrlKey){const e=this.ClampToGrid({x:o.left,y:o.top});o.left=e.x,o.top=e.y}for(const e of r)e.style.top=o.top+"px",e.style.left=o.left+"px"}),(()=>{e.extent=void 0,e.layout=this.RectToAnnotationLayout(o),a({type:"annotation",annotation:e,event:"move"})}))}})):(console.info("missing scaled rect!"),Promise.reject())}Initialize(e,t,s,i=!0){this.mask.parentElement||e.appendChild(this.mask),this.tooltip.parentElement||e.appendChild(this.tooltip),this.dropdown_caret.parentElement||e.appendChild(this.dropdown_caret),this.dropdown_list.parentElement||e.appendChild(this.dropdown_list),this.note_node.parentElement||e.appendChild(this.note_node),this.title_node.parentElement||e.appendChild(this.title_node),this.InitializeInternal(e,t),!i&&this.scroll_reference_node&&(this.scroll_reference_node.style.overflow="hidden"),this.dropdown_callback=s,this.initialized=!0}MockSelection(){if(!this.container)return;if(this.trident)return;const e=window.getSelection();if(e){const t=document.createRange();t.selectNodeContents(this.mock_selection),e.removeAllRanges(),e.addRange(t)}}CreateTile(e,t,s,i,r,o,a,n=!0){const l=document.createElement("canvas");return l.setAttribute("class",e),l.logical_size=t,l.width=t.width*this.dpr,l.height=t.height*this.dpr,l.style.width=`${t.width}px`,l.style.height=`${t.height}px`,l.tile_position=s,l.first_cell=i,this.UpdateTileGridPosition(l),l.last_cell={row:i.row+r.rows-1,column:i.column+r.columns-1},l.pixel_start=o,l.pixel_end={x:o.x+t.width,y:o.y+t.height},l.dirty=!!n,l.needs_full_repaint=!0,a.appendChild(l),l}ApplyTheme(e){var t,s;this.row_header.style.backgroundColor=this.column_header.style.backgroundColor=this.corner.style.backgroundColor=(null===(t=e.headers)||void 0===t?void 0:t.fill)?x(e,e.headers.fill):"",this.corner.style.borderColor=e.grid_color||"";for(const t of this.grid_tiles)for(const i of t)i.style.backgroundColor=x(e,null===(s=e.grid_cell)||void 0===s?void 0:s.fill)||"#fff";this.dropdown_list.style.font=_.Font(e.grid_cell||{})}UpdateTotalSize(){this.total_height=0;const e=this.model.active_sheet.rows;for(let t=0;t<e;t++)this.total_height+=this.RowHeight(t);this.total_width=0;const t=this.model.active_sheet.columns;for(let e=0;e<t;e++)this.total_width+=this.ColumnWidth(e)}UpdateContentsSize(){const e=this.row_header_tiles.reduce(((e,t)=>e+t.logical_size.height),0),t=this.column_header_tiles.reduce(((e,t)=>e+t.logical_size.width),0);this.column_header.style.width=this.contents.style.width=`${t}px`,this.row_header.style.height=this.contents.style.height=`${e}px`}HideTooltip(){this.tooltip.style.display="none",this.tooltip_state=void 0,this.tooltip.classList.remove("arrow-up"),this.tooltip.classList.remove("arrow-left")}ShowTooltip(e={}){e.up?(this.tooltip.classList.add("arrow-up"),this.tooltip_state="up"):e.left&&(this.tooltip.classList.add("arrow-left"),this.tooltip_state="left"),this.tooltip.style.display="block",this.UpdateTooltip(e)}ShowDropdownCaret(e,t,s){let i=this.OffsetCellAddressToRectangle(e.start);e.count>1&&(i=i.Combine(this.OffsetCellAddressToRectangle(e.end))),i=i.Shift(this.header_size.width,this.header_size.height);const r=Math.round(this.scale*Math.max(8,Math.min(20,i.height)));this.dropdown_caret.style.height=`${r}px`,this.dropdown_caret.style.width=`${r}px`,this.dropdown_caret.style.left=`${i.right+1}px`,this.dropdown_caret.style.top=i.bottom-r+"px",this.dropdown_list.style.top=`${i.bottom+2}px`,this.dropdown_list.style.left=`${i.left+2}px`,this.dropdown_list.style.minWidth=`${i.width}px`,this.dropdown_list.textContent="";for(const e of t){const t=fe.CreateDiv(void 0,this.dropdown_list);s===e&&(this.dropdown_selected=t,t.classList.add("selected")),t.dropdown_value=e,t.textContent=(null==e?void 0:e.toString())||""}this.dropdown_caret.setAttribute("class","treb-dropdown-caret"),this.dropdown_caret.style.display="block",this.dropdown_caret_visible=!0}HideDropdownCaret(){this.dropdown_caret_visible&&(this.dropdown_caret.setAttribute("class","treb-dropdown-caret"),this.dropdown_caret_visible=!1,this.dropdown_caret.style.display="none")}GetScrollOffset(){return{x:this.scroll_reference_node.scrollLeft+this.header_offset.x,y:this.scroll_reference_node.scrollTop+this.header_offset.y}}ScrollTo(e,t=!0,s=!0,i=!1){const r=this.CellAddressToRectangle(e);if(i&&this.scroll_reference_node.scrollTo){const e={left:this.scroll_reference_node.scrollLeft,top:this.scroll_reference_node.scrollTop},i={left:t?r.left:e.left,top:s?r.top:e.top,behavior:"smooth"};this.scroll_reference_node.scrollTo(i)}else s&&(this.scroll_reference_node.scrollTop=r.top),t&&(this.scroll_reference_node.scrollLeft=r.left)}ScrollIntoView(e){const t=this.CellAddressToRectangle(e),s=this.scroll_reference_node.clientWidth-this.row_header.offsetWidth,i=this.scroll_reference_node.clientHeight-this.column_header.offsetHeight,r={x:0,y:0},o={x:!1,y:!1},a=new p(this.scroll_reference_node.scrollLeft,this.scroll_reference_node.scrollTop,s,i);(this.model.active_sheet.freeze.rows||this.model.active_sheet.freeze.columns)&&(this.model.active_sheet.freeze.rows&&e.row>=this.model.active_sheet.freeze.rows?r.y=this.frozen_row_tiles[0].logical_size.height:this.model.active_sheet.freeze.rows&&(o.y=!0),this.model.active_sheet.freeze.columns&&e.column>=this.model.active_sheet.freeze.columns?r.x=this.frozen_column_tiles[0].logical_size.width:this.model.active_sheet.freeze.columns&&(o.x=!0)),e.row!==1/0&&(t.top<a.top+r.y&&!o.y?this.scroll_reference_node.scrollTop=t.top-r.y:t.bottom>a.bottom&&(this.scroll_reference_node.scrollTop=t.bottom-i)),e.column!==1/0&&(t.left<a.left+r.x&&!o.x?this.scroll_reference_node.scrollLeft=t.left-r.x:t.right>a.right&&(this.scroll_reference_node.scrollLeft=t.right-s))}UpdateTooltip(e={}){if(void 0!==e.text&&(this.tooltip.textContent=e.text),void 0!==e.x){let t=e.x||0;"up"===this.tooltip_state&&(t-=this.tooltip.offsetWidth/2),this.tooltip.style.left=Math.round(t)+"px"}if(void 0!==e.y){let t=e.y||0;"left"===this.tooltip_state&&(t-=this.tooltip.offsetHeight/2),this.tooltip.style.top=Math.round(t)+"px"}}CoordinateToRowHeader(e){const t={column:1/0,row:0};if(this.model.active_sheet.freeze.rows&&this.frozen_row_tiles[0].pixel_end.y>=e-this.scroll_reference_node.scrollTop){let s=0;e-=this.scroll_reference_node.scrollTop;for(let i=0;i<this.model.active_sheet.freeze.rows;i++)if(s+=this.RowHeight(i),s>=e)return t.row=i,t}for(const s of this.row_header_tiles)if(s.pixel_end.y>=e){let i=e-s.pixel_start.y,r=0;for(t.row=s.first_cell.row;t.row<=s.last_cell.row;t.row++,i-=r)if(r=this.RowHeight(t.row),r>i)return t;return t}return t}CoordinateToColumnHeader(e){const t={row:1/0,column:0};if(this.model.active_sheet.freeze.columns&&this.frozen_column_tiles[0].pixel_end.x>=e-this.scroll_reference_node.scrollLeft){let s=0;e-=this.scroll_reference_node.scrollLeft;for(let i=0;i<this.model.active_sheet.freeze.columns;i++)if(s+=this.ColumnWidth(i),s>=e)return t.column=i,t}for(const s of this.column_header_tiles)if(s.pixel_end.x>=e){let i=e-s.pixel_start.x,r=0;for(t.column=s.first_cell.column;t.column<=s.last_cell.column;t.column++,i-=r)if(r=this.ColumnWidth(t.column),r>i)return t;return t}return t}PointToAddress_Grid(e,t=!1,s=!0){if(s){if(this.model.active_sheet.freeze.rows){const t=this.frozen_row_tiles[0].logical_size.height;e.y-this.scroll_reference_node.scrollTop<t&&(e.y-=this.scroll_reference_node.scrollTop)}if(this.model.active_sheet.freeze.columns){const t=this.frozen_column_tiles[0].logical_size.width;e.x-this.scroll_reference_node.scrollLeft<t&&(e.x-=this.scroll_reference_node.scrollLeft)}}const i={row:0,column:0};for(const t of this.grid_tiles)if(t[0].pixel_start.x<=e.x&&t[0].pixel_end.x>=e.x){for(const s of t)if(s.pixel_start.y<=e.y&&s.pixel_end.y>=e.y){let t=e.x-s.pixel_start.x,r=e.y-s.pixel_start.y,o=0,a=0;for(i.row=s.first_cell.row,i.column=s.first_cell.column;i.column<=s.last_cell.column;i.column++,t-=o)if(o=this.ColumnWidth(i.column),o>t){for(;i.row<=s.last_cell.row;i.row++,r-=a)if(a=this.RowHeight(i.row),a>r)return i;return i}}return i}return i}AdjacentTile(e,t=0,s=0){if(!t&&!s)return e;const i=e.tile_position,r=e.tile_position.row+t,o=e.tile_position.column+s;return r<0||o<0?void 0:this.grid_tiles[i.column]&&this.grid_tiles[i.column][i.row]===e&&this.grid_tiles[o]?this.grid_tiles[o][r]:i.column||this.frozen_column_tiles[i.row]!==e?i.row||this.frozen_row_tiles[i.column]!==e?void 0:this.frozen_row_tiles[o]:this.frozen_column_tiles[r]}UpdateTiles(){if(!this.container)throw new Error("invalid container");this.grid_tiles.forEach((e=>{e.forEach((e=>{e.parentElement&&e.parentElement.removeChild(e)}))}));for(const e of[this.column_header_tiles,this.row_header_tiles,this.frozen_row_tiles,this.frozen_column_tiles])for(const t of e)t.parentElement&&t.parentElement.removeChild(t);this.frozen_row_tiles=[],this.frozen_column_tiles=[],this.row_header_tiles=[],this.column_header_tiles=[],this.grid_tiles=[];const e=this.model.active_sheet;this.default_row_height=Math.round(e.default_row_height*this.scale),this.default_column_width=Math.round(e.default_column_width*this.scale),this.header_offset={x:Math.round(e.header_offset.x*this.scale),y:Math.round(e.header_offset.y*this.scale)},this.UpdateContainingGrid();let t=this.model.active_sheet.rows,s=this.model.active_sheet.columns;t||(t=100),s||(s=40);let i=0,r=0;for(let e=0;e<t;e++)i+=this.RowHeight(e);for(let e=0;e<s;e++)r+=this.ColumnWidth(e);if(!r||!i)throw"unexpected missing total size";if(i||(i=this.default_row_height*t),r||(r=this.default_column_width*s),this.container.offsetWidth>r){const e=Math.ceil((this.container.offsetWidth-r)/this.default_column_width);r+=e*this.default_column_width,s+=e}if(this.last_column=s,this.container.offsetHeight>i){const e=Math.ceil((this.container.offsetHeight-i)/this.default_row_height);i+=e*this.default_row_height,t+=e}this.column_header.style.width=this.contents.style.width=`${r}px`,this.row_header.style.height=this.contents.style.height=`${i}px`;const o=[],a=[];let n=0,l=0;for(let e=0;e<s;e++){const t=this.ColumnWidth(e);n&&n+t>this.default_tile_size.width&&(o.push(n),a.push(l),l=e,n=0),n+=t}o.push(n),a.push(l);const h=[],c=[];let d=0,u=0;for(let e=0;e<t;e++){const t=this.RowHeight(e);d&&d+t>this.default_tile_size.height&&(h.push(d),c.push(u),d=0,u=e),d+=t}h.push(d),c.push(u);const m=o.length,f=h.length;let p=0,_=0,g=0,y=0;for(let e=0;e<this.model.active_sheet.freeze.rows;e++)g+=this.RowHeight(e);for(let e=0;e<this.model.active_sheet.freeze.columns;e++)y+=this.ColumnWidth(e);for(let e=0;e<m;e++){const i=[];p=0;const r=e===m-1?s-a[e]:a[e+1]-a[e];this.column_header_tiles.push(this.CreateTile("column-header-tile",{height:this.header_offset.y,width:o[e]},{row:0,column:e},{row:0,column:a[e]},{rows:0,columns:r},{x:_,y:0},this.column_header)),this.model.active_sheet.freeze.rows&&this.frozen_row_tiles.push(this.CreateTile("frozen-row-tile",{height:g,width:o[e]},{row:1,column:e},{row:0,column:a[e]},{rows:0,columns:r},{x:_,y:0},this.column_header));for(let s=0;s<f;s++){const n=s===f-1?t-c[s]:c[s+1]-c[s];e||(this.row_header_tiles.push(this.CreateTile("row-header-tile",{height:h[s],width:this.header_offset.x},{row:s,column:0},{row:c[s],column:0},{rows:n,columns:1},{x:0,y:p},this.row_header)),this.model.active_sheet.freeze.columns&&this.frozen_column_tiles.push(this.CreateTile("frozen-column-tile",{height:h[s],width:y},{row:s,column:1},{row:c[s],column:0},{rows:n,columns:1},{x:0,y:p},this.row_header))),i.push(this.CreateTile("grid-tile",{height:h[s],width:o[e]},{row:s,column:e},{row:c[s],column:a[e]},{rows:n,columns:r},{x:_,y:p},this.contents)),p+=h[s]}this.grid_tiles.push(i),_+=o[e]}this.total_height=i,this.total_width=r,this.ClearLayoutCaches(),this.UpdateGridTemplates(!0,!0)}ClearLayoutCaches(){this.row_cache=[],this.column_cache=[]}TileIndexForColumn(e){for(const t of this.column_header_tiles)if(t.first_cell.column<=e&&t.last_cell.column>=e)return t.tile_position.column;return-1}TileIndexForRow(e){for(const t of this.row_header_tiles)if(t.first_cell.row<=e&&t.last_cell.row>=e)return t.tile_position.row;return-1}DirtyHeaders(e){if(e){for(const t of this.column_header_tiles){if(t.dirty)continue;const s=new r({row:e.start.row,column:t.first_cell.column},{row:e.start.row,column:t.last_cell.column});(e.entire_row||s.Intersects(e))&&(t.dirty=!0)}for(const t of this.row_header_tiles){if(t.dirty)continue;const s=new r({column:e.start.column,row:t.first_cell.row},{column:e.start.column,row:t.last_cell.row});(e.entire_column||s.Intersects(e))&&(t.dirty=!0)}}}DirtyAll(){for(const e of this.grid_tiles)for(const t of e)t.dirty=!0}DirtyArea(e){if(!this.initialized)return;const t={row:0,column:0},s={row:this.grid_tiles[0].length-1,column:this.grid_tiles.length-1};e.start.column!==1/0&&(t.column=s.column=this.TileIndexForColumn(e.start.column),e.end.column!==e.start.column&&(s.column=this.TileIndexForColumn(e.end.column))),e.start.row!==1/0&&(t.row=s.row=this.TileIndexForRow(e.start.row),e.end.row!==e.start.row&&(s.row=this.TileIndexForRow(e.end.row)));for(let e=t.column;e<=s.column;e++)for(let i=t.row;i<=s.row;i++)this.grid_tiles[e][i].dirty=!0}VisibleTiles(){const e=[{row:0,column:0},{row:0,column:0}];if(!this.container||!this.grid_tiles.length||!this.grid_tiles[0].length)return new r(e[0],e[1]);const t=this.scroll_reference_node.scrollLeft,s=t+this.scroll_reference_node.offsetWidth,i=this.scroll_reference_node.scrollTop,o=i+this.scroll_reference_node.offsetHeight;for(const a of this.grid_tiles){let n=a[0];if(n.pixel_start.x<=t&&n.pixel_end.x>=t)for(n of a)if(n.pixel_start.y<=i&&n.pixel_end.y>=i){e[0]=n.tile_position;break}if(a===this.grid_tiles[this.grid_tiles.length-1]||n.pixel_start.x<=s&&n.pixel_end.x>=s)for(n of a)if(n===a[a.length-1]||n.pixel_start.y<=o&&n.pixel_end.y>=o)return e[1]=n.tile_position,new r(e[0],e[1])}return new r(e[0],e[1])}UpdateTileHeights(e=!0,t=-1){let s=0;for(let i=0;i<this.row_header_tiles.length;i++){const r=this.row_header_tiles[i];if(t>r.last_cell.row){s+=r.logical_size.height;continue}let o=0;for(let e=r.first_cell.row;e<=r.last_cell.row;e++)o+=this.RowHeight(e);const a=r.logical_size.height===o;if(r.pixel_start.y=s,s+=o,r.pixel_end.y=s,!a){if(r.logical_size.height=o,r.style.height=`${o}px`,r.height=this.dpr*o,this.model.active_sheet.freeze.columns){const e=this.frozen_column_tiles[i];e.logical_size.height=o,e.style.height=`${o}px`,e.height=this.dpr*o}e&&(r.dirty=!0,r.needs_full_repaint=!0)}for(const t of this.grid_tiles){const s=t[i];s.pixel_start.y=r.pixel_start.y,s.pixel_end.y=r.pixel_end.y,a||(s.logical_size.height=o,s.style.height=`${o}px`,s.height=this.dpr*o,e&&(s.dirty=!0,s.needs_full_repaint=!0))}}if(this.model.active_sheet.freeze.rows){let e=0;for(let t=0;t<this.model.active_sheet.freeze.rows;t++)e+=this.RowHeight(t);for(const t of this.frozen_row_tiles)t.style.height=`${e}px`,t.height=e*this.dpr;e+=this.header_offset.y,this.corner_canvas.style.height=`${e}px`,this.corner_canvas.height=e*this.dpr;for(const e of this.grid_tiles)e[0].dirty=!0}this.UpdateGridTemplates(!1,!0),this.row_header.style.height=this.contents.style.height=`${s}px`,this.ClearLayoutCaches()}UpdateTileWidths(e=!0,t=-1){let s=0;for(let i=0;i<this.column_header_tiles.length;i++){const r=this.column_header_tiles[i],o=this.grid_tiles[i];if(t>r.last_cell.column){s+=r.logical_size.width;continue}let a=0;for(let e=r.first_cell.column;e<=r.last_cell.column;e++)a+=this.ColumnWidth(e);const n=r.logical_size.width===a;if(r.pixel_start.x=s,s+=a,r.pixel_end.x=s,!n){if(r.logical_size.width=a,r.style.width=`${a}px`,r.width=this.dpr*a,this.model.active_sheet.freeze.rows){const e=this.frozen_row_tiles[i];e.logical_size.width=a,e.style.width=`${a}px`,e.width=this.dpr*a}e&&(r.dirty=!0,r.needs_full_repaint=!0)}for(const t of o)t.pixel_start.x=r.pixel_start.x,t.pixel_end.x=r.pixel_end.x,n||(t.logical_size.width=a,t.style.width=`${a}px`,t.width=this.dpr*a,e&&(t.dirty=!0,t.needs_full_repaint=!0))}if(this.model.active_sheet.freeze.columns){let e=0;for(let t=0;t<this.model.active_sheet.freeze.columns;t++)e+=this.ColumnWidth(t);for(const t of this.frozen_column_tiles)t.style.width=`${e}px`,t.width=e*this.dpr;e+=this.header_offset.x,this.corner_canvas.style.width=`${e}px`,this.corner_canvas.width=e*this.dpr;for(const e of this.grid_tiles[0])e.dirty=!0}this.UpdateGridTemplates(!0,!1),this.column_header.style.width=this.contents.style.width=`${s}px`,this.ClearLayoutCaches()}ClampToGrid(e){const t=this.PointToAddress_Grid(e),s=this.OffsetCellAddressToRectangle(t);return e.x>s.left+s.width/2?e.x=s.left+s.width-1:e.x=s.left-1,e.y>s.top+s.height/2?e.y=s.top+s.height-1:e.y=s.top-1,e}OffsetCellAddressToRectangle(e){let t=this.CellAddressToRectangle(e);return e.column>=0&&e.column<this.model.active_sheet.freeze.columns&&(t=t.Shift(this.scroll_reference_node.scrollLeft,0)),e.row>=0&&e.row<this.model.active_sheet.freeze.rows&&(t=t.Shift(0,this.scroll_reference_node.scrollTop)),t}CellAddressToRectangle(e){const t=e.row===1/0||e.row<0?0:e.row,s=e.column===1/0||e.column<0?0:e.column;if(this.column_cache.length<=s+1){this.column_cache.length||(this.column_cache[0]=0);for(let e=this.column_cache.length-1;e<=s;e++)this.column_cache[e+1]=this.column_cache[e]+this.ColumnWidth(e)}if(this.row_cache.length<=t+1){this.row_cache.length||(this.row_cache[0]=0);for(let e=this.row_cache.length-1;e<=t;e++)this.row_cache[e+1]=this.row_cache[e]+this.RowHeight(e)}const i=this.column_cache[s],r=this.row_cache[t];return new p(i,r,this.column_cache[s+1]-i,this.row_cache[t+1]-r)}ResizeTileWidth(e,t,s=!0){let i=this.column_header_tiles[e];const r=t-i.logical_size.width;i.logical_size.width=t,i.style.width=`${t}px`,i.width=this.dpr*t,i.pixel_end.x+=r,s&&(i.dirty=!0,i.needs_full_repaint=!0);for(let t=e+1;t<this.column_header_tiles.length;t++){this.column_header_tiles[t].pixel_start.x+=r,this.column_header_tiles[t].pixel_end.x+=r;for(const e of this.grid_tiles[t])e.pixel_start.x+=r,e.pixel_end.x+=r}const o=this.grid_tiles[e];for(i of o)i.logical_size.width=t,i.style.width=`${t}px`,i.width=this.dpr*t,i.pixel_end.x+=r,s&&(i.dirty=!0,i.needs_full_repaint=!0);this.UpdateTotalSize(),this.UpdateGridTemplates(!0,!1),this.UpdateContentsSize()}ResizeTileHeight(e,t,s=!0){let i=this.row_header_tiles[e];const r=t-i.logical_size.height;i.logical_size.height=t,i.style.height=`${t}px`,i.height=this.dpr*t,i.pixel_end.y+=r,s&&(i.dirty=!0,i.needs_full_repaint=!0);for(let t=e+1;t<this.row_header_tiles.length;t++)i=this.row_header_tiles[t],i.pixel_start.y+=r,i.pixel_end.y+=r;for(const o of this.grid_tiles){i=o[e],i.logical_size.height=t,i.style.height=`${t}px`,i.height=this.dpr*t,i.pixel_end.y+=r,s&&(i.dirty=!0,i.needs_full_repaint=!0);for(let t=e+1;t<o.length;t++)o[t].pixel_start.y+=r,o[t].pixel_end.y+=r}this.UpdateTotalSize(),this.UpdateGridTemplates(!1,!0),this.UpdateContentsSize()}}{constructor(e){super(e),this.column_header=fe.CreateDiv("top-header"),this.row_header=fe.CreateDiv("left-header"),this.corner=fe.CreateDiv("corner"),this.corner_canvas=document.createElement("canvas"),this.corner.appendChild(this.corner_canvas),this.contents=fe.CreateDiv("contents"),this.grid_selection=document.createElementNS(_e,"svg"),this.grid_selection.classList.add("grid-selection"),this.contents.appendChild(this.grid_selection),this.row_header_selection=document.createElementNS(_e,"svg"),this.row_header_selection.classList.add("frozen-selection"),this.row_header_selection.classList.add("frozen-selection-rows"),this.column_header.appendChild(this.row_header_selection),this.row_header_annotations=fe.CreateDiv("frozen-annotation-container frozen-annotation-container-rows",this.column_header),this.column_header_selection=document.createElementNS(_e,"svg"),this.column_header_selection.classList.add("frozen-selection"),this.column_header_selection.classList.add("frozen-selection-columns"),this.row_header.appendChild(this.column_header_selection),this.column_header_annotations=fe.CreateDiv("frozen-annotation-container frozen-annotation-container-columns",this.row_header),this.corner_selection=document.createElementNS(_e,"svg"),this.corner_selection.classList.add("frozen-selection"),this.corner.appendChild(this.corner_selection),this.corner_annotations=fe.CreateDiv("frozen-annotation-container frozen-annotation-container-corner",this.corner),this.annotation_container=fe.CreateDiv("annotation-container"),this.grid_cover=fe.CreateDiv("tile-cover grid-cover"),this.column_header_cover=fe.CreateDiv("tile-cover column-header-cover"),this.row_header_cover=fe.CreateDiv("tile-cover row-header-cover")}InitializeInternal(e,t){this.container=e,this.container.classList.add("grid-layout"),this.scroll_reference_node=this.container,e.appendChild(this.column_header),e.appendChild(this.row_header),e.appendChild(this.corner),e.appendChild(this.contents),e.appendChild(this.annotation_container),e.appendChild(this.grid_cover),e.appendChild(this.column_header_cover),e.appendChild(this.row_header_cover),e.appendChild(this.mock_selection),this.container.addEventListener("scroll",(()=>t()))}ResizeCursor(e){switch(e){case"row":this.row_header_cover.classList.add("resize");break;case"column":this.column_header_cover.classList.add("resize");break;default:this.row_header_cover.classList.remove("resize"),this.column_header_cover.classList.remove("resize")}}UpdateTileGridPosition(e){e.style.gridColumn=`${e.tile_position.column+1} / ${e.tile_position.column+2}`,e.style.gridRow=`${e.tile_position.row+1} / ${e.tile_position.row+2}`}UpdateContainingGrid(){if(!this.container)throw new Error("missing container");this.header_size.width=this.header_offset.x,this.header_size.height=this.header_offset.y;let e=this.header_offset.x,t=this.header_offset.y;if(this.model.active_sheet.freeze.columns)for(let t=0;t<this.model.active_sheet.freeze.columns;t++)e+=this.ColumnWidth(t);if(this.model.active_sheet.freeze.rows)for(let e=0;e<this.model.active_sheet.freeze.rows;e++)t+=this.RowHeight(e);this.container.style.gridTemplateColumns=`${this.header_offset.x}px auto`,this.container.style.gridTemplateRows=`${this.header_offset.y}px auto`,this.corner_canvas.setAttribute("width",""+this.dpr*e),this.corner_canvas.setAttribute("height",""+this.dpr*t),this.column_header.style.height=`${t}px`,this.corner_canvas.style.width=`${e}px`,this.corner_canvas.style.height=`${t}px`}UpdateGridTemplates(e=!0,t=!0){let s=0,i=0;this.column_header.style.gridTemplateColumns=this.contents.style.gridTemplateColumns=this.column_header_tiles.map((e=>(s+=e.logical_size.width,`${e.logical_size.width}px`))).join(" "),this.column_header.style.gridTemplateRows=`${this.header_offset.y}px auto`,this.row_header.style.gridTemplateRows=this.contents.style.gridTemplateRows=this.row_header_tiles.map((e=>(i+=e.logical_size.height,`${e.logical_size.height}px`))).join(" ");let r=this.header_offset.y;if(this.model.active_sheet.freeze.rows)for(let e=0;e<this.model.active_sheet.freeze.rows;e++)r+=this.RowHeight(e);this.column_header.style.height=`${r}px`,this.row_header_selection.style.display="block",this.row_header_selection.style.width=`${s}px`,this.corner_selection.style.height=this.row_header_selection.style.height=`${r}px`,this.corner_selection.style.top=this.row_header_selection.style.top="0px",this.row_header_selection.style.left="0px";let o=this.header_offset.x;if(this.model.active_sheet.freeze.columns)for(let e=0;e<this.model.active_sheet.freeze.columns;e++)o+=this.ColumnWidth(e);this.column_header_selection.style.display="block",this.corner_selection.style.width=this.column_header_selection.style.width=`${o}px`,this.column_header_selection.style.height=`${i}px`,this.column_header_selection.style.top="0px",this.corner_selection.style.left=this.column_header_selection.style.left="0px";const a=this.model.active_sheet.header_offset.x*this.scale,n=this.model.active_sheet.header_offset.y*this.scale,l=this.model.active_sheet.freeze;l.rows&&l.columns?(this.row_header_annotations.style.display="block",this.column_header_annotations.style.display="block",this.corner_annotations.style.display="block"):l.rows?(this.row_header_annotations.style.display="block",this.column_header_annotations.style.display="none",this.corner_annotations.style.display="none"):l.columns?(this.row_header_annotations.style.display="none",this.column_header_annotations.style.display="block",this.corner_annotations.style.display="none"):(this.row_header_annotations.style.display="none",this.column_header_annotations.style.display="none",this.corner_annotations.style.display="none"),this.row_header_annotations.style.width=`${s}px`,this.corner_annotations.style.height=this.row_header_annotations.style.height=r-n+"px",this.corner_annotations.style.top=this.row_header_annotations.style.top=`${n}px`,this.column_header_annotations.style.width=this.corner_annotations.style.width=o-a+"px",this.column_header_annotations.style.height=`${i}px`,this.corner_annotations.style.left=this.column_header_annotations.style.left=`${a}px`,this.corner_selection.style.display="block",this.grid_selection.style.width=`${s}px`,this.grid_selection.style.height=`${i}px`,this.grid_selection.style.top=`${this.header_offset.y}px`,this.grid_selection.style.left=`${this.header_offset.x}px`,this.annotation_container.style.width=`${s}px`,this.annotation_container.style.height=`${i}px`,this.annotation_container.style.top=`${this.header_offset.y}px`,this.annotation_container.style.left=`${this.header_offset.x}px`}}var ye;!function(e){e[e.Function=0]="Function",e[e.Token=1]="Token"}(ye||(ye={}));class ve{constructor(){this.function_names=[],this.function_map={},this.argument_separator=f.argument_separator.charCodeAt(0)}RemoveFunctions(e){Array.isArray(e)||(e=[e]);let t=Object.keys(this.function_map).map((e=>this.function_map[e]));for(const s of e)t=t.filter((e=>e.name!==s.name));this.SetFunctions(t)}AddFunctions(e){Array.isArray(e)||(e=[e]);const t=Object.keys(this.function_map).map((e=>this.function_map[e])).concat(...e);this.SetFunctions(t)}SetFunctions(e){this.function_map={},this.function_names=e.map((e=>(this.function_map[e.name.toLowerCase()]=e,e.name))).sort(((e,t)=>e.toLowerCase().localeCompare(t.toLowerCase())))}NormalizeIdentifier(e){const t=this.function_map[e.toLowerCase()];return t?t.name:void 0}Exec(e){if("="!==e.text[0])return{};let t,s={};if(e.cursor===e.text.length&&(t=e.text.match(/(?:^|[^A-Za-z_\d])([A-Za-z_][\w\d_.]*)\s*$/),t)){const i=t[1],r=new RegExp("^"+i.replace(".","\\."),"i");s={completions:this.function_names.filter((e=>r.test(e))).map((e=>this.function_map[e.toLowerCase()])),token:i,position:e.cursor-i.length}}const i=this.ParseTooltip(e.text.substr(0,e.cursor));if(i.function){const e=this.function_map[i.function.toLowerCase()];e&&(s.tooltip='<span class="notranslate">'+e.name+"</span>",s.arguments="("+(e.arguments||[]).map(((e,t)=>{const s=e.name||"argument";return t===i.argument?`<span class="active-argument">${s}</span>`:s})).join(f.argument_separator+" ")+")",s.description=e.description?`<span class="function-description">${e.description}</span>`:"",s.function_position=i.position||0)}return s}ParseTooltip(e){var t;const s=[];let i=0,r="",o=!1,a=0;for(const n of e){const e=n.charCodeAt(0);if(o)34===e&&(o=!1);else switch(e){case 40:s.push({buffer:r.trim(),argument:i,position:a-r.length}),r="",i=0;break;case this.argument_separator:i++;break;case 41:i=(null===(t=s.pop())||void 0===t?void 0:t.argument)||0;break;case 34:r="",o=!0;break;default:e>=97&&e<=122||e>=65&&e<=90||e>=48&&e<=57||95===e||46===e?r+=n:r=""}a++}const n=s.pop();return{function:(null==n?void 0:n.buffer)||void 0,position:(null==n?void 0:n.position)||0,argument:i}}}const be="undefined"==typeof navigator?{is_edge:!1,is_ipad:!1,is_android:!1,is_firefox:!1,is_safari:!1,is_mac:!1,is_chrome:!1,trident:!1,is_windows:!1,is_modern:!0,is_node:!0,is_mobile:!1}:new class{constructor(){this.is_edge=/Edge/.test(navigator.appVersion),this.is_ipad=/iPad|iPhone/.test(navigator.userAgent),this.is_android=/android|samsung/i.test(navigator.userAgent),this.is_mobile=this.is_ipad||this.is_android,this.is_firefox=/firefox/i.test(navigator.userAgent),this.is_safari=/safari/i.test(navigator.userAgent),this.is_mac=/macintosh/i.test(navigator.userAgent),this.is_chrome=/Chrome/i.test(navigator.userAgent),this.trident="undefined"!=typeof navigator&&navigator.userAgent&&/trident/i.test(navigator.userAgent),this.is_windows=/win64|win32|windows\s+nt/i.test(navigator.userAgent),this.is_modern=!this.is_edge&&!(this.is_firefox&&this.is_android)&&/webkit|firefox/i.test(navigator.userAgent)}};class we extends U{constructor(e,t,s,i){super(),this.parser=e,this.theme=t,this.model=s,this.autocomplete=i,this.selecting_=!1,this.trident="undefined"!=typeof navigator&&navigator.userAgent&&/trident/i.test(navigator.userAgent),this.last_parse_string="",this.dependency_list=[],this.reference_index_map=[],this.last_reconstructed_text="",this.enable_reconstruct=!0,this.selection_={target:{row:0,column:0},area:new r({row:0,column:0})},this.measurement_node=document.createElement("div")}get selecting(){return this.selecting_}get selection(){return this.selection_}set selection(e){if(e){const t=e.target||e.area.start;this.selection_={target:{row:t.row,column:t.column},area:new r(e.area.start,e.area.end)}}else{const e={row:0,column:0};this.selection_={target:e,area:new r(e)}}}UpdateTheme(e){}InsertReference(e,t){if(!this.editor_node)return;if(!this.editor_insert_node){const e=window.getSelection();if(e){const t=e.getRangeAt(0);this.editor_insert_node=document.createElement("span"),t.insertNode(this.editor_insert_node),e.collapseToEnd()}}if(this.editor_insert_node&&(this.editor_insert_node.innerText=e,e.length)){const e=window.getSelection();if(e){const t=document.createRange();t.selectNodeContents(this.editor_insert_node),e.removeAllRanges(),e.addRange(t),e.collapseToEnd()}}const s=this.ListDependencies();this.Publish({type:"update",text:this.editor_node.textContent||void 0,dependencies:s})}Autocomplete(e,t){if(!this.container_node)return;let s;s=(null==t?void 0:t.nodeType)===Node.ELEMENT_NODE?t.getBoundingClientRect():this.container_node.getBoundingClientRect();const i=new p(Math.round(s.left),Math.round(s.top),s.width,s.height);this.autocomplete.Show(this.AcceptAutocomplete.bind(this),e,i)}FlushReference(){this.editor_insert_node=void 0}SubstringToCaret(e){const t=window.getSelection();if(!t)throw new Error("error getting selection");if(0===t.rangeCount)return console.warn("range count is 0"),"";const s=t.getRangeAt(0),i=s.cloneRange();return i.selectNodeContents(e),i.setEnd(s.endContainer,s.endOffset),this.measurement_node.textContent="",this.measurement_node.appendChild(i.cloneContents()),this.measurement_node.textContent}UpdateSelectState(e=!1){let t=!1,s=!1;if(!this.editor_node)return;const i=this.editor_node.textContent||"";if("="===i.trim()[0]){s=!0;const e=this.SubstringToCaret(this.editor_node).trim();if(e.length){const s=e[e.length-1];we.FormulaChars.some((e=>s===e))&&(t=!0);const r=this.autocomplete_matcher;r&&F().then((()=>{const t=r.Exec({text:i,cursor:e.length}),s=this.NodeAtIndex(t.completions?t.position||0:t.function_position||0);this.Autocomplete(t,s)}))}}t!==this.selecting_?(this.selecting_=t,t||this.Reconstruct(),!e&&t||this.Publish({type:"end-selection"})):t&&e&&this.Publish({type:"end-selection"});const r=s?this.ListDependencies():void 0;this.Publish({type:"update",text:i,dependencies:r})}NodeAtIndex(e){var t,s;const i=(null===(t=this.editor_node)||void 0===t?void 0:t.childNodes)||[];for(let t=0;t<i.length;t++){const r=(null===(s=i[t].textContent)||void 0===s?void 0:s.length)||0;if(r>e)return i[t];e-=r}}Reconstruct(){if(!this.enable_reconstruct)return;if(!this.editor_node)return;if(this.ParseDependencies(),!this.reference_list)return;const e=this.editor_node.textContent||"";if("="!==e.trim()[0])return;if(this.editor_node.spellcheck=!1,this.selecting)return;if(e.trim()===this.last_reconstructed_text.trim())return;this.last_reconstructed_text=e;const t=this.SubstringToCaret(this.editor_node).length,s=document.createDocumentFragment();let i,r,o=0,a="";if(this.last_parse_result){let n=0,l="",h=0;const c=(e,r,a)=>{const n=document.createTextNode(r);if("text"===a)s.appendChild(n);else{const t=document.createElement("span");t.appendChild(n),t.dataset.position=e.toString(),t.dataset.type=a,("address"===a||"range"===a||"identifier"===a&&this.model.named_ranges.Get(r))&&t.classList.add("highlight-"+(this.reference_index_map[h++]%5+1)),s.appendChild(t)}return t>=e&&t<e+r.length&&(i=n,o=t-e),n};this.last_parse_result.expression&&this.parser.Walk(this.last_parse_result.expression,(t=>{switch(t.type){case"address":case"range":case"call":case"identifier":t.position!==n-1&&c(n,e.substring(n,t.position+1),"text"),l="call"===t.type||"identifier"===t.type?t.name:t.label,c(t.position+1,l,t.type),n=t.position+l.length+1}return"range"!==t.type})),a=e.substring(n)||"",r=c(n,a,"text")}if(!i)if(e.length===t){const e=document.createElement("span");s.appendChild(e),i=e,o=0}else i=r,o=Math.max(0,a.length-(e.length-t));if(this.editor_node.textContent="",this.editor_node.appendChild(s),i){const e=document.createRange(),t=window.getSelection();t&&(e.setStart(i,o),e.setEnd(i,o),e.collapse(!0),t.removeAllRanges(),t.addRange(e))}}ParseDependencies(){if(!this.editor_node)return;const e=this.editor_node.textContent||"";if(e!==this.last_parse_string||!this.reference_list){const t={};for(const e of this.model.sheets)t[e.name.toLowerCase()]=e.id;if(this.dependency_list=[],this.reference_index_map=[],e){const s=this.parser.Parse(e);if(this.last_parse_string=e,this.last_parse_result=s,this.reference_list=[],s.full_reference_list)for(const e of s.full_reference_list)if("address"===e.type||"range"===e.type){const s="address"===e.type?e:e.start;s.sheet_id||(s.sheet?s.sheet_id=t[s.sheet.toLowerCase()]||0:s.sheet_id=this.model.active_sheet.id),this.reference_list.push(e)}else{const t=this.model.named_ranges.Get(e.name);t&&(1===t.count?this.reference_list.push(Object.assign(Object.assign({type:"address"},t.start),{label:e.name,position:e.position,id:e.id})):this.reference_list.push({type:"range",start:Object.assign({type:"address",position:e.position,id:e.id,label:e.name},t.start),end:Object.assign({type:"address",position:e.position,label:e.name,id:e.id},t.end),label:e.name,position:e.position,id:e.id}))}if(this.reference_list){this.reference_list.sort(((e,t)=>e.position-t.position));for(const e of this.reference_list){let t;t="address"===e.type?new r({row:e.row,column:e.column,sheet_id:e.sheet_id}):new r({row:e.start.row,column:e.start.column,sheet_id:e.start.sheet_id},{row:e.end.row,column:e.end.column});const s=t.spreadsheet_label;this.dependency_list.some(((e,i)=>e.spreadsheet_label===s&&e.start.sheet_id===t.start.sheet_id&&(this.reference_index_map.push(i),!0)))||(this.reference_index_map.push(this.dependency_list.length),this.dependency_list.push(t))}}}else this.reference_list=void 0}}ListDependencies(){return this.ParseDependencies(),this.dependency_list||[]}AcceptAutocomplete(e){var t,s;if(!this.editor_node)return;let i=window.getSelection(),r=ye.Function;if(e.data&&e.data.completions)for(const s of e.data.completions)if(s.name.toLowerCase()===(null===(t=e.value)||void 0===t?void 0:t.toLowerCase())){r=s.type||ye.Function;break}if(!i)throw new Error("error getting selection");let o=i.getRangeAt(0);const a=o.cloneRange(),n=document.createElement("div");a.selectNodeContents(this.editor_node),a.setEnd(o.endContainer,o.endOffset),n.appendChild(a.cloneContents());const l=(n.textContent||"").substr(0,e.data?e.data.position:0)+e.value,h=r===ye.Token?l:l+"(";this.editor_node.textContent=h,this.autocomplete.Hide(),be.is_firefox||this.Reconstruct(),i=window.getSelection(),o=document.createRange(),(null===(s=this.editor_node)||void 0===s?void 0:s.lastChild)&&o.setStartAfter(this.editor_node.lastChild),o.collapse(!0),null==i||i.removeAllRanges(),null==i||i.addRange(o),this.selecting_=!0,e.click&&this.UpdateSelectState()}}var xe,Ce;we.FormulaChars=("$^&*(-+={[<>/~%"+f.argument_separator).split(""),function(e){e[e.not_handled=0]="not_handled",e[e.handled=1]="handled",e[e.commit=2]="commit",e[e.discard=3]="discard"}(Ce||(Ce={}));const Se="function"==typeof(null===(xe=null===document||void 0===document?void 0:document.body)||void 0===xe?void 0:xe.createTextRange);class Ae extends we{constructor(e,t,s,i,r){super(t,s,i,r),this.container=e,this._editing=!1,this.scale=1,this.edit_container=document.createElement("div"),this.edit_container.classList.add("overlay-editor-container"),this.edit_container.classList.add("notranslate"),this.edit_container.translate=!1,this.edit_node=document.createElement("div"),this.edit_node.classList.add("overlay-editor"),this.edit_node.contentEditable="true",this.edit_node.tabIndex=-1,this.edit_node.spellcheck=!0,this.edit_node.inputMode="none",this.edit_node.addEventListener("input",(()=>{this.editing&&(this.Reconstruct(),this.UpdateSelectState())})),this.edit_node.addEventListener("keyup",(e=>{if(this.editing&&!this.autocomplete.HandleKey("keyup",e).handled){if(this.selecting_)switch(e.key){case"ArrowUp":case"ArrowDown":case"ArrowLeft":case"ArrowRight":case"Shift":case"Control":return}this.FlushReference(),this.UpdateSelectState(!0)}})),this.edit_inset=document.createElement("div"),this.edit_inset.classList.add("overlay-inset"),this.edit_container.appendChild(this.edit_inset),this.edit_inset.appendChild(this.edit_node),e.appendChild(this.edit_container),this.edit_container.style.opacity="0",this.editor_node=this.edit_node,this.container_node=this.edit_container,this.ClearContents()}get editing(){return this._editing}set editing(e){this._editing!==e&&(this._editing=e,e?(this.edit_container.style.opacity="1",this.edit_container.style.pointerEvents="initial"):(this.edit_container.style.opacity="0",this.edit_container.style.pointerEvents="none",be.trident&&(this.edit_container.style.top="-200px")))}Focus(){this.edit_node!==document.activeElement&&(this.edit_container.style.top=`${this.container.scrollTop+2}px`,this.edit_container.style.left=`${this.container.scrollLeft+2}px`),this.edit_node.focus()}CloseEditor(){this.editing=!1,this.ClearContents(),this.edit_node.spellcheck=!0,this.autocomplete.Hide(),this.active_cell=void 0}ClearContents(){be.is_firefox?this.edit_node.innerHTML="<span></span>":this.edit_node.textContent=""}Edit(e,t,s,i,r){this.Publish({type:"start-editing",editor:"ice"}),this.active_cell=s;const o=s.style||{};switch(this.edit_node.style.font=_.Font(o,this.scale),this.edit_node.style.color=C(this.theme,o.text,1),this.edit_inset.style.backgroundColor=x(this.theme,o.fill),o.horizontal_align){case _.HorizontalAlign.Right:this.edit_inset.classList.add("align-right"),this.edit_inset.classList.remove("align-center"),this.edit_inset.classList.remove("align-left");break;case _.HorizontalAlign.Center:this.edit_inset.classList.remove("align-right"),this.edit_inset.classList.add("align-center"),this.edit_inset.classList.remove("align-left");break;default:this.edit_inset.classList.remove("align-right"),this.edit_inset.classList.remove("align-center"),this.edit_inset.classList.add("align-left")}this.edit_node.style.paddingBottom=`${Math.max(0,(self.devicePixelRatio||1)-1)}px`;const a=(null==i?void 0:i.toString())||"";if(a&&"="===a[0]&&(this.edit_node.spellcheck=!1),this.autocomplete.ResetBlock(),this.FlushReference(),this.selection=e,void 0!==i){const e="="!==a[0]&&"%"===a[a.length-1],t=a.length;if(this.edit_node.textContent=a,Se)F().then((()=>{const s=document.body.createTextRange();s.moveToElementText(this.editor_node),e?t>1&&(s.moveStart("character",t),s.move("character",-1),s.select()):(s.moveStart("character",t),s.select())}));else{const s=document.createRange(),i=window.getSelection();if(!i)throw new Error("invalid selection object");this.edit_node.lastChild&&(e?(s.setStart(this.edit_node.lastChild,t-1),s.setEnd(this.edit_node.lastChild,t-1)):s.setStartAfter(this.edit_node.lastChild)),s.collapse(!0),i.removeAllRanges(),i.addRange(s)}if(!r){const e=this.ListDependencies();this.Publish({type:"update",text:i.toString(),dependencies:e})}}t.ApplyStyle(this.edit_container),this.editing=!0,F().then((()=>{this.last_reconstructed_text="",this.Reconstruct()}))}HandleKeyDown(e){if(!this.editing)return Ce.not_handled;const t=this.autocomplete.HandleKey("keydown",e);if(t.accept&&this.AcceptAutocomplete(t),t.handled)return Ce.handled;switch(e.key){case"Enter":case"Tab":return this.selecting_=!1,Ce.commit;case"Escape":case"Esc":return this.selecting_=!1,Ce.discard;case"ArrowUp":case"ArrowDown":case"ArrowLeft":case"ArrowRight":case"Up":case"Down":case"Left":case"Right":return this.selecting_?Ce.not_handled:Ce.handled}return Ce.handled}UpdateTheme(e){this.scale=e}}const Me=new class{constructor(){this.cache={},this.base_size_px=10,this.canvas=document.createElement("canvas")}GetFirstIndex(e){for(let t=3,s=e.length;t<s;t+=4)if(e[t]>0)return(t-3)/4;return e.length}GetLastIndex(e){for(let t=e.length-1;t>=3;t-=4)if(e[t]>0)return t/4;return 0}Flush(){this.cache={}}Get(e){let t=this.cache[e];return t||(t=this.Measure(e),this.cache[e]=t,t)}Measure(e){const t=e.match(/([\d.]+)((?:%|em))/);if(t){const s=t[1]+t[2];let i=Number(t[1])*this.base_size_px;"%"===t[2]&&(i/=100),e=e.replace(s,i+"px")}let s=this.canvas.getContext("2d");if(!s)throw new Error("invalid context");s.font=e;const i=s.measureText("MMM"),r=Math.ceil(i.width);if(this.canvas.setAttribute("width",r.toString()),this.canvas.setAttribute("height",r.toString()),s=this.canvas.getContext("2d"),!s)throw new Error("invalid context");s.font=e,s.textAlign="center",s.textBaseline="alphabetic",s.fillStyle="#000";const o=Math.round(2*r/3),a=Math.round(r/2);s.clearRect(0,0,r,r);for(let e=32;e<=126;e++){const t=String.fromCharCode(e);s.fillText(t,a,o)}const n=s.getImageData(0,0,this.canvas.width,this.canvas.height).data,l=Math.floor(this.GetFirstIndex(n)/r),h=Math.floor(this.GetLastIndex(n)/r);return{ascender:o-l,descender:h-o,block:h-l+1,paren:s.measureText("(").width,hash:s.measureText("##").width-s.measureText("#").width}}},ke="bottom",Re=/webkit/i.test((null===navigator||void 0===navigator?void 0:navigator.userAgent)||"")?1:0;class Le{constructor(e,t,s,i){var r;this.theme=e,this.layout=t,this.model=s,this.options=i,this.cell_edge_buffer=4,this.overflow_areas=[],this.buffer_canvas_size={width:256,height:256},this.buffer_canvas=document.createElement("canvas"),this.buffer_canvas.width=this.buffer_canvas_size.width,this.buffer_canvas.height=this.buffer_canvas_size.height;const o=this.buffer_canvas.getContext("2d",{alpha:!1});if(o){const e=this.layout.dpr;this.buffer_context=o,this.buffer_context.setTransform(e,0,0,e,0,0),this.buffer_context.textAlign="left",this.buffer_context.textBaseline=ke}(null===(r=this.theme.grid_cell)||void 0===r?void 0:r.font_size_value)&&("px"===this.theme.grid_cell.font_size_unit?Me.base_size_px=this.theme.grid_cell.font_size_value:"pt"===this.theme.grid_cell.font_size_unit&&(Me.base_size_px=4*this.theme.grid_cell.font_size_value/3))}UpdateTheme(){var e;(null===(e=this.theme.grid_cell)||void 0===e?void 0:e.font_size_value)&&("px"===this.theme.grid_cell.font_size_unit?Me.base_size_px=this.theme.grid_cell.font_size_value:"pt"===this.theme.grid_cell.font_size_unit&&(Me.base_size_px=4*this.theme.grid_cell.font_size_value/3)),Me.Flush()}EnsureBuffer(e=0,t=0,s=0){const i=this.layout.dpr;if(t*=i,s*=i,(e*=i)>this.buffer_canvas_size.width||t>this.buffer_canvas_size.height){this.buffer_canvas_size.width=Math.max(256*Math.ceil(e/256),this.buffer_canvas_size.width),this.buffer_canvas_size.height=Math.max(256*Math.ceil(t/256),this.buffer_canvas_size.height),this.buffer_canvas.width=this.buffer_canvas_size.width,this.buffer_canvas.height=this.buffer_canvas_size.height;const s=this.buffer_canvas.getContext("2d",{alpha:!1});s&&(this.buffer_context=s,this.buffer_context.textAlign="left",this.buffer_context.textBaseline=ke)}this.buffer_context.setTransform(i,0,0,i,s,0)}OverflowDirty(e=!1){const t=[];for(const s of this.overflow_areas){const i=s.area.start.row;let r=e;if(!r)for(let e=s.area.start.column;!r&&e<=s.area.end.column;e++){const t=this.model.active_sheet.cells.GetCell({row:i,column:e},!1);r=!(!t||!t.render_dirty)}if(r){for(let e=s.area.start.column;e<=s.area.end.column;e++){const t=this.model.active_sheet.cells.GetCell({row:i,column:e},!1);t&&(t.render_dirty=!0,t.renderer_data&&t.renderer_data.overflowed&&(t.renderer_data=void 0))}s.tile.dirty=!0}else t.push(s)}this.overflow_areas=t}RenderCorner(){var e,t,s,i;const o=this.layout.corner_canvas.getContext("2d",{alpha:!1});if(!o)throw new Error("invalid context");const a=Me.Get(_.Font(this.theme.headers||{},this.layout.scale)),n=this.layout.dpr,l=this.layout.header_offset;let h=l.x;for(let e=0;e<this.model.active_sheet.freeze.columns;e++)h+=this.layout.ColumnWidth(e);let c=l.y;for(let e=0;e<this.model.active_sheet.freeze.rows;e++)c+=this.layout.RowHeight(e);if(o.setTransform(n,0,0,n,0,0),o.fillStyle=(null===(e=this.theme.headers)||void 0===e?void 0:e.fill)?x(this.theme,this.theme.headers.fill):"",o.fillRect(0,0,h,l.y),o.fillRect(0,0,l.x,c),o.strokeStyle=this.theme.grid_color||"",o.beginPath(),o.moveTo(l.x-.5,0),o.lineTo(l.x-.5,c),o.moveTo(0,l.y-.5),o.lineTo(h,l.y-.5),o.stroke(),this.model.active_sheet.freeze.columns||this.model.active_sheet.freeze.rows){if(o.textAlign="center",o.textBaseline="middle",o.font=_.Font(this.theme.headers||{},this.layout.scale),o.fillStyle=x(this.theme,null===(t=this.theme.headers)||void 0===t?void 0:t.text),this.model.active_sheet.freeze.rows&&this.layout.header_offset.x>1){o.setTransform(n,0,0,n,0,0),o.translate(0,l.y),o.beginPath(),o.moveTo(0,-.5),o.lineTo(l.x,-.5);let e=0;for(;e<this.model.active_sheet.freeze.rows;e++){const t=this.layout.RowHeight(e);o.fillStyle=x(this.theme,null===(s=this.theme.headers)||void 0===s?void 0:s.text),t>=1.2*a.block&&o.fillText(`${e+1}`,l.x/2,t/2),o.moveTo(0,t-.5),o.lineTo(l.x,t-.5),o.translate(0,t)}o.strokeStyle=this.theme.grid_color||"",o.stroke()}if(this.model.active_sheet.freeze.columns&&this.layout.header_offset.y>1){o.strokeStyle=this.theme.grid_color||"",o.setTransform(n,0,0,n,0,0),o.translate(l.x,0),o.beginPath(),o.moveTo(-.5,0),o.lineTo(-.5,l.y);let e=0;for(;e<this.model.active_sheet.freeze.columns;e++){const t=this.layout.ColumnWidth(e),s=r.ColumnToLabel(e);t>o.measureText(s).width&&(o.fillStyle=x(this.theme,null===(i=this.theme.headers)||void 0===i?void 0:i.text),o.fillText(s,t/2,l.y/2)),o.moveTo(t-.5,0),o.lineTo(t-.5,l.y),o.translate(t,0)}o.stroke()}}}RenderHeaders(e,t=!1){var s,i,o,a,n,l;const h=this.layout.dpr,c=this.layout.header_offset,d=Me.Get(_.Font(this.theme.headers||{},this.layout.scale));for(let a=e.start.column;a<=e.end.column;a++){const e=this.layout.column_header_tiles[a],n=e.getContext("2d",{alpha:!1});if(n&&(n.setTransform(h,0,0,h,0,0),e.dirty||t)){n.fillStyle=(null===(s=this.theme.headers)||void 0===s?void 0:s.fill)?x(this.theme,this.theme.headers.fill):"",n.fillRect(0,0,e.logical_size.width,this.layout.header_offset.y),n.textAlign="center",n.textBaseline="middle",n.font=_.Font(this.theme.headers||{},this.layout.scale),n.fillStyle=x(this.theme,null===(i=this.theme.headers)||void 0===i?void 0:i.text),n.strokeStyle=this.theme.grid_color||"",n.beginPath(),n.moveTo(0,c.y-.5),n.lineTo(e.logical_size.width,c.y-.5);let t=e.first_cell.column;for(;t<=e.last_cell.column;t++){const e=this.layout.ColumnWidth(t),s=r.ColumnToLabel(t);e>n.measureText(s).width&&(n.fillStyle=x(this.theme,null===(o=this.theme.headers)||void 0===o?void 0:o.text),n.fillText(s,e/2,c.y/2)),n.moveTo(e-.5,0),n.lineTo(e-.5,c.y),n.translate(e,0)}n.stroke(),e.dirty=!1}}for(let s=e.start.row;s<=e.end.row;s++){const e=this.layout.row_header_tiles[s];if(e.dirty||t){const t=e.getContext("2d",{alpha:!1});if(!t)continue;t.fillStyle=(null===(a=this.theme.headers)||void 0===a?void 0:a.fill)?x(this.theme,this.theme.headers.fill):"",t.setTransform(h,0,0,h,0,0),t.fillRect(0,0,this.layout.header_offset.x,e.logical_size.height),t.textAlign="center",t.textBaseline="middle",t.font=_.Font(this.theme.headers||{},this.layout.scale),t.fillStyle=x(this.theme,null===(n=this.theme.headers)||void 0===n?void 0:n.text),t.strokeStyle=this.theme.grid_color||"",t.beginPath(),t.moveTo(c.x-.5,0),t.lineTo(c.x-.5,e.logical_size.height);let s=e.first_cell.row;for(;s<=e.last_cell.row;s++){const e=this.layout.RowHeight(s);t.fillStyle=x(this.theme,null===(l=this.theme.headers)||void 0===l?void 0:l.text),e>=1.2*d.block&&t.fillText(`${s+1}`,c.x/2,e/2),t.moveTo(0,e-.5),t.lineTo(c.x,e-.5),t.translate(0,e)}t.strokeStyle=this.theme.grid_color||"",t.stroke(),e.dirty=!1}}(this.model.active_sheet.freeze.rows||this.model.active_sheet.freeze.columns)&&this.RenderCorner()}CopyToAdjacent(e,t,s,i,r,o,a){const n=this.layout.AdjacentTile(e,i,s);if(!n)return;let l=r,h=o;s>0?l=r-(e.pixel_end.x-e.pixel_start.x)*t:s<0&&(l=r+(n.pixel_end.x-n.pixel_start.x)*t),i>0&&(h=o-(e.pixel_end.y-e.pixel_start.y)*t);const c=n.getContext("2d",{alpha:!1});c&&(c.setTransform(t,0,0,t,l,h),c.drawImage(this.buffer_canvas,0,0,(a.width||0)*t,(a.height||0)*t,a.left||0,0,a.width||0,a.height||0))}Render(e){const t=e.getContext("2d",{alpha:!1});if(!t)return;t.textBaseline=ke;const s=this.layout.dpr;t.setTransform(s,0,0,s,0,0);let i=0,r=0;for(let o=e.first_cell.column;o<=e.last_cell.column;o++){const a=this.layout.ColumnWidth(o);if(a){r=0;for(let n=e.first_cell.row;n<=e.last_cell.row;n++){const l=this.layout.RowHeight(n);if(l){t.setTransform(s,0,0,s,i,r);const h=this.model.active_sheet.CellData({row:n,column:o});if(e.needs_full_repaint||h.render_dirty){const c=this.RenderCell(e,h,t,{row:n,column:o},a,l);c.tile_overflow_right&&this.CopyToAdjacent(e,s,1,0,i,r,c),c.tile_overflow_left&&this.CopyToAdjacent(e,s,-1,0,i,r,c),c.tile_overflow_bottom&&this.CopyToAdjacent(e,s,0,1,i,r,c)}}r+=l*s}i+=a*s}}if(!this.model.active_sheet.freeze.rows&&!this.model.active_sheet.freeze.columns)return;let o=0,a=0;if(e.first_cell.row<=this.model.active_sheet.freeze.rows-1)for(let t=e.first_cell.row;t<this.model.active_sheet.freeze.rows&&t<=e.last_cell.row;t++)o+=this.layout.RowHeight(t);if(e.first_cell.column<=this.model.active_sheet.freeze.columns-1)for(let t=e.first_cell.column;t<this.model.active_sheet.freeze.columns&&t<=e.last_cell.column;t++)a+=this.layout.ColumnWidth(t);if(o){const t=this.layout.frozen_row_tiles[e.tile_position.column];if(!t)throw new Error("can't find matching header tile");const i=t.getContext("2d",{alpha:!0});if(!i)throw new Error("header context failed");i.setTransform(s,0,0,s,0,0),i.drawImage(e,0,0,e.logical_size.width*s,o*s,0,0,e.logical_size.width,o)}if(a){const t=this.layout.frozen_column_tiles[e.tile_position.row];if(!t)throw new Error("can't find matching header tile");const i=t.getContext("2d",{alpha:!0});if(!i)throw new Error("header context failed");i.setTransform(s,0,0,s,0,0),i.drawImage(e,0,0,a*s,e.logical_size.height*s,0,0,a,e.logical_size.height)}if(a&&o){const t=this.layout.corner_canvas.getContext("2d",{alpha:"false"});if(!t)throw new Error("corner context failed");t.setTransform(s,0,0,s,this.layout.header_offset.x*s,this.layout.header_offset.y*s),t.drawImage(e,0,0,a*s,o*s,0,0,a,o)}}PrepText(e,t,s,i){const r=[],o=s.style||{};let n,l,h=0,c=s.editing?"":s.formatted;if(Array.isArray(c)){for(const t of c){if(t.flag===g.formatting){l=t.text;continue}const s=e.measureText(t.text).width,i={width:s,text:t.text,hidden:t.flag===g.hidden};r.push(i),t.flag===g.padded?n=i:h+=s}if(n){const e=n.text,t=n.width,s=i-h-2*this.cell_edge_buffer;if(n.width=Math.max(0,s),s>0){const r=Math.floor(s/t);for(let t=1;t<r;t++)n.text+=e;h=i-2*this.cell_edge_buffer}else n.text=""}return{strings:[r],format:l,width:h}}if(c){let r;s.type===a.string&&"'"===c[0]&&(c=c.slice(1)),this.options.markdown?r=P.instance.Parse(c):(r=P.instance.Dummy(c),e.font=t.base);let n=0;const l=i-2*this.cell_edge_buffer,h=[];if(o.wrap)for(const s of r){for(let e=1;e<s.length;e++){const t=s[e].text.match(/^(\s+)/);t&&(s[e-1].text+=t[1],s[e].text=s[e].text.replace(/^\s+/,""))}let i=[];for(const r of s){this.options.markdown&&(r.strong&&r.emphasis?e.font=t.strong_emphasis:r.strong?e.font=t.strong:r.emphasis?e.font=t.emphasis:e.font=t.base);const s=r.text.match(/\S+\s*/g);if(s&&s.length)for(const t of s){const s=e.measureText(t.trim()).width,o=e.measureText(t).width;i.push({part:r,text:t,trimmed:s,width:o})}}for(;i.length;){let e=i.shift();const t=[e];let s=e.trimmed;for(;s<l&&i.length;){const r=i[0],o=s-e.trimmed+e.width+r.trimmed;if(o>=l)break;e=r,t.push(r),s=o,i.shift()}e.text=e.text.trim(),e.width=e.trimmed,h.push(t.map((e=>Object.assign(Object.assign({},e.part),{hidden:!1,width:e.width,text:e.text}))))}}else for(const s of r){const i=[];let r=0;for(const o of s){this.options.markdown&&(o.strong&&o.emphasis?e.font=t.strong_emphasis:o.strong?e.font=t.strong:o.emphasis?e.font=t.emphasis:e.font=t.base);const s=e.measureText(o.text).width;r+=s,i.push(Object.assign(Object.assign({},o),{hidden:!1,width:s}))}n=Math.max(n,r),h.push(i)}return{strings:h,width:n}}return{strings:[[{text:"",hidden:!1,width:0}]],width:0}}ResolveColors(e){const t=Object.assign({},e);return t.text={text:C(this.theme,e.text,1)},t}RenderCellBorders(e,t,s,i=0,r=0,o=0,a=0){var n,l,h,c;const d=this.model.active_sheet.SurroundingStyle(e);let u=C(this.theme,d[8].fill);u&&(t.fillStyle=u,t.fillRect(i+0,r-1,o,1)),u=C(this.theme,d[4].fill),u&&(t.fillStyle=u,t.fillRect(i-1,r,1,a)),u=C(this.theme,s.fill),u&&(t.fillStyle=u,t.fillRect(i-1,r-1,o+1,a+1)),u=C(this.theme,d[6].fill),u&&(t.fillStyle=u,t.fillRect(i+o-1,r-1,1,a+1)),u=C(this.theme,d[2].fill),u&&(t.fillStyle=u,t.fillRect(i-1,r+a-1,o+1,1)),d[6].border_top&&!d[6].border_left&&(t.fillStyle=C(this.theme,d[6].border_top_fill,1),t.fillRect(i+o-1,r-2+d[6].border_top,1,1)),d[9].border_left&&(t.fillStyle=C(this.theme,d[9].border_left_fill,1),t.fillRect(i+o-1,r-1,1,1)),d[9].border_bottom&&(t.fillStyle=C(this.theme,d[9].border_bottom_fill,1),t.fillRect(i+o-1,r-2+d[9].border_bottom,1,1)),d[4].border_top&&!d[4].border_right&&(t.fillStyle=C(this.theme,d[4].border_right_fill,1),t.fillRect(i-1,r-2+d[4].border_top,1,1)),d[7].border_right&&(t.fillStyle=C(this.theme,d[7].border_right_fill,1),t.fillRect(i-1,r-1,1,1)),d[7].border_bottom&&(t.fillStyle=C(this.theme,d[7].border_bottom_fill,1),t.fillRect(i-1,r-2+d[7].border_bottom,1,1)),d[6].border_bottom&&!d[6].border_left&&(t.fillStyle=C(this.theme,d[6].border_bottom_fill,1),t.fillRect(i+o-1,r+a-d[6].border_bottom,1,1)),d[3].border_left&&(t.fillStyle=C(this.theme,d[3].border_left_fill,1),t.fillRect(i+o-1,r+a-1,1,1)),d[3].border_top&&(t.fillStyle=C(this.theme,d[3].border_top_fill,1),t.fillRect(i+o-1,r+a-d[3].border_top,1,1)),d[4].border_bottom&&!d[4].border_right&&(t.fillStyle=C(this.theme,d[4].border_bottom_fill,1),t.fillRect(i-1,r+a-d[4].border_bottom,1,1)),d[1].border_right&&(t.fillStyle=C(this.theme,d[1].border_right_fill,1),t.fillRect(i-1,r+a-1,1,1)),d[1].border_top&&(t.fillStyle=C(this.theme,d[1].border_top_fill,1),t.fillRect(i-1,r+a-d[1].border_top,1,1)),d[8].border_bottom&&(t.fillStyle=C(this.theme,d[8].border_bottom_fill,1),2===d[8].border_bottom?(t.fillRect(i-1,r-2,o+1,1),t.fillRect(i-1,r-0,o+1,1),t.fillStyle=C(this.theme,d[8].fill)||x(this.theme,null===(n=this.theme.grid_cell)||void 0===n?void 0:n.fill)||"#fff",t.fillRect(i-1,r-1,o+1,1)):t.fillRect(i-1,r-1,o+1,1)),d[4].border_right&&(t.fillStyle=C(this.theme,d[4].border_right_fill,1),t.fillRect(i-1,r-1,1,a+1)),d[6].border_left&&(t.fillStyle=C(this.theme,d[4].border_left_fill,1),t.fillRect(i+o-1,r-1,1,a+1)),d[2].border_top&&(t.fillStyle=C(this.theme,d[2].border_top_fill,1),2===d[2].border_top?(t.fillRect(i-1,r+a-2,o+1,1),t.fillRect(i-1,r+a-0,o+1,1),t.fillStyle=C(this.theme,d[2].fill)||x(this.theme,null===(l=this.theme.grid_cell)||void 0===l?void 0:l.fill)||"#fff",t.fillRect(i-1,r+a-1,o+1,1)):t.fillRect(i-1,r+a-1,o+1,1)),s.border_top&&(t.fillStyle=C(this.theme,s.border_top_fill,1),2===s.border_top?(t.fillRect(i-1,r-2,o+1,1),t.fillRect(i-1,r+0,o+1,1),t.fillStyle=C(this.theme,s.fill)||x(this.theme,null===(h=this.theme.grid_cell)||void 0===h?void 0:h.fill)||"#fff",t.fillRect(i-1,r-1,o+1,1)):t.fillRect(i-1,r-1,o+1,1)),s.border_left&&(t.fillStyle=C(this.theme,s.border_left_fill,1),t.fillRect(i-1,r-1,1,a+1)),s.border_right&&(t.fillStyle=C(this.theme,s.border_right_fill,1),t.fillRect(i+o-1,r-1,1,a+1)),s.border_bottom&&(t.fillStyle=C(this.theme,s.border_bottom_fill,1),2===s.border_bottom?(t.fillRect(i-1,r+a-2,o+1,1),t.fillRect(i-1,r+a+0,o+1,1),t.fillStyle=C(this.theme,s.fill)||x(this.theme,null===(c=this.theme.grid_cell)||void 0===c?void 0:c.fill)||"#fff",t.fillRect(i-1,r+a-1,o+1,1)):t.fillRect(i-1,r+a-1,o+1,1))}RenderCellBackground(e,t,s,i,r,o){var a;s.fillStyle=this.theme.grid_color,s.fillRect(0,0,r,o);const n=C(this.theme,i.fill);if(n?(s.fillStyle=n,s.fillRect(0,0,r-1,o-1)):(s.fillStyle=x(this.theme,null===(a=this.theme.grid_cell)||void 0===a?void 0:a.fill)||"#fff",s.fillRect(0,0,r-1,o-1)),e){const e=2,t=1,i=8;s.fillStyle=this.theme.note_marker_color,s.beginPath(),s.moveTo(r-e,t),s.lineTo(r-e-i,t),s.lineTo(r-e,t+i),s.lineTo(r-e,t),s.fill()}this.RenderCellBorders(t,s,i,0,0,r,o)}RenderCell(e,t,s,i,o,n){var l,h,c;const d={},u=t.render_dirty;if(t.render_dirty=!1,e.needs_full_repaint&&(null===(l=t.renderer_data)||void 0===l?void 0:l.overflowed))return{};const m=t.style?Object.assign({},t.style):{};if(t.merge_area){if(i.row!==t.merge_area.start.row||i.column!==t.merge_area.start.column)return{};for(let e=t.merge_area.start.column+1;e<=t.merge_area.end.column;e++)o+=this.layout.ColumnWidth(e);for(let e=t.merge_area.start.row+1;e<=t.merge_area.end.row;e++)n+=this.layout.RowHeight(e);if(t.merge_area.count>1){const e=this.model.active_sheet.CellStyleData(t.merge_area.end);e&&(m.border_bottom=e.border_bottom,m.border_right=e.border_right,m.border_bottom_fill=e.border_bottom_fill,m.border_right_fill=e.border_right_fill)}t.merge_area.end.column>e.last_cell.column&&(d.tile_overflow_right=!0),t.merge_area.end.row>e.last_cell.row&&(d.tile_overflow_bottom=!0),(d.tile_overflow_bottom||d.tile_overflow_right)&&this.overflow_areas.push({tile:e,head:Object.assign({},i),area:new r(t.merge_area.start,t.merge_area.end)})}const f=!!t.hyperlink;if(t.render_function){this.RenderCellBackground(!!t.note,i,s,m,o,n),s.strokeStyle=s.fillStyle=C(this.theme,m.text,1);const e=this.ResolveColors(m);if(t.render_function.call(void 0,{width:o,height:n,context:s,cell:t,style:e,scale:this.layout.scale||1}).handled)return d}if(!t.formatted)return this.RenderCellBackground(!!t.note,i,d.tile_overflow_bottom||d.tile_overflow_right?this.buffer_context:s,m,o,n),d;const g={base:_.Font(m,this.layout.scale),strong:_.Font(Object.assign(Object.assign({},m),{font_bold:!0}),this.layout.scale),emphasis:_.Font(Object.assign(Object.assign({},m),{font_italic:!0}),this.layout.scale),strong_emphasis:_.Font(Object.assign(Object.assign({},m),{font_bold:!0,font_italic:!0}),this.layout.scale)};s.font=g.base,!u&&t.renderer_data&&t.renderer_data.width===o&&t.renderer_data.height===n||(t.renderer_data={text_data:this.PrepText(s,g,t,o),width:o,height:n});const y=t.renderer_data.text_data,v=y.width>o-2*this.cell_edge_buffer;let b=o,w=0,S=!1;const A=t.type===a.number||t.calculated_type===a.number||t.type===a.complex||t.calculated_type===a.complex;let M=m.horizontal_align;M===_.HorizontalAlign.None&&(M=A?_.HorizontalAlign.Right:_.HorizontalAlign.Left);const k=[];if(v)if(t.type===a.number||t.calculated_type===a.number||m.wrap||t.merge_area)S=!A;else{const t=y.width-o+this.cell_edge_buffer;let s=0,a=0;M===_.HorizontalAlign.Center?s=a=t/2:M===_.HorizontalAlign.Right?s=t:a=t;let l=i.column,h=i.column;for(;a>0&&l<this.layout.last_column;){l++;const e={row:i.row,column:l},t=this.model.active_sheet.CellData(e),s=this.layout.ColumnWidth(l);if(a-=s,!t||t.type||t.calculated_type){S=!0;break}k.push({address:e,cell:t,grid:new p(b,0,s,n),background:new p(b-1,0,s,n-1),border:new p(b,0,s,n)}),b+=s,t.render_dirty=!1,t.renderer_data={overflowed:!0}}for(l>e.last_cell.column&&(d.tile_overflow_right=!0);s>0&&h>=1;){h--;const e={row:i.row,column:h},t=this.model.active_sheet.CellData(e),r=this.layout.ColumnWidth(h);if(s-=r,!t||t.type||t.calculated_type){S=!0;break}w-=r,k.push({address:e,cell:t,grid:new p(w,0,r,n),background:new p(w,0,r,n-1),border:new p(w,0,r,n)})}h<e.first_cell.column&&(d.tile_overflow_left=!0),this.overflow_areas.push({head:Object.assign({},i),tile:e,area:new r({row:i.row,column:h},{row:i.row,column:l})})}let R=!1;const L=s;(d.tile_overflow_bottom||d.tile_overflow_left||d.tile_overflow_right)&&(R=!0,d.width=b-w,d.height=n,d.left=w,this.EnsureBuffer(d.width+1,n+1,-w),(s=this.buffer_context).font=g.base),this.RenderCellBackground(!!t.note,i,s,m,o,n);for(const e of k)(null===(h=e.cell.style)||void 0===h?void 0:h.fill)&&(e.cell.style.fill.text||e.cell.style.fill.theme||0===e.cell.style.fill.theme)&&!this.options.grid_over_background?(s.fillStyle=x(this.theme,e.cell.style.fill),s.fillRect(e.grid.left,e.grid.top,e.grid.width,e.grid.height)):(s.fillStyle=this.theme.grid_color||"",s.fillRect(e.grid.left,e.grid.top,e.grid.width,e.grid.height),s.fillStyle=(null===(c=this.theme.grid_cell)||void 0===c?void 0:c.fill)?x(this.theme,this.theme.grid_cell.fill):"",s.fillRect(e.background.left,e.background.top,e.background.width,e.background.height)),e.cell.style&&this.RenderCellBorders(e.address,s,e.cell.style,e.border.left,e.border.top,e.border.width,e.border.height);const E=Me.Get(g.base);s.lineWidth=1,s.strokeStyle=s.fillStyle=y.format?y.format:C(this.theme,m.text,1),s.beginPath();let T=this.cell_edge_buffer;const D=1.3,z=y.strings.length,N=z*E.block*D;S=(S||N>=n)&&!R,S&&(s.save(),s.beginPath(),s.moveTo(w+1.5,0),s.lineTo(w+1.5,n),s.lineTo(b-1.5,n),s.lineTo(b-1.5,0),s.clip()),s.beginPath();let P=Math.round(n-2-E.block*D*(z-1)+Re);switch(m.vertical_align){case _.VerticalAlign.Top:P=Math.round(E.block*D)+1;break;case _.VerticalAlign.Middle:P=Math.round((n-N)/2+E.block*D)}if(t.type!==a.number&&t.calculated_type!==a.number&&t.type!==a.complex&&t.calculated_type!==a.complex||!v){let e=P,t=0;for(const i of y.strings){let r=0;for(const e of i)r+=e.width;M===_.HorizontalAlign.Center?T=Math.round((o-r)/2):M===_.HorizontalAlign.Right&&(T=o-this.cell_edge_buffer-r);const a=Math.floor(e+1.5-E.descender-Re)+.5,n=Math.floor(e-E.descender-E.ascender/2)+.5;let l=T;for(const t of i)t.strong&&t.emphasis?s.font=g.strong_emphasis:t.strong?s.font=g.strong:t.emphasis?s.font=g.emphasis:s.font=g.base,t.hidden||(s.fillText(t.text,l,e),m.font_underline&&(s.moveTo(l,a),s.lineTo(l+t.width,a)),m.font_strike&&(s.moveTo(l,n),s.lineTo(l+t.width,n)),f&&(t.left=l,t.top=e-E.block,t.height=E.block)),l+=t.width;t++,e=Math.round(P+t*E.block*D)}}else{const e=Math.floor((o-2*this.cell_edge_buffer)/E.hash);let t="";for(let s=0;s<e;s++)t+="#";const i=s.measureText(t).width;M===_.HorizontalAlign.Center?T=Math.round((o-i)/2):M===_.HorizontalAlign.Right&&(T=o-this.cell_edge_buffer-i),s.fillText(t,T,P)}if(s.stroke(),S)s.restore();else if(R){const e=this.layout.dpr;L.drawImage(this.buffer_canvas,0,0,(d.width||0)*e,n*e,w,0,d.width||0,n)}return d}}class Ee extends we{constructor(e,t,s,i,r,o){super(t,s,i,o),this.container=e,this.options=r,this.focused_=!1,this.lines=1,this.last_formula="",this.label_update_timer=0;const a=fe.CreateDiv("treb-formula-bar-container notranslate",e),n=fe.CreateDiv("treb-formula-bar",a);this.address_label_container=fe.CreateDiv("address-label",n),this.address_label=fe.CreateDiv("",this.address_label_container),this.InitAddressLabel(),this.options.insert_function_button&&(this.button=fe.Create("button","formula-button",n),this.button.addEventListener("click",(()=>{const e=this.editor_node&&this.editor_node.textContent||"";this.Publish({type:"formula-button",formula:e})}))),this.container_node=fe.CreateDiv("editor-container",n),this.editor_node=fe.CreateDiv("formula-editor",this.container_node),this.editor_node.setAttribute("contenteditable","true"),this.editor_node.spellcheck=!1,this.editor_node.addEventListener("focusin",(()=>{if(!this.editor_node)return;let e=this.editor_node.textContent||"";"{"===e[0]&&"}"===e[e.length-1]&&(e=e.substr(1,e.length-2),this.editor_node.textContent=e,this.last_reconstructed_text=""),this.editor_node.spellcheck="="!==e[0],this.autocomplete.ResetBlock(),F().then((()=>{this.Reconstruct()}));const t=this.ListDependencies();this.Publish([{type:"start-editing",editor:"formula-bar"},{type:"update",text:e,cell:this.active_cell,dependencies:t},{type:"retain-focus",focus:!0}]),this.focused_=!0})),this.editor_node.addEventListener("focusout",(()=>{this.autocomplete.Hide(),this.Publish([{type:"stop-editing"},{type:"retain-focus",focus:!1}]),this.focused_=!1,this.editor_node&&(this.editor_node.spellcheck=!1)})),this.editor_node.addEventListener("keydown",(e=>this.FormulaKeyDown(e))),this.editor_node.addEventListener("keyup",(e=>this.FormulaKeyUp(e))),this.editor_node.addEventListener("input",(()=>{this.Reconstruct(),this.UpdateSelectState()})),this.options.expand_formula_button&&(this.expand_button=fe.Create("button","expand-button",n),this.expand_button.addEventListener("click",(e=>{e.stopPropagation(),e.preventDefault(),this.editor_node&&(this.editor_node.scrollTop=0),n.classList.toggle("expanded")})))}get focused(){return this.focused_}set formula(e){this.editor_node&&(this.editor_node.textContent=e,this.last_reconstructed_text=""),this.last_formula=e}get formula(){return this.editor_node&&this.editor_node.textContent||""}set label(e){e.trim().length?(this.address_label.textContent=e,this.label_update_timer||(this.label_update_timer=requestAnimationFrame((()=>{this.label_update_timer=0,this.address_label.scrollWidth>this.address_label.offsetWidth?this.address_label.setAttribute("title",e):this.address_label.removeAttribute("title")})))):(this.address_label.innerHTML="&nbsp;",this.address_label.removeAttribute("title"))}get label(){var e;return(null===(e=this.address_label)||void 0===e?void 0:e.textContent)||""}set editable(e){this.editor_node&&this.container_node&&(this.editor_node.setAttribute("contenteditable",e.toString()),e?this.container_node.classList.remove("locked"):this.container_node.classList.add("locked"))}IsElement(e){return e===this.editor_node}InitAddressLabel(){this.address_label.contentEditable="true",this.address_label.spellcheck=!1,this.address_label.addEventListener("focusin",(e=>{requestAnimationFrame((()=>{if(document.body.createTextRange){const e=document.body.createTextRange();e.moveToElementText(this.address_label),e.select()}else{const e=window.getSelection(),t=document.createRange();t.selectNodeContents(this.address_label),null==e||e.removeAllRanges(),null==e||e.addRange(t)}}))})),this.address_label.addEventListener("keydown",(e=>{switch(e.key){case"Enter":e.stopPropagation(),e.preventDefault(),this.Publish({type:"address-label-event",text:this.address_label.textContent||void 0});break;case"Esc":case"Escape":e.stopPropagation(),e.preventDefault(),this.Publish({type:"address-label-event"})}}))}FocusEditor(){this.editor_node&&this.editor_node.focus()}GetTextContent(e){const t=e.childNodes,s=[];for(let e=0;e<t.length;e++){const i=t[e];switch(i.nodeType){case Node.ELEMENT_NODE:s.push(...this.GetTextContent(i)),i instanceof Element&&"DIV"===i.tagName&&s.push("\n");break;case Node.TEXT_NODE:i.nodeValue&&s.push(i.nodeValue)}}return s}FormulaKeyDown(e){const t=this.autocomplete.HandleKey("keydown",e);if(t.accept&&this.AcceptAutocomplete(t),!t.handled){switch(e.key){case"Enter":case"Tab":{this.selecting_=!1;const t="Enter"===e.key&&e.ctrlKey&&e.shiftKey,s=(this.editor_node?this.GetTextContent(this.editor_node).join(""):"").trim();this.Publish({type:"commit",selection:this.selection,value:s,event:e,array:t}),this.FlushReference()}break;case"Escape":case"Esc":this.selecting_=!1,this.Publish({type:"discard"}),this.FlushReference();break;default:return}e.stopPropagation(),e.preventDefault()}}FormulaKeyUp(e){this.autocomplete.HandleKey("keyup",e).handled||(this.FlushReference(),this.trident&&(this.UpdateSelectState(),this.Reconstruct()))}}const Te={scrollbars:!0,in_cell_editor:!0,formula_bar:!0,add_tab:!1,tab_bar:"auto",insert_function_button:!1,expand_formula_button:!1,expand:!0,repaint_on_cell_change:!0,grid_over_background:!1};var De,ze,Ne,Pe,Fe,Ie,Oe,Ue;!function(e){e.None="none",e.All="all",e.Outside="outside",e.Top="top",e.Bottom="bottom",e.Left="left",e.Right="right",e.DoubleTop="double-top",e.DoubleBottom="double-bottom"}(De||(De={}));class $e{constructor(e={}){this.options=e,this.completion_list_visible=!1,this.tooltip_visible=!1,this.selected_index=0,this.block=!1,this.autocomplete_data={},this.completion_list=fe.CreateDiv("treb-cell-editor-ac-list treb-autocomplete",e.container||document.body),this.completion_list.addEventListener("mousedown",(e=>this.ListMouseDown(e))),this.completion_list.addEventListener("mousemove",(e=>this.ListMouseMove(e))),this.tooltip=fe.CreateDiv("treb-cell-editor-ac-tooltip treb-autocomplete-tooltip",e.container||document.body)}Hide(){this.tooltip.style.top="-1000px",this.completion_list.style.top="-1000px",this.completion_list_visible=!1,this.tooltip_visible=!1,this.active_element=void 0}ResetBlock(){this.block=!1}ListMouseMove(e){const t=e.target;"A"===t.tagName&&t!==this.active_element&&this.active_element&&(this.active_element.classList.remove("selected"),this.active_element=t,this.active_element.classList.add("selected"),this.selected_index=Number(t.dataset.index||"0"),this.last_completion=t.textContent||"")}ListMouseDown(e){e.stopPropagation(),e.preventDefault();let t=e.target;for(;t;){if(t===this.completion_list)return;if("A"===t.tagName)break;t=t.parentElement}t&&(console.info(t),this.callback&&this.callback({handled:!0,accept:!0,value:t.textContent?t.textContent:void 0,data:this.autocomplete_data,click:!0}))}HandleKey(e,t){if(!this.completion_list_visible)return{handled:!1};let s=0,i=!1,r=!1;switch(t.key){case"Up":case"ArrowUp":s=-1;break;case"Down":case"ArrowDown":s=1;break;case"Tab":r=!0;break;case"Escape":case"Esc":i=!0;break;default:return{handled:!1}}if(t.stopPropagation(),t.preventDefault(),"keyup"===e)return{handled:!0};if(s){const e=this.completion_list.getBoundingClientRect();this.selected_index+=s,this.selected_index=Math.max(0,this.selected_index);const t=this.completion_list.querySelectorAll("a");this.selected_index=Math.min(this.selected_index,t.length-1);for(let s=0;s<t.length;s++){const i=t[s];if(s===this.selected_index){i.classList.add("selected"),this.active_element=i;const t=i.getBoundingClientRect();t.top<e.top?this.completion_list.scrollBy(0,-t.height):t.bottom>e.bottom&&this.completion_list.scrollBy(0,t.height),this.last_completion=i.textContent||void 0}else i.classList.remove("selected")}return{handled:!0}}return i?(this.block=!0,this.Hide(),{handled:!0}):r?{handled:!0,accept:!0,value:this.last_completion,data:this.autocomplete_data}:{handled:!1}}Show(e,t={},s){if(this.completion_list_visible=!1,this.tooltip_visible=!1,this.autocomplete_data=t,this.callback=e,!this.block)if(t.tooltip?(this.tooltip.innerHTML=t.tooltip+t.arguments+(t.description?"\n"+t.description:""),this.tooltip.style.left=s.left+"px",this.options.tooltip_prefer_top?this.tooltip.style.top=s.top-this.tooltip.offsetHeight-5+"px":this.tooltip.style.top=s.bottom+5+"px",this.tooltip_visible=!0):this.tooltip.style.top="-1000px",t.completions&&t.completions.length){this.tooltip.style.top="-1000px",this.selected_index=0,this.completion_list.innerHTML='<ul class="notranslate">'+t.completions.map(((e,t)=>(e.name===this.last_completion&&(this.selected_index=t),`<li><a data-index="${t}">${e.name}</a></li>`))).join("\n")+"<ul>";const e=this.completion_list.offsetHeight;let i=!1;this.options.autocomplete_prefer_top?i=s.top>=200:document.documentElement&&Math.max(document.documentElement.clientHeight,window.innerHeight||0)-s.bottom<200&&(i=!0),this.completion_list.style.top=i?s.top-e-5+"px":s.bottom+5+"px",this.completion_list.style.left=s.left+"px";const r=this.completion_list.querySelectorAll("a");this.active_element=r[this.selected_index],r[this.selected_index].classList.add("selected"),this.last_completion=r[this.selected_index].textContent||void 0,this.completion_list.scrollTop=this.active_element.offsetTop,this.completion_list_visible=!0}else this.completion_list.style.top="-1000px"}}!function(e){e[e.Null=0]="Null",e[e.InsertRows=1]="InsertRows",e[e.InsertColumns=2]="InsertColumns",e[e.ResizeRows=3]="ResizeRows",e[e.ResizeColumns=4]="ResizeColumns",e[e.Select=5]="Select",e[e.SetRange=6]="SetRange",e[e.UpdateStyle=7]="UpdateStyle",e[e.UpdateBorders=8]="UpdateBorders",e[e.MergeCells=9]="MergeCells",e[e.UnmergeCells=10]="UnmergeCells",e[e.Clear=11]="Clear",e[e.UpdateTheme=12]="UpdateTheme",e[e.SetNote=13]="SetNote",e[e.SetLink=14]="SetLink",e[e.Freeze=15]="Freeze",e[e.SetName=16]="SetName",e[e.ShowHeaders=17]="ShowHeaders",e[e.AddSheet=18]="AddSheet",e[e.DuplicateSheet=19]="DuplicateSheet",e[e.DeleteSheet=20]="DeleteSheet",e[e.ActivateSheet=21]="ActivateSheet",e[e.RenameSheet=22]="RenameSheet",e[e.ReorderSheet=23]="ReorderSheet",e[e.ShowSheet=24]="ShowSheet",e[e.DataValidation=25]="DataValidation"}(ze||(ze={}));class He{constructor(){this.forward={},this.backward=[]}Count(){return this.backward.length}Serialize(){return JSON.parse(JSON.stringify(this.Map()))}Deserialize(e){if(this.Reset(),e){for(const t of Object.keys(e))this.SetName(t,new r(e[t].start,e[t].end),!1);this.RebuildList()}}MatchSelection(e,t){if(!e.start.sheet_id)throw new Error("match selection without sheet id");let s;for(const i of this.List())if(i.range.start.sheet_id===e.start.sheet_id&&(i.range.Equals(e)&&(s=i.name),null==t?void 0:t.Equals(i.range)))return i.name;return s}SetName(e,t,s=!0){const i=this.ValidateNamed(e);return i?t.entire_column||t.entire_row?(console.warn("invalid range"),!1):(this.forward[i]=t,s&&this.RebuildList(),!0):(console.warn("invalid name"),!1)}SetNames(e){for(const t of Object.keys(e)){const s=e[t];this.SetName(t,new r(s.start,s.end),!1)}this.RebuildList()}ClearName(e,t=!0){delete this.forward[e],t&&this.RebuildList()}Reset(){this.forward={},this.backward=[]}Get(e){return this.forward[e.toUpperCase()]}Map(){return this.forward}List(){return this.backward}ValidateNamed(e){return!!(e=e.trim()).length&&!/^[A-Za-z]{1,3}\d+$/.test(e)&&!/[^A-Za-z\d_.]/.test(e)&&!/^[^A-Za-z_]/.test(e)&&e.toUpperCase()}PatchNamedRanges(e,t,s,i){const o=this.List().slice(0);for(const a of o){const o=a.name,n=a.range;if(t&&e<=n.end.column)if(t>0)e<=n.start.column?n.Shift(0,t):e>n.start.column&&e<=n.end.column?n.ConsumeAddress({row:n.end.row,column:n.end.column+t}):console.warn("PNR X case 1",e,t,JSON.stringify(n));else if(t<0)if(e-t<=n.start.column)n.Shift(0,t);else if(e<=n.start.column&&e-t>n.end.column)this.ClearName(o,!1);else if(e<=n.start.column){const s=e-t-1;this.SetName(o,new r({row:n.start.row,column:s+1+t},{row:n.end.row,column:n.end.column+t}),!1)}else e<=n.end.column?e-t-1>=n.end.column?this.SetName(o,new r({row:n.start.row,column:n.start.column},{row:n.end.row,column:e-1}),!1):this.SetName(o,new r({row:n.start.row,column:n.start.column},{row:n.end.row,column:n.start.column+n.columns+t-1}),!1):console.warn("PNR X case 2",e,t,JSON.stringify(n));if(i&&s<=n.end.row)if(i>0)s<=n.start.row?n.Shift(i,0):s>n.start.row&&s<=n.end.row?n.ConsumeAddress({row:n.end.row+i,column:n.end.column}):console.warn("PNR X case 3",s,i,JSON.stringify(n));else if(i<0)if(s-i<=n.start.row)n.Shift(i,0);else if(s<=n.start.row&&s-i>n.end.row)this.ClearName(o,!1);else if(s<=n.start.row){const e=s-i-1;this.SetName(o,new r({column:n.start.column,row:e+1+i},{column:n.end.column,row:n.end.row+i}),!1)}else s<=n.end.row?s-i-1>=n.end.row?this.SetName(o,new r({column:n.start.column,row:n.start.row},{column:n.end.column,row:s-1}),!1):this.SetName(o,new r({column:n.start.column,row:n.start.row},{column:n.end.column,row:n.start.row+n.rows+i-1}),!1):console.warn("PNR X case 4",s,i,JSON.stringify(n))}this.RebuildList()}RebuildList(){this.backward=[];for(const e of Object.keys(this.forward))this.backward.push({name:e,range:this.forward[e]})}}!function(e){e[e.NotEditing=0]="NotEditing",e[e.CellEditor=1]="CellEditor",e[e.FormulaBar=2]="FormulaBar"}(Ne||(Ne={}));class Ve{constructor(e={},t=w){this.grid_events=new U,this.command_log=new U,this.headless=!1,this.hover_data={},this.batch=!1,this.batch_events=[],this.editing_state=Ne.NotEditing,this.editing_cell={row:-1,column:-1,sheet_id:0},this.tile_update_pending=!1,this.parser=new z,this.decimal_separator_code=46,this.RESIZE_PIXEL_BUFFER=5,this.select_argument=!1,this.cell_resize={row:-1,column:-1},this.render_tiles=new r({row:0,column:0}),this.primary_selection={target:{row:0,column:0},area:new r({row:0,column:0}),empty:!0},this.active_selection={target:{row:0,column:0},area:new r({row:0,column:0}),empty:!0},this.nub_select_flag=!1,this.additional_selections=[],this.double_click_data={},this.layout_token=0,this.render_token=0,this.autocomplete_matcher=new ve,this.theme_style_properties=_.Composite([_.DefaultProperties]);const s=[me.Blank(this.theme_style_properties)];var i;this.model={sheets:s,active_sheet:s[0],named_ranges:new He,macro_functions:{}},this.theme=JSON.parse(JSON.stringify(t)),this.options=Object.assign(Object.assign({},Te),e),this.layout=(i=this.model,new ge(i)),e.initial_scale&&("string"==typeof e.initial_scale&&(e.initial_scale=Number(e.initial_scale)),this.layout.scale=e.initial_scale),this.tile_renderer=new Le(this.theme,this.layout,this.model,this.options),this.selection_renderer=new le(this.theme,this.layout,this.model,this.primary_selection,this.additional_selections),"."===f.decimal_separator?(this.parser.decimal_mark=M.Period,this.parser.argument_separator=A.Comma):(this.parser.decimal_mark=M.Comma,this.parser.argument_separator=A.Semicolon),this.decimal_separator_code=f.decimal_separator.charCodeAt(0)}get active_sheet(){return this.model.active_sheet}set active_sheet(e){this.model.active_sheet=e}SetNote(e,t){if(!e){if(this.primary_selection.empty)return;e=this.primary_selection.target}this.ExecCommand({key:ze.SetNote,address:e,note:t})}SetLink(e,t){if(!e){if(this.primary_selection.empty)return;e=this.primary_selection.target}this.ExecCommand({key:ze.SetLink,address:e,reference:t})}FindAnnotation(e){for(const t of this.active_sheet.annotations)if(t.node===e)return t}CreateAnnotation(e={},t=!0,s=!1,i){const r=new ue(e);if(s)if(!r.layout&&r.scaled_rect&&(r.layout=this.layout.RectToAnnotationLayout(r.scaled_rect)),r.layout){let e=this.layout.AnnotationLayoutToRect(r.layout).Shift(20,20),t=!0;for(;t;){t=!1;for(const s of this.active_sheet.annotations)if(s!==r&&s.scaled_rect&&s.scaled_rect.top===e.top&&s.scaled_rect.left===e.left){e=e.Shift(20,20),t=!0;break}}r.layout=this.layout.RectToAnnotationLayout(e)}else console.warn("can't offset annotation without layout");return i&&(p.IsRectangle(i)?(r.layout=void 0,r.rect=p.Create(i)):i.start&&(r.rect=void 0,r.layout=this.layout.AddressToAnnotationLayout(i.start,i.end||i.start))),t&&(this.active_sheet.annotations.some((e=>e===r))||this.active_sheet.annotations.push(r),this.AddAnnotation(r)),r}UpdateScale(e=1){var t,s;this.layout.scale=e,this.UpdateLayout(),this.UpdateAnnotationLayout(),this.layout.UpdateAnnotation(this.active_sheet.annotations),this.layout.ApplyTheme(this.theme),null===(t=this.overlay_editor)||void 0===t||t.UpdateTheme(e),null===(s=this.tab_bar)||void 0===s||s.UpdateScale(e),this.grid_events.Publish({type:"scale",scale:e});for(const e of this.model.sheets)for(const t of e.annotations)t.dirty=!0}UpdateAnnotationLayout(){}AddAnnotation(e,t=!1,s=!0){if(!e.node){e.node=document.createElement("div"),e.node.dataset.scale=this.layout.scale.toString(),e.node.style.fontSize=10*this.layout.scale+"pt",e.content_node=fe.CreateDiv("annotation-content",e.node);const t=fe.CreateDiv("annotation-move-target",e.node),s=fe.CreateDiv("annotation-resize-target",e.node);if(e.node){const i=e.node;i.setAttribute("tabindex","-1"),i.addEventListener("mousedown",(r=>{this.layout.AnnotationMouseDown(e,i,r,t,s).then((e=>{e&&this.grid_events.Publish(e)}))})),e.node.addEventListener("focusin",(()=>{for(const t of this.layout.GetFrozenAnnotations(e))t.classList.add("clone-focus");this.selected_annotation=e,this.primary_selection.empty=!0,this.primary_selection.target={row:-1,column:-1,sheet_id:this.active_sheet.id},this.HideGridSelection()})),e.node.addEventListener("focusout",(t=>{for(const t of this.layout.GetFrozenAnnotations(e))t.classList.remove("clone-focus");this.formula_bar&&this.formula_bar.IsElement(t.relatedTarget)?(this.primary_selection.empty=!0,this.RenderSelections(),this.editing_annotation=e,this.layout.ShowSelections(!0)):(this.selected_annotation===e&&(this.selected_annotation=void 0),this.ShowGridSelection())})),e.node.addEventListener("keydown",(t=>{const s=e.scaled_rect;if(!s)return void console.info("missing scaled rect!");const r=[i,...this.layout.GetFrozenAnnotations(e)],o={x:s.left,y:s.top};switch(t.key){case"ArrowUp":case"Up":t.ctrlKey?(this.layout.AnnotationLayoutOrder(e,1)&&this.grid_events.Publish({type:"annotation",event:"move",annotation:e}),i.focus()):o.y--;break;case"ArrowLeft":case"Left":if(t.ctrlKey)return;o.x--;break;case"ArrowRight":case"Right":if(t.ctrlKey)return;o.x++;break;case"ArrowDown":case"Down":t.ctrlKey?(this.layout.AnnotationLayoutOrder(e,-1)&&this.grid_events.Publish({type:"annotation",event:"move",annotation:e}),i.focus()):o.y++;break;case"Escape":case"Esc":this.Focus();break;case"Delete":case"Del":this.Focus(),this.RemoveAnnotation(e);break;default:return}if(t.stopPropagation(),t.preventDefault(),o.x=Math.max(o.x,0),o.y=Math.max(o.y,0),s.left!==o.x||s.top!==o.y){s.left=Math.round(o.x),s.top=Math.round(o.y);for(const e of r)e.style.top=s.top+"px",e.style.left=s.left+"px";e.extent=void 0,this.grid_events.Publish({type:"annotation",event:"move",annotation:e}),e.layout=this.layout.RectToAnnotationLayout(s)}}))}}e.node.classList.add("annotation"),s&&this.layout.AddAnnotation(e),t||this.grid_events.Publish({type:"annotation",annotation:e,event:"create"})}AnnotationUpdated(e){this.layout.CloneFrozenAnnotation(e)}RemoveAnnotation(e){for(let t=0;t<this.active_sheet.annotations.length;t++)if(e===this.active_sheet.annotations[t])return this.active_sheet.annotations.splice(t,1),this.layout.RemoveAnnotation(e),void this.grid_events.Publish({type:"annotation",annotation:e,event:"delete"})}RemoveAnnotationNodes(){this.layout.RemoveAnnotationNodes()}Serialize(e={}){this.active_sheet.selection=JSON.parse(JSON.stringify(this.primary_selection)),this.active_sheet.scroll_offset=this.layout.scroll_offset;const t=this.model.sheets.map((t=>t.toJSON(e)));let s;const i=Object.keys(this.model.macro_functions);if(i.length){s=[];for(const e of i)s.push(Object.assign(Object.assign({},this.model.macro_functions[e]),{expression:void 0}))}return{sheet_data:t,active_sheet:this.active_sheet.id,named_ranges:this.model.named_ranges.Count()?this.model.named_ranges.Serialize():void 0,macro_functions:s}}RealArea(e){return this.active_sheet.RealArea(e)}CellRenderData(e){return this.active_sheet.CellData(e)}Clear(){this.ExecCommand({key:ze.Clear})}FromCSV(e){const t=((e,t=",")=>{let s=N.default,i=[],r="";const o=[],a=e.length;if(/[\r\n"]/.test(t))throw new Error("invalid delimiter");for(let n=0;n<a;n++){const l=e[n];if(s===N.default)switch(l){case t:i.push(r),r="";break;case"\r":break;case"\n":i.push(r),r="",o.push(i),i=[];break;case'"':0===r.length?s=N.quoted:r+=l;break;default:r+=l}else'"'===l?n+1<a&&'"'===e[n+1]?(r+='"',n++):s=N.default:r+=l}return(i.length||r.length)&&(i.push(r),o.push(i)),o})(e).map((e=>e.map((e=>se.TryParse(e).value)))),s={row:Math.max(0,t.length-1),column:t.reduce(((e,t)=>Math.max(e,Math.max(0,t.length-1))),0)};this.ExecCommand([{key:ze.Clear},{key:ze.SetRange,area:{start:{row:0,column:0},end:s},value:t}])}ShowHeaders(e=!0){this.ExecCommand({key:ze.ShowHeaders,show:e})}FromImportData(e,t=!1){var s;this.RemoveAnnotationNodes();const i=e.sheets,o=i.map((()=>me.Blank(this.theme_style_properties).toJSON()));let a;if("number"==typeof e.active_tab)a=null===(s=o[e.active_tab])||void 0===s?void 0:s.id;else for(let t=0;t<e.sheets.length;t++)if(!e.sheets[t].hidden){a=o[t].id;break}this.UpdateSheets(o,!0,a);const n={};this.model.macro_functions={},this.ClearSelection(this.primary_selection);for(let e=0;e<i.length;e++){const t=this.model.sheets[e];t.ImportData(i[e]),n[t.name]=t.id}if(this.model.named_ranges.Reset(),e.names){for(const t of Object.keys(e.names)){const s=e.names[t],i=this.parser.Parse(s);if(i.expression){if("range"===i.expression.type){const e=n[i.expression.start.sheet||""];e&&(i.expression.start.sheet_id=e,this.model.named_ranges.SetName(t,new r(i.expression.start,i.expression.end),!1))}if("address"===i.expression.type){const e=n[i.expression.sheet||""];e&&(i.expression.sheet_id=e,this.model.named_ranges.SetName(t,new r(i.expression),!1))}}}this.model.named_ranges.RebuildList()}for(const e of this.active_sheet.annotations)this.AddAnnotation(e,!0);this.QueueLayoutUpdate(),this.StyleDefaultFromTheme(),t&&this.Repaint(!1,!1),this.tab_bar&&this.tab_bar.Update()}ResetMetadata(){this.model.document_name=void 0,this.model.user_data=void 0}NextSheet(e=1){if(1!==this.model.sheets.length)for(let t=0;t<this.model.sheets.length;t++)if(this.model.sheets[t]===this.active_sheet){let s=(t+e)%this.model.sheets.length;for(;s<0;)s+=this.model.sheets.length;return void this.ActivateSheet(s)}}InsertSheet(e,t){if(void 0===e&&!this.model.sheets.some(((t,s)=>t===this.active_sheet&&(e=s+1,!0))))throw new Error("invalid index");this.ExecCommand({key:ze.AddSheet,insert_index:e,name:t})}DeleteSheet(e){if(void 0===e&&!this.model.sheets.some(((t,s)=>t===this.active_sheet&&(e=s,!0))))throw new Error("invalid index");this.ExecCommand({key:ze.DeleteSheet,index:e})}DuplicateSheet(e,t,s){const i={key:ze.DuplicateSheet,new_name:t,insert_before:s};void 0===e?i.id=this.active_sheet.id:i.index=e,this.ExecCommand(i)}AddSheet(e){this.ExecCommand({key:ze.AddSheet,name:e})}ActivateSheet(e){const t="number"==typeof e?e:void 0,s="string"==typeof e?e:void 0;this.ExecCommand({key:ze.ActivateSheet,index:t,name:s})}ActivateSheetID(e){this.ExecCommand({key:ze.ActivateSheet,id:e})}ShowAll(){const e=[];for(let t=0;t<this.model.sheets.length;t++)e.push({key:ze.ShowSheet,index:t,show:!0});this.ExecCommand(e)}ShowSheet(e=0,t=!0){const s={key:ze.ShowSheet,show:t};"string"==typeof e?s.name=e:s.index=e,this.ExecCommand(s)}UpdateSheets(e,t=!1,s){this.RemoveAnnotationNodes(),me.Reset();const i=e.map((e=>me.FromJSON(e,this.theme_style_properties)));if(0===i.length&&i.push(me.Blank(this.theme_style_properties)),this.model.sheets=i,this.active_sheet=i[0],s)if("number"==typeof s){for(const e of this.model.sheets)if(s===e.id){this.active_sheet=e;break}}else if("string"==typeof s)for(const e of this.model.sheets)if(s===e.name){this.active_sheet=e;break}if(this.ClearSelection(this.primary_selection),e[0]&&e[0].primary_selection){const t=e[0].primary_selection;t.empty||this.Select(this.primary_selection,new r(t.area.start,t.area.end),t.target)}else if(!this.active_sheet.selection.empty){const e=this.active_sheet.selection;this.Select(this.primary_selection,new r(e.area.start,e.area.end),e.target)}this.ResetMetadata(),this.layout.ClearLayoutCaches();for(const e of this.model.sheets)for(const t of e.annotations)this.AddAnnotation(t,!0,e===this.active_sheet);this.QueueLayoutUpdate(),this.StyleDefaultFromTheme(),t&&this.Repaint(!1,!1),this.tab_bar&&this.tab_bar.Update()}UpdateLayout(){this.layout.UpdateTiles(),this.render_tiles=this.layout.VisibleTiles(),this.Repaint(!0)}ApplyTheme(){this.UpdateTheme(!0)}UpdateTheme(e=!1,t){var s;if(!e)for(const e of Object.keys(this.theme))delete this.theme[e];let i=JSON.parse(JSON.stringify(w));if(this.grid_container){const e=(e=>{var t,s,i;const r=JSON.parse(JSON.stringify(w)),o=(e,t)=>{const s=document.createElement("div");return s.setAttribute("class",t),e.appendChild(s),s},a=o(e,""),n=((e,t)=>window.getComputedStyle(o(e,t))).bind(0,a);let l=n("grid-cells");r.grid_cell=S(l),r.grid_color=l.stroke||"",l=n("grid-headers"),r.headers=S(l),l=n("note-marker"),r.note_marker_color=l.backgroundColor,a.style.color="rgba(1,2,3,.4)",l=n("");const h=l.color;r.theme_colors=[(null===(t=r.grid_cell.fill)||void 0===t?void 0:t.text)||"rgb(255, 255, 255)",(null===(s=r.grid_cell.text)||void 0===s?void 0:s.text)||"rgb(51, 51, 51)"];for(let e=1;e<32&&(l=n(`theme-color-${e}`),l.color&&l.color!==h);e++)r.theme_colors.push(l.color);const c=document.createElement("canvas");c.width=3,c.height=3;const d=c.getContext("2d");return d&&(r.theme_colors_rgb=r.theme_colors.map((e=>{d.fillStyle=e,d.fillRect(0,0,3,3);const t=d.getImageData(1,1,1,1);return Array.from(t.data)}))),null===(i=a.parentElement)||void 0===i||i.removeChild(a),r})(this.grid_container);i=Object.assign({},e)}i=Object.assign(Object.assign(Object.assign({},this.theme),i),t),Object.assign(this.theme,i),this.StyleDefaultFromTheme(),this.active_sheet.UpdateDefaultRowHeight(),this.active_sheet.FlushCellStyles(),this.layout.ApplyTheme(this.theme),this.tile_renderer.UpdateTheme(),e||(this.UpdateLayout(),null===(s=this.overlay_editor)||void 0===s||s.UpdateTheme(this.layout.scale),this.Repaint(!0,!0,!0))}Initialize(e,t=!1){var s;this.grid_container=e,e.classList.add("treb-main"),be.is_windows?e.classList.add("treb-ua-windows"):be.is_mac&&e.classList.add("treb-ua-osx"),e.classList.add("treb-theme"),this.ApplyTheme();const i=document.createElement("div"),r=document.createElement("div");let o;r.classList.add("treb-layout-master"),r.appendChild(i),e.appendChild(r),this.options.formula_bar&&(o||(o=new $e({theme:this.theme,container:i})),this.InitFormulaBar(e,o)),this.options.tab_bar&&(this.tab_bar=new ce(this.layout,this.model,this.options,this.theme,e),this.tab_bar.Subscribe((e=>{switch(e.type){case"cancel":break;case"scale":{let t=this.layout.scale;switch(e.action){case"increase":t+=.05;break;case"decrease":t-=.05;break;default:t=e.action}t=Math.round(100*t)/100,t=Math.min(2,Math.max(t,.5)),this.options.persist_scale_key&&localStorage.setItem(this.options.persist_scale_key,JSON.stringify({scale:t})),this.UpdateScale(t)}break;case"reorder-sheet":this.ReorderSheet(e.index,e.move_before);break;case"delete-sheet":this.DeleteSheet();break;case"add-sheet":this.AddSheet();break;case"rename-sheet":this.RenameSheet(e.sheet,e.name);break;case"activate-sheet":this.ActivateSheetID(e.sheet.id)}this.Focus()}))),this.container=i,this.container.classList.add("treb-grid"),be.is_mac&&be.is_safari&&this.container.classList.add("safari"),this.container.setAttribute("tabindex","-1"),this.layout.Initialize(i,(()=>this.OnScroll()),(e=>this.OnDropdownSelect(e)),this.options.scrollbars),this.selection_renderer.Initialize(),this.layout.UpdateTiles(),o||(o=new $e({theme:this.theme,container:i})),this.InitOverlayEditor(o),this.AttachListeners(),this.render_tiles=this.layout.VisibleTiles(),t||(null===(s=this.tab_bar)||void 0===s||s.Update(),this.Repaint(!0))}MergeSelection(){this.primary_selection.empty||(this.layout.HideDropdownCaret(),this.ExecCommand({key:ze.MergeCells,area:this.primary_selection.area}))}UnmergeSelection(){this.primary_selection.empty||(this.layout.HideDropdownCaret(),this.ExecCommand({key:ze.UnmergeCells,area:this.primary_selection.area}))}Focus(){var e,t;be.is_mobile?null===(e=this.container)||void 0===e||e.focus():null===(t=this.overlay_editor)||void 0===t||t.Focus()}SetValidation(e,t){if(!e){if(this.primary_selection.empty)throw new Error("invalid target in set validation");e=this.primary_selection.target}console.info("target",e);const s={key:ze.DataValidation,target:e};t&&(Array.isArray(t)?s.list=t:"object"==typeof t&&t.start&&t.end&&i(t.start)&&i(t.end)&&(s.range=t)),this.ExecCommand(s)}SetName(e,t){const s={key:ze.SetName,name:e};t&&(i(t)&&(t=new r(t)),t.start.sheet_id||(t=new r(Object.assign(Object.assign({},t.start),{sheet_id:this.active_sheet.id}),t.end)),s.area=new r(t.start,t.end)),this.ExecCommand(s)}GetNumberFormat(e){const t=this.active_sheet.CellStyleData(e);if(t&&t.number_format)return Q.Get(t.number_format).toString()}SelectAll(){this.Select(this.primary_selection,new r({row:1/0,column:1/0}),void 0,!0),this.RenderSelections()}SelectRange(e){this.Select(this.primary_selection,e),this.RenderSelections()}GetRange(e,t=!1,s=!1){let r=0;if(i(e)){r=e.sheet_id||this.active_sheet.id;for(const i of this.model.sheets)if(i.id===r)return t?i.cells.RawValue(e):s?i.GetFormattedRange(e):i.cells.GetRange(e)}else{r=e.start.sheet_id||this.active_sheet.id;for(const i of this.model.sheets)if(i.id===r)return t?i.cells.RawValue(e.start,e.end):s?i.GetFormattedRange(e.start,e.end):i.cells.GetRange(e.start,e.end)}}SetRange(e,t,s=!1,i=!1,r=!1){if(Array.isArray(t)){if(!((o=t)&&Array.isArray(o)&&Array.isArray(o[0])))if(s){const s=e.entire_column?this.active_sheet.rows:e.rows,i=e.entire_row?this.active_sheet.columns:e.columns,r=s*i;if(r>t.length){let e=t.slice(0);const s=Math.ceil(r/e.length);for(let i=1;i<s;i++)e=e.concat(t.slice(0));t=e}const o=[];for(let e=0,r=0;e<i;e++,r+=s)o[e]=t.slice(r,r+s);t=o}else t=[t];i&&(t=this.Transpose(t)),this.ExecCommand({key:ze.SetRange,area:e,value:t,array:r})}else s||r?this.ExecCommand({key:ze.SetRange,area:e,value:t,array:r}):this.ExecCommand({key:ze.SetRange,area:e.start,value:t,array:r});var o;!this.primary_selection.empty&&e.Contains(this.primary_selection.target)&&this.UpdateFormulaBarFormula()}SetRowHeight(e,t,s=!0){this.ExecCommand({key:ze.ResizeRows,row:e,height:t,shrink:s})}SetColumnWidth(e,t=0){this.ExecCommand({key:ze.ResizeColumns,column:e,width:t})}ApplyStyle(e,t={},s=!0){if(!e){if(this.primary_selection.empty)return;e=this.primary_selection.area}this.ExecCommand({key:ze.UpdateStyle,area:e,style:t,delta:s}),this.UpdateFormulaBarFormula()}GetSelection(){return this.primary_selection}Update(e=!1,t){this.DelayedRender(e,t)}ApplyBorders(e,t=De.None,s,i=1){if(!e){if(this.primary_selection.empty)return;e=this.primary_selection.area}t===De.None&&(i=0),this.ExecCommand({key:ze.UpdateBorders,color:{text:s},area:e,borders:t,width:i})}ApplyBorders2(e,t=De.None,s,i=1){if(!e){if(this.primary_selection.empty)return;e=this.primary_selection.area}t===De.None&&(i=0),this.ExecCommand({key:ze.UpdateBorders,color:s,area:e,borders:t,width:i})}GetFreeze(){return Object.assign({},this.active_sheet.freeze)}Freeze(e=0,t=0,s=!0){this.ExecCommand({key:ze.Freeze,rows:e,columns:t,highlight_transition:s})}Batch(e,t=!0){this.batch=!0,e(),this.batch=!1;const s=this.batch_events.slice(0);return this.batch_events=[],t&&this.DelayedRender(!1),s}DeleteColumns(){if(this.primary_selection.empty)return;const e=this.primary_selection.area;if(e.entire_row)this.Clear();else{const t=e.start.column,s=-e.columns;this.ExecCommand({key:ze.InsertColumns,before_column:t,count:s})}}DeleteRows(){if(this.primary_selection.empty)return;const e=this.primary_selection.area;if(e.entire_column)this.Clear();else{const t=e.start.row,s=-e.rows;this.ExecCommand({key:ze.InsertRows,before_row:t,count:s})}}InsertColumn(){if(this.primary_selection.empty)return;const e=this.primary_selection.area,t=e.entire_row?0:e.start.column;this.InsertColumns(t,1)}InsertColumns(e=0,t=1){this.ExecCommand({key:ze.InsertColumns,before_column:e,count:t})}ReorderSheet(e,t){this.ExecCommand({key:ze.ReorderSheet,index:e,move_before:t})}RenameSheet(e=this.active_sheet,t){this.ExecCommand({key:ze.RenameSheet,new_name:t,id:e.id})}InsertRow(){if(this.primary_selection.empty)return;const e=this.primary_selection.area,t=e.entire_column?0:e.start.row;this.InsertRows(t,1)}InsertRows(e=0,t=1){this.ExecCommand({key:ze.InsertRows,before_row:e,count:t})}SetAutocompleteFunctions(e){const t=e.slice(0).concat(this.model.named_ranges.List().map((e=>({name:e.name,type:ye.Token}))));this.autocomplete_matcher.SetFunctions(t)}ScrollTo(e,t=!0,s=!0,i=!1){this.layout.ScrollTo(e,t,s,i)}ScrollIntoView(e){this.options.scrollbars&&this.layout.ScrollIntoView(e)}GetScrollOffset(){return this.layout.GetScrollOffset()}DeleteSheetInternal(e){let t=!1,s=-1;const i=e.name?e.name.toLowerCase():"",r=this.model.sheets.filter(((r,o)=>o!==e.index&&r.id!==e.id&&r.name.toLowerCase()!==i||(t=r===this.active_sheet,s=o,!1)));if(r.length)if(r.every((e=>!e.visible)))r.unshift(me.Blank(this.theme_style_properties)),s=0;else for(s>=r.length&&(s=0);!r[s].visible;)s++;else r.push(me.Blank(this.theme_style_properties)),s=0;this.model.sheets=r,t&&this.ActivateSheetInternal({key:ze.ActivateSheet,index:s}),this.tab_bar&&this.tab_bar.Update()}AddSheetInternal(e=me.default_sheet_name,t=-1){if(!this.options.add_tab)return void console.warn("add tab option not set or false");for(;this.model.sheets.some((t=>t.name===e));){const t=e.match(/^(.*?)(\d+)$/);t?e=t[1]+(Number(t[2])+1):e+="2"}const s=me.Blank(this.theme_style_properties,e);return t>=0?this.model.sheets.splice(t,0,s):this.model.sheets.push(s),this.tab_bar&&this.tab_bar.Update(),s.id}DuplicateSheetInternal(e){if(!this.options.add_tab)return void console.warn("add tab option not set or false");const t=this.ResolveSheet(e),s=this.model.sheets.reduce(((e,t)=>Math.max(e,t.id)),0)+1;let i=-1;for(let e=0;e<this.model.sheets.length;e++)this.model.sheets[e]===t&&(i=e+1);if(!t||i<0)throw new Error("source sheet not found");if("number"==typeof e.insert_before)i=e.insert_before;else if("string"==typeof e.insert_before){const t=e.insert_before.toLowerCase();for(let e=0;e<this.model.sheets.length;e++)if(this.model.sheets[e].name.toLowerCase()===t){i=e;break}}const r=me.FromJSON(t.toJSON({rendered_values:!0}),this.theme_style_properties);let o=e.new_name||t.name;for(;this.model.sheets.some((e=>e.name===o));){const e=o.match(/^(.*?)(\d+)$/);e?o=e[1]+(Number(e[2])+1):o+="2"}return r.name=o,r.id=s,this.model.sheets.splice(i,0,r),this.tab_bar&&this.tab_bar.Update(),r.id}ActivateSheetInternal(e){const t=this.SelectingArgument(),s=this.ResolveSheet(e)||this.model.sheets[0];if(this.active_sheet===s)return;if(!s.visible)throw new Error("cannot activate hidden sheet");this.HideHoverInfo(),this.active_sheet.selection=JSON.parse(JSON.stringify(this.primary_selection)),this.active_sheet.scroll_offset=this.layout.scroll_offset;const i=this.active_sheet;this.RemoveAnnotationNodes(),this.active_sheet=s,t?this.RenderSelections():(this.ClearSelection(this.primary_selection),s.selection&&!s.selection.empty&&this.Select(this.primary_selection,new r(s.selection.area.start,s.selection.area.end),s.selection.target));const o=this.active_sheet.annotations;for(const e of o)this.AddAnnotation(e,!0);this.QueueLayoutUpdate(),this.Repaint(!1,!1),this.grid_events.Publish({type:"sheet-change",deactivate:i,activate:this.active_sheet}),this.tab_bar&&this.tab_bar.Update(),this.layout.scroll_offset=this.active_sheet.scroll_offset}ResolveSheet(e){if(void 0!==e.index)return this.model.sheets[e.index];if(void 0!==e.name){const t=e.name.toLowerCase();for(const e of this.model.sheets)if(e.name.toLowerCase()===t)return e}if(e.id)for(const t of this.model.sheets)if(t.id===e.id)return t}ShowSheetInternal(e){const t=this.ResolveSheet(e);if(t&&t.visible!==e.show){if(!e.show){let e=0;for(const s of this.model.sheets)t.visible&&s!==t||e++;if(e>=this.model.sheets.length)throw new Error("can't hide all sheets")}if(t.visible=e.show,t===this.active_sheet)for(let e=0;e<this.model.sheets.length;e++)if(this.model.sheets[e]===this.active_sheet)return void this.ActivateSheetInternal({key:ze.ActivateSheet,index:e+1});this.tab_bar&&this.tab_bar.Update()}}StyleDefaultFromTheme(){var e,t,s;this.theme_style_properties.font_face=(null===(e=this.theme.grid_cell)||void 0===e?void 0:e.font_face)||"",this.theme_style_properties.font_size_unit=(null===(t=this.theme.grid_cell)||void 0===t?void 0:t.font_size_unit)||"pt",this.theme_style_properties.font_size_value=(null===(s=this.theme.grid_cell)||void 0===s?void 0:s.font_size_value)||10}HighlightFreezeArea(){for(const e of[this.layout.corner_selection,this.layout.row_header_selection,this.layout.column_header_selection]){const t=e.getAttribute("class")||"";be.trident?e.setAttribute("class",t+" highlight-area"):e.classList.add("highlight-area"),setTimeout((()=>{be.trident?e.setAttribute("class",t):e.classList.remove("highlight-area")}),400)}}QueueLayoutUpdate(){this.tile_update_pending=!0}HandleAddressLabelEvent(e){if(e){const t=(e="")=>{const t=e.toLowerCase();for(const e of this.model.sheets)if(e.name.toLowerCase()===t)return e.id;return this.active_sheet.id},s=e=>{for(const t of this.model.sheets)if(t.id===e)return t;return this.active_sheet};let i;const o=this.parser.Parse(e);if(o.expression)switch(o.expression.type){case"address":o.expression.sheet_id=t(o.expression.sheet),i=new r(o.expression);break;case"range":o.expression.start.sheet_id=t(o.expression.start.sheet),i=new r(o.expression.start,o.expression.end);break;case"identifier":i=this.model.named_ranges.Get(o.expression.name),i||this.primary_selection.empty||this.SetName(o.expression.name.toUpperCase(),this.primary_selection.area)}if(i){const e=s(i.start.sheet_id);if(e.columns>=i.end.column&&e.rows>=i.end.row)return void this.ExecCommand({key:ze.Select,area:i});console.warn("address out of range")}}this.UpdateAddressLabel(),this.Focus()}InitFormulaBar(e,t){this.formula_bar=new Ee(e,this.parser,this.theme,this.model,this.options,t),this.formula_bar.autocomplete_matcher=this.autocomplete_matcher,this.formula_bar.Subscribe((e=>{switch(e.type){case"address-label-event":this.HandleAddressLabelEvent(e.text);break;case"stop-editing":this.editing_state=Ne.NotEditing;break;case"start-editing":this.editing_state=Ne.FormulaBar,this.editing_cell=Object.assign({},this.primary_selection.target);break;case"discard":if(this.editing_state=Ne.NotEditing,this.editing_annotation)return this.ClearAdditionalSelections(),this.ClearSelection(this.active_selection),this.editing_annotation.node&&this.editing_annotation.node.focus(),this.editing_annotation=void 0,this.UpdateFormulaBarFormula(),void this.DelayedRender();this.container&&this.Focus(),this.ClearAdditionalSelections(),this.ClearSelection(this.active_selection),this.UpdateFormulaBarFormula(),this.DelayedRender();break;case"commit":if(this.active_sheet.id!==this.editing_cell.sheet_id&&this.editing_cell.sheet_id&&this.ActivateSheetID(this.editing_cell.sheet_id),this.editing_state=Ne.NotEditing,this.editing_annotation){const t=this.editing_annotation;return this.ClearAdditionalSelections(),this.ClearSelection(this.active_selection),t.formula=e.value?this.FixFormula(e.value):"",t.node&&t.node.focus(),this.grid_events.Publish({type:"annotation",event:"update",annotation:t}),this.editing_annotation=void 0,void this.DelayedRender()}this.container&&this.Focus(),this.SetInferredType(this.primary_selection,e.value,e.array),this.ClearAdditionalSelections(),this.ClearSelection(this.active_selection),this.options.repaint_on_cell_change&&this.DelayedRender(!1,this.primary_selection.area),e.event&&this.OverlayKeyDown(e.event);break;case"update":e.dependencies&&this.HighlightDependencies(e.dependencies)}}))}InitOverlayEditor(e){this.container&&(this.overlay_editor=new Ae(this.container,this.parser,this.theme,this.model,e),this.overlay_editor.UpdateTheme(this.layout.scale),this.overlay_editor.autocomplete_matcher=this.autocomplete_matcher,this.overlay_editor.Subscribe((e=>{switch(e.type){case"stop-editing":this.editing_state=Ne.NotEditing;break;case"start-editing":this.editing_state=Ne.CellEditor,this.editing_cell=Object.assign({},this.primary_selection.target);break;case"update":e.dependencies&&this.HighlightDependencies(e.dependencies);break;case"end-selection":this.ClearSelection(this.active_selection),this.DelayedRender()}})))}DelayedRender(e=!1,t,s=!1){!this.tile_update_pending&&t?this.layout.DirtyArea(t):!this.tile_update_pending&&e&&this.layout.DirtyAll(),this.render_token||(this.render_token=1,F().then((()=>{this.render_token=0,this.Repaint(e,s)})))}Repaint(e=!1,t=!1,s=!1){if(this.headless)return;if(this.tile_update_pending&&(this.tile_update_pending=!1,this.layout.UpdateTiles(),this.render_tiles=this.layout.VisibleTiles(),this.layout.UpdateAnnotation(this.active_sheet.annotations)),this.layout_token=0,this.tile_renderer.OverflowDirty(t),e)for(const e of this.layout.grid_tiles)for(const t of e)t.dirty=!0;const i=this.render_tiles.start,r=this.render_tiles.end,o=[];for(let e=i.row;e<=r.row;e++)o.push(e);const a=[];for(let e=i.column;e<=r.column;e++)a.push(e);i.row>0&&this.active_sheet.freeze.rows&&o.push(0),i.column>0&&this.active_sheet.freeze.columns&&a.push(0);for(const t of a)for(const s of o){const i=this.layout.grid_tiles[t][s];(e||i.dirty||i.needs_full_repaint)&&(this.tile_renderer.Render(i),i.dirty=i.needs_full_repaint=!1)}this.tile_renderer.RenderHeaders(this.render_tiles,s),this.tile_renderer.RenderCorner(),this.RenderSelections()}MouseMove_RowHeader(e){const t=this.layout.CoordinateToRowHeader(e.offsetY),s=this.layout.OffsetCellAddressToRectangle({row:t.row,column:0});!this.hover_data.address||-1===this.hover_data.address.row&&-1===this.hover_data.address.column||this.HoverCell({row:-1,column:-1});let i=-1;e.offsetY-s.top<=this.RESIZE_PIXEL_BUFFER&&t.row>0?i=t.row-1:s.bottom-e.offsetY<=this.RESIZE_PIXEL_BUFFER&&(i=t.row),i>=0?this.layout.ResizeCursor("row"):this.cell_resize.row&&(this.cell_resize.row=-1,this.layout.ResizeCursor()),this.cell_resize.row=i}MouseMove_ColumnHeader(e){const t=this.layout.CoordinateToColumnHeader(e.offsetX),s=this.layout.OffsetCellAddressToRectangle({row:0,column:t.column});!this.hover_data.address||-1===this.hover_data.address.row&&-1===this.hover_data.address.column||this.HoverCell({row:-1,column:-1});let i=-1;e.offsetX-s.left<=this.RESIZE_PIXEL_BUFFER&&t.column>0?i=t.column-1:s.right-e.offsetX<=this.RESIZE_PIXEL_BUFFER&&(i=t.column),i>=0?this.layout.ResizeCursor("column"):this.cell_resize.column&&(this.cell_resize.column=-1,this.layout.ResizeCursor()),this.cell_resize.column=i}MouseDown_RowHeader(e){e.stopPropagation(),e.preventDefault();let t=this.layout.CoordinateToRowHeader(e.offsetY);const s=this.layout.row_header_cover.getBoundingClientRect(),i=(s.left,s.top);if(this.cell_resize.row>=0){const t=this.cell_resize.row,r=i+e.offsetY;if(this.layout.HideDropdownCaret(),this.IsDoubleClick({row:t,column:-1})){let e=[t];if(!this.primary_selection.empty&&this.primary_selection.area.rows>1&&this.primary_selection.area.start.column===1/0&&this.primary_selection.area.ContainsRow(t)){const t=this.active_sheet.RealArea(this.primary_selection.area);e=[];for(let s=t.start.row;s<=t.end.row;s++)e.push(s)}return void this.ExecCommand({key:ze.ResizeRows,row:e})}const o=this.layout.RowHeight(t);let a=o;const n=this.layout.OffsetCellAddressToRectangle({row:t,column:0}),l=i+n.bottom;this.layout.ShowTooltip({left:!0,text:`${a}px`,x:Math.round(s.right+10),y:l});const h=[],c=[];for(const e of this.active_sheet.annotations){const t=n.bottom-1;if(!e.scaled_rect||e.scaled_rect.bottom<t)continue;const s=[...this.layout.GetFrozenAnnotations(e)];e.node&&s.push(e.node),t<=e.scaled_rect.top&&e.move_with_cells?h.push({annotation:e,y:e.scaled_rect.top,nodes:s}):t>e.scaled_rect.top&&e.resize_with_cells&&c.push({annotation:e,height:e.scaled_rect.height,nodes:s})}he(this.layout.mask,"row-resize",(e=>{const s=Math.max(-o,Math.round(e.offsetY-r));if(s+o!==a){a=s+o,this.layout.SetRowHeight(t,a),this.layout.UpdateTooltip({text:`${a}px`,y:l+s});for(const{annotation:e,y:t}of h)e.scaled_rect&&(e.scaled_rect.top=t+s);for(const{annotation:e,height:t}of c)e.scaled_rect&&(e.scaled_rect.height=t+s);requestAnimationFrame((()=>{for(const{annotation:e,nodes:t}of c)if(e.scaled_rect)for(const s of t)e.scaled_rect.ApplyStyle(s);for(const{annotation:e,nodes:t}of h)if(e.scaled_rect)for(const s of t)e.scaled_rect.ApplyStyle(s);this.layout.UpdateTileHeights(!0,t),this.Repaint(!1,!0),this.layout.UpdateAnnotation(this.active_sheet.annotations)}))}}),(()=>{this.layout.HideTooltip(),requestAnimationFrame((()=>{let e=[t];if(!this.primary_selection.empty&&this.primary_selection.area.rows>1&&this.primary_selection.area.start.column===1/0&&this.primary_selection.area.ContainsRow(t)){const t=this.active_sheet.RealArea(this.primary_selection.area);e=[];for(let s=t.start.row;s<=t.end.row;s++)e.push(s)}this.ExecCommand({key:ze.ResizeRows,row:e,height:a});for(const{annotation:e}of h)e.scaled_rect&&(e.layout=this.layout.RectToAnnotationLayout(e.scaled_rect));for(const{annotation:e}of c)e.scaled_rect&&(e.layout=this.layout.RectToAnnotationLayout(e.scaled_rect)),e.resize_callback&&e.resize_callback.call(void 0)}))}))}else{const s=this.SelectingArgument()?this.active_selection:this.primary_selection;if(this.SelectingArgument()||this.Focus(),e.shiftKey&&!s.empty){const e=s.target;this.Select(s,new r(s.target,t,!0),void 0,!0),t=e}else this.Select(s,new r(t),{column:0,row:t.row});this.RenderSelections(),he(this.layout.mask,[],(e=>{const o=this.layout.CoordinateToRowHeader(e.offsetY-i),a=new r(o,t,!0);!s.empty&&a.Equals(s.area)||(this.Select(s,a,void 0,!0),this.RenderSelections())}),(()=>{}))}}MouseDown_ColumnHeader(e){e.stopPropagation(),e.preventDefault();let t=this.layout.CoordinateToColumnHeader(e.offsetX);const s=this.layout.column_header_cover.getBoundingClientRect(),i=s.left;if(s.top,this.cell_resize.column>=0){const t=this.cell_resize.column,r=i+e.offsetX;if(this.layout.HideDropdownCaret(),this.IsDoubleClick({row:-1,column:t})){let e=[t];if(!this.primary_selection.empty&&this.primary_selection.area.columns>1&&this.primary_selection.area.start.row===1/0&&this.primary_selection.area.ContainsColumn(t)){const t=this.active_sheet.RealArea(this.primary_selection.area);e=[];for(let s=t.start.column;s<=t.end.column;s++)e.push(s)}return void this.ExecCommand({key:ze.ResizeColumns,column:e})}const o=this.layout.ColumnWidth(t);let a=o;const n=this.layout.OffsetCellAddressToRectangle({row:0,column:t}),l=i+n.right;this.layout.ShowTooltip({up:!0,text:`${a}px`,x:l,y:Math.round(s.bottom+10)});const h=[],c=[];for(const e of this.active_sheet.annotations){const t=n.right-1;if(!e.scaled_rect||e.scaled_rect.right<t)continue;const s=[...this.layout.GetFrozenAnnotations(e)];e.node&&s.push(e.node),t<=e.scaled_rect.left&&e.move_with_cells?h.push({annotation:e,x:e.scaled_rect.left,nodes:s}):t>e.scaled_rect.left&&e.resize_with_cells&&c.push({annotation:e,width:e.scaled_rect.width,nodes:s})}he(this.layout.mask,"column-resize",(e=>{const s=Math.max(-o,Math.round(e.offsetX-r));if(s+o!==a){a=s+o,this.layout.UpdateTooltip({text:`${a}px`,x:l+s}),this.layout.SetColumnWidth(t,a);for(const{annotation:e,x:t}of h)e.scaled_rect&&(e.scaled_rect.left=t+s);for(const{annotation:e,width:t}of c)e.scaled_rect&&(e.scaled_rect.width=t+s);requestAnimationFrame((()=>{for(const{annotation:e,nodes:t}of c)if(e.scaled_rect)for(const s of t)e.scaled_rect.ApplyStyle(s);for(const{annotation:e,nodes:t}of h)if(e.scaled_rect)for(const s of t)e.scaled_rect.ApplyStyle(s);this.layout.UpdateTileWidths(!0,t),this.Repaint(!1,!0)}))}}),(()=>{this.layout.HideTooltip(),requestAnimationFrame((()=>{const e=[t];if(!this.primary_selection.empty&&this.primary_selection.area.columns>1&&this.primary_selection.area.start.row===1/0&&this.primary_selection.area.ContainsColumn(t)){const t=this.active_sheet.RealArea(this.primary_selection.area);for(let s=t.start.column;s<=t.end.column;s++)e.push(s)}this.ExecCommand({key:ze.ResizeColumns,column:e,width:a});for(const{annotation:e}of h)e.scaled_rect&&(e.layout=this.layout.RectToAnnotationLayout(e.scaled_rect));for(const{annotation:e}of c)e.scaled_rect&&(e.layout=this.layout.RectToAnnotationLayout(e.scaled_rect)),e.resize_callback&&e.resize_callback.call(void 0)}))}))}else{const s=this.SelectingArgument()?this.active_selection:this.primary_selection;if(this.SelectingArgument()||this.Focus(),e.shiftKey&&!s.empty){const e=s.target;this.Select(s,new r(s.target,t,!0),void 0,!0),t=e}else this.Select(s,new r(t),{row:0,column:t.column});this.RenderSelections(),he(this.layout.mask,[],(e=>{const o=this.layout.CoordinateToColumnHeader(e.offsetX-i),a=new r(o,t,!0);!s.empty&&a.Equals(s.area)||(this.Select(s,a,void 0,!0),this.RenderSelections())}))}}HoverCell(e,t){let s=this.active_sheet.cells.GetCell(e,!1);if(null==s?void 0:s.merge_area){const t=s.merge_area;e=t.start,s=this.active_sheet.cells.GetCell(e,!1),e={row:t.start.row,column:t.end.column}}(null==s?void 0:s.note)?(this.layout.ShowNote(s.note,e,t),this.hover_data.note=!0):this.hover_data.note&&(this.layout.HideNote(),this.hover_data.note=!1),(null==s?void 0:s.hyperlink)?(this.layout.ShowTitle("Link: "+s.hyperlink,e,t),this.hover_data.link=!0,this.hover_data.cell=s):this.hover_data.link&&(this.layout.HideTitle(),this.hover_data.cell=void 0),this.hover_data.address=Object.assign({},e)}HideHoverInfo(){this.layout.HideTitle(),this.layout.HideTooltip(),this.hover_data.note=this.hover_data.link=!1,this.hover_data.cell=void 0,this.hover_data.pointer&&this.layout.grid_cover.classList.remove("link-pointer"),this.hover_data.pointer=!1}MouseMove_Grid(e){var t;e.stopPropagation(),e.preventDefault(),(this.cell_resize.row>=0||this.cell_resize.column>=0)&&this.layout.ResizeCursor();const s={x:e.offsetX,y:e.offsetY};let i;if((null===(t=this.overlay_editor)||void 0===t?void 0:t.editing)||(i=this.layout.PointToAddress_Grid(s),this.hover_data.address&&this.hover_data.address.row===i.row&&this.hover_data.address.column===i.column||this.HoverCell(i,e)),this.hover_data.link&&i&&(this.hover_data.point=s,this.hover_data.handler||(this.hover_data.handler=requestAnimationFrame((()=>{const e=this.hover_data.address&&this.hover_data.point&&this.hover_data.cell&&this.PointInTextPart(this.hover_data.address,this.hover_data.point,this.hover_data.cell);e!==!!this.hover_data.pointer&&(this.hover_data.pointer=e,e?this.layout.grid_cover.classList.add("link-pointer"):this.layout.grid_cover.classList.remove("link-pointer")),this.hover_data.handler=void 0})))),this.primary_selection.empty||!this.selection_renderer.nub_rectangle)return void(this.nub_select_flag&&(this.layout.grid_cover.classList.remove("nub-select"),this.nub_select_flag=!1));const r=this.selection_renderer.nub_rectangle.Contains(e.offsetX,e.offsetY);r!==this.nub_select_flag&&(r?this.layout.grid_cover.classList.add("nub-select"):this.layout.grid_cover.classList.remove("nub-select"),this.nub_select_flag=r)}ClearDoubleClick(){this.double_click_data.address=void 0}IsDoubleClick(e,t=300){if(this.double_click_data.address&&this.double_click_data.address.row===e.row&&this.double_click_data.address.column===e.column)return clearTimeout(this.double_click_data.timeout),this.double_click_data.address=void 0,this.double_click_data.timeout=void 0,!0;this.double_click_data.timeout&&clearTimeout(this.double_click_data.timeout),this.double_click_data.address=Object.assign({},e),this.double_click_data.timeout=window.setTimeout((()=>{this.double_click_data.address=void 0,this.double_click_data.timeout=void 0}),t)}PointInTextPart(e,t,s){var i,r;let o=this.layout.CellAddressToRectangle(e);s.merge_area&&(o=o.Combine(this.layout.CellAddressToRectangle(s.merge_area.end)));const a=t.x-o.left,n=t.y-o.top,l=(null===(r=null===(i=s.renderer_data)||void 0===i?void 0:i.text_data)||void 0===r?void 0:r.strings)||[];for(const e of l)for(const t of e)if("number"==typeof t.left&&"number"==typeof t.top&&"number"==typeof t.width&&"number"==typeof t.height&&a>=t.left&&n>=t.top&&a<=t.left+t.width&&n<=t.top+t.height)return!0;return!1}MouseDown_Grid(e){var t,s,i,o,a;e.stopPropagation(),e.preventDefault();const n=this.SelectingArgument();!n&&this.additional_selections.length&&this.ClearAdditionalSelections(),n&&(null===(t=this.formula_bar)||void 0===t?void 0:t.selecting)||this.Focus(),(null===(s=this.overlay_editor)||void 0===s?void 0:s.editing)&&!(null===(i=this.overlay_editor)||void 0===i?void 0:i.selecting)&&this.DismissEditor();const l={x:e.offsetX,y:e.offsetY};let h=this.layout.PointToAddress_Grid(l);const c=n?this.active_selection:this.primary_selection;if(!n&&this.IsDoubleClick(h))return be.is_mobile&&(null===(a=null===(o=this.overlay_editor)||void 0===o?void 0:o.edit_node)||void 0===a||a.focus()),void this.OverlayEditCell({target:h,area:new r(h)},!1);let d=this.layout.grid_cover.getBoundingClientRect();const u={x:d.left,y:d.top},m=[];let f;if(e.shiftKey&&!c.empty){const e=c.target;this.Select(c,new r(h,c.target,!0),void 0,!0),h=e}else if(this.nub_select_flag)h=c.area.TopLeft(),m.push("nub-select"),f=this.active_sheet.RealArea(c.area);else{let e=h,t=this.active_sheet.CellData(e);if(t.merge_area&&(e=t.merge_area.start,t=this.active_sheet.CellData(t.merge_area.start)),t.hyperlink&&this.PointInTextPart(e,l,t)){const e=t.hyperlink;return F().then((()=>{this.grid_events.Publish({type:"cell-event",data:{type:"hyperlink",data:e}})})),void this.ClearDoubleClick()}if(t.click_function){let s=this.layout.CellAddressToRectangle(e);t.merge_area&&(s=s.Combine(this.layout.CellAddressToRectangle(t.merge_area.end)));const i=t.click_function.call(this,{cell:t,x:l.x-s.left,y:l.y-s.top,width:s.width,height:s.height,scale:this.layout.scale});if(i.value&&this.ExecCommand({key:ze.SetRange,value:i.value,area:e}),i.block_selection)return this.ClearDoubleClick(),void(this.primary_selection.empty||this.primary_selection.target.row!==e.row||this.primary_selection.target.column!==e.column||this.UpdateFormulaBarFormula())}this.Select(c,new r(h),h)}this.RenderSelections(),n&&this.UpdateSelectedArgument(c);const p=this.layout.CellAddressToRectangle({row:0,column:0}).Combine(this.layout.CellAddressToRectangle({row:this.active_sheet.rows-1,column:this.active_sheet.columns-1})).Expand(-1,-1);he(this.layout.mask,m,(e=>{const t={x:e.offsetX-u.x,y:e.offsetY-u.y},s=p.Clamp(t.x,t.y),i=this.layout.PointToAddress_Grid(s,!0),o=this.layout.scroll_reference_node;let a=!1;this.container&&this.options.scrollbars&&(t.x<o.scrollLeft?(o.scrollLeft-=25,a=!0):t.x>o.scrollLeft+this.container.clientWidth&&(o.scrollLeft+=25,a=!0),t.y<o.scrollTop?(o.scrollTop-=25,a=!0):t.y>o.scrollTop+this.container.clientHeight&&(o.scrollTop+=25,a=!0),a&&(d=this.layout.grid_cover.getBoundingClientRect(),u.x=d.left+document.body.scrollLeft,u.y=d.top+document.body.scrollTop));let l=new r(i,h,!0);if(f&&(l=f.Clone(),l.ConsumeAddress(i),l.rows!==f.rows&&l.columns!==f.columns)){const e={rows:i.row>f.end.row?i.row-f.end.row:f.start.row-i.row,columns:i.column>f.end.column?i.column-f.end.column:f.start.column-i.column};l=e.rows>=e.columns?new r({row:l.start.row,column:f.start.column},{row:l.end.row,column:f.end.column}):new r({row:f.start.row,column:l.start.column},{row:f.end.row,column:l.end.column})}!c.empty&&l.Equals(c.area)||(this.Select(c,l,void 0,!0),this.RenderSelections(),n?this.UpdateSelectedArgument(c):c.empty||c.area.entire_sheet||(c.area.entire_column?this.UpdateAddressLabel(void 0,c.area.columns+"C"):c.area.entire_row?this.UpdateAddressLabel(void 0,c.area.rows+"R"):c.area.count>1?this.UpdateAddressLabel(void 0,c.area.rows+"R x "+c.area.columns+"C"):this.UpdateAddressLabel(c)))}),(()=>{var e;this.UpdateAddressLabel(),n?(null===(e=this.overlay_editor)||void 0===e?void 0:e.editing)||this.select_argument||this.formula_bar&&this.formula_bar.FocusEditor():f&&this.RecycleNubArea(c.area,f)}))}Transpose(e){const t=[],s=e.length,i=e[0].length;for(let r=0;r<i;r++){t[r]=[];for(let i=0;i<s;i++)t[r][i]=e[i][r]}return t}RecycleNubArea(e,t){var s;if(e.Equals(t))return;let i=[];for(let e=0;e<t.rows;e++){i[e]=[];for(let s=0;s<t.columns;s++){const r={row:t.start.row+e,column:t.start.column+s};i[e][s]=this.active_sheet.CellData(r)}}if(i[0][0].area&&i[0][0].area.Equals(t))return void this.ExecCommand({key:ze.SetRange,value:i[0][0].value,array:!0,area:e});const r=[];let o=[],a=t.columns,n=e.rows,l=!1,h=!1;e.columns===t.columns?l=e.start.row<t.start.row:(a=t.rows,n=e.columns,l=e.start.column<t.start.column,i=this.Transpose(i),h=!0);for(let e=0;e<n;e++)r[e]=[],o[e]=[];for(let e=0;e<a;e++){let t=0;if(i.length>1){t=1;const s=[],r=[];for(let t=0;t<i.length;t++){const o=i[t][e];o.ValueIsNumber()&&(r.push(t),s.push(o.value))}if(s.length>1){const e=s.slice(1).map(((e,t)=>e-s[t]));e.every((t=>t===e[0]))&&(t=e[0])}s.length&&(t+=s[s.length-1]-s[0])}for(let a=0;a<i.length;a++){let h;const c=i[a][e];if(c.ValueIsFormula()){const e=this.parser.Parse(c.value);e.expression&&(null===(s=e.full_reference_list)||void 0===s?void 0:s.length)&&(h=e.expression)}let d=0,u=a,m=i.length,f=0,p=t;l&&(u=n-i.length+a,m=-i.length,p=-t);for(let t=u;t>=0&&t<n;t+=m,d+=m,f+=p){if(h)r[t][e]="="+this.parser.Render(h,{rows:d,columns:0});else{const s=i[a][e];s.ValueIsNumber()?r[t][e]=s.value+f:r[t][e]=s.value}o[t][e]=i[a][e].style||{}}}}const c=[{key:ze.SetRange,value:h?this.Transpose(r):r,array:!1,area:e}];h&&(o=this.Transpose(o));for(let t=0;t<o.length;t++)for(let s=0;s<o[t].length;s++)c.push({key:ze.UpdateStyle,area:{row:t+e.start.row,column:s+e.start.column},style:o[t][s],delta:!1});this.ExecCommand(c)}UpdateSelectedArgument(e){var t;const s=this.active_sheet.CellData(e.area.start),i=new r(s.merge_area?s.merge_area.start:e.target);let o=this.model.named_ranges.MatchSelection(e.area,i);if(!o&&(o=e.area.spreadsheet_label,s.merge_area&&s.merge_area.Equals(e.area)&&(o=r.CellAddressToLabel(s.merge_area.start)),this.active_sheet.id!==this.editing_cell.sheet_id)){const e=this.active_sheet.name;o=k.test(e)?`'${e}'!${o}`:`${e}!${o}`}(null===(t=this.overlay_editor)||void 0===t?void 0:t.editing)&&this.overlay_editor.selecting?this.overlay_editor.InsertReference(o,0):this.formula_bar&&this.formula_bar.selecting?this.formula_bar.InsertReference(o,0):this.select_argument&&this.grid_events.Publish({type:"alternate-selection",selection:this.active_selection})}SelectingArgument(){var e,t;return(null===(e=this.overlay_editor)||void 0===e?void 0:e.editing)&&(null===(t=this.overlay_editor)||void 0===t?void 0:t.selecting)||this.formula_bar&&this.formula_bar.selecting||this.select_argument}OverlayKeyDown(e){var t,s,i;let r=!1;if(this.overlay_editor&&this.overlay_editor.editing)switch(r=!0,this.overlay_editor.HandleKeyDown(e)){case Ce.handled:return;case Ce.discard:return this.editing_state=Ne.NotEditing,this.DismissEditor(),void this.DelayedRender();case Ce.commit:if(this.active_sheet.id!==this.editing_cell.sheet_id&&this.editing_cell.sheet_id&&this.ActivateSheetID(this.editing_cell.sheet_id),this.editing_state=Ne.NotEditing,null===(t=this.overlay_editor)||void 0===t?void 0:t.selection){const t=(null===(s=this.overlay_editor)||void 0===s?void 0:s.edit_node.textContent)||void 0,i="Enter"===e.key&&e.ctrlKey&&e.shiftKey;this.SetInferredType(this.overlay_editor.selection,t,i)}this.DismissEditor(),this.options.repaint_on_cell_change&&this.DelayedRender(!1,(null===(i=this.overlay_editor)||void 0===i?void 0:i.selection.area)||void 0)}const o=this.SelectingArgument();if(this.formula_bar&&this.formula_bar.focused&&!o)return;if(this.selected_annotation&&!o)return;const a=o?this.active_selection:this.primary_selection,n={rows:0,columns:0};let l=!1,h=!1;if(e.ctrlKey||be.is_mac&&e.metaKey){switch(e.key){case"ArrowDown":case"Down":n.rows++;break;case"ArrowUp":case"Up":n.rows--;break;case"ArrowLeft":case"Left":n.columns--;break;case"ArrowRight":case"Right":n.columns++;break;case"Delete":case"Del":e.stopPropagation(),e.preventDefault();for(let e=0;e<this.model.sheets.length;e++)if(this.model.sheets[e]===this.active_sheet){this.DeleteSheet(e);break}return;case"/":e.stopPropagation(),e.preventDefault(),this.SelectArray();break;default:if(e.shiftKey)return}if(n.columns||n.rows){if(e.stopPropagation(),e.preventDefault(),a.empty||!n.columns&&!n.rows)return;if(this.BlockSelection(a,!!e.shiftKey,n.columns,n.rows))return}else{const t={},s=this.primary_selection.empty?{}:this.active_sheet.CellData(this.primary_selection.target).style||{};switch(e.key.toLowerCase()){case"b":t.font_bold=!s.font_bold;break;case"i":t.font_italic=!s.font_italic;break;case"u":t.font_underline=!s.font_underline;break;case"a":this.SelectAll();break;case"0":if(!e.altKey)return;this.ClearSelection(this.primary_selection),this.RenderSelections();break;default:return void e.key}Object.keys(t).length&&this.ApplyStyle(void 0,t)}}else switch(e.key){case"Tab":e.shiftKey?n.columns--:n.columns++,l=!0;break;case"Enter":e.shiftKey?n.rows--:n.rows++,l=!0;break;case"ArrowDown":case"Down":n.rows++,h=e.shiftKey;break;case"ArrowUp":case"Up":n.rows--,h=e.shiftKey;break;case"ArrowLeft":case"Left":n.columns--,h=e.shiftKey;break;case"ArrowRight":case"Right":n.columns++,h=e.shiftKey;break;case"Delete":case"Del":a.empty||this.DeleteSelection(a);break;case"PageUp":case"PageDown":if(e.shiftKey){this.NextSheet("PageUp"===e.key?-1:1);break}return;case"Control":case"Shift":case"Alt":return;default:return void(a.empty||this.OverlayEditCell(a,!0,e))}e.stopPropagation(),e.preventDefault(),(n.rows||n.columns)&&this.AdvanceSelection(n,a,l,h,!r)}SelectArray(){if(this.primary_selection.empty)return;const e=this.active_sheet.CellData(this.primary_selection.target);e&&e.area&&(this.Select(this.primary_selection,e.area,e.area.start),this.RenderSelections())}RenderSelections(e=!0){const t=!this.editing_state||this.editing_cell.sheet_id===this.active_sheet.id;this.selection_renderer.RenderSelections(t,e)}BlockSelection(e,t,s,i,o=!0){if(e.empty)return!1;const n=Object.assign({},e.target);i>0?n.row=Math.max(n.row,e.area.end.row):i<0&&(n.row=Math.min(n.row,e.area.start.row)),s>0?n.column=Math.max(n.column,e.area.end.column):s<0&&(n.column=Math.min(n.column,e.area.start.column));const l=this.active_sheet.cells;let h=l.GetCell(e.target,!1);if(!h||h.type===a.undefined&&!h.area)return!1;let c=Object.assign({},n);for(;;){const t={row:c.row+i,column:c.column+s};if(t.column<0||t.row<0||t.column>=this.active_sheet.columns||t.row>=this.active_sheet.rows)break;let r=!1;if(i)for(let s=e.area.start.column;!r&&s<=e.area.end.column;s++)h=l.GetCell({row:t.row,column:s},!1),r=r||!!h&&(h.type!==a.undefined||!!h.area),!r&&h&&h.merge_area&&(h=l.GetCell(h.merge_area.start,!1),r=r||!!h&&(h.type!==a.undefined||!!h.area));else for(let s=e.area.start.row;!r&&s<=e.area.end.row;s++)h=l.GetCell({row:s,column:t.column},!1),r=r||!!h&&(h.type!==a.undefined||!!h.area),!r&&h&&h.merge_area&&(h=l.GetCell(h.merge_area.start,!1),r=r||!!h&&(h.type!==a.undefined||!!h.area));if(!r)break;c=t}if(t){i?(n.row=e.target.row,n.column=e.area.start.column,c.column=e.area.end.column):(n.column=e.target.column,n.row=e.area.start.row,c.row=e.area.end.row);const t=new r(n,c,!0);this.Select(e,t,e.target,!0)}else this.Select(e,new r(c));return this.ScrollIntoView(c),this.SelectingArgument()&&this.UpdateSelectedArgument(e),o&&this.DelayedRender(),!0}DeleteSelection(e){if(e.empty)return;const t=this.active_sheet.RealArea(e.area);this.ExecCommand({key:ze.Clear,area:t})}Error(e){console.info("Error",e),this.grid_events.Publish({type:"error",message:e})}SetInferredType(e,t,s=!1,i=!0){var r;let o=e.target||e.area.start;const n=this.active_sheet.CellData(o);if(n.area){if(!s&&n.area.count>1||!e.area||!e.area.Equals(n.area))return void this.Error("You can't change part of an array.")}else if(s){let t=!1;if(this.active_sheet.cells.Apply(e.area,(e=>{e.area&&(t=!0)}),!1),t)return void this.Error("You can't change part of an array.")}if(n.validation){let e;if(n.validation.type===l.List?e=n.validation.list:n.validation.type===l.Range&&(e=this.GetValidationRange(n.validation.area)),e&&e.length){let s=!1;if(t){const i=t.toUpperCase();for(const r of e)if(r&&r.toString().toUpperCase()===i){t=r.toString(),s=!0;break}}if(!s)return void this.Error("Invalid value (data validation).")}}n.merge_area&&(o=n.merge_area.start);const h="string"==typeof t&&"="===t.trim()[0],c=[];if(h&&(t=this.FixFormula(t||""),!this.active_sheet.HasCellStyle(o))){const i=this.parser.Parse(t);if(i){if("call"===(null===(r=i.expression)||void 0===r?void 0:r.type)&&(!n.style||!n.style.number_format||Q.Equals(n.style.number_format,"General"))){let t;switch(i.expression.name.toLowerCase()){case"today":t="Short Date";break;case"now":t="Timestamp"}t&&c.push({key:ze.UpdateStyle,area:s?e.area:o,style:{number_format:t},delta:!0})}if(i.dependencies){const t=i.dependencies;for(const i of Object.keys(t.addresses)){const r=t.addresses[i];if(this.active_sheet.HasCellStyle(Object.assign({},r))){const t=this.active_sheet.CellData(Object.assign({},r));if(t.style&&t.style.number_format){const i={number_format:t.style.number_format};c.push({key:ze.UpdateStyle,area:s?e.area:o,style:i,delta:!0})}break}}}}}let d=this.parser.Parse(t||"").expression;"group"===(null==d?void 0:d.type)&&1===d.elements.length&&"complex"===d.elements[0].type&&(d=d.elements[0]);const u=d&&"complex"===d.type?{type:a.complex,value:{real:d.real,imaginary:d.imaginary}}:se.TryParse(t);if(!h&&u.type===a.number){let t="";const i=u.hints||ee.None;n.style&&n.style.number_format&&!Q.Equals(n.style.number_format,"General")||(i&ee.Date?t="Short Date":i&ee.Exponential?t="Exponential":i&ee.Percent?t="Percent":i&ee.Currency?t="Currency":(i&ee.Grouping||i&ee.Parens)&&(t="Accounting")),t&&c.push({key:ze.UpdateStyle,area:s?e.area:o,style:{number_format:t},delta:!0})}if(c.push({key:ze.SetRange,area:s?e.area:o,array:s,value:h?t:u.value}),!i)return c;this.ExecCommand(c)}FixFormula(e){if("="!==e.trim()[0])return e;let t=!1,s=!1,i=0,r=!1;const o=(e=e.replace(/^\s+/,"")).length;for(let a=0;a<o;a++){const o=e[a];if(!r)switch(o){case'"':t?'"'===e[a+1]?a++:t=!1:s||(t=!0);break;case"'":s?s=!1:t||(s=!0);break;case"\\":r=!0;break;case"(":t||s||i++;break;case")":t||s||i--}}for(t?e+='"':s&&(e+="'");i>0;)e+=")",i--;return this.NormalizeFormula(e)}NormalizeFormula(e){const t=this.parser.Parse(e);return t&&t.expression&&(this.parser.Walk(t.expression,(e=>{switch(e.type){case"call":e.name=this.autocomplete_matcher.NormalizeIdentifier(e.name)||e.name;break;case"identifier":this.model.named_ranges.Get(e.name)&&(e.name=e.name.toUpperCase())}return!0})),e="="+this.parser.Render(t.expression,void 0,"")),e}DismissEditor(){var e,t;(null===(e=this.overlay_editor)||void 0===e?void 0:e.active_cell)&&(this.overlay_editor.active_cell.editing=!1,this.overlay_editor.active_cell.render_dirty=!0,this.DelayedRender(void 0,this.overlay_editor.selection.area)),this.editing_state=Ne.NotEditing,this.Focus(),null===(t=this.overlay_editor)||void 0===t||t.CloseEditor(),this.ClearAdditionalSelections(),this.ClearSelection(this.active_selection)}NormalizeCellValue(e){let t=e.value;if(e.ValueIsNumber()&&e.style&&e.style.number_format)if(Q.Get(e.style.number_format).date_format){const s=X(e.value),i=s.getUTCHours()||s.getUTCMinutes()||s.getUTCSeconds()?"Timestamp":"Short Date";t=Q.Get(i).Format(t)}else if(/(?:%|percent)/i.test(e.style.number_format)){let s=0;const i=e.value.toString().match(/\.(.*?)$/);i&&i[1]&&(s=Math.max(0,i[1].length-2)),t=(100*e.value).toFixed(s)+"%",","===f.decimal_separator&&(t=t.replace(/\./,","))}else t&&","===f.decimal_separator&&(t=e.value.toString().replace(/\./,","));else{if(e.ValueIsBoolean())return e.value.toString().toUpperCase();if(e.ValueIsNumber())t&&","===f.decimal_separator&&(t=e.value.toString().replace(/\./,","));else if(e.ValueIsComplex()){const s={real:e.value.real.toString(),imaginary:Math.abs(e.value.imaginary).toString()};","===f.decimal_separator&&(s.real=s.real.replace(/\./,","),s.imaginary=s.imaginary.replace(/\./,",")),t=`${s.real}${e.value.imaginary<0?" - ":" + "}${s.imaginary}i`}}return t}IsNumeric(e){return e>=48&&e<=57||e===this.decimal_separator_code||45===e||43===e}OverlayEditCell(e,t=!0,s){var i,r;if(!this.options.in_cell_editor)return;let o,n=e.target||e.area.start,l=this.active_sheet.CellData(n);if(this.HideHoverInfo(),l.merge_area?(o=this.layout.OffsetCellAddressToRectangle(l.merge_area.start).Combine(this.layout.OffsetCellAddressToRectangle(l.merge_area.end)),n=l.merge_area.start,l=this.active_sheet.CellData(n)):o=this.layout.OffsetCellAddressToRectangle(n),null===(i=l.style)||void 0===i?void 0:i.locked)return void console.info("cell is locked for editing");o=o.Shift(this.layout.header_size.width,this.layout.header_size.height);let h=l.value;h=t?l.type!==a.number&&l.rendered_type!==a.number||!l.style||!l.style.number_format||!/(?:%|percent)/i.test(l.style.number_format)||s&&!this.IsNumeric(s.key.charCodeAt(0))?void 0:"%":this.NormalizeCellValue(l),null===(r=this.overlay_editor)||void 0===r||r.Edit(e,o.Expand(-1,-1),l,h,s),l.editing=!0,l.render_dirty=!0,this.DelayedRender(!1,e.area)}BoundAddressArea(e,t){e.column>t.end.column?(e.row=this.StepVisibleRows(e.row,1),e.row>t.end.row&&(e.row=t.start.row),e.column=t.start.column):e.column<t.start.column?(e.row=this.StepVisibleRows(e.row,-1),e.row<t.start.row&&(e.row=t.end.row),e.column=t.end.column):e.row>t.end.row?(e.column=this.StepVisibleColumns(e.column,1),e.column>t.end.column&&(e.column=t.start.column),e.row=t.start.row):e.row<t.start.row&&(e.column=this.StepVisibleColumns(e.column,-1),e.column<t.start.column&&(e.column=t.end.column),e.row=t.end.row)}StepVisibleRows(e,t){if(t>0)for(let s=0;s<t;s++)this.layout.RowHeight(++e)||s--;else if(t<0)for(let s=0;s>t;s--)--e>=0&&!this.layout.RowHeight(e)&&s++;return e}StepVisibleColumns(e,t){if(t>0)for(let s=0;s<t;s++)this.layout.ColumnWidth(++e)||s--;else if(t<0)for(let s=0;s>t;s--)--e>=0&&!this.layout.ColumnWidth(e)&&s++;return e}AdvanceSelection(e,t,s=!1,i=!1,o=!0){const a=this.SelectingArgument();let n=!1;if(t.empty)if(a){const s={row:Math.max(0,this.StepVisibleRows(this.primary_selection.target.row,e.rows)),column:Math.max(0,this.StepVisibleColumns(this.primary_selection.target.column,e.columns))};this.Select(t,new r(s))}else this.Select(t,new r({row:0,column:0}));else{const a=this.active_sheet.CellData(t.target);if(a.merge_area&&s&&(s=!a.merge_area.Equals(t.area)),s&&t.area.count>1){const s=this.RealArea(t.area),i=t.target;for(;;){i.row=this.StepVisibleRows(i.row,e.rows),i.column=this.StepVisibleColumns(i.column,e.columns),this.BoundAddressArea(i,s);const t=this.active_sheet.CellData(i);if(!t.merge_area||t.merge_area.start.row===i.row&&t.merge_area.start.column===i.column)break}this.Select(t,s,i)}else if(i&&t&&t.target){const s=t.area,i=t.target,a=s.start,l=s.end,h={row:1/0,column:1/0};if(e.columns&&(1===s.columns?e.columns>0?(l.column=this.StepVisibleColumns(l.column,1),h.column=l.column):(a.column=this.StepVisibleColumns(a.column,-1),h.column=a.column):s.end.column>i.column?(l.column=this.StepVisibleColumns(l.column,e.columns),h.column=l.column):s.start.column<i.column&&(a.column=this.StepVisibleColumns(a.column,e.columns),h.column=a.column),l.column=Math.max(0,l.column),a.column=Math.max(0,a.column)),e.rows&&(1===s.rows?e.rows>0?(l.row=this.StepVisibleRows(l.row,1),h.row=l.row):(a.row=this.StepVisibleRows(a.row,-1),h.row=a.row):s.end.row>i.row?(l.row=this.StepVisibleRows(l.row,e.rows),h.row=l.row):s.start.row<i.row&&(a.row=this.StepVisibleRows(a.row,e.rows),h.row=a.row),l.row=Math.max(0,l.row),a.row=Math.max(0,a.row)),this.options.expand){for(const e of[a,l,h])e.row!==1/0&&(e.row=Math.max(0,e.row)),e.column!==1/0&&(e.column=Math.max(0,e.column));if(l.row!==1/0&&l.row>=this.active_sheet.rows&&this.options.expand){let e=this.active_sheet.rows;for(;l.row>=e;)e+=8;this.active_sheet.cells.EnsureRow(e),n=!0}if(l.column!==1/0&&l.column>=this.active_sheet.columns&&this.options.expand){let e=this.active_sheet.columns;for(;l.column>=e;)e+=8;this.active_sheet.cells.EnsureColumn(e),n=!0}n&&(this.layout.UpdateTiles(),this.layout.UpdateContentsSize(),this.Repaint(!0,!0),o=!0),this.ScrollIntoView(h),this.Select(t,new r(a,l),void 0,!0)}else{for(const e of[a,l,h])e.row!==1/0&&(e.row=Math.max(0,Math.min(e.row,this.active_sheet.rows-1))),e.column!==1/0&&(e.column=Math.max(0,Math.min(e.column,this.active_sheet.columns-1)));this.ScrollIntoView(h),this.Select(t,new r(a,l),void 0,!0)}}else{const s=t.target;if(a.merge_area?(e.columns<0?s.column=this.StepVisibleColumns(a.merge_area.start.column,-1):e.columns>0&&(s.column=this.StepVisibleColumns(a.merge_area.end.column,1)),e.rows<0?s.row=this.StepVisibleRows(a.merge_area.start.row,-1):e.rows>0&&(s.row=this.StepVisibleRows(a.merge_area.end.row,1))):(s.row=this.StepVisibleRows(s.row,e.rows),s.column=this.StepVisibleColumns(s.column,e.columns)),s.row>=this.active_sheet.rows&&this.options.expand){let e=this.active_sheet.rows;for(;s.row>=e;)e+=8;this.active_sheet.cells.EnsureRow(e),n=!0}if(s.column>=this.active_sheet.columns&&this.options.expand){let e=this.active_sheet.columns;for(;s.column>=e;)e+=8;this.active_sheet.cells.EnsureColumn(e),n=!0}n&&(this.layout.UpdateTiles(),this.layout.UpdateContentsSize(),this.Repaint(!0,!0),o=!0),this.Select(t,new r({row:Math.min(Math.max(0,s.row),this.active_sheet.rows-1),column:Math.min(Math.max(0,s.column),this.active_sheet.columns-1)})),this.RenderSelections(),this.ScrollIntoView(t.target)}}this.SelectingArgument()&&this.UpdateSelectedArgument(t),o&&this.DelayedRender()}HighlightDependencies(e,t=!0){let s=0;e:for(let t of e)if((t.start.row===1/0||t.start.row<this.active_sheet.rows)&&(t.start.column===1/0||t.start.column<this.active_sheet.columns)){t=this.active_sheet.RealArea(t);const e=t.spreadsheet_label;if(this.additional_selections[s]&&this.additional_selections[s].area.spreadsheet_label===e)s++;else{for(let i=0;i<s;i++)if(this.additional_selections[i].area.spreadsheet_label===e&&this.additional_selections[i].area.start.sheet_id===t.start.sheet_id)continue e;this.additional_selections[s++]={target:t.start,area:t}}}this.additional_selections.splice(s),t&&this.RenderSelections(!1)}AddAdditionalSelection(e,t){const s=t.spreadsheet_label;return!this.additional_selections.some((e=>e.area.spreadsheet_label===s))&&(this.additional_selections.push({target:e,area:t}),!0)}ClearAdditionalSelections(){this.additional_selections.splice(0,this.additional_selections.length)}ClearSelection(e){this.Select(e)}HideGridSelection(){this.UpdateAddressLabel(void 0,"");const e=this.selected_annotation&&this.selected_annotation.formula?this.selected_annotation.formula:"";this.UpdateFormulaBarFormula(e),this.layout.ShowSelections(!1)}ShowGridSelection(){this.UpdateAddressLabel(),this.UpdateFormulaBarFormula(),this.layout.ShowSelections(!0)}Select(e,t,s,i=!1){if(e.empty||i&&(s=e.target),t){let i=this.active_sheet.RealArea(t);s||(s=i.start);let o=!0;for(;o;)o=!1,this.active_sheet.cells.Apply(i,(e=>{e.merge_area&&!i.ContainsArea(e.merge_area)&&(t.ConsumeArea(e.merge_area),i=this.active_sheet.RealArea(t),o=!0)}));e.area=new r(Object.assign(Object.assign({},t.start),{sheet_id:this.active_sheet.id}),t.end),s&&(e.target=Object.assign(Object.assign({},s),{sheet_id:this.active_sheet.id})),e.empty=!1}else e.empty=!0;e===this.primary_selection&&(be.is_edge&&this.Focus(),this.grid_events.Publish({type:"selection",selection:this.primary_selection}),this.UpdateAddressLabel(),this.UpdateFormulaBarFormula())}SetValidationInternal(e){let t,s;if(e.target.sheet_id&&e.target.sheet_id!==this.model.active_sheet.id){for(const s of this.model.sheets)if(s.id===e.target.sheet_id){t=s;break}}else t=this.model.active_sheet;if(t&&(s=t.cells.GetCell(e.target,!0)),!s)throw new Error("invalid cell in set validation");e.range?s.validation={type:l.Range,area:e.range}:e.list?s.validation={type:l.List,list:JSON.parse(JSON.stringify(e.list))}:s.validation=void 0}GetValidationRange(e){let t,s;if(e.start.sheet_id&&e.start.sheet_id!==this.model.active_sheet.id){for(const s of this.model.sheets)if(s.id===e.start.sheet_id){t=s;break}}else t=this.model.active_sheet;if(t){s=[];for(let i=(e=t.RealArea(new r(e.start,e.end),!0)).start.row;i<=e.end.row;i++)for(let r=e.start.column;r<=e.end.column;r++){const e=t.CellData({row:i,column:r});e&&e.formatted&&("string"==typeof e.formatted?s.push(e.formatted):s.push(Y.FormatPartsAsText(e.formatted)))}}return s}UpdateFormulaBarFormula(e){var t,s;if(this.formula_bar)if(e)this.formula_bar.formula=e;else if(this.primary_selection.empty)this.formula_bar.formula="";else{let e=this.active_sheet.CellData(this.primary_selection.target);const i=e.merge_area||e.area;i&&(i.start.column===this.primary_selection.target.column&&i.start.row===this.primary_selection.target.row||(e=this.active_sheet.CellData(i.start))),this.formula_bar.editable=!(null===(t=e.style)||void 0===t?void 0:t.locked);const o=this.NormalizeCellValue(e);if(e.validation&&!(null===(s=e.style)||void 0===s?void 0:s.locked)){let t;e.validation.type===l.List?t=e.validation.list:e.validation.type===l.Range&&(t=this.GetValidationRange(e.validation.area)),t&&t.length&&this.layout.ShowDropdownCaret(e.merge_area||new r(this.primary_selection.target),t,e.value)}else this.layout.HideDropdownCaret();e.area?this.formula_bar.formula="{"+(o||"")+"}":this.formula_bar.formula=void 0!==o?o.toString():""}}UpdateAddressLabel(e=this.primary_selection,t){if(this.formula_bar)if(void 0!==t)this.formula_bar.label=t;else if(e.empty)this.formula_bar.label="";else{const t=this.active_sheet.CellData(this.primary_selection.target),s=new r(t.merge_area?t.merge_area.start:e.target);this.formula_bar.label=this.model.named_ranges.MatchSelection(e.area,s)||r.CellAddressToLabel(s.start)}}OnDropdownSelect(e){if(void 0!==e){const t=se.TryParse(e.toString());t.type===a.number&&(e=t.value)}const t=this.active_sheet.CellData(this.primary_selection.target),s=t.merge_area?t.merge_area.start:this.primary_selection.target;this.ExecCommand({key:ze.SetRange,area:s,value:e}),this.UpdateFormulaBarFormula()}OnScroll(){const e=this.layout.VisibleTiles();e.Equals(this.render_tiles)||(this.render_tiles=e,this.layout_token||(this.layout_token=requestAnimationFrame((()=>this.Repaint()))))}AttachListeners(){var e;if(!this.container)throw new Error("invalid container");this.container.addEventListener("copy",this.HandleCopy.bind(this)),this.container.addEventListener("cut",this.HandleCut.bind(this)),this.container.addEventListener("paste",this.HandlePaste.bind(this)),this.layout.grid_cover.addEventListener("mousedown",(e=>this.MouseDown_Grid(e))),this.layout.column_header_cover.addEventListener("mousedown",(e=>this.MouseDown_ColumnHeader(e))),this.layout.row_header_cover.addEventListener("mousedown",(e=>this.MouseDown_RowHeader(e))),this.layout.column_header_cover.addEventListener("mousemove",(e=>this.MouseMove_ColumnHeader(e))),this.layout.row_header_cover.addEventListener("mousemove",(e=>this.MouseMove_RowHeader(e))),this.layout.grid_cover.addEventListener("mousemove",(e=>this.MouseMove_Grid(e))),null===(e=this.overlay_editor)||void 0===e||e.edit_node.addEventListener("keydown",(e=>this.OverlayKeyDown(e))),this.layout.corner.addEventListener("dblclick",(()=>{this.SelectAll()}))}HandleCopy(e){if(e.stopPropagation(),e.preventDefault(),this.primary_selection.empty){if(e.clipboardData&&e.clipboardData.clearData(),this.selected_annotation&&e.clipboardData){const t=JSON.stringify({data:this.selected_annotation,source:this.active_sheet.id});if(e.clipboardData.setData("text/x-treb-annotation",t),this.selected_annotation.node){const t=this.selected_annotation.node.firstChild;if(t){const s=(e=>{if(!I){const e={},t=document.createElement("iframe");t.style.width="10px",t.style.height="10px",t.style.position="absolute",t.style.left="-100px",document.body.appendChild(t);const s=t.contentDocument;if(s){const t=s.createElement("div");s.body.appendChild(t);const i=getComputedStyle(t);Array.prototype.forEach.call(i,(t=>e[t]=i[t]))}document.body.removeChild(t),I=e}return V(e,I)})(t).outerHTML,i="text/plain";e.clipboardData.setData(i,s)}}}}else{const t=this.active_sheet.RealArea(this.primary_selection.area),s=t.columns,i=t.rows,r=[],o=[];for(let e=0;e<i;e++){const i=[];for(let r=0;r<s;r++){const s={row:t.start.row+e,column:t.start.column+r},a=this.active_sheet.CellData(s);i.push(void 0===a.calculated?a.value:a.calculated);const n={address:s,data:a.value,type:a.type,style:this.active_sheet.GetCopyStyle(s)};a.area&&a.area.start.row===s.row&&a.area.start.column===s.column&&(n.array={rows:a.area.rows,columns:a.area.columns}),o.push(JSON.parse(JSON.stringify(n)))}r.push(i)}const a=r.map((e=>e.join("\t"))).join("\n");e.clipboardData&&(e.clipboardData.clearData(),e.clipboardData.setData("text/plain",a),e.clipboardData.setData("text/x-treb",JSON.stringify({source:t,data:o})))}}HandleCut(e){if(e.stopPropagation(),e.preventDefault(),this.HandleCopy(e),this.primary_selection.empty)this.selected_annotation&&this.RemoveAnnotation(this.selected_annotation);else{const e=this.active_sheet.RealArea(this.primary_selection.area);this.ExecCommand({key:ze.Clear,area:e})}}RecyclePasteAreas(e,t){const s=[];if(1===e.count)for(let e=t.start.row;e<=t.end.row;e++)for(let i=t.start.column;i<=t.end.column;i++)s.push(new r({row:e,column:i}));else if(e.columns===t.columns&&t.rows>=e.rows&&t.rows%e.rows==0)for(let i=t.start.row;i<=t.end.row;i+=e.rows)s.push(new r({row:i,column:t.start.column},{row:i+e.rows-1,column:t.end.column}));else if(e.rows===t.rows&&t.columns>=e.columns&&t.columns%e.columns==0)for(let i=t.start.column;i<=t.end.column;i+=e.columns)s.push(new r({column:i,row:t.start.row},{column:i+e.columns-1,row:t.end.row}));else s.push(t.Clone().Resize(e.rows,e.columns));return s}HandlePaste(e){var t;if(null===(t=this.overlay_editor)||void 0===t?void 0:t.editing)return;if(e.stopPropagation(),e.preventDefault(),!e.clipboardData)return;const s=e.clipboardData.getData("text/x-treb-annotation");if(s){try{const e=JSON.parse(s);if(e.source&&e.source!==this.active_sheet.id&&e.data&&e.data.formula){let t="";for(const s of this.model.sheets)if(s.id===e.source){t=s.name;break}if(t){const s=this.parser.Parse(e.data.formula);s.expression&&(this.parser.Walk(s.expression,(e=>("address"===e.type&&(e.sheet_id||e.sheet||(e.sheet=t)),!0))),e.data.formula="="+this.parser.Render(s.expression,void 0,""))}}const t=this.CreateAnnotation(e.data,!0,!0);if(t.node){const e=t.node;setTimeout((()=>{e.focus()}),1)}}catch(e){console.error(e)}return}if(this.primary_selection.empty)return;const i=this.active_sheet.RealArea(this.primary_selection.area),o=[],n=e.clipboardData.getData("text/x-treb");if(n)try{const e=JSON.parse(n),t=new r(e.source.start,e.source.end),s=this.RecyclePasteAreas(t,i);1===s.length&&i.Resize(s[0].rows,s[0].columns);const l=[];for(const i of s){this.active_sheet.cells.EnsureCell(i.end),o.push({key:ze.Clear,area:i});const s={rows:i.start.row-t.start.row,columns:i.start.column-t.start.column};e.data.forEach((e=>{let n=e.data;const h={row:e.address.row-t.start.row+i.start.row,column:e.address.column-t.start.column+i.start.column};if(e.type===a.formula){const e=this.parser.Parse(n);e.expression&&(n="="+this.parser.Render(e.expression,s,""))}if(e.array){const t={start:Object.assign({},h),end:{row:h.row+e.array.rows-1,column:h.column+e.array.columns-1}},s={key:ze.SetRange,value:n,array:!0,area:t};l.push(new r(t.start,t.end)),o.push(s)}else{let e=!1;for(const t of l)if(t.Contains(h)){e=!0;break}e||o.push({key:ze.SetRange,value:n,area:h})}o.push({key:ze.UpdateStyle,style:e.style||{},area:h})}))}}catch(e){return console.error("invalid treb data on clipboard"),void console.info(e)}else{const t=e.clipboardData.getData("text/plain");if(!t)return!0;const s=t.trim().split("\n").map((e=>e.split("\t").map((e=>e.trim())))),n=this.RecyclePasteAreas(new r({row:0,column:0},{row:s.length-1,column:s[0].length-1}),i);1===n.length&&(i.Resize(s.length,s[0].length),i.Resize(n[0].rows,n[0].columns));for(const e of n)for(let t=0;t<s.length;t++)for(let i=0;i<s[0].length;i++){const n=new r({row:t+e.start.row,column:i+e.start.column});if(this.active_sheet.cells.EnsureCell(n.end),s[t][i]){const e=this.SetInferredType({area:n,target:n.start,empty:!1},s[t][i],!1,!1);if(e)for(const t of e)o.push(t)}else{const e=this.active_sheet.cells.GetCell(n.start,!1);e&&e.type!==a.undefined&&o.push({key:ze.Clear,area:n.Clone()})}}}this.ExecCommand(o),this.Select(this.primary_selection,i)}AllSelections(e=!1){const t=[this.primary_selection,this.active_selection].concat(this.additional_selections);return e?t:t.filter((e=>!e.empty))}FreezeInternal(e){const t="boolean"!=typeof e.highlight_transition||e.highlight_transition;e.rows!==this.active_sheet.freeze.rows||e.columns!==this.active_sheet.freeze.columns?(this.active_sheet.freeze.rows=e.rows,this.active_sheet.freeze.columns=e.columns,this.QueueLayoutUpdate(),this.Repaint(),t&&this.HighlightFreezeArea(),e.rows||e.columns?this.layout.CloneFrozenAnnotations():this.layout.ClearFrozenAnnotations()):t&&this.HighlightFreezeArea()}RenameSheetInternal(e,t){if(!t||R.test(t))throw new Error("invalid sheet name");const s=t.toLowerCase();for(const t of this.model.sheets)if(t!==e&&t.name.toLowerCase()===s)throw new Error("sheet name already exists");const i=e.name.toLowerCase();e.name=t;for(const e of this.model.sheets){e.cells.IterateAll((e=>{if(e.ValueIsFormula()){let s=!1;const r=this.parser.Parse(e.value||"");r.expression&&(this.parser.Walk(r.expression,(e=>("address"===e.type&&e.sheet&&e.sheet.toLowerCase()===i&&(e.sheet=t,s=!0),!0))),s&&(e.value="="+this.parser.Render(r.expression,void 0,"")))}}));for(const s of e.annotations)if(s.formula){let e=!1;const r=this.parser.Parse(s.formula||"");r.expression&&(this.parser.Walk(r.expression,(s=>("address"===s.type&&s.sheet&&s.sheet.toLowerCase()===i&&(s.sheet=t,e=!0),!0))),e&&(s.formula="="+this.parser.Render(r.expression,void 0,"")))}}}PatchFormulasInternal(e,t,s,i,r,o,a){const n=this.parser.Parse(e||"");let l=!1;if(n.expression&&(this.parser.Walk(n.expression,(e=>{if("range"===e.type||"address"===e.type){const n=[];"range"===e.type?(e.start.sheet&&e.start.sheet.toLowerCase()===o||!e.start.sheet&&a)&&n.push(e.start,e.end):"address"===e.type&&(e.sheet&&e.sheet.toLowerCase()===o||!e.sheet&&a)&&n.push(e);for(const e of n)s&&e.row>=t&&(s<0&&e.row+s<t?e.column=e.row=-1:e.row+=s,l=!0),r&&e.column>=i&&(r<0&&e.column+r<i?e.column=e.row=-1:e.column+=r,l=!0);return!1}return!0})),l))return"="+this.parser.Render(n.expression,void 0,"")}InsertRowsInternal(e){if(!this.active_sheet.InsertRows(e.before_row,e.count))return void this.Error("You can't change part of an array.");this.model.named_ranges.PatchNamedRanges(0,0,e.before_row,e.count);const t=this.active_sheet.name.toLowerCase();for(const s of this.model.sheets){const i=s===this.active_sheet;s.cells.IterateAll((s=>{if(s.ValueIsFormula()){const r=this.PatchFormulasInternal(s.value||"",e.before_row,e.count,0,0,t,i);r&&(s.value=r)}}));for(const r of s.annotations)if(r.formula){const s=this.PatchFormulasInternal(r.formula||"",e.before_row,e.count,0,0,t,i);s&&(r.formula=s)}}const s=[],i=[];if(e.count>0){const t=this.layout.CellAddressToRectangle({row:e.before_row,column:0}),r=this.layout.default_row_height*e.count+1;for(const e of this.active_sheet.annotations)if(e.scaled_rect){if(t.top>=e.scaled_rect.bottom)continue;t.top<=e.scaled_rect.top?e.scaled_rect.top+=r-1:(e.scaled_rect.height+=r,i.push(e)),e.layout=this.layout.RectToAnnotationLayout(e.scaled_rect),s.push(e)}}else if(e.count<0){let t=this.layout.CellAddressToRectangle({row:e.before_row,column:0});e.count<-1&&(t=t.Combine(this.layout.CellAddressToRectangle({row:e.before_row-e.count-1,column:0})));for(const e of this.active_sheet.annotations)if(e.scaled_rect){if(e.scaled_rect.bottom<=t.top)continue;if(e.scaled_rect.top>=t.bottom-1)e.scaled_rect.top-=t.height;else if(e.scaled_rect.top<=t.top&&e.scaled_rect.bottom>=t.bottom)e.scaled_rect.height=Math.max(e.scaled_rect.height-t.height,10),i.push(e);else{if(e.scaled_rect.top>=t.top&&e.scaled_rect.bottom<=t.bottom)continue;if(e.scaled_rect.top>=t.top&&e.scaled_rect.bottom>t.bottom){const s=e.scaled_rect.top-t.top+1,r=t.height-s;e.scaled_rect.top-=s,e.scaled_rect.height=Math.max(e.scaled_rect.height-r,10),i.push(e)}else if(e.scaled_rect.top<t.top&&e.scaled_rect.bottom<=t.bottom){const s=e.scaled_rect.bottom-t.top;e.scaled_rect.height=Math.max(e.scaled_rect.height-s,10),i.push(e)}else console.info("unhandled case")}e.layout=this.layout.RectToAnnotationLayout(e.scaled_rect),s.push(e)}}if(e.count<0)for(const e of this.AllSelections())e.empty=!0;else for(const t of this.AllSelections())t.target.row>=e.before_row&&(t.target.row+=e.count),t.area.entire_column||(t.area.start.row>=e.before_row?t.area.Shift(e.count,0):t.area.end.row>=e.before_row&&t.area.ConsumeAddress({row:t.area.end.row+e.count,column:t.area.end.column}));if(this.QueueLayoutUpdate(),this.Repaint(),s.length){this.layout.UpdateAnnotation(s);for(const e of i)e.resize_callback&&e.resize_callback.call(void 0)}}InsertColumnsInternal(e){if(!this.active_sheet.InsertColumns(e.before_column,e.count))return void this.Error("You can't change part of an array.");this.model.named_ranges.PatchNamedRanges(e.before_column,e.count,0,0);const t=this.active_sheet.name.toLowerCase();for(const s of this.model.sheets){const i=s===this.active_sheet;s.cells.IterateAll((s=>{if(s.ValueIsFormula()){const r=this.PatchFormulasInternal(s.value||"",0,0,e.before_column,e.count,t,i);r&&(s.value=r)}}));for(const r of s.annotations)if(r.formula){const s=this.PatchFormulasInternal(r.formula,0,0,e.before_column,e.count,t,i);s&&(r.formula=s)}}const s=[],i=[];if(e.count>0){const t=this.layout.CellAddressToRectangle({row:0,column:e.before_column}),r=this.layout.default_column_width*e.count+1;for(const e of this.active_sheet.annotations)if(e.scaled_rect){if(t.left>=e.scaled_rect.right)continue;t.left<=e.scaled_rect.left?e.scaled_rect.left+=r-1:(e.scaled_rect.width+=r,i.push(e)),e.layout=this.layout.RectToAnnotationLayout(e.scaled_rect),s.push(e)}}else if(e.count<0){let t=this.layout.CellAddressToRectangle({row:0,column:e.before_column});e.count<-1&&(t=t.Combine(this.layout.CellAddressToRectangle({row:0,column:e.before_column-e.count-1})));for(const e of this.active_sheet.annotations)if(e.scaled_rect){if(e.scaled_rect.right<=t.left)continue;if(e.scaled_rect.left>=t.right-1)e.scaled_rect.left-=t.width;else if(e.scaled_rect.left<=t.left&&e.scaled_rect.right>=t.right)e.scaled_rect.width=Math.max(e.scaled_rect.width-t.width,10),i.push(e);else{if(e.scaled_rect.left>=t.left&&e.scaled_rect.right<=t.right)continue;if(e.scaled_rect.left>=t.left&&e.scaled_rect.right>t.right){const s=e.scaled_rect.left-t.left+1,r=t.width-s;e.scaled_rect.left-=s,e.scaled_rect.width=Math.max(e.scaled_rect.width-r,10),i.push(e)}else if(e.scaled_rect.left<t.left&&e.scaled_rect.right<=t.right){const s=e.scaled_rect.right-t.left;e.scaled_rect.width=Math.max(e.scaled_rect.width-s,10),i.push(e)}else console.info("unhandled case")}e.layout=this.layout.RectToAnnotationLayout(e.scaled_rect),s.push(e)}}if(e.count<0)for(const e of this.AllSelections())e.empty=!0;else for(const t of this.AllSelections())t.target.column>=e.before_column&&(t.target.column+=e.count),t.area.entire_row||(t.area.start.column>=e.before_column?t.area.Shift(0,e.count):t.area.end.column>=e.before_column&&t.area.ConsumeAddress({row:t.area.end.row,column:t.area.end.column+e.count}));if(this.QueueLayoutUpdate(),this.Repaint(),s.length){this.layout.UpdateAnnotation(s);for(const e of i)e.resize_callback&&e.resize_callback.call(void 0)}}ApplyBordersInternal(e){const t=e.borders,s=e.borders===De.None?0:e.width,i=new r(e.area.start,e.area.end);let o=this.active_sheet;if(e.area.start.sheet_id&&e.area.start.sheet_id!==this.active_sheet.id)for(const t of this.model.sheets)if(t.id===e.area.start.sheet_id){o=t;break}const a={border_top:s},n={border_bottom:s},l={border_left:s},h={border_right:s};return e.color&&(a.border_top_fill=Object.assign({},e.color),n.border_bottom_fill=Object.assign({},e.color),l.border_left_fill=Object.assign({},e.color),h.border_right_fill=Object.assign({},e.color)),t!==De.None&&t!==De.All||o.UpdateAreaStyle(i,Object.assign(Object.assign(Object.assign(Object.assign({},a),n),l),h),!0),t!==De.Top&&t!==De.Outside||i.entire_column||o.UpdateAreaStyle(i.top,Object.assign({},a),!0),t!==De.None&&t!==De.All&&t!==De.Outside&&t!==De.Top||i.entire_column||i.start.row&&o.UpdateAreaStyle(new r({row:i.start.row-1,column:i.start.column},{row:i.start.row-1,column:i.end.column}),Object.assign({},{border_bottom:0}),!0),t!==De.Bottom&&t!==De.Outside||i.entire_column||o.UpdateAreaStyle(i.bottom,Object.assign({},n),!0),t!==De.None&&t!==De.All&&t!==De.Outside&&t!==De.Bottom||i.entire_column||o.UpdateAreaStyle(new r({row:i.end.row+1,column:i.start.column},{row:i.end.row+1,column:i.end.column}),Object.assign({},{border_top:0}),!0),t!==De.Left&&t!==De.Outside||i.entire_row||o.UpdateAreaStyle(i.left,Object.assign({},l),!0),t!==De.None&&t!==De.All&&t!==De.Outside&&t!==De.Left||i.entire_row||i.start.column&&o.UpdateAreaStyle(new r({row:i.start.row,column:i.start.column-1},{row:i.end.row,column:i.start.column-1}),Object.assign({},{border_right:0}),!0),t!==De.Right&&t!==De.Outside||i.entire_row||o.UpdateAreaStyle(i.right,Object.assign({},h),!0),t!==De.None&&t!==De.All&&t!==De.Outside&&t!==De.Right||i.entire_row||o.UpdateAreaStyle(new r({row:i.start.row,column:i.end.column+1},{row:i.end.row,column:i.end.column+1}),Object.assign({},{border_left:0}),!0),r.Bleed(i)}SetRangeInternal(e){const t=i(e.area)?new r(e.area):new r(e.area.start,e.area.end);let s=this.active_sheet;if(t.start.sheet_id&&t.start.sheet_id!==this.active_sheet.id)for(const e of this.model.sheets)if(e.id===t.start.sheet_id){s=e;break}if(t.entire_row||t.entire_column||!(t.end.row>=s.rows||t.end.column>=s.columns)||(s.cells.EnsureCell(t.end),this.QueueLayoutUpdate()),i(e.area)){const i=s.CellData(e.area);if(i.area&&(i.area.rows>1||i.area.columns>1))return void this.Error("You can't change part of an array.");const r=Array.isArray(e.value)?Array.isArray(e.value[0])?e.value[0][0]:e.value[0]:e.value;return e.array?s.SetArrayValue(t,r):s.SetCellValue(e.area,r),t}if(e.array){const i=Array.isArray(e.value)?Array.isArray(e.value[0])?e.value[0][0]:e.value[0]:e.value;s.SetArrayValue(t,i)}else s.SetAreaValues2(t,e.value);return t}ClearAreaInternal(e){let t=!1;e=this.active_sheet.RealArea(e),this.active_sheet.cells.Apply(e,(s=>{s.area&&!e.ContainsArea(s.area)&&(t=!0)})),t?this.Error("You can't change part of an array."):this.active_sheet.ClearArea(e)}ExecCommand(e){let t,s,o,a=!1,n=!1;const l=[];Array.isArray(e)||(e=[e]),this.command_log.Publish({command:e,timestamp:(new Date).getTime()});for(const l of e)switch(l.key){case ze.Clear:if(l.area){const e=new r(l.area.start,l.area.end);this.ClearAreaInternal(e),s=r.Join(e,s),this.UpdateFormulaBarFormula()}else me.Reset(),this.RemoveAnnotationNodes(),this.UpdateSheets([],!0),this.model.named_ranges.Reset(),this.model.macro_functions={},this.ClearSelection(this.primary_selection),this.ScrollIntoView({row:0,column:0}),this.QueueLayoutUpdate(),this.layout.HideNote();break;case ze.Select:l.area?(l.area.start.sheet_id&&l.area.start.sheet_id!==this.active_sheet.id&&this.ActivateSheetInternal({key:ze.ActivateSheet,id:l.area.start.sheet_id}),this.Select(this.primary_selection,new r(l.area.start,l.area.end)),this.RenderSelections()):this.ClearSelection(this.primary_selection);break;case ze.Freeze:this.FreezeInternal(l),a=!0;break;case ze.MergeCells:this.active_sheet.MergeCells(new r(l.area.start,l.area.end)),t=r.Join(l.area,t),a=!0,n=!0,s=r.Join(l.area,s);break;case ze.UnmergeCells:{const e={},i=new r(l.area.start,l.area.end);this.active_sheet.cells.Apply(i,(t=>{if(t.merge_area){const s=r.CellAddressToLabel(t.merge_area.start)+":"+r.CellAddressToLabel(t.merge_area.end);e[s]=t.merge_area}}),!1);const o=Object.keys(e);for(let t=0;t<o.length;t++)this.active_sheet.UnmergeCells(e[o[t]]);t=r.Join(l.area,t),s=r.Join(l.area,s),a=!0,n=!0}break;case ze.UpdateStyle:{let e,s=this.active_sheet;if(i(l.area)){if(e=new r(l.area),e.start.sheet_id&&e.start.sheet_id!==this.active_sheet.id)for(const t of this.model.sheets)if(t.id===e.start.sheet_id){s=t;break}s.UpdateCellStyle(l.area,l.style,!!l.delta)}else{if(e=new r(l.area.start,l.area.end),e.start.sheet_id&&e.start.sheet_id!==this.active_sheet.id)for(const t of this.model.sheets)if(t.id===e.start.sheet_id){s=t;break}s.UpdateAreaStyle(e,l.style,!!l.delta)}s===this.active_sheet&&(o=r.Join(e,o),(!l.delta||l.style.fill||l.style.border_top||l.style.border_left||l.style.border_right||l.style.border_bottom)&&(e=r.Bleed(e),this.active_sheet.Invalidate(e)),t=r.Join(e,t))}break;case ze.DataValidation:this.SetValidationInternal(l),t=r.Join(new r(l.target),t);break;case ze.SetName:l.area?(this.model.named_ranges.SetName(l.name,new r(l.area.start,l.area.end)),this.autocomplete_matcher.AddFunctions({type:ye.Token,name:l.name})):(this.model.named_ranges.ClearName(l.name),this.autocomplete_matcher.RemoveFunctions({type:ye.Token,name:l.name})),a=!0,n=!0;break;case ze.UpdateBorders:{const e=this.ApplyBordersInternal(l);t=r.Join(e,t),o=r.Join(e,o)}break;case ze.ShowSheet:this.ShowSheetInternal(l),a=!0;break;case ze.ReorderSheet:{const e=[],t=this.model.sheets[l.index];for(let s=0;s<this.model.sheets.length;s++)s!==l.index&&(s===l.move_before&&e.push(t),e.push(this.model.sheets[s]));l.move_before>=this.model.sheets.length&&e.push(t),this.model.sheets=e,this.tab_bar&&this.tab_bar.Update(),a=!0}break;case ze.RenameSheet:{const e=this.ResolveSheet(l);e&&(this.RenameSheetInternal(e,l.new_name),this.tab_bar&&this.tab_bar.Update(),a=!0)}break;case ze.ResizeRows:{let e=l.row;if(void 0===e){e=[];for(let t=0;t<this.active_sheet.rows;t++)e.push(t)}if("number"==typeof e&&(e=[e]),"number"==typeof l.height)for(const t of e)this.layout.SetRowHeight(t,l.height);else{const t="boolean"!=typeof l.shrink||l.shrink;for(const s of e)this.active_sheet.AutoSizeRow(s,this.theme.grid_cell,t)}this.layout.UpdateTotalSize(),this.layout.container&&this.layout.container.offsetHeight&&this.layout.container.offsetHeight>this.layout.total_height?this.UpdateLayout():(this.layout.UpdateTileHeights(!0),this.render_tiles=this.layout.VisibleTiles(),this.Repaint(!1,!0)),this.layout.UpdateAnnotation(this.active_sheet.annotations),a=!0,this.RenderSelections()}break;case ze.ResizeColumns:{let e=l.column;if(void 0===e){e=[];for(let t=0;t<this.active_sheet.columns;t++)e.push(t)}if("number"==typeof e&&(e=[e]),"number"==typeof l.width)for(const t of e)this.layout.SetColumnWidth(t,l.width);else for(const t of e)this.active_sheet.AutoSizeColumn(t,!1);this.layout.UpdateTotalSize(),this.layout.container&&this.layout.container.offsetWidth&&this.layout.container.offsetWidth>this.layout.total_width?this.UpdateLayout():(this.layout.UpdateTileWidths(!0),this.render_tiles=this.layout.VisibleTiles(),this.Repaint(!1,!0)),this.layout.UpdateAnnotation(this.active_sheet.annotations),a=!0,this.RenderSelections()}break;case ze.ShowHeaders:this.active_sheet.SetHeaderSize(l.show?void 0:1,l.show?void 0:1),this.QueueLayoutUpdate(),this.Repaint();break;case ze.InsertRows:this.InsertRowsInternal(l),a=!0,n=!0;break;case ze.InsertColumns:this.InsertColumnsInternal(l),a=!0,n=!0;break;case ze.SetLink:case ze.SetNote:{let e=this.active_sheet;if(l.address.sheet_id)for(const t of this.model.sheets)if(t.id===l.address.sheet_id){e=t;break}let s=e.cells.GetCell(l.address,!0);if(s){let i;s.merge_area?(i=new r(s.merge_area.start),s=e.cells.GetCell(s.merge_area.start,!0)):i=new r(l.address),l.key===ze.SetNote?s.SetNote(l.note):(s.hyperlink=l.reference||void 0,s.render_dirty=!0),e===this.active_sheet&&this.DelayedRender(!1,i),o=r.Join(i,o),t=r.Join(i,t)}}break;case ze.SetRange:{const e=this.SetRangeInternal(l);e&&(s=r.Join(e,s),this.options.repaint_on_cell_change&&(t=r.Join(e,t)))}break;case ze.DeleteSheet:this.DeleteSheetInternal(l),a=!0,n=!0;break;case ze.DuplicateSheet:this.DuplicateSheetInternal(l),a=!0,n=!0;break;case ze.AddSheet:this.ActivateSheetInternal({key:ze.ActivateSheet,id:this.AddSheetInternal(l.name,l.insert_index)}),a=!0;break;case ze.ActivateSheet:this.ActivateSheetInternal(l);break;default:console.warn(`unhandled command: ${ze[l.key]} (${l.key})`)}s&&(s.start.sheet_id||s.SetSheetID(this.active_sheet.id),l.push({type:"data",area:s})),o&&(o.start.sheet_id||o.SetSheetID(this.active_sheet.id),l.push({type:"style",area:o})),a&&l.push({type:"structure",rebuild_required:n}),this.batch?this.batch_events.push(...l):(this.grid_events.Publish(l),t&&this.DelayedRender(!1,t))}}!function(e){e[e.white=0]="white",e[e.gray=1]="gray",e[e.black=2]="black"}(Pe||(Pe={}));class je{constructor(){this.type=je.type,this.color=Pe.white,this.edges_in=[],this.edges_out=[]}get has_inbound_edges(){return this.edges_in.length>0}get has_outbound_edges(){return this.edges_out.length>0}Reset(){for(const e of this.edges_out)e.RemoveDependency(this);for(const e of this.edges_in)e.RemoveDependent(this);this.edges_out=[],this.edges_in=[]}ClearDependencies(){for(const e of this.edges_in)e.RemoveDependent(this);this.edges_in=[]}AddDependent(e){if(e!==this){for(const t of this.edges_out)if(t===e)return;this.edges_out.push(e)}}RemoveDependent(e){this.edges_out=this.edges_out.filter((t=>t!==e))}AddDependency(e){if(e!==this){for(const t of this.edges_in)if(t===e)return;this.edges_in.push(e)}}RemoveDependency(e){this.edges_in=this.edges_in.filter((t=>t!==e))}LinkTo(e){this.AddDependent(e),e.AddDependency(this)}DependsOn(e){this.AddDependency(e),e.AddDependent(this)}LoopCheck(){this.color=Pe.gray;const e=[this];for(;e.length;){const t=e[e.length-1];let s=!0;if(t.color!==Pe.black)for(const i of t.edges_out){if(i.color===Pe.gray)return this.color=Pe.white,!0;i.color===Pe.white&&(i.color=Pe.gray,e.push(i),s=!1)}s&&(e.pop(),t.color=Pe.black)}return this.color=Pe.black,!1}}je.type="vertex";class Ge extends je{constructor(){super(...arguments),this.dirty=!1}}!function(e){e[e.None=0]="None",e[e.CalculationError=1]="CalculationError"}(Fe||(Fe={}));class Be extends Ge{constructor(){super(...arguments),this.error=Fe.None,this.result={type:a.undefined},this.expression={type:"missing",id:-1},this.expression_error=!1,this.short_circuit=!1,this.type=Be.type}get array_head(){return!!this.address&&!!this.reference&&!!this.reference.area&&this.reference.area.start.column===this.address.column&&this.reference.area.start.row===this.address.row}TakeReferenceValue(){this.reference&&(this.result=y(this.reference.GetValue()))}Calculate(e){if(this.dirty)if(this.color===Pe.white&&this.LoopCheck()&&(this.dirty=!1,this.edges_in.length)){this.reference&&(this.array_head||this.reference.type===a.formula)&&this.reference.SetCalculationError("LOOP");for(const t of this.edges_out)t.Calculate(e)}else{for(const e of this.edges_in)if(e.dirty)return;if(this.reference){if(this.reference.type===a.formula){this.short_circuit=!1;const t=e.CalculationCallback.call(e,this);if(this.result=t.value,this.short_circuit)return;t.volatile&&e.volatile_list.push(this)}else this.result=this.reference.GetValue4();if(this.array_head)e.SpreadCallback.call(e,this,this.result);else if(this.reference.type===a.formula){const e=this.result.type===a.array?this.result.value[0][0]:this.result;this.reference.SetCalculatedValue(e.value,e.type)}}else console.info("skip dirty constant? [or dangling...]");this.dirty=!1;for(const t of this.edges_out)t.dirty&&e.calculation_list.push(t)}}}Be.type="spreadsheet-vertex";class Ze extends Ge{constructor(e){super(),this.type=Ze.type,this.area=e.Clone(),Ze.list.push(this)}static GetVertex(e){for(const t of this.list)if(t.area.start.sheet_id===e.start.sheet_id&&t.area.Equals(e))return[t,!1];return[new Ze(e),!0]}static Clear(){this.list=[]}static GetContainingArrays(e){const t=[];for(const s of this.list)s.area.start.sheet_id===e.sheet_id&&s.area.Contains(e)&&t.push(s);return t}static CreateImplicitEdges(e,t){for(const s of this.list)s.area.start.sheet_id===t.sheet_id&&s.area.Contains(t)&&s.DependsOn(e)}RemoveDependent(e){super.RemoveDependent(e),this.edges_out.length||(this.Reset(),Ze.list=Ze.list.filter((e=>e!==this)))}Calculate(e){if(this.dirty)if(this.color===Pe.white&&this.LoopCheck()&&(this.dirty=!1,this.edges_in.length))for(const t of this.edges_out)t.Calculate(e);else{for(const e of this.edges_in)if(e.dirty)return;this.dirty=!1;for(const t of this.edges_out)t.Calculate(e)}}}Ze.type="array-vertex",Ze.list=[],(Ue=Ie||(Ie={}))[Ue.OK=0]="OK",Ue[Ue.Loop=1]="Loop",Ue[Ue.CalculationError=2]="CalculationError",function(e){e.Argument="ARG",e.Data="DATA",e.Reference="REF",e.Name="NAME",e.Expression="EXPR",e.Value="VALUE",e.Unknown="UNK",e.NotImpl="NOTIMPL",e.Div0="DIV/0",e.NA="N/A"}(Oe||(Oe={}));const Je={error:Oe.NotImpl},qe=()=>({type:a.error,value:Oe.Expression}),We=()=>({type:a.error,value:Oe.Data}),Xe=()=>({type:a.error,value:Oe.Div0}),Ke=()=>({type:a.error,value:Oe.Argument}),Ye=()=>({type:a.error,value:Oe.Value}),Qe=()=>({type:a.error,value:Oe.Reference}),et=()=>({type:a.error,value:Oe.Name}),tt=()=>({type:a.error,value:Oe.Unknown});var st;!function(e){e[e.value=0]="value",e[e.reference=1]="reference"}(st||(st={}));const it=e=>({r:Math.sqrt(e.real*e.real+e.imaginary*e.imaginary),theta:Math.atan2(e.imaginary,e.real)}),rt=(e,t)=>({real:e.real*t.real-e.imaginary*t.imaginary,imaginary:e.real*t.imaginary+e.imaginary*t.real}),ot=(e,t)=>{const s=[];for(let i=0;i<e.m;i++){const r=[];for(let s=0;s<t.n;s++){let o=0;for(let r=0;r<e.n;r++)o+=e.array[i][r]*t.array[r][s];r.push(o)}s.push(r)}return{array:s,m:e.m,n:t.n}},at=e=>{const t={real:0,imaginary:0},s=e.n;if(2==s){const t=rt(e.array[0][0],e.array[1][1]),s=rt(e.array[1][0],e.array[0][1]);return{real:t.real-s.real,imaginary:t.imaginary-s.imaginary}}const i=(e=>{const t={m:e,n:e,array:[]};for(let s=0;s<e;s++){const s=[];for(let t=0;t<e;t++)s.push({real:0,imaginary:0});t.array.push(s)}return t})(e.n);for(let r=0;r<s;r++){let o=0;for(let t=1;t<s;t++){let a=0;for(let n=0;n<s;n++)n!=r&&(i.array[o][a]=Object.assign({},e.array[t][n]),a++);o++}i.m=i.n=s-1;const a=Math.pow(-1,r),n=rt({real:e.array[0][r].real*a,imaginary:e.array[0][r].imaginary*a},at(i));t.real+=n.real,t.imaginary+=n.imaginary}return t},nt=e=>{if(e.m!==e.n)return;const t=(e=>{const t=e.array.map((e=>e.slice(0)));return{m:e.m,n:e.n,array:t}})(e),s=t.array;var i,r,o,a,n=e.m;for(r=1;r<n;r++)s[0][r]/=s[0][0];for(r=1;r<n;r++){for(o=r;o<n;o++){for(i=0,a=0;a<r;a++)i+=s[o][a]*s[a][r];s[o][r]-=i}if(r!=n-1)for(o=r+1;o<n;o++){for(i=0,a=0;a<r;a++)i+=s[r][a]*s[a][o];s[r][o]=(s[r][o]-i)/s[r][r]}}for(r=0;r<n;r++)for(o=r;o<n;o++){var l=1;if(r!=o)for(l=0,a=r;a<o;a++)l-=s[o][a]*s[a][r];s[o][r]=l/s[o][o]}for(r=0;r<n;r++)for(o=r;o<n;o++)if(r!=o){for(i=0,a=r;a<o;a++)i+=s[a][o]*(r==a?1:s[r][a]);s[r][o]=-i}for(r=0;r<n;r++)for(o=0;o<n;o++){for(i=0,a=r>o?r:o;a<n;a++)i+=(o==a?1:s[o][a])*s[a][r];s[o][r]=i}return t},lt=e=>{const t=e.real||0,s=e.imaginary||0;return rt({real:Math.exp(t),imaginary:0},{real:Math.cos(s),imaginary:Math.sin(s)})},ht=(e,t)=>{if(t.imaginary)return lt(rt(t,(e=>{const t=it(e);return{real:Math.log(t.r),imaginary:t.theta}})(e)));{const s=it(e);return(e=>{const{r:t,theta:s}=e;return{real:t*Math.cos(s),imaginary:t*Math.sin(s)}})({r:Math.pow(s.r,t.real),theta:s.theta*t.real})}},ct=(e,t=0)=>e&&e.type===a.complex?e:{type:a.complex,value:{real:t,imaginary:0}},dt=e=>e.imaginary?{type:a.complex,value:e}:{type:a.number,value:e.real},ut=(e,t)=>{if(e.type===a.error)return[0,0,e];if(t.type===a.error)return[0,0,t];const s=[0,0];switch(e.type){case a.number:s[0]=e.value;break;case a.boolean:s[0]=e.value?1:0;break;case a.undefined:break;case a.complex:s[3]=e;break;default:return[0,0,Ye()]}switch(t.type){case a.number:s[1]=t.value;break;case a.boolean:s[1]=t.value?1:0;break;case a.undefined:break;case a.complex:s[4]=t;break;default:return[0,0,Ye()]}return(s[3]||s[4])&&(s[3]=ct(s[3],s[0]),s[4]=ct(s[4],s[1])),s},mt=(e,t)=>{let[s,i,r,o,n]=ut(e,t);return r||(o&&n?dt({real:o.value.real+n.value.real,imaginary:o.value.imaginary+n.value.imaginary}):{value:s+i,type:a.number})},ft=(e,t)=>{let[s,i,r,o,n]=ut(e,t);return r||(o&&n?dt({real:o.value.real-n.value.real,imaginary:o.value.imaginary-n.value.imaginary}):{value:s-i,type:a.number})},pt=(e,t)=>{let[s,i,r,o,n]=ut(e,t);if(r)return r;if(o&&n)return dt(ht(o.value,n.value));const l=Math.pow(s,i);return isNaN(l)?Ye():{type:a.number,value:l}},_t=(e,t)=>{let[s,i,r,o,n]=ut(e,t);return r||(o&&n?dt(rt(o.value,n.value)):{value:s*i,type:a.number})},gt=(e,t)=>{let[s,i,r,o,n]=ut(e,t);return r||(o&&n?0===n.value.real&&0===n.value.imaginary?Xe():dt(((e,t)=>{const s={real:t.real,imaginary:-t.imaginary},i=rt(e,s),r=rt(t,s);return{real:i.real/r.real,imaginary:i.imaginary/r.real}})(o.value,n.value)):0===i?Xe():{value:s/i,type:a.number})},yt=(e,t)=>{const[s,i,r]=ut(e,t);return r||(0===i?Xe():{value:s%i,type:a.number})},vt=(e,t)=>e.type===a.error?e:t.type===a.error?t:{type:a.string,value:`${e.type===a.undefined?"":e.value}${t.type===a.undefined?"":t.value}`},bt=(e,t)=>{if(e.type===a.error)return e;if(t.type===a.error)return t;if(e.type===a.undefined&&(""===t.value||0===t.value||t.type===a.complex&&0===t.value.real&&0===t.value.imaginary)||t.type===a.undefined&&(""===e.value||0===e.value||e.type===a.complex&&0===e.value.real&&0===e.value.imaginary))return{type:a.boolean,value:!0};if(e.type===a.complex||t.type===a.complex){let s=!1;return e.type===t.type?s=e.value.real==t.value.real&&e.value.imaginary==t.value.imaginary:e.type===a.number?s=t.value.real==e.value&&!t.value.imaginary:t.type===a.number&&(s=e.value.real==t.value&&!e.value.imaginary),{type:a.boolean,value:s}}return{type:a.boolean,value:e.value==t.value}},wt=(e,t)=>{const s=bt(e,t);return{type:a.boolean,value:!s.value}},xt=(e,t)=>e.type===a.error?e:t.type===a.error?t:e.type===a.complex||t.type===a.complex?Ye():{type:a.boolean,value:(e.value||0)>(t.value||0)},Ct=(e,t)=>e.type===a.error?e:t.type===a.error?t:e.type===a.complex||t.type===a.complex?Ye():{type:a.boolean,value:e.value>=t.value},St=(e,t)=>e.type===a.error?e:t.type===a.error?t:e.type===a.complex||t.type===a.complex?Ye():{type:a.boolean,value:e.value<t.value},At=(e,t)=>e.type===a.error?e:t.type===a.error?t:e.type===a.complex||t.type===a.complex?Ye():{type:a.boolean,value:e.value<=t.value},Mt=e=>!Array.isArray(e)&&e.type===a.object&&!!e.value.type,kt=e=>e.type===a.object&&"metadata"===e.key;class Rt{constructor(e,t){this.library=e,this.parser=t,this.context={address:{row:-1,column:-1},volatile:!1,call_index:0},this.call_index=0,this.cells_map={},this.sheet_name_map={},this.named_range_map={}}SetModel(e){this.cells_map={},this.sheet_name_map={};for(const t of e.sheets)this.cells_map[t.id]=t.cells,this.sheet_name_map[t.name.toLowerCase()]=t.id;this.data_model=e,this.named_range_map=e.named_ranges.Map(),this.context.model=e}Calculate(e,t,s=!1){return s||(this.context.address=t,this.context.volatile=!1,this.context.call_index=0,this.call_index=0),{value:this.CalculateExpression(e),volatile:this.context.volatile}}CellFunction2(e){if(!e.sheet_id){if(!e.sheet)return()=>Qe();e.sheet_id=this.sheet_name_map[e.sheet.toLowerCase()]}const t=this.cells_map[e.sheet_id];if(!t)return console.warn("missing cells reference @ "+e.sheet_id),()=>Qe();const s=t.GetCell(e);return s?()=>s.GetValue4():()=>({type:a.undefined,value:void 0})}CellFunction4(e,t){if(!e.sheet_id)throw new Error("missing sheet id in CellFunction4");return this.cells_map[e.sheet_id].GetRange4(e,t,!0)}GetMetadata(e,t){let s,i;switch(e.type){case"address":s=e;break;case"range":i=e;break;case"identifier":{const t=this.named_range_map[e.name.toUpperCase()];t&&(1===t.count?s=t.start:i=t)}break;case"call":{const t=this.CalculateExpression(e,!0);if(!Mt(t))return t;if("address"===t.value.type)s=t.value;else{if("range"!==t.value.type)return t;i=t.value}}break;default:return this.CalculateExpression(e)}if(s){let e=this.data_model.active_sheet;if(s.sheet_id&&s.sheet_id!==e.id)for(const t of this.data_model.sheets)if(t.id===s.sheet_id){e=t;break}const i=e.CellData(s),r=i.calculated_type?i.calculated:i.value,o=Object.assign({type:"metadata",address:Object.assign({},s),value:r,format:i.style?i.style.number_format:void 0},t(i,s));return{type:a.object,value:o,key:"metadata"}}if(i){if(i.start.row===1/0||i.start.column===1/0)return Qe();let e=this.data_model.active_sheet;if(i.start.sheet_id&&i.start.sheet_id!==e.id)for(const t of this.data_model.sheets)if(t.id===i.start.sheet_id){e=t;break}const r=[];for(let o=i.start.column;o<=i.end.column;o++){const n=[];for(let r=i.start.row;r<=i.end.row;r++){const l=e.CellData({row:r,column:o});s=Object.assign(Object.assign({},i.start),{row:r,column:o});const h=l.calculated_type?l.calculated:l.value,c=Object.assign({type:"metadata",address:s,value:h,format:l.style?l.style.number_format:void 0},t(l,s));n.push({type:a.object,value:c,key:"metadata"})}r.push(n)}return{type:a.array,value:r}}return this.CalculateExpression(e)}RewriteMacro(e,t){let s;switch(e.type){case"identifier":if(s=t[e.name.toUpperCase()],s)return JSON.parse(JSON.stringify(s));break;case"binary":e.left=this.RewriteMacro(e.left,t),e.right=this.RewriteMacro(e.right,t);break;case"unary":e.operand=this.RewriteMacro(e.operand,t);break;case"group":e.elements=e.elements.map((e=>this.RewriteMacro(e,t)));break;case"call":e.args=e.args.map((e=>this.RewriteMacro(e,t)))}return e}CallMacro(e,t){var s;if(!t.expression)return()=>qe();const i=JSON.stringify(t.expression),r={},o=(null===(s=t.argument_names)||void 0===s?void 0:s.map((e=>e.toUpperCase())))||[];return e=>{const t=JSON.parse(i);for(let t=0;t<o.length;t++)r[o[t]]=e.args[t]||{type:"missing"};return this.CalculateExpression(this.RewriteMacro(t,r))}}CallExpression(e,t=!1){const s=this.library.Get(e.name);return s?i=>{const r=this.call_index++;this.context.volatile=this.context.volatile||!!s.volatile;const o="if"===e.name.toLowerCase();let n,l=-1;const h=s.arguments||[],c=i.args.map(((e,t)=>{if(n)return;const s=h[Math.min(t,h.length-1)]||{};if(t===l)return s.boxed?{type:a.undefined}:void 0;if(void 0===e)return o&&0===t&&(l=1),s.boxed?{type:a.undefined}:void 0;if(s.address)return s.boxed?{type:a.string,value:this.parser.Render(e).replace(/\$/g,"")}:this.parser.Render(e).replace(/\$/g,"");if(s.metadata)return this.GetMetadata(e,(()=>({})));{const i=this.CalculateExpression(e);if(i.type===a.error)return s.allow_error?i:void(n=i);if(o&&0===t&&i.type!==a.array){let e=!1;if(i.type===a.string){const t=i.value.toLowerCase().trim();e="false"!==t&&"f"!==t}else e=!!i.value;l=e?2:1}return s.boxed?i:i.type===a.array?i.value.map((e=>e.map((e=>e.value)))):i.value}}));if(n)return n;if(this.context.call_index=r,s.return_type===st.reference){const e=s.fn.apply(null,c);if(t)return e;if(Mt(e)){if("address"===e.value.type)return this.CellFunction2(e.value)();if("range"===e.value.type)return this.CellFunction4(e.value.start,e.value.end)}return e}return s.fn.apply(null,c)}:()=>et()}UnaryExpression(e){switch(e.operator){case"+":return e=>this.CalculateExpression(e.operand);case"-":{const e=ft,t={type:a.number,value:0};return s=>{const i=this.CalculateExpression(s.operand);return i.type===a.array?{type:a.array,value:i.value.map((s=>s.map((s=>e(t,s)))))}:e(t,i)}}default:return()=>(console.warn("unexpected unary operator:",e.operator),qe())}}RecycleArray(e,t,s){if(e[0].length<s){const t=e[0].length;for(const i of e)for(let e=t;e<s;e++)i[e]=i[e%t]}if(e.length<t){const s=e.length;for(let i=s;i<t;i++)e[i]=e[i%s].slice(0)}return e}ElementwiseBinaryExpression(e,t,s){const i=Math.max(t.value.length,s.value.length),r=Math.max(t.value[0].length,s.value[0].length),o=this.RecycleArray(t.value,i,r),n=this.RecycleArray(s.value,i,r),l=[];for(let t=0;t<i;t++){const s=[];for(let i=0;i<r;i++)s[i]=e(o[t][i],n[t][i]);l.push(s)}return{type:a.array,value:l}}BinaryExpression(e){const t=(e=>{switch(e){case"&":return vt;case"+":return mt;case"-":return ft;case"*":return _t;case"/":return gt;case"^":case"**":return pt;case"%":return yt;case"=":case"==":return bt;case"!=":case"<>":return wt;case">":return xt;case">=":return Ct;case"<":return St;case"<=":return At}})(e.operator);return t?e=>{const s=this.CalculateExpression(e.left),i=this.CalculateExpression(e.right);return s.type===a.array?i.type===a.array?this.ElementwiseBinaryExpression(t,s,i):this.ElementwiseBinaryExpression(t,s,{type:a.array,value:[[i]]}):i.type===a.array?this.ElementwiseBinaryExpression(t,{type:a.array,value:[[s]]},i):t(s,i)}:()=>(console.info(`(unexpected binary operator: ${e.operator})`),qe())}Identifier(e){const t=e.name,s=t.toUpperCase();switch(s){case"FALSE":case"F":return()=>({value:!1,type:a.boolean});case"TRUE":case"T":return()=>({value:!0,type:a.boolean});case"UNDEFINED":return()=>({value:void 0,type:a.undefined})}return()=>{const e=this.named_range_map[s];return e?1===e.count?this.CellFunction4(e.start,e.start):this.CellFunction4(e.start,e.end):(console.info("** identifier",t),et())}}GroupExpression(e){return e.elements&&1===e.elements.length?e=>this.CalculateExpression(e.elements[0]):(console.warn("Can't handle group !== 1"),()=>qe())}CalculateExpression(e,t=!1){if(e.user_data)return e.user_data(e);switch(e.type){case"call":{const s=this.data_model.macro_functions[e.name.toUpperCase()];return s?(e.user_data=this.CallMacro(e,s))(e):(e.user_data=this.CallExpression(e,t))(e)}case"address":return(e.user_data=this.CellFunction2(e))();case"range":return(e.user_data=e=>this.CellFunction4(e.start,e.end))(e);case"binary":return(e.user_data=this.BinaryExpression(e))(e);case"unary":return(e.user_data=this.UnaryExpression(e))(e);case"identifier":return(e.user_data=this.Identifier(e))();case"missing":return(e.user_data=()=>({value:void 0,type:a.undefined}))();case"literal":{const t={value:e.value,type:n(e.value)};return(e.user_data=()=>t)()}case"group":return(e.user_data=this.GroupExpression(e))(e);case"complex":{const t={value:{real:e.real,imaginary:e.imaginary},type:a.complex};return(e.user_data=()=>t)()}case"array":return(e.user_data=()=>({type:a.array,value:e.values.map((e=>(Array.isArray(e)?e:[e]).map((e=>({type:n(e),value:e})))))}))();default:return console.warn("Unhandled parse expr:",e),tt()}}}const Lt=e=>{const t=[],s=e.length,i=e[0].length;for(let r=0;r<i;r++){t[r]=[];for(let i=0;i<s;i++)t[r][i]=e[i][r]}return t},Et=e=>{let t=[];for(const s of e)if(s.type===a.array)for(const e of s.value)t=t.concat(Et(e));else t.push(s);return t},Tt=e=>Array.isArray(e)?e.reduce(((e,t)=>void 0===t?e:Array.isArray(t)?e.concat(Tt(t)):t instanceof Float32Array||t instanceof Float64Array?e.concat(Array.from(t)):e.concat([t])),[]):[e],Dt=e=>(t,...s)=>Array.isArray(t)?(console.info("AAA 71823"),{type:a.array,value:t.map((t=>t.map((t=>e(t,...s)))))}):"object"==typeof t&&t&&t.type===a.array?{type:a.array,value:t.value.map((t=>t.map((t=>e(t,...s)))))}:e(t,...s),zt=e=>(t,s,...i)=>{let r=!1,o=!1;return t&&"object"==typeof t&&t.type===a.array?(t=t.value,r=!0):r=Array.isArray(t),s&&"object"==typeof s&&s.type===a.array?(s=s.value,o=!0):o=Array.isArray(s),r?o?{type:a.array,value:t.map(((t,r)=>t.map(((t,o)=>e(t,s[r][o],...i)))))}:{type:a.array,value:t.map((t=>t.map((t=>e(t,s,...i)))))}:o?{type:a.array,value:s.map((s=>s.map((s=>e(t,s,...i)))))}:e(t,s,...i)};class Nt{constructor(){this.functions={}}Register(...e){for(const t of e)for(const e of Object.keys(t)){if(/[^a-zA-Z0-9._]/.test(e))throw new Error("invalid function name (invalid character)");if(e.length>255)throw new Error("invalid function name (too long, > 255)");if(/^[^a-zA-Z]/.test(e))throw new Error("invalid function name (start with an ascii letter)");const s=e.toLowerCase();if(this.functions[s])throw new Error(`function name (${s}) is already in use`);const i=t[e];i.canonical_name=e,this.functions[s]=i}}Get(e){const t=e.toLowerCase();return this.functions[t]}List(){const e={};for(const t of Object.keys(this.functions))e[t]=this.functions[t];return e}Alias(e,t){const s=this.Get(t);if(!s)throw new Error(`referenced function ${t} does not exist`);this.Register({[e]:Object.assign({},s)})}}var Pt;!function(e){e[e.move=0]="move",e[e.line=1]="line"}(Pt||(Pt={}));class Ft{static UnpackValues(e){if(Array.isArray(e)){const t=e[0];return Array.isArray(t)||t instanceof Float64Array||t instanceof Float32Array?e.reduce(((e,t)=>e.concat(this.UnpackValues(t))),[]):e.map((e=>isNaN(e)?void 0:e))}if(e instanceof Float32Array||e instanceof Float64Array)return Array.prototype.slice.call(e);if(e&&"object"==typeof e){const t=Object.keys(e).length;if(void 0!==e[0]&&void 0!==e[(t-1).toString()]){const s=[];for(let i=0;i<t;i++)s[i]=e[i.toString()];return s}}return[]}static SparklineCommon(e,t){var s;let i=[];const r=(null===(s=t.text)||void 0===s?void 0:s.text)||this.default_color,o=[r,r];return Array.isArray(e.calculated)&&(i=this.UnpackValues(e.calculated[0]),"string"==typeof e.calculated[1]&&(o[0]=e.calculated[1]),"string"==typeof e.calculated[2]&&(o[1]=e.calculated[2])),{values:i,colors:o}}static RenderLine(e,t,s,i,r){const{values:o,colors:a}=this.SparklineCommon(i,r);let n=1;Array.isArray(i.calculated)&&"number"==typeof i.calculated[2]&&(n=i.calculated[2]);let l=0,h=0,c=-1;for(let e=0;e<o.length;e++){const t=o[e];"number"==typeof t&&(c>=0?(l=Math.min(l,t),h=Math.max(h,t)):(c=e,l=h=t))}if(l!==h){const i=.9*e/(o.length-1),r=h-l,d=.8*t,u=.1*t;s.strokeStyle=a[0],s.lineWidth=n,s.lineCap="round",s.lineJoin="round",s.beginPath();let m=Pt.move;for(let a=c;a<o.length;a++){const n=o[a];if("number"==typeof n){const o=.05*e+i*a,h=t-(n-l)*d/r-u;m===Pt.move?(s.moveTo(o,h),m=Pt.line):s.lineTo(o,h)}else m=Pt.move}s.stroke()}}static RenderColumn(e,t,s,i,r){const{values:o,colors:a}=this.SparklineCommon(i,r);let n=0,l=0,h=!1;for(const e of o)"number"==typeof e&&(h?(n=Math.min(n,e),l=Math.max(l,e)):(h=!0,n=l=e));if(o.length){const i=(e-6-2)/(o.length-0),r=t-5,h=2.5;if(n!==l)if(n<0&&l>0){const e=l-n,t=h+l/e*r;for(let n=0;n<o.length;n++){const l=o[n];if("number"==typeof l){const o=3+n*i,h=Math.abs(l)/e*r;if(l>=0){s.fillStyle=a[0];const e=t-h;s.fillRect(o+2,e,i-2,h)}else{s.fillStyle=a[1];const e=t;s.fillRect(o+2,e,i-2,h)}}}}else if(l>0){s.fillStyle=a[0];const e=l-n;for(let a=0;a<o.length;a++){const l=o[a];if("number"==typeof l){const o=3+a*i,c=Math.max(1,(l-n)/e*r),d=t-h-c;s.fillRect(o+2,d,i-2,c)}}}else{s.fillStyle=a[1];const e=l-n;for(let t=0;t<o.length;t++){const a=o[t];if("number"==typeof a){const o=3+t*i,n=Math.max(1,Math.abs(l-a)/e*r),c=h;s.fillRect(o+2,c,i-2,n)}}}}}}Ft.default_color="#888";const It=e=>{const t=1/(1+.3275911*(e=Math.abs(e)));return 1-((((1.061405429*t-1.453152027)*t+1.421413741)*t-.284496736)*t+.254829592)*t*Math.exp(-1*e*e)},Ot=e=>{if(.5===e)return 0;const t=e<1&&e>.5?1-e:e,s=Math.sqrt(Math.log(1/Math.pow(t,2))),i=s-(2.515517+.802853*s+.010328*Math.pow(s,2))/(1+1.432788*s+.189269*Math.pow(s,2)+.001308*Math.pow(s,3));return e>.5?i:-i},Ut={Rand:{volatile:!0,fn:()=>({type:a.number,value:Math.random()})},RandBetween:{arguments:[{name:"min"},{name:"max"}],volatile:!0,fn:(e=0,t=1)=>{if(e>t){const s=e;e=t,t=s}return{type:a.number,value:Math.floor(Math.random()*(t+1-e)+e)}}},Sum:{description:"Adds arguments and ranges",arguments:[{boxed:!0,name:"values or ranges"}],fn:(...e)=>{let t={real:0,imaginary:0};const s=Et(e);for(const e of s)switch(e.type){case a.number:t.real+=e.value;break;case a.boolean:t.real+=e.value?1:0;break;case a.complex:t.real+=e.value.real,t.imaginary+=e.value.imaginary;break;case a.error:return e}return v(t)}},Now:{description:"Returns current time",volatile:!0,fn:()=>({type:a.number,value:K((new Date).getTime())})},Today:{description:"Returns current day",volatile:!0,fn:()=>{const e=new Date;return e.setMilliseconds(0),e.setSeconds(0),e.setMinutes(0),e.setHours(12),{type:a.number,value:K(e.getTime())}}},IfError:{description:"Returns the original value, or the alternate value if the original value contains an error",arguments:[{name:"original value",allow_error:!0,boxed:!0},{name:"alternate value"}],fn:(e,t=0)=>e&&e.type===a.error?{value:t,type:n(t)}:e},IsError:{description:"Checks if another cell contains an error",arguments:[{name:"reference",allow_error:!0,boxed:!0}],fn:(...e)=>{const t=Et(e);for(const e of t)if(e.type===a.error)return{type:a.boolean,value:!0};return{type:a.boolean,value:!1}}},Cell:{description:"Returns data about a cell",arguments:[{name:"type",description:"Type of data to return"},{name:"reference",description:"Cell reference",metadata:!0}],fn:(e,t)=>{if(!kt(t))return Qe();if(e)switch(e.toString().toLowerCase()){case"format":return t.value.format?{type:a.string,value:t.value.format}:Qe();case"address":return{type:a.string,value:t.value.address.label.replace(/\$/g,"")}}return{type:a.error,value:Je.error}}},Year:{description:"Returns year from date",arguments:[{name:"date"}],fn:e=>y(new Date(X(e)).getUTCFullYear())},Month:{description:"Returns month from date",arguments:[{name:"date"}],fn:e=>y(new Date(X(e)).getUTCMonth()+1)},Day:{description:"Returns day of month from date",arguments:[{name:"date"}],fn:e=>y(new Date(X(e)).getUTCDate())},Radians:{description:"Converts degrees to radians",arguments:[{name:"Degrees",description:"Angle in degrees"}],fn:Dt((e=>y(e*Math.PI/180)))},Degrees:{description:"Converts radians to degrees",arguments:[{name:"Radians",description:"Angle in radians"}],fn:Dt((e=>y(e/Math.PI*180)))},CountA:{description:"Counts cells that are not empty",fn:(...e)=>y(Tt(e).reduce(((e,t)=>void 0===t?e:e+1),0))},Count:{description:"Counts cells that contain numbers",fn:(...e)=>y(Tt(e).reduce(((e,t)=>"number"==typeof t?e+1:e),0))},Or:{fn:(...e)=>{let t=!1;e=Tt(e);for(const s of e)t=t||!!s;return y(t)}},And:{fn:(...e)=>{let t=!0;e=Tt(e);for(const s of e)t=t&&!!s;return y(t)}},Not:{fn:(...e)=>0===e.length?Ke():1===e.length?y(!e[0]):y(!0)},If:{arguments:[{name:"test value",boxed:!0},{name:"value if true",boxed:!0,allow_error:!0},{name:"value if false",boxed:!0,allow_error:!0}],fn:(e,t={type:a.boolean,value:!0},s={type:a.boolean,value:!1})=>{const i=t.type===a.array,r=s.type===a.array;return e.type===a.array?{type:a.array,value:e.value.map(((e,o)=>e.map(((e,n)=>(e.type===a.string?"false"!==e.value.toLowerCase()&&"f"!==e.value.toLowerCase():e.value)?i?t.value[o][n]:t:r?s.value[o][n]:s))))}:(e.type===a.string?"false"!==e.value.toLowerCase()&&"f"!==e.value.toLowerCase():e.value)?t:s}},Fact:{description:"Returns the factorial of a number",arguments:[{name:"number"}],fn:Dt((e=>{e=Math.floor(e);let t=1;for(;e>1;)t*=e,e--;return{type:a.number,value:t}}))},Power:{description:"Returns base raised to the given power",arguments:[{name:"base",boxed:!0},{name:"exponent",boxed:!0}],fn:zt(((e,t)=>{if(e.type===a.complex||t.type===a.complex){const s=e.type===a.complex?e.value:{real:e.value||0,imaginary:0},i=t.type===a.complex?t.value:{real:t.value||0,imaginary:0},r=ht(s,i);return v(r)}{const s=Math.pow(e.value,t.value);return isNaN(s)?Ye():{type:a.number,value:s}}}))},Mod:{fn:zt(((e,t)=>t?y(e%t):Xe()))},Sort:{arguments:[{name:"values"}],fn:(...e)=>((e=Tt(e)).every((e=>"number"==typeof e))?e.sort(((e,t)=>e-t)):e.sort(),{type:a.array,value:[e.map((e=>y(e)))]})},Transpose:{description:"Returns transpose of input matrix",arguments:[{name:"matrix",boxed:!0}],fn:e=>e.type===a.array?{type:a.array,value:Lt(e.value)}:e},Max:{fn:(...e)=>({type:a.number,value:Math.max.apply(0,Tt(e).filter((e=>"number"==typeof e)))})},Min:{fn:(...e)=>({type:a.number,value:Math.min.apply(0,Tt(e).filter((e=>"number"==typeof e)))})},SumProduct:{description:"Returns the sum of pairwise products of two or more ranges",fn:(...e)=>{const t=e.map((e=>Tt(e))),s=Math.max.apply(0,t.map((e=>e.length)));let i=0;for(let e=0;e<s;e++)i+=t.reduce(((t,s)=>t*(s[e]||0)),1);return{type:a.number,value:i}}},VLookup:{fn:(e,t,s,i=!0)=>{if(s=Math.max(0,s-1),i){let i=Math.abs(e-t[0][0]),r=t[s][0];for(let o=1;o<t[0].length;o++){const a=Math.abs(t[0][o]-e);a<i&&(i=a,r=t[s][o])}return y(r)}for(let i=1;i<t[0].length;i++)if(t[0][i]==e)return t[s][i];return{type:a.error,value:Oe.NA}}},Product:{arguments:[{boxed:!0}],fn:(...e)=>{let t={real:1,imaginary:0};e=Et(e);for(const s of e)s.type===a.complex?t=rt(t,s.value):s.type===a.number&&(t.real*=s.value,t.imaginary*=s.value);return v(t)}},Log:{fn:zt(((e,t=10)=>({type:a.number,value:Math.log(e)/Math.log(t)})))},Log10:{fn:Dt((e=>({type:a.number,value:Math.log(e)/Math.log(10)})))},Ln:{fn:Dt((e=>({type:a.number,value:Math.log(e)})))},Round:{fn:zt(((e,t=0)=>{const s=Math.pow(10,t);return{type:a.number,value:Math.round(s*e)/s}}))},RoundDown:{fn:zt(((e,t=0)=>{const s=Math.pow(10,t),i=e>=0;return{type:a.number,value:i?Math.floor(s*e)/s:Math.ceil(s*e)/s}}))},Reverse:{arguments:[{boxed:!0}],fn:e=>e.type===a.array?(1===e.value.length?e.value[0].reverse():e.value.reverse(),e):{type:a.string,value:e.value.toString().split("").reverse().join("")}},Exp:{arguments:[{boxed:!0}],fn:Dt((e=>{if(e.type===a.complex){const t=lt(e.value);return v(t)}return{type:a.number,value:Math.exp(e.value||0)}}))},Abs:{arguments:[{boxed:!0}],fn:Dt((e=>e.type===a.complex?{type:a.number,value:Math.sqrt(e.value.real*e.value.real+e.value.imaginary*e.value.imaginary)}:{type:a.number,value:Math.abs(e.value||0)}))},Simplify:{fn:zt(((e,t=2)=>{if(t=t||2,0===e)return{type:a.number,value:e};const s=e<0?-1:1;e*=s;const i=Math.pow(10,Math.floor(Math.log10(e))+1-t);return{type:a.number,value:Math.round(e/i)*i*s}}))},Erf:{fn:e=>({type:a.number,value:It(e)})},NormsInv:{description:"Inverse of the normal cumulative distribution",arguments:[{name:"probability"}],fn:e=>({type:a.number,value:Ot(e)})},"Norm.Inv":{description:"Inverse of the normal cumulative distribution",arguments:[{name:"probability"},{name:"mean",default:0},{name:"standard deviation",default:1}],fn:(e,t=0,s=1)=>({type:a.number,value:Ot(e)*s+t})},"Norm.Dist":{description:"Cumulative normal distribution",arguments:[{name:"value"},{name:"mean",default:0},{name:"standard deviation",default:1}],fn:(e,t=0,s=1)=>{const i=e<t?-1:1;return{type:a.number,value:.5*(1+i*It(Math.abs(e-t)/(s*Math.sqrt(2))))}}},Sqrt:{description:"Returns the square root of the argument",arguments:[{boxed:!0}],fn:Dt((e=>{if(e.type===a.complex){const t=ht(e.value,{real:.5,imaginary:0});return v(t)}if(e.type!==a.undefined&&e.value){const t=Math.sqrt(e.value);return isNaN(t)?Ye():{type:a.number,value:t}}return{type:a.number,value:0}}))},HexToDec:{arguments:[{description:"hexadecimal string"}],fn:e=>({type:a.number,value:parseInt(e,16)})},DecToHex:{arguments:[{description:"number"}],fn:e=>({type:a.string,value:e.toString(16)})},Checkbox:{arguments:[{name:"checked"}],click:e=>{const{x:t,y:s,width:i,height:r,cell:o}=e,a={},n=Math.round(16*(e.scale||1));if(o&&i&&r&&t&&s){const e={x:3,y:r-3-n};if(o.style){switch(o.style.vertical_align){case _.VerticalAlign.Top:e.y=3;break;case _.VerticalAlign.Middle:e.y=Math.round((r-n)/2)}switch(o.style.horizontal_align){case _.HorizontalAlign.Right:e.x=Math.round(i-3-n);break;case _.HorizontalAlign.Center:e.x=Math.round((i-n)/2)}}t>=e.x&&t<=e.x+n&&s>=e.y&&s<=e.y+n&&(a.value=`=Checkbox(${o.calculated?"FALSE":"TRUE"})`,a.block_selection=!0)}return a},render:e=>{const{context:t,width:s,height:i,cell:r}=e,o=e.scale||1;t.lineJoin="round",t.lineCap="round";const a=3*o,n=16*o;let l=a,h=i-a-n;if(r.style){switch(r.style.vertical_align){case _.VerticalAlign.Top:h=a;break;case _.VerticalAlign.Middle:h=(i-n)/2}switch(r.style.horizontal_align){case _.HorizontalAlign.Right:l=s-a-n;break;case _.HorizontalAlign.Center:l=(s-n)/2}}l=Math.floor(l)+.5,h=Math.floor(h)+.5;const c=Math.floor(l+n)+.5,d=Math.floor(h+n)+.5;if(r&&r.calculated){t.lineWidth=.5,t.fillStyle=t.strokeStyle,t.beginPath(),t.moveTo(l,h),t.lineTo(l+16*o,h),t.lineTo(l+16*o,h+16*o),t.lineTo(l,h+16*o),t.closePath(),t.moveTo(l+15*o,h+4*o);for(const e of[[13.59,2.58],[6,10.17],[2.41,6.59],[1,8],[6,13]])t.lineTo(l+e[0]*o,h+e[1]*o);t.closePath(),t.fill()}else t.lineWidth=1,t.lineJoin="round",t.beginPath(),t.moveTo(l,h),t.lineTo(c,h),t.lineTo(c,d),t.lineTo(l,d),t.closePath(),t.stroke();return{handled:!0}},fn:e=>({value:!!e,type:a.boolean})},"Sparkline.Column":{arguments:[{name:"data"},{name:"color"},{name:"negative color"}],render:e=>(Ft.RenderColumn(e.width,e.height,e.context,e.cell,e.style),{handled:!0}),fn:(...e)=>({type:a.object,value:e,key:"sparkline-data"})},"Sparkline.Line":{arguments:[{name:"data"},{name:"color"},{name:"line width"}],render:e=>(Ft.RenderLine(e.width,e.height,e.context,e.cell,e.style),{handled:!0}),fn:(...e)=>({type:a.object,value:e,key:"sparkline-data"})}},$t={};for(const e of Object.keys(Ut))$t[e.toLowerCase()]=e;const Ht=["pow"],Vt={};for(const e of Ht)Vt[e.toLowerCase()]=e;for(const e of Object.getOwnPropertyNames(Math)){const t=e.toLowerCase();if($t[t])continue;if(Vt[t])continue;const s=Object.getOwnPropertyDescriptor(Math,e);if(!s)continue;const i=s.value,r=typeof i;switch(r){case"number":Ut[e]={fn:()=>({type:a.number,value:i}),category:["Math Functions"]};break;case"function":Ut[e]={fn:(...e)=>y(i(...e)),category:["Math Functions"]};break;default:console.info("unexpected type:",r,e)}}Math.log10||(Math.log10=e=>Math.log(e)/Math.log(10));const jt=(e,t,s=0,i=0,r=0)=>r?-s*(e/(1-Math.pow(1+e,-t)))/(1+e)-i*(1/((1+e)*((Math.pow(1+e,t)-1)/e))):-(s*e*Math.pow(1+e,t)+i*e)/(Math.pow(1+e,t)-1),Gt=(e,t,s,i=0,r=0)=>r?(1+e)*-s/e*(Math.pow(1+e,t)-1)-i*Math.pow(1+e,t):-s/e*(Math.pow(1+e,t)-1)-i*Math.pow(1+e,t),Bt=(e,t,s,i=0,r=0,o=0)=>{if(t<1)return NaN;if(1===t&&o)return 0;const a=jt(e,s,i,r,o),n=Gt(e,t-1,a,i,o)*e;return o?n/(1+e):n},Zt=(e,t,s,i=0,r=0,o=0)=>jt(e,s,i,r,o)-Bt(e,t,s,i,r,o),Jt={NPV:{description:"Returns the present value of a series of future cashflows",arguments:[{name:"Rate"},{name:"Cashflow"}],fn:(e=0,...t)=>{let s=0;const i=Tt(t);for(let t=0;t<i.length;t++){const r=i[t];"number"==typeof r&&(s+=Math.pow(1+e,-(t+1))*r)}return{type:a.number,value:s}}},IRR:{description:"Calculates the internal rate of return of a series of cashflows",arguments:[{name:"Cashflows"},{name:"Guess",default:.1}],fn:(e,t=.1)=>{const s=Tt(e).map((e=>"number"==typeof e?e:0)),i=[{found:!1,value:0},{found:!1,value:0}];for(let e=0;e<50;e++){let e=0;for(let i=0;i<s.length;i++)e+=Math.pow(1+t,-(i+1))*s[i];if(Math.abs(e)<=.00125)return{type:a.number,value:t};if(e>0){if(i[0].value=i[0].found?Math.max(i[0].value,t):t,i[0].found=!0,!i[1].found){t+=.1;continue}}else if(i[1].value=i[1].found?Math.min(i[1].value,t):t,i[1].found=!0,!i[0].found){t-=.1;continue}t=i[0].value+(i[1].value-i[0].value)/2}return{type:a.error,value:"NUM"}}},CUMPRINC:{description:"Returns cumulative principal paid on a loan between two periods",arguments:[{name:"Rate"},{name:"Periods"},{name:"Present Value"},{name:"Start Period"},{name:"End Period"},{name:"Type",default:0}],fn:(e,t,s,i,r,o=0)=>{let n=0;for(let a=i;a<=r;a++)n+=Zt(e,a,t,s,0,o);return{type:a.number,value:n}}},CUMIPMT:{description:"Returns cumulative interest paid on a loan between two periods",arguments:[{name:"Rate"},{name:"Periods"},{name:"Present Value"},{name:"Start Period"},{name:"End Period"},{name:"Type",default:0}],fn:(e,t,s,i,r,o=0)=>{let n=0;for(let a=i;a<=r;a++)n+=Bt(e,a,t,s,0,o);return{type:a.number,value:n}}},IPMT:{description:"Returns the interest portion of a payment",arguments:[{name:"Rate"},{name:"Period"},{name:"Periods"},{name:"Present Value",default:0},{name:"Future Value",default:0},{name:"Type",default:0}],fn:(e,t,s,i=0,r=0,o=0)=>({type:a.number,value:Bt(e,t,s,i,r,o)})},PPMT:{description:"Returns the principal portion of a payment",arguments:[{name:"Rate"},{name:"Period"},{name:"Periods"},{name:"Present Value",default:0},{name:"Future Value",default:0},{name:"Type",default:0}],fn:(e,t,s,i=0,r=0,o=0)=>({type:a.number,value:Zt(e,t,s,i,r,o)})},Rate:{description:"Returns the interest rate of a loan",arguments:[{name:"Periods"},{name:"Payment"},{name:"Present Value",default:0},{name:"Future Value",default:0},{name:"Type",default:0}],fn:(e,t,s=0,i=0,r=0)=>{let o=.25;const n=[-1,1];for(let l=0;l<32;l++){const l=jt(o,e,s,i,r);if(Math.abs(l-t)<=1e-6)return{type:a.number,value:o};const h=jt(n[1],e,s,i,r);t>=l&&t<=h||t>=h&&t<=l?n[0]=o:n[1]=o,o=n[0]+(n[1]-n[0])/2}return{type:a.number,value:o}}},FV:{description:"Returns the future value of an investment",arguments:[{name:"Rate"},{name:"Periods"},{name:"Payment"},{name:"Present Value",default:0},{name:"Type",default:0}],fn:(e,t,s,i=0,r=0)=>({type:a.number,value:Gt(e,t,s,i,r)})},PV:{description:"Returns the present value of an investment",arguments:[{name:"Rate"},{name:"Periods"},{name:"Payment"},{name:"Future Value",default:0},{name:"Type",default:0}],fn:(e,t,s,i=0,r=0)=>r?(s+=i*(1/((1+e)*((Math.pow(1+e,t)-1)/e))),{type:a.number,value:-(s+s/e*(1-Math.pow(1+e,-(t-1))))}):{type:a.number,value:-(i+s/e*(Math.pow(1+e,t)-1))/Math.pow(1+e,t)}},NPER:{description:"Returns the number of periods of an investment",arguments:[{name:"Rate"},{name:"Payment"},{name:"Present Value"},{name:"Future Value",default:0},{name:"Type",default:0}],fn:(e,t,s=0,i=0,r=0)=>r?{type:a.number,value:1+(-Math.log(1+e*(1-s/-t))+Math.log(1+i*e/(-t*(1+e))))/Math.log(1+e)}:{type:a.number,value:(Math.log(Math.pow(1-s*e/-t,-1))+Math.log(1+i*e/-t))/Math.log(1+e)}},PMT:{description:"Returns the periodic payment of a loan",arguments:[{name:"Rate"},{name:"Periods"},{name:"Present Value"},{name:"Future Value",default:0},{name:"Type",default:0}],fn:(e,t,s,i=0,r=0)=>({type:a.number,value:jt(e,t,s,i,r)})}},qt={Char:{arguments:[{name:"number"}],fn:e=>({type:a.string,value:String.fromCodePoint(e||32)}),category:["text"]},Code:{arguments:[{name:"string"}],fn:e=>({type:a.number,value:e.codePointAt(0)||0}),category:["text"]},Text:{arguments:[{name:"value"},{name:"number format"}],fn:(e,t="0.00####")=>({type:a.string,value:Q.Get(t).Format(e||0)}),category:["text"]},Left:{arguments:[{name:"string"},{name:"count"}],fn:(e,t=1)=>({type:a.string,value:e.substr(0,t)}),category:["text"]},Right:{arguments:[{name:"string"},{name:"count"}],fn:(e,t=1)=>({type:a.string,value:e.slice(-t)}),category:["text"]},Mid:{arguments:[{name:"string"},{name:"left"},{name:"count"}],fn:(e,t=0,s=1)=>({type:a.string,value:e.substr(Math.max(0,t-1),s)}),category:["text"]},Search:{description:"Find a string (needle) in another string (haystack). Case-insensitive.",arguments:[{name:"Needle"},{name:"Haystack"},{name:"Start",default:1}],fn:(e,t,s=1)=>{if(s>=1){if(!e)return{type:a.number,value:s};const i=(e=>{const t=[],s=e.length,i="[\\^$.|?*+()";for(let r=0;r<s;r++){let s=e[r];switch(s){case"*":t.push(".","*");break;case"?":t.push(".");break;case"~":s=e[++r]||"";default:for(let e=0;e<i.length;e++)if(s===i[e]){t.push("\\");break}t.push(s)}}return t.join("")})(e),r=new RegExp(i,"i").exec(t.substr(s-1));if(r)return{type:a.number,value:r.index+s}}return Ye()}},Find:{description:"Find a string (needle) in another string (haystack). Case-sensitive.",arguments:[{name:"Needle"},{name:"Haystack"},{name:"Start",default:1}],fn:(e,t,s=1)=>{if(s>=1){if(!e)return{type:a.number,value:s};const i=new RegExp(e).exec(t.substr(s-1));if(i)return{type:a.number,value:i.index+s}}return Ye()}},Concat:{description:"Pastes strings together",fn:(...e)=>{const t=Tt(e).map((e=>{var t;const s=(null===(t=e)||void 0===t?void 0:t.toString())||"";return"number"==typeof e&&","===f.decimal_separator?s.replace(/\./,","):s})).join("");return{type:a.string,value:t}}}},Wt={Concatenate:"Concat"},Xt={IsBlank:{description:"Returns true if the reference is blank",arguments:[{name:"Reference",metadata:!0}],fn:Dt((e=>({type:a.boolean,value:!(null==e?void 0:e.value)||void 0===e.value.value})))},IsNumber:{description:"Returns true if the reference is a number",arguments:[{name:"Reference",metadata:!0}],fn:Dt((e=>({type:a.boolean,value:(null==e?void 0:e.value)&&"number"==typeof e.value.value})))},IsLogical:{description:"Returns true if the reference is a logical TRUE or FALSE",arguments:[{name:"Reference",metadata:!0}],fn:Dt((e=>({type:a.boolean,value:(null==e?void 0:e.value)&&"boolean"==typeof e.value.value})))},IsText:{description:"Returns true if the reference is text",arguments:[{name:"Reference",metadata:!0}],fn:Dt((e=>({type:a.boolean,value:(null==e?void 0:e.value)&&"string"==typeof e.value.value})))}},Kt=(e,t=!1)=>{const s=e.length;let i=0,r=0;for(let t=0;t<s;t++)i+=e[t];i/=s;for(let t=0;t<s;t++){const s=e[t]-i;r+=s*s}return t?r/(s-1):r/s},Yt={StDev:{description:"Returns the standard deviation of a set of values, corresponding to a population",arguments:[{name:"data"}],fn:(...e)=>({type:a.number,value:Math.sqrt(Kt(Tt(e),!1))})},"StDev.S":{description:"Returns the standard deviation of a set of values, corresponding to a sample of a population",arguments:[{name:"data"}],fn:(...e)=>({type:a.number,value:Math.sqrt(Kt(Tt(e),!0))})},Var:{description:"Returns the variance of a set of values, corresponding to a population",arguments:[{name:"data"}],fn:(...e)=>({type:a.number,value:Kt(Tt(e),!1)})},"Var.S":{description:"Returns the variance of a set of values, corresponding to a sample of a population",arguments:[{name:"data"}],fn:(...e)=>({type:a.number,value:Kt(Tt(e),!0)})},Correl:{description:"Returns the correlation between two ranges of values",arguments:[{name:"A"},{name:"B"}],fn:(e,t)=>{if(!Array.isArray(e)||!Array.isArray(t))return Ye();if(!Array.isArray(e[0])||!Array.isArray(t[0]))return Ye();let s=0,i=0,r=0,o=0,n=0,l=0,h=0;for(let s=0;s<e.length;s++){if(!e[s]||!t[s])continue;const a=e[s].length;for(let c=0;c<a;c++){const a=Number(e[s][c]),d=Number(t[s][c]);isNaN(a)||isNaN(d)||(i+=a*d,r+=a,o+=d,n+=a*a,l+=d*d,h++)}}return s=h*i-r*o,s&&(s/=Math.sqrt((h*n-r*r)*(h*l-o*o))),{type:a.number,value:s}}},GeoMean:{description:"Returns the geometric mean of all numeric arguments",arguments:[{boxed:!0}],fn:(...e)=>{e=Et(e);let t=0,s={real:1,imaginary:0},i=!1,r=!1;for(const o of e)o.type===a.complex?(i=!0,s=rt(s,o.value),t++):o.type===a.number&&(o.value<0&&(r=!0),t++,s.real*=o.value,s.imaginary*=o.value);if(i){const e=ht(s,{real:1/t,imaginary:0});return e.imaginary?{type:a.complex,value:e}:{type:a.number,value:e.real}}return r?Ye():{type:a.number,value:Math.pow(s.real,1/t)}}},Average:{description:"Returns the arithmetic mean of all numeric arguments",arguments:[{boxed:!0}],fn:(...e)=>{e=Et(e);const t={real:0,imaginary:0};let s=0;for(const i of e){if(i.type===a.error)return i;i.type===a.number&&(t.real+=i.value,s++),i.type===a.complex&&(t.real+=i.value.real,t.imaginary+=i.value.imaginary,s++)}return t.real/=s,t.imaginary/=s,t.imaginary?{type:a.complex,value:t}:{type:a.number,value:t.real}}},Percentile:{description:"Returns the kth percentile value from the range of data",arguments:[{name:"range"},{name:"percentile"}],fn:(e,t)=>{const s=Tt(e).filter((e=>"number"==typeof e));s.sort(((e,t)=>e-t));const i=s.length,r=Math.pow(10,8),o=Math.round((1+(i-1)*t)*r)/r,n=Math.floor(o),l=Math.ceil(o);return{type:a.number,value:(s[n-1]+s[l-1])/2}}},Median:{description:"Returns the median value of the range of data",arguments:[{name:"range"}],fn:(...e)=>{const t=Tt(e).filter((e=>"number"==typeof e));t.sort(((e,t)=>e-t));const s=1+.5*(t.length-1),i=Math.floor(s),r=Math.ceil(s);return{type:a.number,value:(t[i-1]+t[r-1])/2}}}},Qt={Mean:"Average","StDev.P":"StDev","Var.P":"Var"},es={IsComplex:{description:"Returns true if the reference is a complex number",arguments:[{name:"Reference",metadata:!0}],fn:Dt((e=>({type:a.boolean,value:(null==e?void 0:e.value)&&o(e.value.value)})))},Real:{description:"Returns the real part of a complex number",arguments:[{boxed:!0}],fn:Dt((e=>e.type===a.number?Object.assign({},e):e.type===a.complex?{type:a.number,value:e.value.real||0}:e.type===a.undefined||e.type===a.string&&""===e.value?{type:a.number,value:0}:Ye()))},Imaginary:{description:"Returns the imaginary part of a complex number (as real)",arguments:[{boxed:!0}],fn:Dt((e=>e.type===a.complex?{type:a.number,value:e.value.imaginary||0}:e.type===a.number||e.type===a.undefined||e.type===a.string&&""===e.value?{type:a.number,value:0}:Ye()))},Conjugate:{description:"Returns the conjugate of a complex number",arguments:[{boxed:!0}],fn:Dt((e=>e.type===a.complex?{type:a.complex,value:{real:e.value.real,imaginary:-e.value.imaginary}}:e.type!==a.number&&e.type!==a.undefined&&e.value?Ye():{type:a.number,value:e.value||0}))},Arg:{description:"Returns the principal argument of a complex number (in radians)",arguments:[{boxed:!0}],fn:Dt((e=>e.type===a.complex?{type:a.number,value:Math.atan2(e.value.imaginary,e.value.real)}:e.type===a.number||e.type===a.undefined||e.type===a.string&&""===e.value?{type:a.number,value:Math.atan2(0,e.value||0)}:Ye()))},Rectangular:{description:"Converts a complex number in polar form to rectangular form",arguments:[{name:"r"},{name:"θ in radians"}],fn:(e=0,t=0)=>({type:a.complex,value:{real:e*Math.cos(t),imaginary:e*Math.sin(t)}})},Complex:{description:"Ensures that the given value will be treated as a complex number",arguments:[{boxed:!0}],fn:Dt((e=>e.type===a.complex?e:e.type!==a.number&&e.type!==a.undefined&&e.value?Ye():{type:a.complex,value:{imaginary:0,real:e.value||0}}))},ComplexLog:{description:"Returns the principal value Log(z) of a complex number z",arguments:[{boxed:!0}],fn:Dt((e=>{if(e.type===a.number){if(!e.value)return Ye();e={type:a.complex,value:{real:e.value,imaginary:0}}}else if(e.type===a.undefined||e.type===a.string&&""===e.value)return Ye();if(e.type===a.complex){const t=it(e.value),s={real:Math.log(t.r),imaginary:t.theta};return s.imaginary?{type:a.complex,value:s}:{type:a.number,value:s.real}}return Ye()}))}},ts=e=>{let t=[];t=e.type===a.array?e.value:[[e.value]];const s=t.length,i=s?t[0].length:0,r=[];if(!s||!i)return{m:s,n:i,array:r};for(let e=0;e<s;e++){const o=[];for(let r=0;r<i;r++){const n=t[e][r];if(n.type===a.complex)o.push(Object.assign({},n.value));else if(n.type===a.number)o.push({real:n.value,imaginary:0});else{if(n.type!==a.undefined&&""!==n.value)return{m:s,n:i,error:!0,array:[]};o.push({real:0,imaginary:0})}}r.push(o)}return{m:s,n:i,array:r}},ss={MDeterm:{description:"Returns the determinant of a matrix",arguments:[{name:"matrix",boxed:!0}],fn:e=>{const t=ts(e);if(!t.array||!t.m||!t.n||t.m!==t.n||t.error)return Ye();const s=at(t);return s?v(s):Ye()}},MInverse:{description:"Returns the inverse matrix",arguments:[{name:"matrix",boxed:!0}],fn:e=>{const t=ts(e);if(!t.array||!t.m||!t.n||t.m!==t.n||t.error)return Ye();const s=at(t);if(s&&0===s.real&&0===(null==s?void 0:s.imaginary))return Ye();const i=(e=>{const t=[];if(e.m!==e.n)return;const{real:s,imaginary:i,flags:r}=(e=>{const t={real_values:!1,imaginary_values:!1,square:e.m===e.n,unit_diagonal:!0},s={m:e.m,n:e.n,array:[]},i={m:e.m,n:e.n,array:[]};for(let r=0;r<e.m;r++){const o=e.array[r],a=[],n=[];for(let s=0;s<e.n;s++)o[s].real&&(t.real_values=!0),o[s].imaginary&&(t.imaginary_values=!0),s===r&&t.unit_diagonal&&(1===o[s].real&&0===o[s].imaginary||(t.unit_diagonal=!1)),a.push(o[s].real),n.push(o[s].imaginary);s.array.push(a),i.array.push(n)}return{real:s,imaginary:i,flags:t}})(e),o=nt(s);if(!o)return;if(!r.imaginary_values){for(let s=0;s<e.m;s++){const i=[];for(let t=0;t<e.n;t++)i.push({real:o.array[s][t],imaginary:0});t.push(i)}return t}const a=ot(o,i),n=((e,t)=>{const s=[];for(let i=0;i<e.m;i++){const r=[];for(let s=0;s<e.n;s++)r.push(e.array[i][s]+t.array[i][s]);s.push(r)}return{m:e.m,n:e.n,array:s}})(s,ot(i,a)),l=nt(n);if(!l)return;const h=ot(a,l);for(let s=0;s<e.m;s++){const i=[];for(let t=0;t<e.n;t++)i.push({real:l.array[s][t],imaginary:-h.array[s][t]});t.push(i)}return t})(t);return i?{type:a.array,value:i.map((e=>e.map((e=>v(e)))))}:Ye()}},MMult:{description:"Returns the dot product of A and B",arguments:[{name:"A",boxed:!0},{name:"B",boxed:!0}],fn:(e,t)=>{const s=ts(e),i=ts(t);if(!s.array||s.error||!i.array||i.error)return Ye();if(s.m!==i.n)return Ye();const r=((e,t)=>{const s=[];for(let i=0;i<e.m;i++){const r=[];for(let s=0;s<t.n;s++){const o={real:0,imaginary:0};for(let r=0;r<e.n;r++)o.real+=e.array[i][r].real*t.array[r][s].real-e.array[i][r].imaginary*t.array[r][s].imaginary,o.imaginary+=e.array[i][r].real*t.array[r][s].imaginary+e.array[i][r].imaginary*t.array[r][s].real;r.push(o)}s.push(r)}return s})(i,s);return{type:a.array,value:r.map((e=>e.map((e=>v(e)))))}}}};class is extends Be{constructor(){super(...arguments),this.state_id=0,this.type=is.type,this.color=Pe.black,this.state_representation=""}UpdateState(){const e=JSON.stringify(this.edges_in.map((e=>e.result)));e!==this.state_representation&&(this.state_representation=e,this.state_id++)}Calculate(e){if(this.dirty){for(const e of this.edges_in)if(e.dirty)return;this.UpdateState(),this.dirty=!1}}AddDependent(e){throw new Error("leaf vertex cannot have dependents")}}is.type="leaf-vertex";class rs extends class{constructor(){this.vertices=[[]],this.volatile_list=[],this.calculation_list=[],this.cells_map={},this.leaf_vertices=[],this.dirty_list=[],this.loop_check_required=!1}IsSpreadsheetVertex(e){return e.type===Be.type}AttachData(e){this.model=e,this.cells_map={};for(const t of e.sheets)this.cells_map[t.id]=t.cells}FlushTree(){this.dirty_list=[],this.volatile_list=[],this.vertices=[[]],this.leaf_vertices=[],this.cells_map={},Ze.Clear()}ResolveArrayHead(e){if(!e.sheet_id)throw new Error("resolve array head with no sheet id");const t=this.cells_map[e.sheet_id];if(!t)throw new Error("no cells? sheet id "+e.sheet_id);const s=t.data[e.row];if(s){const t=s[e.column];if(t&&t.area){const s={row:t.area.start.row,column:t.area.start.column,sheet_id:e.sheet_id};return console.info("array head",e,s),s}}return e}GetVertex(e,t){if(!e.sheet_id)throw new Error("getvertex with no sheet id");const s=this.cells_map[e.sheet_id];if(!s)throw new Error("no cells? sheet id "+e.sheet_id);if(!this.vertices[e.sheet_id]){if(!t)return;this.vertices[e.sheet_id]=[]}if(this.vertices[e.sheet_id][e.column]){const s=this.vertices[e.sheet_id][e.column][e.row];if(s)return s;if(!t)return}else{if(!t)return;this.vertices[e.sheet_id][e.column]=[]}const i=new Be;return i.address={row:e.row,column:e.column,absolute_row:e.absolute_row,absolute_column:e.absolute_column,sheet_id:e.sheet_id},i.reference=s.EnsureCell(e),this.vertices[e.sheet_id][e.column][e.row]=i,Ze.CreateImplicitEdges(i,e),i}RemoveVertex(e){if(!e.sheet_id)throw new Error("removevertex with no sheet id");const t=this.GetVertex(e,!1);t&&(t.Reset(),this.vertices[e.sheet_id][e.column][e.row]=void 0)}ResetVertex(e){const t=this.GetVertex(e,!1);t&&t.Reset()}ResetInbound(e,t=!1,s=!0,i=!1){const r=this.GetVertex(e,s);if(!r){if(t){const t=Ze.GetContainingArrays(e);for(const e of t)this.SetVertexDirty(e)}return}const o=r.edges_in.slice(0);if(r.ClearDependencies(),t&&this.SetVertexDirty(r),i){r.has_outbound_edges||this.RemoveVertex(e);for(const e of o)if(!e.has_inbound_edges&&!e.has_outbound_edges){const t=e;t.address&&this.RemoveVertex(t.address)}}}ResetLoopState(){for(const e of this.vertices)if(e)for(const t of e)if(t)for(const e of t)e&&(e.color=e.edges_out.length?Pe.white:Pe.black);for(const e of this.leaf_vertices)e.color=Pe.black}LoopCheck(e=!1){if(!this.loop_check_required&&!e)return!1;const t=[];for(const e of this.vertices)if(e)for(const s of e)if(s)for(const e of s)e&&(e.color=e.edges_out.length?Pe.white:Pe.black,t.push(e));const s=[];for(const e of t)if(e.color===Pe.white){for(e.color=Pe.gray,s.push(e);s.length;){const t=s[s.length-1];let i=!0;if(t.color!==Pe.black)for(const r of t.edges_out){if(r.color===Pe.gray)return this.loop_hint=this.RenderAddress(e.address),console.info("loop detected @",this.loop_hint),!0;r.color===Pe.white&&(r.color=Pe.gray,s.push(r),i=!1)}i&&(s.pop(),t.color=Pe.black)}e.color=Pe.black}return this.loop_check_required=!1,this.loop_hint=void 0,!1}RenderAddress(e){if(!e)return"undefined";let t="";if(e.sheet_id&&this.model)for(const s of this.model.sheets)if(e.sheet_id===s.id){t=s.name+"!";break}return t+new r(e).spreadsheet_label}AddArrayEdge(e,t){if(!e.start.sheet_id)throw new Error("AddArrayEdge called without sheet ID");const s=this.GetVertex(t,!0),[i,r]=Ze.GetVertex(e);if(s.DependsOn(i),this.loop_check_required=!0,!r)return;const o=this.vertices[e.start.sheet_id];if(o)if(e.entire_row){for(let t=0;t<o.length;t++)if(o[t])for(let s=e.start.row;s<=e.end.row;s++){const e=o[t][s];e&&i.DependsOn(e)}}else if(e.entire_column){for(let t=e.start.column;t<=e.end.column;t++)if(o[t])for(const e of o[t])(null==e?void 0:e.address)&&i.DependsOn(e)}else for(let t=e.start.row;t<=e.end.row;t++)for(let s=e.start.column;s<=e.end.column;s++){const e=o[s][t];e&&i.DependsOn(e)}}AddEdge(e,t,s){const i=this.GetVertex(e,!0);this.GetVertex(t,!0).DependsOn(i),i.reference&&i.reference.area&&!i.array_head&&this.AddEdge(Object.assign(Object.assign({},e),{row:i.reference.area.start.row,column:i.reference.area.start.column}),t,"implicit"),this.loop_check_required=!0}RemoveEdge(e,t){const s=this.GetVertex(e,!1),i=this.GetVertex(t,!1);s&&i&&(s.RemoveDependent(i),i.RemoveDependency(s))}SetAreaDirty(e){if(e.start.column===1/0||e.end.column===1/0||e.start.row===1/0||e.end.row===1/0)throw new Error("don't iterate over infinite area");const t=e.start.sheet_id;if(!t)throw new Error("invalid area, missing sheet id");for(let s=e.start.column;s<=e.end.column;s++)for(let i=e.start.row;i<=e.end.row;i++){const e={row:i,column:s,sheet_id:t};this.GetVertex(e,!1)&&this.SetDirty(e)}}SetVertexDirty(e){if(!e.dirty){this.dirty_list.push(e),e.dirty=!0;for(const t of e.edges_out)this.SetVertexDirty(t)}}SetDirty(e){const t=this.GetVertex(e,!0);this.SetVertexDirty(t)}AddLeafVertex(e){for(const t of this.leaf_vertices)if(t===e)return;this.leaf_vertices.push(e)}RemoveLeafVertex(e){this.leaf_vertices=this.leaf_vertices.filter((t=>t!==e))}AddLeafVertexEdge(e,t){const s=this.GetVertex(e,!0);return t.DependsOn(s),Ie.OK}RemoveLeafVertexEdge(e,t){const s=this.GetVertex(e,!1);s&&(s.RemoveDependent(t),t.RemoveDependency(s))}InitializeGraph(){for(const e of this.dirty_list)this.IsSpreadsheetVertex(e)&&(e.TakeReferenceValue(),this.CheckVolatile(e)&&this.volatile_list.push(e)),e.dirty=!1;this.dirty_list=[]}Recalculate(){for(const e of this.volatile_list)this.SetVertexDirty(e);this.calculation_list=this.dirty_list.slice(0),this.volatile_list=[],this.dirty_list=[],this.loop_check_required&&(this.ResetLoopState(),this.loop_check_required=!1);for(let e=0;e<this.calculation_list.length;e++)this.calculation_list[e].Calculate(this);this.calculation_list=[]}}{constructor(){super(),this.library=new Nt,this.parser=new z,this.expression_calculator=new Rt(this.library,this.parser),this.full_rebuild_required=!1,this.UpdateLocale(),this.library.Register(Ut,qt,Yt,Jt,Xt,es,ss);for(const e of Object.keys(Qt))this.library.Alias(e,Qt[e]);for(const e of Object.keys(Wt))this.library.Alias(e,Wt[e]);this.library.Register({CountIf:{arguments:[{name:"range"},{name:"criteria"}],fn:(e,t)=>{const s=Tt(e);"string"!=typeof t?t="="+(t||0).toString():(t=t.trim(),/^[=<>]/.test(t)||(t="="+t));const i=this.parser.Parse("{}"+t),r=i.expression;if(i.error||!r)return qe();if("binary"!==r.type)return qe();if("array"!==r.left.type)return qe();r.left.values=[s];const o=this.CalculateExpression(r);if(Array.isArray(o)){let e=0;for(const t of o)for(const s of t)s.value&&e++;return{type:a.number,value:e}}return o}},Offset:{arguments:[{name:"reference",description:"Base reference",metadata:!0},{name:"rows",description:"number of rows to offset"},{name:"columns",description:"number of columns to offset"}],return_type:st.reference,volatile:!0,fn:((e,t=0,s=0,i=1,r=1)=>{if(!e)return Ke();if(!kt(e))return Qe();const o=this.DynamicDependencies(e.value.address,this.expression_calculator.context.address,!0,t,s,i,r);if(!o)return Qe();if(o.dirty)return this.GetVertex(this.expression_calculator.context.address,!0).short_circuit=!0,{type:a.undefined,value:void 0};if(o.area){const e=Object.assign(Object.assign({type:"address"},o.area.start),{label:"",position:0,id:0}),t=Object.assign(Object.assign({type:"address"},o.area.end),{label:"",position:0,id:0}),s=1===o.area.count?e:{type:"range",start:e,end:t,label:"",position:0,id:0};return{type:a.object,value:s}}return Ye()}).bind(this)},Indirect:{arguments:[{name:"reference",description:"Cell reference (string)"}],return_type:st.reference,volatile:!0,fn:(e=>{if(!e||"string"!=typeof e)return Ke();const t=this.parser.Parse(e);if(t.error||!t.expression||"address"!==t.expression.type&&"range"!==t.expression.type)return Qe();const s=this.DynamicDependencies(t.expression,this.expression_calculator.context.address);return s?s.dirty?(this.GetVertex(this.expression_calculator.context.address,!0).short_circuit=!0,{type:a.undefined,value:void 0}):{type:a.object,value:t.expression}:Qe()}).bind(this)},Rows:{arguments:[{name:"reference",description:"Array or reference"}],volatile:!1,fn:e=>{if(!e)return Ke();if(Array.isArray(e)){const t=e[0];return Array.isArray(t)?{type:a.number,value:t.length}:Ye()}return{type:a.number,value:1}}},Columns:{arguments:[{name:"reference",description:"Array or reference"}],volatile:!1,fn:e=>e?Array.isArray(e)?{type:a.number,value:e.length}:{type:a.number,value:1}:Ke()},IsFormula:{description:"Returns true if the reference is a formula",arguments:[{name:"Reference",metadata:!0}],fn:Dt((e=>{var t,s;if(null===(t=null==e?void 0:e.value)||void 0===t?void 0:t.address)for(const t of(null===(s=this.model)||void 0===s?void 0:s.sheets)||[])if(t.id===e.value.address.sheet_id){const s=t.cells.GetCell(e.value.address,!1);return{type:a.boolean,value:(null==s?void 0:s.type)===a.formula}}return{type:a.boolean,value:!1}}))}})}SpreadCallback(e,t){if(!e.address||!e.address.sheet_id)throw new Error("spread callback called without sheet id");const s=this.cells_map[e.address.sheet_id];if(!s)throw new Error("spread callback called without cells");if(!e||!e.reference)return;const i=e.reference.area;if(i){const e=i.rows,r=i.columns;if(t.type===a.array){const o=Lt(t.value);for(let t=0;t<e;t++)if(o[t]){let e=0;for(;e<r&&e<o[t].length;e++)s.data[t+i.start.row][e+i.start.column].SetCalculatedValue(o[t][e].value,o[t][e].type);for(;e<r;e++)s.data[t+i.start.row][e+i.start.column].SetCalculatedValue(void 0,a.undefined)}else for(let e=0;e<r;e++)s.data[t+i.start.row][e+i.start.column].SetCalculatedValue(void 0,a.undefined)}else for(let o=0;o<e;o++)for(let e=0;e<r;e++)s.data[o+i.start.row][e+i.start.column].SetCalculatedValue(t.value,t.type)}}CalculationCallback(e){if(!e.address)throw new Error("vertex missing address");return e.expression_error?{value:tt()}:this.expression_calculator.Calculate(e.expression,e.address)}DynamicDependencies(e,t,s=!1,i=0,o=0,a=1,n=1){if(!this.model)return;let l=this.ResolveExpressionAddress(e,t);if(!l)return;let h=!1;l=this.model.active_sheet.RealArea(l);const c=l.start.sheet_id;s&&(l=new r({column:l.start.column+o,row:l.start.row+i,sheet_id:l.start.sheet_id},{column:l.start.column+o+a-1,row:l.start.row+i+n-1,sheet_id:l.end.sheet_id}));for(let e=l.start.row;e<=l.end.row;e++)for(let t=l.start.column;t<=l.end.column;t++){const s=this.GetVertex({row:e,column:t,sheet_id:c},!1);s&&s.dirty&&(this.AddEdge({row:e,column:t,sheet_id:c},this.expression_calculator.context.address),h=!0)}return{dirty:h,area:l}}UpdateLocale(){","===f.decimal_separator?(this.parser.decimal_mark=M.Comma,this.parser.argument_separator=A.Semicolon):(this.parser.decimal_mark=M.Period,this.parser.argument_separator=A.Comma)}GetFunction(e){return this.library.Get(e)}SupportedFunctions(){const e=this.library.List(),t=Object.keys(e).map((t=>{let s=e[t].canonical_name;return s||(s=t.replace(/_/g,".")),{name:s,description:e[t].description,arguments:(e[t].arguments||[]).map((e=>({name:e.name||""})))}}));if(this.model)for(const e of Object.keys(this.model.macro_functions)){const s=this.model.macro_functions[e];t.push({name:s.name,description:s.description,arguments:(s.argument_names||[]).map((e=>({name:e})))})}return t}RegisterFunction(e){for(const t of Object.keys(e)){const s=e[t],i=s.fn;s.fn=(...e)=>i.apply({address:Object.assign({},this.expression_calculator.context.address)},e),this.library.Register({[t]:s})}}AttachModel(e){this.AttachData(e),this.expression_calculator.SetModel(e)}Calculate(e,t){if(this.AttachModel(e),t&&!t.start.sheet_id)throw new Error("CalculateInternal called with subset w/out sheet ID");this.full_rebuild_required&&(t=void 0,this.UpdateAnnotations(),this.full_rebuild_required=!1),this.RebuildGraph(t);try{this.Recalculate()}catch(e){console.error(e),console.info("calculation error trapped")}}Reset(){this.FlushTree(),this.model&&this.AttachModel(this.model),this.full_rebuild_required=!0}CalculateExpression(e,t={row:-1,column:-1},s=!1){return this.expression_calculator.Calculate(e,t,s).value}RebuildClean(e,t=!1){this.full_rebuild_required=!1,this.AttachModel(e),this.RebuildGraph(),this.UpdateAnnotations(),this.InitializeGraph(),t&&this.volatile_list.length&&this.Recalculate()}FlattenCellList(e){const t={},s=[];for(const i of e){const e={column:i.column,row:i.row,sheet_id:i.sheet_id},o=r.CellAddressToLabel(e,!0);t[o]||(t[o]=o,s.push(e))}return s}MetadataReferences(e){const t=[];if(!this.model)return t;const s=this.parser.Parse(e);if(s.expression&&"call"===s.expression.type){const e=this.GetFunction(s.expression.name);if(!e||!e.arguments)return t;for(let i=0;i<e.arguments.length;i++){const r=e.arguments[i];if(!r||!r.metadata)continue;const o=s.expression.args[i];if(!o)continue;const a=this.ResolveExpressionAddress(o);a&&t.push(a.start)}}return t}RemoveAnnotation(e){const t=e.temp.vertex;t&&(t.Reset(),this.RemoveLeafVertex(t))}UpdateAnnotations(e){if(!e&&this.model&&(e=this.model.active_sheet.annotations),e){void 0===e||Array.isArray(e)||(e=[e]);for(const t of e)if(t.formula){t.temp.vertex||(t.temp.vertex=new is);const e=t.temp.vertex;this.AddLeafVertex(e),this.UpdateLeafVertex(e,t.formula)}}}ResolveSheetID(e,t){if(!this.model)throw new Error("ResolveSheetID called without model");const s="address"===e.type?e:e.start;if(s.sheet_id)return!0;if(!s.sheet)return s.sheet_id=(null==t?void 0:t.sheet_id)||this.model.active_sheet.id,!0;{const e=s.sheet.toLowerCase();for(const t of this.model.sheets)if(t.name.toLowerCase()===e)return s.sheet_id=t.id,!0}return!1}ResolveExpressionAddress(e,t){switch(e.type){case"address":if(this.ResolveSheetID(e,t))return new r(e);break;case"range":if(this.ResolveSheetID(e,t))return new r(e.start,e.end);break;case"identifier":if(this.model){const t=this.model.named_ranges.Get(e.name.toUpperCase());if(t)return new r(t.start,t.end)}}}NamedRangeToAddressUnit(e){if(!this.model)return;const t=e.name.toUpperCase(),s=this.model.named_ranges.Get(t);return s?1===s.count?this.ConstructAddressUnit(s.start,t,e.id,e.position):{type:"range",start:this.ConstructAddressUnit(s.start,t,e.id,e.position),end:this.ConstructAddressUnit(s.end,t,e.id,e.position),label:t,id:e.id,position:e.position}:void 0}ConstructAddressUnit(e,t,s,i){return{type:"address",row:e.row,column:e.column,sheet_id:e.sheet_id,label:t,id:s,position:i}}RebuildDependencies(e,t,s,i={addresses:{},ranges:{}},r){if(!r&&(r={},this.model)){for(const e of this.model.sheets)r[e.name.toLowerCase()]=e.id;if(!s)for(const e of this.model.sheets)if(e.id===t){s=e.name;break}}switch(e.type){case"literal":case"missing":case"operator":break;case"identifier":{const t=this.NamedRangeToAddressUnit(e);t&&("address"===t.type?i.addresses[t.label]=t:i.ranges[t.label]=t)}break;case"address":e.sheet_id||(e.sheet_id=e.sheet?r[e.sheet.toLowerCase()]||0:t,e.sheet||(e.sheet=s)),i.addresses[e.sheet_id+"!"+e.label]=e;break;case"range":e.start.sheet_id||(e.start.sheet_id=e.start.sheet?r[e.start.sheet.toLowerCase()]||0:t,e.start.sheet||(e.start.sheet=s)),i.ranges[e.start.sheet_id+"!"+e.start.label+":"+e.end.label]=e;break;case"unary":this.RebuildDependencies(e.operand,t,s,i,r);break;case"binary":this.RebuildDependencies(e.left,t,s,i,r),this.RebuildDependencies(e.right,t,s,i,r);break;case"group":e.elements.forEach((e=>this.RebuildDependencies(e,t,s,i,r)));break;case"call":{const o=e.args.slice(0),a=this.library.Get(e.name);a&&a.arguments&&a.arguments.forEach(((e,i)=>{e&&e.address&&(this.RebuildDependencies(o[i],t,s,void 0,r),o[i]={type:"missing",id:-1})})),o.forEach((e=>this.RebuildDependencies(e,t,s,i,r)))}}return i}UpdateLeafVertex(e,t){if(!this.model)throw new Error("UpdateLeafVertex called without model");e.Reset();const s=this.parser.Parse(t);if(s.expression){const t=this.RebuildDependencies(s.expression,this.model.active_sheet.id,this.model.active_sheet.name);for(const s of Object.keys(t.ranges)){const i=t.ranges[s];new r(i.start,i.end).Iterate((t=>{this.AddLeafVertexEdge(t,e)}))}for(const s of Object.keys(t.addresses)){const i=t.addresses[s];this.AddLeafVertexEdge(i,e)}}e.expression=s.expression||{type:"missing",id:-1},e.expression_error=!s.valid}ApplyMacroFunctionInternal(e,t,s){switch(e.type){case"identifier":if(s[0]){const t=s[0][(e.name||"").toUpperCase()];if(t)return JSON.parse(JSON.stringify(t))}break;case"binary":e.left=this.ApplyMacroFunctionInternal(e.left,t,s),e.right=this.ApplyMacroFunctionInternal(e.right,t,s);break;case"unary":e.operand=this.ApplyMacroFunctionInternal(e.operand,t,s);break;case"group":e.elements=e.elements.map((e=>this.ApplyMacroFunctionInternal(e,t,s)));break;case"call":if(e.args=e.args.map((e=>this.ApplyMacroFunctionInternal(e,t,s))),!this.library.Get(e.name)){const i=t.macro_functions[e.name.toUpperCase()];if(i&&i.expression){const r=JSON.parse(JSON.stringify(i.expression)),o={};if(i.argument_names)for(let t=0;t<i.argument_names.length;t++)o[i.argument_names[t].toUpperCase()]=e.args[t]?e.args[t]:{type:"missing"};s.unshift(o);const a=this.ApplyMacroFunctionInternal(r,t,s);return s.shift(),a}}}return e}ApplyMacroFunctions(e){if(this.model)return Object.keys(this.model.macro_functions).length?this.ApplyMacroFunctionInternal(e,this.model,[]):void 0}RebuildGraphCell(e,t){if(e.area&&e.area.start.column===t.column&&e.area.start.row===t.row){const{start:s,end:i}=e.area,r=s.sheet_id||t.sheet_id;s.sheet_id||(s.sheet_id=r);for(let e=s.column;e<=i.column;e++)for(let t=s.row;t<=i.row;t++)this.ResetInbound({column:e,row:t,sheet_id:r},!0,!1);this.SetDirty(t);for(let e=s.column;e<=i.column;e++)for(let t=s.row;t<=i.row;t++)t===s.row&&e===s.column||this.AddEdge(s,Object.assign(Object.assign({},s),{row:t,column:e}))}if(e.type===a.formula){this.ResetInbound(t,!0);const s=this.parser.Parse(e.value);if(s.expression){if("call"===s.expression.type){const t=this.library.Get(s.expression.name);t&&(t.render||t.click)&&(e.render_function=t.render,e.click_function=t.click)}const i=this.RebuildDependencies(s.expression,t.sheet_id,"");for(const e of Object.keys(i.ranges)){const s=i.ranges[e],o=new r(s.start,s.end);o.entire_row||o.entire_column?this.AddArrayEdge(o,t):o.Iterate((e=>this.AddEdge(e,t)))}for(const e of Object.keys(i.addresses)){const s=i.addresses[e];this.AddEdge(s,t)}}const i=this.GetVertex(t,!0);i&&(i.expression=s.expression||{type:"missing",id:-1},i.expression_error=!s.valid)}else e.value!==e.calculated?this.ResetInbound(t,!0,!1):e.type===a.undefined?this.ResetInbound(t,!0,!1,!0):console.warn("UNHANDLED CASE",e)}RebuildGraph(e){var t;if(e){if(!e.start.sheet_id)throw new Error("subset missing sheet id");const t=this.cells_map[e.start.sheet_id];for(let s=e.start.row;s<=e.end.row;s++){const i=t.data[s];if(i)for(let t=e.start.column;t<=e.end.column;t++){const r=i[t];r&&this.RebuildGraphCell(r,{row:s,column:t,sheet_id:e.start.sheet_id})}}}else for(const e of(null===(t=this.model)||void 0===t?void 0:t.sheets)||[]){const t=e.cells.data.length;for(let s=0;s<t;s++){const t=e.cells.data[s];if(t){const i=t.length;for(let r=0;r<i;r++){const i=t[r];i&&this.RebuildGraphCell(i,{row:s,column:r,sheet_id:e.id})}}}}}IsNativeOrTypedArray(e){return Array.isArray(e)||e instanceof Float64Array||e instanceof Float32Array}CheckVolatile(e){if(!e.expression||e.expression_error)return!1;let t=!1;return this.parser.Walk(e.expression,(e=>{if("call"===e.type){const s=this.library.Get(e.name);s&&s.volatile&&(t=!0)}return!t})),t}}var os;!function(e){e.default="",e.info="info",e.error="error",e.warning="warning",e.success="success",e.about="about",e.initial="initial"}(os||(os={}));class as{constructor(e){this.parent_node=e,this.visible_=!1,this.pending_dialog_resoltion=[],this.options_={type:os.initial},this.event_handler=e=>{"Escape"!==e.key&&"Esc"!==e.key||(e.stopPropagation(),e.preventDefault(),this.visible=!1)},this.model=Z`<div id='mask' class='treb-embed-mask'><div id='dialog' class='treb-embed-dialog'><div id='left'><a href='https://treb.app' target='_blank'><svg width=48 height=48 viewBox='0 0 64 64'><path fill="${"#036ec1"}" d="M37.913,14.323c-2.042,0-7.067,2.558-8.72,3.481c-0.959-1.012-1.065-2.522-1.243-4.475 c-0.959,0.994-0.337,4.014,0,5.115c-4.19,3.125-7.707,6.357-11.295,10.016c-1.225-1.936-2.06-3.517-2.344-7.033 c-1.243,2.664,0.355,6.163,1.278,8.098c-3.96,4.99-7.885,10.354-11.064,15.486C-10.001,14.323,34.344-3.916,63.327,8.641 c-17.955,11.952-22.59,49.672-54.13,39.639c-2.22,3.197-3.712,7.37-5.541,11.082c-1.527,0.107-2.593-0.675-2.983-1.278    c3.072-7.441,7.033-13.995,11.082-20.459c4.387,0.125,8.737,0.195,12.36-0.426c-3.144-0.834-6.908-0.319-10.655-1.278    c2.291-4.387,5.63-7.726,8.95-11.082c3.605,0.32,7.264,1.314,11.082,0.426c-3.32-0.586-6.535-0.799-9.377-1.705 C27.223,20.131,33.438,16.401,37.913,14.323z"/></svg></a></div><div id='middle'><div id='title' class='treb-embed-dialog-title'></div><div id='message' class='treb-embed-dialog-message'></div><div id='about' class='treb-embed-dialog-body'>TREB version ${"11.7.2"}<div class='smaller'><a target=_blank href='https://treb.app'>http://treb.app</a></div></div></div><div id='close' class='close-box'><svg viewBox='0 0 16 16'><path d='M11.854 4.146a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708-.708l7-7a.5.5 0 0 1 .708 0z'/><path d='M4.146 4.146a.5.5 0 0 0 0 .708l7 7a.5.5 0 0 0 .708-.708l-7-7a.5.5 0 0 0-.708 0z'/></svg></div></div></div>`,this.model.close.addEventListener("click",(e=>{e.stopPropagation(),e.preventDefault(),this.HideDialog()})),e.appendChild(this.model.mask)}set options(e){if(e.type===os.about&&(e.close_box=!0,e.icon=!0),this.options_.icon!==e.icon&&(this.model.left.style.display=e.icon?"block":"none"),this.options_.close_box!==e.close_box&&(this.model.close.style.display=e.close_box?"block":"none"),this.options_.message!==e.message&&(this.model.message.textContent=e.message||"",this.model.message.style.display=e.message?"block":"none"),this.options_.title!==e.title&&(this.model.title.textContent=e.title||"",this.model.title.style.display=e.title?"block":"none"),this.options_.type!==e.type){let t=this.model.dialog.className.replace(/dialog-type-\S+/g,"").trim();e.type&&(t+=` dialog-type-${e.type}`),this.model.dialog.className=t,"about"===e.type?this.model.about.style.display="block":this.model.about.style.display="none"}this.options_=e}set visible(e){if(e!==this.visible_)if(this.visible_=e,e)this.parent_node.classList.add("masked"),this.model.mask.classList.add("visible"),window.addEventListener("keydown",this.event_handler);else{this.parent_node.classList.remove("masked"),this.model.mask.classList.remove("visible"),window.removeEventListener("keydown",this.event_handler);const e=this.pending_dialog_resoltion.slice(0);this.pending_dialog_resoltion=[],Promise.resolve().then((()=>{for(const t of e)t()}))}}get visible(){return this.visible_}Div(e,t){const s=document.createElement("div");return e&&s.setAttribute("class",e),t&&t.appendChild(s),s}Update(e,t=!0){t&&(e=Object.assign(Object.assign({},this.options_),e)),this.options=e}HideDialog(){this.visible=!1}ShowDialog(e){return new Promise((t=>{this.pending_dialog_resoltion.push(t),this.options=e,this.visible=!0,this.timeout&&(clearTimeout(this.timeout),this.timeout=0),e.timeout&&(this.timeout=setTimeout((()=>this.HideDialog()),e.timeout))}))}}const ns={delimiter:","},ls={formula_bar:!0,in_cell_editor:!0,undo:!0,scrollbars:!0,dnd:!1,export:!0,fork:!1,popout:!0,tab_bar:"auto",add_tab:!1,max_workers:1,resizable:!0,default_trials:5e3,screen_updates:!1,lhs:!0,hyperlinks:"_blank",max_file_size:94208,complex:!1};var hs,cs,ds;!function(e){e.json="json",e.treb="treb",e.csv="csv",e.tsv="tsv",e.xlsx="xlsx"}(hs||(hs={})),function(e){e.DRAG_AND_DROP="drag-and-drop",e.LOCAL_FILE="local-file",e.NETWORK_FILE="network-file",e.LOCAL_STORAGE="local-storage",e.UNDO="undo"}(cs||(cs={})),function(e){e.TREB="treb",e.CSV="csv",e.XLSX="xlsx"}(ds||(ds={}));const us={"fa/light/arrow-down-to-line":{viewbox:"0 0 384 512",paths:[{d:"M181 395C184 398 188 400 192 400S200 398 203 395L347 251C354 245 354 235 347 229S331 222 325 229L208 345V48C208 39 201 32 192 32S176 39 176 48V345L59 229C53 222 43 222 37 229S30 245 37 251L181 395ZM368 448H16C7 448 0 455 0 464S7 480 16 480H368C377 480 384 473 384 464S377 448 368 448Z",classes:["fa-light"]}]},"fa/light/arrow-up-to-line":{viewbox:"0 0 384 512",paths:[{d:"M203 117C200 114 196 112 192 112S184 114 181 117L37 261C30 267 30 277 37 283S53 290 59 283L176 167V464C176 473 183 480 192 480S208 473 208 464V167L325 283C331 290 341 290 347 283S354 267 347 261L203 117ZM368 32H16C7 32 0 39 0 48S7 64 16 64H368C377 64 384 57 384 48S377 32 368 32Z",classes:["fa-light"]}]},"fa/light/arrows-rotate":{viewbox:"0 0 512 512",paths:[{d:"M464 32C455 32 448 39 448 48V177C416 100 341 48 256 48C154 48 68 121 51 221C49 230 55 238 64 240C65 240 66 240 67 240C74 240 81 234 82 227C97 142 170 80 256 80C328 80 393 125 420 192H304C295 192 288 199 288 208S295 224 304 224H464C473 224 480 217 480 208V48C480 39 473 32 464 32ZM448 272C439 271 431 277 430 285C415 370 342 432 256 432C184 432 119 387 92 320H208C217 320 224 313 224 304S217 288 208 288H48C39 288 32 295 32 304V464C32 473 39 480 48 480S64 473 64 464V335C96 412 171 464 256 464C358 464 444 391 461 291C463 282 457 274 448 272Z",classes:["fa-light"]}]},"fa/light/border-all":{viewbox:"0 0 448 512",paths:[{d:"M400 32H48C22 32 0 54 0 80V432C0 458 22 480 48 480H400C426 480 448 458 448 432V80C448 54 426 32 400 32ZM32 80C32 71 39 64 48 64H208V240H32V80ZM48 448C39 448 32 441 32 432V272H208V448H48ZM416 432C416 441 409 448 400 448H240V272H416V432ZM416 240H240V64H400C409 64 416 71 416 80V240Z",classes:["fa-light"]}]},"fa/light/border-bottom":{viewbox:"0 0 448 512",paths:[{d:"M224 88C237 88 248 77 248 64C248 51 237 40 224 40S200 51 200 64C200 77 211 88 224 88ZM224 184C237 184 248 173 248 160C248 147 237 136 224 136S200 147 200 160C200 173 211 184 224 184ZM320 88C333 88 344 77 344 64C344 51 333 40 320 40S296 51 296 64C296 77 307 88 320 88ZM416 376C429 376 440 365 440 352C440 339 429 328 416 328S392 339 392 352C392 365 403 376 416 376ZM320 280C333 280 344 269 344 256C344 243 333 232 320 232S296 243 296 256C296 269 307 280 320 280ZM416 88C429 88 440 77 440 64C440 51 429 40 416 40S392 51 392 64C392 77 403 88 416 88ZM416 280C429 280 440 269 440 256C440 243 429 232 416 232S392 243 392 256C392 269 403 280 416 280ZM416 184C429 184 440 173 440 160C440 147 429 136 416 136S392 147 392 160C392 173 403 184 416 184ZM32 376C45 376 56 365 56 352C56 339 45 328 32 328S8 339 8 352C8 365 19 376 32 376ZM32 88C45 88 56 77 56 64C56 51 45 40 32 40S8 51 8 64C8 77 19 88 32 88ZM32 280C45 280 56 269 56 256C56 243 45 232 32 232S8 243 8 256C8 269 19 280 32 280ZM32 184C45 184 56 173 56 160C56 147 45 136 32 136S8 147 8 160C8 173 19 184 32 184ZM432 448H16C7 448 0 455 0 464S7 480 16 480H432C441 480 448 473 448 464S441 448 432 448ZM128 280C141 280 152 269 152 256C152 243 141 232 128 232S104 243 104 256C104 269 115 280 128 280ZM224 376C237 376 248 365 248 352C248 339 237 328 224 328S200 339 200 352C200 365 211 376 224 376ZM224 280C237 280 248 269 248 256C248 243 237 232 224 232S200 243 200 256C200 269 211 280 224 280ZM128 88C141 88 152 77 152 64C152 51 141 40 128 40S104 51 104 64C104 77 115 88 128 88Z",classes:["fa-light"]}]},"fa/light/border-inner":{viewbox:"0 0 448 512",paths:[{d:"M128 88C141 88 152 77 152 64C152 51 141 40 128 40S104 51 104 64C104 77 115 88 128 88ZM32 88C45 88 56 77 56 64C56 51 45 40 32 40S8 51 8 64C8 77 19 88 32 88ZM32 184C45 184 56 173 56 160C56 147 45 136 32 136S8 147 8 160C8 173 19 184 32 184ZM416 88C429 88 440 77 440 64C440 51 429 40 416 40S392 51 392 64C392 77 403 88 416 88ZM416 184C429 184 440 173 440 160C440 147 429 136 416 136S392 147 392 160C392 173 403 184 416 184ZM320 88C333 88 344 77 344 64C344 51 333 40 320 40S296 51 296 64C296 77 307 88 320 88ZM32 424C19 424 8 435 8 448C8 461 19 472 32 472S56 461 56 448C56 435 45 424 32 424ZM416 328C403 328 392 339 392 352C392 365 403 376 416 376S440 365 440 352C440 339 429 328 416 328ZM416 424C403 424 392 435 392 448C392 461 403 472 416 472S440 461 440 448C440 435 429 424 416 424ZM320 424C307 424 296 435 296 448C296 461 307 472 320 472S344 461 344 448C344 435 333 424 320 424ZM128 424C115 424 104 435 104 448C104 461 115 472 128 472S152 461 152 448C152 435 141 424 128 424ZM32 328C19 328 8 339 8 352C8 365 19 376 32 376S56 365 56 352C56 339 45 328 32 328ZM432 240H240V48C240 39 233 32 224 32S208 39 208 48V240H16C7 240 0 247 0 256S7 272 16 272H208V464C208 473 215 480 224 480S240 473 240 464V272H432C441 272 448 265 448 256S441 240 432 240Z",classes:["fa-light"]}]},"fa/light/border-left":{viewbox:"0 0 448 512",paths:[{d:"M128 40C115 40 104 51 104 64C104 77 115 88 128 88S152 77 152 64C152 51 141 40 128 40ZM224 424C211 424 200 435 200 448C200 461 211 472 224 472S248 461 248 448C248 435 237 424 224 424ZM224 328C211 328 200 339 200 352C200 365 211 376 224 376S248 365 248 352C248 339 237 328 224 328ZM224 232C211 232 200 243 200 256C200 269 211 280 224 280S248 269 248 256C248 243 237 232 224 232ZM416 88C429 88 440 77 440 64C440 51 429 40 416 40S392 51 392 64C392 77 403 88 416 88ZM224 136C211 136 200 147 200 160C200 173 211 184 224 184S248 173 248 160C248 147 237 136 224 136ZM128 232C115 232 104 243 104 256C104 269 115 280 128 280S152 269 152 256C152 243 141 232 128 232ZM128 424C115 424 104 435 104 448C104 461 115 472 128 472S152 461 152 448C152 435 141 424 128 424ZM416 136C403 136 392 147 392 160C392 173 403 184 416 184S440 173 440 160C440 147 429 136 416 136ZM416 424C403 424 392 435 392 448C392 461 403 472 416 472S440 461 440 448C440 435 429 424 416 424ZM416 328C403 328 392 339 392 352C392 365 403 376 416 376S440 365 440 352C440 339 429 328 416 328ZM416 232C403 232 392 243 392 256C392 269 403 280 416 280S440 269 440 256C440 243 429 232 416 232ZM320 232C307 232 296 243 296 256C296 269 307 280 320 280S344 269 344 256C344 243 333 232 320 232ZM320 40C307 40 296 51 296 64C296 77 307 88 320 88S344 77 344 64C344 51 333 40 320 40ZM320 424C307 424 296 435 296 448C296 461 307 472 320 472S344 461 344 448C344 435 333 424 320 424ZM224 40C211 40 200 51 200 64C200 77 211 88 224 88S248 77 248 64C248 51 237 40 224 40ZM16 32C7 32 0 39 0 48V464C0 473 7 480 16 480S32 473 32 464V48C32 39 25 32 16 32Z",classes:["fa-light"]}]},"fa/light/border-none":{viewbox:"0 0 448 512",paths:[{d:"M128 232C115 232 104 243 104 256C104 269 115 280 128 280S152 269 152 256C152 243 141 232 128 232ZM32 40C19 40 8 51 8 64C8 77 19 88 32 88S56 77 56 64C56 51 45 40 32 40ZM128 424C115 424 104 435 104 448C104 461 115 472 128 472S152 461 152 448C152 435 141 424 128 424ZM128 40C115 40 104 51 104 64C104 77 115 88 128 88S152 77 152 64C152 51 141 40 128 40ZM224 328C211 328 200 339 200 352C200 365 211 376 224 376S248 365 248 352C248 339 237 328 224 328ZM416 88C429 88 440 77 440 64C440 51 429 40 416 40S392 51 392 64C392 77 403 88 416 88ZM32 424C19 424 8 435 8 448C8 461 19 472 32 472S56 461 56 448C56 435 45 424 32 424ZM32 328C19 328 8 339 8 352C8 365 19 376 32 376S56 365 56 352C56 339 45 328 32 328ZM32 136C19 136 8 147 8 160C8 173 19 184 32 184S56 173 56 160C56 147 45 136 32 136ZM32 232C19 232 8 243 8 256C8 269 19 280 32 280S56 269 56 256C56 243 45 232 32 232ZM224 424C211 424 200 435 200 448C200 461 211 472 224 472S248 461 248 448C248 435 237 424 224 424ZM416 328C403 328 392 339 392 352C392 365 403 376 416 376S440 365 440 352C440 339 429 328 416 328ZM416 424C403 424 392 435 392 448C392 461 403 472 416 472S440 461 440 448C440 435 429 424 416 424ZM416 232C403 232 392 243 392 256C392 269 403 280 416 280S440 269 440 256C440 243 429 232 416 232ZM320 40C307 40 296 51 296 64C296 77 307 88 320 88S344 77 344 64C344 51 333 40 320 40ZM224 232C211 232 200 243 200 256C200 269 211 280 224 280S248 269 248 256C248 243 237 232 224 232ZM416 136C403 136 392 147 392 160C392 173 403 184 416 184S440 173 440 160C440 147 429 136 416 136ZM224 40C211 40 200 51 200 64C200 77 211 88 224 88S248 77 248 64C248 51 237 40 224 40ZM320 232C307 232 296 243 296 256C296 269 307 280 320 280S344 269 344 256C344 243 333 232 320 232ZM224 136C211 136 200 147 200 160C200 173 211 184 224 184S248 173 248 160C248 147 237 136 224 136ZM320 424C307 424 296 435 296 448C296 461 307 472 320 472S344 461 344 448C344 435 333 424 320 424Z",classes:["fa-light"]}]},"fa/light/border-outer":{viewbox:"0 0 448 512",paths:[{d:"M224 328C211 328 200 339 200 352C200 365 211 376 224 376S248 365 248 352C248 339 237 328 224 328ZM128 232C115 232 104 243 104 256C104 269 115 280 128 280S152 269 152 256C152 243 141 232 128 232ZM224 232C211 232 200 243 200 256C200 269 211 280 224 280S248 269 248 256C248 243 237 232 224 232ZM320 232C307 232 296 243 296 256C296 269 307 280 320 280S344 269 344 256C344 243 333 232 320 232ZM224 136C211 136 200 147 200 160C200 173 211 184 224 184S248 173 248 160C248 147 237 136 224 136ZM400 32H48C22 32 0 54 0 80V432C0 458 22 480 48 480H400C426 480 448 458 448 432V80C448 54 426 32 400 32ZM416 432C416 441 409 448 400 448H48C39 448 32 441 32 432V80C32 71 39 64 48 64H400C409 64 416 71 416 80V432Z",classes:["fa-light"]}]},"fa/light/border-right":{viewbox:"0 0 448 512",paths:[{d:"M120 40C107 40 96 51 96 64C96 77 107 88 120 88S144 77 144 64C144 51 133 40 120 40ZM24 136C11 136 0 147 0 160C0 173 11 184 24 184S48 173 48 160C48 147 37 136 24 136ZM120 424C107 424 96 435 96 448C96 461 107 472 120 472S144 461 144 448C144 435 133 424 120 424ZM120 232C107 232 96 243 96 256C96 269 107 280 120 280S144 269 144 256C144 243 133 232 120 232ZM24 40C11 40 0 51 0 64C0 77 11 88 24 88S48 77 48 64C48 51 37 40 24 40ZM24 424C11 424 0 435 0 448C0 461 11 472 24 472S48 461 48 448C48 435 37 424 24 424ZM24 328C11 328 0 339 0 352C0 365 11 376 24 376S48 365 48 352C48 339 37 328 24 328ZM24 232C11 232 0 243 0 256C0 269 11 280 24 280S48 269 48 256C48 243 37 232 24 232ZM216 328C203 328 192 339 192 352C192 365 203 376 216 376S240 365 240 352C240 339 229 328 216 328ZM216 40C203 40 192 51 192 64C192 77 203 88 216 88S240 77 240 64C240 51 229 40 216 40ZM312 232C299 232 288 243 288 256C288 269 299 280 312 280S336 269 336 256C336 243 325 232 312 232ZM216 424C203 424 192 435 192 448C192 461 203 472 216 472S240 461 240 448C240 435 229 424 216 424ZM312 40C299 40 288 51 288 64C288 77 299 88 312 88S336 77 336 64C336 51 325 40 312 40ZM312 424C299 424 288 435 288 448C288 461 299 472 312 472S336 461 336 448C336 435 325 424 312 424ZM216 232C203 232 192 243 192 256C192 269 203 280 216 280S240 269 240 256C240 243 229 232 216 232ZM216 136C203 136 192 147 192 160C192 173 203 184 216 184S240 173 240 160C240 147 229 136 216 136ZM424 32C415 32 408 39 408 48V464C408 473 415 480 424 480S440 473 440 464V48C440 39 433 32 424 32Z",classes:["fa-light"]}]},"fa/light/border-top":{viewbox:"0 0 448 512",paths:[{d:"M128 424C115 424 104 435 104 448S115 472 128 472C141 472 152 461 152 448S141 424 128 424ZM224 328C211 328 200 339 200 352S211 376 224 376C237 376 248 365 248 352S237 328 224 328ZM32 136C19 136 8 147 8 160S19 184 32 184C45 184 56 173 56 160S45 136 32 136ZM224 424C211 424 200 435 200 448S211 472 224 472C237 472 248 461 248 448S237 424 224 424ZM128 232C115 232 104 243 104 256S115 280 128 280C141 280 152 269 152 256S141 232 128 232ZM432 32H16C7 32 0 39 0 48S7 64 16 64H432C441 64 448 57 448 48S441 32 432 32ZM32 328C19 328 8 339 8 352S19 376 32 376C45 376 56 365 56 352S45 328 32 328ZM32 232C19 232 8 243 8 256S19 280 32 280C45 280 56 269 56 256S45 232 32 232ZM32 424C19 424 8 435 8 448S19 472 32 472C45 472 56 461 56 448S45 424 32 424ZM416 328C403 328 392 339 392 352S403 376 416 376C429 376 440 365 440 352S429 328 416 328ZM416 232C403 232 392 243 392 256S403 280 416 280C429 280 440 269 440 256S429 232 416 232ZM416 424C403 424 392 435 392 448S403 472 416 472C429 472 440 461 440 448S429 424 416 424ZM416 136C403 136 392 147 392 160S403 184 416 184C429 184 440 173 440 160S429 136 416 136ZM320 424C307 424 296 435 296 448S307 472 320 472C333 472 344 461 344 448S333 424 320 424ZM224 136C211 136 200 147 200 160S211 184 224 184C237 184 248 173 248 160S237 136 224 136ZM224 232C211 232 200 243 200 256S211 280 224 280C237 280 248 269 248 256S237 232 224 232ZM320 232C307 232 296 243 296 256S307 280 320 280C333 280 344 269 344 256S333 232 320 232Z",classes:["fa-light"]}]},"fa/light/check":{viewbox:"0 0 512 512",paths:[{d:"M475 123L203 395C200 398 196 400 192 400S184 398 181 395L37 251C30 245 30 235 37 229S53 222 59 229L192 361L453 101C459 94 469 94 475 101S482 117 475 123Z",classes:["fa-light"]}]},"fa/light/compress":{viewbox:"0 0 448 512",paths:[{d:"M144 320H16C7 320 0 327 0 336S7 352 16 352H128V464C128 473 135 480 144 480S160 473 160 464V336C160 327 153 320 144 320ZM304 192H432C441 192 448 185 448 176S441 160 432 160H320V48C320 39 313 32 304 32S288 39 288 48V176C288 185 295 192 304 192ZM432 320H304C295 320 288 327 288 336V464C288 473 295 480 304 480S320 473 320 464V352H432C441 352 448 345 448 336S441 320 432 320ZM144 32C135 32 128 39 128 48V160H16C7 160 0 167 0 176S7 192 16 192H144C153 192 160 185 160 176V48C160 39 153 32 144 32Z",classes:["fa-light"]}]},"fa/light/expand":{viewbox:"0 0 448 512",paths:[{d:"M144 32H16C7 32 0 39 0 48V176C0 185 7 192 16 192S32 185 32 176V64H144C153 64 160 57 160 48S153 32 144 32ZM144 448H32V336C32 327 25 320 16 320S0 327 0 336V464C0 473 7 480 16 480H144C153 480 160 473 160 464S153 448 144 448ZM432 320C423 320 416 327 416 336V448H304C295 448 288 455 288 464S295 480 304 480H432C441 480 448 473 448 464V336C448 327 441 320 432 320ZM432 32H304C295 32 288 39 288 48S295 64 304 64H416V176C416 185 423 192 432 192S448 185 448 176V48C448 39 441 32 432 32Z",classes:["fa-light"]}]},"fa/light/fill-drip":{viewbox:"0 0 576 512",paths:[{d:"M525 340C519 330 505 330 499 340C480 370 448 423 448 448C448 483 477 512 512 512S576 483 576 448C576 423 544 370 525 340ZM512 480C494 480 480 466 480 448C480 438 494 410 512 379C530 410 544 438 544 448C544 466 530 480 512 480ZM503 217L295 9C289 3 281 0 272 0C264 0 256 3 250 9L157 102L63 8C56 2 46 2 40 8C34 14 34 24 40 31L134 125L28 231C-9 268 -9 329 28 367L145 484C164 503 189 512 213 512C238 512 262 503 281 484L503 262C515 250 515 230 503 217ZM258 461C246 473 230 480 213 480C196 480 180 473 168 461L51 344C44 337 39 329 36 320H400L258 461ZM432 288H33C35 275 41 263 51 254L157 148L245 235C251 242 261 242 267 235C273 229 273 219 267 213L179 125L272 32L480 240L432 288Z",classes:["fa-light"]}]},"fa/light/font":{viewbox:"0 0 448 512",paths:[{d:"M432 448H411L239 41C234 29 214 29 209 41L37 448H16C7 448 0 455 0 464S7 480 16 480H96C105 480 112 473 112 464S105 448 96 448H72L113 352H335L376 448H352C343 448 336 455 336 464S343 480 352 480H432C441 480 448 473 448 464S441 448 432 448ZM126 320L224 88L322 320H126Z",classes:["fa-light"]}]},"fa/light/image-landscape":{viewbox:"0 0 576 512",paths:[{d:"M160 184C173 184 184 173 184 160S173 136 160 136C147 136 136 147 136 160S147 184 160 184ZM347 172C335 156 308 156 297 172L253 233L246 224C234 210 209 210 197 224L134 305C127 314 126 326 132 336C137 346 147 352 158 352H418C429 352 439 346 444 337C444 337 444 337 444 337C450 327 449 315 443 306L347 172ZM162 320L220 244L241 270C245 275 258 281 266 269L321 191L413 320H162ZM512 64H64C29 64 0 93 0 128V384C0 419 29 448 64 448H512C547 448 576 419 576 384V128C576 93 547 64 512 64ZM544 384C544 402 530 416 512 416H64C46 416 32 402 32 384V128C32 110 46 96 64 96H512C530 96 544 110 544 128V384Z",classes:["fa-light"]}]},"fa/light/image":{viewbox:"0 0 512 512",paths:[{d:"M325 158C314 140 285 141 274 158L200 268L184 246C173 230 146 230 134 246L70 335C63 344 62 357 67 367C73 378 83 384 95 384H417C429 384 439 378 444 368C450 358 449 346 443 336L325 158ZM96 352L158 265L188 306C191 310 196 313 201 313C207 312 212 310 214 305L298 175L415 352H96ZM448 32H64C29 32 0 61 0 96V416C0 451 29 480 64 480H448C483 480 512 451 512 416V96C512 61 483 32 448 32ZM480 416C480 434 466 448 448 448H64C46 448 32 434 32 416V96C32 78 46 64 64 64H448C466 64 480 78 480 96V416ZM144 192C170 192 192 170 192 144S170 96 144 96S96 118 96 144S118 192 144 192ZM144 128C153 128 160 135 160 144S153 160 144 160S128 153 128 144S135 128 144 128Z",classes:["fa-light"]}]},"fa/light/lock-keyhole":{viewbox:"0 0 512 512",paths:[{d:"M416 224H384V128C384 57 327 0 256 0S128 57 128 128V224H96C61 224 32 253 32 288V448C32 483 61 512 96 512H416C451 512 480 483 480 448V288C480 253 451 224 416 224ZM160 128C160 75 203 32 256 32S352 75 352 128V224H160V128ZM448 448C448 466 434 480 416 480H96C78 480 64 466 64 448V288C64 270 78 256 96 256H416C434 256 448 270 448 288V448ZM256 320C247 320 240 327 240 336V400C240 409 247 416 256 416S272 409 272 400V336C272 327 265 320 256 320Z",classes:["fa-light"]}]},"fa/light/message":{viewbox:"0 0 512 512",paths:[{d:"M448 0H64C29 0 0 29 0 64V352C0 387 29 416 64 416H160V500C160 510 171 515 179 510L304 416H448C483 416 512 387 512 352V64C512 29 483 0 448 0ZM480 352C480 370 466 384 448 384H304C297 384 290 386 285 390L192 460V400C192 391 185 384 176 384H64C46 384 32 370 32 352V64C32 46 46 32 64 32H448C466 32 480 46 480 64V352Z",classes:["fa-light"]}]},"fa/light/palette":{viewbox:"0 0 512 512",paths:[{d:"M112 264C99 264 88 275 88 288S99 312 112 312C125 312 136 301 136 288S125 264 112 264ZM144 152C131 152 120 163 120 176S131 200 144 200S168 189 168 176S157 152 144 152ZM256 0C239 0 222 2 204 5C105 24 25 104 5 203C-29 378 116 512 239 512C248 512 256 511 264 510C305 504 325 455 306 418C283 373 316 320 367 320H447C483 320 512 290 512 255C511 114 397 0 256 0ZM447 288H367C332 288 300 306 282 336C263 366 262 402 278 433C283 443 283 455 278 464C275 469 270 477 259 479C253 480 246 480 239 480C185 480 125 449 84 398C40 345 23 278 37 210C54 123 124 54 210 37C226 34 241 32 256 32C379 32 480 132 480 255C480 273 465 288 447 288ZM368 136C355 136 344 147 344 160S355 184 368 184S392 173 392 160S381 136 368 136ZM240 88C227 88 216 99 216 112S227 136 240 136C253 136 264 125 264 112S253 88 240 88Z",classes:["fa-light"]}]},"fa/light/save":{viewbox:"0 0 448 512",paths:[{d:"M434 130L350 46C341 37 329 32 316 32H64C29 32 0 61 0 96V416C0 451 29 480 64 480H384C419 480 448 451 448 416V164C448 151 443 139 434 130ZM96 64H288V160H96V64ZM416 416C416 434 402 448 384 448H64C46 448 32 434 32 416V80C32 71 39 64 48 64H64V160C64 178 78 192 96 192H288C306 192 320 178 320 160V65C322 64 321 64 322 64L411 153C414 155 416 160 416 164V416ZM224 240C180 240 144 276 144 320S180 400 224 400S304 364 304 320S268 240 224 240ZM224 368C198 368 176 346 176 320S198 272 224 272S272 294 272 320S250 368 224 368Z",classes:["fa-light"]}]},"fa/light/snowflake":{viewbox:"0 0 512 512",paths:[{d:"M478 384C475 389 470 392 464 392C461 392 459 391 456 390L392 353L406 403C408 412 403 421 394 423C393 423 392 423 390 423C383 423 377 419 375 412L353 331L272 284V377L331 437C338 443 338 453 331 459C328 462 324 464 320 464S312 462 309 459L272 423V496C272 505 265 512 256 512S240 505 240 496V423L203 459C197 466 187 466 181 459S174 443 181 437L240 377V284L159 331L137 412C135 419 129 423 122 423C120 423 119 423 118 423C109 421 104 412 106 403L120 353L56 390C54 391 51 392 48 392C42 392 37 389 34 384C30 376 32 367 40 362L104 325L53 312C45 310 40 301 42 292S53 279 62 281L143 303L224 256L143 209L62 231C60 231 59 231 58 231C51 231 44 227 42 220C40 211 45 202 53 200L104 187L40 150C32 145 30 136 34 128C39 120 48 118 56 122L120 159L106 109C104 100 109 91 118 89C126 87 135 92 137 100L159 181L240 228V135L181 75C174 69 174 59 181 53S197 46 203 53L240 89V16C240 7 247 0 256 0S272 7 272 16V89L309 53C315 46 325 46 331 53S338 69 331 75L272 135V228L353 181L375 100C377 92 386 87 395 89C403 91 408 100 406 109L392 159L456 122C464 118 473 120 478 128C482 136 480 145 472 150L408 187L459 200C467 202 472 211 470 220C468 227 462 231 454 231C453 231 452 231 450 231L369 209L288 256L369 303L450 281C459 279 468 284 470 292C472 301 467 310 459 312L408 325L472 362C480 367 482 376 478 384Z",classes:["fa-light"]}]},"fa/light/table-columns":{viewbox:"0 0 576 512",paths:[{d:"M480 32H96C61 32 32 61 32 96V416C32 451 61 480 96 480H480C515 480 544 451 544 416V96C544 61 515 32 480 32ZM272 448H96C78 448 64 434 64 416V192H272V448ZM512 416C512 434 498 448 480 448H304V192H512V416ZM512 160H64V96C64 78 78 64 96 64H480C498 64 512 78 512 96V160Z",classes:["fa-light"]}]},"bootstrap/arrows-collapse":{viewbox:"0 0 16 16",paths:[{d:"M1 8a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13A.5.5 0 0 1 1 8zm7-8a.5.5 0 0 1 .5.5v3.793l1.146-1.147a.5.5 0 0 1 .708.708l-2 2a.5.5 0 0 1-.708 0l-2-2a.5.5 0 1 1 .708-.708L7.5 4.293V.5A.5.5 0 0 1 8 0zm-.5 11.707l-1.146 1.147a.5.5 0 0 1-.708-.708l2-2a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 11.707V15.5a.5.5 0 0 1-1 0v-3.793z",classes:["bootstrap"]}]},"bootstrap/chat-left":{viewbox:"0 0 16 16",paths:[{d:"M14 1a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H4.414A2 2 0 0 0 3 11.586l-2 2V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12.793a.5.5 0 0 0 .854.353l2.853-2.853A1 1 0 0 1 4.414 12H14a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z",classes:["bootstrap"]}]},"bootstrap/text-center":{viewbox:"0 0 16 16",paths:[{d:"M4 12.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm-2-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5zm2-3a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm-2-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5z",classes:["bootstrap"]}]},"bootstrap/text-left":{viewbox:"0 0 16 16",paths:[{d:"M2 12.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm0-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5zm0-3a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm0-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5z",classes:["bootstrap"]}]},"bootstrap/text-right":{viewbox:"0 0 16 16",paths:[{d:"M6 12.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm-4-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5zm4-3a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm-4-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5z",classes:["bootstrap"]}]},"extra/border-double-bottom":{viewbox:"0 0 448 512",paths:[{d:"M224 88C237 88 248 77 248 64C248 51 237 40 224 40S200 51 200 64C200 77 211 88 224 88ZM224 184C237 184 248 173 248 160C248 147 237 136 224 136S200 147 200 160C200 173 211 184 224 184ZM320 88C333 88 344 77 344 64C344 51 333 40 320 40S296 51 296 64C296 77 307 88 320 88ZM416 376C429 376 440 365 440 352C440 339 429 328 416 328S392 339 392 352C392 365 403 376 416 376ZM320 280C333 280 344 269 344 256C344 243 333 232 320 232S296 243 296 256C296 269 307 280 320 280ZM416 88C429 88 440 77 440 64C440 51 429 40 416 40S392 51 392 64C392 77 403 88 416 88ZM416 280C429 280 440 269 440 256C440 243 429 232 416 232S392 243 392 256C392 269 403 280 416 280ZM416 184C429 184 440 173 440 160C440 147 429 136 416 136S392 147 392 160C392 173 403 184 416 184ZM32 376C45 376 56 365 56 352C56 339 45 328 32 328S8 339 8 352C8 365 19 376 32 376ZM32 88C45 88 56 77 56 64C56 51 45 40 32 40S8 51 8 64C8 77 19 88 32 88ZM32 280C45 280 56 269 56 256C56 243 45 232 32 232S8 243 8 256C8 269 19 280 32 280ZM32 184C45 184 56 173 56 160C56 147 45 136 32 136S8 147 8 160C8 173 19 184 32 184ZM432 448H16C7 448 0 455 0 464S7 480 16 480H432C441 480 448 473 448 464S441 448 432 448ZM128 280C141 280 152 269 152 256C152 243 141 232 128 232S104 243 104 256C104 269 115 280 128 280ZM224 376C237 376 248 365 248 352C248 339 237 328 224 328S200 339 200 352C200 365 211 376 224 376ZM224 280C237 280 248 269 248 256C248 243 237 232 224 232S200 243 200 256C200 269 211 280 224 280ZM128 88C141 88 152 77 152 64C152 51 141 40 128 40S104 51 104 64C104 77 115 88 128 88Z",classes:["extra"]}]},"extra/border-double-bottom2":{viewbox:"0 0 448 512",paths:[{d:"M432,477H16c-9,0-16,7-16,16s7,16,16,16h416c9,0,16-7,16-16S441,477,432,477z",classes:["extra"]},{d:"M128,36c-13,0-24,11-24,24s11,24,24,24s24-11,24-24S141,36,128,36z",classes:["extra"]},{d:"M128,228c-13,0-24,11-24,24s11,24,24,24s24-11,24-24S141,228,128,228z",classes:["extra"]},{d:"M224,324c-13,0-24,11-24,24s11,24,24,24s24-11,24-24S237,324,224,324z",classes:["extra"]},{d:"M32,228c-13,0-24,11-24,24s11,24,24,24s24-11,24-24S45,228,32,228z",classes:["extra"]},{d:"M224,228c-13,0-24,11-24,24s11,24,24,24s24-11,24-24S237,228,224,228z",classes:["extra"]},{d:"M32,132c-13,0-24,11-24,24s11,24,24,24s24-11,24-24S45,132,32,132z",classes:["extra"]},{d:"M32,36C19,36,8,47,8,60s11,24,24,24s24-11,24-24S45,36,32,36z",classes:["extra"]},{d:"M32,324c-13,0-24,11-24,24s11,24,24,24s24-11,24-24S45,324,32,324z",classes:["extra"]},{d:"M416,132c-13,0-24,11-24,24s11,24,24,24s24-11,24-24S429,132,416,132z",classes:["extra"]},{d:"M224,132c-13,0-24,11-24,24s11,24,24,24s24-11,24-24S237,132,224,132z",classes:["extra"]},{d:"M416,324c-13,0-24,11-24,24s11,24,24,24s24-11,24-24S429,324,416,324z",classes:["extra"]},{d:"M416,36c-13,0-24,11-24,24s11,24,24,24s24-11,24-24S429,36,416,36z",classes:["extra"]},{d:"M416,228c-13,0-24,11-24,24s11,24,24,24s24-11,24-24S429,228,416,228z",classes:["extra"]},{d:"M224,36c-13,0-24,11-24,24s11,24,24,24s24-11,24-24S237,36,224,36z",classes:["extra"]},{d:"M320,36c-13,0-24,11-24,24s11,24,24,24s24-11,24-24S333,36,320,36z",classes:["extra"]},{d:"M320,228c-13,0-24,11-24,24s11,24,24,24s24-11,24-24S333,228,320,228z",classes:["extra"]},{d:"M432,409H16c-9,0-16,7-16,16s7,16,16,16h416c9,0,16-7,16-16S441,409,432,409z",classes:["extra"]}]},"extra/wrap":{viewbox:"0 0 16 16",paths:[{d:"M4,5h8c0.276,0,0.5-0.224,0.5-0.5S12.276,4,12,4H4C3.724,4,3.5,4.224,3.5,4.5S3.724,5,4,5z",classes:["extra"]},{d:"M10,8H4C3.724,8,3.5,8.224,3.5,8.5S3.724,9,4,9h6c0.828,0,1.5,0.672,1.5,1.5S10.828,12,10,12v-1.203l-2.953,1.707 L10,14.203V13c1.381,0,2.5-1.119,2.5-2.5S11.381,8,10,8z",classes:["extra"]},{d:"M3.75,12.5c0,0.276,0.224,0.5,0.5,0.5H6v-1H4.25C3.974,12,3.75,12.224,3.75,12.5z",classes:["extra"]}]}},ms={"column-chart":{paths:[{d:"M6,19 L6,10"},{d:"M10,19 L10,13"},{d:"M14,19 L14,5"},{d:"M18,19 L18,9"}]},"donut-chart":{paths:[{d:"M12,4 A8,8,0,0,1,17.65685,6.34315"},{d:"M19.72741,9.92945 A8,8,75,0,1,12,20"},{d:"M8,18.9282 A8,8,75,0,1,8,5.0718"}]},"bar-chart":{paths:[{d:"M5,6 L14,6"},{d:"M5,10 L11,10"},{d:"M5,14 L19,14"},{d:"M5,18 L15,18"}]},"line-chart":{paths:[{d:"M5,15 L9,11 L13,15 L19,9"}]}};class fs extends U{constructor(e,t,s){super(),this.container=e,this.options=t,this.theme=s,this.number_formats=[],this.date_formats=[],this.colors=[],this.background_color={text:"yellow"},this.foreground_color={text:"blue"},this.border_color=void 0;const i=f.decimal_separator;for(const e of[0,128,192,212,256])this.colors.push(`rgb(${e}, ${e}, ${e})`);for(const e of["red","orange","yellow","green","blue","indigo","violet"])this.colors.push(e);this.model=Z`<div id='root' class='treb-toolbar'><div class='group narrow'>${this.IconButton("bootstrap/text-left","text-align","align-left","Align left")}<button class='drop'></button><div class='drop-menu' tabindex='-1'><ul><li>${this.IconButton("bootstrap/text-left","align-left-drop","align-left","Align left","text-align")}</li><li>${this.IconButton("bootstrap/text-center","align-center-drop","align-center","Align center","text-align")}</li><li>${this.IconButton("bootstrap/text-right","align-right-drop","align-right","Align right","text-align")}</li></ul></div></div><div class='group narrow'>${this.IconButton("fa/light/arrow-up-to-line","vertical-align","align-top","Align top")}<button class='drop'></button><div class='drop-menu' tabindex='-1'><ul><li>${this.IconButton("fa/light/arrow-up-to-line","align-top-drop","align-top","Align top","vertical-align")}</li><li>${this.IconButton("bootstrap/arrows-collapse","align-middle-drop","align-middle","Align middle","vertical-align")}</li><li>${this.IconButton("fa/light/arrow-down-to-line","align-bottom-drop","align-bottom","Align bottom","vertical-align")}</li></ul></div></div>${t.file_menu?`<div class='group wide'><button title='File options' class='drop-button'>${this.Icon("fa/light/save")}</button><div class='drop-menu' tabindex='-1'><ul><li><button class='text' data-command='reset'>New Document</button></li><hr/><li><button class='text' data-command='import-desktop'>Open File</button></li><li><button class='text' data-command='save-json'>Save JSON</button></li><hr/><li><button class='text' data-command='export-xlsx'>Export XLSX</button></li></ul></div></div>`:""}<div class='group wide'>${this.IconButton("bootstrap/text-left","align-left",!0,"Align left")}${this.IconButton("bootstrap/text-center","align-center",!0,"Align center")}${this.IconButton("bootstrap/text-right","align-right",!0,"Align right")}</div><div class='group wide'>${this.IconButton("fa/light/arrow-up-to-line","align-top",!0,"Align top")}${this.IconButton("bootstrap/arrows-collapse","align-middle",!0,"Align middle")}${this.IconButton("fa/light/arrow-down-to-line","align-bottom",!0,"Align bottom")}</div><div class='group'><button id='wrap' data-command='wrap' title='Wrap text'>${this.Icon("extra/wrap")}</button><button id='merge' data-command='merge' title='Merge cells'>${this.Icon("fa/light/expand","active-icon")}${this.Icon("fa/light/compress","inactive-icon")}</button>${this.IconButton("fa/light/lock-keyhole","lock")}<button id='comment' class='drop-button' title='Comment'>${this.Icon("fa/light/message")}</button><div class='drop-menu' tabindex='-1'><div class='comment-editor'><div class='label' id='comment-label'></div><textarea id='comment-text' class='comment-textarea'></textarea><div class='comment-buttons'><button data-command='clear-comment'>Clear</button><button id='update-comment' data-command='update-comment'>Save</button></div></div></div></div><div class='group'><button class='color-button' data-command='background-color' title='Background color'>${this.Icon("fa/light/fill-drip")}<div id='background-color-bar' class='color-bar' ></div></button><button class='drop'></button><div class='drop-menu color-chooser' data-target='background' tabindex='-1'></div></div><div class='group'><button class='color-button' data-command='foreground-color' title='Text color'>${this.Icon("fa/light/font")}<div id='foreground-color-bar' class='color-bar' ></div></button><button class='drop'></button><div class='drop-menu color-chooser' data-target='foreground' tabindex='-1'></div></div>${t.font_scale?`<div class='group wide'><div class='container font-size'><input value='' id='font-size-input' title='Font scale'></div><button class='drop'></button><div class='drop-menu' tabindex='-1'><ul><li><button class='text' data-command='font-scale' data-scale='0.80'>0${i}80</button></li><li><button class='text' data-command='font-scale' data-scale='0.90'>0${i}90</button></li><li><button class='text' data-command='font-scale' data-scale='1.00'>1${i}00</button></li><li><button class='text' data-command='font-scale' data-scale='1.10'>1${i}10</button></li><li><button class='text' data-command='font-scale' data-scale='1.20'>1${i}20</button></li><li><button class='text' data-command='font-scale' data-scale='1.50'>1${i}50</button></li><li><button class='text' data-command='font-scale' data-scale='2.00'>2${i}00</button></li></ul></div></div>`:""}${""}<div class='group'>${this.IconButton("fa/light/border-bottom","update-border","border-bottom","Bottom border")}<button class='drop'></button><div class='drop-menu' tabindex='-1'><ul><li>${this.IconButton("fa/light/border-top","border-top",!0,"Top border","update-border")}</li><li>${this.IconButton("fa/light/border-left","border-left",!0,"Left border","update-border")}</li><li>${this.IconButton("fa/light/border-right","border-right",!0,"Right border","update-border")}</li><li>${this.IconButton("fa/light/border-bottom","border-bottom",!0,"Bottom border","update-border")}</li><li>${this.IconButton("extra/border-double-bottom2","border-double-bottom",!0,"Double bottom border","update-border")}</li><li>${this.IconButton("fa/light/border-all","border-all",!0,"All borders","update-border")}</li><li>${this.IconButton("fa/light/border-outer","border-outside",!0,"Outside borders","update-border")}</li><li>${this.IconButton("fa/light/border-none","border-none",!0,"Clear borders","update-border")}</li><hr/><li><button id='border-color' class='color-button drop-button' data-position='horizontal' title='Border color'>${this.Icon("fa/light/palette")}<div id='border-color-bar' class='color-bar'></div></button><div class='drop-menu color-chooser' data-target='border' tabindex='-1'></div></li></ul></div></div><!-- merge was here --><div class='group'><button id='layout' class='drop-button' title='Rows/columns'>${this.Icon("fa/light/table-columns")}</button><div class='drop-menu' tabindex='-1'><ul><li><button class='text' data-command='insert-row'>Insert row</button></li><li><button class='text' data-command='insert-column'>Insert column</button></li><li><button class='text' data-command='delete-row'>Delete row</button></li><li><button class='text' data-command='delete-column'>Delete column</button></li></ul>${t.add_tab?"<ul><hr/><li><button class='text' data-command='insert-sheet'>Insert sheet</button></li><li><button class='text' data-command='delete-sheet'>Delete sheet</button></li></ul>":""}</div></div><div class='group'>${this.IconButton("fa/light/snowflake","freeze")}<!-- lock was here --></div><div class='group'><div class='container'><input value='General' id='number-format-input' title='Number format'></div><button class='drop'></button><div class='drop-menu scroll' tabindex='-1' data-number-formats></div></div><div class='split-button'><button data-command='decrease-decimal' title='Decrease precision'><div>0${i}0</div></button><button data-command='increase-decimal' title='Increase precision'><div>0${i}00</div></button></div><div class='group'>${this.IconButton("column-chart","insert-annotation","column-chart","Insert column chart")}<button class='drop'></button><div class='drop-menu' tabindex='-1'><ul><li>${this.IconButton("column-chart","column-chart",!0,"Insert column chart","insert-annotation")}</li><li>${this.IconButton("donut-chart","donut-chart",!0,"Insert donut chart","insert-annotation")}</li><li>${this.IconButton("bar-chart","bar-chart",!0,"Insert bar chart","insert-annotation")}</li><li>${this.IconButton("line-chart","line-chart",!0,"Insert line chart","insert-annotation")}</li><hr/><li>${this.IconButton("fa/light/image","insert-image",!0,"Insert image","insert-annotation")}</li></ul></div></div>${t.toolbar_recalculate_button?`<div class='group end-group'><button data-command='recalculate' title='Recalculate'>${this.Icon("fa/light/arrows-rotate")}</button></div>`:""}<div class='staging'><div id='color-chooser' class='color-chooser-main'><div class='color-header'>Theme colors</div><div id='theme-color-list' class='color-list'></div><div class='color-header other-colors'>Other colors</div><div id='color-list' class='color-list'></div><div class='new-color'><input id='color-input' placeholder='New Color'><button id='color-button'>${this.Icon("fa/light/check")}</button></div></div></div></div>`,this.model["background-color-bar"].style.color="yellow",this.model["foreground-color-bar"].style.color="blue",this.model["border-color-bar"].style.color="#333";const o=this.model["color-button"],a=this.model["color-input"];this.UpdateTheme(s),o.addEventListener("click",(()=>{this.CommitColor({text:a.value||""})})),a.addEventListener("keydown",(e=>{"Enter"===e.key&&this.CommitColor({text:a.value||""})})),a.addEventListener("input",(()=>{o.style.backgroundColor="";const e=a.value||"";o.style.backgroundColor=e;const t=H.MeasureColor(e),s=b.RGBToHSL(t[0],t[1],t[2]);o.style.color=s.l>.5?"":"#fff"})),this.model["comment-text"].addEventListener("keydown",(e=>{if("Enter"===e.key&&e.ctrlKey)return e.stopPropagation(),e.preventDefault(),void this.model["update-comment"].click()}));let n="";const l=this.model["font-size-input"];l&&(l.addEventListener("focus",(()=>n=l.value||"")),l.addEventListener("keydown",(e=>{switch(e.key){case"Enter":if(l.value){let e=l.value;"."!==f.decimal_separator&&(e=e.replace(new RegExp(f.decimal_separator,"g"),".")),this.Publish({type:"font-size",style:_.ParseFontSize(e)})}else this.Publish({type:"font-size",style:{font_size_unit:void 0,font_size_value:void 0}});break;case"Escape":c.value=h,this.Publish({type:"cancel"});break;default:return}e.stopPropagation(),e.preventDefault()})));let h="";const c=this.model["number-format-input"];c.addEventListener("focus",(()=>h=c.value||"")),c.addEventListener("keydown",(e=>{switch(e.key){case"Enter":this.Publish({type:"format",format:c.value||""});break;case"Escape":c.value=h,this.Publish({type:"cancel"});break;default:return}e.stopPropagation(),e.preventDefault()})),this.model.root.addEventListener("click",(e=>{var t,s,i,n,l,h,c,d,u,m,f,p;const _=e.target;let g=null===(t=null==_?void 0:_.dataset)||void 0===t?void 0:t.command;if(g){const e={};if(/^border-/.test(g))e.border=g,e.color=this.border_color,g="border";else switch(g){case"font-scale":e.scale=(null===(s=null==_?void 0:_.dataset)||void 0===s?void 0:s.scale)||1;break;case"clear-comment":case"update-comment":(null===(i=this.state)||void 0===i?void 0:i.selection)&&!this.state.selection.empty&&(e.address=Object.assign({},this.state.selection.target)),e.comment=this.model["comment-text"].value||"";break;case"background-color":e.target="background",e.color=this.background_color;break;case"foreground-color":e.target="foreground",e.color=this.foreground_color;break;case"border-color":e.target="border",e.color=this.border_color}this.Publish({type:"button",command:g,data:e})}else if((null===(n=null==_?void 0:_.classList)||void 0===n?void 0:n.contains("drop"))||(null===(l=null==_?void 0:_.classList)||void 0===l?void 0:l.contains("drop-button"))){let e=_.parentElement;for(;e&&!e.classList.contains("group");){if(e===this.model.root)return;e=e.parentElement}if(e){let e;const t=_.nextSibling;(null===(h=null==t?void 0:t.classList)||void 0===h?void 0:h.contains("drop-menu"))&&(_===this.model.comment&&(this.model["comment-label"].textContent=(null===(d=null===(c=this.state)||void 0===c?void 0:c.selection)||void 0===d?void 0:d.target)?r.CellAddressToLabel(null===(u=this.state)||void 0===u?void 0:u.selection.target):"",this.model["comment-text"].value=(null===(m=this.state)||void 0===m?void 0:m.comment)||"",e=this.model["comment-text"]),void 0!==t.dataset.numberFormats&&this.RenderNumberFormats(t),t.classList.contains("color-chooser")&&(this.color_target=(null===(f=t.dataset)||void 0===f?void 0:f.target)||"",this.RenderColors(this.model["color-list"]),a.value="",o.style.backgroundColor="",o.style.color="",t.appendChild(this.model["color-chooser"])),"horizontal"===(null===(p=_.dataset)||void 0===p?void 0:p.position)?this.Focus(t,_.offsetWidth+12,_.offsetTop-8,e):this.Focus(t,0,_.offsetHeight+4,e))}}})),/narrow/i.test((t.toolbar||"").toString())&&this.model.root.classList.add("narrow"),e.appendChild(this.model.root)}ResolveColor(e,t){return C(this.theme,e||t)||""}CommitColor(e){switch(this.color_target){case"background":this.model["background-color-bar"].style.color=this.ResolveColor(e,{theme:0}),this.background_color=e?Object.assign({},e):void 0;break;case"border":this.model["border-color-bar"].style.color=this.ResolveColor(e,{theme:1}),this.border_color=e?Object.assign({},e):void 0;break;case"foreground":e||(e={theme:1}),this.model["foreground-color-bar"].style.color=this.ResolveColor(e,{theme:1}),this.foreground_color=e?Object.assign({},e):void 0}this.Publish({type:"button",command:"color",data:{color:e?Object.assign({},e):void 0,target:this.color_target||""}})}Focus(e,t,s,i){e.style.left=t+"px",e.style.top=s+"px",e.classList.add("visible");const r=e=>{"Escape"===e.key&&(e.stopPropagation(),e.preventDefault(),this.Publish({type:"cancel"}))};window.addEventListener("keydown",r);const o=e=>{var t,s,i,r,o,a,n,l,h;const c=e.target;if(null===(t=c.dataset)||void 0===t?void 0:t.replace){const e=this.model[c.dataset.replace];e.innerHTML=c.innerHTML,e.setAttribute("title",c.getAttribute("title")||""),e.dataset.command=c.dataset.command||void 0}if("number-format"===(null===(s=c.dataset)||void 0===s?void 0:s.command)){const e=c.textContent||"General";this.model["number-format-input"].value=c.textContent||"",this.Publish({type:"format",format:e})}else{if((null===(i=c.dataset)||void 0===i?void 0:i.command)||(null===(r=c.classList)||void 0===r?void 0:r.contains("drop-button")))return;if(null===(o=c.classList)||void 0===o?void 0:o.contains("color-swatch"))if(void 0!==(null===(a=null==c?void 0:c.dataset)||void 0===a?void 0:a.theme)){let e=Number(null===(n=null==c?void 0:c.dataset)||void 0===n?void 0:n.theme);isNaN(e)&&(e=0);const t={theme:e||0};if(null===(l=null==c?void 0:c.dataset)||void 0===l?void 0:l.tint){const e=Number(c.dataset.tint);e&&!isNaN(e)&&(t.tint=e)}this.CommitColor(t)}else{const e=(null===(h=null==c?void 0:c.dataset)||void 0===h?void 0:h.color)||"";this.CommitColor(e?{text:e}:void 0)}}e.stopPropagation()};e.addEventListener("click",o);const a=t=>{const s=t.relatedTarget;s&&e.contains(s)||(e.classList.remove("visible"),e.removeEventListener("focusout",a),e.removeEventListener("click",o),window.removeEventListener("keydown",r))};e.addEventListener("focusout",a),requestAnimationFrame((()=>(i||e).focus()))}UpdateState(e){var t,s,i,r,o,a,n,l;this.state=e;const h={"align-center":e.style&&(null===(t=e.style)||void 0===t?void 0:t.horizontal_align)===_.HorizontalAlign.Center,"align-left":e.style&&(null===(s=e.style)||void 0===s?void 0:s.horizontal_align)===_.HorizontalAlign.Left,"align-right":e.style&&(null===(i=e.style)||void 0===i?void 0:i.horizontal_align)===_.HorizontalAlign.Right,"align-top":e.style&&(null===(r=e.style)||void 0===r?void 0:r.vertical_align)===_.VerticalAlign.Top,"align-middle":e.style&&(null===(o=e.style)||void 0===o?void 0:o.vertical_align)===_.VerticalAlign.Middle,"align-bottom":e.style&&(null===(a=e.style)||void 0===a?void 0:a.vertical_align)===_.VerticalAlign.Bottom,wrap:e.style&&!!e.style.wrap,comment:!!e.comment},c=this.model.freeze;e.frozen?(c.classList.add("active"),c.setAttribute("title","Unfreeze panes")):(c.classList.remove("active"),c.setAttribute("title","Freeze panes")),(null===(n=e.style)||void 0===n?void 0:n.locked)?(this.model.lock.classList.add("active"),this.model.lock.setAttribute("title","Unlock cells")):(this.model.lock.classList.remove("active"),this.model.lock.setAttribute("title","Lock cells"));const d=this.model.merge;e.merge?(d.classList.add("active"),d.dataset.command="unmerge",d.setAttribute("title","Unmerge cells")):(d.classList.remove("active"),d.dataset.command="merge",d.setAttribute("title","Merge cells"));const u=this.model["font-size-input"];if(u){let t=_.RelativeFontSize(e.style||{},this.theme.grid_cell||{}).toFixed(2);t=t.replace(/\./g,f.decimal_separator),u.value=t}const m=(null===(l=e.style)||void 0===l?void 0:l.number_format)||"";this.model["number-format-input"].value=Q.SymbolicName(m)||m,Object.keys(h).forEach((e=>{var t,s;h[e]?null===(t=this.model[e])||void 0===t||t.classList.add("active"):null===(s=this.model[e])||void 0===s||s.classList.remove("active")}))}UpdateTheme(e){const t=this.model["theme-color-list"],s=[],i=["Background","Text","Background","Text","Accent","Accent","Accent","Accent","Accent","Accent"];let r=0;if(e.theme_colors)if(this.options.tint_theme_colors)for(const t of[.5,.25,0,-.25,-.5]){for(s.push("<div class='color-list-row'>"),r=0;r<10;r++){let o=e.theme_colors[r]||"#000";t&&(o+=` (${Math.round(100*Math.abs(t))}% ${t>0?"lighter":"darker"})`);const a=this.ResolveColor({theme:r,tint:t},{});s.push(`<button data-color='${a}' class='color-swatch' data-tint=${t} data-theme=${r} title='${i[r]}: ${o}' ></button>`)}s.push("</div>")}else{for(s.push("<div class='color-list-row'>"),r=0;r<10;r++){const t=e.theme_colors[r]||"#000";s.push(`<button data-color='${t}' class='color-swatch' data-theme=${r} title='${i[r]}: ${t}' ></button>`)}s.push("</div>")}t.innerHTML=s.join("");const o=t.querySelectorAll("button[data-color]");for(let e=0;e<o.length;e++)o[e].style.backgroundColor=o[e].dataset.color||""}RenderColors(e){const t=["<div class='color-list-row'>","<button class='color-swatch default-color' data-color='' title='Default color'></button>"];let s=0;for(;s<9&&s<this.colors.length;s++){const e=this.colors[s];t.push(`<button class='color-swatch' data-color='${e}' title='${e}' ></button>`)}for(t.push("</div>");s<this.colors.length;){t.push("<div class='color-list-row'>");const e=s+10;for(;s<this.colors.length&&s<e;s++){const e=this.colors[s];t.push(`<button class='color-swatch' data-color='${e}' title='${e}' ></button>`)}t.push("</div>")}e.innerHTML=t.join("");const i=e.querySelectorAll("button.color-swatch");for(let e=0;e<i.length;e++){const t=i[e];t.style.background=t.dataset.color||""}}RenderNumberFormats(e){e.innerHTML=`<ul>${this.number_formats.map((e=>B`<li><button data-command='number-format' class='text'>${e}</button></li>`)).join("\n")}</ul><hr/><ul>${this.date_formats.map((e=>B`<li><button data-command='number-format' class='text'>${e}</button></li>`)).join("\n")}</ul>`}UpdateDocumentStyles(e,t,s){const i=["General","Number","Integer","Percent","Fraction","Accounting","Currency","Scientific"],r=["Timestamp","Long Date","Short Date"];for(const t of e)Q.SymbolicName(Q.Translate(t))||(Q.Get(t).date_format?r.push(t):i.push(t));this.number_formats=i,this.date_formats=r;const o=this.colors.map((e=>H.MeasureColor(e)));for(const e of t){const t=H.MeasureColor(e);o.some((e=>e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]))||(this.colors.push(e),o.push(t))}}IconButton(e,t,s=!0,i,r){return t&&!0===s&&(s=t),"<button"+(t?` id='${t}'`:"")+(r?` data-replace='${r}'`:"")+`${s?` data-command='${s}'`:""}${i?` title='${i}'`:""}>${this.Icon(e)}</button>`}Icon(e,t=""){let s=us[e],i="",r="";return s||(s=ms[e],i="symbol"),(t||i)&&(r=` class='${i} ${t}'`),s?`<svg${r} viewBox='${s.viewbox||"0 0 24 24"}'>${(s.paths||[]).map((e=>{let t=" ";return Array.isArray(e.classes)?t+=e.classes.join(" "):e.classes&&(t+=e.classes),`<path d='${e.d}' class='${t.trim()}'/>`})).join("")}</svg>`:(console.warn(e),"")}}class ps{constructor(e=0,t=0,s=100,i=100){this.left=e,this.top=t,this.right=s,this.bottom=i}get width(){return this.right-this.left}get height(){return this.bottom-this.top}get center(){return{x:this.left+this.width/2,y:this.top+this.height/2}}}var _s,gs,ys;!function(e){e[e.horizontal=0]="horizontal",e[e.vertical=1]="vertical"}(_s||(_s={})),function(e){e[e.top=0]="top",e[e.bottom=1]="bottom",e[e.left=2]="left",e[e.right=3]="right"}(gs||(gs={})),function(e){e[e.line=0]="line",e[e.marker=1]="marker"}(ys||(ys={}));const vs="http://www.w3.org/2000/svg",bs=/trident/i.test((null===navigator||void 0===navigator?void 0:navigator.userAgent)||""),ws=(e,t={},s)=>{const i=document.createElementNS(vs,e);for(const e of Object.keys(t))if(void 0!==t[e]){const s=t[e];i.setAttribute(e,Array.isArray(s)?s.join(" "):s.toString())}return s&&(i.textContent=s),i};class xs{constructor(){this.size={width:0,height:0},this.bounds=new ps,this.container_group=ws("g"),this.group=ws("g"),this.axis_group=ws("g",{class:"axis-group"}),this.label_group=ws("g",{class:"label-group"}),this.container_group.appendChild(this.axis_group),this.container_group.appendChild(this.group),this.container_group.appendChild(this.label_group)}Initialize(e){this.parent=e,this.svg_node=ws("svg",{class:"treb-chart"}),this.svg_node.style.overflow="hidden",this.svg_node.style.position="relative",this.svg_node.style.width="100%",this.svg_node.style.height="100%",this.svg_node.appendChild(this.container_group),this.parent.appendChild(this.svg_node),this.Resize()}Legend(e){const t=ws("g");this.group.appendChild(t);const s=ws("text");t.appendChild(s),t.setAttribute("class","legend");const i=[[]];let r=e.area.width,o=0,a=0;const n=e.area.width,l=e.style===ys.marker?14:26,h=e.labels.map(((t,h)=>{s.textContent=t;const c=s.getBoundingClientRect(),d={width:c.width,height:c.height},u=d.width+l+10;return a=Math.max(a,d.height),e.layout===_s.vertical?i[h]=[h]:u>r?0===i[o].length?(i[o].push(h),o++,i[o]=[],r=n):(o++,i[o]=[h],r=n-u):(i[o].push(h),r-=u),d}));t.removeChild(s);let c=a,d=e.layout||_s.horizontal;d===_s.horizontal&&i.every((e=>e.length<=1))&&(d=_s.horizontal);for(let s=0;s<i.length;s++){const r=i[s].reduce(((e,t)=>e+h[t].width+l),10*(i[s].length-1));let o=0,a=d===_s.horizontal?Math.round((n-r)/2):Math.round(5);for(let r=0;r<i[s].length;r++){const n=i[s][r],d=h[n],u=e.labels[n],m=c-1;t.appendChild(ws("text",{"dominant-baseline":"middle",x:a+l,y:c,dy:bs?".3em":void 0},u)),e.style===ys.marker?t.appendChild(ws("rect",{class:`series-${n+1}`,x:a,y:m-4,width:8,height:8})):t.appendChild(ws("rect",{class:`series-${n+1}`,x:a,y:m-1,width:l-3,height:2})),o=Math.max(o,d.height),a+=d.width+l+10}c=Math.round(c+1.1*o)}const u=t.getBoundingClientRect(),m=u.width,f=u.height+a;switch(e.position){case gs.bottom:t.setAttribute("transform",`translate(${e.area.left}, ${e.area.bottom-f})`);break;case gs.left:t.setAttribute("transform",`translate(${e.area.left}, ${e.area.top})`);break;case gs.right:t.setAttribute("transform",`translate(${e.area.right-m}, ${e.area.top})`);break;case gs.top:default:t.setAttribute("transform",`translate(${e.area.left}, ${e.area.top})`)}e.position===gs.top?e.area.top+=f||0:e.position===gs.right?e.area.right-=(m||0)+8:e.position===gs.left?e.area.left+=(m||0)+8:e.area.bottom-=f||0}Clear(){this.group.textContent="",this.axis_group.textContent="",this.label_group.textContent=""}Resize(){const e=this.parent.getBoundingClientRect();this.svg_node.setAttribute("width",e.width.toString()),this.svg_node.setAttribute("height",e.height.toString()),this.size={width:e.width,height:e.height}}Prerender(){const e=this.svg_node.getBoundingClientRect();this.bounds.top=e.top,this.bounds.left=e.left,this.bounds.right=e.right,this.bounds.bottom=e.bottom}RenderTitle(e,t,s,i){const r=ws("text",{class:"chart-title",x:Math.round(t.width/2)},e);r.style.textAnchor="middle",this.group.appendChild(r);const o=r.getBoundingClientRect();switch(i){case"bottom":r.setAttribute("y",Math.round(t.bottom-o.height).toString()),t.bottom-=o.height+s;break;default:r.setAttribute("y",Math.round(t.top+s+o.height).toString()),t.top+=o.height+s}}MeasureText(e,t,s=!1){this.text_measurement_node||(this.text_measurement_node=ws("text",{x:"-100px",y:"-100px"}),this.svg_node.appendChild(this.text_measurement_node)),void 0!==t?("string"==typeof t&&(t=[t]),this.text_measurement_node.setAttribute("class",t.join(" "))):this.text_measurement_node.setAttribute("class",""),this.text_measurement_node.textContent=e;const i=this.text_measurement_node.getBoundingClientRect(),r={width:i.width,height:i.height,y_offset:i.height-(this.bounds.top-i.top-100)};return s&&(r.width=Math.ceil(r.width),r.height=Math.ceil(r.height),r.y_offset=Math.ceil(r.y_offset)),r}RenderTicks(e,t,s,i,r){const o=[],a=e.width/i;for(let r=0;r<i;r++){const i=Math.round(e.left+a/2+a*r)-.5;o.push(`M${i} ${t} L${i} ${s}`)}this.group.appendChild(ws("path",{d:o,class:r}))}RenderXAxisBar(e,t,s,i,r){const o=s.length;if(!o)return;const a=t?e.width/o:e.width/(o-1),n=t?a/2:0;let l=1,h=!0;for(;h;){h=!1;let t=0;for(let s=0;s<o;s+=l){const r=Math.round(e.left+n+a*s),o=r-i[s].width/2;if(t&&o<=t){l++,h=!0;break}t=r+i[s].width/2+4}}for(let t=0;t<o;t+=l){const i=Math.round(e.left+n+a*t);this.RenderText(this.axis_group,s[t],"center",{x:i,y:e.bottom},r)}}RenderXAxis(e,t,s,i,r){const o=s.length;if(!o)return;const a=t?e.width/o:e.width/(o-1),n=t?a/2:0;let l=1,h=!0;const c=(s.length-1)%2==0,d=(s.length-1)%3==0;for(;h;){h=!1;let t=0;for(let s=0;s<o;s+=l){const r=Math.round(e.left+n+a*s),o=r-i[s].width/2;if(t&&o<=t){l++,h=!0;break}t=r+i[s].width/2+4}}3===l&&!d&&c&&l++;for(let t=0;t<o;t+=l){const i=Math.round(e.left+n+a*t);this.RenderText(this.axis_group,s[t],"center",{x:i,y:e.bottom},r)}}RenderYAxisBar(e,t,s,i){(s=s.slice(0)).reverse();const r=s.length;if(!r)return;const o=e.height/r;let a=1,n=!0;for(;n;){n=!1;let t=0;for(let i=0;i<r;i+=a){const r=s[i],l=Math.round(e.bottom-o*(i+.5)+r.metrics.height/4);if(t&&l>=t){a++,n=!0;break}t=l-r.metrics.height}}for(let n=0;n<r;n+=a){const r=s[n],a=Math.round(e.bottom-o*(n+.5)+r.metrics.height/4);this.RenderText(this.axis_group,r.label,"right",{x:t,y:a},i)}}RenderYAxis(e,t,s,i){const r=s.length;if(!r)return;const o=e.height/(r-1);let a=1,n=!0;for(;n;){n=!1;let t=0;for(let i=0;i<r;i+=a){const r=s[i],l=Math.round(e.bottom-o*i+r.metrics.height/4);if(t&&l>=t){a++,n=!0;break}t=l-r.metrics.height}}for(let n=0;n<r;n+=a){const r=s[n],a=Math.round(e.bottom-o*n+r.metrics.height/4);this.RenderText(this.axis_group,r.label,"right",{x:t,y:a},i)}}LineProperties(e,t){const s=t.x-e.x,i=t.y-e.y;return{length:Math.sqrt(s*s+i*i),angle:Math.atan2(i,s)}}RenderSmoothLine(e,t,s=!1,i,r){const o=ws("g"),a=[],n=[],l=t.length,h=l-1,c=e.width/l/2,d=[],u=t.map(((t,s)=>{if(void 0!==t)return{x:Math.round(e.left+e.width/h*s),y:e.bottom-t}}));let m=[];const f=()=>{if(m.length<2)return;let t="";const i=m[0],r=m[m.length-1];2===m.length?t=`${m[0].x},${m[0].y} L${m[1].x},${m[1].y}`:m.length>2&&(t=""+this.CatmullRomChain(m).map((e=>`${e.x},${e.y}`)).join(" L")),t&&(a.push("M"+t),s&&(n.push(`M ${i.x},${e.bottom} L ${i.x},${i.y}`),n.push("L"+t),n.push(`L ${r.x},${e.bottom}`)))};for(const e of u)e?m.push(e):(f(),m=[]);if(m.length&&f(),s&&o.appendChild(ws("path",{class:"fill",d:n})),o.appendChild(ws("path",{class:"line",d:a})),void 0!==r&&("string"==typeof r&&(r=[r]),o.setAttribute("class",r.join(" "))),this.group.appendChild(o),i&&d.length){const e=document.createElementNS(vs,"g");for(const t of d){const s=ws("circle",{cx:t.x,cy:t.y,r:c});s.addEventListener("mouseenter",(e=>{this.parent.setAttribute("title",i[t.i]||"")})),s.addEventListener("mouseleave",(e=>{this.parent.setAttribute("title","")})),e.appendChild(s)}e.setAttribute("class","mouse-layer"),this.group.appendChild(e)}}RenderLine(e,t,s=!1,i,r){const o=document.createElementNS(vs,"g"),a=[],n=[],l=t.length,h=l-1,c=e.width/l/2,d=[];let u,m=0,f=!0;for(;m<l;m++){const i=t[m];if(void 0===i){f=!0,s&&void 0!==u&&n.push(`L${u} ${e.bottom}Z`),u=void 0;continue}const r=Math.round(+e.left+e.width/h*m);f?(s&&n.push(`M${r} ${e.bottom} L${r} ${e.bottom-i}`),a.push(`M${r} ${e.bottom-i}`)):(a.push(`L${r} ${e.bottom-i}`),n.push(`L${r} ${e.bottom-i}`)),d.push({x:r,y:e.bottom-i,i:m}),u=r,f=!1}if(s&&void 0!==u&&n.push(`L${u} ${e.bottom}Z`),s&&o.appendChild(ws("path",{class:"fill",d:n})),o.appendChild(ws("path",{class:"line",d:a})),void 0!==r&&("string"==typeof r&&(r=[r]),o.setAttribute("class",r.join(" "))),this.group.appendChild(o),i&&d.length){const e=document.createElementNS(vs,"g");for(const t of d){const s=ws("circle",{cx:t.x,cy:t.y,r:c});s.addEventListener("mouseenter",(e=>{this.parent.setAttribute("title",i[t.i]||"")})),s.addEventListener("mouseleave",(e=>{this.parent.setAttribute("title","")})),e.appendChild(s)}e.setAttribute("class","mouse-layer"),this.group.appendChild(e)}}RenderBarGrid(e,t,s){const i=[],r=e.width/t;for(let s=0;s<=t;s++){const t=Math.round(e.left+r*s)-.5;i.push(`M${t} ${e.top} L${t} ${e.bottom}`)}this.group.appendChild(ws("path",{d:i,class:s}))}RenderGrid(e,t,s=0,i){const r=[];let o=e.height/t;for(let s=0;s<=t;s++){const t=Math.round(e.top+o*s)-.5;r.push(`M${e.left} ${t} L${e.right} ${t}`)}o=e.width/(s-1);for(let t=0;t<s;t++){const s=Math.round(e.left+o*t)-.5;r.push(`M${s} ${e.top} L${s} ${e.bottom}`)}this.group.appendChild(ws("path",{d:r,class:i}))}MultiplyPoint(e,t){return{x:e.x*t,y:e.y*t}}AddPoints(e,t){return{x:e.x+t.x,y:e.y+t.y}}CatmullRomSpline(e,t){let s=.5;s/=2;const i=(e,t,s)=>{const{x:i,y:r}=t,{x:o,y:a}=s;return Math.pow(Math.pow(o-i,2)+Math.pow(a-r,2),.25)+e},r=i(0,e[0],e[1]),o=i(r,e[1],e[2]),a=i(o,e[2],e[3]),n=(o-r)/t,l=[];for(let s=0;s<t;s++){const t=r+n*s,i=this.AddPoints(this.MultiplyPoint(e[0],(r-t)/(r-0)),this.MultiplyPoint(e[1],(t-0)/(r-0))),h=this.AddPoints(this.MultiplyPoint(e[1],(o-t)/(o-r)),this.MultiplyPoint(e[2],(t-r)/(o-r))),c=this.AddPoints(this.MultiplyPoint(e[2],(a-t)/(a-o)),this.MultiplyPoint(e[3],(t-o)/(a-o))),d=this.AddPoints(this.MultiplyPoint(i,(o-t)/(o-0)),this.MultiplyPoint(h,(t-0)/(o-0))),u=this.AddPoints(this.MultiplyPoint(h,(a-t)/(a-r)),this.MultiplyPoint(c,(t-r)/(a-r))),m=this.AddPoints(this.MultiplyPoint(d,(o-t)/(o-r)),this.MultiplyPoint(u,(t-r)/(o-r)));l.push(m)}return l}CatmullRomChain(e,t=30){const s=e.slice(0),i=[],r=s.length;if(r){let e=s[r-1].x-s[r-2].x,o=s[r-1].y-s[r-2].y;s.push({x:s[r-1].x+e,y:s[r-1].y+o}),s.push({x:s[r-1].x+e,y:s[r-1].y+o}),e=s[1].x-s[0].x,o=s[1].y-s[0].y,s.unshift({x:s[0].x-e,y:s[0].y-o});for(let e=0;e<s.length-4;e++){const r=s.slice(e,e+4),o=this.CatmullRomSpline(r,t);i.push(...o)}}return i}RenderDataLabels(e,t,s,i,r,o,a){const n=Math.max(t.length,s.length),l=i.max-i.min||1,h=r.max-r.min||1;for(let c=0;c<n;c++){const n=t[c],d=s[c];if(void 0!==n&&void 0!==d){const t={x:e.left+(n-i.min)/l*e.width,y:e.bottom-(d-r.min)/h*e.height},s=o[c];if(s){this.label_group.appendChild(ws("circle",{class:"label-target",cx:t.x,cy:t.y,r:10}));const i=ws("g",{class:"data-label",transform:`translate(${t.x+10},${t.y})`});this.label_group.appendChild(i);const r=ws("circle",{cx:-10,y:0,r:5,class:`marker-highlight series-${a}`});i.appendChild(r);const o=ws("text",{x:4,y:0},s);i.appendChild(o);const n=o.getBoundingClientRect(),l=n.height,h=n.width+8;h+15+t.x>=e.right&&(i.setAttribute("transform",`translate(${t.x-h-15},${t.y})`),r.setAttribute("cx",(h+15).toString()));const c=ws("path",{d:`M0,5 h${h} v-${l} h-${h} Z`});i.insertBefore(c,o)}}}}RenderScatterSeries(e,t,s,i,r,o=!0,a=!1,n=!1,l=!1,h=!1,c){const d=Math.max(t.length,s.length),u=i.max-i.min||1,m=r.max-r.min||1,f=[],p=[],_=[],g=ws("g",{class:c});this.group.appendChild(g);for(let o=0;o<d;o++){const a=t[o],n=s[o];void 0===a||void 0===n?f.push(void 0):f.push({x:e.left+(a-i.min)/u*e.width,y:e.bottom-(n-r.min)/m*e.height})}if(o){let t=[];const s=h?()=>2===t.length?`${t[0].x},${t[0].y} L${t[1].x},${t[1].y}`:t.length>2?this.CatmullRomChain(t).map((e=>`${e.x},${e.y}`)).join(" L"):"":()=>t.map((e=>`${e.x},${e.y}`)).join(" L");for(const i of f)if(i)t.push(i);else{if(t.length>=2){const i=s();p.push("M"+i),_.push(`M${t[0].x},${e.bottom}L`+i+`L${t[t.length-1].x},${e.bottom}Z`)}t=[]}if(t.length>=2){const i=s();p.push("M"+i),_.push(`M${t[0].x},${e.bottom}L`+i+`L${t[t.length-1].x},${e.bottom}Z`)}}if(n&&g.appendChild(ws("path",{d:_,class:"fill"})),o&&g.appendChild(ws("path",{d:p,class:"line"})),a)for(const e of f)e&&g.appendChild(ws("circle",{cx:e.x,cy:e.y,r:1,class:"point"}));if(l)for(const e of f)e&&g.appendChild(ws("circle",{cx:e.x,cy:e.y,r:3,class:"marker"}))}RenderPoints(e,t,s,i){const r=[];for(let i=0;i<t.length;i++){const o=t[i]*e.width+e.left,a=e.bottom-s[i]*e.height;r.push(`M${o-1},${a-1} L${o+1},${a+1}`),r.push(`M${o-1},${a+1} L${o+1},${a-1}`)}this.group.appendChild(ws("path",{d:r,class:i}))}RenderPoint(e,t,s){this.group.appendChild(ws("circle",{cx:e,cy:t,r:1,class:s}))}RenderRectangle(e,t,s,i,r,o){let a="";if(t)if(t[0]&&t[0]===t[1]&&t[0]>=e.height){const s=t[0],i=t[0]-e.height,r=Math.sqrt(s*s-i*i);a=`M${e.left+e.width/2-r},${e.bottom} a${s},${s} 0 0 1 ${2*r},0 z`}else if(t[1]&&t[1]===t[2]&&t[1]>=e.width){const s=t[1],i=t[1]-e.width,r=Math.sqrt(s*s-i*i);a=`M${e.left},${e.top+e.height/2-r} a${s},${s} 0 0 1 0,${2*r} z`}else a=`M${e.left},${e.top+t[0]} a${t[0]},${t[0]} 0 0 1 ${t[0]},${-t[0]} h${e.width-t[0]-t[1]} a${t[1]},${t[1]} 0 0 1 ${t[1]},${t[1]} v${e.height-t[1]-t[2]} a${t[2]},${t[2]} 0 0 1 ${-t[2]},${t[2]} h${-e.width+t[2]+t[3]} a${t[3]},${t[3]} 0 0 1 ${-t[3]},${-t[3]} v${-e.height+t[3]+t[0]} `;else a=`M${e.left},${e.top} h${e.width} v${e.height} h${-e.width} v${-e.height} `;const n=ws("path",{d:a,class:s});if(i&&(n.addEventListener("mouseenter",(e=>{this.parent.setAttribute("title",i)})),n.addEventListener("mouseleave",(e=>{this.parent.setAttribute("title","")}))),this.group.appendChild(n),r){this.label_group.appendChild(ws("path",{class:"label-target",d:a}));const t=o||{x:Math.round(e.left+e.width/2),y:Math.round(e.top-10)},s=ws("g",{class:"data-label",transform:`translate(${t.x},${t.y})`});this.label_group.appendChild(s);const i=ws("text",{x:0,y:0},r);s.appendChild(i);const n=i.getBoundingClientRect(),l=n.height,h=n.width+8;t.y-n.height<4&&(t.y-=t.y-n.height-4,s.setAttribute("transform",`translate(${t.x},${t.y})`)),i.setAttribute("x",Math.floor(-n.width/2).toString());const c=Math.ceil(.125*l),d=ws("rect",{rx:3,x:-h/2,y:Math.round(2*c/3-l),width:h,height:l+c});s.insertBefore(d,i)}}RenderText(e,t,s,i,r){const o=ws("text",{x:i.x,y:i.y,class:r},t);switch(s){case"right":o.style.textAnchor="end";break;case"center":o.style.textAnchor="middle";break;default:o.style.textAnchor="start"}(e||this.group).appendChild(o)}RenderDonut(e,t,s,i,r,o,a){let n=-Math.PI/2,l=0;o&&(s*=.8,i*=.7);const h=(e,t,s)=>[Math.cos(s)*t+e.x,Math.sin(s)*t+e.y];for(const o of e){const e=o.title||"",c=o.percent,d=o.index;let u=[],m=0;const f=h.bind(0,t,s),p=h.bind(0,t,i);if(c>.5){m=n+c/2*Math.PI*2,l=n+c*Math.PI*2;const e=m-n,t=l-m;u.push(`M${f(n)}`,`A${s},${s},${e},0,1,${f(m)}`,`A${s},${s},${t},0,1,${f(l)}`,`L${p(l)}`,`A${i},${i},${t},0,0,${p(m)}`,`A${i},${i},${e},0,0,${p(n)}`,"Z")}else{l=n+c*Math.PI*2,m=(l-n)/2+n;const e=l-n;u.push(`M${f(n)}`,`A${s},${s},${e},0,1,${f(l)}`,`L${p(l)}`,`A${i},${i},${e},0,0,${p(n)}`,"Z")}const _=ws("path",{d:u,class:void 0===d?void 0:`series-${d}`}),g=ws("g",{class:a});if(g.appendChild(_),this.group.appendChild(g),c>=.05&&e){u=[];const o=h(t,i+(s-i)/2+(s-i),m);u.push(`M${h(t,i+(s-i)/2,m)}`),u.push(`L${o}`),g.appendChild(ws("path",{d:u,class:"callout"}));const a=[],n=ws("text",{class:"callout-label"});g.appendChild(n);const l=m+Math.PI/2,c=e;n.textContent=c;let d=n.getBoundingClientRect();const f={width:d.width,height:d.height};let[p,_]=o;p+=f.height/2*Math.cos(m),_+=f.height/4+f.height/2*Math.sin(m);let y=!1;l>Math.PI?p-f.width<=r.left&&(y=!0):p+f.width>r.right&&(y=!0);const v=/[\s-]/;if(y&&v.test(c)){let e=-1,t=1;for(let s=0;s<c.length;s++)if(v.test(c[s])){const i=Math.abs(.5-s/c.length);i<t&&(t=i,e=s)}e>0&&(a.push(c.substr(0,e+1).trim()),a.push(c.substr(e+1).trim()))}if(a.length){let e=0,t=0;const s=a.map((e=>{n.textContent=e,d=n.getBoundingClientRect();const s={width:d.width,height:d.height};return t=Math.max(t,s.width),{text:e,metrics:s}}));n.textContent="";for(const i of s){const s=document.createElementNS(vs,"tspan");s.textContent=i.text;const r=l>Math.PI?p-(t-i.metrics.width)/2:p+(t-i.metrics.width)/2;s.setAttribute("x",r.toString()),s.setAttribute("dy",e.toString()),n.appendChild(s),e=i.metrics.height}}const b=l>Math.PI?"end":"start";n.setAttribute("text-anchor",b),n.setAttribute("x",p.toString()),n.setAttribute("y",_.toString())}n=l}}}class Cs{static Scale(e,t,s=6.5){return j(e,t,s)}static Range(e){let t,s;for(const i of e)void 0!==i&&((void 0===t||t>i)&&(t=i),(void 0===s||s<i)&&(s=i));return{min:t,max:s,range:void 0===t||void 0===s?0:s-t}}static ApplyScale(e,t,s){return t*(e-s.min)/(s.max-s.min)}static Flatten(e){let t=[];if(Array.isArray(e))for(const s of e)Array.isArray(s)?t=t.concat(this.Flatten(s)):t.push(s);else void 0!==e&&t.push(e);return t}}s(897);const Ss="#,##0.00";class As{constructor(e=new xs){this.renderer=e,this.chart_data={type:"null"},this.margin={top:.025,left:.05,bottom:.025,right:.075}}Initialize(e){this.renderer.Initialize(e)}Exec(e,t){const s=(null==t?void 0:t.value)||[];switch(e.toLowerCase()){case"mc.histogram":this.CreateHistogram(s);break;case"mc.correlation":this.CreateScatter(s);break;case"column.chart":this.CreateColumnChart(s,"column");break;case"bar.chart":this.CreateColumnChart(s,"bar");break;case"line.chart":this.CreateLineChart(s,"line");break;case"area.chart":this.CreateLineChart(s,"area");break;case"donut.chart":case"pie.chart":this.CreateDonut(s,"pie.chart"===e.toLowerCase());break;case"scatter.plot":this.CreateScatterChart(s,"plot");break;case"scatter.line":this.CreateScatterChart(s,"line");break;default:this.Clear()}}Clear(){this.chart_data={type:"null"}}CreateColumnChart(e,t){var s,i;const r=this.TransformSeriesData(e[0]),o=this.CommonData(r);let n;if(e[1]){n=(e[1].type===a.array?Cs.Flatten(e[1].value):Cs.Flatten(e[1])).map((e=>e?e.type===a.object&&"metadata"===e.value.type?"number"==typeof e.value.value?Q.Get(e.value.format||Ss).Format(e.value.value):e.value.value:"number"==typeof e.value?Q.Get(e.format||Ss).Format(e.value):e.value:""));const t=r.reduce(((e,t)=>Math.max(e,t.y.data.length)),0);for(t<n.length&&(n=n.slice(0,t));t>n.length;)n.push("")}const l=(null===(s=e[2])||void 0===s?void 0:s.toString())||void 0,h=(null===(i=e[3])||void 0===i?void 0:i.toString())||void 0;if(this.chart_data={type:t,legend:o.legend,legend_style:ys.marker,series2:r,scale:o.y.scale,title:l,y_labels:"bar"===t?n:o.y.labels,x_labels:"bar"===t?o.y.labels:n},h){this.chart_data.round=/round/i.test(h),this.chart_data.data_labels=/labels/i.test(h);const e=h.match(/labels="(.*?)"/);e&&r&&this.ApplyLabels(r,e[1],n)}}ReadSeries(e){var t,s,i,r;const o={x:{data:[]},y:{data:[]}};if(e[0]){const i=Cs.Flatten(e[0]);"object"==typeof i[0]?o.label=(null===(s=null===(t=i[0])||void 0===t?void 0:t.value)||void 0===s?void 0:s.toString())||"":o.label=i[0].toString()}if(e[2]&&"object"==typeof e[2]&&e[2].type===a.array){const t=Cs.Flatten(e[2].value);if(o.y.data=t.map((e=>"number"==typeof e.value.value?e.value.value:void 0)),null===(i=t[0].value)||void 0===i?void 0:i.format){o.y.format=null===(r=t[0].value)||void 0===r?void 0:r.format;const e=Q.Get(o.y.format);o.y.labels=o.y.data.map((t=>void 0===t?void 0:e.Format(t)))}}if(e[1]&&"object"==typeof e[1]&&e[1].type===a.array){const t=Cs.Flatten(e[1].value);o.x.data=t.map((e=>"number"==typeof e.value.value?e.value.value:void 0)),t[0].value.format&&(o.x.format=t[0].value.format)}for(const e of[o.x,o.y])if(e.data.length){const t=e.data.filter((e=>e||0===e));e.range={min:Math.min.apply(0,t),max:Math.max.apply(0,t)}}return o}ArrayToSeries(e){const t={x:{data:[]},y:{data:[]}},s=Cs.Flatten(e.value);if(t.y.data=s.map(((e,s)=>"number"==typeof e.value?e.value:"number"==typeof e.value.value.real?(t.x.data[s]=e.value.value.real,e.value.value.imaginary):"number"==typeof e.value.value?e.value.value:void 0)),s[0].value.format){t.y.format=s[0].value.format||"";const e=Q.Get(t.y.format||"");t.y.labels=t.y.data.map((t=>void 0===t?void 0:e.Format(t)))}const i=t.y.data.filter((e=>e||0===e));if(t.y.range={min:Math.min.apply(0,i),max:Math.max.apply(0,i)},t.x.data.length){const e=t.x.data.filter((e=>"number"==typeof e));if(t.x.range={min:Math.min.apply(0,e),max:Math.max.apply(0,e)},s[0].value.format){t.x.format=s[0].value.format||"";const e=Q.Get(t.x.format||"");t.x.labels=t.x.data.map((t=>void 0===t?void 0:e.Format(t)))}}return t}TransformSeriesData(e,t){if(!e)return[];const s=[];if(e.type===a.object){if("group"===e.key){if(Array.isArray(e.value))for(const t of e.value)if(t&&"object"==typeof t)if("series"===t.key){const e=this.ReadSeries(t.value);s.push(e)}else t.type===a.array&&s.push(this.ArrayToSeries(t))}else if("series"===e.key){const t=this.ReadSeries(e.value);s.push(t)}}else e.type===a.array&&s.push(this.ArrayToSeries(e));let i,r=0;if((null==t?void 0:t.type)===a.array){const e=Cs.Flatten(t.value);let s="0.00###";e[0]&&e[0].type===a.object&&(s=e[0].value.format);const r=e.map((e=>e.type===a.number?e.value:e.type===a.object?e.value.value:void 0)),o=r.filter((e=>"number"==typeof e));i={data:r,format:s,range:{min:Math.min.apply(0,o),max:Math.max.apply(0,o)}}}for(const e of s)r=Math.max(r,e.y.data.length),e.x.data.length&&(i||(i=e.x));if(!i){i={data:[],range:{min:0,max:Math.max(0,r-1)}};for(let e=0;e<r;e++)i.data.push(e)}for(const e of s)e.x.data.length||(e.x=i);return s}CommonData(e,t,s){let i,r="",o="";for(const t of e)t.y.format&&!o&&(o=t.y.format),t.x.format&&!r&&(r=t.x.format);e.some((e=>e.label&&e.label.length>0))&&(i=e.map(((e,t)=>e.label||`Series ${t+1}`)));const a=e.filter((e=>e.x.range)),n=Math.min.apply(0,a.map((e=>{var t;return(null===(t=e.x.range)||void 0===t?void 0:t.min)||0}))),l=Math.max.apply(0,a.map((e=>{var t;return(null===(t=e.x.range)||void 0===t?void 0:t.max)||0})));e.filter((e=>e.y.range));let h=Math.min.apply(0,a.map((e=>{var t;return(null===(t=e.y.range)||void 0===t?void 0:t.min)||0}))),c=Math.max.apply(0,a.map((e=>{var t;return(null===(t=e.y.range)||void 0===t?void 0:t.max)||0})));void 0!==t&&(h=Math.min(h,t)),void 0!==s&&(c=Math.max(c,s));const d=Cs.Scale(n,l,7),u=Cs.Scale(h,c,7);let m,f;if(r){m=[];const e=Q.Get(r);for(let t=0;t<=d.count;t++)m.push(e.Format(d.min+t*d.step))}if(o){f=[];const e=Q.Get(o);for(let t=0;t<=u.count;t++)f.push(e.Format(u.min+t*u.step))}return{x:{format:r,scale:d,labels:m},y:{format:o,scale:u,labels:f},legend:i}}CreateScatterChart(e,t="plot"){var s,i;const r=this.TransformSeriesData(e[0]),o=this.CommonData(r),a=(null===(s=e[1])||void 0===s?void 0:s.toString())||void 0,n=(null===(i=e[2])||void 0===i?void 0:i.toString())||void 0;if(this.chart_data={legend:o.legend,style:t,type:"scatter2",series:r,title:a,x_scale:o.x.scale,x_labels:o.x.labels,y_scale:o.y.scale,y_labels:o.y.labels,lines:"line"===t,points:"plot"===t},n){this.chart_data.markers=/marker/i.test(n),this.chart_data.smooth=/smooth/i.test(n),this.chart_data.data_labels=/labels/i.test(n);const e=n.match(/labels="(.*?)"/);e&&this.chart_data.series&&this.ApplyLabels(this.chart_data.series,e[1])}}ApplyLabels(e,t,s){for(const i of e){const e={x:Q.Get(i.x.format||""),y:Q.Get(i.y.format||"")};i.y.labels=[];for(let r=0;r<i.y.data.length;r++){const o=s?s[r]:"number"==typeof i.x.data[r]?e.x.Format(i.x.data[r]):"",a="number"==typeof i.y.data[r]?e.y.Format(i.y.data[r]):"";i.y.labels[r]=t.replace(/\bx\b/g,o).replace(/\by\b/g,a)}}}CreateLineChart(e,t){var s,i;const r=this.TransformSeriesData(e[0],e[1]),o=this.CommonData(r,0,0),a=(null===(s=e[2])||void 0===s?void 0:s.toString())||void 0,n=(null===(i=e[3])||void 0===i?void 0:i.toString())||void 0;this.chart_data={legend:o.legend,type:"scatter2",series:r,title:a,x_scale:o.x.scale,x_labels:o.x.labels,y_scale:o.y.scale,y_labels:o.y.labels,lines:!0,filled:"area"===t},n&&(this.chart_data.smooth=/smooth/i.test(n))}CreateDonut(e,t=!1){var s,i;const r=(null===(s=e[0])||void 0===s?void 0:s.type)===a.array?e[0].value:e[0],o=Cs.Flatten(r);let n=o.map((e=>"number"==typeof e.value.value?e.value.value:void 0));const l=(null===(i=e[1])||void 0===i?void 0:i.type)===a.array?e[1].value:e[1],h=Cs.Flatten(l).map((e=>{var t,s,i;if(e&&"object"==typeof e){const r=null===(t=e.value)||void 0===t?void 0:t.value;return"number"==typeof r&&(null===(s=e.value)||void 0===s?void 0:s.format)?Q.Get(null===(i=e.value)||void 0===i?void 0:i.format).Format(r):r?r.toString():""}return e?e.toString():""}));n=n.map((e=>e<0?(console.warn("pie/donut chart does not support negative values (omitted)"),0):e));const c=e[2]||"";let d=0;const u=n.map(((e,t)=>(void 0!==e&&(d+=e),{value:e,label:h[t]||"",index:t+1,percent:0})));if(d)for(const e of u)e.percent=(e.value||0)/d;const m=o.length&&o[0].format?o[0].format:"",f=Q.Get(m||Ss),p=Q.Get("percent");void 0===e[4]&&e[1]&&(e[4]="label");const _=e[4]||"";if(_)for(const e of u){const t=f.Format(e.value||0),s=p.Format(e.percent);e.title=_.replace(/value%/gi,p.Format(e.value||0)).replace(/value/gi,t).replace(/percent/gi,s).replace(/label/gi,e.label||"").trim()}const g=(e[3]||"").toString().trim();/^(asc|inc)/i.test(g)?u.sort(((e,t)=>(e.value||0)-(t.value||0))):/^(desc|dec)/i.test(g)&&u.sort(((e,t)=>(t.value||0)-(e.value||0))),this.chart_data={type:t?"pie":"donut",slices:u,title:c}}CreateScatter(e){const t=[e[0],e[1]];if(!t[0]||t[0].type!==a.object||!this.IsCellData(t[0].value))return console.warn("invalid args [0]",e),void this.Clear();if(!t[1]||t[1].type!==a.object||!this.IsCellData(t[1].value))return console.warn("invalid args [1]",e),void this.Clear();const s=e[2]||"",i=t[0].value,r=t[1].value;let o=(i.simulation_data||[]).slice(0),n=(r.simulation_data||[]).slice(0);const l=Math.min.apply(0,o),h=Math.max.apply(0,o)-l;o=o.map((e=>(e-l)/h));const c=Math.min.apply(0,n),d=Math.max.apply(0,n)-c;n=n.map((e=>(e-c)/d));const u=Math.min(o.length,n.length);this.chart_data={type:"scatter",x:o,y:n,count:u,title:s}}CreateHistogram(e){var t,s;const i=[],r=[],o=Array.isArray(e[0])?e[0]:[e[0]];for(const t of o){if(!t||t.type!==a.object||!this.IsCellData(t.value))return console.warn("invalid args [0]",e),void this.Clear();const s=t.value.simulation_data||[];s.length&&(i.push(Math.min.apply(0,s)),r.push(Math.max.apply(0,s)))}if(!i.length||!r.length)return console.info("no data"),void this.Clear();let n=12;"number"==typeof e[3]&&(n=e[3]);const l=Cs.Scale(Math.min.apply(0,i),Math.max.apply(0,r),n),h=[];for(let e=0;e<=l.count;e++)h[e]=l.min+e*l.step;const c=o.map((e=>{const t=e.value.simulation_data||[],s=[];for(let e=0;e<=l.count;e++)s[e]=0;for(const e of t)s[Math.round((e-l.min)/l.step)]++;const i=Q.Get("#,##0"),r=s.filter((e=>e||0===e)),o={y:{data:s,format:"#,##0",labels:s.map((e=>void 0===e?void 0:i.Format(e))),range:{min:Math.min.apply(0,r),max:Math.max.apply(0,r)}},x:{data:[],range:{min:0,max:Math.max(0,s.length-1)}}};for(let e=0;e<o.y.data.length;e++)o.x.data.push(e);return o})),d=this.CommonData(c),u=Q.Get((null===(t=o[0].value)||void 0===t?void 0:t.format)||"General"),m=h.map((e=>u.Format(e))),f=(null===(s=e[1])||void 0===s?void 0:s.toString())||void 0;c[0].y.labels=(c[0].y.labels||[]).map(((e,t)=>m[t]+" "+e)),this.chart_data={type:"column",series2:c,scale:d.y.scale,title:f,y_labels:d.y.labels,x_labels:m,data_labels:!0}}Resize(){this.renderer.Resize()}Update(){this.renderer.Resize(),this.renderer.Prerender(),this.renderer.Clear();const e=new ps(0,0,this.renderer.size.width,this.renderer.size.height),t={top:Math.round(e.height)*this.margin.top,bottom:Math.round(e.height)*this.margin.bottom,left:Math.round(e.width)*this.margin.left,right:Math.round(e.width)*this.margin.right},s=this.chart_data.title;if(s&&this.renderer.RenderTitle(s,e,t.top,this.chart_data.title_layout||"top"),e.top+=t.top,e.left+=t.left,e.bottom-=t.bottom,e.right-=t.right,this.chart_data.legend&&this.chart_data.legend.length){let t=gs.top;this.chart_data.title&&(this.chart_data.title_layout&&"top"!==this.chart_data.title_layout||(t=gs.bottom));const s=this.chart_data.legend_position||t;this.renderer.Legend({labels:this.chart_data.legend,position:s,style:this.chart_data.legend_style,layout:s===gs.top||s===gs.bottom?_s.horizontal:_s.vertical,area:e})}if("histogram"===this.chart_data.type||"line"===this.chart_data.type||"area"===this.chart_data.type||"column"===this.chart_data.type||"bar"===this.chart_data.type||"scatter2"===this.chart_data.type){let s=[],i=0;if(this.chart_data.x_labels&&this.chart_data.x_labels.length&&(s=this.chart_data.x_labels.map((e=>{const t=this.renderer.MeasureText(e,["axis-label","x-axis-label"],!0);return i=Math.max(i,t.height),t}))),this.chart_data.y_labels&&this.chart_data.y_labels.length){const r=[];let o=0,a=0;const n="scatter2"===this.chart_data.type?this.chart_data.y_scale:this.chart_data.scale,l="bar"===this.chart_data.type?this.chart_data.y_labels.length:n.count+1;for(let e=0;e<l;e++){const t=this.renderer.MeasureText(this.chart_data.y_labels[e],["axis-label","y-axis-label"]);r.push({label:this.chart_data.y_labels[e],metrics:t}),o=Math.max(o,t.width),a=Math.max(a,t.height)}e.bottom=Math.round(e.bottom-a/2),e.top=Math.round(e.top+a/2),s.length&&(e.bottom-=i+t.bottom),"bar"===this.chart_data.type?this.renderer.RenderYAxisBar(e,e.left+o,r,["axis-label","y-axis-label"]):this.renderer.RenderYAxis(e,e.left+o,r,["axis-label","y-axis-label"]),e.left+=o+t.left}s.length&&this.chart_data.x_labels&&this.chart_data.x_labels.length&&(this.chart_data.y_labels&&(e.bottom+=i+t.bottom),this.renderer.RenderXAxis(e,"line"!==this.chart_data.type&&"area"!==this.chart_data.type&&"bar"!==this.chart_data.type&&"scatter2"!==this.chart_data.type,this.chart_data.x_labels,s,["axis-label","x-axis-label"]),e.bottom-=i+t.bottom)}switch(this.chart_data.type){case"scatter":this.renderer.RenderPoints(e,this.chart_data.x,this.chart_data.y,"mc mc-correlation series-1");break;case"scatter2":if(this.renderer.RenderGrid(e,this.chart_data.y_scale.count,this.chart_data.x_scale.count+1,"chart-grid"),this.chart_data.series){for(let t=0;t<this.chart_data.series.length;t++){const s=this.chart_data.series[t];this.renderer.RenderScatterSeries(e,s.x.data,s.y.data,this.chart_data.x_scale,this.chart_data.y_scale,!!this.chart_data.lines,!!this.chart_data.points,!!this.chart_data.filled,!!this.chart_data.markers,!!this.chart_data.smooth,`scatter-plot series-${t+1}`)}if(this.chart_data.data_labels)for(let t=0;t<this.chart_data.series.length;t++){const s=this.chart_data.series[t];s.y.labels&&this.renderer.RenderDataLabels(e,s.x.data,s.y.data,this.chart_data.x_scale,this.chart_data.y_scale,s.y.labels,t+1)}}break;case"pie":case"donut":{const t=Math.min(e.height,e.width)/2*.9,s="pie"===this.chart_data.type?0:.8*t;this.renderer.RenderDonut(this.chart_data.slices,e.center,t,s,e,!0,"donut")}break;case"line":case"area":{const t=this.chart_data.scale;if(this.chart_data.series){const s=this.chart_data.x_scale?this.chart_data.x_scale.max:Math.max.apply(0,this.chart_data.series.map((e=>e.length))),i=this.chart_data.smooth?this.renderer.RenderSmoothLine:this.renderer.RenderLine;this.renderer.RenderGrid(e,this.chart_data.scale.count,this.chart_data.x_scale?this.chart_data.x_scale.count+1:s,"chart-grid");let r=0;for(const o of this.chart_data.series){const a=o.map((s=>{if(void 0!==s)return Cs.ApplyScale(s,e.height,t)}));if(a.length<s)for(let e=a.length;e<s;e++)a.push(void 0);const n=["area"===this.chart_data.type?"chart-area":"chart-line",`series-${r+1}`];i.call(this.renderer,e,a,"area"===this.chart_data.type,this.chart_data.titles,n),r++}}}break;case"bar":{let t;if(this.renderer.RenderBarGrid(e,this.chart_data.scale.count,"chart-grid"),this.chart_data.series2){let s=0;const i=this.chart_data.series2.length;for(const e of this.chart_data.series2)s=Math.max(s,e.y.data.length);const r=e.height/s;let o=.7;"number"==typeof this.chart_data.space&&(o=Math.max(0,Math.min(1,1-this.chart_data.space)));const a=r*(1-o)/2,n=(r-2*a)/i;let l=0;if(this.chart_data.scale.min<0&&(l=Cs.ApplyScale(0,e.width,this.chart_data.scale)),this.chart_data.round){const e=Math.floor(n/2);t=[0,e,e,0]}for(let s=0;s<i;s++){const i=this.chart_data.series2[s];for(let o=0;o<i.y.data.length;o++){const h=i.y.data[o];if("number"==typeof h){const i=Math.round(e.top+o*r+a)+s*n;let c=0,d=0,u=!1;l?h>0?(d=Cs.ApplyScale(h+this.chart_data.scale.min,e.width,this.chart_data.scale),c=e.left+l):(d=Cs.ApplyScale(this.chart_data.scale.min-h,e.width,this.chart_data.scale),c=e.left+l-d,u=!0):(d=Cs.ApplyScale(h,e.width,this.chart_data.scale),c=e.left);const m=void 0;d&&this.renderer.RenderRectangle(new ps(c,i,c+d,i+n),t,["chart-column",`series-${s+1}`],m||void 0)}}}}}break;case"column":if(this.renderer.RenderGrid(e,this.chart_data.scale.count,0,"chart-grid"),this.chart_data.series2){let t=0;const s=this.chart_data.series2.length;for(const e of this.chart_data.series2)t=Math.max(t,e.y.data.length);const i=e.width/t;let r=.7;"number"==typeof this.chart_data.space&&(r=Math.max(0,Math.min(1,1-this.chart_data.space)));const o=i*(1-r)/2,a=(i-2*o)/s;let n,l=0;if(this.chart_data.scale.min<0&&(l=Cs.ApplyScale(0,e.height,this.chart_data.scale)),this.chart_data.round){const e=Math.floor(a/2);n=[e,e,0,0]}for(let t=0;t<s;t++){const s=this.chart_data.series2[t];for(let r=0;r<s.y.data.length;r++){const h=s.y.data[r];if("number"==typeof h){const c=Math.round(e.left+r*i+o)+t*a;let d=0,u=0,m=!1;l?h>0?(d=Cs.ApplyScale(h+this.chart_data.scale.min,e.height,this.chart_data.scale),u=e.bottom-d-l):(d=Cs.ApplyScale(this.chart_data.scale.min-h,e.height,this.chart_data.scale),u=e.bottom-l,m=!0):(d=Cs.ApplyScale(h,e.height,this.chart_data.scale),u=e.bottom-d);const f=void 0;if(d){const e=this.chart_data.data_labels&&s.y.labels?s.y.labels[r]:"",i={x:Math.round(c+a/2),y:Math.round(u-10)};this.renderer.RenderRectangle(new ps(c,u,c+a,u+d),n,["chart-column",`series-${t+1}`],f||void 0,e,i)}}}}}break;case"histogram":{this.renderer.RenderGrid(e,this.chart_data.scale.count,0,"chart-grid");const t=e.width/this.chart_data.count,s=t*(1-this.chart_data.column_width)/2;for(let i=0;i<this.chart_data.count;i++){const r=Math.round(e.left+i*t+s),o=t-2*s,a=Cs.ApplyScale(this.chart_data.bins[i],e.height,this.chart_data.scale),n=e.bottom-a,l=this.chart_data.titles?this.chart_data.titles[i]:void 0;this.renderer.RenderRectangle(new ps(r,n,r+o,n+a),void 0,"chart-column series-1",l||void 0)}}}}IsCellData(e){return"object"==typeof e&&"object"==typeof e.address&&"number"==typeof e.address.row&&"number"==typeof e.address.column}}As.functions_registered=!1;const Ms=(...e)=>({type:a.object,value:e,key:"arguments"}),ks={Group:{arguments:[{name:"Array...",metadata:!0}],fn:(...e)=>({type:a.object,value:e,key:"group"})},Series:{arguments:[{name:"Label"},{name:"X",metadata:!0},{name:"Y",metadata:!0}],fn:(...e)=>({type:a.object,value:e,key:"series"})},"Bar.Chart":{arguments:[{name:"Data",metadata:!0},{name:"Categories",metadata:!0},{name:"ChartTitle"}],fn:Ms},"Line.Chart":{arguments:[{name:"y",metadata:!0},{name:"x",metadata:!0},{name:"ChartTitle"}],fn:Ms},"Area.Chart":{arguments:[{name:"y",metadata:!0},{name:"x",metadata:!0},{name:"ChartTitle"}],fn:Ms},"Pie.Chart":{arguments:[{name:"Values",metadata:!0},{name:"Labels"},{name:"Title"},{name:"Sort"},{name:"Label"}],fn:Ms},"Donut.Chart":{arguments:[{name:"Values",metadata:!0},{name:"Labels",metadata:!0},{name:"Title"},{name:"Sort"},{name:"Label"}],fn:Ms},"MC.Histogram":{arguments:[{name:"Reference Cell",metadata:!0},{name:"Title"}],fn:Ms},"MC.Correlation":{arguments:[{name:"Reference Cell 1",metadata:!0},{name:"Reference Cell 2",metadata:!0},{name:"Title"}],fn:Ms},"Scatter.Line":{arguments:[{name:"Data",metadata:!0},{name:"ChartTitle"}],fn:Ms},"Scatter.Plot":{arguments:[{name:"Data",metadata:!0},{name:"ChartTitle"}],fn:Ms},"Column.Chart":{arguments:[{name:"Data",metadata:!0},{name:"Categories",metadata:!0},{name:"Chart Title"}],fn:Ms}};var Rs,Ls=s(162);!function(e){e[e.automatic=0]="automatic",e[e.manual=1]="manual"}(Rs||(Rs={}));class Es extends U{constructor(e){super(),this.loaded=!1,this.calculation=Rs.automatic,this.file_version=0,this.last_save_version=0,this.registered_libraries={},this.undo_pointer=0,this.undo_stack=[],this.options=Object.assign(Object.assign({},ls),e),this.options.complex,"string"==typeof this.options.imaginary_value&&(Y.imaginary_character=this.options.imaginary_value);let t,s,i,r=this.options.network_document;this.options.storage_key&&!this.options.toll_initial_load&&(t=localStorage.getItem(this.options.storage_key)||void 0,t&&(s=cs.LOCAL_STORAGE),!t&&this.options.alternate_document&&(r=this.options.alternate_document),window.addEventListener("beforeunload",(()=>{this.options.storage_key&&this.SaveLocalStorage(this.options.storage_key)}))),"string"==typeof e.container?i=document.getElementById(e.container):e.container&&(i=e.container);const o={expand:!1,insert_function_button:!1,in_cell_editor:!0,repaint_on_cell_change:!1,markdown:!!this.options.markdown};if(this.options.scale&&(o.initial_scale=this.options.scale),void 0!==this.options.formula_bar&&(o.formula_bar=this.options.formula_bar),this.options.expand_formula_button&&(o.expand_formula_button=this.options.expand_formula_button),this.options.scrollbars&&(o.scrollbars=this.options.scrollbars),void 0!==this.options.tab_bar&&(o.tab_bar=this.options.tab_bar),this.options.scale_control&&(o.scale_control=!0,o.tab_bar=!0,this.options.persist_scale)){!0===this.options.persist_scale?o.persist_scale_key="spreadsheet-scale":o.persist_scale_key="spreadsheet-scale-"+this.options.persist_scale;const e=localStorage.getItem(o.persist_scale_key);if(e)try{const t=JSON.parse(e);o.initial_scale=t.scale||1}catch(e){}}if(this.options.add_tab&&(o.add_tab=this.options.add_tab),this.options.delete_tab&&(o.delete_tab=this.options.add_tab),this.options.expand&&(o.expand=!0),this.grid=new Ve(o),e.headless&&(this.grid.headless=!0),i){this.node=document.createElement("div"),i.appendChild(this.node),i.addEventListener("keydown",this.HandleKeyDown.bind(this));const s=!(!t&&!e.network_document);this.grid.Initialize(this.node,s),this.options.dnd&&(this.node.addEventListener("dragenter",(e=>this.HandleDrag(e))),this.node.addEventListener("dragover",(e=>this.HandleDrag(e))),this.node.addEventListener("drop",(e=>this.HandleDrop(e)))),this.grid.grid_events.Subscribe((e=>{var t;switch(e.type){case"error":null===(t=this.dialog)||void 0===t||t.ShowDialog({type:os.error,message:e.message,title:e.title,timeout:3e3,close_box:!0});break;case"selection":this.UpdateSelection(e.selection),this.UpdateSelectionStyle(e.selection);break;case"sheet-change":this.OnSheetChange(e),this.UpdateSelectionStyle();break;case"data":{const t=this.last_selection;(this.calculation===Rs.automatic?this.Recalculate(e):Promise.resolve()).then((()=>{this.DocumentChange(t)}))}break;case"style":this.DocumentChange(),this.UpdateDocumentStyles(!1),this.UpdateSelectionStyle();break;case"scale":this.RebuildAllAnnotations();break;case"annotation":if(e.annotation)switch(this.DocumentChange(),e.event){case"create":this.InflateAnnotation(e.annotation),this.calculator.UpdateAnnotations(e.annotation),this.grid.AnnotationUpdated(e.annotation);break;case"delete":this.calculator.RemoveAnnotation(e.annotation);break;case"update":e.annotation.update_callback?(e.annotation.update_callback(),this.grid.AnnotationUpdated(e.annotation)):console.info("annotation update event without update callback"),this.calculator.UpdateAnnotations(e.annotation);break;case"resize":e.annotation.resize_callback&&(e.annotation.resize_callback(),this.grid.AnnotationUpdated(e.annotation))}else console.info("annotation event without annotation");break;case"structure":this.DocumentChange(),e.rebuild_required&&this.calculator.Reset(),this.UpdateSelectionStyle();break;case"cell-event":this.HandleCellEvent(e)}})),this.options.prompt_save&&window.addEventListener("beforeunload",(e=>{this.last_save_version!==this.file_version&&(e.preventDefault(),e.returnValue="")}))}else console.info("not initializing grid; don't call UI functions"),this.grid.headless=!0;if(this.calculator=this.InitCalculator(),t?this.LoadDocument(JSON.parse(t),void 0,void 0,!!e.recalculate,void 0,void 0,s):r||this.calculator.RebuildClean(this.grid.model,!0),this.FlushUndo(),void 0!==e.show_headers&&this.grid.ShowHeaders(e.show_headers),this.options.scroll&&!this.options.network_document){const e=this.options.scroll;requestAnimationFrame((()=>{this.ScrollTo(e)}))}this.grid.SetAutocompleteFunctions(this.calculator.SupportedFunctions()),this.options.global_name&&(self[this.options.global_name]=this),r&&this.LoadNetworkDocument(r,this.options),i&&(this.dialog=new as(i))}static SniffPath(){const e=document.querySelectorAll("script"),t=new RegExp("embedded-treb-bundle");for(let s=0;s<e.length;s++){const i=e[s].src;if(i&&t.test(i))return i&&/\?.*?engine/i.test(i)&&(this.enable_engine=!0),i&&/\?.*?format/i.test(i)&&(this.enable_formatter=!0),this.treb_embedded_script_path=i,void(this.treb_base_path=i.replace(new RegExp("embedded-treb-bundle.*$"),""))}}get modified(){return 1!==this.undo_stack.length}get document_name(){return this.grid.model.document_name}set document_name(e){this.grid.model.document_name=e,this.DocumentChange()}get user_data(){return this.grid.model.user_data}set user_data(e){this.grid.model.user_data=e,this.DocumentChange()}get parser(){return this.calculator.parser}get script_path(){let e="embedded-treb-bundle";Es.treb_language&&(e+="-"+Es.treb_language),/\.js$/.test(e)||(e+=".js");let t=Es.treb_base_path;return t&&(/\/$/.test(t)||(t+="/"),e=t+e),e}HandleCellEvent(e){var t;if("hyperlink"===(null===(t=e.data)||void 0===t?void 0:t.type)){const t="hyperlink invalid target",s=e.data.data||"";if("string"==typeof s){if(/^https{0,1}:\/\//i.test(s)){if(!this.options.hyperlinks)return void console.warn("hyperlinks are disabled");const e=document.createElement("a");return e.setAttribute("target",this.options.hyperlinks),e.setAttribute("href",s),e.setAttribute("noreferrer","true"),e.setAttribute("nofollow","true"),void e.click()}{const e=this.parser.Parse(s);if(e.expression){if("address"===e.expression.type)return(e.expression.sheet||e.expression.sheet_id)&&this.ActivateSheet(e.expression.sheet||e.expression.sheet_id),void this.Select(s);if("range"===e.expression.type)return(e.expression.start.sheet||e.expression.start.sheet_id)&&this.ActivateSheet(e.expression.start.sheet||e.expression.start.sheet_id),void this.Select(s)}}return void console.warn(t,2)}}}Batch(e,s=!1){return t(this,void 0,void 0,(function*(){const t=this.last_selection,i=this.grid.Batch(e,s);let r=!1,o=!1;for(const e of i)"data"===e.type?r=!0:"structure"===e.type&&e.rebuild_required&&(o=!0);o&&this.calculator.Reset(),(r||o)&&(yield this.Recalculate(),this.DocumentChange(t))}))}OnSheetChange(e){for(const t of e.activate.annotations)this.InflateAnnotation(t),this.calculator.UpdateAnnotations(t);this.UpdateAnnotations()}HandleDrag(e){if(e.dataTransfer&&e.dataTransfer.types)if(e.dataTransfer.types.some&&e.dataTransfer.types.some((e=>"Files"===e)))e.preventDefault();else for(let t=0;t<e.dataTransfer.types.length;t++)if("files"===e.dataTransfer.types[t])return void e.preventDefault()}HandleDrop(e){if(e.dataTransfer&&e.dataTransfer.files&&e.dataTransfer.files.length){e.preventDefault();const t=e.dataTransfer.files[0];/^image/.test(t.type)?this.InsertImage(t):this.LoadFileInternal(t,cs.DRAG_AND_DROP).then((()=>{})).catch((e=>{var t;null===(t=this.dialog)||void 0===t||t.ShowDialog({title:"Error reading file",close_box:!0,message:"Please make sure your file is a valid XLSX, CSV or TREB file.",type:os.error,timeout:3e3}),console.error(e)}))}}Freeze(e=0,t=0){this.grid.Freeze(e,t,!0)}FreezeSelection(){const e=this.grid.GetSelection();if(e.empty)this.grid.Freeze(0,0);else{const t=e.area;t.entire_sheet||(t.entire_row?this.grid.Freeze(t.end.row+1,0):t.entire_column?this.grid.Freeze(0,t.end.column+1):this.grid.Freeze(t.end.row+1,t.end.column+1))}}GetFreeze(){return this.grid.GetFreeze()}UpdateTheme(e){this.grid.UpdateTheme(void 0,e),this.toolbar&&this.toolbar.UpdateTheme(this.grid.theme)}PostDocument(e,t){let s=!1,i=0;const r=JSON.stringify(this.SerializeDocument(!1,!0)),o=e=>{"ack"===e.data&&(s=!0,window.removeEventListener("message",o))};window.addEventListener("message",o);const a=(o=100)=>{if(i++>30)console.warn("timeout");else{try{e.postMessage(r,t)}catch(e){console.error(e)}setTimeout((()=>{s||a(o)}),o)}};e.focus(),a()}SetRange(e,t,s=!1,o=!1,a=!1){let n;if("string"==typeof e){const t=this.grid.model.named_ranges.Get(e);if(t)n=t.Clone();else{const t=e.split(":");n=t.length<2?new r(this.EnsureAddress(t[0])):new r(this.EnsureAddress(t[0]),this.EnsureAddress(t[1]))}}else n=i(e)?new r(e):new r(e.start,e.end);this.grid.SetRange(n,t,s,o,a)}ParseNumber(e){return se.TryParse(e).value}FormatNumber(e,t){return Q.Get(t).Format(e)}SetScale(e=1){this.grid.UpdateScale(e)}CreateChart(){return this.registered_libraries["treb-charts"]||(this.calculator.RegisterFunction(ks),this.registered_libraries["treb-charts"]=!0,this.grid.SetAutocompleteFunctions(this.calculator.SupportedFunctions())),new As}Evaluate(e){const t=this.parser.Parse(e);if(t&&t.expression){this.parser.Walk(t.expression,(e=>("address"!==e.type&&"range"!==e.type||this.calculator.ResolveSheetID(e),!0)));const e=this.calculator.CalculateExpression(t.expression);return e.type===a.array?e.value.map((e=>e.map((e=>e.value)))):e.value}}GetSheetID(e){if("number"==typeof e){const t=this.grid.model.sheets[e];if(t)return t.id}else{const t=e.toUpperCase();for(const e of this.grid.model.sheets)if(e.name.toUpperCase()===t)return e.id}}GetRange(e,t=!1,s=!1){if("string"==typeof e){const i=this.grid.model.named_ranges.Get(e);if(i)return this.grid.GetRange(i,t,s);{const i=e.split(":");return i.length<2?this.grid.GetRange(new r(this.EnsureAddress(i[0])),t,s):this.grid.GetRange(new r(this.EnsureAddress(i[0]),this.EnsureAddress(i[1])),t,s)}}return i(e)?this.grid.GetRange(e,t,s):this.grid.GetRange(new r(e.start,e.end),t,s)}DeleteSheet(e){if(e){e=e.toLowerCase();for(let t=0;t<this.grid.model.sheets.length;t++)if(this.grid.model.sheets[t].name.toLowerCase()===e){this.grid.DeleteSheet(t);break}}else this.grid.DeleteSheet();this.calculator.Reset()}AddSheet(e){this.grid.AddSheet(e),this.calculator.Reset()}InsertAnnotation(e,t="treb-chart",s){let i;if(s)if(p.IsRectangle(s))i=s;else if("string"==typeof s){let e;if(e=this.grid.model.named_ranges.Get(s),!e){const t=s.split(":");e=t.length<2?new r(this.EnsureAddress(t[0])):new r(this.EnsureAddress(t[0]),this.EnsureAddress(t[1]))}e&&(i=e)}const{x:o,y:a}=this.grid.GetScrollOffset(),n=this.grid.layout.scale||1;this.grid.CreateAnnotation({type:t,formula:e},void 0,void 0,i||{top:a/n+30,left:o/n+30,width:300,height:300})}InsertImage(e){var s;return t(this,void 0,void 0,(function*(){if(e||(e=yield this.SelectFile(".png, .jpg, .jpeg, .gif, .svg")),!e)return;if(this.options.max_file_size&&e.size>this.options.max_file_size)return void(null===(s=this.dialog)||void 0===s||s.ShowDialog({type:os.error,message:"This file exceeds the allowed image size. Please try a smaller image.",title:"Error adding image",timeout:3e3,close_box:!0}));const t=e;yield new Promise(((e,s)=>{const i=new FileReader;i.onload=()=>{try{if(i.result){let e;if("string"==typeof i.result)e=i.result;else{e="";const t=new Uint8Array(i.result);for(let s=0;s<t.byteLength;s++)e+=String.fromCharCode(t[s])}const t=document.createElement("img");t.src=e;const s=this.grid.CreateAnnotation({type:"image",formula:""},void 0,void 0,{top:30,left:30,width:t.width||300,height:t.height||300});s.data.src=e,s.data.original_size={width:t.width||300,height:t.height||300}}e()}catch(e){s(e)}},i.onabort=()=>{s("Aborted")},i.onerror=()=>{s("File error")},setTimeout((()=>{i.readAsDataURL(t)}),100)}))}))}SetLink(e,t=""){e=this.EnsureAddress(e),this.grid.SetLink(e,t)}ShowSheet(e=0,t=!0){this.grid.ShowSheet(e,t)}ActivateSheet(e){this.grid.ActivateSheet(e)}SetColumnWidth(e,t){this.grid.SetColumnWidth(e,t)}SetRowHeight(e,t){this.grid.SetRowHeight(e,t)}EnsureAddress(e){const t={row:0,column:0};if("string"==typeof e){const s=this.parser.Parse(e);if(s.expression&&"address"===s.expression.type)this.calculator.ResolveSheetID(s.expression),t.row=s.expression.row,t.column=s.expression.column,t.sheet_id=s.expression.sheet_id;else if(s.expression&&"range"===s.expression.type)this.calculator.ResolveSheetID(s.expression),t.row=s.expression.start.row,t.column=s.expression.start.column,t.sheet_id=s.expression.start.sheet_id;else if(s.expression&&"identifier"===s.expression.type){const e=this.grid.model.named_ranges.Get(s.expression.name);if(e)return e.start}}else t.row=e.row||0,t.column=e.column||0;return t}ScrollTo(e,t=!0,s=!0,i=!1){this.grid.ScrollTo(this.EnsureAddress(e),t,s,i)}InsertRow(){this.grid.InsertRow()}InsertColumn(){this.grid.InsertColumn()}DeleteRows(){this.grid.DeleteRows()}DeleteColumns(){this.grid.DeleteColumns()}ApplyBorders(e,t=1){this.grid.ApplyBorders(void 0,e,void 0,t)}MergeCells(){this.grid.MergeSelection()}UnmergeCells(){this.grid.UnmergeSelection()}ImportXLSX(e,s){return t(this,void 0,void 0,(function*(){if(!this.export_worker){const e="embedded-treb-export-worker";this.export_worker=yield this.LoadWorker(e)}return new Promise(((t,i)=>{var r;this.export_worker?(null===(r=this.dialog)||void 0===r||r.ShowDialog({message:"Importing XLSX..."}),this.export_worker.onmessage=e=>{var r;return e.data?"error"===e.data.status?i(e.data.error||"unknown error"):(this.grid.FromImportData(e.data.results),this.ResetInternal(),this.grid.Update(),this.calculator.AttachModel(this.grid.model),this.Publish({type:"load",source:s}),this.UpdateDocumentStyles(),this.InflateAnnotations(),null===(r=this.dialog)||void 0===r||r.HideDialog(),void t()):i("unknown error (missing data)")},this.export_worker.onerror=e=>{console.error("import worker error"),console.info(e),i(e)},this.export_worker.postMessage({command:"import",data:e})):i("worker failed")}))}))}ExportBlob(){return t(this,void 0,void 0,(function*(){if(!this.export_worker){const e="embedded-treb-export-worker";this.export_worker=yield this.LoadWorker(e)}return new Promise(((e,t)=>{if(this.export_worker){this.export_worker.onmessage=t=>{e(t.data?t.data.blob:void 0)},this.export_worker.onerror=e=>{console.error("export worker error"),console.info(e),t(e)};const s=this.grid.Serialize({rendered_values:!0,expand_arrays:!0,export_colors:!0,decorated_cells:!0});s.decimal_mark=f.decimal_separator,this.export_worker.postMessage({command:"export",sheet:s})}else t("worker failed")}))}))}Export(){this.ExportBlob().then((e=>{let t="export";this.grid.model.document_name&&(t=this.grid.model.document_name.toLowerCase().replace(/\s+/g,"-")),e&&(Ls.saveAs(e,t+".xlsx",{autoBom:!1}),this.last_save_version=this.file_version)})).catch((e=>{var t;throw/invalid uri/i.test(e.message)&&(null===(t=this.dialog)||void 0===t||t.ShowDialog({title:"Error exporting file",close_box:!0,message:"The worker cannot run from the filesystem, please use a web server.",timeout:3e3,type:os.error})),e}))}GetSelection(e=!1){const t=this.grid.GetSelection();if(t.empty)return"";const s=t.area.spreadsheet_label;if(e){const e=this.grid.active_sheet.name;return k.test(e)?`'${e}'!${s}`:`${e}!${s}`}return s}GetSelectionReference(){return this.grid.GetSelection()}Focus(){this.grid.Focus()}Resize(){this.grid.UpdateLayout(),this.Publish({type:"resize"})}ResetInternal(){this.calculator.Reset(),this.FlushUndo(),this.file_version=this.last_save_version=0}Reset(){this.grid.Clear(),this.ResetInternal(),this.calculator.AttachModel(this.grid.model),this.Publish({type:"reset"})}Select(e){let t;if(e)if("string"==typeof e){const s=this.grid.model.named_ranges.Get(e);if(s)t=s.Clone();else{const s=e.split(":");t=s.length<2?new r(this.EnsureAddress(s[0])):new r(this.EnsureAddress(s[0]),this.EnsureAddress(s[1]))}}else t=i(e)?new r(e):new r(e.start,e.end);this.grid.SelectRange(t)}ApplyStyle(e,t={},s=!0){let o;if(e)if("string"==typeof e){const t=this.grid.model.named_ranges.Get(e);if(t)o=t.Clone();else{const t=e.split(":");o=t.length<2?new r(this.EnsureAddress(t[0])):new r(this.EnsureAddress(t[0]),this.EnsureAddress(t[1]))}}else o=i(e)?new r(e):new r(e.start,e.end);this.grid.ApplyStyle(o,t,s)}Fetch(e){return t(this,void 0,void 0,(function*(){return new Promise(((t,s)=>{const i=new XMLHttpRequest;i.onload=()=>t(i.response),i.onerror=()=>s("load error"),i.ontimeout=()=>s("timeout"),i.open("GET",e),i.send()}))}))}LoadFromLocalStorage(e){this.options.storage_key=e;const t=localStorage.getItem(e);if(t)try{const e=JSON.parse(t);return this.LoadDocument(e,void 0,void 0,void 0,void 0,void 0,cs.LOCAL_STORAGE),!0}catch(e){console.error(e)}return!1}LoadNetworkDocument(e,s){var i;return t(this,void 0,void 0,(function*(){const t=s?s.scroll:void 0,r=!!s&&!!s.recalculate,o=s?s.sheet:void 0,a=/csv(?:$|\?|&)/i.test(e),n=/tsv(?:$|\?|&)/i.test(e);try{let s=yield this.Fetch(e);if("string"==typeof s)if(a)this.LoadCSV(s,cs.NETWORK_FILE);else{if(n)throw new Error("tsv not supported (TODO)");{"&&&START&&&"===s.substr(0,11)?s=s.substr(11):"for(;;);"===s.substr(0,8)&&(s=s.substr(8));const e=JSON.parse(s);this.LoadDocument(e,t,void 0,r,o,void 0,cs.NETWORK_FILE)}}}catch(t){console.info("error loading network document",e),console.error(t),null===(i=this.dialog)||void 0===i||i.ShowDialog({title:"Error loading file",close_box:!0,message:"The network document returned an error",type:os.error,timeout:3e3}),this.Reset()}}))}SelectFile(e){return new Promise((t=>{const s=document.createElement("input");let i,r;s.type="file",e&&(s.accept=e);const o=()=>{window.removeEventListener("focus",o),r=setTimeout(i,250)},a=()=>{r&&clearTimeout(r),i(s.files?s.files[0]:void 0)};i=e=>{s.removeEventListener("change",a),window.removeEventListener("focus",o),t(e)},s.addEventListener("change",a),window.addEventListener("focus",o),s.click()}))}LoadLocalFile(){var e;return t(this,void 0,void 0,(function*(){const t=yield this.SelectFile(".treb, .csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/json");if(t)try{return yield this.LoadFileInternal(t,cs.LOCAL_FILE),!0}catch(t){return null===(e=this.dialog)||void 0===e||e.ShowDialog({title:"Error reading file",close_box:!0,message:"Please make sure your file is a valid XLSX, CSV or TREB file.",type:os.error,timeout:3e3}),!1}return!1}))}LoadFileInternal(e,t){if(!e)return Promise.resolve();const s=new FileReader;return new Promise(((i,r)=>{const o=e=>{s.onload=null,s.onabort=null,s.onerror=null,e?r(e):i()};s.onload=()=>{try{if(s.result)if(/\.csv$/i.test(e.name))this.LoadCSV(s.result,t);else{if(/\.xls[xm]$/i.test(e.name)){let e;if("string"==typeof s.result)e=s.result;else{e="";const t=new Uint8Array(s.result);for(let s=0;s<t.byteLength;s++)e+=String.fromCharCode(t[s])}return void this.ImportXLSX(e,t).then((()=>o())).catch((e=>o(e)))}{const e=JSON.parse(s.result);this.LoadDocument(e,void 0,void 0,void 0,void 0,void 0,t)}}o()}catch(e){o(e)}},s.onabort=()=>{o("Aborted")},s.onerror=()=>{o("File error")},setTimeout((()=>{/\.xlsx$/i.test(e.name)?s.readAsBinaryString?s.readAsBinaryString(e):s.readAsArrayBuffer(e):s.readAsText(e)}),100)}))}ExportDelimited(e={}){if(!(e=Object.assign(Object.assign({},ns),e)).delimiter||","!==e.delimiter&&"\t"!==e.delimiter)throw new Error("invalid delimiter");let t=this.grid.model.active_sheet;switch(typeof e.sheet){case"undefined":break;case"string":t=void 0;for(const s of this.grid.model.sheets)s.name===e.sheet&&(t=s);break;case"number":t=this.grid.model.sheets[e.sheet];break;default:t=void 0}if(!t)throw new Error("invalid sheet identifier");const s=t.cells.toJSON({nested:!1,expand_arrays:!0,calculated_value:!0}),i=[];for(let e=0;e<s.columns;e++)i.push("");const r=[];for(let e=0;e<s.rows;e++)r.push(i.slice(0));const o=new RegExp(`[\t\n\r"${e.delimiter}]`);if(d(s.data))for(const t of s.data){let s="";e.formulas||void 0===t.calculated?"string"==typeof t.value&&"'"===t.value[0]?s=t.value.substr(1):void 0!==t.value&&(s=t.value.toString()):s=t.calculated.toString(),o.test(s)&&(s=s.replace(/"/g,'""'),s='"'+s+'"'),r[t.row][t.column]=s}return r.map((t=>t.join(e.delimiter))).join("\r\n")}SaveLocalFile(e=hs.treb,t=!0,s=!1,i){const r=this.grid.model.document_name||"document";let o,a;const n=e.split(/\./).filter((e=>e.trim().length)),l=n.length?n[n.length-1].toLowerCase():hs.treb;switch(n.length<=1&&(e=(l===hs.csv||l===hs.tsv)&&this.grid.model.sheets.length>1?(r+"-"+this.grid.model.active_sheet.name).toLowerCase().replace(/\W+/g,"-")+"."+l:r.toLowerCase().replace(/\W+/g,"-")+"."+l),l){case hs.csv:a=this.ExportDelimited({delimiter:","});break;case hs.tsv:a=this.ExportDelimited({delimiter:"\t"});break;case hs.treb:case hs.json:o=this.SerializeDocument(t,void 0,i),a=JSON.stringify(o,void 0,s?2:void 0),this.last_save_version=this.file_version;break;default:throw new Error("invalid file type")}if(a&&e){const t=new Blob([a],{type:"text/plain;charset=utf-8"});Ls.saveAs(t,e,{autoBom:!1})}}LoadCSV(e,t){this.grid.FromCSV(e),this.ResetInternal(),this.grid.Update(!0),this.Publish({type:"load",source:t}),this.UpdateDocumentStyles()}LoadDocument(e,t={row:0,column:0},s=!0,i=!1,r,o,a){if(o&&e.sheet_data){const t=Array.isArray(e.sheet_data)?e.sheet_data:[e.sheet_data];for(const e of t)if(e.id===o.target.sheet_id){e.selection=o;break}}this.ImportDocumentData(e,r),this.calculator.Reset(),e.rendered_values&&!i?(this.grid.Update(),this.calculator.RebuildClean(this.grid.model,!0)):(console.info("load recalc"),this.Recalculate()),this.InflateAnnotations(),s&&this.FlushUndo(),this.Publish({type:"load",source:a}),this.UpdateDocumentStyles(),this.loaded=!0,t&&F().then((()=>{this.ScrollTo(t)}))}SetNote(e){this.grid.SetNote(void 0,e)}ClearName(e){this.grid.SetName(e)}DefineName(e,t){if(t)this.grid.SetName(e,new r(t.start,t.end));else{const t=this.grid.GetSelection();t.empty||this.grid.SetName(e,t.area)}}RemoveFunction(e){const t=e.toUpperCase(),s=Object.keys(this.grid.model.macro_functions);for(const e of s)e.toUpperCase()===t&&delete this.grid.model.macro_functions[e];this.grid.SetAutocompleteFunctions(this.calculator.SupportedFunctions())}DefineFunction(e,t="",s="0"){if(!e.length||/^[^A-Za-z]/.test(e)||/[^\w_.]/.test(e))throw new Error("invalid function name");"string"==typeof t&&(t=t?t.split(this.parser.argument_separator).map((e=>e.trim())):[]);for(const e of t)if(!e.length||/^[^A-Za-z]/.test(e)||/[^\w_.]/.test(e))throw new Error("invalid argument name");this.RemoveFunction(e),this.grid.model.macro_functions[e.toUpperCase()]={name:e,function_def:s,argument_names:t,expression:this.parser.Parse(s).expression},this.grid.SetAutocompleteFunctions(this.calculator.SupportedFunctions())}UpdateAnnotations(){for(const e of this.grid.model.active_sheet.annotations)if(e.temp.vertex){const t=e.temp.vertex;t.state_id!==e.temp.state&&(e.temp.state=t.state_id,e.update_callback&&e.update_callback(),this.grid.AnnotationUpdated(e))}}SetHeadless(e=!0){this.grid.headless!==e&&(this.grid.headless=e,e||(this.grid.Update(!0),this.RebuildAllAnnotations()))}RebuildAllAnnotations(){for(const e of this.grid.model.active_sheet.annotations)this.InflateAnnotation(e),e.resize_callback&&e.resize_callback(),e.update_callback&&e.update_callback()}InflateAnnotations(){for(const e of this.grid.model.active_sheet.annotations)this.InflateAnnotation(e)}InflateAnnotation(e){var t;if(!this.grid.headless)if(e.inflated)e.dirty&&(e.resize_callback&&e.resize_callback(),e.dirty=!1);else if(e.inflated=!0,e.dirty&&(e.dirty=!1),e.content_node&&e.data)if("treb-chart"===e.type){const s=new As;s.Initialize(e.content_node),this.registered_libraries["treb-charts"]||(this.calculator.RegisterFunction(ks),this.registered_libraries["treb-charts"]=!0,this.grid.SetAutocompleteFunctions(this.calculator.SupportedFunctions()));const i=()=>{if(e.formula){const t=this.parser.Parse(e.formula);if(t&&t.expression&&"call"===t.expression.type){this.parser.Walk(t.expression,(e=>("address"!==e.type&&"range"!==e.type||this.calculator.ResolveSheetID(e),!0)));const e=t.expression.name.toLowerCase(),i=this.calculator.CalculateExpression(t.expression);s.Exec(e,i)}}s.Update()};e.resize_callback=()=>{this.grid.headless||(s.Resize(),s.Update())},e.update_callback=()=>{this.grid.headless||i()},(null===(t=e.node)||void 0===t?void 0:t.parentElement)&&(this.grid.headless||i())}else if("image"===e.type){const t=document.createElement("img");"string"==typeof e.data.src&&/^data:image/i.test(e.data.src)&&t.setAttribute("src",e.data.src),t.style.width="100%",t.style.height="100%",e.content_node.appendChild(t)}}SerializeDocument(e=!0,t=!0,s={}){const i=Object.assign(Object.assign({shrink:!0},s),{rendered_values:t}),r=this.grid.Serialize(i),o=Object.assign({app:"treb",version:"11.7.2",name:this.grid.model.document_name,user_data:this.grid.model.user_data,decimal_mark:f.decimal_separator},r);return t&&(o.rendered_values=!0),o}Recalculate(e){return t(this,void 0,void 0,(function*(){let t;e&&"data"===e.type&&e.area&&(t=e.area),yield this.calculator.Calculate(this.grid.model,t),this.grid.Update(!0),this.UpdateAnnotations(),this.Publish({type:"data"})}))}SaveLocalStorage(e){if(e||(e=this.options.storage_key),!e)return void console.info("not saving, no key");const t=JSON.stringify(this.SerializeDocument(!0,!0,{rendered_values:!0,expand_arrays:!0}));localStorage.setItem(e,t)}DocumentChange(e){F().then((()=>{const t=JSON.stringify(this.SerializeDocument(!1,!0,{rendered_values:!0,expand_arrays:!0}));this.options.storage_key&&localStorage.setItem(this.options.storage_key,t),this.options.undo&&this.PushUndo(t,e),this.Publish({type:"document-change"})}))}PushUndo(e,t){const s=t||this.last_selection;this.undo_stack[this.undo_pointer-1]&&(this.undo_stack[this.undo_pointer-1].selection=s),e||(e=JSON.stringify(this.SerializeDocument(!1,!0,{rendered_values:!0,expand_arrays:!0}))),this.undo_stack[this.undo_pointer++]={data:e,selection:void 0};const i=this.undo_stack.length;if(i>16){const e=i-16;this.undo_stack=this.undo_stack.slice(e),this.undo_pointer-=e}this.file_version++}FlushUndo(e=!0){this.undo_stack=[],this.undo_pointer=0,e&&this.PushUndo(),this.last_save_version=this.file_version=0}Undo(){if(this.undo_pointer<=1)return void console.warn("nothing to undo");const e=this.undo_stack[--this.undo_pointer-1],t=e.selection?JSON.parse(e.selection):void 0;this.LoadDocument(JSON.parse(e.data),void 0,!1,void 0,void 0,t,cs.UNDO),this.file_version--}UpdateSelection(e){this.last_selection=JSON.stringify(e),this.Publish({type:"selection"})}About(){var e;null===(e=this.dialog)||void 0===e||e.ShowDialog({type:os.about})}CreateToolbar(e){return this.toolbar=new fs(e,this.options,this.grid.theme),this.toolbar.Subscribe((e=>{var t,s,i,r,o,a,n,l;let h={};const c=e=>{const t=this.grid.GetSelection();if(t&&!t.empty){const s=t.area.spreadsheet_label;this.InsertAnnotation(`=${e}(${s},,"${s}")`)}};if("format"===e.type)h.number_format=e.format||"General";else if("font-size"===e.type){const t=this.grid.GetSelection(),s=this.grid.RealArea(t.area);this.grid.ApplyStyle(void 0,e.style,!0);const i=[];for(let e=s.start.row;e<=s.end.row;e++)i.push(e);this.grid.SetRowHeight(i,void 0,!1)}else if("button"===e.type)switch(e.command){case"font-scale":{const s=this.grid.GetSelection(),i=this.grid.RealArea(s.area),r=Number((null===(t=e.data)||void 0===t?void 0:t.scale)||1);if(r&&!isNaN(r)){this.grid.ApplyStyle(void 0,{font_size_unit:"em",font_size_value:r},!0);const e=[];for(let t=i.start.row;t<=i.end.row;t++)e.push(t);this.grid.SetRowHeight(e,void 0,!1)}}break;case"update-comment":this.SetNote((null===(s=e.data)||void 0===s?void 0:s.comment)||"");break;case"clear-comment":this.SetNote("");break;case"border":{let t=1,s=((null===(i=e.data)||void 0===i?void 0:i.border)||"").replace(/^border-/,"");"double-bottom"===s&&(s="bottom",t=2),s&&this.grid.ApplyBorders2(void 0,s,(null===(r=e.data)||void 0===r?void 0:r.color)||void 0,t)}break;case"color":case"background-color":case"foreground-color":case"border-color":switch(null===(o=e.data)||void 0===o?void 0:o.target){case"border":h.border_top_fill=h.border_bottom_fill=h.border_left_fill=h.border_right_fill=(null===(a=e.data)||void 0===a?void 0:a.color)||{};break;case"foreground":h.text=(null===(n=e.data)||void 0===n?void 0:n.color)||{theme:1};break;case"background":h.fill=(null===(l=e.data)||void 0===l?void 0:l.color)||{}}break;case"insert-row":this.grid.InsertRow();break;case"insert-column":this.grid.InsertColumn();break;case"delete-row":this.grid.DeleteRows();break;case"delete-column":this.grid.DeleteColumns();break;case"insert-sheet":this.grid.InsertSheet();break;case"delete-sheet":this.grid.DeleteSheet();break;case"freeze":{const e=this.grid.GetFreeze();e.rows||e.columns?this.Freeze(0,0):this.FreezeSelection()}break;case"insert-image":this.InsertImage();break;case"donut-chart":c("Donut.Chart");break;case"column-chart":c("Column.Chart");break;case"bar-chart":c("Bar.Chart");break;case"line-chart":c("Line.Chart");break;case"increase-decimal":case"decrease-decimal":if(this.active_selection_style){const t=Q.Get(this.active_selection_style.number_format||"General");if(t.date_format)break;const s=new Y(t.pattern);"increase-decimal"===e.command?s.IncreaseDecimal():s.DecreaseDecimal(),h.number_format=s.toString()}break;case"merge":this.grid.MergeSelection();break;case"unmerge":this.grid.UnmergeSelection();break;case"lock":h={locked:!this.active_selection_style||!this.active_selection_style.locked};break;case"wrap":h={wrap:!this.active_selection_style||!this.active_selection_style.wrap};break;case"align-left":h={horizontal_align:_.HorizontalAlign.Left};break;case"align-center":h={horizontal_align:_.HorizontalAlign.Center};break;case"align-right":h={horizontal_align:_.HorizontalAlign.Right};break;case"align-top":h={vertical_align:_.VerticalAlign.Top};break;case"align-middle":h={vertical_align:_.VerticalAlign.Middle};break;case"align-bottom":h={vertical_align:_.VerticalAlign.Bottom};break;case"reset":this.Reset();break;case"import-desktop":this.LoadLocalFile();break;case"save-json":this.SaveLocalFile();break;case"save-csv":this.SaveLocalFile(hs.csv);break;case"export-xlsx":this.Export();break;case"recalculate":this.Recalculate();break;default:console.info("unhandled",e.command)}Object.keys(h).length&&this.grid.ApplyStyle(void 0,h,!0),this.Focus()})),this.UpdateDocumentStyles(!1),this.UpdateSelectionStyle(void 0,!1),this.toolbar}UpdateSelectionStyle(e,t=!0){var s;const i=this.grid.GetFreeze(),r={frozen:!!i.rows||!!i.columns};if(e||(e=this.grid.GetSelection()),e&&!e.empty){r.selection=e,r.merge=!1;let t=this.grid.model.active_sheet.CellData(e.target);r.merge=!!t.merge_area,r.merge&&t.merge_area&&(t.merge_area.start.row!==e.target.row||t.merge_area.start.column!==e.target.column)&&(t=this.grid.model.active_sheet.CellData(t.merge_area.start)),this.active_selection_style=t.style,r.comment=t.note,r.style=t.style?Object.assign({},t.style):void 0}else this.active_selection_style={};null===(s=this.toolbar)||void 0===s||s.UpdateState(r)}UpdateDocumentStyles(e=!0){if(!this.toolbar)return;const t={},s={};for(const e of this.grid.model.sheets)e.NumberFormatsAndColors(s,t);this.toolbar.UpdateDocumentStyles(Object.keys(t),Object.keys(s),e)}InitCalculator(){return new rs}ConvertLocale(e){var t;const s=new z;let i,r;"."===e.decimal_mark?(s.decimal_mark=M.Period,s.argument_separator=A.Comma,i=M.Comma,r=A.Semicolon):(s.decimal_mark=M.Comma,s.argument_separator=A.Semicolon,i=M.Period,r=A.Comma);const o=e=>{const t=s.Parse(e);if(t.expression)return"="+s.Render(t.expression,void 0,"",i,r)};if(e.macro_functions)for(const t of e.macro_functions){const e=o(t.function_def);e&&(t.function_def=e)}if(e.sheet_data){const s=Array.isArray(e.sheet_data)?e.sheet_data:[e.sheet_data];for(const e of s){if(e.annotations)for(const t of e.annotations)if(t.formula){const e=o(t.formula);e&&(t.formula=e)}if(null===(t=e.data)||void 0===t?void 0:t.length)for(const t of e.data){const e=c(t)?[t]:t.cells;for(const t of e)if(t.value&&"string"==typeof t.value&&"="===t.value[0]){const e=o(t.value.slice(1));e&&(t.value=e)}}}}}CompareVersions(e="",t=""){const s=e.split(".").map((e=>Number(e)||0)).concat([0,0,0]),i=t.split(".").map((e=>Number(e)||0)).concat([0,0,0]),r=["major","minor","patch"],o={match:0};for(let e=0;e<3;e++)if(s[e]!==i[e]){o.match=s[e]>i[e]?1:-1,o.level=r[e];break}return o}ImportDocumentData(e,t){let s=[];const i=this.CompareVersions(e.version,"11.7.2");i.match>0&&("major"!==i.level&&"minor"!==i.level||console.warn(`The file you are opening was created with a newer version of TREB (${e.version} vs 11.7.2).\nYou may encounter compatibility errors.`)),e.sheet_data&&(Array.isArray(e.sheet_data)?s=e.sheet_data:s.push(e.sheet_data)),e.decimal_mark&&e.decimal_mark!==f.decimal_separator&&this.ConvertLocale(e),this.grid.UpdateSheets(s,void 0,t||e.active_sheet);const r=this.grid.model;r.document_name=e.name,r.user_data=e.user_data,r.named_ranges.Reset();let o=e.named_ranges;if(!o&&s[0]&&s[0].named_ranges&&(o=s[0].named_ranges),o&&r.named_ranges.Deserialize(o),r.macro_functions={},e.macro_functions)for(const t of e.macro_functions)r.macro_functions[t.name.toUpperCase()]=Object.assign(Object.assign({},t),{expression:this.parser.Parse(t.function_def||"").expression})}LoadWorker(e){return t(this,void 0,void 0,(function*(){let t;Es.treb_language&&(e+="-"+Es.treb_language),/\.js$/.test(e)||(e+="-11.7.2.js");let s=Es.treb_base_path;if(s&&(/\/$/.test(s)||(s+="/"),e=s+e),/^(http:|https:|\/\/)/.test(e)){const s=yield this.Fetch(e);t=new Worker(URL.createObjectURL(new Blob([s],{type:"application/javascript"})))}else{if(/^file:/.test(e))throw new Error("invalid URI");t=new Worker(e)}return t}))}HandleKeyDown(e){!e.ctrlKey||"KeyZ"!==e.code&&"z"!==e.key||(e.stopPropagation(),e.preventDefault(),this.Undo())}}Es.treb_base_path="",Es.treb_language="",Es.treb_script_host="",Es.treb_embedded_script_path="",Es.enable_engine=!1,Es.enable_formatter=!1;const Ts=e=>{const t=4+e.data.length,s=new Float64Array(t);return s[0]=e.column,s[1]=e.row,s[2]=e.sheet_id,s[3]=e.data.length,s.set(e.data,4),s},Ds=e=>e.length===3+e[2]?{column:e[0],row:e[1],sheet_id:0,data:e.subarray(3)}:{column:e[0],row:e[1],sheet_id:e[2],data:e.subarray(4)},zs=e=>{if(1===e.length)return e[0];let t=0,s=0;for(const i of e)t=Math.max(t,i.elapsed),s+=i.trials;const i=e[0],r=i.results.map((e=>{const t=new Float64Array(4+s);return t.set(new Float64Array(e)),t}));let o=i.trials+4;for(let t=1;t<e.length;t++){const s=e[t];s.results.forEach(((e,t)=>{const s=new Float64Array(e),i=r[t];if(i[0]!==s[0]||i[1]!==s[1]||i[2]!==s[2])throw new Error("mismatch in result address");i.set(s.subarray(4),o)})),o+=s.trials}return{elapsed:t,trials:s,results:r.map((e=>e.buffer))}};var Ns,Ps=s(691);!function(e){e[e.Null=0]="Null",e[e.Prep=1]="Prep",e[e.Simulation=2]="Simulation",e[e.Post=3]="Post"}(Ns||(Ns={}));const Fs=e=>{const t=Ps.MC.Uniform(e),s=[];for(let t=0;t<e;t++)s[t]=t;for(let i=0;i<e;i++){const r=i+Math.floor(t[i]*(e-i)),o=s[i];s[i]=s[r],s[r]=o}return s};class Is{constructor(){this.address={row:0,column:0},this.volatile=!1,this.iteration=0,this.iterations=0,this.call_index=0,this.lhs=!1,this.state=Ns.Null,this.results=[],this.elapsed=0,this.trials=0,this.distributions=[],this.correlated_distributions={},this.functions={"Multivariate.Normal":{description:"Returns a sample from the multivariate normal distribution",simulation_volatile:!0,arguments:[{name:"range of values",description:"Set of Correlated Distributions (N)",address:!0},{name:"correlation",description:"Correlation Matrix (NxN)"},{name:"mean",description:"Distribution Mean",default:0},{name:"stdev",description:"Standard Deviation",default:1}],fn:this.multivariate_normal.bind(this),category:["RiskAMP Random Distributions"],extension:!0},"Multivariate.LogNormal":{description:"Returns a sample from the multivariate log-normal distribution",simulation_volatile:!0,arguments:[{name:"range of values",description:"Set of Correlated Distributions (N)",address:!0},{name:"correlation",description:"Correlation Matrix (NxN)"},{name:"mean",description:"Mean of underlying Normal distribution",default:0},{name:"stdev",description:"Standard Deviation of underlying Normal distribution",default:1}],fn:this.multivariate_lognormal.bind(this),category:["RiskAMP Random Distributions"],extension:!0},"Multivariate.Uniform":{description:"Returns a sample from the multivariate uniform distribution",simulation_volatile:!0,arguments:[{name:"range of values",description:"Set of Correlated Distributions (N)",address:!0},{name:"correlation",description:"Correlation Matrix (NxN)"},{name:"min",description:"Minimum Value",default:0},{name:"max",description:"Maximum Value",default:1}],fn:this.multivariate_uniform.bind(this),category:["RiskAMP Random Distributions"],extension:!0},"Multivariate.Beta":{description:"Returns a sample from the multivariate beta distribution",simulation_volatile:!0,arguments:[{name:"range of values",description:"Set of Correlated Distributions (N)",address:!0},{name:"correlation",description:"Correlation Matrix (NxN)"},{name:"w",description:"Shape Parameter"},{name:"v",description:"Shape Parameter"}],fn:this.multivariate_beta.bind(this),category:["RiskAMP Random Distributions"],extension:!0},"Multivariate.PERT":{description:"Returns a sample from the multivariate PERT distribution",simulation_volatile:!0,arguments:[{name:"range of values",description:"Set of Correlated Distributions (N)",address:!0},{name:"correlation",description:"Correlation Matrix (NxN)"},{name:"min",description:"Minimum Value"},{name:"mode",description:"Most-Likely Value"},{name:"max",description:"Maximum Value"},{name:"lambda",default:4}],fn:this.multivariate_pert.bind(this),category:["RiskAMP Random Distributions"],extension:!0},"Multivariate.Triangular":{description:"Returns a sample from the multivariate triangular distribution",simulation_volatile:!0,arguments:[{name:"range of values",description:"Set of Correlated Distributions (N)",address:!0},{name:"correlation",description:"Correlation Matrix (NxN)"},{name:"min",description:"Minimum Value"},{name:"mode",description:"Most-Likely Value"},{name:"max",description:"Maximum Value"}],fn:this.multivariate_triangular.bind(this),category:["RiskAMP Random Distributions"],extension:!0},UniformRangeSample:{description:"Returns one of a set of values, with equal probability and with replacement",simulation_volatile:!0,arguments:[{name:"range",description:"Range of Values"}],fn:this.uniformrangesample.bind(this),category:["RiskAMP Random Distributions"],extension:!0},SampleValue:{description:"Returns one of a set of values, with equal probability and with replacement",simulation_volatile:!0,arguments:[{name:"range",description:"Range of Values"}],fn:this.samplevalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},"SampleValue.Weighted":{description:"Returns one of a set of values, weighted by a second set of values",simulation_volatile:!0,arguments:[{name:"range",description:"Range of Values"},{name:"weights",description:"Range of Weights"}],fn:this.samplevalue_weighted.bind(this),category:["RiskAMP Random Distributions"],extension:!0},BernoulliValue:{description:"Returns true or false (boolean) based on the given probability",simulation_volatile:!0,arguments:[{name:"p",description:"Probability to return True",default:.5}],fn:this.bernoullivalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},ProbabilityValue:{description:"Returns true or false (boolean) based on the given probability",simulation_volatile:!0,arguments:[{name:"p",description:"Probability to return True",default:.5}],fn:this.probabilityvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},UniformValue:{description:"Returns a sample from the uniform distribution",simulation_volatile:!0,arguments:[{name:"min",description:"Minimum",default:0},{name:"max",description:"Maximum",default:1}],fn:this.uniformvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},BetaValue:{description:"Returns a sample from the beta distribution",simulation_volatile:!0,arguments:[{name:"w",description:"Shape Parameter"},{name:"v",description:"Shape Parameter"}],fn:this.betavalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},TruncatedNormalValue:{description:"Returns a sample from the normal distribution",simulation_volatile:!0,arguments:[{name:"mean",description:"Mean",default:0},{name:"stdev",description:"Standard Deviation",default:1},{name:"min",description:"Minimum Value"},{name:"max",description:"Maximum Value"}],fn:this.truncatednormalvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},NormalValue:{description:"Returns a sample from the normal distribution",simulation_volatile:!0,arguments:[{name:"mean",description:"Mean",default:0},{name:"stdev",description:"Standard Deviation",default:1}],fn:this.normalvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},PERTValue:{description:"Returns a sample from the beta-PERT distribution",simulation_volatile:!0,arguments:[{name:"min",description:"Minimum Value",default:0},{name:"mode",description:"Most-Likely Value",default:.5},{name:"max",description:"Maximum Value",default:1},{name:"lambda",default:4}],fn:this.pertvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},LognormalValue:{description:"Returns a sample from the log-normal distribution",simulation_volatile:!0,arguments:[{name:"mean",description:"Mean of underlying Normal distribution",default:0},{name:"stdev",description:"Standard Deviation of underlying Normal distribution",default:1}],fn:this.lognormalvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},SequentialValue:{description:"Returns one from a set of values, in order",simulation_volatile:!0,arguments:[{name:"values",description:"Data Array"},{name:"count",description:"Count",default:0}],fn:this.sequentialvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},IndexValue:{description:"Returns a monotonically increasing value",simulation_volatile:!0,arguments:[{name:"max",description:"Maximum",default:0}],fn:this.indexvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},"PERTValue.P":{description:"Returns a sample from the beta-PERT distribution",simulation_volatile:!0,arguments:[{name:"p10",description:"10th-Percentile Value",default:0},{name:"mode",description:"Most-Likely Value",default:.5},{name:"p90",description:"90th-Percentile Value",default:1},{name:"lambda",default:4}],fn:this.pertvalue_p.bind(this),category:["RiskAMP Random Distributions"],extension:!0},TriangularValue:{description:"Returns a sample from the triangular distribution",simulation_volatile:!0,arguments:[{name:"min",description:"Minimum Value",default:0},{name:"mode",description:"Most Likely Value",default:.5},{name:"max",description:"Maximum Value",default:1}],fn:this.triangularvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},SimulationCorrelation:{description:"Returns the correlation between the data from two cells in the simulation",arguments:[{name:"reference cell",description:"Cell 1",collector:!0},{name:"reference cell",description:"Cell 2",collector:!0}],fn:this.simulationcorrelation.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationRSquared:{description:"Returns the r-squared value (coefficient of correlation) of the data from two cells in the simulation",arguments:[{name:"dependent",description:"Dependent Value",collector:!0},{name:"independent",description:"Indepdendent Value",collector:!0}],fn:this.simulationrsquared.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationSkewness:{description:"Returns the skewness of data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationskewness.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationKurtosis:{description:"Returns the kurtosis (peakedness) of data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationkurtosis.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationPercentile:{description:"Returns the value of a cell at a given percentile in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0},{name:"percentile",description:"Percentile (as %)"}],fn:this.simulationpercentile.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationInterval:{description:"Returns the portion of results in the simulation that fall within some bounds (as a percentage)",arguments:[{name:"reference cell",description:"Source Cell",collector:!0},{name:"min",description:"Minimum Value (optional, inclusive)"},{name:"max",description:"Maximum Value (optional, inclusive)"}],fn:this.simulationinterval.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationMean:{description:"Returns the mean (average) value of the data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationmean.bind(this),extension:!0,category:["RiskAMP Simulation Functions"]},SimulationMedian:{description:"Returns the median value of the data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationmedian.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationValue:{description:"Returns the value of this cell in the simulation at the given trial number",arguments:[{name:"reference cell",description:"Source Cell",collector:!0},{name:"iteration",description:"Trial Number"}],fn:this.simulationvalue.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationValuesArray:{description:"Returns all values of this cell in the simulation, as an array",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationvaluesarray.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SortedSimulationIndex:{description:"Returns the iteration number of a sorted value for this cell",arguments:[{name:"reference cell",description:"Source Cell",collector:!0},{name:"index"}],fn:this.sortedsimulationindex.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},"SimulationValuesArray.Ordered":{description:"Returns all values of this cell in the simulation, as an array, ordered by a second cell",arguments:[{name:"reference cell",description:"Source Cell",collector:!0},{name:"order by",description:"Reference Cell for Ordering",collector:!0}],fn:this.simulationvaluesarray_ordered.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationMin:{description:"Returns the minimum value of the data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationmin.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationMax:{description:"Returns the maximum value of the data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationmax.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationStandardError:{description:"Returns the standard error of the mean from this cell in the simulation",arguments:[{name:"reference cell",collector:!0}],fn:this.simulationstandarderror.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationStandardDeviation:{description:"Returns the standard deviation of the data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationstandarddeviation.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationVariance:{description:"Returns the variance of the data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationvariance.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationTrials:{description:"Returns the number of trials from the last simulation",fn:this.simulationtrials.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationTime:{description:"Returns the elapsed time of the last simulation",fn:this.simulationtime.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},IsPosDef:{description:"Checks that a matrix is positive-definite",arguments:[{name:"matrix"}],fn:e=>{if(e.some((e=>e.some((e=>"number"!=typeof e)))))return Ye();const t=Ps.Matrix.FromArray(e);return{type:a.boolean,value:t.IsPosDef()}},extension:!0},MakePosDef:{description:"Returns a matrix that is positive-definite",arguments:[{name:"matrix"}],fn:e=>{if(e.some((e=>e.some((e=>"number"!=typeof e)))))return Ye();const t=Ps.Matrix.FromArray(e).MakePosDef().ToArray();return{type:a.array,value:t.map((e=>e.map((e=>({type:a.number,value:e})))))}},extension:!0},Cholesky:{arguments:[{name:"matrix"},{name:"transpose",default:!1}],fn:(e,t=!1)=>{const s=Ps.Matrix.FromArray(e).Cholesky(t).ToArray();return{type:a.array,value:s.map((e=>e.map((e=>({type:a.number,value:e})))))}},extension:!0},EigenValues:{description:"Returns the eigenvalues of the matrix (as column vector)",arguments:[{name:"matrix"}],fn:e=>{if(e.some((e=>e.some((e=>"number"!=typeof e)))))return Ye();const t=Ps.Matrix.FromArray(e).EigenSystem();return{type:a.array,value:[t.realvalues.map((e=>({type:a.number,value:e})))]}},extension:!0},EigenVectors:{description:"Returns the eigenvectors of the matrix (as matrix)",arguments:[{name:"matrix"}],fn:e=>{if(e.some((e=>e.some((e=>"number"!=typeof e)))))return Ye();const t=Ps.Matrix.FromArray(e).EigenSystem();return{type:a.array,value:t.vectors.map((e=>Array.from(e).map((e=>({type:a.number,value:e})))))}},extension:!0},"RiskAMP.Scale":{description:"Creates a uniform scale within a given range",arguments:[{name:"min"},{name:"max"}],fn:this.Scale.bind(this),extension:!0},"RiskAMP.HistogramTable":{description:"Creates a histogram table from a source cell",arguments:[{name:"reference cell",collector:!0}],fn:this.HistogramTable.bind(this),extension:!0},"RiskAMP.Permutation":{description:"Creates a random permutation of source data",arguments:[{name:"range",boxed:!0}],fn:this.Permutation.bind(this),extension:!0,simulation_volatile:!0}}}set seed(e){Ps.Random.Seed(e)}CallerArea(){var e;let t,s=1,i=1;if(this.address.sheet_id)for(const s of(null===(e=this.model)||void 0===e?void 0:e.sheets)||[])if(s.id===this.address.sheet_id){s.cells.data[this.address.row]&&(t=s.cells.data[this.address.row][this.address.column]);break}return(null==t?void 0:t.area)&&(s=t.area.rows,i=t.area.columns),{rows:s,columns:i}}CorrelateDistributions(){for(const e of Object.keys(this.correlated_distributions)){const t=this.correlated_distributions[e],s=t.addresses.map((e=>this.distributions[e.sheet_id||0][e.column][e.row][e.call_index]));try{const e=Ps.MC.CorrelateCDM(t.correlation,s,!0);t.addresses.forEach(((t,s)=>{this.distributions[t.sheet_id||0][t.column][t.row][t.call_index]=e[s]}))}catch(e){console.warn(e)}}}InitDistribution(){if(!this.address)throw new Error("invalid address");if(!this.address.sheet_id)throw new Error("address missing sheet ID");this.distributions[this.address.sheet_id]||(this.distributions[this.address.sheet_id]=[]);const e=this.distributions[this.address.sheet_id];e[this.address.column]||(e[this.address.column]=[]);const t=e[this.address.column];t[this.address.row]||(t[this.address.row]=[])}StoreCellResults(e){if(e||(e=this.address),!e)return;if(!e.sheet_id)throw new Error("SCR called without sheet id");this.results[e.sheet_id]||(this.results[e.sheet_id]=[]),this.results[e.sheet_id][e.column]||(this.results[e.sheet_id][e.column]=[]);const t=this.results[e.sheet_id][e.column];return t[e.row]||(t[e.row]=[]),t[e.row]}PrepMultivariate(e,t){if(!this.correlated_distributions[e]){let s=Ps.CDMatrix.FromArray(t);if(!s.IsSymmetric()){for(let e=1;e<t.length;e++)for(let s=0;s<e;s++)if(t[e][s]){console.warn("invalid lower-triangular matrix");break}s=s.Symmetrize(!0)}this.correlated_distributions[e]={correlation:s,addresses:[]}}this.correlated_distributions[e].addresses.push({column:this.address.column,row:this.address.row,sheet_id:this.address.sheet_id,call_index:this.call_index}),this.InitDistribution()}ValidateCorrelationMatrix(e){let t=Ps.Matrix.FromArray(e);return t.IsSymmetric()||(t=t.Symmetrize(!0)),!(e.some((e=>e.some((e=>"number"!=typeof e&&void 0!==e))))||!t.IsPosDef())}multivariate_normal(e,t,s=0,i=1){if(this.state===Ns.Prep)this.PrepMultivariate(e,t),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Ps.MC.Normal(this.iterations,{mean:s,sd:i,lhs:this.lhs,ordered:!0});else if(this.state===Ns.Simulation)return{type:a.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return this.ValidateCorrelationMatrix(t)?{type:a.number,value:Ps.MC.Normal(1,{mean:s,sd:i})[0]}:We()}multivariate_lognormal(e,t,s=0,i=1){if(this.state===Ns.Prep)this.PrepMultivariate(e,t),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Ps.MC.LogNormal(this.iterations,{mean:s,sd:i,lhs:this.lhs,ordered:!0});else if(this.state===Ns.Simulation)return{type:a.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return this.ValidateCorrelationMatrix(t)?{type:a.number,value:Ps.MC.LogNormal(1,{mean:s,sd:i})[0]}:We()}multivariate_beta(e,t,s=1,i=2){if(this.state===Ns.Prep)this.PrepMultivariate(e,t),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Ps.MC.Beta(this.iterations,{a:s,b:i,lhs:this.lhs,ordered:!0});else if(this.state===Ns.Simulation)return{type:a.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return this.ValidateCorrelationMatrix(t)?{type:a.number,value:Ps.MC.Beta(1,{a:s,b:i})[0]}:We()}multivariate_uniform(e,t,s=0,i=1){if(this.state===Ns.Prep)this.PrepMultivariate(e,t),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Ps.MC.Uniform(this.iterations,{min:s,max:i,lhs:this.lhs,ordered:!0});else if(this.state===Ns.Simulation)return{type:a.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return this.ValidateCorrelationMatrix(t)?{type:a.number,value:Ps.MC.Uniform(1,{min:s,max:i})[0]}:We()}multivariate_pert(e,t,s=0,i=.5,r=1,o=4){if(this.state===Ns.Prep)this.PrepMultivariate(e,t),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Ps.MC.PERT(this.iterations,{a:s,b:r,c:i,lambda:o,lhs:this.lhs,ordered:!0});else if(this.state===Ns.Simulation)return{type:a.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return this.ValidateCorrelationMatrix(t)?{type:a.number,value:Ps.MC.PERT(1,{a:s,b:r,c:i,lambda:o})[0]}:We()}multivariate_triangular(e,t,s=0,i=.5,r=1){if(this.state===Ns.Prep)this.PrepMultivariate(e,t),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Ps.MC.Triangular(this.iterations,{a:s,b:r,c:i,lhs:this.lhs,ordered:!0});else if(this.state===Ns.Simulation)return{type:a.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return this.ValidateCorrelationMatrix(t)?{type:a.number,value:Ps.MC.Triangular(1,{a:s,b:r,c:i})[0]}:We()}uniformvalue(e=0,t=1){if(this.state===Ns.Prep)this.InitDistribution(),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Ps.MC.Uniform(this.iterations,{min:e,max:t,lhs:this.lhs});else if(this.state===Ns.Simulation)return{type:a.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return{type:a.number,value:Ps.MC.Uniform(1,{min:e,max:t})[0]}}bernoullivalue(e=.5){if(this.state===Ns.Prep)this.InitDistribution(),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Ps.MC.Bernoulli(this.iterations,{p:e,lhs:this.lhs});else if(this.state===Ns.Simulation)return{type:a.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return{type:a.boolean,value:Ps.MC.Bernoulli(1,{p:e})[0]}}probabilityvalue(e=.5){return this.bernoullivalue(e)}sequentialvalue(e,t=0){if(this.state===Ns.Prep)this.InitDistribution();else if(this.state===Ns.Simulation){let s=this.iteration;t>0&&(s=this.iteration%t);const i=e[0].length,r=Math.floor(s/i)%e.length,o=s%i;return{type:a.number,value:e[r][o]}}return{type:a.number,value:e[0][0]}}indexvalue(e=0){if(this.state===Ns.Prep)this.InitDistribution();else if(this.state===Ns.Simulation)return e>0?{type:a.number,value:this.iteration%e+1}:{type:a.number,value:this.iteration+1};return{type:a.number,value:1}}lognormalvalue(e=0,t=1){if(this.state===Ns.Prep)this.InitDistribution(),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Ps.MC.LogNormal(this.iterations,{mean:e,sd:t,lhs:this.lhs});else if(this.state===Ns.Simulation)return{type:a.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return{type:a.number,value:Ps.MC.LogNormal(1,{mean:e,sd:t})[0]}}truncatednormalvalue(e=0,t=1,s,i){if(this.state===Ns.Prep)this.InitDistribution(),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Ps.MC.TruncatedNormal(this.iterations,{mean:e,sd:t,lhs:this.lhs,min:s,max:i});else if(this.state===Ns.Simulation)return{type:a.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return{type:a.number,value:Ps.MC.TruncatedNormal(1,{mean:e,sd:t,min:s,max:i})[0]}}normalvalue(e=0,t=1){if(this.state===Ns.Prep)this.InitDistribution(),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Ps.MC.Normal(this.iterations,{mean:e,sd:t,lhs:this.lhs});else if(this.state===Ns.Simulation)return{type:a.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return{type:a.number,value:Ps.MC.Normal(1,{mean:e,sd:t})[0]}}pertvalue(e=0,t=.5,s=1,i=4){if(this.state===Ns.Prep)this.InitDistribution(),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Ps.MC.PERT(this.iterations,{a:e,b:s,c:t,lambda:i,lhs:this.lhs});else if(this.state===Ns.Simulation)return{type:a.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return{type:a.number,value:Ps.MC.PERT(1,{a:e,b:s,c:t,lambda:i})[0]}}pertvalue_p(e=0,t=.5,s=1,i=4){if(this.state===Ns.Prep){const r=Ps.MC.P80Pert(e,s,t,i);this.InitDistribution(),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Ps.MC.PERT(this.iterations,Object.assign(Object.assign({},r),{lambda:i,lhs:this.lhs}))}else if(this.state===Ns.Simulation)return{type:a.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};const r=Ps.MC.P80Pert(e,s,t,i);return{type:a.number,value:Ps.MC.PERT(1,Object.assign(Object.assign({},r),{lambda:i}))[0]}}CommonDistributionFunction(e,t,s){if(this.state===Ns.Prep)this.InitDistribution(),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=e.apply(t,[this.iterations].concat(s));else if(this.state===Ns.Simulation)return this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration];return e.apply(t,[1].concat(s))[0]}triangularvalue(e=0,t=.5,s=1){if(this.state===Ns.Prep)this.InitDistribution(),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Ps.MC.Triangular(this.iterations,{a:e,b:s,c:t,lhs:this.lhs});else if(this.state===Ns.Simulation)return{type:a.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return{type:a.number,value:Ps.MC.Triangular(1,{a:e,b:s,c:t})[0]}}betavalue(e=1,t=1){if(this.state===Ns.Prep)this.InitDistribution(),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Ps.MC.Beta(this.iterations,{a:e,b:t,lhs:this.lhs});else if(this.state===Ns.Simulation)return{type:a.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return{type:a.number,value:Ps.MC.Beta(1,{a:e,b:t})[0]}}samplevalue(e){return this.uniformrangesample(e)}samplevalue_weighted(e,t){if(this.state===Ns.Prep)this.InitDistribution(),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Ps.MC.Uniform(this.iterations,{min:0,max:1,lhs:this.lhs});else{const s=this.state===Ns.Simulation?this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]:Ps.MC.Uniform(1,{min:0,max:1})[0];if(!e||!e.length)return{type:a.undefined,value:void 0};const i=s*Tt(t).reduce(((e,t)=>void 0===t?e:e+Number(t)),0);let r=0;for(let s=0;s<e.length;s++)for(let o=0;o<e[s].length;o++)if(r+=t[s][o],r>=i)return{type:a.number,value:e[s][o]}}return{type:a.number,value:e[0][0]}}uniformrangesample(e){this.state===Ns.Prep&&(this.InitDistribution(),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=Ps.MC.Uniform(this.iterations,{min:0,max:1,lhs:this.lhs}));const t=this.state===Ns.Simulation?this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]:Ps.MC.Uniform(1,{min:0,max:1})[0];if(!e||!e.length)return{type:a.undefined,value:void 0};const s=Math.floor(e[0].length*e.length*t),i=e[s%e.length][Math.floor(s/e.length)]||"";return{value:i,type:n(i)}}simulationtrials(){return{type:a.number,value:this.trials}}simulationtime(){return{type:a.number,value:this.elapsed/1e3}}simulationvaluesarray(e){if(this.state!==Ns.Null)return{type:a.number,value:0};if(!e||!e.length)return We();const t=[];for(let s=0;s<e.length;s++)t[s]={type:a.number,value:e[s]};return{type:a.array,value:[t]}}simulationvaluesarray_ordered(e,t){if(this.state!==Ns.Null)return{type:a.number,value:0};if(!e||!e.length||t&&!t.length)return We();if(!t)return{type:a.array,value:[Array.prototype.slice.call(e,0).sort(((e,t)=>e-t)).map((e=>({type:a.number,value:e})))]};const s=Array.from(e).map(((e,s)=>[e,t[s]]));return s.sort(((e,t)=>e[1]-t[1])),{type:a.array,value:[s.map((e=>({type:a.number,value:e[0]})))]}}simulationrsquared(e,t){return this.state!==Ns.Null?{type:a.number,value:0}:e&&e.length&&t&&t.length?{type:a.number,value:Ps.Stats.R2(e,t)}:We()}simulationcorrelation(e,t){return this.state!==Ns.Null?{type:a.number,value:0}:e&&e.length&&t&&t.length?{type:a.number,value:Ps.Stats.Correlation(e,t)}:We()}sortedsimulationindex(e,t=1){if(this.state!==Ns.Null)return{type:a.number,value:0};if(!e||!e.length)return We();if(t<1||t>e.length)return Ke();const s=Array.from(e).map(((e,t)=>[e,t+1]));return s.sort(((e,t)=>e[0]-t[0])),{type:a.number,value:s[t-1][1]}}simulationvalue(e,t=1){return this.state!==Ns.Null?{type:a.number,value:0}:e&&e.length?t<1||t>e.length?Ke():{type:a.number,value:e[t-1]}:We()}simulationpercentile(e,t=.5){return this.state!==Ns.Null?{type:a.number,value:0}:e&&e.length?{type:a.number,value:Ps.Stats.Percentile(e,t)}:We()}simulationstandarddeviation(e){if(this.state!==Ns.Null)return{type:a.number,value:0};if(!e||!e.length)return We();const t=Ps.Stats.Statistics(e);return{type:a.number,value:t.stdev}}simulationvariance(e){if(this.state!==Ns.Null)return{type:a.number,value:0};if(!e||!e.length)return We();const t=Ps.Stats.Statistics(e);return{type:a.number,value:t.variance}}simulationskewness(e){if(this.state!==Ns.Null)return{type:a.number,value:0};if(!e||!e.length)return We();const t=Ps.Stats.Statistics(e);return{type:a.number,value:t.skewness}}simulationkurtosis(e){if(this.state!==Ns.Null)return{type:a.number,value:0};if(!e||!e.length)return We();const t=Ps.Stats.Statistics(e);return{type:a.number,value:t.kurtosis}}simulationinterval(e,t,s){return this.state!==Ns.Null?{type:a.number,value:0}:e&&e.length?{type:a.number,value:Ps.Stats.Interval({data:e,min:t,max:s})}:We()}simulationstandarderror(e){if(this.state!==Ns.Null)return{type:a.number,value:0};if(!e||!e.length)return We();let t=0,s=0;for(const s of e)t+=s||0;const i=t/e.length;for(const t of e){const e=t-i;s+=e*e}return{type:a.number,value:Math.sqrt(s/e.length)/Math.sqrt(e.length)}}simulationmin(e){return this.state!==Ns.Null?{type:a.number,value:0}:e&&e.length?{type:a.number,value:Math.min.apply(0,e)}:We()}simulationmax(e){return this.state!==Ns.Null?{type:a.number,value:0}:e&&e.length?{type:a.number,value:Math.max.apply(0,e)}:We()}simulationmean(e){if(this.state!==Ns.Null)return{type:a.number,value:0};if(!e||!e.length)return We();let t=0;for(const s of e)t+=s;return{type:a.number,value:t/e.length}}simulationmedian(e){if(this.state!==Ns.Null)return{type:a.number,value:0};if(!e||!e.length)return We();const t=e.filter((e=>"number"==typeof e?e:0));return t.sort(((e,t)=>e-t)),{type:a.number,value:t[Math.round(t.length/2)]}}Permutation(e){if(!e){const{rows:e,columns:t}=this.CallerArea(),s=e*t;if(s<=0)return Ke();const i=Fs(s),r=[];let o=0;for(let s=0;s<t;s++){const t=[];for(let s=0;s<e;s++)t.push({type:a.number,value:i[o++]});r.push(t)}return{type:a.array,value:r}}if(e.type===a.array){const t=e.value.length,s=e.value[0].length;if(!t||!s)return Ke();const i=e.value.reduce(((e,t)=>t.concat(e)),[]),r=t*s;if(i.length!==r)throw console.info("invalid?",r,e,i),new Error("invalid length");const o=Fs(r),n=[];let l=0;for(let e=0;e<t;e++){const e=[];for(let t=0;t<s;t++){const t=o[l++];e.push(Object.assign({},i[t]))}n.push(e)}return{type:a.array,value:n}}return Object.assign({},e)}Scale(e,t){const{rows:s,columns:i}=this.CallerArea(),r=Math.max(s,i),o=e>t?j(t,e,r-1,!0):j(e,t,r-1,!0);let n=o.min;const l=[[]];if(o.count<r-1&&(n=o.min-Math.floor((r-1-o.count)/2)*o.step),e>t)for(let e=0;e<r;e++){const t=n+e*o.step;l[0][r-1-e]={type:a.number,value:t}}else for(let e=0;e<r;e++){const t=n+e*o.step;l[0][e]={type:a.number,value:t}}return{type:a.array,value:s<i?Lt(l):l}}HistogramTable(e){const{rows:t,columns:s}=this.CallerArea(),i=Math.max(t,s),r=Math.min(t,s);if(Array.isArray(e)||e instanceof Float64Array||e instanceof Float32Array){if(e.length<=1)return{type:a.number,value:0};Array.isArray(e)||(e=Array.prototype.slice.call(e)),e.sort(((e,t)=>e-t));const o=e[0]||0,n=e[e.length-1]||0;if(n===o)return{type:a.number,value:0};let l=[[],[]];const h=j(o,n,i,!0);let c=h.min,d=0;h.count<i&&(c=h.min-Math.ceil(i-h.count)/2*h.step);for(let t=0;t<i;t++){const s=c+(t+1)*h.step;let i=0;for(;d<e.length&&e[d]<s;d++,i++);l[1][t]={type:a.number,value:i},l[0][t]={type:a.number,value:s}}return 1===r&&(l=[l[1]]),{type:a.array,value:s>t?Lt(l):l}}return{type:a.number,value:0}}}class Os extends Rt{constructor(e,t){super(e,t),this.simulation_model=new Is,this.context=this.simulation_model}CallExpression(e,t=!1){const s=this.library.Get(e.name);if(!s)return e=>et();const i=s.arguments||[];return this.simulation_model.state===Ns.Prep&&e.args.forEach(((e,t)=>{const s=i[t]||{};if(e&&s.collector)if("address"===e.type)this.simulation_model.StoreCellResults(e);else if("identifier"===e.type){const t=this.named_range_map[e.name.toUpperCase()];t&&this.simulation_model.StoreCellResults(t.start)}else if("call"===e.type){const t=this.CalculateExpression(e,!0);t&&Mt(t)&&("address"===t.value.type?this.simulation_model.StoreCellResults(t.value):"range"===t.value.type&&this.simulation_model.StoreCellResults(t.value.start))}})),r=>{const o=this.call_index++;this.simulation_model.volatile=this.simulation_model.volatile||!!s.volatile||!!s.simulation_volatile&&this.simulation_model.state!==Ns.Null;const n="IF"===e.name.toUpperCase();let l,h=-1;const c=r.args.map(((e,t)=>{if(l)return;const s=i[Math.min(t,i.length-1)]||{};if(t===h)return s.boxed?{type:a.undefined}:void 0;if(void 0===e)return n&&0===t&&(h=1),s.boxed?{type:a.undefined}:void 0;if(s.address)return s.boxed?{type:a.string,value:this.parser.Render(e).replace(/\$/g,"")}:this.parser.Render(e).replace(/\$/g,"");if(s.metadata)return this.GetMetadata(e,((e,t)=>({simulation_data:this.simulation_model.state===Ns.Null?this.simulation_model.StoreCellResults(t):[]})));if(s.collector&&this.simulation_model.state===Ns.Null){if("address"===e.type)return this.simulation_model.StoreCellResults(e);if("range"===e.type)return this.simulation_model.StoreCellResults(e.start);if("identifier"===e.type){const t=this.named_range_map[e.name.toUpperCase()];if(t)return this.simulation_model.StoreCellResults(t.start)}else if("call"===e.type){const t=this.CalculateExpression(e,!0);if(t&&Mt(t)){if("address"===t.value.type)return this.simulation_model.StoreCellResults(t.value);if("range"===t.value.type)return this.simulation_model.StoreCellResults(t.value.start)}}return l=Qe(),l}{const i=this.CalculateExpression(e);if(i.type===a.error)return s.allow_error?i:void(l=i);if(n&&0===t&&i.type!==a.array){let e=!1;if(i.type===a.string){const t=i.value.toLowerCase().trim();e="false"!==t&&"f"!==t}else e=!!i.value;h=e?2:1}return s.boxed?i:Array.isArray(i)?(console.warn("AAA 82394"),i.map((e=>e.map((e=>e.value))))):i.type===a.array?i.value.map((e=>e.map((e=>e.value)))):i.value}}));if(l)return l;if(this.context.call_index=o,s.return_type===st.reference){const e=s.fn.apply(null,c);if(t)return e;if(Mt(e)){if("address"===e.value.type)return this.CellFunction2(e.value)();if("range"===e.value.type)return this.CellFunction4(e.value.start,e.value.end)}return e}return s.fn.apply(null,c)}}}class Us extends rs{constructor(){super(),this.expression_calculator=this.simulation_expression_calculator=new Os(this.library,this.parser),this.library.Register(this.simulation_expression_calculator.simulation_model.functions)}InitSimulation(e,t,s,i,r){var o;const a=this.simulation_expression_calculator.simulation_model;if(a.iterations=e,a.results=[],a.lhs=t,a.correlated_distributions={},"number"==typeof r&&(a.seed=r),this.Reset(),this.AttachModel(s),i&&i.length)for(const e of i){if(!e.sheet_id)throw new Error("additional cell passed without sheet id");for(const t of(null===(o=this.model)||void 0===o?void 0:o.sheets)||[])if(t.id===e.sheet_id){t.cells.GetCell(e,!1)&&a.StoreCellResults(e);break}}if(this.RebuildGraph(),this.LoopCheck())throw new Error("Loop (circular dependency) found in graph");return a.state=Ns.Prep,a.iteration=0,this.Recalculate(),a.CorrelateDistributions(),a.state=Ns.Simulation,Ie.OK}GetResults(){return this.simulation_expression_calculator.simulation_model.results}SimulationTrial(e){const t=this.simulation_expression_calculator.simulation_model;t.iteration=e;try{this.Recalculate();for(const s in t.results){const i=this.cells_map[s];for(const r in t.results[s]){const o=t.results[s][r];for(const t in o){const s=i.GetCell({row:Number(t),column:Number(r)});if(s){const i=s.GetValue();switch(typeof i){case"number":o[t][e]=i;break;case"boolean":o[t][e]=i?1:0;break;default:o[t][e]=0}}}}}return{status:Ie.OK,reference:null}}catch(e){return console.info("calculation error trapped",e),{status:Ie.CalculationError,reference:null}}}FlattenedResults(){const e=this.simulation_expression_calculator.simulation_model,t=[];for(const s in e.results)for(const i in e.results[s]){const r=e.results[s][i];for(const e in r)t.push(Ts({row:Number(e),column:Number(i),sheet_id:Number(s),data:r[e]}).buffer)}return t}FlushSimulationResults(){const e=this.simulation_expression_calculator.simulation_model;e.results=[],e.elapsed=0,e.trials=0}ShiftSimulationResults(e,t,s,i){}UpdateResults(e,t=this.model,s=!0){if(!t)throw new Error("UpdateResults called without model");const i=this.simulation_expression_calculator.simulation_model;if(e){i.results=[],i.elapsed=e.elapsed,i.trials=e.trials;for(const r of e.results){const e=r instanceof ArrayBuffer?Ds(new Float64Array(r)):r;e.sheet_id||(e.sheet_id=t.active_sheet.id),i.results[e.sheet_id]||(i.results[e.sheet_id]=[]),i.results[e.sheet_id][e.column]||(i.results[e.sheet_id][e.column]=[]),i.results[e.sheet_id][e.column][e.row]=e.data,s&&this.SetDirty(e)}}else i.results=[],i.elapsed=0,i.trials=0}}var $s=s(742),Hs=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z",".","-",":","+","=","^","!","/","*","?","&","<",">","(",")","[","]","{","}","@","%","$","#"],Vs=[0,68,0,84,83,82,72,0,75,76,70,65,0,63,62,69,0,1,2,3,4,5,6,7,8,9,64,0,73,66,74,71,81,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,77,0,78,67,0,0,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,79,0,80,0,0];function js(e){if(e.length%4)return null;for(var t="",s=0,i=0,r="string"==typeof e?function(e,t){return e.charCodeAt(t)}:function(e,t){return e[t]};s<e.length;)if(i=256*i+r(e,s++),s%4==0){for(var o=52200625;o>=1;)t+=Hs[Math.floor(i/o)%85],o/=85;i=0}return t}function Gs(e){if(e.length%5)return null;for(var t=new Uint8Array(4*e.length/5),s=0,i=0,r=0;i<e.length;){if(!Hs.includes(e.charAt(i)))return null;var o=e.charCodeAt(i++)-32;if(r=85*r+Vs[o],i%5==0){for(var a=16777216;a>=1;)t[s++]=r/a%256,a/=256;r=0}}return t}class Bs extends Es{constructor(){super(...arguments),this.replay_buffer=[],this.simulation_resolution=[],this.workers=[],this.simulation_status={running:!1,threads:0,results:[],completed:0,progress:[],aggregate_progress:0}}ResetInternal(){super.ResetInternal(),this.FlushSimulationResults()}SimulationData(e){(e=this.EnsureAddress(e)).sheet_id||(e.sheet_id=this.grid.model.active_sheet.id);const t=this.calculator.GetResults();if(!t)return;if(!t[e.sheet_id])return;if(!t[e.sheet_id][e.column])return;const s=t[e.sheet_id][e.column][e.row];return s?Array.isArray(s)?s.slice(0):Array.from(s):void 0}FlushSimulationResults(){this.calculator.FlushSimulationResults(),this.last_simulation_data=void 0}SerializeDocument(e=!0,t=!0,s={}){const i=super.SerializeDocument(e,t,s);return e&&this.last_simulation_data&&(i.simulation_data={elapsed:this.last_simulation_data.elapsed,trials:this.last_simulation_data.trials,results:void 0},s.use_float32?(i.simulation_data.bitness=32,i.simulation_data.results=(this.last_simulation_data.results||[]).map((e=>{const t=Float32Array.from(new Float64Array(e));return s.use_z85?js(new Uint8Array(t.buffer)):$s.JQ(new Uint8Array(t.buffer))}))):i.simulation_data.results=(this.last_simulation_data.results||[]).map((e=>s.use_z85?js(new Uint8Array(e)):$s.JQ(new Uint8Array(e)))),s.use_z85&&(i.simulation_data.encoding="z85")),i}InitWorkers(e=this.options.max_workers){return t(this,void 0,void 0,(function*(){if(e=e||1,this.workers.length){for(const e of this.workers)e.terminate();this.workers=[]}let t=Math.max(1,e);"number"==typeof navigator.hardwareConcurrency&&(t=Math.min(t,navigator.hardwareConcurrency)),console.info(`creating ${t} thread${1===t?"":"s"}`);for(let e=0;e<t;e++)this.workers[e]=yield this.LoadWorker("embedded-treb-worker"),this.workers[e].onmessage=t=>{const s=t.data;this.HandleWorkerMessage(s,e)},this.workers[e].onerror=t=>{var s;console.error(`worker error (worker #${e})`),console.info(t);const i=t.message||"Worker error.";null===(s=this.dialog)||void 0===s||s.ShowDialog({title:"Calculation failed",message:i,close_box:!0,type:os.error,timeout:3e3});for(const e of this.simulation_resolution)e.call(this);this.simulation_resolution=[],this.simulation_status.running=!1;for(const e of this.workers)e.terminate();this.workers=[]}}))}RunSimulation(e=this.options.default_trials||5e3,s={}){var i,r,o;return t(this,void 0,void 0,(function*(){const{lhs:t,stepped:a,abort_on_dialog_close:n}=Object.assign({abort_on_dialog_close:!0,lhs:!!this.options.lhs,stepped:!!this.options.screen_updates},s);let l,h=s.additional_cells||[];if(this.simulation_status.running)throw new Error("simulation already running");if("number"==typeof s.seed&&Ps.Random.Seed(s.seed),null===(i=this.dialog)||void 0===i||i.ShowDialog({title:"Running Monte Carlo simulation",message:"Starting"}).then((()=>{this.simulation_status.running&&n&&this.AbortSimulation()})),!this.workers.length)try{yield this.InitWorkers()}catch(e){throw null===(r=this.dialog)||void 0===r||r.ShowDialog({title:"Calculation failed",message:"Worker not initialized.",close_box:!0,type:os.error,timeout:3e3}),new Error("worker not initialized")}if(!this.workers[0])throw null===(o=this.dialog)||void 0===o||o.ShowDialog({title:"Calculation failed",message:"Worker not initialized.",close_box:!0,type:os.error,timeout:3e3}),new Error("worker not initialized");this.Publish({type:"running-simulation",trials:e}),this.simulation_status.running=!0,this.simulation_status.threads=this.workers.length,this.simulation_status.progress=[],this.simulation_status.results=[],this.simulation_status.aggregate_progress=0,this.simulation_status.completed=0;for(let e=0;e<this.workers.length;e++)this.simulation_status.progress.push(0);for(const e of this.grid.model.active_sheet.annotations)e.formula&&(h=h.concat(this.calculator.MetadataReferences(e.formula)));if(h=this.calculator.FlattenCellList(h),this.grid.model.macro_functions){l=[];const e=Object.keys(this.grid.model.macro_functions);for(const t of e){const e=this.grid.model.macro_functions[t];l.push(JSON.parse(JSON.stringify(e)))}}const c=this.workers.map((()=>1e14*Ps.Random.Next()));s.replay&&this.replay_buffer.map(((e,t)=>c[t]=e));for(let e=0;e<this.workers.length;e++)this.workers[e].postMessage({type:"configure",seed:c[e],locale:f.locale,sheets:this.grid.model.sheets.map((e=>e.toJSON({rendered_values:!0,preserve_type:!0}))),named_ranges:this.grid.model.named_ranges.Serialize(),macro_functions:l,additional_cells:h});this.replay_buffer=c,Ps.Random.Seed(c[0]);let d=e,u=this.workers.length;for(const e of this.workers){const s=Math.floor(d/u--);e.postMessage({type:"start",trials:s,lhs:t,screen_updates:a}),d-=s}yield new Promise((e=>{this.simulation_resolution.push(e)}))}))}InitCalculator(){return new Us}ImportDocumentData(e,t){if(super.ImportDocumentData(e,t),e.simulation_data){const t="z85"===e.simulation_data.encoding;this.last_simulation_data=e.simulation_data,32===e.simulation_data.bitness?this.last_simulation_data.results=(this.last_simulation_data.results||[]).map((e=>{if(t){const t=Gs(e);return t?Float64Array.from(t).buffer:(new Float64Array).buffer}{const t=new Float32Array($s.b$(e).buffer);return Float64Array.from(t).buffer}})):this.last_simulation_data.results=(this.last_simulation_data.results||[]).map((e=>{if(t){const t=Gs(e);return t?t.buffer:(new Uint8Array).buffer}return $s.b$(e).buffer})),this.calculator.UpdateResults(this.last_simulation_data,this.grid.model,!1)}else this.FlushSimulationResults()}UpdateProgress(e,t){var s;this.simulation_status.progress[t]=e||0;const i=Math.round(this.simulation_status.progress.reduce(((e,t)=>e+t),0)/this.simulation_status.threads);i!==this.simulation_status.aggregate_progress&&(this.simulation_status.aggregate_progress=i,null===(s=this.dialog)||void 0===s||s.Update({message:`${i}% complete`}),this.Publish({type:"simulation-progress",progress:i}))}HandleWorkerMessage(e,t){switch(e.type){case"update":this.UpdateProgress(e.percent_complete,t),this.simulation_status.results[t]=e.trial_data,this.last_simulation_data=zs(this.simulation_status.results.filter((e=>!!e))),this.calculator.UpdateResults(this.last_simulation_data),this.Recalculate().then((()=>{this.workers[t].postMessage({type:"step"})}));break;case"progress":this.UpdateProgress(e.percent_complete,t);break;case"complete":this.simulation_status.progress[t]=100,this.simulation_status.results[t]=e.trial_data,this.simulation_status.completed++,this.simulation_status.completed===this.simulation_status.threads?(this.simulation_status.running=!1,this.last_simulation_data=zs(this.simulation_status.results),requestAnimationFrame((()=>{this.calculator.UpdateResults(this.last_simulation_data),this.Recalculate().then((()=>{this.grid.headless||this.Focus()})),setTimeout((()=>{var e,t,s;null===(e=this.dialog)||void 0===e||e.HideDialog(),this.Publish({type:"simulation-complete",elapsed:(null===(t=this.last_simulation_data)||void 0===t?void 0:t.elapsed)||0,trials:(null===(s=this.last_simulation_data)||void 0===s?void 0:s.trials)||0});for(const e of this.simulation_resolution)e.call(this);this.simulation_resolution=[]}),500)}))):this.UpdateProgress(100,t);break;default:console.info("unhandled worker message",e)}}AbortSimulation(){console.warn("aborting simulation");for(const e of this.workers)e.terminate();this.workers=[],this.simulation_status.running=!1,requestAnimationFrame((()=>{this.Recalculate().then((()=>{this.grid.headless||this.Focus()})),this.Publish({type:"simulation-aborted"});for(const e of this.simulation_resolution)e.call(this);this.simulation_resolution=[]}))}}const Zs={"treb-popout-icon":{viewbox:"0 0 28 28",paths:["M22 14.5v5c0 2.484-2.016 4.5-4.5 4.5h-13c-2.484 0-4.5-2.016-4.5-4.5v-13c0-2.484 2.016-4.5 4.5-4.5h11c0.281 0 0.5 0.219 0.5 0.5v1c0 0.281-0.219 0.5-0.5 0.5h-11c-1.375 0-2.5 1.125-2.5 2.5v13c0 1.375 1.125 2.5 2.5 2.5h13c1.375 0 2.5-1.125 2.5-2.5v-5c0-0.281 0.219-0.5 0.5-0.5h1c0.281 0 0.5 0.219 0.5 0.5zM28 1v8c0 0.547-0.453 1-1 1-0.266 0-0.516-0.109-0.703-0.297l-2.75-2.75-10.187 10.187c-0.094 0.094-0.234 0.156-0.359 0.156s-0.266-0.063-0.359-0.156l-1.781-1.781c-0.094-0.094-0.156-0.234-0.156-0.359s0.063-0.266 0.156-0.359l10.187-10.187-2.75-2.75c-0.187-0.187-0.297-0.438-0.297-0.703 0-0.547 0.453-1 1-1h8c0.547 0 1 0.453 1 1z"]},"treb-toolbar-icon":{viewbox:"0 0 24 28",paths:["M5.5 22v2h-5.5v-2h5.5zM11 20c0.547 0 1 0.453 1 1v4c0 0.547-0.453 1-1 1h-4c-0.547 0-1-0.453-1-1v-4c0-0.547 0.453-1 1-1h4zM13.5 14v2h-13.5v-2h13.5zM3.5 6v2h-3.5v-2h3.5zM24 22v2h-11.5v-2h11.5zM9 4c0.547 0 1 0.453 1 1v4c0 0.547-0.453 1-1 1h-4c-0.547 0-1-0.453-1-1v-4c0-0.547 0.453-1 1-1h4zM19 12c0.547 0 1 0.453 1 1v4c0 0.547-0.453 1-1 1h-4c-0.547 0-1-0.453-1-1v-4c0-0.547 0.453-1 1-1h4zM24 14v2h-3.5v-2h3.5zM24 6v2h-13.5v-2h13.5z"]},"treb-export-icon":{viewbox:"0 0 26 28",paths:["M20 21c0-0.547-0.453-1-1-1s-1 0.453-1 1 0.453 1 1 1 1-0.453 1-1zM24 21c0-0.547-0.453-1-1-1s-1 0.453-1 1 0.453 1 1 1 1-0.453 1-1zM26 17.5v5c0 0.828-0.672 1.5-1.5 1.5h-23c-0.828 0-1.5-0.672-1.5-1.5v-5c0-0.828 0.672-1.5 1.5-1.5h7.266l2.109 2.125c0.578 0.562 1.328 0.875 2.125 0.875s1.547-0.313 2.125-0.875l2.125-2.125h7.25c0.828 0 1.5 0.672 1.5 1.5zM20.922 8.609c0.156 0.375 0.078 0.812-0.219 1.094l-7 7c-0.187 0.203-0.453 0.297-0.703 0.297s-0.516-0.094-0.703-0.297l-7-7c-0.297-0.281-0.375-0.719-0.219-1.094 0.156-0.359 0.516-0.609 0.922-0.609h4v-7c0-0.547 0.453-1 1-1h4c0.547 0 1 0.453 1 1v7h4c0.406 0 0.766 0.25 0.922 0.609z"]},"treb-reset-icon":{viewbox:"0 0 24 28",paths:["M23.609 16.5c0 0.031 0 0.078-0.016 0.109-1.328 5.531-5.891 9.391-11.656 9.391-3.047 0-6-1.203-8.219-3.313l-2.016 2.016c-0.187 0.187-0.438 0.297-0.703 0.297-0.547 0-1-0.453-1-1v-7c0-0.547 0.453-1 1-1h7c0.547 0 1 0.453 1 1 0 0.266-0.109 0.516-0.297 0.703l-2.141 2.141c1.469 1.375 3.422 2.156 5.437 2.156 2.781 0 5.359-1.437 6.813-3.813 0.375-0.609 0.562-1.203 0.828-1.828 0.078-0.219 0.234-0.359 0.469-0.359h3c0.281 0 0.5 0.234 0.5 0.5zM24 4v7c0 0.547-0.453 1-1 1h-7c-0.547 0-1-0.453-1-1 0-0.266 0.109-0.516 0.297-0.703l2.156-2.156c-1.484-1.375-3.437-2.141-5.453-2.141-2.781 0-5.359 1.437-6.813 3.813-0.375 0.609-0.562 1.203-0.828 1.828-0.078 0.219-0.234 0.359-0.469 0.359h-3.109c-0.281 0-0.5-0.234-0.5-0.5v-0.109c1.344-5.547 5.953-9.391 11.719-9.391 3.063 0 6.047 1.219 8.266 3.313l2.031-2.016c0.187-0.187 0.438-0.297 0.703-0.297 0.547 0 1 0.453 1 1z"]},"treb-about-icon":{viewbox:"0 0 24 28",paths:["M14 21.5v-3c0-0.281-0.219-0.5-0.5-0.5h-3c-0.281 0-0.5 0.219-0.5 0.5v3c0 0.281 0.219 0.5 0.5 0.5h3c0.281 0 0.5-0.219 0.5-0.5zM18 11c0-2.859-3-5-5.688-5-2.547 0-4.453 1.094-5.797 3.328-0.141 0.219-0.078 0.5 0.125 0.656l2.063 1.563c0.078 0.063 0.187 0.094 0.297 0.094 0.141 0 0.297-0.063 0.391-0.187 0.734-0.938 1.047-1.219 1.344-1.437 0.266-0.187 0.781-0.375 1.344-0.375 1 0 1.922 0.641 1.922 1.328 0 0.812-0.422 1.219-1.375 1.656-1.109 0.5-2.625 1.797-2.625 3.313v0.562c0 0.281 0.219 0.5 0.5 0.5h3c0.281 0 0.5-0.219 0.5-0.5v0c0-0.359 0.453-1.125 1.188-1.547 1.188-0.672 2.812-1.578 2.812-3.953zM24 14c0 6.625-5.375 12-12 12s-12-5.375-12-12 5.375-12 12-12 12 5.375 12 12z"]},"treb-simulation-icon":{viewbox:"0 0 24 28",paths:["M18.5 14c0 0.359-0.187 0.688-0.5 0.859l-8.5 5c-0.156 0.094-0.328 0.141-0.5 0.141s-0.344-0.047-0.5-0.125c-0.313-0.187-0.5-0.516-0.5-0.875v-10c0-0.359 0.187-0.688 0.5-0.875 0.313-0.172 0.703-0.172 1 0.016l8.5 5c0.313 0.172 0.5 0.5 0.5 0.859z","M20.5 14c0-4.688-3.813-8.5-8.5-8.5s-8.5 3.813-8.5 8.5 3.813 8.5 8.5 8.5 8.5-3.813 8.5-8.5zM24 14c0 6.625-5.375 12-12 12s-12-5.375-12-12 5.375-12 12-12 12 5.375 12 12z"]},"treb-fork-icon":{viewbox:"0 0 16 28",paths:["M4.5 23c0-0.828-0.672-1.5-1.5-1.5s-1.5 0.672-1.5 1.5 0.672 1.5 1.5 1.5 1.5-0.672 1.5-1.5zM4.5 5c0-0.828-0.672-1.5-1.5-1.5s-1.5 0.672-1.5 1.5 0.672 1.5 1.5 1.5 1.5-0.672 1.5-1.5zM14.5 7c0-0.828-0.672-1.5-1.5-1.5s-1.5 0.672-1.5 1.5 0.672 1.5 1.5 1.5 1.5-0.672 1.5-1.5zM16 7c0 1.109-0.609 2.078-1.5 2.594-0.047 5.641-4.047 6.891-6.703 7.734-2.484 0.781-3.297 1.156-3.297 2.672v0.406c0.891 0.516 1.5 1.484 1.5 2.594 0 1.656-1.344 3-3 3s-3-1.344-3-3c0-1.109 0.609-2.078 1.5-2.594v-12.812c-0.891-0.516-1.5-1.484-1.5-2.594 0-1.656 1.344-3 3-3s3 1.344 3 3c0 1.109-0.609 2.078-1.5 2.594v7.766c0.797-0.391 1.641-0.656 2.406-0.891 2.906-0.922 4.562-1.609 4.594-4.875-0.891-0.516-1.5-1.484-1.5-2.594 0-1.656 1.344-3 3-3s3 1.344 3 3z"]},"treb-chevron-left-icon":{viewbox:"0 0 21 28",paths:["M18.297 4.703l-8.297 8.297 8.297 8.297c0.391 0.391 0.391 1.016 0 1.406l-2.594 2.594c-0.391 0.391-1.016 0.391-1.406 0l-11.594-11.594c-0.391-0.391-0.391-1.016 0-1.406l11.594-11.594c0.391-0.391 1.016-0.391 1.406 0l2.594 2.594c0.391 0.391 0.391 1.016 0 1.406z"]},"treb-chevron-right-icon":{viewbox:"0 0 19 28",paths:["M17.297 13.703l-11.594 11.594c-0.391 0.391-1.016 0.391-1.406 0l-2.594-2.594c-0.391-0.391-0.391-1.016 0-1.406l8.297-8.297-8.297-8.297c-0.391-0.391-0.391-1.016 0-1.406l2.594-2.594c0.391-0.391 1.016-0.391 1.406 0l11.594 11.594c0.391 0.391 0.391 1.016 0 1.406z"]}},Js="sidebar-open",qs="toolbar-open",Ws="http://www.w3.org/2000/svg";class Xs{constructor(e){const t="string"==typeof e.container?document.querySelector(e.container):e.container;if(!t)throw new Error("missing container");this.options=Object.assign(Object.assign({},ls),e),this.outer_container=t,"static"===window.getComputedStyle(t).position&&(t.style.position="relative");const s=this.outer_container.getBoundingClientRect();this.options.headless||s.width&&s.height||this.outer_container.classList.add("default-spreadsheet-size"),this.inner_container=document.createElement("div"),this.inner_container.classList.add("embedded-spreadsheet-container"),this.options.collapsed||this.outer_container.classList.add("sidebar-open"),"show"!==this.options.toolbar&&"show-narrow"!==this.options.toolbar||this.outer_container.classList.add("toolbar-open"),this.outer_container.appendChild(this.inner_container),this.sheet=new Bs(Object.assign(Object.assign({},this.options),{container:this.inner_container,resizable:!1})),this.sidebar=document.createElement("div"),this.sidebar.classList.add("embedded-spreadsheet-sidebar"),Xs.EnsureSymbols(),this.options.mc&&this.AddSidebarButton({icon:"treb-simulation-icon",title:"Run Simulation",click:()=>this.sheet.RunSimulation()}),this.AddSidebarButton({icon:"treb-reset-icon",title:"Recalculate",click:()=>this.sheet.Recalculate()}),this.options.toolbar&&(this.toolbar_container=document.createElement("div"),this.toolbar_container.classList.add("toolbar-container"),this.toolbar_button=this.AddSidebarButton({icon:"treb-toolbar-icon",title:"Show Toolbar",click:()=>this.ToggleToolbar()}),this.outer_container.appendChild(this.toolbar_container),this.sheet.toolbar_ctl={Show:e=>this.ShowToolbar(e)}),this.options.export&&this.AddSidebarButton({icon:"treb-export-icon",title:"Download as XLSX",click:()=>this.sheet.Export()}),this.options.popout&&this.AddSidebarButton({icon:"treb-popout-icon",title:"Open in New Tab",click:()=>this.Popout()}),this.options.fork&&this.AddSidebarButton({icon:"treb-fork-icon",title:"Fork and Edit",click:()=>{const e="https://treb.app",t=window.open(e+"/edit?fork");t&&this.sheet.PostDocument(t,e)}}),this.AddSidebarButton({icon:"treb-about-icon",title:"What's This?",click:()=>this.sheet.About()});const i=document.createElement("div");i.classList.add("sidebar-spacer"),this.sidebar.appendChild(i),this.AddSidebarButton({icon:"treb-chevron-right-icon",classes:"smaller",title:"Hide Sidebar",click:()=>this.HideSidebar()}),this.outer_container.appendChild(this.sidebar);const r=this.AddSidebarButton({icon:"treb-chevron-left-icon",classes:["smaller","show-sidebar-button"],title:"Show Sidebar",click:()=>this.ShowSidebar()},void 0);if(this.outer_container.appendChild(r),this.options.resizable){const e=t.querySelector(".treb-grid"),s=t.querySelector(".treb-layout-master");e&&$.Create({container:this.outer_container,node:e,resize_callback:()=>this.sheet.Resize(),layout_reference:s||void 0})}"show"!==this.options.toolbar&&"show-narrow"!==this.options.toolbar||this.ShowToolbar(!0),e.container._spreadsheet=this.sheet}static EnsureSymbols(){if(this.symbols_injected)return;this.symbols_injected=!0;const e=document.createElementNS(Ws,"svg");e.setAttribute("aria-hidden","true"),e.style.position="absolute",e.style.width="0",e.style.height="0",e.style.overflow="hidden";const t=document.createElementNS(Ws,"defs");e.appendChild(t);for(const e of Object.keys(Zs)){const s=Zs[e],i=document.createElementNS(Ws,"symbol");i.setAttribute("id",e),s.viewbox&&i.setAttribute("viewBox",s.viewbox);for(const e of s.paths||[]){const t=document.createElementNS(Ws,"path");t.setAttribute("d",e),i.appendChild(t)}t.appendChild(i)}document.body.insertBefore(e,document.body.firstChild||null)}static Create(e){return new Xs(e).sheet}Popout(){const e=window.open("","_blank");if(!e)return;e.document.head.innerHTML=`<title>${this.sheet.document_name?`TREB: ${this.sheet.document_name}`:"TREB: Untitled Document"}</title><meta charset='utf-8'><meta http-equiv='X-UA-Compatible' content='IE=edge'><meta name='viewport' content='width=device-width,initial-scale=1'><link rel='icon' type='image/svg+xml' href='https://treb.app/leaf.svg'>`;const t=e.document.createElement("script");t.src=this.sheet.script_path,t.setAttribute("type","text/javascript"),e.document.body.appendChild(t);const s=JSON.stringify(this.sheet.SerializeDocument(!0,!0)),i=e.document.createElement("style");i.setAttribute("type","text/css"),i.textContent="*{box-sizing:border-box;padding:0;margin:0;}body,html{height:100%;width:100%;position:relative;}.treb{top:0;left:0;right:0;bottom:0;position:absolute;background:#fff;}",e.document.head.appendChild(i);const r=e.document.createElement("div");r.setAttribute("class","treb treb-fullscreen-padding"),e.document.body.appendChild(r);const o=window.screen.availWidth>=1200,a=e.document.createElement("script"),n=Object.assign(Object.assign({},this.options),{container:void 0,network_document:void 0,storage_key:void 0,resizable:!1,export:!0,scroll:void 0,toolbar:!o||"show",file_menu:!0,prompt_save:!0,expand_formula_button:o,popout:!1,add_tab:!0,tab_bar:"auto",headless:!1,dnd:!0,collapsed:!o});a.textContent=`(${((e,t)=>{let s=0;const i=()=>{e.container=document.querySelector(".treb"),e.container&&window.TREB?(window.sheet=window.TREB.CreateSpreadsheet(e),window.sheet.LoadDocument(t)):++s<32&&setTimeout((()=>i()),100)};i()}).toString()})(${JSON.stringify(n)},${s})`,e.document.body.appendChild(a),e.document.close()}AddSidebarButton(e={},t=this.sidebar){const s=document.createElement("div");if(s.classList.add("sidebar-button"),e.classes){const t="string"==typeof e.classes?[e.classes]:e.classes;for(const e of t)s.classList.add(e)}if(e.title&&s.setAttribute("title",e.title),e.text&&(s.textContent=e.text),e.click){const t=e.click;s.addEventListener("click",(()=>t()))}if(e.icon){const t=document.createElementNS(Ws,"svg");s.appendChild(t);const i=document.createElementNS(Ws,"use");i.setAttributeNS("http://www.w3.org/1999/xlink","href","#"+e.icon),t.appendChild(i)}return t&&t.appendChild(s),s}ToggleSidebar(){this.outer_container.classList.toggle(Js)}ShowSidebar(e=!0){e?this.outer_container.classList.add(Js):this.outer_container.classList.remove(Js)}HideSidebar(){this.ShowSidebar(!1)}ToggleToolbar(){this.ShowToolbar(!this.outer_container.classList.contains(qs))}ShowToolbar(e=!0){let t="Hide Toolbar";e?(this.toolbar_container&&!this.toolbar&&(this.toolbar=this.sheet.CreateToolbar(this.toolbar_container)),this.outer_container.classList.add(qs)):(this.outer_container.classList.remove(qs),t="Show Toolbar"),this.toolbar_button&&this.toolbar_button.setAttribute("title",t)}HideToolbar(){this.ShowToolbar(!1)}}Xs.symbols_injected=!1;class Ks{static Run(){const e=document.querySelectorAll("div[data-treb]");for(let t=0;t<e.length;t++){const s=e[t];if(s._spreadsheet)continue;const i=s.dataset||{},r={container:s,network_document:i.treb||void 0},o=i.options;if(o){const e=o.split(/,/g);for(const t of e){const[e,s]=t.split("=");e&&(void 0===s?r[e]=!0:/^(?:true|false)/i.test(s)?r[e]="false"!==s.toLowerCase():isNaN(s)?r[e]=s:r[e]=Number(s))}}const a=Xs.Create(r),n=r.load||i.load;if(n){const e=self;e[n]?e[n](a,s):console.warn(`function ${n} not found`)}}}}(()=>{const e=self.TREB||{};e.CreateSpreadsheet||(Es.SniffPath(),e.version="11.7.2",Es.enable_engine&&(e.CreateEngine=(e={})=>new Bs(e)),e.CreateSpreadsheet=e=>Xs.Create(e),Es.enable_formatter&&(e.Format={format:(e,t)=>Q.Get(t).Format(e),parse:e=>se.TryParse(e).value}),self.TREB=e,document.addEventListener("DOMContentLoaded",(()=>Ks.Run())),document.addEventListener("readystatechange",(()=>{"complete"===document.readyState&&Ks.Run()})))})(),Es.treb_language="es6"})()})();