/*! v11.0.1. Copyright 2018-2021 Structured Data, LLC. All rights reserved. CC BY-ND: https://treb.app/license */
(()=>{var e={691:function(e,t){!function(e){"use strict";var t=new(function(){function e(e){void 0===e&&(e=0),this.m_w=0,this.m_z=0,this.Seed(e)}return e.prototype.Seed=function(e){void 0===e&&(e=0),e?(this.m_w=Math.round(2863311530&e)||1,this.m_z=Math.round(1431655765&e)||1):(this.m_w=Math.round(1e5*Math.random()),this.m_z=Math.round((new Date).getTime()))},e.prototype.Next=function(){return this.m_z=36969*(65535&this.m_z)+(this.m_z>>16)&4294967295,this.m_w=18e3*(65535&this.m_w)+(this.m_w>>16)&4294967295,.5+((this.m_z<<16)+this.m_w&4294967295)/4294967296},e.prototype.GetState=function(){return[this.m_w,this.m_z]},e}()),r=function(){function e(){}return e.Sort=function(e,t){this.QuickSort(e,t,0,e.length)},e.Partition=function(e,t,r,s){for(var i=e[s-1],a=r,n=r;n<s-1;n+=1)e[n]<=i&&(this.Swap(e,t,n,a),a+=1);return this.Swap(e,t,a,s-1),a},e.Swap=function(e,t,r,s){var i=e[r];e[r]=e[s],e[s]=i,i=t[r],t[r]=t[s],t[s]=i},e.QuickSort=function(e,t,r,s){if(r<s){var i=this.Partition(e,t,r,s);this.QuickSort(e,t,r,i),this.QuickSort(e,t,i+1,s)}},e}(),s=function(){return(s=Object.assign||function(e){for(var t,r=1,s=arguments.length;r<s;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},i=function(){function e(){}return e.Sort=function(e){return this.QuickSort(e,0,e.length-1),e},e.Swap=function(e,t,r){var s=e[t];e[t]=e[r],e[r]=s},e.Partition=function(e,t,r){for(var s=e[Math.floor((r+t)/2)];t<=r;){for(;e[t]<s;)t++;for(;e[r]>s;)r--;t<=r&&(this.Swap(e,t,r),t++,r--)}return t},e.QuickSort=function(e,t,r){var s;return e.length>1&&(t<(s=this.Partition(e,t,r))-1&&this.QuickSort(e,t,s-1),s<r&&this.QuickSort(e,s,r)),e},e}(),a=function(){function e(){}return e.Correlation=function(e,t){for(var r=0,s=0,i=0,a=0,n=0,o=0,l=0;l<e.length;l++)s+=e[l]*t[l],i+=e[l],a+=t[l],n+=e[l]*e[l],o+=t[l]*t[l];return(r=e.length*s-i*a)&&(r/=Math.sqrt((e.length*n-i*i)*(e.length*o-a*a))),r},e.TickRange=function(e,t,r){var s=e/(t-1),i=Math.ceil(this.Log10(s)-1),a=Math.pow(10,i);return Math.ceil(s/a)*a},e.Log10=function(e){return Math.log(e)/Math.LN10},e.Log2=function(e){return Math.log(e)/Math.LN2},e.Percentiles=function(e,t){for(var r=i.Sort(e.slice(0)),s=r.length,a=new Array(101),n=0;n<100;n++)a[n]=r[Math.round(s*n/100)];return a[100]=r[s-1],a},e.Percentile=function(e,t){var r=i.Sort(e.slice(0)),s=r.length;return r[Math.max(0,Math.min(s-1,Math.round(s*t)))]},e.Interval=function(e){var t=0;if(!e.data||!e.data.length)return 0;if(void 0===e.min){if(void 0===e.max)return 1;for(var r=0,s=e.data;r<s.length;r++)(l=s[r])<=e.max&&t++}else if(void 0===e.max)for(var i=0,a=e.data;i<a.length;i++)(l=a[i])>=e.min&&t++;else for(var n=0,o=e.data;n<o.length;n++){var l;(l=o[n])>=e.min&&l<=e.max&&t++}return t/e.data.length},e.R2=function(e,t){for(var r=0,s=0,i=0,a=0,n=0,o=0,l=0,u=0,h=0;h<e.length;h++)a+=(s=t[h])*(i=e[h]),n+=s,o+=i,l+=s*s,u+=i*i;return(r=e.length*a-n*o)&&(r/=Math.sqrt((e.length*l-n*n)*(e.length*u-o*o))),r*r},e.ToSD=function(e,t){if(void 0===t&&(t=2),t=t||2,0===e)return e;var r=Math.pow(10,Math.floor(this.Log10(e))+1-t);return Math.round(e/r)*r},e.Statistics=function(e){for(var t=this.Range(e),r=e.length,a=0,n=0,o=0,l=0,u=i.Sort(e.slice(0)),h=u[Math.round(r/2)],c=0;c<r;c++)a+=e[c];var d=a/=r;for(c=0;c<r;c++){var m=e[c]-a;n+=m*m,l+=m*m*m,o+=m*m*m*m}var f=r,p=n/r,_=Math.sqrt(n/r),y=l/((r-1)*Math.pow(_,3)),g=o/((r-1)*Math.pow(_,4)),v=Math.sqrt(n/r)/Math.sqrt(r),b={};for(c=5;c<100;c+=5)b[c]=u[Math.round(r*c/100)];b[0]=u[0],b[100]=u[r-1];var w=this.Interval({data:e,max:0});return s(s({},t),{median:h,mean:d,N:f,variance:p,stdev:_,skewness:y,kurtosis:g,stderr:v,percentiles:b,zero:w})},e.Truncate=function(e,t,r){var s=i.Sort(e.slice(0));return s.slice(Math.round(s.length*t/100),Math.round(s.length*r/100))},e.Histogram=function(e,t){void 0===t&&(t="sturges");for(var r=!0,s=0;r&&s<e.length;s++)r=r&&e[s]===Math.round(e[s]);var i=this.Range(e);if("string"==typeof t||!t)if("fd"===t){var a=this.FD(e);t=0===a||0===i.range?1:Math.round(i.range/a+1)}else t=this.Sturges(e);var n=[],o=[];if(r&&t>i.range){for(t=i.range+1,s=0;s<t;s++)n[s]=0,o[s]=i.min+s;for(var l=0,u=e;l<u.length;l++)n[(_=u[l])-i.min]++}else{var h=this.TickRange(i.range,t),c=this.FirstBin(i.max,i.min,t,h),d=Math.ceil(this.Log10(h)-1);for(s=0;s<t;s++)n[s]=0,o[s]=(c+s*h).toFixed(Math.max(0,-d));for(var m=c-h,f=0,p=e;f<p.length;f++){var _=p[f];n[Math.floor((_-m)/h)]++}}return{bins:n,labels:o}},e.Sturges=function(e){return Math.ceil(this.Log2(e.length)+1)},e.IQR=function(e){var t=this.Quantiles(e,[.25,.75]);return t[1]-t[0]},e.Quantiles=function(e,t){void 0===t&&(t=[0,.25,.5,.75,1]);var r=i.Sort(e.slice(0));return t.map((function(e){return r[Math.floor((r.length-1)*e)]}))},e.FD=function(e){return 2*this.IQR(e)*Math.pow(e.length,-1/3)},e.FirstBin=function(e,t,r,s){var i=(Math.floor(t/s)+1)*s,a=Math.floor((i+(r-1)*s-e)/s);return a>=2?i-a/2*s:i},e.Range=function(e){for(var t=e.length,r=t>0?e[0]:0,s=t>0?e[0]:0,i=1;i<t;i++)e[i]>s&&(s=e[i]),e[i]<r&&(r=e[i]);return{min:r,max:s,range:s-r}},e.EPSILON_DOUBLE=2220446049250313e-31,e.QUIET_NAN=Number.NaN,e.s_undefined="undefined",e.s_object="object",e.s_number="number",e}(),n=function(){function e(){this.rows=0,this.columns=0,this.data=[]}return e.Zero=function(t,r){return void 0===r&&(r=t),(new e).Reset(t,r)},e.Identity=function(e){for(var t=this.Zero(e,e),r=0;r<e;r++)t.data[r][r]=1;return t},e.Clone=function(t){var r=new e;r.rows=t.rows,r.columns=t.columns;for(var s=0,i=t.data;s<i.length;s++){var a=i[s];r.data.push(new Float64Array(a))}return r},e.FromArray=function(e,t){void 0===t&&(t=!1);var r=e[0].length,s=e.length;if(t){for(var i=this.Zero(r,s),a=0;a<s;a++)for(var n=0;n<r;n++)i.data[a][n]=e[a][n];return i}for(i=this.Zero(s,r),a=0;a<s;a++)for(n=0;n<r;n++)i.data[n][a]=e[a][n]||0;return i},e.prototype.Reset=function(e,t){this.data=new Array(t);for(var r=0;r<t;r++)this.data[r]=new Float64Array(e);return this.rows=e,this.columns=t,this},e.prototype.CopyTo=function(e){e.rows=this.rows,e.columns=this.columns,e.data=new Array(this.columns);for(var t=0,r=this.data;t<r.length;t++){var s=r[t];e.data.push(new Float64Array(s))}return e},e.prototype.GetColumn=function(e){return this.data[e]},e.prototype.SetColumn=function(e,t){this.data[e]=new Float64Array(t)},e.prototype.Transpose=function(){for(var t=e.Zero(this.columns,this.rows),r=0;r<this.columns;r++)for(var s=0;s<this.rows;s++)t.data[r][s]=this.data[s][r];return t},e.prototype.Symmetrize=function(t){void 0===t&&(t=!1);var r=this.Transpose(),s=e.Clone(this);if(t)for(a=1;a<this.columns;a++)for(i=0;i<a;i++)s.data[i][a]=r.data[i][a];else for(var i=1;i<this.rows;i++)for(var a=0;a<i;a++)s.data[i][a]=r.data[i][a];return s},e.prototype.Cholesky=function(t){if(void 0===t&&(t=!1),this.rows!==this.columns)throw new Error("matrix not square");for(var r=this.rows,s=e.Zero(r),i=0;i<r;i++){for(var a=0,n=0;n<i;n++){for(var o=0,l=0;l<n;l++)o+=s.data[n][l]*s.data[i][l];if(s.data[i][n]=o=(this.data[i][n]-o)/s.data[n][n],a+=o*o,this.data[n][i]!==this.data[i][n])throw new Error("matrix not symmetrical")}if((a=this.data[i][i]-a)<=0)throw new Error("matrix not pos-def ("+a+")");for(s.data[i][i]=a>0?Math.sqrt(a):0,n=i+1;n<r;n++)s.data[i][n]=0}return t?s.Transpose():s},e.prototype.Multiply=function(t){for(var r=0,s=0,i=e.Zero(this.rows,t.columns),a=0;a<this.rows;a++)for(var n=0;n<t.columns;n++){for(s=r=0;r<this.columns;r++)s+=this.data[r][a]*t.data[n][r];i.data[n][a]=s}return i},e.prototype.Inverse=function(){if(this.rows!==this.columns)throw new Error("invalid matrix");for(var t=e.Clone(this),r=0,s=t.rows,i=1;i<s;i++)t.data[i][0]/=t.data[0][0];for(i=1;i<s;i++){for(var a=i;a<s;a++){r=0;for(var n=0;n<i;n++)r+=t.data[n][a]*t.data[i][n];t.data[i][a]-=r}if(i!==s-1)for(a=i+1;a<s;a++){for(r=0,n=0;n<i;n++)r+=t.data[n][i]*t.data[a][n];t.data[a][i]=(t.data[a][i]-r)/t.data[i][i]}}for(i=0;i<s;i++)for(a=i;a<s;a++){var o=1;if(i!==a)for(o=0,n=i;n<a;n++)o-=t.data[n][a]*t.data[i][n];t.data[i][a]=o/t.data[a][a]}for(i=0;i<s;i++)for(a=i;a<s;a++)if(i!==a){for(r=0,n=i;n<a;n++)r+=t.data[a][n]*(i===n?1:t.data[n][i]);t.data[a][i]=-r}for(i=0;i<s;i++)for(a=0;a<s;a++){for(r=0,n=i>a?i:a;n<s;n++)r+=(a===n?1:t.data[n][a])*t.data[i][n];t.data[i][a]=r}return t},e.prototype.SortColumns=function(t){void 0===t&&(t=!1);for(var r=e.Clone(this),s=t?function(e,t){return t-e}:function(e,t){return e-t},i=0,a=r.data;i<a.length;i++)a[i].sort(s);return r},e.prototype.Rank=function(t){void 0===t&&(t=!1);for(var s=e.Clone(this),i=new Int32Array(this.rows),a=0;a<this.rows;a++)i[a]=a;for(var n=0;n<this.columns;n++){var o=new Int32Array(i);for(r.Sort(s.data[n],o),t&&o.reverse(),a=0;a<this.rows;a++)s.data[n][o[a]]=a}return s},e.prototype.Rank2=function(t,s){void 0===t&&(t=!1);for(var i=e.Zero(this.rows,this.columns),a=new Int32Array(this.rows),n=0;n<this.rows;n++)a[n]=n;for(var o=0;o<this.columns;o++){var l=new Int32Array(a);for(r.Sort(this.data[o],l),t&&l.reverse(),n=0;n<this.rows;n++)i.data[o][l[n]]=s.data[o][n]}return i},e.prototype.Correl=function(){for(var t=e.Zero(this.columns,this.columns),r=0;r<this.columns;r++){t.data[r][r]=1;for(var s=0;s<r;s++)t.data[s][r]=a.Correlation(this.data[r],this.data[s])}return t.Symmetrize()},e.prototype.IsSymmetric=function(){if(this.rows!==this.columns)return!1;for(var e=0;e<this.columns;e++)for(var t=0;t<this.rows;t++)if(this.data[e][t]!==this.data[t][e])return!1;return!0},e.prototype.toString=function(e){var t="";e=e||2;for(var r=0;r<this.rows;r++){for(var s=0;s<this.columns;s++){var i=this.data[s][r];i>=0&&(t+=" "),t+=i.toFixed(e),t+=" "}t+="\n"}return t},e}();Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length,r=0;r<t;r++){if(arguments[r]===1/0||arguments[r]===-1/0)return 1/0;e+=arguments[r]*arguments[r]}return Math.sqrt(e)});var o=function(){function e(){}return e.Guid=function(){for(var e="",t=0;t<8;t++)e+=Math.round(256*Math.random()).toString(16);return e},e.Log10=function(e){return Math.log(e)/Math.LN10},e.ToSD=function(e,t){if(void 0===t&&(t=2),t=t||2,0===e)return e;var r=e<0?-1:1;e*=r;var s=Math.pow(10,Math.floor(this.Log10(e))+1-t);return Math.round(e/s)*s*r},e.ToSDCeil=function(e,t){if(void 0===t&&(t=2),t=t||2,0===e)return e;var r=e<0?-1:1;e*=r;var s=Math.pow(10,Math.floor(this.Log10(e))+1-t);return Math.ceil(e/s)*s*r},e.SuggestDecimals=function(e){if("number"!=typeof e){for(var t=e[0],r=e[0],s=0,i=e;s<i.length;s++){var a=i[s];t=Math.min(t,a),r=Math.max(r,a)}e=r-t}var n=Math.ceil(this.Log10(e));return console.log(n),n<=0?1-n:1},e.YearFraction=function(e){var t=new Date(e.getTime());return t.setMonth(11,31),(t.getTime()-e.getTime())/this.MILLIS_YEAR},e.DEFAULT_NUMBER_FORMAT="(0,0.00)",e.DEFAULT_PCT_FORMAT="0.00",e.DEFAULT_CURRENCY_FORMAT="(0,0)",e.MILLIS_YEAR=315576e5,e}(),l=function(){function e(e){this.order=0,this.realvalues=[],this.ivalues=[],this.vectors=[];var t=e.length;this.order=t,this.vectors=[];for(var r=!0,s=0;r&&s<t;s++){if(e[s].length!==t)throw new Error("not square");for(var i=0;i<t;i++)e[s][i]!==e[i][s]&&(r=!1)}if(r){for(s=0;s<t;s++)Array.isArray(e[s])?this.vectors.push(e[s].slice(0)):this.vectors.push(Array.from(e[s]));this.tred2(),this.tql2()}else{var a=[],n=[];for(s=0;s<t;s++){for(Array.isArray(e[s])?a.push(e[s].slice(0)):a.push(Array.from(e[s])),this.vectors.push([]),i=0;i<t;i++)this.vectors[s][i]=0;n.push(0)}this.orthes(a,n),this.hqr2(a,n)}}return e.prototype.GetDiagonal=function(){for(var e=[],t=0;t<this.order;t++){e.push([]);for(var r=0;r<this.order;r++)e[t][r]=0;e[t][t]=this.realvalues[t],this.ivalues[t]>0?e[t][t+1]=this.ivalues[t]:this.ivalues[t]<0&&(e[t][t-1]=this.ivalues[t])}return e},e.prototype.tred2=function(){for(var e=0,t=0,r=0,s=0,i=0,a=this.order,n=this.vectors,o=this.realvalues,l=this.ivalues,u=0;u<a;u++)o[u]=n[a-1][u];for(var h=a-1;h>0;h--){r=0,s=0;for(var c=0;c<h;c++)r+=Math.abs(o[c]);if(0===r)for(l[h]=o[h-1],u=0;u<h;u++)o[u]=n[h-1][u],n[h][u]=0,n[u][h]=0;else{for(c=0;c<h;c++)o[c]/=r,s+=o[c]*o[c];for(e=o[h-1],t=Math.sqrt(s),e>0&&(t=-t),l[h]=r*t,s-=e*t,o[h-1]=e-t,u=0;u<h;u++)l[u]=0;for(u=0;u<h;u++){e=o[u],n[u][h]=e;var d=l[u]+n[u][u]*e;for(c=u+1;c<=h-1;c++)d+=n[c][u]*o[c],l[c]+=n[c][u]*e;l[u]=d}for(e=0,u=0;u<h;u++)l[u]/=s,e+=l[u]*o[u];for(i=e/(s+s),u=0;u<h;u++)l[u]-=i*o[u];for(u=0;u<h;u++){for(e=o[u],t=l[u],c=u;c<=h-1;c++)n[c][u]-=e*l[c]+t*o[c];o[u]=n[h-1][u],n[h][u]=0}}o[h]=s}for(h=0;h<a-1;h++){if(n[a-1][h]=n[h][h],n[h][h]=1,0!==(s=o[h+1])){for(c=0;c<=h;c++)o[c]=n[c][h+1]/s;for(u=0;u<=h;u++){for(t=0,c=0;c<=h;c++)t+=n[c][h+1]*n[c][u];for(c=0;c<=h;c++)n[c][u]-=t*o[c]}}for(c=0;c<=h;c++)n[c][h+1]=0}for(u=0;u<a;u++)o[u]=n[a-1][u],n[a-1][u]=0;n[a-1][a-1]=1,l[0]=0},e.prototype.tql2=function(){var e,t,r,s,i,a,n,o,l,u,h,c,d,m,f,p,_,y,g,v=this.order,b=this.vectors,w=this.realvalues,x=this.ivalues;for(e=1;e<v;e++)x[e-1]=x[e];for(x[v-1]=0,n=0,o=0,l=Math.pow(2,-52),t=0;t<v;t++){for(o=Math.max(o,Math.abs(w[t])+Math.abs(x[t])),a=t;a<v&&!(Math.abs(x[a])<=l*o);)a++;if(a>t)do{for(u=w[t],s=(w[t+1]-u)/(2*x[t]),h=Math.hypot(s,1),s<0&&(h=-h),w[t]=x[t]/(s+h),w[t+1]=x[t]*(s+h),c=w[t+1],d=u-w[t],e=t+2;e<v;e++)w[e]-=d;for(n+=d,s=w[a],f=m=1,p=m,_=x[t+1],y=0,g=0,e=a-1;e>=t;e--)for(p=f,f=m,g=y,u=m*x[e],d=m*s,h=Math.hypot(s,x[e]),x[e+1]=y*h,y=x[e]/h,s=(m=s/h)*w[e]-y*u,w[e+1]=d+y*(m*u+y*w[e]),r=0;r<v;r++)d=b[r][e+1],b[r][e+1]=y*b[r][e]+m*d,b[r][e]=m*b[r][e]-y*d;s=-y*g*p*_*x[t]/c,x[t]=y*s,w[t]=m*s}while(Math.abs(x[t])>l*o);w[t]=w[t]+n,x[t]=0}for(e=0;e<v-1;e++){for(r=e,s=w[e],i=e+1;i<v;i++)w[i]<s&&(r=i,s=w[i]);if(r!==e)for(w[r]=w[e],w[e]=s,i=0;i<v;i++)s=b[i][e],b[i][e]=b[i][r],b[i][r]=s}},e.prototype.orthes=function(e,t){var r,s,i,a,n,o,l,u=this.order,h=this.vectors,c=(this.realvalues,this.ivalues,u-1);for(o=1;o<=c-1;o++){for(l=0,a=o;a<=c;a++)l+=Math.abs(e[a][o-1]);if(0!==l){for(i=0,a=c;a>=o;a--)t[a]=e[a][o-1]/l,i+=t[a]*t[a];for(s=Math.sqrt(i),t[o]>0&&(s=-s),i-=t[o]*s,t[o]=t[o]-s,n=o;n<u;n++){for(r=0,a=c;a>=o;a--)r+=t[a]*e[a][n];for(r/=i,a=o;a<=c;a++)e[a][n]-=r*t[a]}for(a=0;a<=c;a++){for(r=0,n=c;n>=o;n--)r+=t[n]*e[a][n];for(r/=i,n=o;n<=c;n++)e[a][n]-=r*t[n]}t[o]=l*t[o],e[o][o-1]=l*s}}for(a=0;a<u;a++)for(n=0;n<u;n++)h[a][n]=a===n?1:0;for(o=c-1;o>=1;o--)if(0!==e[o][o-1]){for(a=o+1;a<=c;a++)t[a]=e[a][o-1];for(n=o;n<=c;n++){for(s=0,a=o;a<=c;a++)s+=t[a]*h[a][n];for(s=s/t[o]/e[o][o-1],a=o;a<=c;a++)h[a][n]+=s*t[a]}}},e.prototype.cdiv=function(e,t,r,s){var i=0,a=0;return Math.abs(r)>Math.abs(s)?{r:(e+(i=s/r)*t)/(a=r+i*s),i:(t-i*e)/a}:{r:((i=r/s)*e+t)/(a=s+i*r),i:(i*t-e)/a}},e.prototype.hqr2=function(e,t){var r,s,i,a,n,o,l,u,h,c,d,m=this.order,f=this.vectors,p=this.realvalues,_=this.ivalues,y=m,g=y-1,v=y-1,b=Math.pow(2,-52),w=0,x=0,M=0,C=0,S=0,A=0,R=0;for(o=0;o<y;o++)for((o<0||o>v)&&(p[o]=e[o][o],_[o]=0),l=Math.max(o-1,0);l<y;l++)R+=Math.abs(e[o][l]);for(h=0;g>=0;){for(c=g;c>0&&(0===(S=Math.abs(e[c-1][c-1])+Math.abs(e[c][c]))&&(S=R),!(Math.abs(e[c][c-1])<b*S));)c--;if(c===g)e[g][g]=e[g][g]+w,p[g]=e[g][g],_[g]=0,g--,h=0;else if(c===g-1){if(s=e[g][g-1]*e[g-1][g],M=(x=(e[g-1][g-1]-e[g][g])/2)*x+s,A=Math.sqrt(Math.abs(M)),e[g][g]=e[g][g]+w,e[g-1][g-1]=e[g-1][g-1]+w,i=e[g][g],M>=0){for(A=x>=0?x+A:x-A,p[g-1]=i+A,p[g]=p[g-1],0!==A&&(p[g]=i-s/A),_[g-1]=0,_[g]=0,x=(i=e[g][g-1])/(S=Math.abs(i)+Math.abs(A)),M=A/S,x/=C=Math.sqrt(x*x+M*M),M/=C,l=g-1;l<y;l++)A=e[g-1][l],e[g-1][l]=M*A+x*e[g][l],e[g][l]=M*e[g][l]-x*A;for(o=0;o<=g;o++)A=e[o][g-1],e[o][g-1]=M*A+x*e[o][g],e[o][g]=M*e[o][g]-x*A;for(o=0;o<=v;o++)A=f[o][g-1],f[o][g-1]=M*A+x*f[o][g],f[o][g]=M*f[o][g]-x*A}else p[g-1]=i+x,p[g]=i+x,_[g-1]=A,_[g]=-A;g-=2,h=0}else{if(i=e[g][g],a=0,s=0,c<g&&(a=e[g-1][g-1],s=e[g][g-1]*e[g-1][g]),10===h){for(w+=i,o=0;o<=g;o++)e[o][o]-=i;i=a=.75*(S=Math.abs(e[g][g-1])+Math.abs(e[g-1][g-2])),s=-.4375*S*S}if(30===h&&(S=(S=(a-i)/2)*S+s)>0){for(S=Math.sqrt(S),a<i&&(S=-S),S=i-s/((a-i)/2+S),o=0;o<=g;o++)e[o][o]-=S;w+=S,i=a=s=.964}for(h+=1,d=g-2;d>=c&&(x=((C=i-(A=e[d][d]))*(S=a-A)-s)/e[d+1][d]+e[d][d+1],M=e[d+1][d+1]-A-C-S,C=e[d+2][d+1],x/=S=Math.abs(x)+Math.abs(M)+Math.abs(C),M/=S,C/=S,d!==c)&&!(Math.abs(e[d][d-1])*(Math.abs(M)+Math.abs(C))<b*(Math.abs(x)*(Math.abs(e[d-1][d-1])+Math.abs(A)+Math.abs(e[d+1][d+1]))));)d--;for(o=d+2;o<=g;o++)e[o][o-2]=0,o>d+2&&(e[o][o-3]=0);for(u=d;u<=g-1;u++){var k=u!==g-1;if(u!==d&&(x=e[u][u-1],M=e[u+1][u-1],C=k?e[u+2][u-1]:0,0!==(i=Math.abs(x)+Math.abs(M)+Math.abs(C))&&(x/=i,M/=i,C/=i)),0===i)break;if(S=Math.sqrt(x*x+M*M+C*C),x<0&&(S=-S),0!==S){for(u!==d?e[u][u-1]=-S*i:c!==d&&(e[u][u-1]=-e[u][u-1]),i=(x+=S)/S,a=M/S,A=C/S,M/=x,C/=x,l=u;l<y;l++)x=e[u][l]+M*e[u+1][l],k&&(x+=C*e[u+2][l],e[u+2][l]=e[u+2][l]-x*A),e[u][l]=e[u][l]-x*i,e[u+1][l]=e[u+1][l]-x*a;for(o=0;o<=Math.min(g,u+3);o++)x=i*e[o][u]+a*e[o][u+1],k&&(x+=A*e[o][u+2],e[o][u+2]=e[o][u+2]-x*C),e[o][u]=e[o][u]-x,e[o][u+1]=e[o][u+1]-x*M;for(o=0;o<=v;o++)x=i*f[o][u]+a*f[o][u+1],k&&(x+=A*f[o][u+2],f[o][u+2]=f[o][u+2]-x*C),f[o][u]=f[o][u]-x,f[o][u+1]=f[o][u+1]-x*M}}}}if(0!==R){for(g=y-1;g>=0;g--)if(x=p[g],0===(M=_[g]))for(c=g,e[g][g]=1,o=g-1;o>=0;o--){for(s=e[o][o]-x,C=0,l=c;l<=g;l++)C+=e[o][l]*e[l][g];if(_[o]<0)A=s,S=C;else if(c=o,0===_[o]?e[o][g]=0!==s?-C/s:-C/(b*R):(i=e[o][o+1],a=e[o+1][o],r=(i*S-A*C)/(M=(p[o]-x)*(p[o]-x)+_[o]*_[o]),e[o][g]=r,Math.abs(i)>Math.abs(A)?e[o+1][g]=(-C-s*r)/i:e[o+1][g]=(-S-a*r)/A),b*(r=Math.abs(e[o][g]))*r>1)for(l=o;l<=g;l++)e[l][g]=e[l][g]/r}else if(M<0)for(c=g-1,Math.abs(e[g][g-1])>Math.abs(e[g-1][g])?(e[g-1][g-1]=M/e[g][g-1],e[g-1][g]=-(e[g][g]-x)/e[g][g-1]):(n=this.cdiv(0,-e[g-1][g],e[g-1][g-1]-x,M),e[g-1][g-1]=n.r,e[g-1][g]=n.i),e[g][g-1]=0,e[g][g]=1,o=g-2;o>=0;o--){var N=void 0,D=void 0,P=void 0,E=void 0;for(N=0,D=0,l=c;l<=g;l++)N+=e[o][l]*e[l][g-1],D+=e[o][l]*e[l][g];if(s=e[o][o]-x,_[o]<0)A=s,C=N,S=D;else if(c=o,0===_[o]?(n=this.cdiv(-N,-D,s,M),e[o][g-1]=n.r,e[o][g]=n.i):(i=e[o][o+1],a=e[o+1][o],P=(p[o]-x)*(p[o]-x)+_[o]*_[o]-M*M,E=2*(p[o]-x)*M,0===P&&0===E&&(P=b*R*(Math.abs(s)+Math.abs(M)+Math.abs(i)+Math.abs(a)+Math.abs(A))),n=this.cdiv(i*C-A*N+M*D,i*S-A*D-M*N,P,E),e[o][g-1]=n.r,e[o][g]=n.i,Math.abs(i)>Math.abs(A)+Math.abs(M)?(e[o+1][g-1]=(-N-s*e[o][g-1]+M*e[o][g])/i,e[o+1][g]=(-D-s*e[o][g]-M*e[o][g-1])/i):(n=this.cdiv(-C-a*e[o][g-1],-S-a*e[o][g],A,M),e[o+1][g-1]=n.r,e[o+1][g]=n.i)),b*(r=Math.max(Math.abs(e[o][g-1]),Math.abs(e[o][g])))*r>1)for(l=o;l<=g;l++)e[l][g-1]=e[l][g-1]/r,e[l][g]=e[l][g]/r}for(o=0;o<y;o++)if(o<0||o>v)for(l=o;l<y;l++)f[o][l]=e[o][l];for(l=y-1;l>=0;l--)for(o=0;o<=v;o++){for(A=0,u=0;u<=Math.min(l,v);u++)A+=f[o][u]*e[u][l];f[o][l]=A}}},e}(),u=Math.pow(2,-52),h=function(){function e(){this.rows=0,this.columns=0,this._data=[]}return e.FromArray=function(e){for(var t=e[0].length,r=e.length,s=this.Zero(r,t),i=0;i<r;i++)for(var a=0;a<t;a++)s._data[i][a]=e[i][a]||0;return s},e.Zero=function(t,r){return void 0===r&&(r=t),(new e).Reset(t,r)},e.Identity=function(e){for(var t=this.Zero(e),r=0;r<e;r++)t._data[r][r]=1;return t},e.Clone=function(e){for(var t=this.Zero(e.rows,e.columns),r=0;r<e.rows;r++)t._data[r]=new Float64Array(e._data[r]);return t},e.prototype.Reset=function(e,t){void 0===t&&(t=e),this._data=new Array(e);for(var r=0;r<e;r++)this._data[r]=new Float64Array(t);return this.rows=e,this.columns=t,this},e.prototype.CopyTo=function(e){e.rows=this.rows,e.columns=this.columns,e._data=[];for(var t=0;t<this.rows;t++)e._data[t]=new Float64Array(this._data[t]);return e},e.prototype.Row=function(e,t){return void 0!==t&&(this._data[e]=new Float64Array(t)),Array.from(this._data[e])},e.prototype.Column=function(e,t){if(void 0!==t)for(var r=0;r<this.rows;r++)this._data[r][e]=arguments[1][r];var s=new Array(this.rows);for(r=0;r<this.rows;r++)s[r]=this._data[r][e];return s},e.prototype.Transpose=function(){for(var t=e.Zero(this.columns,this.rows),r=0;r<this.rows;r++)for(var s=0;s<this.columns;s++)t._data[s][r]=this._data[r][s];return t},e.prototype.ToArray=function(e){void 0===e&&(e=!1);var t=[];if(e)for(var r=0;r<this.columns;r++)t.push(this.Column(r));else for(var s=0;s<this.rows;s++)t.push(this.Row(s));return t},e.prototype.EigenSystem=function(){return new l(this._data)},e.prototype.IsPosDef=function(){return new l(this._data).realvalues.every((function(e){return e>0}))},e.prototype.MakePosDef=function(t){void 0===t&&(t=u);var r,s,i=new l(this._data),a=i.realvalues.length,n=e.Zero(a),o=e.Zero(a),h=0,c=e.Zero(a);for(i.vectors.forEach((function(e,t){return c.Row(t,e)})),r=0;r<a;r++){for(s=0;s<a;s++)n._data[r][s]=t;i.realvalues[r]>t&&(n._data[r][r]=i.realvalues[r])}for(r=0;r<a;r++){for(h=0,s=0;s<a;s++)o._data[r][s]=0,h+=i.vectors[r][s]*i.vectors[r][s]*n._data[s][s];o._data[r][r]=Math.sqrt(1/h)}for(r=0;r<a;r++)n._data[r][r]=Math.sqrt(n._data[r][r]);for(var d=o.Multiply(c.Multiply(n)),m=d.Multiply(d.Transpose()).Symmetrize(),f=0;f<m.rows;f++)m._data[f][f]=1;return m},e.prototype.Symmetrize=function(t){void 0===t&&(t=!1);var r,s,i=this.Transpose(),a=e.Clone(this);if(t)for(r=1;r<this.rows;r++)for(s=0;s<r;s++)a._data[r][s]=i._data[r][s];else for(s=1;s<this.columns;s++)for(r=0;r<s;r++)a._data[r][s]=i._data[r][s];return a},e.prototype.Cholesky=function(t){if(void 0===t&&(t=!1),this.rows!==this.columns)throw new Error("matrix not square");var r,s,i,a,n,o=this.rows,l=e.Zero(o);for(a=0;a<o;a++){for(s=0,n=0;n<a;n++){for(r=0,i=0;i<n;i++)r+=l._data[i][n]*l._data[i][a];if(l._data[n][a]=r=(this._data[n][a]-r)/l._data[n][n],s+=r*r,this._data[n][a]!=this._data[a][n])throw new Error("matrix not symmetrical")}if((s=this._data[a][a]-s)<=0)throw new Error("matrix not pos-def");for(l._data[a][a]=s>0?Math.sqrt(s):0,n=a+1;n<o;n++)l._data[n][a]=0}return t?l.Transpose():l},e.prototype.Multiply=function(t){var r,s,i,a,n=e.Zero(this.rows,t.columns);for(r=0;r<this.rows;r++)for(s=0;s<t.columns;s++){for(a=i=0;i<this.columns;i++)a+=this._data[r][i]*t._data[i][s];n._data[r][s]=a}return n},e.prototype.Inverse=function(){if(this.rows!==this.columns)throw new Error("invalid matrix");var t,r,s,i,a=e.Clone(this),n=a.rows;for(r=1;r<n;r++)a._data[0][r]/=a._data[0][0];for(r=1;r<n;r++){for(s=r;s<n;s++){for(t=0,i=0;i<r;i++)t+=a._data[s][i]*a._data[i][r];a._data[s][r]-=t}if(r!=n-1)for(s=r+1;s<n;s++){for(t=0,i=0;i<r;i++)t+=a._data[r][i]*a._data[i][s];a._data[r][s]=(a._data[r][s]-t)/a._data[r][r]}}for(r=0;r<n;r++)for(s=r;s<n;s++){var o=1;if(r!=s)for(o=0,i=r;i<s;i++)o-=a._data[s][i]*a._data[i][r];a._data[s][r]=o/a._data[s][s]}for(r=0;r<n;r++)for(s=r;s<n;s++)if(r!=s){for(t=0,i=r;i<s;i++)t+=a._data[i][s]*(r==i?1:a._data[r][i]);a._data[r][s]=-t}for(r=0;r<n;r++)for(s=0;s<n;s++){for(t=0,i=r>s?r:s;i<n;i++)t+=(s==i?1:a._data[s][i])*a._data[i][r];a._data[s][r]=t}return a},e.prototype.SortColumns=function(t){void 0===t&&(t=!1);for(var r=e.Clone(this),s=t?function(e,t){return t-e}:function(e,t){return e-t},i=0;i<this.columns;i++)r.Column(i,this.Column(i).sort(s));return r},e.prototype.Rank=function(t){void 0===t&&(t=!1);for(var s,i=e.Clone(this),a=new Array(this.rows),n=new Array(this.rows),o=0;o<this.columns;o++){for(s=0;s<this.rows;s++)n[s]=s,a[s]=this._data[s][o];for(r.Sort(a,n),t&&n.reverse(),s=0;s<this.rows;s++)i._data[n[s]][o]=s}return i},e.prototype.Correl=function(){for(var t=new Array(this.columns),r=0;r<this.columns;r++)t[r]=this.Column(r);for(var s=e.Zero(this.columns),i=0;i<this.columns;i++){s._data[i][i]=1;for(var n=0;n<i;n++)s._data[i][n]=a.Correlation(t[i],t[n])}return s.Symmetrize()},e.prototype.IsSymmetric=function(){if(this.rows!=this.columns)return!1;for(var e=0;e<this.rows;e++)for(var t=0;t<this.columns;t++)if(this._data[e][t]!==this._data[t][e])return!1;return!0},e}();Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length,r=0;r<t;r++){if(arguments[r]===1/0||arguments[r]===-1/0)return 1/0;e+=arguments[r]*arguments[r]}return Math.sqrt(e)});for(var c=function(){function e(){}return e.Normal=function(e,t){var r=this;void 0===t&&(t={});var i=s({mean:0,sd:1,lhs:!1,ordered:!1},t);return(i.lhs?this.LHSField(e,i.ordered):this.UniformField(e,i.ordered)).map((function(e){return r.InverseNormal2(e)*i.sd+i.mean}))},e.ReverseInverseNormal2=function(e,t){var r=this;void 0===t&&(t=40);for(var s=[0,Math.min(1,Math.max(0,.5+.125*e)),1],i=s.map((function(e){return r.InverseNormal2(e)})),a=0;a<t;a++){if(Math.abs(i[1]-e)<=1e-6)return s[1];i[1]<e?(s=[s[1],(s[1]+s[2])/2,s[2]],i=[i[1],this.InverseNormal2(s[1]),i[2]]):(s=[s[0],(s[0]+s[1])/2,s[1]],i=[i[0],this.InverseNormal2(s[1]),i[1]])}return s[1]},e.TruncatedNormal=function(e,t){var r=this;void 0===t&&(t={});var i=s({mean:0,sd:1,lhs:!1,ordered:!1},t),a=i.lhs?this.LHSField(e,i.ordered):this.UniformField(e,i.ordered),n=0,o=1;"number"==typeof i.min&&(n=this.ReverseInverseNormal2((i.min-i.mean)/i.sd,i.max_iterations)),"number"==typeof i.max&&(o=this.ReverseInverseNormal2((i.max-i.mean)/i.sd,i.max_iterations));var l=o-n;return(a=a.map((function(e){return e*l+n}))).map((function(e){return r.InverseNormal2(e)*i.sd+i.mean}))},e.LogNormal=function(e,t){void 0===t&&(t={});for(var r=s({mean:1,sd:1,lhs:!1,ordered:!1},t),i=r.lhs?this.LHSFieldDouble(e,r.ordered):this.UniformField(e,r.ordered),a=0;a<i.length;a++)i[a]=Math.exp(this.InverseNormal2(i[a])*r.sd+r.mean);return i},e.LogNormalReturn=function(e,t){void 0===t&&(t={});var r=s({mean:1,sd:1,lhs:!1,ordered:!1},t),i=r.lhs?this.LHSFieldDouble(e,r.ordered):this.UniformField(e,r.ordered);r.mean+=1;for(var a=r.mean*r.mean,n=r.sd*r.sd,o=Math.log(a/Math.sqrt(a+n)),l=Math.sqrt(Math.log((a+n)/a)),u=0;u<e;u++)i[u]=Math.exp(this.InverseNormal2(i[u])*l+o)-1;return i},e.Triangular=function(e,t){var r=this;void 0===t&&(t={});var i=s({a:0,b:1,c:.5,lhs:!1,ordered:!1,field:null},t);return(i.field||(i.lhs?this.LHSField(e,i.ordered):this.UniformField(e,i.ordered))).map((function(e){return r.InverseTriangular(e,i.a,i.b,i.c)}))},e.PERT=function(e,t){void 0===t&&(t={});var r=s({field:null,lhs:!1,a:0,b:1,c:.5,lambda:4,ordered:!1},t),i=r.field||(r.lhs?this.LHSField(e,r.ordered):this.UniformField(e,r.ordered));return this.InversePERTField(i,r.a,r.b,r.c,r.lambda)},e.Uniform=function(e,t){void 0===t&&(t={});for(var r=s({lhs:!1,min:0,max:1,ordered:!1},t),i=r.lhs?this.LHSFieldDouble(e,r.ordered):this.UniformField(e,r.ordered),a=r.max-r.min,n=0;n<i.length;n++)i[n]=i[n]*a+r.min;return i},e.Bernoulli=function(e,t){void 0===t&&(t={});var r=s({lhs:!1,p:.5},t);return this.Uniform(e,{lhs:r.lhs,min:0,max:1}).map((function(e){return e<=r.p}))},e.Beta=function(e,t){var r=this;void 0===t&&(t={});var i=s({lhs:!1,a:0,b:1,ordered:!1},t);return(i.lhs?this.LHSField(e,i.ordered):this.UniformField(e,i.ordered)).map((function(e){return r.InverseBeta(e,i.a,i.b)}))},e.Discretize=function(e,t){var r=e.slice(0);t=t||Math.round;for(var s=0;s<r.length;s++)r[s]=t(r[s]);return r},e.Constant=function(e,t){for(var r=new Array(e),s=0;s<e;s++)r[s]=t;return r},e.Fixed=function(e,t){void 0===t&&(t={}),t=s({value:0},t);for(var r=new Array(e),i=0;i<e;i++)r[i]=t.value;return r},e.Conditional=function(e,t,r,s,i,a){void 0===i&&(i=0);for(var n=a||this.Bernoulli(e,{lhs:!0,p:t}),o=r(Math.ceil(e*t),s),l=new Array(e),u=0,h=0;u<e;u++)l[u]=n[u]?o[h++]:i;return l},e.Correlate=function(e,t,r){void 0===r&&(r=!1);var s,i=t.length,a=t[0].length,n=h.Zero(a,i);for(s=0;s<i;s++)n.Column(s,this.VDWField(a));var o=n.Multiply(e.Cholesky(!0).Multiply(n.Correl().Cholesky(!0).Inverse()).Transpose()).Rank();return r?t.map((function(e,t){var r=new Array(e.length),i=o.Column(t);for(s=0;s<i.length;s++)r[s]=e[i[s]];return r})):t.map((function(e,t){var r=e.slice(0).sort((function(e,t){return e-t})),i=new Array(e.length),a=o.Column(t);for(s=0;s<a.length;s++)i[s]=r[a[s]];return i}))},e.CorrelateCDM=function(e,t,r){void 0===r&&(r=!1);var s,i=t.length,a=t[0].length,o=n.Zero(a,i);for(s=0;s<i;s++)o.SetColumn(s,this.VDWField(a));var l=new n;if(l.rows=a,l.columns=i,l.data=t.map((function(e){return new Float64Array(e)})),!r)throw new Error("E_NOTIMPL: correlateCDM !ordered");return o.Multiply(e.Cholesky(!0).Multiply(o.Correl().Cholesky(!0).Inverse()).Transpose()).Rank2(!1,l).data},e.P80Pert=function(e,t,r,s){var i=this.PERTParameters(e,t,r,s),a=(i.max-i.min)/(this.InverseBeta(.9,i.v,i.w)-this.InverseBeta(.1,i.v,i.w)),n=i.min-this.InverseBeta(.1,i.v,i.w)*a,o=i.max+(1-this.InverseBeta(.9,i.v,i.w))*a;return{a:n/i.scale,b:o/i.scale,c:r}},e.P80Triangular=function(e,t,r){var s,i=(r-e)/(t-e),a=i<.5;a&&(i=1-i);var n=2.1266864*i-.1596122-2.1742909*i*i+1.1087738*i*i*i;a&&(n=1-n);var o=(t-e)/(.6890868-.4434898*i+.35757*i*i);return{a:s=r-n*o,b:s+o,c:r}},e.BetaDensity=function(e,t,r){if("number"!=typeof e){for(var s=new Array(e.length),i=0;i<e.length;i++)e[i]<=0||e[i]>=1?s[i]=0:s[i]=Math.exp((t-1)*Math.log(e[i])+(r-1)*Math.log(1-e[i])-this.LnGamma(t)-this.LnGamma(r)+this.LnGamma(t+r));return s}return e<=0||e>=1?0:Math.exp((t-1)*Math.log(e)+(r-1)*Math.log(1-e)-this.LnGamma(t)-this.LnGamma(r)+this.LnGamma(t+r))},e.PERTDensity=function(e,t,r,s,i){void 0===i&&(i=4);var a,n,o=(t+r+i*s)/(i+2);return n=(a=s===o?i/2+1:(o-t)*(2*s-t-r)/((s-o)*(r-t)))*(r-o)/(o-t),this.BetaDensity(e,a,n)},e.NormalDensity=function(e){if("number"!=typeof e){for(var t=new Array(e.length),r=0;r<e.length;r++)t[r]=.398942280401433*Math.exp(-e[r]*e[r]/2);return t}return.398942280401433*Math.exp(-e*e/2)},e.Shuffle=function(e){var r,s,i;for(s=e.length-1;s>=0;s--)r=Math.floor(t.Next()*(s+1)),i=e[s],e[s]=e[r],e[r]=i;return e},e.VDWField=function(e){if(this.vdw_cache.length!==e){this.vdw_cache=new Float64Array(e);for(var t=0;t<e;t++)this.vdw_cache[t]=this.InverseNormal2((t+1)/(e+1))}var r=new Float64Array(this.vdw_cache);return this.Shuffle(r)},e.LHSFieldDouble=function(e,r){void 0===r&&(r=!1);for(var s=1/e,i=new Float64Array(e),a=0;a<e;a++)i[a]=t.Next()*s+a*s;return r||this.Shuffle(i),i},e.LHSField=function(e,r){void 0===r&&(r=!1);for(var s=1/e,i=new Array(e),a=0;a<e;a++)i[a]=t.Next()*s+a*s;return r||this.Shuffle(i),i},e.UniformField=function(e,r){void 0===r&&(r=!1);for(var s=new Array(e),i=0;i<e;i++)s[i]=t.Next();return r&&s.sort((function(e,t){return e-t})),s},e.InverseTriangular=function(e,t,r,s){return t===r?t:e<=(s-t)/(r-t)?t+Math.sqrt((r-t)*(s-t)*e):r-Math.sqrt((r-t)*(r-s)*(1-e))},e.InverseNormal=function(e){return.5===e?0:(t=e<1&&e>.5?1-e:e,s=(r=Math.sqrt(Math.log(1/Math.pow(t,2))))-(2.515517+.802853*r+.010328*Math.pow(r,2))/(1+1.432788*r+.189269*Math.pow(r,2)+.001308*Math.pow(r,3)),e>.5?s:-s);var t,r,s},e.InverseNormal2=function(e){var t,r,s=e-.5;return Math.abs(s)<=.425?s*(((((((2509.0809287301227*(r=.180625-s*s)+33430.57558358813)*r+67265.7709270087)*r+45921.95393154987)*r+13731.69376550946)*r+1971.5909503065513)*r+133.14166789178438)*r+3.3871328727963665)/(((((((5226.495278852854*r+28729.085735721943)*r+39307.89580009271)*r+21213.794301586597)*r+5394.196021424751)*r+687.1870074920579)*r+42.31333070160091)*r+1):(r=s<0?e:1-e)<=0?0:(t=(r=Math.sqrt(-Math.log(r)))<=5?(((((((.0007745450142783414*(r-=1.6)+.022723844989269184)*r+.2417807251774506)*r+1.2704582524523684)*r+3.6478483247632045)*r+5.769497221460691)*r+4.630337846156546)*r+1.4234371107496835)/(((((((1.0507500716444169e-9*r+.0005475938084995345)*r+.015198666563616457)*r+.14810397642748008)*r+.6897673349851)*r+1.6763848301838038)*r+2.053191626637759)*r+1):(((((((2.0103343992922881e-7*(r-=5)+27115555687434876e-21)*r+.0012426609473880784)*r+.026532189526576124)*r+.29656057182850487)*r+1.7848265399172913)*r+5.463784911164114)*r+6.657904643501103)/(((((((20442631033899397e-31*r+1.421511758316446e-7)*r+18463183175100548e-21)*r+.0007868691311456133)*r+.014875361290850615)*r+.1369298809227358)*r+.599832206555888)*r+1),s<0?-t:t)},e.Log1p=function(e){var t=1+e;return Math.log(t)-(t-1-e)/t},e.BetaContFrac=function(t,r,s,i){var a,n=2*Number.MIN_VALUE,o=0,l=1,u=1-(t+r)*s/(t+1);for(Math.abs(u)<n&&(u=e.QUIET_NAN),a=u=1/u;o<512;){var h,c=o+1,d=c*(r-c)*s/((t-1+2*c)*(t+2*c));if(u=1+d*u,l=1+d/l,Math.abs(u)<n&&(u=e.QUIET_NAN),Math.abs(l)<n&&(l=e.QUIET_NAN),a*=(u=1/u)*l,u=1+(d=-(t+c)*(t+r+c)*s/((t+2*c)*(t+2*c+1)))*u,l=1+d/l,Math.abs(u)<n&&(u=e.QUIET_NAN),Math.abs(l)<n&&(l=e.QUIET_NAN),a*=h=(u=1/u)*l,Math.abs(h-1)<2*e.EPSILON_DOUBLE)break;if(a*Math.abs(h-1)<i)break;++o}return o>=512?e.QUIET_NAN:a},e.BetaCDF=function(t,r,s){if(t<=0)return 0;if(t>=1)return 1;if(0===t)return 0;if(1===t)return 1;var i,a=-(this.LnGamma(r)+this.LnGamma(s)-this.LnGamma(r+s))+r*Math.log(t)+s*this.Log1p(-t),n=Math.exp(a);return t<(r+1)/(r+s+2)?(i=Math.abs(0/(1*n/r))*e.EPSILON_DOUBLE,n*this.BetaContFrac(r,s,t,i)/r*1+0):(i=Math.abs(1/(1*n/s))*e.EPSILON_DOUBLE,1*(1-n*this.BetaContFrac(s,r,1-t,i)/s)+0)},e.LnGamma=function(e){var t=e-1,r=t+5.5;r-=(t+.5)*Math.log(r);var s=1;return s+=76.18009173/(t+=1),s+=-86.50532033/(t+=1),s+=24.01409822/(t+=1),s+=-1.231739516/(t+=1),s+=.00120858003/(t+=1),s+=-536382e-11/(t+=1),-r+Math.log(2.50662827465*s)},e.BetaPDF=function(e,t,r){return e<0||e>1?0:Math.exp(this.LnGamma(t+r)-this.LnGamma(t)-this.LnGamma(r))*Math.pow(e,t-1)*Math.pow(1-e,r-1)},e.InverseBeta=function(e,t,r){var s,i,a,n,o,l,u,h,c=0;if(e<0||e>1||t<0||r<0)return 0;if(0===e)return 0;if(1===e)return 1;if(e>.5){var d=1-e;return d>.5?this.InverseBeta(1-d,t,r):1-this.InverseBeta(d,r,t)}if(i=t/(t+r),e<.1){var m=(Math.log(t)+this.LnGamma(t)+this.LnGamma(r)-this.LnGamma(t+r)+Math.log(e))/t;m<=0?(s=Math.exp(m),s*=Math.pow(1-s,-(r-1)/t)):s=i,s>i&&(s=i)}else s=i;do{if(n=e-this.BetaCDF(s,t,r),o=this.BetaPDF(s,t,r),0===n||c++>64)return s;h=-((t-1)/s-(r-1)/(1-s))*(a=n/Math.max(2*Math.abs(n/s),o))*a/2,l=u=a,Math.abs(h)<Math.abs(u)?l+=h:l*=2*Math.abs(u/h),s+l>0&&s+l<1?s+=l:s=Math.sqrt(s)*Math.sqrt(i)}while(Math.abs(u)>1e-10*s);return s},e.InversePERTField=function(e,t,r,s,i){var a=this;if(r<=t)return e.map((function(){return t}));try{var n=this.PERTParameters(t,r,s,i);return e.map((function(e){return(a.InverseBeta(e,n.v,n.w)*(n.max-n.min)+n.min)/n.scale}))}catch(s){return t===r?e.map((function(e){return t})):e.map((function(e){return 0}))}},e.PERTParameters=function(e,t,r,s){if(void 0===s&&(s=4),e>=t||s<0||r<e||r>t)throw new Error("Invalid parameters");for(var i,a,n=1;Math.abs(e)<1&&Math.abs(t)<1;)n*=10,e*=10,t*=10,r*=10;return i=(e+t+s*r)/(s+2),{v:a=(0===r?Math.abs(i-r):Math.abs((i-r)/r))<=1e-12?s/2+1:(i-e)*(2*r-e-t)/((r-i)*(t-e)),w:a*(t-i)/(i-e),min:e,max:t,scale:n}},e.InversePERT=function(e,t,r,s,i){void 0===i&&(i=4);var a=this.PERTParameters(t,r,s,i);return(this.InverseBeta(e,a.v,a.w)*(a.max-a.min)+a.min)/a.scale},e.EPSILON_DOUBLE=2220446049250313e-31,e.QUIET_NAN=Number.NaN,e.M_LN_SQRT_2PI=.9189385332046728,e.M_1_SQRT_2PI=.3989422804014327,e.vdw_cache=new Float64Array(0),e}(),d=new Array(256),m=0;m<256;++m)d[m]=(m+256).toString(16).substr(1);var f=function(){function e(){this.buffer=[],this.buffer=[];for(var e=0;e<16;e++)this.buffer[e]=Math.floor(256*t.Next())}return e.prototype.toString=function(){var e=0;return d[this.buffer[e++]]+d[this.buffer[e++]]+d[this.buffer[e++]]+d[this.buffer[e++]]+"-"+d[this.buffer[e++]]+d[this.buffer[e++]]+"-"+d[this.buffer[e++]]+d[this.buffer[e++]]+"-"+d[this.buffer[e++]]+d[this.buffer[e++]]+"-"+d[this.buffer[e++]]+d[this.buffer[e++]]+d[this.buffer[e++]]+d[this.buffer[e++]]+d[this.buffer[e++]]+d[this.buffer[e++]]},e}();e.CDMatrix=n,e.Eigensystem=l,e.MC=c,e.Matrix=h,e.QSort=i,e.QSort2=r,e.Random=t,e.Stats=a,e.UUID=f,e.Util=o,Object.defineProperty(e,"__esModule",{value:!0})}(t)}},t={};function r(s){var i=t[s];if(void 0!==i)return i.exports;var a=t[s]={exports:{}};return e[s].call(a.exports,a,a.exports,r),a.exports}(()=>{"use strict";class e{constructor(e,t=e,r=!1){this.end_=this.PatchNull(t),this.start_=this.PatchNull(e),r&&this.Normalize()}static FromColumn(t){return new e({row:1/0,column:t})}static FromRow(t){return new e({row:t,column:1/0})}static ColumnToLabel(e){let t=String.fromCharCode(65+e%26);for(;e>25;)e=Math.floor(e/26)-1,t=String.fromCharCode(65+e%26)+t;return t}static CellAddressToLabel(e,t=!1){return(t?`${e.sheet_id||0}!`:"")+(e.absolute_column?"$":"")+this.ColumnToLabel(e.column)+(e.absolute_row?"$":"")+(e.row+1)}static Join(t,...r){const s=new e(t.start,t.end);for(const e of r)e&&(s.ConsumeAddress(e.start),s.ConsumeAddress(e.end));return s}static Bleed(t,r=1){return new e({row:Math.max(0,t.start.row-r),column:Math.max(0,t.start.column-r)},{row:t.end.row+r,column:t.end.column+r})}get start(){return Object.assign({},this.start_)}set start(e){this.start_=e}get end(){return Object.assign({},this.end_)}set end(e){this.end_=e}get rows(){return this.start_.row===1/0||this.end_.row===1/0?1/0:this.end_.row-this.start_.row+1}get columns(){return this.start_.column===1/0||this.end_.column===1/0?1/0:this.end_.column-this.start_.column+1}get count(){return this.rows*this.columns}get entire_sheet(){return this.entire_row&&this.entire_column}get entire_column(){return this.start_.row===1/0}get entire_row(){return this.start_.column===1/0}PatchNull(e){const t=Object.assign({},e);return null===t.row&&(t.row=1/0),null===t.column&&(t.column=1/0),t}SetSheetID(e){this.start_.sheet_id=e}Normalize(){const e=Object.assign({},this.start_),t=Object.assign({},this.end_);e.row===1/0||t.row===1/0?e.row=t.row=1/0:e.row>t.row&&(e.row=this.end_.row,e.absolute_row=this.end_.absolute_row,t.row=this.start_.row,t.absolute_row=this.start_.absolute_row),e.column===1/0||t.column===1/0?e.column=t.column=1/0:e.column>t.column&&(e.column=this.end_.column,e.absolute_column=this.end_.absolute_column,t.column=this.start_.column,t.absolute_column=this.start_.absolute_column),this.start_=e,this.end_=t}TopLeft(){const e={row:0,column:0};return this.entire_row||(e.column=this.start.column),this.entire_column||(e.row=this.start.row),e}BottomRight(){const e={row:0,column:0};return this.entire_row||(e.column=this.end.column),this.entire_column||(e.row=this.end.row),e}ContainsRow(e){return this.entire_column||e>=this.start_.row&&e<=this.end_.row}ContainsColumn(e){return this.entire_row||e>=this.start_.column&&e<=this.end_.column}Contains(e){return(this.entire_column||e.row>=this.start_.row&&e.row<=this.end_.row)&&(this.entire_row||e.column>=this.start_.column&&e.column<=this.end_.column)}ContainsArea(e){return this.start.column<=e.start.column&&this.end.column>=e.end.column&&this.start.row<=e.start.row&&this.end.row>=e.end.row}Intersects(e){return!(e.start.column>this.end.column||this.start.column>e.end.column||e.start.row>this.end.row||this.start.row>e.end.row)}Equals(e){return e.start_.row===this.start_.row&&e.start_.column===this.start_.column&&e.end_.row===this.end_.row&&e.end_.column===this.end_.column}Clone(){return new e(this.start,this.end)}Array(){if(this.entire_column||this.entire_row)throw new Error("can't convert infinite area to array");const e=new Array(this.rows*this.columns),t=this.start_.sheet_id;let r=0;for(let s=this.start_.row;s<=this.end_.row;s++)for(let i=this.start_.column;i<=this.end_.column;i++)e[r++]={row:s,column:i,sheet_id:t};return e}get left(){const t=new e(this.start_,this.end_);return t.end_.column=t.start_.column,t}get right(){const t=new e(this.start_,this.end_);return t.start_.column=t.end_.column,t}get top(){const t=new e(this.start_,this.end_);return t.end_.row=t.start_.row,t}get bottom(){const t=new e(this.start_,this.end_);return t.start_.row=t.end_.row,t}Shift(e,t){return this.start_.row+=e,this.start_.column+=t,this.end_.row+=e,this.end_.column+=t,this}ConsumeAddress(e){this.entire_row||(e.column<this.start_.column&&(this.start_.column=e.column),e.column>this.end_.column&&(this.end_.column=e.column)),this.entire_column||(e.row<this.start_.row&&(this.start_.row=e.row),e.row>this.end_.row&&(this.end_.row=e.row))}ConsumeArea(e){this.ConsumeAddress(e.start),this.ConsumeAddress(e.end)}Resize(e,t){return this.end_.row=this.start_.row+e-1,this.end_.column=this.start_.column+t-1,this}Iterate(e){if(this.entire_column||this.entire_row)console.warn("don't iterate infinite area");else for(let t=this.start_.column;t<=this.end_.column;t++)for(let r=this.start_.row;r<=this.end_.row;r++)e({column:t,row:r,sheet_id:this.start_.sheet_id})}get spreadsheet_label(){let t;return this.entire_sheet?"":this.entire_column?(t=e.ColumnToLabel(this.start_.column),t+=":"+e.ColumnToLabel(this.end_.column),t):this.entire_row?(t=String(this.start_.row+1),t+=":"+(this.end_.row+1),t):(t=e.CellAddressToLabel(this.start_),this.columns>1||this.rows>1?t+":"+e.CellAddressToLabel(this.end_):t)}toJSON(){return{start:Object.assign({},this.start_),end:Object.assign({},this.end_)}}}const t=e=>"object"==typeof e&&!!e&&"number"==typeof e.real&&"number"==typeof e.imaginary;var s;!function(e){e[e[void 0]=0]="undefined",e[e.formula=1]="formula",e[e.string=2]="string",e[e.number=3]="number",e[e.boolean=4]="boolean",e[e.object=5]="object",e[e.error=6]="error",e[e.complex=7]="complex"}(s||(s={}));const i=e=>{switch(typeof e){case"undefined":return s.undefined;case"number":return s.number;case"boolean":return s.boolean;case"object":return null===e?s.undefined:t(e)?s.complex:s.object;case"string":return"="===e[0]?s.formula:s.string;default:return s.error}};var a;!function(e){e[e.List=0]="List",e[e.Date=1]="Date",e[e.Range=2]="Range",e[e.Number=3]="Number",e[e.Boolean=4]="Boolean"}(a||(a={}));class n{constructor(e,t){this.type=s.undefined,this.render_dirty=!0,void 0!==e&&this.Set(e,t)}static StringToColumn(e){let t=0;e=e.toUpperCase();for(let r=0;r<e.length;r++)t*=26,t+=e.charCodeAt(r)-64;return t-1}ValueIsNumber(){return this.type===s.number}ValueIsFormula(){return this.type===s.formula}ValueIsBoolean(){return this.type===s.boolean}ValueIsComplex(){return this.type===s.complex}FlushStyle(){this.formatted=this.rendered_type=this.style=void 0,this.render_dirty=!0}FlushArray(){this.area=void 0}FlushCache(){this.calculated=this.calculated_type=this.formatted=this.rendered_type=this.render_function=this.click_function=void 0,this.render_dirty=!0}Reset(){this.type=s.undefined,this.value=this.note=this.hyperlink=this.formatted=this.rendered_type=this.style=this.calculated=this.calculated_type=this.area=this.renderer_data=this.render_function=this.click_function=void 0,this.render_dirty=!0}Set(e,t=i(e)){this.value=e,this.type=t,this.formatted=this.rendered_type=this.style=this.calculated=this.calculated_type=this.render_function=this.click_function=this.area=void 0,this.render_dirty=!0}SetCalculatedValue(e,t=i(e)){this.calculated!==e&&(this.calculated=e,this.calculated_type=t,this.formatted=this.rendered_type=void 0,this.render_dirty=!0)}SetCalculatedValueOrError(e,t){void 0===t&&("object"==typeof e&&e.error?(t=s.error,e=e.error):t=i(e)),this.calculated!==e&&(this.calculated=e,this.calculated_type=t,this.formatted=this.rendered_type=void 0,this.render_dirty=!0)}GetValue(){return this.calculated_type?this.calculated:"string"==typeof this.value&&"'"===this.value[0]?this.value.slice(1):this.value}GetValue4(){return this.calculated_type?{type:this.calculated_type,value:this.calculated}:this.type===s.formula?{type:s.number,value:0}:{type:this.type,value:"string"==typeof this.value&&"'"===this.value[0]?this.value.slice(1):this.value}}SetNote(e){this.note=e,this.render_dirty=!0}SetCalculationError(e="ERR"){this.SetCalculatedValue(e,s.error)}SetArray(e){this.type=s.undefined,this.value=this.formatted=this.rendered_type=this.style=this.hyperlink=this.calculated=this.calculated_type=void 0,this.area=e,this.render_dirty=!0}SetArrayHead(e,t){this.type=i(t),this.value=t,this.formatted=this.rendered_type=this.style=this.calculated=this.calculated_type=void 0,this.area=e,this.render_dirty=!0}}function o(e,t){var r={};for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&t.indexOf(s)<0&&(r[s]=e[s]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(s=Object.getOwnPropertySymbols(e);i<s.length;i++)t.indexOf(s[i])<0&&Object.prototype.propertyIsEnumerable.call(e,s[i])&&(r[s[i]]=e[s[i]])}return r}Object.create,Object.create;const l=e=>e.type===s.formula,u=()=>({type:s.undefined,value:void 0}),h=(e,t)=>(void 0===t&&(t=i(e)),{value:e,type:t}),c=e=>e.imaginary?{type:s.complex,value:e}:{type:s.number,value:e.real},d=e=>!!e[0]&&(e=>!e.cells)(e[0]),m=e=>!!e[0]&&void 0!==e[0].row;class f{constructor(){this.data=[],this.rows_=0,this.columns_=0}get rows(){return this.rows_}get columns(){return this.columns_}EnsureRow(e){this.rows_=Math.max(e+1,this.rows_)}EnsureColumn(e){this.columns_=Math.max(e+1,this.columns_)}InsertColumns(e=0,t=1){this.data=this.data.map((r=>{if(r.length>=e){const s=r.slice(0,e);let i=e+t;return r.slice(e).forEach((e=>s[i++]=e)),s}return r})),this.columns_+=t}DeleteColumns(e,t=1){this.data.forEach((r=>r.splice(e,t))),this.columns_-=t}DeleteRows(e,t=1){this.data.splice(e,t),this.rows_-=t}InsertRows(e=0,t=1){const r=[e,0,[]];for(let e=1;e<t;e++)r.push([]);Array.prototype.splice.apply(this.data,r),this.rows_+=t}GetCell(e,t){const{row:r,column:s}=e;if(!this.data[r]){if(!t)return;this.data[r]=[],this.rows_=Math.max(this.rows_,r+1)}return this.data[r][s]||t&&(this.data[r][s]=new n,this.columns_=Math.max(this.columns_,s+1)),this.data[r][s]}EnsureCell(e){const{row:t,column:r}=e;let s=this.data[t];s||(this.data[t]=s=[],this.rows_=Math.max(this.rows_,t+1));let i=s[r];return i||(i=s[r]=new n,this.columns_=Math.max(this.columns_,r+1)),i}FromArray(e=[],t=!1){this.data=[];let r=0,s=0;if(t){s=e.length;for(let t=0;t<s;t++){const s=e[t];r=Math.max(r,s.length);for(let e=0;e<s.length;e++)this.data[e]||(this.data[e]=[]),this.data[e][t]=new n(s[e])}}else{r=e.length;for(let t=0;t<r;t++){const r=[],i=e[t];s=Math.max(s,i.length);for(let e=0;e<i.length;e++)r[e]=new n(i[e]);this.data[t]=r}}this.rows_=r,this.columns_=s}FromJSON(t=[],r){if(this.data=[],!d(t)){const e=[];if(m(t))for(const r of t)for(const t of r.cells)e.push(Object.assign(Object.assign({},t),{row:r.row}));else for(const r of t)for(const t of r.cells)e.push(Object.assign(Object.assign({},t),{column:r.column}));t=e}for(const s of t){this.data[s.row]||(this.data[s.row]=[]);const t=new n(s.value);if(void 0!==s.calculated&&t.SetCalculatedValue(s.calculated,s.calculated_type),r&&void 0!==s.style_ref&&(t.style=r[s.style_ref]),void 0!==s.note&&(t.note=s.note),void 0!==s.hyperlink&&(t.hyperlink=s.hyperlink),this.data[s.row][s.column]&&this.data[s.row][s.column].area&&(t.area=this.data[s.row][s.column].area),this.data[s.row][s.column]=t,s.area){const t=new e(s.area.start,s.area.end);for(let e=t.start.row;e<=t.end.row;e++)for(let r=t.start.column;r<=t.end.column;r++)this.data[e]||(this.data[e]=[]),this.data[e][r]||(this.data[e][r]=new n),this.data[e][r].area=t}if(s.merge_area){const t=new e(s.merge_area.start,s.merge_area.end);for(let e=t.start.row;e<=t.end.row;e++)for(let r=t.start.column;r<=t.end.column;r++)this.data[e]||(this.data[e]=[]),this.data[e][r]||(this.data[e][r]=new n),this.data[e][r].merge_area=t}s.validation&&(t.validation=s.validation)}this.rows_=this.data.length,this.columns_=this.data.reduce(((e,t)=>Math.max(e,t.length)),0)}toJSON(e={}){let t,r=0,i=0,a=this.data.length-1;e.subset&&(r=e.subset.start.column,i=e.subset.start.row,a=e.subset.end.row);const n=[];let l=-1,u=-1;const h={},c={};for(let o=i;o<=a;o++)if(this.data[o]){const i=this.data[o];t=i.length-1,e.subset&&(t=e.subset.end.column);for(let a=r;a<=t;a++){const t=i[a],r=t&&t.merge_area&&t.merge_area.start.row===o&&t.merge_area.start.column===a,d=t&&t.area&&t.area.start.row===o&&t.area.start.column===a,m=!t||t.type===s.string&&!t.value;if(t&&(!m||e.preserve_empty_strings)&&(r||t.type||t.calculated_type&&e.expand_arrays||t.calculated_type&&e.calculated_value||t.validation||e.decorated_cells&&t.style&&(t.style.fill||t.style.border_bottom||t.style.border_top||t.style.border_left||t.style.border_right))){const r={row:o,column:a,value:t.value};t.note&&(r.note=t.note),t.hyperlink&&(r.hyperlink=t.hyperlink),e.preserve_type&&(r.type=t.type),e.sheet_id&&(r.sheet_id=e.sheet_id),e.calculated_value&&void 0!==t.calculated&&(r.calculated=t.calculated,(e.preserve_type||t.calculated_type===s.error)&&(r.calculated_type=t.calculated_type)),t.area&&d&&(r.area=t.area.toJSON()),t.merge_area&&(r.merge_area=t.merge_area.toJSON()),t.validation&&(r.validation=t.validation),e.cell_style_refs&&e.cell_style_refs[a]&&e.cell_style_refs[a][o]&&(r.style_ref=e.cell_style_refs[a][o],e.cell_style_refs[a][o]=0),h[o]=o,c[a]=a,l=Math.max(o,l),u=Math.max(a,u),n.push(r)}}}if(e.nested){const e=Object.keys(h),t=Object.keys(c);if(e.length<=t.length&&e.length){const t={},r=[];for(const e of n){const{row:r}=e,s=o(e,["row"]);t[e.row]||(t[e.row]=[]),t[e.row].push(s)}for(const s of e){const e=Number(s);r.push({row:e,cells:t[e]})}return{data:r,rows:l,columns:u+1}}if(t.length){const e={},r=[];for(const t of n){const{column:r}=t,s=o(t,["column"]);e[t.column]||(e[t.column]=[]),e[t.column].push(s)}for(const s of t){const t=Number(s);r.push({column:t,cells:e[t]})}return{data:r,rows:l,columns:u+1}}}return{data:n,rows:l+1,columns:u+1}}GetAll(e=!1){return this.GetRange({row:0,column:0},{row:this.rows_-1,column:this.columns_-1},e)}Normalize2(e,t){return e.column===1/0&&(e=Object.assign(Object.assign({},e),{column:0})),e.row===1/0&&(e=Object.assign(Object.assign({},e),{row:0})),t.column===1/0&&(t=Object.assign(Object.assign({},t),{column:this.columns_-1})),t.row===1/0&&(t=Object.assign(Object.assign({},t),{row:this.rows_-1})),{from:e,to:t}}Normalize1(e){return e.column===1/0&&(e=Object.assign(Object.assign({},e),{column:0})),e.row===1/0&&(e=Object.assign(Object.assign({},e),{row:0})),e}RawValue(e,t=e){if(({from:e,to:t}=this.Normalize2(e,t)),e.row===t.row&&e.column===t.column)return this.data[e.row]&&this.data[e.row][e.column]?this.data[e.row][e.column].value:void 0;const r=[],s=this.data.slice(e.row,t.row+1),i=e.column,a=t.column+1;for(const e of s){const t=[];for(let r=i,s=0;r<a;r++,s++){const s=e[r];t.push(s?s.value:void 0)}r.push(t)}return r}GetRange(e,t,r=!1){if(t?({from:e,to:t}=this.Normalize2(e,t)):e=this.Normalize1(e),!t||e===t||e.column===t.column&&e.row===t.row)return this.data[e.row]&&this.data[e.row][e.column]?this.data[e.row][e.column].GetValue():void 0;const s=[];if(r)for(let r=e.column;r<=t.column;r++){const i=[];for(let s=e.row;s<=t.row;s++)this.data[s]&&this.data[s][r]?i.push(this.data[s][r].GetValue()):i.push(void 0);s.push(i)}else for(let r=e.row;r<=t.row;r++){const i=[];for(let s=e.column;s<=t.column;s++)this.data[r]&&this.data[r][s]?i.push(this.data[r][s].GetValue()):i.push(void 0);s.push(i)}return s}GetRange4(e,t=e,r=!1){if(({from:e,to:t}=this.Normalize2(e,t)),e.row===t.row&&e.column===t.column)return this.data[e.row]&&this.data[e.row][e.column]?this.data[e.row][e.column].GetValue4():{value:void 0,type:s.undefined};const i=[];if(r)for(let r=e.column;r<=t.column;r++){const s=[];for(let i=e.row;i<=t.row;i++)this.data[i]&&this.data[i][r]?s.push(this.data[i][r].GetValue4()):s.push(u());i.push(s)}else for(let r=e.row;r<=t.row;r++){const s=[];for(let i=e.column;i<=t.column;i++)this.data[r]&&this.data[r][i]?s.push(this.data[r][i].GetValue4()):s.push(u());i.push(s)}return i}Apply(t,r,s=!1){var i;if("object"==typeof(i=t)&&void 0!==i.row&&void 0!==i.column&&(t=new e(t)),t.entire_column||t.entire_row)throw new Error("don't iterate infinite cells");const a=t.start,o=t.end;if(s)for(let e=a.row;e<=o.row;e++){this.data[e]||(this.data[e]=[]);const t=this.data[e];for(let s=a.column;s<=o.column;s++)t[s]||(t[s]=new n),r(t[s],s,e)}else for(let e=a.row;e<=o.row;e++)if(this.data[e]){const t=this.data[e];for(let s=a.column;s<=o.column;s++)t[s]&&r(t[s],s,e)}}SetArea(e,t){if(ArrayBuffer.isView(t))throw new Error("ABIV");if(Array.isArray(t))for(let r=e.start.row,s=0;r<=e.end.row;r++,s++){this.data[r]||(this.data[r]=[]);const i=this.data[r];if(t[s])for(let r=e.start.column,a=0;r<=e.end.column;r++,a++)i[r]||(i[r]=new n),i[r].Set(t[s][a])}else{const r=i(t);for(let s=e.start.row;s<=e.end.row;s++){this.data[s]||(this.data[s]=[]);const i=this.data[s];for(let s=e.start.column;s<=e.end.column;s++)i[s]||(i[s]=new n),i[s].Set(t,r)}}this.rows_=Math.max(this.rows_,e.end.row+1),this.columns_=Math.max(this.columns_,e.end.column+1)}IterateAll(e){for(const t of this.data)if(t)for(const r of t)r&&e(r)}FlushCellStyles(){for(const e of this.data)if(e)for(const t of e)t&&t.FlushStyle()}FlushCachedValues(){for(const e of this.data)if(e)for(const t of e)t&&t.FlushCache()}}class p{static UpdateLocale(e){var t;if(e)this.locale=e;else if("undefined"!=typeof self){const e=null===(t=null===self||void 0===self?void 0:self.document)||void 0===t?void 0:t.location;if(e&&e.search&&/locale=([^?&]+?)(?:\?|$|&)/.test(e.search)){const t=e.search.match(/locale=(.*?)(?:\?|$|&)/);t&&(this.locale=t[1]),console.info("override locale",this.locale)}else"undefined"!=typeof navigator&&(navigator.languages&&navigator.languages[0]?this.locale=navigator.languages[0]:this.locale=navigator.language)}const r=new Intl.NumberFormat(this.locale,{minimumFractionDigits:1}).format(3.3).replace(/\d/g,"");this.decimal_separator=","===r?",":".",","===this.decimal_separator&&(this.argument_separator=";",this.grouping_separator=" ");let s=new Date(2e3,0,2,12,0,0,0);this.UpdateDateComponent(0,0,s),s=new Date(2e3,1,7,12,0,0,0),this.UpdateDateComponent(1,1,s),s=new Date(2e3,2,7,12,0,0,0),this.UpdateDateComponent(2,2,s),s=new Date(2e3,3,5,12,0,0,0),this.UpdateDateComponent(3,3,s),s=new Date(2e3,4,4,12,0,0,0),this.UpdateDateComponent(4,4,s),s=new Date(2e3,5,2,12,0,0,0),this.UpdateDateComponent(5,5,s),s=new Date(2e3,6,1,12,0,0,0),this.UpdateDateComponent(6,6,s),s=new Date(2e3,7,1,12,0,0,0),this.UpdateDateComponent(7,-1,s),s=new Date(2e3,8,1,12,0,0,0),this.UpdateDateComponent(8,-1,s),s=new Date(2e3,9,1,12,0,0,0),this.UpdateDateComponent(9,-1,s),s=new Date(2e3,10,1,12,0,0,0),this.UpdateDateComponent(10,-1,s),s=new Date(2e3,11,1,12,0,0,0),this.UpdateDateComponent(11,-1,s)}static UpdateDateComponent(e,t,r){t>=0&&(this.date_components.short_days[t]=r.toLocaleString(this.locale,{weekday:"short"}),this.date_components.long_days[t]=r.toLocaleString(this.locale,{weekday:"long"})),e>=0&&(this.date_components.short_months[e]=r.toLocaleString(this.locale,{month:"short"}),this.date_components.long_months[e]=r.toLocaleString(this.locale,{month:"long"}))}}p.locale="en-us",p.decimal_separator=".",p.argument_separator=",",p.grouping_separator=",",p.date_components={short_days:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],long_days:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],short_months:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],long_months:["January","February","March","April","May","June","July","August","September","October","November","December"]},p.UpdateLocale();class _{constructor(e=0,t=0,r=0,s=0){this.left=e,this.top=t,this.width=r,this.height=s}get right(){return this.left+this.width}get bottom(){return this.top+this.height}static Create(e){return new _(e.left||0,e.top||0,e.width||0,e.height||0)}static IsRectangle(e){var t,r,s,i;return"object"==typeof e&&"number"==typeof(null===(t=e)||void 0===t?void 0:t.left)&&"number"==typeof(null===(r=e)||void 0===r?void 0:r.top)&&"number"==typeof(null===(s=e)||void 0===s?void 0:s.width)&&"number"==typeof(null===(i=e)||void 0===i?void 0:i.height)}Shift(e=0,t=0){return new _(this.left+e,this.top+t,this.width,this.height)}Scale(e=1,t=e){return new _(this.left*e,this.top*t,this.width*e,this.height*t)}Expand(e=0,t=0){return new _(this.left,this.top,this.width+e,this.height+t)}Combine(e){return new _(Math.min(this.left,e.left),Math.min(this.top,e.top),Math.max(this.right,e.right)-Math.min(this.left,e.left),Math.max(this.bottom,e.bottom)-Math.min(this.top,e.top))}CheckEdges(e,t,r=16){let s=0;return e-this.left<r&&(s|=1),this.right-e<r&&(s|=2),t-this.top<r&&(s|=4),this.bottom-t<r&&(s|=8),s}Contains(e,t,r=0){return e>=this.left-r&&e<=this.left+this.width+r&&t>=this.top-r&&t<=this.top+this.height+r}ContextFill(e){e.fillRect(this.left,this.top,this.width,this.height)}ContextStroke(e){e.strokeRect(this.left,this.top,this.width,this.height)}Clamp(e,t){return{x:e=Math.min(Math.max(e,this.left),this.right),y:t=Math.min(Math.max(t,this.top),this.bottom)}}ApplyStyle(e){e.style.top=this.top+"px",e.style.left=this.left+"px",e.style.width=this.width+"px",e.style.height=this.height+"px"}toJSON(){return{top:this.top,left:this.left,width:this.width,height:this.height}}}var y,g,v;!function(e){const t=JSON.stringify({});let r,s;!function(e){e[e.None=0]="None",e[e.Left=1]="Left",e[e.Center=2]="Center",e[e.Right=3]="Right"}(r=e.HorizontalAlign||(e.HorizontalAlign={})),function(e){e[e.None=0]="None",e[e.Top=1]="Top",e[e.Bottom=2]="Bottom",e[e.Middle=3]="Middle"}(s=e.VerticalAlign||(e.VerticalAlign={})),e.DefaultProperties={horizontal_align:r.None,vertical_align:s.None,number_format:"General",nan:"NaN",font_size_value:10,font_size_unit:"pt",font_face:"calibri",font_bold:!1,font_italic:!1,font_underline:!1,font_strike:!1,text:{theme:1},border_top:0,border_left:0,border_right:0,border_bottom:0},e.Merge=(e,t,r=!0)=>{const s=r?Object.assign(Object.assign({},e),t):Object.assign({},t);return JSON.parse(JSON.stringify(s))},e.Composite=e=>JSON.parse(JSON.stringify(e.reduce(((e,t)=>Object.assign(Object.assign({},e),t)),{}))),e.Empty=e=>JSON.stringify(e)===t,e.ValidColor=e=>!(!e||e.none||!e.text&&!e.theme&&0!==e.theme),e.Font=(e,t=1)=>{const r=[];return e.font_weight?r.push(e.font_weight.toString()):e.font_bold&&r.push("bold"),e.font_italic&&r.push("italic"),r.push(((e.font_size_value||0)*t).toFixed(2)+(e.font_size_unit||"pt")),r.push(e.font_face||""),r.join(" ")}}(y||(y={})),function(e){e[e.default=0]="default",e[e.hidden=1]="hidden",e[e.padded=2]="padded",e[e.date_component=3]="date_component",e[e.date_component_minutes=4]="date_component_minutes",e[e.literal=5]="literal",e[e.formatting=6]="formatting"}(g||(g={})),new class{Darken(e,t,r,s,i=!1){let{h:a,s:n,l:o}=this.RGBToHSL(e,t,r);return o-=i?o*s/100:s/100,o=Math.max(0,Math.min(1,o)),this.HSLToRGB(a,n,o)}Lighten(e,t,r,s,i=!1){let{h:a,s:n,l:o}=this.RGBToHSL(e,t,r);return o+=i?o*s/100:s/100,o=Math.max(0,Math.min(1,o)),this.HSLToRGB(a,n,o)}RGBToHSL(e,t,r){e/=255,t/=255,r/=255;const s=Math.max(e,t,r),i=Math.min(e,t,r);let a=0,n=0;const o=(s+i)/2;if(s===i)a=n=0;else{const l=s-i;switch(n=o>.5?l/(2-s-i):l/(s+i),s){case e:a=(t-r)/l+(t<r?6:0);break;case t:a=(r-e)/l+2;break;case r:a=(e-t)/l+4}a/=6}return{h:360*a,s:n,l:o}}HSLToRGB(e,t,r){let s,i,a;if(0===t)s=i=a=r;else{e/=360;const n=r<.5?r*(1+t):r+t-r*t,o=2*r-n;s=this.HueToRGB(o,n,e+1/3),i=this.HueToRGB(o,n,e),a=this.HueToRGB(o,n,e-1/3)}return{r:Math.round(255*s),g:Math.round(255*i),b:Math.round(255*a)}}HueToRGB(e,t,r){return r<0&&(r+=1),r>1&&(r-=1),r<1/6?e+6*(t-e)*r:r<.5?t:r<2/3?e+(t-e)*(2/3-r)*6:e}};class b{constructor(){this.date_format=!1,this.string_format=!1,this.fraction_format=!1,this.twelve_hour=!1,this.fraction_denominator=0,this.fraction_integer=!0,this.fraction_align=0,this.fraction_denominator_digits=0,this.integer_min_digits=0,this.decimal_min_digits=0,this.decimal_max_digits=0,this.grouping=!1,this.has_number_format=!1,this.prefix=[{text:""}],this.suffix=[{text:""}],this.scaling=0,this.percent=!1,this.exponential=!1,this.has_asterisk=!1}}!function(e){e[e.Integer=0]="Integer",e[e.Decimal=1]="Decimal"}(v||(v={}));class w{static Parse(e){if(this.pattern=e,this.characters=e.split("").map((e=>e.charCodeAt(0))),this.char_index=0,this.current_section=new b,this.sections=[this.current_section],this.ParseDatePattern())return this.sections;for(this.char_index=0,this.current_section=new b,this.sections=[this.current_section];this.char_index<this.characters.length;)this.ConsumeChar();return this.sections}static ConsumeString(){let e="";for(this.preserve_formatting_characters&&(e+=this.pattern[this.char_index]),++this.char_index;this.char_index<this.characters.length;this.char_index++)switch(this.characters[this.char_index]){case 92:this.preserve_formatting_characters&&(e+=this.pattern[this.char_index]),this.char_index+1<this.characters.length&&(e+=this.pattern[++this.char_index]);break;case 34:return this.preserve_formatting_characters&&(e+=this.pattern[this.char_index]),this.char_index++,e;default:e+=this.pattern[this.char_index]}throw new Error("unterminated string")}static ConsumeFormatting(){let e="";for(++this.char_index;this.char_index<this.characters.length;this.char_index++)switch(this.characters[this.char_index]){case 92:throw new Error("invalid escape character in formatting block");case 93:return this.char_index++,e;default:e+=this.pattern[this.char_index]}throw new Error("unterminated format")}static ScanFractionFormat(){const e=this.pattern.substr(this.char_index).match(/^([#?]+ +){0,1}([#?]+)\/([#?0-9]+)(?:$|[^#?0-9])/);if(!e)return!1;const t=(e[1]||"").length+e[2].length+e[3].length+1;this.current_section.fraction_format=!0,this.current_section.fraction_integer=!!e[1];const r=Number(e[3]);return isNaN(r)||(this.current_section.fraction_denominator=r),this.current_section.decimal_max_digits=this.current_section.fraction_denominator_digits=e[3].length,this.char_index+=t,this.current_section.has_number_format=!0,!0}static ConsumeNumberFormat(){let e=v.Integer;for(this.char_index;this.char_index<this.characters.length;this.char_index++)switch(this.characters[this.char_index]){case this.group_separator:{let t=!1;for(let e=this.char_index+1;!t&&e<this.characters.length;e++){const r=this.characters[e];if(r===this.decimal_mark||35===r||48===r)t=!0;else if(44!==r)break}if(t){if(e===v.Decimal)throw new Error("invalid grouping in decimal part");this.current_section.grouping=!0}else this.current_section.scaling=1e3*(this.current_section.scaling||1)}break;case this.decimal_mark:if(e===v.Decimal)throw new Error("too many decimal marks");e=v.Decimal;break;case 35:e===v.Decimal?this.current_section.decimal_max_digits++:this.current_section.integer_min_digits&&this.current_section.integer_min_digits++;break;case 48:e===v.Decimal?(this.current_section.decimal_max_digits++,this.current_section.decimal_min_digits=this.current_section.decimal_max_digits):this.current_section.integer_min_digits++;break;default:return}}static AppendCharAsText(e=!0){this.current_section.has_number_format?this.current_section.suffix[this.current_section.suffix.length-1].text+=this.pattern[this.char_index]:this.current_section.prefix[this.current_section.prefix.length-1].text+=this.pattern[this.char_index],e&&this.char_index++}static AppendString(e){this.current_section.has_number_format?this.current_section.suffix[this.current_section.suffix.length-1].text+=e:this.current_section.prefix[this.current_section.prefix.length-1].text+=e}static AppendTextPart(e){this.current_section.has_number_format?(this.current_section.suffix.push(e),this.current_section.suffix.push({text:""})):(this.current_section.prefix.push(e),this.current_section.prefix.push({text:""}))}static ConsumeChar(){const e=this.characters[this.char_index];if(63!==e&&35!==e||this.current_section.has_number_format||this.current_section.string_format||!this.ScanFractionFormat())switch(e){case 59:this.char_index++,this.current_section=new b,3===this.sections.length&&(this.current_section.string_format=!0),this.sections.push(this.current_section);break;case 64:this.char_index++,this.AppendTextPart({text:"@",flag:g.literal}),this.current_section.string_format=!0;break;case 48:case 35:case 46:case 44:this.current_section.has_number_format||this.current_section.string_format?this.AppendCharAsText():(this.ConsumeNumberFormat(),this.current_section.has_number_format=!0);break;case 91:this.AppendTextPart({text:this.ConsumeFormatting(),flag:g.formatting});break;case 34:this.AppendString(this.ConsumeString());break;case 63:this.preserve_formatting_characters?this.AppendCharAsText():(this.AppendTextPart({text:"0",flag:g.hidden}),this.char_index++);break;case 95:if(this.preserve_formatting_characters)this.AppendCharAsText();else{if(++this.char_index>=this.characters.length)throw new Error("invalid pad character at end");this.AppendTextPart({text:this.pattern[this.char_index++],flag:g.hidden})}break;case 42:if(this.current_section.has_asterisk)throw new Error("we don't support multiple asterisks");if(this.preserve_formatting_characters)this.AppendCharAsText();else{if(++this.char_index>=this.characters.length)throw new Error("invalid pad character at end");this.AppendTextPart({text:this.pattern[this.char_index++],flag:g.padded}),this.current_section.has_asterisk=!0}break;case 101:case 69:this.current_section.percent||this.current_section.exponential||this.current_section.string_format?this.AppendCharAsText():(this.current_section.exponential=!0,this.char_index++);break;case 37:this.current_section.exponential||this.current_section.string_format||(this.current_section.percent=!0),this.AppendCharAsText();break;case 92:if(this.preserve_formatting_characters&&this.AppendCharAsText(!1),++this.char_index>=this.characters.length)throw new Error("invalid escape character at end");this.AppendCharAsText();break;default:this.AppendCharAsText()}}static ParseDatePattern(){for(this.date_pattern=!0;this.date_pattern&&this.char_index<this.pattern.length;)this.DatePatternConsumeChar();if(this.date_pattern){this.date_pattern=!1;for(const e of this.sections)for(const t of e.prefix)t.flag&&t.flag&(g.date_component|g.date_component_minutes)&&(this.date_pattern=!0)}return this.date_pattern&&(this.sections[0].date_format=!0,this.sections[0].prefix.forEach(((e,t)=>{if(e.flag===g.date_component&&("mm"===e.text||"m"===e.text)){if(t)for(let r=t-1;r;r--){const t=this.sections[0].prefix[r];if(t.flag===g.date_component){/h/i.test(t.text)&&(e.flag=g.date_component_minutes,e.text=e.text.toLowerCase());break}}if(t<this.sections[0].prefix.length-1)for(let r=t+1;r<this.sections[0].prefix.length;r++){const t=this.sections[0].prefix[r];if(t.flag===g.date_component){/s/i.test(t.text)&&(e.flag=g.date_component_minutes,e.text=e.text.toLowerCase());break}}}}))),this.date_pattern}static ConsumeDatePart(){const e=this.pattern[this.char_index++],t=e.toLowerCase(),r={text:e,flag:g.date_component};for(;this.pattern[this.char_index]&&this.pattern[this.char_index].toLowerCase()===t;)r.text+=this.pattern[this.char_index++];if("s"===t&&"."===this.pattern[this.char_index])for(r.text+=this.pattern[this.char_index++];"0"===this.pattern[this.char_index];)r.text+=this.pattern[this.char_index++];return r}static ConsumeAMPM(){let e=this.pattern.substr(this.char_index,5);return"am/pm"===e||"AM/PM"===e?(this.char_index+=5,this.sections[0].twelve_hour=!0,{text:e,flag:g.date_component}):(e=this.pattern.substr(this.char_index,3),"a/p"===e||"A/P"===e?(this.char_index+=3,this.sections[0].twelve_hour=!0,{text:e,flag:g.date_component}):void 0)}static DatePatternConsumeChar(){switch(this.characters[this.char_index]){case 59:this.char_index=this.characters.length;break;case 48:case 35:case 101:case 69:case 37:case 64:this.date_pattern=!1;break;case 72:case 104:case 77:case 109:case 83:case 115:case 68:case 100:case 89:case 121:this.AppendTextPart(this.ConsumeDatePart());break;case 65:case 97:{const e=this.ConsumeAMPM();e?this.AppendTextPart(e):this.AppendCharAsText()}break;case 34:this.AppendString(this.ConsumeString());break;case 63:this.preserve_formatting_characters?this.AppendCharAsText():(this.AppendTextPart({text:"0",flag:g.hidden}),this.char_index++);break;case 95:if(this.preserve_formatting_characters)this.AppendCharAsText();else{if(++this.char_index>=this.characters.length)throw new Error("invalid pad character at end");this.AppendTextPart({text:this.pattern[this.char_index++],flag:g.hidden})}break;case 42:if(this.current_section.has_asterisk)throw new Error("we don't support multiple asterisks");if(this.preserve_formatting_characters)this.AppendCharAsText();else{if(++this.char_index>=this.characters.length)throw new Error("invalid pad character at end");this.AppendTextPart({text:this.pattern[this.char_index++],flag:g.padded}),this.current_section.has_asterisk=!0}break;case 92:if(this.preserve_formatting_characters&&this.AppendCharAsText(!1),++this.char_index>=this.characters.length)throw new Error("invalid escape character at end");this.AppendCharAsText();break;default:this.AppendCharAsText()}}}w.date_pattern=!1,w.pattern="",w.char_index=0,w.characters=[],w.sections=[],w.current_section=new b,w.preserve_formatting_characters=!1,w.decimal_mark=46,w.group_separator=44;const x=e=>(e>=60&&e--,new Date(864e5*e-22090752e5)),M=(e,t=!0)=>{if(t){const t=new Date(e),r=new Date;r.setUTCMilliseconds(t.getUTCMilliseconds()),r.setUTCSeconds(t.getUTCSeconds()),r.setUTCMinutes(t.getUTCMinutes()),r.setUTCHours(t.getHours()),r.setUTCDate(t.getDate()),r.setUTCMonth(t.getMonth()),r.setUTCFullYear(t.getFullYear()),e=r.getTime()}return(e=(e+22090752e5)/864e5)>=60&&e++,e};class C{constructor(e){if(this._pattern="",this.decimal_zero_regexp=[],this.cloned=[],this.magic_decimal=!1,this._pattern=e,this.sections=w.Parse(e),this.sections.length||(this.sections=[]),this.sections[0]||(this.sections[0]=new b),this.sections[1]||(this.sections[1]=Object.assign({},this.sections[0]),this.sections[1].prefix=JSON.parse(JSON.stringify(this.sections[1].prefix)),this.sections[1].suffix=JSON.parse(JSON.stringify(this.sections[1].suffix)),this.sections[1].prefix.push({text:"-"}),this.cloned[1]=!0),this.sections[2]||(this.sections[2]=Object.assign({},this.sections[0]),this.cloned[2]=!0),!this.sections[3])for(const e of this.sections[0].prefix)if(e.flag===g.literal){this.sections[3]=Object.assign({},this.sections[0]),this.sections[3].string_format=!0,this.cloned[3]=!0;break}this.decimal_zero_regexp=this.sections.map((e=>{if(e.decimal_max_digits>e.decimal_min_digits)return new RegExp(`0{1,${e.decimal_max_digits-e.decimal_min_digits}}(?:$|e)`)}))}static FormatPartsAsText(e,t=0){let r=-1;const s=e.map(((e,t)=>{switch(e.flag){case g.padded:return r=t,e.text;case g.hidden:return e.text.replace(/./g," ");case g.formatting:return"";default:return e.text}}));if(r>=0&&t){const e=s.reduce(((e,t,s)=>s===r?e:e+t.length),0);let i="";for(let a=0;a<t-e;a++)i+=s[r];s[r]=i}return s.join("")}get pattern(){return this._pattern}get date_format(){return this.sections[0]&&this.sections[0].date_format}IncreaseDecimal(){this.sections.forEach((e=>{e.decimal_min_digits++,e.decimal_max_digits=e.decimal_min_digits}))}DecreaseDecimal(){this.sections.forEach((e=>{e.decimal_min_digits=Math.max(0,e.decimal_min_digits-1),e.decimal_max_digits=e.decimal_min_digits}))}AddGrouping(){this.sections.forEach((e=>{e.grouping=!0}))}RemoveGrouping(){this.sections.forEach((e=>{e.grouping=!1}))}ToggleGrouping(){const e=!this.sections[0].grouping;this.sections.forEach((t=>{t.grouping=e}))}toString(){return this.sections[0].date_format?this._pattern:this.sections.filter(((e,t)=>!this.cloned[t])).map((e=>{let t="",r=0;if(e.fraction_format){e.fraction_integer&&(t+="? ");let r="";for(let t=0;t<e.fraction_denominator_digits;t++)r+="#";t+=r,t+="/",e.fraction_denominator?t+=e.fraction_denominator:t+=r}else if(e.has_number_format){for(r=0;r<e.integer_min_digits;r++)t+="0";if(e.grouping&&(t.length<4&&(t=("####"+t).slice(-4)),t=t.replace(/[\d#]{1,3}(?=([\d#]{3})+(?![\d#]))/g,"$&,")),e.decimal_max_digits||e.decimal_min_digits){for(t+=".",r=0;r<e.decimal_min_digits;r++)t+="0";for(;r<e.decimal_max_digits;r++)t+="#"}if(e.scaling){const s=Math.log10(e.scaling)/3;for(r=0;r<s;r++)t+=","}e.exponential&&(t+="e")}return e.prefix.map((e=>e.flag===g.hidden?"0"===e.text?"?":"_"+e.text:e.flag===g.padded?"*"+e.text:e.flag===g.formatting?"["+e.text+"]":e.text)).join("")+t+e.suffix.map((e=>e.flag===g.hidden?"0"===e.text?"?":"_"+e.text:e.flag===g.padded?"*"+e.text:e.text)).join("")})).join(";")}FormatComplex(e){let t=[],r=[],s=!!e.imaginary;s&&(t=this.FormatParts(e.imaginary),s=t.some((e=>/[1-9]/.test(e.text))));let i=!!e.real;i&&(r=this.FormatParts(e.real),i=r.some((e=>/[1-9]/.test(e.text))));const a=[];return i||!i&&!s?(a.push(...this.FormatParts(e.real)),s&&(Math.abs(e.imaginary),a.push({text:e.imaginary<0?` ${C.minus_character} `:" + "}),a.push(...this.FormatParts(Math.abs(e.imaginary)),{text:C.imaginary_character}))):s&&a.push(...this.FormatParts(e.imaginary),{text:C.imaginary_character}),a}FormatParts(e){if("number"!=typeof e&&!this.sections[3])return[{text:e.toString()}];const{parts:t,section:r}=this.BaseFormat(e);let s=[];if(r.date_format||r.string_format)for(const e of t)"string"==typeof e?s.push({text:e}):s.push(e);else this.magic_decimal&&""===t[1]&&t.splice(1,1),s=[...r.prefix.map((e=>Object.assign({},e))),{text:r.has_number_format?t.join(p.decimal_separator):""},...r.suffix.map((e=>Object.assign({},e)))];for(let e=1;e<s.length;e++)s[e].flag===s[e-1].flag&&(s[e].text=s[e-1].text+s[e].text,s[e-1].text="");return s.filter((e=>e.text))}Format(e,t=0){return C.FormatPartsAsText(this.FormatParts(e),t)}ZeroPad(e,t){for(;e.length<t;)e="0"+e;return e}DateFormat(e){const t=x(e),r=this.sections[0];let s=t.getUTCHours();return r.twelve_hour&&(s>12&&(s-=12),0===s&&(s=12)),{parts:r.prefix.map((e=>{if(e.flag===g.date_component_minutes)return"mm"===e.text?{text:this.ZeroPad(t.getUTCMinutes().toString(),2)}:{text:this.ZeroPad(t.getUTCMinutes().toString(),1)};if(e.flag===g.date_component){switch(e.text.toLowerCase()){case"am/pm":case"a/p":{const r=e.text.split("/");return{text:t.getUTCHours()>12?r[1]:r[0]}}case"mmmmm":return{text:p.date_components.long_months[t.getUTCMonth()][0]};case"mmmm":return"MMMM"===e.text?{text:p.date_components.long_months[t.getUTCMonth()].toUpperCase()}:{text:p.date_components.long_months[t.getUTCMonth()]};case"mmm":return"MMM"===e.text?{text:p.date_components.short_months[t.getUTCMonth()].toUpperCase()}:{text:p.date_components.short_months[t.getUTCMonth()]};case"mm":return{text:this.ZeroPad((t.getUTCMonth()+1).toString(),2)};case"m":return{text:this.ZeroPad((t.getUTCMonth()+1).toString(),1)};case"ddddd":case"dddd":return"DDDDD"===e.text||"DDDD"===e.text?{text:p.date_components.long_days[t.getUTCDay()].toUpperCase()}:{text:p.date_components.long_days[t.getUTCDay()]};case"ddd":return"DDD"===e.text?{text:p.date_components.short_days[t.getUTCDay()].toUpperCase()}:{text:p.date_components.short_days[t.getUTCDay()]};case"dd":return{text:this.ZeroPad(t.getUTCDate().toString(),2)};case"d":return{text:this.ZeroPad(t.getUTCDate().toString(),1)};case"yyyy":case"yyy":return{text:t.getUTCFullYear().toString()};case"yy":case"y":return{text:this.ZeroPad((t.getUTCFullYear()%100).toString(),2)};case"hh":return{text:this.ZeroPad(s.toString(),2)};case"h":return{text:this.ZeroPad(s.toString(),1)};case"ss":return{text:this.ZeroPad(t.getUTCSeconds().toString(),2)};case"s":return{text:this.ZeroPad(t.getUTCSeconds().toString(),1)}}const r=e.text.match(/^(s+)\.(0+)$/);if(r)return{text:this.ZeroPad(t.getUTCSeconds().toString(),r[1].length)+p.decimal_separator+(t.getUTCMilliseconds()/1e3).toFixed(r[2].length).substr(2)}}return Object.assign({},e)})),section:r}}StringFormat(e,t){const r=[];for(const s of t.prefix)s.flag===g.literal?r.push({text:e}):r.push(Object.assign({},s));return{parts:r,section:t}}Round2(e,t){const r=Math.pow(10,t);return Math.round(r*e)/r}FormatFraction(e,t){t.percent&&(e*=100);let r={denominator:1,numerator:Math.round(e),error:Math.abs(Math.round(e)-e)};if(t.fraction_denominator)r.denominator=t.fraction_denominator,r.numerator=Math.round(e*r.denominator);else if(r.error){const s=C.fraction_limits[t.fraction_denominator_digits-1]||C.fraction_limits[0];for(let t=2;t<=s;t++){const s=Math.round(e*t),i=Math.abs(s/t-e);if(i<r.error&&(r={numerator:s,denominator:t,error:i},!i))break}}const s=[];if(t.fraction_integer){const e=Math.floor(r.numerator/r.denominator);r.numerator%=r.denominator,!e&&r.numerator||(s.push(e.toString()),r.numerator&&s.push(" "))}else r.numerator||s.push("0");return r.numerator&&(s.push(r.numerator.toString()),s.push("/"),s.push(r.denominator.toString())),s.join("")}BaseFormat(e){if(this.sections[0].date_format)return this.DateFormat(Number(e));if("number"!=typeof e)return this.StringFormat(e.toString(),this.sections[3]);let t=this.sections[0],r=this.decimal_zero_regexp[0];e<0&&(t=this.sections[1]);const s=t.percent?t.decimal_max_digits+2:t.decimal_max_digits,i=Math.pow(10,-s)/2;let a=Math.abs(e);if(a<i&&(t=this.sections[2],r=this.decimal_zero_regexp[2]),t.scaling&&(a/=t.scaling,a<i&&(t=this.sections[2],r=this.decimal_zero_regexp[2])),t.string_format)return this.StringFormat(e.toString(),t);let n="";if(t.fraction_format)return{parts:[this.FormatFraction(a,t)],section:t};t.exponential?n=a.toExponential(t.decimal_max_digits):(t.percent&&(a*=100),n=this.Round2(a,t.decimal_max_digits).toFixed(t.decimal_max_digits)),r&&(n=n.replace(r,""));const o=n.split(".");for(;o[0].length<t.integer_min_digits;)o[0]=("0000000000000000"+o[0]).slice(-t.integer_min_digits);return 0===t.integer_min_digits&&"0"===o[0]&&(o[0]=""),t.grouping&&(o[0]=o[0].replace(C.grouping_regexp,"$&"+p.grouping_separator)),{parts:o,section:t}}}C.grouping_regexp=/\d{1,3}(?=(\d{3})+(?!\d))/g,C.fraction_limits=[9,99,999,9999],C.imaginary_character="",C.minus_character="-";class S{static Get(e,t=!1){if(t&&"General"===e)return this.complex_general;const r=this.symbolc_name_map[e.toLowerCase()];let s=this.cache[r||e];return s||(s=new C(e),this.cache[e]=s),s}static Equals(e,t){if(e===t)return!0;const r=this.Get(e),s=this.Get(t);return r.pattern===s.pattern}static Translate(e){const t=this.symbolc_name_map[e.toLowerCase()];return t?this.cache[t].toString():e}static SymbolicName(e){for(const t of Object.keys(this.base_formats))if(e===this.base_formats[t])return t;return null}static InitCache(){for(const e of Object.keys(this.base_formats))this.cache[e]=new C(this.base_formats[e]),this.symbolc_name_map[e.toLowerCase()]=e;this.cache.General.magic_decimal=!0,this.complex_general=new C("0.###"),this.complex_general.magic_decimal=!0;for(const e of Object.keys(this.aliases))this.cache[e]=this.cache[this.aliases[e]],this.symbolc_name_map[e.toLowerCase()]=e}}var A;S.cache={},S.symbolc_name_map={},S.base_formats={Accounting:"_(#,##0.00_);(#,##0.00);-???",Number:"0.00",Integer:"0",Percent:"0.00%",General:"0.######",Fraction:"# ?/?",Dollar:"$* _(#,##0.00_);$* (#,##0.00);$* -???",Exponential:"0.000e","Short Date":"mm/dd/yy","Long Date":"dddd, mmm d yyyy",Timestamp:"mm-dd-yy hh:mm:ss"},S.aliases={Scientific:"Exponential",Percentage:"Percent",Currency:"Dollar"},S.InitCache(),function(e){e[e.None=0]="None",e[e.Nan=1]="Nan",e[e.Exponential=2]="Exponential",e[e.Percent=4]="Percent",e[e.Currency=8]="Currency",e[e.Grouping=16]="Grouping",e[e.Parens=32]="Parens",e[e.Date=64]="Date",e[e.Time=128]="Time"}(A||(A={}));const R=(new Date).getUTCFullYear();new class{TestDate(e){const t=Date.parse(e);if(isNaN(t))return!1;const r=new Date(t),s=e.replace(/[\d\-\\/,.\s]+/g," ").toLocaleLowerCase().split(/\s+/).map((e=>e.trim())).filter((e=>!!e));if(!s.length)return t;if(!this.compare_month){this.compare_month={};for(let e=0;e<12;e++)this.compare_month[p.date_components.long_months[e].toLocaleLowerCase().replace(/\./,"")]=e,this.compare_month[p.date_components.short_months[e].toLocaleLowerCase().replace(/\./,"")]=e}if(!this.compare_day){this.compare_day={};for(let e=0;e<7;e++)this.compare_day[p.date_components.long_days[e].toLocaleLowerCase().replace(/\./,"")]=e,this.compare_day[p.date_components.short_days[e].toLocaleLowerCase().replace(/\./,"")]=e}let i=!1,a=!1;for(const e of s){let t=!1;for(const[s,a]of Object.entries(this.compare_month))if(e===s){if(i)return!1;if(r.getUTCMonth()!==a)return!1;t=!0,i=!0}if(!t)for(const[s,i]of Object.entries(this.compare_day))if(e===s){if(a)return!1;if(r.getUTCDay()!==i)return!1;t=!0,a=!0}if(!t)return!1}return!(a&&!i)&&t}TryParse(e=""){let t=A.None;if("'"===e[0])return{value:e,type:s.string};if(""===e)return{value:e,type:s.string};if("NaN"===e)return{value:NaN,type:s.number,hints:A.Nan};let r=e.trim();const i=r.match(/^[$](.*?)$/);i&&(r=i[1],t|=A.Currency);const a=r.match(/^\((.*?)\)$/);a&&(r=a[1],t|=A.Parens);const n=r.match(/^(.*?)%\s*$/);n&&(r=n[1],t|=A.Percent),"."===p.decimal_separator?/,/.test(r)&&(r=r.replace(/,/g,""),t|=A.Grouping):(r=r.replace(/(\d)\s+/g,"$1"),r=r.replace(/\./g,""),r=r.replace(/,/,"."));let o=Number(r);if(null===o||isNaN(o)){const r=e.toLowerCase();if("false"===r)return{value:!1,type:s.boolean};if("true"===r)return{value:!0,type:s.boolean};const i=this.TestDate(e);if(!1!==i&&!isNaN(i)){const e=new Date(i),r=e.getUTCFullYear();if(r>=R-200&&r<=R+200)return t=A.Date,(e.getHours()||e.getMinutes()||e.getSeconds())&&(t|=A.Time),{value:M(i),type:s.number,hints:t}}return{value:e,type:s.string}}if(a&&(o=-o),n){const e=o<0?-1:1,t=(e*o).toString().split(".");t[0]=("00"+t[0]).replace(/(\d\d)$/,".$1"),o=Number(t.join(""))*e}return/e/.test(e)&&(t|=A.Exponential),{value:o,type:s.number,hints:t}}};class k{static MeasureColorARGB(e){const t=this.MeasureColor(e);let r="FF";for(let e=0;e<3;e++){const s=t[e].toString(16);0===s.length?r+="00":1===s.length?r+=`0${s}`:r+=s}return r.toUpperCase()}static MeasureColor(e){let t=this.color_cache[e];if(t)return t;this.color_measurement_canvas||(this.color_measurement_canvas=document.createElement("canvas"),this.color_measurement_canvas.width=1,this.color_measurement_canvas.height=1);const r=this.color_measurement_canvas.getContext("2d");return r?(r.fillStyle="#fff",r.fillRect(0,0,1,1),r.fillStyle=e,r.fillRect(0,0,1,1),t=r.getImageData(0,0,1,1).data,this.color_cache[e]=t,t):new Uint8ClampedArray(3)}static EnsureMeasurementNode(){if(!this.text_measurement_node){const e=document.querySelector(".treb-chart-measurement-node");e?this.text_measurement_node=e:(this.text_measurement_node=document.createElement("div"),this.text_measurement_node.classList.add("treb-chart-measurement-node"),this.text_measurement_node.style.margin="0px",this.text_measurement_node.style.padding="0px",this.text_measurement_node.style.whiteSpace="nowrap",this.text_measurement_node.style.position="fixed",this.text_measurement_node.style.border="0px",this.text_measurement_node.style.border="1px solid red",this.text_measurement_node.style.boxSizing="content-box",this.text_measurement_node.style.top=this.text_measurement_node.style.left="-1000px",document.body.appendChild(this.text_measurement_node))}}static FontLoaded(e,t=!1,r=400){const s=`${t?"italic":""} ${r} 20pt ${e}`,i=this.MeasureText(`${s}, sans-serif`,"check font"),a=this.MeasureText(`${s}, serif`,"check font"),n=this.MeasureText(`${s}, monospace`,"check font");return i.width===a.width&&a.width===n.width}static MeasureText(e,t,r=0){this.EnsureMeasurementNode(),this.text_measurement_node.style.font=e,/\n/.test(t)?(t=t.replace(/\n/g,"<BR/>"),this.text_measurement_node.innerHTML=t):this.text_measurement_node.textContent=t,this.text_measurement_node.style.lineHeight="1em",this.text_measurement_node.style.transform=r?`rotate(${r}deg)`:"";const s=this.text_measurement_node.getBoundingClientRect();return{width:s.width,height:s.height}}}k.color_cache={};const N=(e,t,r=6.5,s=!1)=>{if(t===e)t++,e&&e--;else{const r=Math.round(1e5*t)/1e5;Math.abs(r-t)/(t-e)<1e-5&&(t=r)}const i=t-e,a=Math.log(i)/Math.log(10),n=Math.floor(Math.abs(a))*(a<0?-1:1)-1,o=[.1,.25,.5,1,2.5,5,10,25,50,100];let l=-1,u=0;for(const i of o){const a=i*Math.pow(10,n),o=Math.floor(e/a)*a,h=(Math.ceil(t/a)*a-o)/a,c=Math.abs(h-r);(l<0||c<u)&&(!s||h<=r)&&(u=c,l=a)}return e=Math.floor(e/l)*l,t=Math.ceil(t/l)*l,{scale:n,step:l,count:r=Math.round((t-e)/l),min:e,max:t}};let D=100;class P{constructor(e={}){this.key_=D++,this.data={},this.type="",this.temp={},this.inflated=!1,this.resizable=!0,this.movable=!0,this.removable=!0,this.selectable=!0,this.move_with_cells=!0,this.resize_with_cells=!0,this.formula="";for(const t of Object.keys(this))"layout"!==t&&e[t]&&(this[t]=e[t]);e.layout&&(this.layout=JSON.parse(JSON.stringify(e.layout))),e.rect&&(this.rect=_.Create(e.rect))}get key(){return this.key_}toJSON(){const e={};return this.data&&(e.data=this.data),this.formula&&(e.formula=this.formula),this.type&&(e.type=this.type),this.resizable||(e.resizable=this.resizable),this.movable||(e.movable=this.movable),this.removable||(e.removable=this.removable),this.selectable||(e.selectable=this.selectable),this.move_with_cells||(e.move_with_cells=this.move_with_cells),this.resize_with_cells||(e.resize_with_cells=this.resize_with_cells),this.layout&&(e.layout=this.layout),this.extent&&(e.extent=this.extent),e}}class E{constructor(t){this.annotations=[],this.freeze={rows:0,columns:0},this.visible=!0,this.default_column_width=100,this.default_row_height=25,this.cells=new f,this.selection={target:{row:0,column:0},area:new e({row:0,column:0}),empty:!0},this.scroll_offset={x:0,y:0},this.name=E.default_sheet_name,this.row_height_=[],this.column_width_=[],this.row_headers=[],this.column_headers=[],this.row_header_width=100,this.column_header_height=25,this.style_map=[],this.style_json_map=[],this.sheet_style={},this.row_styles={},this.column_styles={},this.row_pattern=[],this.cell_style=[],this.default_style_properties=t,this.default_column_width=100,this.row_header_width=60,this.UpdateDefaultRowHeight(),this.id_=E.base_id++}static Reset(){this.base_id=100}static Blank(e,t,r=30,s=20){const i=new E(e);return t&&(i.name=t),r=Math.max(r,1),s=Math.max(s,1),i.cells.EnsureCell({row:r-1,column:s-1}),i}static FromJSON(e,t,r){let s;s="string"==typeof e?JSON.parse(e):e;const i=(e,t)=>{Object.keys(t).forEach((r=>{const s=Number(r)||0;e[s]=t[r]}))};r||(r=new E(t)),s.default_column_width&&(r.default_column_width=s.default_column_width),s.default_row_height&&(r.default_row_height=s.default_row_height),s.id&&(r.id=s.id),s.name&&(r.name=s.name);const a=e=>{const t=e;t.text_color&&("none"!==t.text_color&&(t.text={text:t.text_color}),t.text_color=void 0),t.background&&("none"!==t.background&&(t.fill={text:t.background}),t.background=void 0),t.border_top_color&&("none"!==t.border_top_color&&(t.border_top_fill={text:t.border_top_color}),t.border_top_color=void 0),t.border_left_color&&("none"!==t.border_left_color&&(t.border_left_fill={text:t.border_left_color}),t.border_left_color=void 0),t.border_bottom_color&&("none"!==t.border_bottom_color&&(t.border_bottom_fill={text:t.border_bottom_color}),t.border_bottom_color=void 0),t.border_right_color&&("none"!==t.border_right_color&&(t.border_right_fill={text:t.border_right_color}),t.border_right_color=void 0)},n=s.cell_style_refs;for(const e of n)a(e);if(r.cell_style=[],n&&(s.cell_styles||[]).forEach((e=>{"number"==typeof e.ref&&(e.style=JSON.parse(JSON.stringify(n[e.ref])))})),r.cells.FromJSON(s.data),s.rows&&r.cells.EnsureRow(s.rows-1),s.columns&&r.cells.EnsureColumn(s.columns-1),s.data)if(d(s.data))for(const e of s.data)e.style_ref&&(r.cell_style[e.column]||(r.cell_style[e.column]=[]),r.cell_style[e.column][e.row]=JSON.parse(JSON.stringify(n[e.style_ref])));else if(m(s.data))for(const e of s.data){const t=e.row;for(const s of e.cells){const e=s.column;s.style_ref&&(r.cell_style[e]||(r.cell_style[e]=[]),r.cell_style[e][t]=JSON.parse(JSON.stringify(n[s.style_ref])))}}else for(const e of s.data){const t=e.column;for(const s of e.cells){const e=s.row;s.style_ref&&(r.cell_style[t]||(r.cell_style[t]=[]),r.cell_style[t][e]=JSON.parse(JSON.stringify(n[s.style_ref])))}}r.freeze.rows=0,r.freeze.columns=0,s.freeze&&(r.freeze.rows=s.freeze.rows||0,r.freeze.columns=s.freeze.columns||0),r.scroll_offset=s.scroll?Object.assign({},s.scroll):{x:0,y:0};for(const e of s.cell_styles||[])e.style&&(r.cell_style[e.column]||(r.cell_style[e.column]=[]),r.cell_style[e.column][e.row]=e.style);r.sheet_style=s.sheet_style||{},r.row_styles=s.row_style,r.column_styles=s.column_style,r.row_pattern=s.row_pattern||[],a(r.sheet_style||{});for(const e of r.row_pattern)a(e);for(const e of Object.keys(r.column_styles))a(r.column_styles[e]);for(const e of Object.keys(r.row_styles))a(r.row_styles[e]);return r.row_height_=[],i(r.row_height_,s.row_height||{}),r.row_height_.length&&r.cells.EnsureRow(r.row_height_.length-1),r.column_width_=[],i(r.column_width_,s.column_width||{}),r.column_width_.length&&r.cells.EnsureColumn(r.column_width_.length-1),r.annotations=(s.annotations||[]).map((e=>new P(e))),s.selection&&(r.selection=JSON.parse(JSON.stringify(s.selection))),r.visible=!0,void 0!==s.visible&&(r.visible=!!s.visible),r}get header_offset(){return{x:this.row_header_width,y:this.column_header_height}}get rows(){return this.cells.rows}get columns(){return this.cells.columns}get id(){return this.id_}set id(e){this.id_=e,this.id>=E.base_id&&(E.base_id=this.id+1)}MergeCells(e){e=e.Clone(),this.cells.Apply(e,((t,r,s)=>{t.merge_area=e,t.render_dirty=!0,r===e.start.column&&s===e.start.row||t.Reset()}),!0)}UnmergeCells(e){let t=!0;this.cells.Apply(e,(r=>{t=t&&!!r.merge_area&&e.Equals(r.merge_area)}),!1),t?this.cells.Apply(e,(e=>{e.merge_area=void 0,e.render_dirty=!0}),!1):console.warn("area mismatch")}StyleFontSize(e,t={}){let r=e.font_size_value||0,s=0;switch(e.font_size_unit){case"px":r*=.75;break;case"em":s=e.font_size_value||1;break;case"%":s=(e.font_size_value||100)/100}return s&&(r=s*(t.font_size_value||10),"px"===t.font_size_unit&&(r*=.75)),r||10}UpdateDefaultRowHeight(){const e=y.Composite([this.default_style_properties,this.sheet_style]);if("undefined"!=typeof window){const t=k.MeasureText(y.Font(e),"M"),r=Math.round(1.4*t.height);this.default_row_height<r&&(this.default_row_height=r)}}SetRowHeaders(e){this.row_headers=e.map((e=>void 0===e?"":e.toString())),this.row_headers&&this.cells.EnsureRow(this.row_headers.length-1)}SetColumnHeaders(e){this.column_headers=e.map((e=>void 0===e?"":e.toString())),e&&this.cells.EnsureColumn(e.length-1)}RowHeader(e){return this.row_headers?this.row_headers.length>e?this.row_headers[e]:"":e+1}ColumnHeader(e){let t="";if(this.column_headers)return this.column_headers.length>e?this.column_headers[e]:"";for(;;){const r=e%26;if(t=String.fromCharCode(65+r)+t,!(e=Math.floor(e/26)))break;e--}return t}GetRowHeight(e){const t=this.row_height_[e];return void 0===t?this.default_row_height:t}SetRowHeight(e,t){return this.row_height_[e]=t,this.cells.EnsureRow(e),t}GetColumnWidth(e){const t=this.column_width_[e];return void 0===t?this.default_column_width:t}SetColumnWidth(e,t){return this.column_width_[e]=t,this.cells.EnsureColumn(e),t}Delta(e,t){const r={},s=[...Object.keys(e),...Object.keys(t)];for(const i of s){const s=e[i],a=t[i];"object"==typeof s&&"object"==typeof a?JSON.stringify(s)!==JSON.stringify(a)&&(r[i]=a):s!==a&&(r[i]=a)}return r}UpdateCellStyle(e,t,r=!0){const{row:s,column:i}=e;this.cell_style[i]||(this.cell_style[i]=[]);const a=this.CompositeStyleForCell(e,!1,!1),n=y.Composite([this.default_style_properties,a,y.Merge(this.cell_style[i][s]||{},t,r)]),o=this.Delta(a,n);this.cell_style[i][s]=o,this.CellData(e).FlushStyle()}Invalidate(e){this.cells.Apply(this.RealArea(e),(e=>e.render_dirty=!0))}UpdateAreaStyle(e,t={},r=!0){if(e)if(e.entire_sheet)this.UpdateSheetStyle(t,r);else if(e.entire_column)for(let s=e.start.column;s<=e.end.column;s++)this.UpdateColumnStyle(s,t,r);else if(e.entire_row)for(let s=e.start.row;s<=e.end.row;s++)this.UpdateRowStyle(s,t,r);else e.Array().forEach((e=>this.UpdateCellStyle(e,t,r)))}HasCellStyle(e){return!!(this.cell_style[e.column]&&this.cell_style[e.column][e.row]||this.row_styles[e.row]||this.column_styles[e.column]||this.row_pattern.length)}NextVisibleColumn(e){for(++e;0===this.column_width_[e];e++);return e}PreviousVisibleColumn(e){for(--e;e>=0&&0===this.column_width_[e];e--);return e}NextVisibleRow(e){for(++e;0===this.row_height_[e];e++);return e}PreviousVisibleRow(e){for(--e;e>=0&&0===this.row_height_[e];e--);return e}SurroundingStyle(e){const t=[{},{},{},{},{},{},{},{},{},{}];let r=e.column+1,s=e.column-1,i=e.row+1,a=e.row-1;for(;0===this.column_width_[r];r++);for(;0===this.row_height_[i];i++);for(;s>=0&&0===this.column_width_[s];s--);for(;a>=0&&0===this.row_height_[a];a--);return s>=0&&a>=0&&(t[7]=this.CellStyleData({row:a,column:s})||{}),s>=0&&(t[4]=this.CellStyleData({row:e.row,column:s})||{},t[1]=this.CellStyleData({row:i,column:s})||{}),a>=0&&(t[8]=this.CellStyleData({row:a,column:e.column})||{},t[9]=this.CellStyleData({row:a,column:r})||{}),t[6]=this.CellStyleData({row:e.row,column:r})||{},t[2]=this.CellStyleData({row:i,column:e.column})||{},t[3]=this.CellStyleData({row:i,column:r})||{},t}CellStyleData(e){const t=this.cells.GetCell(e);if(t){if(!t.style){const r=this.GetStyleIndex(this.CompositeStyleForCell(e));t.style=this.style_map[r]}return t.style}}GetCopyStyle(e){return this.CompositeStyleForCell(e,!0,!1)}CellData(e){const t=this.cells.EnsureCell(e);if(t.rendered_type)return t;let r,i;if(t.calculated_type?(i=t.calculated,r=t.calculated_type):(i=t.value,r=t.type),!t.style){const r=this.GetStyleIndex(this.CompositeStyleForCell(e));t.style=this.style_map[r]}if(r&&null!=i)if(r===s.number)isNaN(i)?t.formatted=void 0===t.style.nan?"NaN":t.style.nan:t.formatted=this.FormatNumber(i,t.style.number_format),t.rendered_type=s.number;else if(r===s.error)t.formatted="#"+(i||"ERR?"),t.rendered_type=s.error;else if(r===s.boolean)t.formatted=i.toString().toUpperCase(),t.rendered_type=s.boolean;else if(r===s.formula&&void 0===t.calculated)t.formatted="",t.rendered_type=s.string;else if(r===s.complex){const e=i;if(isNaN(e.real)||isNaN(e.imaginary))t.formatted=void 0===t.style.nan?"NaN":t.style.nan;else{const r=S.Get(t.style.number_format||"",!0);t.formatted=r.FormatComplex(e)}t.rendered_type=s.complex}else t.formatted=this.FormatNumber(i,t.style.number_format),t.rendered_type=s.string;else t.formatted="",t.rendered_type=s.string;return t}FormatNumber(e,t=""){const r=S.Get(t).FormatParts(e);return r.length?1!==r.length||r[0].flag?r:r[0].text||"":""}SetHeaderSize(e=60,t=this.default_row_height){this.row_header_width=e,this.column_header_height=t}AutoSizeRow(e,t={}){let r=this.default_row_height;for(let s=0;s<this.cells.columns;s++){const i=this.CellData({row:e,column:s}),a=i.style;let n=i.formatted||"";if("string"!=typeof n&&(n=n.map((e=>e.text)).join("")),a&&n&&n.length){const e=n.split(/\n/),s=this.StyleFontSize(a,t);r=Math.max(r,((s||10)+9)*e.length)}}this.SetRowHeight(e,r)}AutoSizeColumn(e,t=!0){E.measurement_canvas||(E.measurement_canvas=document.createElement("canvas"));const r=E.measurement_canvas.getContext("2d");if(!r)return;let s=12;t||(s=this.GetColumnWidth(e));for(let t=0;t<this.cells.rows;t++){const i=this.CellData({row:t,column:e});let a=i.formatted||"";"string"!=typeof a&&(a=a.map((e=>e.text)).join("")),a&&a.length&&(r.font=y.Font(i.style||{}),s=Math.max(s,Math.ceil(r.measureText(a).width)+8))}this.SetColumnWidth(e,s)}GetStyle(e){return this.style_map[e]}InsertRows(t=0,r=1){if(t)for(let e=0;e<this.cells.columns;e++){const r=this.cells.GetCell({row:t-1,column:e},!1);if(r&&r.area){const s=this.cells.GetCell({row:t,column:e},!1);if(s&&s.area&&s.area.Equals(r.area))return!1}}r<0?this.cells.DeleteRows(t,-r):this.cells.InsertRows(t,r);const s={},i={};for(let e=t;e<this.cells.rows;e++)for(let t=0;t<this.cells.columns;t++){const r=this.cells.GetCell({row:e,column:t},!1);r&&(r.area&&!i[r.area.spreadsheet_label]&&(i[r.area.spreadsheet_label]=r.area),r.merge_area&&!s[r.merge_area.spreadsheet_label]&&(s[r.merge_area.spreadsheet_label]=r.merge_area))}for(const t of Object.keys(i)){const s=i[t],a=new e({row:s.start.row+r,column:s.start.column},{row:s.end.row+r,column:s.end.column});a.Iterate((e=>{this.cells.GetCell(e,!0).area=a}))}for(const i of Object.keys(s)){const a=s[i],n={row:a.start.row,column:a.start.column};a.start.row>=t&&(n.row+=r);const o=new e(n,{row:a.end.row+r,column:a.end.column});o.Iterate((e=>{this.cells.GetCell(e,!0).merge_area=o}))}const a=Object.keys(this.row_styles),n={};a.forEach((e=>{const s=Number(e);s<t?n[s]=this.row_styles[s]:r<0&&s<t-r||(n[s+r]=this.row_styles[s])})),this.row_styles=n;let o=[];if(r<0)o=[t,-r];else{o=[t,0];for(let e=0;e<r;e++)o.push(void 0)}return this.cell_style.forEach((e=>{e&&e.length>=t&&e.splice.apply(e,o)})),this.row_height_.splice.apply(this.row_height_,o),this.FlushCellStyles(),!0}InsertColumns(t=0,r=1){if(t)for(let e=0;e<this.cells.rows;e++){const r=this.cells.GetCell({row:e,column:t-1},!1);if(r&&r.area){const s=this.cells.GetCell({row:e,column:t},!1);if(s&&s.area&&s.area.Equals(r.area))return!1}}r<0?this.cells.DeleteColumns(t,-r):this.cells.InsertColumns(t,r);const s={},i={};for(let e=t;e<this.cells.columns;e++)for(let t=0;t<this.cells.rows;t++){const r=this.cells.GetCell({row:t,column:e},!1);r&&(r.area&&!i[r.area.spreadsheet_label]&&(i[r.area.spreadsheet_label]=r.area),r.merge_area&&!s[r.merge_area.spreadsheet_label]&&(s[r.merge_area.spreadsheet_label]=r.merge_area))}for(const t of Object.keys(i)){const s=i[t],a=new e({row:s.start.row,column:s.start.column+r},{row:s.end.row,column:s.end.column+r});a.Iterate((e=>{this.cells.GetCell(e,!0).area=a}))}for(const i of Object.keys(s)){const a=s[i],n={row:a.start.row,column:a.start.column};a.start.column>=t&&(n.column+=r);const o=new e(n,{row:a.end.row,column:a.end.column+r});o.Iterate((e=>{this.cells.GetCell(e,!0).merge_area=o}))}const a=Object.keys(this.column_styles),n={};a.forEach((e=>{const s=Number(e);s<t?n[s]=this.column_styles[s]:r<0&&s<t-r||(n[s+r]=this.column_styles[s])})),this.column_styles=n;let o=[];if(r<0)o=[t,-r];else{o=[t,0];for(let e=0;e<r;e++)o.push(void 0)}return this.cell_style.splice.apply(this.cell_style,o),this.column_width_.splice.apply(this.column_width_,o),this.FlushCellStyles(),!0}ClearArea(e){e=this.RealArea(e),this.cells.Apply(e,(e=>e.Reset()))}SetAreaValues2(e,t){e=this.RealArea(e),this.cells.SetArea(e,t)}SetArrayValue(e,t){e=this.RealArea(e),this.cells.Apply(e,(t=>t.SetArray(e)),!0),this.cells.GetCell(e.start,!0).SetArrayHead(e,t)}SetCellValue(e,t){this.cells.GetCell(e,!0).Set(t)}RealArea(t,r=!1){const s=t.start,i=t.end;return t.entire_row&&(s.column=0,s.absolute_column=!1,i.column=this.cells.columns-1,i.absolute_column=!1),t.entire_column&&(s.row=0,s.absolute_row=!1,i.row=this.cells.rows-1,i.absolute_row=!1),r&&(i.row>=this.rows&&(i.row=this.rows-1,i.absolute_row=!1),i.column>=this.columns&&(i.column=this.columns-1,i.absolute_column=!1)),new e(s,i)}FormattedCellValue(e){const t=this.CellData(e);if(t)return"string"==typeof t.formatted?t.formatted:t.formatted?t.formatted.map((e=>{switch(e.flag){case 1:case 2:return" ";default:return e.text}})).join(""):t.value}GetFormattedRange(e,t=e){if(e.row===t.row&&e.column===t.column)return this.FormattedCellValue(e);const r=[];for(let s=e.row;s<=t.row;s++){const i=[];for(let r=e.column;r<=t.column;r++)i.push(this.FormattedCellValue({row:s,column:r}));r.push(i)}return r}NumberFormatsAndColors(e,t){const r=r=>{var s,i,a,n,o,l;r.number_format&&(t[r.number_format]=1),(null===(s=r.text)||void 0===s?void 0:s.text)&&"none"!==r.text.text&&(e[r.text.text]=1),(null===(i=r.fill)||void 0===i?void 0:i.text)&&(e[r.fill.text]=1),(null===(a=r.border_top_fill)||void 0===a?void 0:a.text)&&(e[r.border_top_fill.text]=1),(null===(n=r.border_left_fill)||void 0===n?void 0:n.text)&&(e[r.border_left_fill.text]=1),(null===(o=r.border_right_fill)||void 0===o?void 0:o.text)&&(e[r.border_right_fill.text]=1),(null===(l=r.border_bottom_fill)||void 0===l?void 0:l.text)&&(e[r.border_bottom_fill.text]=1)};r(this.sheet_style);for(const e in this.row_styles)r(this.row_styles[e]);for(const e in this.column_styles)r(this.column_styles[e]);for(const e of this.row_pattern)r(e);for(const e of this.cell_style)if(e)for(const t of e)t&&r(t)}toJSON(e={}){var t;const r=(e,t)=>{const r={};for(let s=0;s<e.length;s++)void 0!==e[s]&&e[s]!==t&&(r[s]=e[s]);if(Object.keys(r).length)return r};let s=[{}];const i={},a=[],n=JSON.stringify({});for(let e=0;e<this.cell_style.length;e++){const t=this.cell_style[e];if(t){a[e]=[];for(let r=0;r<t.length;r++)if(t[r]){const o=JSON.stringify(t[r]);if(o!==n){let n=i[o];"number"!=typeof n&&(i[o]=n=s.length,s.push(t[r])),a[e][r]=n}}}}s=JSON.parse(JSON.stringify(s));const o=JSON.parse(JSON.stringify(this.sheet_style)),l=JSON.parse(JSON.stringify(this.row_styles)),u=JSON.parse(JSON.stringify(this.column_styles)),h=JSON.parse(JSON.stringify(this.row_pattern)),c=(e={},t={})=>{const r=Object.assign(Object.assign({},t),e);return r.text?(r.text=k.MeasureColorARGB(r.text),r):"number"==typeof r.theme?r:void 0};if(e.export_colors){const e=[];for(const t of[l,u,s,[o],h])if(Array.isArray(t))for(const r of t)e.push(r);else for(const r of Object.keys(t))e.push(t[r]);for(const r of e)r.border_top_fill=c(r.border_top_fill,y.DefaultProperties.border_top_fill),r.border_left_fill=c(r.border_left_fill,y.DefaultProperties.border_top_fill),r.border_right_fill=c(r.border_right_fill,y.DefaultProperties.border_top_fill),r.border_bottom_fill=c(r.border_bottom_fill,y.DefaultProperties.border_top_fill),(null===(t=r.fill)||void 0===t?void 0:t.text)&&(r.fill.text=k.MeasureColorARGB(r.fill.text)),r.text&&r.text.text&&"none"!==r.text.text&&(r.text.text=k.MeasureColorARGB(r.text.text))}const d={calculated_value:!!e.rendered_values,preserve_type:!!e.preserve_type,expand_arrays:!!e.expand_arrays,decorated_cells:!!e.decorated_cells,nested:!0,cell_style_refs:a},m=this.cells.toJSON(d),f=m.data;let{rows:p,columns:_}=m;e.shrink?(p+=2,_+=1):(p=this.rows,_=this.columns);for(const e of this.annotations)e.extent||this.CalculateAnnotationExtent(e),e.extent&&(p=Math.max(p,e.extent.row+1),_=Math.max(_,e.extent.column+1));const g=[];for(let e=0;e<a.length;e++){const t=a[e];if(t)for(let r=0;r<t.length;r++)t[r]&&g.push({row:r,column:e,ref:t[r]})}const v={id:this.id,name:this.name,data:f,sheet_style:o,rows:p,columns:_,cell_styles:g,cell_style_refs:s,row_style:l,column_style:u,row_pattern:h.length?h:void 0,default_row_height:this.default_row_height,default_column_width:this.default_column_width,row_height:r(this.row_height_,this.default_row_height),column_width:r(this.column_width_,this.default_column_width),selection:JSON.parse(JSON.stringify(this.selection)),annotations:JSON.parse(JSON.stringify(this.annotations))};return this.visible||(v.visible=this.visible),(this.scroll_offset.x||this.scroll_offset.y)&&(v.scroll=this.scroll_offset),(this.freeze.rows||this.freeze.columns)&&(v.freeze=this.freeze),v}FlushCellStyles(){this.style_map=[],this.style_json_map=[],this.cells.FlushCellStyles()}ImportData(t){const r=t.styles,s=t.sheet_style;s&&this.UpdateAreaStyle(new e({row:1/0,column:1/0},{row:1/0,column:1/0}),r[s]);const i=t.column_styles;if(i)for(let t=0;t<i.length;t++)i[t]&&this.UpdateAreaStyle(new e({row:1/0,column:t},{row:1/0,column:t}),r[i[t]]);this.cells.FromJSON(t.cells),t.name&&(this.name=t.name||"");const a=this.cell_style;for(const e of t.cells)e.style_ref&&(a[e.column]||(a[e.column]=[]),a[e.column][e.row]=r[e.style_ref]);for(let e=0;e<t.column_widths.length;e++)void 0!==t.column_widths[e]&&this.SetColumnWidth(e,t.column_widths[e]);for(let e=0;e<t.row_heights.length;e++)void 0!==t.row_heights[e]&&this.SetRowHeight(e,t.row_heights[e]);for(const e of t.annotations||[])this.annotations.push(new P(e));t.hidden&&(this.visible=!1)}CalculateAnnotationExtent(e){var t,r;if(e.layout)return void(e.extent=Object.assign({},e.layout.br.address));e.extent={row:0,column:0};let s=null===(t=e.rect)||void 0===t?void 0:t.right;if(s&&this.default_column_width)for(let t=0;s>=0&&t<1e3;t++)if(s-=this.GetColumnWidth(t),s<0){e.extent.column=t;break}let i=null===(r=e.rect)||void 0===r?void 0:r.bottom;if(i&&this.default_row_height)for(let t=0;i>=0&&t<1e3;t++)if(i-=this.GetRowHeight(t),i<0){e.extent.row=t;break}}UpdateSheetStyle(e,t=!0){this.sheet_style=y.Merge(this.sheet_style,e,t);const r=Object.keys(e);for(const e of this.cell_style)if(e)for(const t of e)t&&r.forEach((e=>delete t[e]));for(const e of Object.keys(this.row_styles))r.forEach((t=>delete this.row_styles[e][t]));for(const e of Object.keys(this.column_styles))r.forEach((t=>delete this.column_styles[e][t]));this.FlushCellStyles()}UpdateRowStyle(t,r,s=!0){this.row_styles[t]=y.Merge(this.row_styles[t]||{},r,s);const i=Object.keys(r);for(const e of this.cell_style)e&&e[t]&&i.forEach((r=>delete e[t][r]));for(let e=0;e<this.cells.columns;e++)if(this.column_styles[e]){const s=this.column_styles[e],a=this.cell_style[e]&&this.cell_style[e][t]||{};for(const e of i)void 0!==s[e]&&(a[e]=r[e]);Object.keys(a).length&&(this.cell_style[e]||(this.cell_style[e]=[]),this.cell_style[e][t]=JSON.parse(JSON.stringify(a)))}this.cells.Apply(this.RealArea(e.FromRow(t)),(e=>e.FlushStyle()))}FlattenStyles(){this.CompositeStyleForCell}UpdateColumnStyle(t,r,s=!0){this.column_styles[t]=y.Merge(this.column_styles[t]||{},r,s);const i=Object.keys(r);if(this.cell_style[t])for(const e of this.cell_style[t])e&&i.forEach((t=>delete e[t]));this.cells.Apply(this.RealArea(e.FromColumn(t)),(e=>e.FlushStyle()))}CompositeStyleForCell(e,t=!0,r=!0){const{row:s,column:i}=e,a=[this.default_style_properties,this.sheet_style];return r&&this.row_pattern.length&&a.push(this.row_pattern[s%this.row_pattern.length]),this.row_styles[s]&&a.push(this.row_styles[s]),this.column_styles[i]&&a.push(this.column_styles[i]),t&&this.cell_style[i]&&this.cell_style[i][s]&&a.push(this.cell_style[i][s]),y.Composite(a)}GetStyleIndex(e){const t=JSON.stringify(e);for(let e=0;e<this.style_json_map.length;e++)if(t===this.style_json_map[e])return e;const r=this.style_map.length;return this.style_map.push(JSON.parse(t)),this.style_json_map.push(t),r}}E.base_id=100,E.default_sheet_name="Sheet1";class T{constructor(){this.forward={},this.backward=[]}Count(){return this.backward.length}Serialize(){return JSON.parse(JSON.stringify(this.Map()))}Deserialize(t){if(this.Reset(),t){for(const r of Object.keys(t))this.SetName(r,new e(t[r].start,t[r].end),!1);this.RebuildList()}}MatchSelection(e,t){if(!e.start.sheet_id)throw new Error("match selection without sheet id");let r;for(const s of this.List())if(s.range.start.sheet_id===e.start.sheet_id&&(s.range.Equals(e)&&(r=s.name),null==t?void 0:t.Equals(s.range)))return s.name;return r}SetName(e,t,r=!0){const s=this.ValidateNamed(e);return s?t.entire_column||t.entire_row?(console.warn("invalid range"),!1):(this.forward[s]=t,r&&this.RebuildList(),!0):(console.warn("invalid name"),!1)}SetNames(t){for(const r of Object.keys(t)){const s=t[r];this.SetName(r,new e(s.start,s.end),!1)}this.RebuildList()}ClearName(e,t=!0){delete this.forward[e],t&&this.RebuildList()}Reset(){this.forward={},this.backward=[]}Get(e){return this.forward[e.toUpperCase()]}Map(){return this.forward}List(){return this.backward}ValidateNamed(e){return!!(e=e.trim()).length&&!/^[A-Za-z]{1,3}\d+$/.test(e)&&!/[^A-Za-z\d_.]/.test(e)&&!/^[^A-Za-z_]/.test(e)&&e.toUpperCase()}PatchNamedRanges(t,r,s,i){const a=this.List().slice(0);for(const n of a){const a=n.name,o=n.range;if(r&&t<=o.end.column)if(r>0)t<=o.start.column?o.Shift(0,r):t>o.start.column&&t<=o.end.column?o.ConsumeAddress({row:o.end.row,column:o.end.column+r}):console.warn("PNR X case 1",t,r,JSON.stringify(o));else if(r<0)if(t-r<=o.start.column)o.Shift(0,r);else if(t<=o.start.column&&t-r>o.end.column)this.ClearName(a,!1);else if(t<=o.start.column){const s=t-r-1;this.SetName(a,new e({row:o.start.row,column:s+1+r},{row:o.end.row,column:o.end.column+r}),!1)}else t<=o.end.column?t-r-1>=o.end.column?this.SetName(a,new e({row:o.start.row,column:o.start.column},{row:o.end.row,column:t-1}),!1):this.SetName(a,new e({row:o.start.row,column:o.start.column},{row:o.end.row,column:o.start.column+o.columns+r-1}),!1):console.warn("PNR X case 2",t,r,JSON.stringify(o));if(i&&s<=o.end.row)if(i>0)s<=o.start.row?o.Shift(i,0):s>o.start.row&&s<=o.end.row?o.ConsumeAddress({row:o.end.row+i,column:o.end.column}):console.warn("PNR X case 3",s,i,JSON.stringify(o));else if(i<0)if(s-i<=o.start.row)o.Shift(i,0);else if(s<=o.start.row&&s-i>o.end.row)this.ClearName(a,!1);else if(s<=o.start.row){const t=s-i-1;this.SetName(a,new e({column:o.start.column,row:t+1+i},{column:o.end.column,row:o.end.row+i}),!1)}else s<=o.end.row?s-i-1>=o.end.row?this.SetName(a,new e({column:o.start.column,row:o.start.row},{column:o.end.column,row:s-1}),!1):this.SetName(a,new e({column:o.start.column,row:o.start.row},{column:o.end.column,row:o.start.row+o.rows+i-1}),!1):console.warn("PNR X case 4",s,i,JSON.stringify(o))}this.RebuildList()}RebuildList(){this.backward=[];for(const e of Object.keys(this.forward))this.backward.push({name:e,range:this.forward[e]})}}var F,O;!function(e){e.Comma=",",e.Semicolon=";"}(F||(F={})),function(e){e.Period=".",e.Comma=","}(O||(O={}));const L=/[\s-+=<>!()]/,I=48,U={"==":6,"!=":6,"<>":6,"=":6,"<":7,">":7,"<=":7,">=":7,"+":9,"-":9,"&":9,"*":10,"/":10,"^":11,":":13},V=Object.keys(U).sort(((e,t)=>t.length-e.length)),j={"-":100,"+":100};class G{constructor(){this.argument_separator=F.Comma,this.decimal_mark=O.Period,this.argument_separator_char=44,this.decimal_mark_char=46,this.imaginary_char=105,this.imaginary_number="i",this.id_counter=0,this.expression="",this.data=[],this.index=0,this.length=0,this.valid=!0,this.dependencies={addresses:{},ranges:{}},this.address_refcount={},this.full_reference_list=[]}Walk(e,t){switch(e.type){case"address":case"missing":case"literal":case"complex":case"identifier":case"operator":return void t(e);case"range":return void(t(e)&&(this.Walk(e.start,t),this.Walk(e.end,t)));case"binary":return void(t(e)&&(this.Walk(e.left,t),this.Walk(e.right,t)));case"unary":return void(t(e)&&this.Walk(e.operand,t));case"group":return void(t(e)&&e.elements.forEach((e=>this.Walk(e,t))));case"call":t(e)&&e.args.forEach((e=>this.Walk(e,t)))}}Transpose(e){const t=e.length,r=[];let s=0;for(let r=0;r<t;r++)Array.isArray(e[r])&&(s=Math.max(s,e[r].length));for(let i=0;i<s;i++){r[i]=[];for(let s=0;s<t;s++)r[i][s]=e[s][i]}return r}Render(e,t={rows:0,columns:0},r="(missing)",s,i,a){let n=this.argument_separator+" ";i===F.Comma?n=", ":i===F.Semicolon&&(n="; ");let o=this.imaginary_number;a&&(o=a);const l=s===O.Comma?",":".",u=this.decimal_mark===O.Comma?/,/:/\./;switch(e.type){case"address":return this.AddressLabel(e,t);case"range":return this.AddressLabel(e.start,t)+":"+this.AddressLabel(e.end,t);case"missing":return r;case"array":return"{"+this.Transpose(e.values).map((e=>e.map((e=>"string"==typeof e?'"'+e+'"':e)).join(", "))).join("; ")+"}";case"binary":return this.Render(e.left,t,r,s,i)+" "+e.operator+" "+this.Render(e.right,t,r,s,i);case"unary":return e.operator+this.Render(e.operand,t,r,s,i);case"complex":if(e.real){const t=Math.abs(e.imaginary);return`${e.real||0}${e.imaginary<0?" - ":" + "}${1===t?"":t}i`}return-1===e.imaginary?"-i":1===e.imaginary?"i":`${e.imaginary}i`;case"literal":if("string"==typeof e.value)return'"'+e.value.replace(/"/g,'""')+'"';if(s&&"number"==typeof e.value){if(e.text){let t=e.text;return s===O.Comma&&this.decimal_mark===O.Period&&(t=t.replace(/,/g,"")),t.replace(u,l)}return e.value.toString().replace(/\./,l)}return e.text?e.text:e.value.toString();case"identifier":return e.name;case"operator":return"["+e.operator+"]";case"group":return e.explicit?"("+e.elements.map((e=>this.Render(e,t,r,s,i))).join(n)+")":e.elements.map((e=>this.Render(e,t,r,s,i))).join(n);case"call":return e.name+"("+e.args.map((e=>this.Render(e,t,r,s,i))).join(n)+")"}return"??"}Parse(e){switch("="===(e=e.trim())[0]&&(e=e.substr(1).trim()),this.expression=e,this.data=[],this.length=e.length,this.index=0,this.valid=!0,this.error_position=void 0,this.error=void 0,this.dependencies.addresses={},this.dependencies.ranges={},this.address_refcount={},this.full_reference_list=[],this.id_counter=0,this.argument_separator){case F.Semicolon:this.argument_separator_char=59;break;default:this.argument_separator_char=44}switch(this.decimal_mark){case O.Comma:this.decimal_mark_char=44;break;default:this.decimal_mark_char=46}for(let t=0;t<this.length;t++)this.data[t]=e.charCodeAt(t);const t=this.ParseGeneric(),r={};for(const e of Object.keys(this.dependencies.addresses))this.address_refcount[e]&&(r[e]=this.dependencies.addresses[e]);return this.dependencies.addresses=r,{expression:t||void 0,valid:this.valid,error:this.error,error_position:this.error_position,dependencies:this.dependencies,separator:this.argument_separator,decimal_mark:this.decimal_mark,full_reference_list:this.full_reference_list.slice(0)}}ColumnLabel(e){if(e===1/0)return"";let t=String.fromCharCode(65+e%26);for(;e>25;)e=Math.floor(e/26)-1,t=String.fromCharCode(65+e%26)+t;return t}AddressLabel(e,t){let r=e.column;e.absolute_column||e.column===1/0||(r+=t.columns);let s=e.row;if(e.absolute_row||e.row===1/0||(s+=t.rows),s<0||r<0||s===1/0&&r===1/0)return"#REF";let i="";return e.sheet&&(i=(L.test(e.sheet)?"'"+e.sheet+"'":e.sheet)+"!"),s===1/0?i+(e.absolute_column?"$":"")+this.ColumnLabel(r):r===1/0?i+(e.absolute_row?"$":"")+(s+1):i+(e.absolute_column?"$":"")+this.ColumnLabel(r)+(e.absolute_row?"$":"")+(s+1)}ParseGeneric(e=[0]){let t=[];for(;this.index<this.length;){const r=this.ParseNext(0===t.length);if("number"==typeof r){if(e.some((e=>r===e)))break;if(40===r){this.index++;const e=this.ParseGeneric([41]);this.index++,e&&t.push({type:"group",id:this.id_counter++,elements:[e],explicit:!0})}else{const e=this.ConsumeOperator();e?t.push(e):(this.error=`unexpected character [1]: ${String.fromCharCode(r)}, ${r}`,this.valid=!1,this.index++)}}else t.push(r)}return t.length&&(t=this.BinaryToRange2(t),t=t.map((e=>"identifier"===e.type&&e.name===this.imaginary_number?{type:"complex",real:0,imaginary:1,position:e.position,text:e.name,id:this.id_counter++}:e))),0===t.length?null:1===t.length?t[0]:this.BinaryToComplex(this.ArrangeUnits(t))}UnitToAddress(e){if("literal"===e.type){if("number"==typeof e.value&&e.value>0&&!/\./.test(e.text||""))return{type:"address",position:e.position,label:e.value.toString(),row:e.value-1,id:this.id_counter++,column:1/0}}else{let t,r=e.name;const s=r.split("!");if(s.length>1&&(t=s.slice(0,s.length-1).join("!"),r=r.substr(t.length+1),"'"===t[0])){if(!(t.length>1&&"'"===t[t.length-1]))return;t=t.substr(1,t.length-2)}const i="$"===r[0];r=(i?r.substr(1):r).toUpperCase();const a=Number(r);if(isNaN(a)){if(/[A-Z]{1,3}/.test(r)){let s=-1;for(let e=0;e<r.length;e++)s=26*(1+s)+(r[e].charCodeAt(0)-65);return{type:"address",position:e.position,absolute_column:i,label:e.name,column:s,id:this.id_counter++,row:1/0,sheet:t}}}else if(a>0&&a!==1/0&&!/\./.test(r))return{type:"address",position:e.position,absolute_row:i,label:e.name,row:a-1,id:this.id_counter++,column:1/0,sheet:t}}}BinaryToRange2(e){const t=[];for(let r=0;r<e.length;r++){const s=e[r],i=e[r+1],a=e[r+2];let n,o,l="";if(s&&i&&a&&"operator"===i.type&&":"===i.operator)if("address"===s.type&&"address"===a.type){const e=s.position+s.label.length,t=a.position;n={type:"range",id:this.id_counter++,position:s.position,start:s,end:a,label:s.label+this.expression.substring(e,t)+a.label},l=n.start.label+":"+n.end.label,this.address_refcount[n.start.label]--,this.address_refcount[n.end.label]--;const r=[s.position,a.position];this.full_reference_list=this.full_reference_list.filter((e=>e.position!==r[0]&&e.position!==r[1]))}else if(!("literal"!==s.type&&"identifier"!==s.type||"literal"!==a.type&&"identifier"!==a.type)){let e=this.UnitToAddress(s);if(!e&&"literal"===s.type&&"number"==typeof s.value&&s.value<0){const t=Object.assign(Object.assign({},s),{text:(s.text||"").replace(/^-/,""),position:s.position+1,value:-s.value});e=this.UnitToAddress(t),e&&(o={type:"operator",operator:"-",position:s.position,id:this.id_counter++})}const t=this.UnitToAddress(a);e&&t&&(e.column===1/0&&t.column===1/0||e.row===1/0&&t.row===1/0)&&(l=e.label+":"+t.label,n={type:"range",id:this.id_counter++,position:e.position,start:e,end:t,label:l})}n?(o&&t.push(o),t.push(n),this.dependencies.ranges[l]=n,this.full_reference_list.push(n),r+=2):t.push(s)}return t}BinaryToComplex(e){var t;if("binary"===e.type){if(!("+"!==e.operator&&"-"!==e.operator||"literal"!==e.left.type||"number"!=typeof e.left.value||"complex"!==e.right.type||e.right.composited)){let r="";r=this.expression.substring(e.left.position,e.right.position+((null===(t=e.right.text)||void 0===t?void 0:t.length)||0));let s=e.right.imaginary;return"-"===e.operator&&(s=-s),{type:"complex",position:e.left.position,text:r,id:this.id_counter++,imaginary:s,real:e.left.value,composited:!0}}e.left=this.BinaryToComplex(e.left),e.right=this.BinaryToComplex(e.right)}else if("unary"===e.type&&("-"===e.operator||"+"===e.operator)&&"complex"===e.operand.type&&e.operand.text===this.imaginary_number)return Object.assign(Object.assign({},e.operand),{position:e.position,text:this.expression.substring(e.position,e.operand.position+(e.operand.text||"").length),imaginary:e.operand.imaginary*("-"===e.operator?-1:1)});return e}BinaryToRangeX(e){if("binary"===e.type){if(":"===e.operator){let t,r="";if("address"===e.left.type&&"address"===e.right.type){const s=e.left.position+e.left.label.length,i=e.right.position;t={type:"range",id:this.id_counter++,position:e.left.position,start:e.left,end:e.right,label:e.left.label+this.expression.substring(s,i)+e.right.label},r=t.start.label+":"+t.end.label,this.address_refcount[t.start.label]--,this.address_refcount[t.end.label]--;const a=[e.left.position,e.right.position];this.full_reference_list=this.full_reference_list.filter((e=>e.position!==a[0]&&e.position!==a[1]))}else if(!("literal"!==e.left.type&&"identifier"!==e.left.type||"literal"!==e.right.type&&"identifier"!==e.right.type)){const s=this.UnitToAddress(e.left),i=this.UnitToAddress(e.right);s&&i&&(s.column===1/0&&i.column===1/0||s.row===1/0&&i.row===1/0)&&(r=s.label+":"+i.label,t={type:"range",id:this.id_counter++,position:e.left.position,start:s,end:i,label:r})}if(t)return this.dependencies.ranges[r]=t,this.full_reference_list.push(t),t;this.error="unexpected character: :",this.valid=!1}e.left=this.BinaryToRangeX(e.left),e.right=this.BinaryToRangeX(e.right)}return e}ArrangeUnits(e){if(0===e.length)return{type:"missing",id:this.id_counter++};if(1===e.length)return e[0];const t=[];for(let r=0;r<e.length;r++){let s=e[r];if("operator"===s.type){if(0!==t.length&&"operator"!==t[t.length-1].type){t.push(s);continue}if(!j[s.operator])return this.error=`unexpected character [2]: ${s.operator}`,this.error_position=s.position,this.valid=!1,{type:"group",id:this.id_counter++,elements:e,explicit:!1};{const t=this.BinaryToComplex(this.ArrangeUnits(e.slice(r+1)));if(!this.valid)return{type:"group",id:this.id_counter++,elements:e,explicit:!1};"binary"===t.type?(t.left={type:"unary",id:this.id_counter++,operator:s.operator,operand:t.left,position:s.position},s=t):s={type:"unary",id:this.id_counter++,operator:s.operator,operand:t,position:s.position},r=e.length}}if(t.length<2)t.push(s);else{if("operator"!==t[t.length-1].type)return this.error="multiple expressions",this.error_position=s.position,this.valid=!1,{type:"group",id:this.id_counter++,elements:e,explicit:!1};{const e=t[t.length-2],r=t[t.length-1],i=r.operator,a={type:"binary",id:this.id_counter++,left:e,operator:i,position:r.position,right:s};"binary"===e.type&&U[i]>U[e.operator]&&(a.left=e.left,a.operator=e.operator,a.position=e.position,a.right={type:"binary",id:this.id_counter++,left:e.right,right:s,operator:i,position:r.position}),t.splice(-2,2,a)}}}return t[0]}ParseNext(e=!0){this.ConsumeWhiteSpace();const t=this.data[this.index];if(34===t)return{type:"literal",id:this.id_counter++,position:this.index,value:this.ConsumeString()};if(t>=I&&t<=57||t===this.decimal_mark_char)return this.ConsumeNumber();if(123===t)return this.ConsumeArray();if(!e||45!==t&&43!==t){if(t>=65&&t<=90||t>=97&&t<=122||95===t||39===t||36===t||t>=192&&t<=312)return this.ConsumeToken(t)}else{const e=this.data[this.index+1];if(e>=I&&e<=57||e===this.decimal_mark_char)return this.ConsumeNumber()}return t}ConsumeArray(){const e={type:"array",id:this.id_counter++,values:[],position:this.index};this.index++;let t=0,r=0;for(;this.index<this.length;){const s=this.ParseNext(),i=this.index;if("number"==typeof s)switch(this.index++,s){case 59:r++,t=0;break;case 44:t++;break;case 125:return e;default:this.valid&&(this.error="invalid character in array literal",this.error_position=i,this.valid=!1)}else switch(s.type){case"literal":e.values[t]||(e.values[t]=[]),e.values[t][r]=s.value;break;default:this.valid&&(this.error="invalid value in array literal",this.error_position=i,this.valid=!1)}}return e}ConsumeOperator(){for(const e of V)if(this.expression.substr(this.index,e.length)===e){const t=this.index;return this.index+=e.length,{type:"operator",id:this.id_counter++,operator:e,position:t}}return null}ConsumeArguments(){this.index++;let e=0;const t=[];for(;this.index<this.length;){const r=this.ParseGeneric([this.argument_separator_char,41]);null!==r&&t.push(r);const s=this.data[this.index];if(s===this.argument_separator_char){this.index++,e++;for(let r=t.length;r<e;r++)t.push({type:"missing",id:this.id_counter++})}else if(41===s)return this.index++,t}return t}ConsumeToken(e){const t=[e],r=this.index;let s=39===e;for(++this.index;this.index<this.length;this.index++){const e=this.data[this.index];if(!(e>=65&&e<=90||e>=97&&e<=122||e>=192&&e<=312||95===e||36===e||46===e||33===e||s||e>=I&&e<=57))break;t.push(e),39===e&&(s=!1)}const i=t.map((e=>String.fromCharCode(e))).join("");if(s)return this.error="unbalanced single quote",this.error_position=r,this.valid=!1,{type:"identifier",id:this.id_counter++,name:i,position:r};if("true"===i.toLowerCase())return{type:"literal",id:this.id_counter++,value:!0,position:r};if("false"===i.toLowerCase())return{type:"literal",id:this.id_counter++,value:!1,position:r};if(this.ConsumeWhiteSpace(),40===this.data[this.index]){const e=this.ConsumeArguments();return{type:"call",id:this.id_counter++,name:i,args:e,position:r}}const a=this.ConsumeAddress(i,r);if(a)return a;const n={type:"identifier",id:this.id_counter++,name:i,position:r};return this.full_reference_list.push(n),n}ConsumeAddress(e,t){const r=t,s=e.length;let i;const a=e.split("!");a.length>1&&(i=a.slice(0,a.length-1).join("!"),t+=i.length+1);const n=this.ConsumeAddressColumn(t);if(!n)return null;t=n.position;const o=this.ConsumeAddressRow(t);if(!o)return null;t=o.position;const l=i?i+e.substr(i.length,t-r).toUpperCase():e.substr(0,t-r).toUpperCase();i&&"'"===i[0]&&(i=i.substr(1,i.length-2));const u={type:"address",id:this.id_counter++,label:l,row:o.row,column:n.column,absolute_row:o.absolute,absolute_column:n.absolute,position:r,sheet:i};return s!==t-r?null:(this.dependencies.addresses[u.label]=u,this.address_refcount[u.label]=(this.address_refcount[u.label]||0)+1,this.full_reference_list.push(u),u)}ConsumeAddressRow(e){const t=36===this.data[e];t&&e++;const r=e;let s=0;for(;;e++){const t=this.data[e];if(!(t>=I&&t<=57))break;s*=10,s+=t-I}return r!==e&&{absolute:t,row:s-1,position:e}}ConsumeAddressColumn(e){let t=-1,r=0;const s=36===this.data[e];for(s&&e++;;e++,r++){if(r>=4)return!1;const s=this.data[e];if(s>=65&&s<=90)t=26*(1+t)+(s-65);else{if(!(s>=97&&s<=122))break;t=26*(1+t)+(s-97)}}return!(t<0)&&{absolute:s,column:t,position:e}}ConsumeNumber(){const e=this.index;let t=0,r=!1,s=!1,i=0,a=0,n=0,o="integer",l=0,u=!1;const h=this.index;for(;this.index<this.length;this.index++,l++){const e=this.data[this.index];if(e===this.decimal_mark_char){if("integer"!==o)break;o="fraction"}else{if(37===e){i/=100,n/=100,this.index++;break}if(43===e||45===e){if(0!==l)break;45===e&&(s=!0)}else if(69===e||101===e){if("integer"!==o&&"fraction"!==o)break;o="exponent",this.index<this.length-1&&(43===this.data[this.index+1]?this.index++:45===this.data[this.index+1]&&(this.index++,r=!0))}else if(e===this.imaginary_char){if("integer"===o||"fraction"===o){this.index++,u=!0;break}}else{if(!(e>=I&&e<=57))break;switch(o){case"integer":i=10*i+(e-I);break;case"fraction":n=10*n+(e-I),a++;break;case"exponent":t=10*t+(e-I)}}}}let c=i+n/Math.pow(10,a);return"exponent"===o&&(c*=Math.pow(10,(r?-1:1)*t)),u?{type:"complex",id:this.id_counter++,position:e,imaginary:s?-c:c,real:0,text:this.expression.substring(h,this.index)||""}:{type:"literal",id:this.id_counter++,position:e,value:s?-c:c,text:this.expression.substring(h,this.index)||""}}ConsumeString(){this.index++;const e=[];for(;this.index<this.length;this.index++){const t=this.data[this.index];if(34===t&&(this.index++,this.index>=this.length||34!==this.data[this.index]))break;e.push(t)}return e.map((e=>String.fromCharCode(e))).join("")}ConsumeWhiteSpace(){for(;this.index<this.length;){const e=this.data[this.index];if(32!==e&&9!==e&&10!==e&&13!==e&&160!==e)return;this.index++}}}var B,z,J,q,H,$;!function(e){e[e.default=0]="default",e[e.quoted=1]="quoted"}(B||(B={})),($=z||(z={}))[$.white=0]="white",$[$.gray=1]="gray",$[$.black=2]="black";class Z{constructor(){this.type=Z.type,this.color=z.white,this.edges_in=[],this.edges_out=[]}get has_inbound_edges(){return this.edges_in.length>0}get has_outbound_edges(){return this.edges_out.length>0}Reset(){for(const e of this.edges_out)e.RemoveDependency(this);for(const e of this.edges_in)e.RemoveDependent(this);this.edges_out=[],this.edges_in=[]}ClearDependencies(){for(const e of this.edges_in)e.RemoveDependent(this);this.edges_in=[]}AddDependent(e){if(e!==this){for(const t of this.edges_out)if(t===e)return;this.edges_out.push(e)}}RemoveDependent(e){this.edges_out=this.edges_out.filter((t=>t!==e))}AddDependency(e){if(e!==this){for(const t of this.edges_in)if(t===e)return;this.edges_in.push(e)}}RemoveDependency(e){this.edges_in=this.edges_in.filter((t=>t!==e))}LinkTo(e){this.AddDependent(e),e.AddDependency(this)}DependsOn(e){this.AddDependency(e),e.AddDependent(this)}LoopCheck(){this.color=z.gray;const e=[this];for(;e.length;){const t=e[e.length-1];let r=!0;if(t.color!==z.black)for(const s of t.edges_out){if(s.color===z.gray)return this.color=z.white,!0;s.color===z.white&&(s.color=z.gray,e.push(s),r=!1)}r&&(e.pop(),t.color=z.black)}return this.color=z.black,!1}}Z.type="vertex";class W extends Z{constructor(){super(...arguments),this.dirty=!1}}!function(e){e[e.None=0]="None",e[e.CalculationError=1]="CalculationError"}(J||(J={}));class Q extends W{constructor(){super(...arguments),this.error=J.None,this.result=u(),this.expression={type:"missing",id:-1},this.expression_error=!1,this.short_circuit=!1,this.type=Q.type}get array_head(){return!!this.address&&!!this.reference&&!!this.reference.area&&this.reference.area.start.column===this.address.column&&this.reference.area.start.row===this.address.row}TakeReferenceValue(){this.reference&&(this.result=h(this.reference.GetValue()))}Calculate(e){if(this.dirty)if(this.color===z.white&&this.LoopCheck()&&(this.dirty=!1,this.edges_in.length)){this.reference&&(this.array_head||this.reference.type===s.formula)&&this.reference.SetCalculationError("LOOP");for(const t of this.edges_out)t.Calculate(e)}else{for(const e of this.edges_in)if(e.dirty)return;if(this.reference){if(this.reference.type===s.formula){this.short_circuit=!1;const t=e.CalculationCallback.call(e,this);if(this.result=t.value,this.short_circuit)return;t.volatile&&e.volatile_list.push(this)}else this.result=this.reference.GetValue4();if(this.array_head)e.SpreadCallback.call(e,this,this.result);else if(this.reference.type===s.formula){const e=Array.isArray(this.result)?this.result[0][0]:this.result;this.reference.SetCalculatedValue(e.value,e.type)}}else console.info("skip dirty constant? [or dangling...]");this.dirty=!1;for(const t of this.edges_out)t.dirty&&e.calculation_list.push(t)}}}Q.type="spreadsheet-vertex";class Y extends W{constructor(e){super(),this.type=Y.type,this.area=e.Clone(),Y.list.push(this)}static GetVertex(e){for(const t of this.list)if(t.area.start.sheet_id===e.start.sheet_id&&t.area.Equals(e))return[t,!1];return[new Y(e),!0]}static Clear(){this.list=[]}static GetContainingArrays(e){const t=[];for(const r of this.list)r.area.start.sheet_id===e.sheet_id&&r.area.Contains(e)&&t.push(r);return t}static CreateImplicitEdges(e,t){for(const r of this.list)r.area.start.sheet_id===t.sheet_id&&r.area.Contains(t)&&r.DependsOn(e)}RemoveDependent(e){super.RemoveDependent(e),this.edges_out.length||(this.Reset(),Y.list=Y.list.filter((e=>e!==this)))}Calculate(e){if(this.dirty)if(this.color===z.white&&this.LoopCheck()&&(this.dirty=!1,this.edges_in.length))for(const t of this.edges_out)t.Calculate(e);else{for(const e of this.edges_in)if(e.dirty)return;this.dirty=!1;for(const t of this.edges_out)t.Calculate(e)}}}Y.type="array-vertex",Y.list=[],function(e){e[e.OK=0]="OK",e[e.Loop=1]="Loop",e[e.CalculationError=2]="CalculationError"}(q||(q={})),function(e){e.Argument="ARG",e.Data="DATA",e.Reference="REF",e.Name="NAME",e.Expression="EXPR",e.Value="VALUE",e.Unknown="UNK",e.NotImpl="NOTIMPL",e.Div0="DIV/0",e.NA="N/A"}(H||(H={}));const K={error:H.NotImpl},X=()=>({type:s.error,value:H.Expression}),ee=()=>({type:s.error,value:H.Data}),te=()=>({type:s.error,value:H.Div0}),re=()=>({type:s.error,value:H.Argument}),se=()=>({type:s.error,value:H.Value}),ie=()=>({type:s.error,value:H.Reference}),ae=()=>({type:s.error,value:H.Name}),ne=()=>({type:s.error,value:H.Unknown});var oe;!function(e){e[e.value=0]="value",e[e.reference=1]="reference"}(oe||(oe={}));const le=e=>({r:Math.sqrt(e.real*e.real+e.imaginary*e.imaginary),theta:Math.atan2(e.imaginary,e.real)}),ue=(e,t)=>({real:e.real*t.real-e.imaginary*t.imaginary,imaginary:e.real*t.imaginary+e.imaginary*t.real}),he=(e,t)=>{const r=[];for(let s=0;s<e.m;s++){const i=[];for(let r=0;r<t.n;r++){let a=0;for(let i=0;i<e.n;i++)a+=e.array[s][i]*t.array[i][r];i.push(a)}r.push(i)}return{array:r,m:e.m,n:t.n}},ce=e=>{const t={real:0,imaginary:0},r=e.n;if(2==r){const t=ue(e.array[0][0],e.array[1][1]),r=ue(e.array[1][0],e.array[0][1]);return{real:t.real-r.real,imaginary:t.imaginary-r.imaginary}}const s=(e=>{const t={m:e,n:e,array:[]};for(let r=0;r<e;r++){const r=[];for(let t=0;t<e;t++)r.push({real:0,imaginary:0});t.array.push(r)}return t})(e.n);for(let i=0;i<r;i++){let a=0;for(let t=1;t<r;t++){let n=0;for(let o=0;o<r;o++)o!=i&&(s.array[a][n]=Object.assign({},e.array[t][o]),n++);a++}s.m=s.n=r-1;const n=Math.pow(-1,i),o=ue({real:e.array[0][i].real*n,imaginary:e.array[0][i].imaginary*n},ce(s));t.real+=o.real,t.imaginary+=o.imaginary}return t},de=e=>{if(e.m!==e.n)return;const t=(e=>{const t=e.array.map((e=>e.slice(0)));return{m:e.m,n:e.n,array:t}})(e),r=t.array;var s,i,a,n,o=e.m;for(i=1;i<o;i++)r[0][i]/=r[0][0];for(i=1;i<o;i++){for(a=i;a<o;a++){for(s=0,n=0;n<i;n++)s+=r[a][n]*r[n][i];r[a][i]-=s}if(i!=o-1)for(a=i+1;a<o;a++){for(s=0,n=0;n<i;n++)s+=r[i][n]*r[n][a];r[i][a]=(r[i][a]-s)/r[i][i]}}for(i=0;i<o;i++)for(a=i;a<o;a++){var l=1;if(i!=a)for(l=0,n=i;n<a;n++)l-=r[a][n]*r[n][i];r[a][i]=l/r[a][a]}for(i=0;i<o;i++)for(a=i;a<o;a++)if(i!=a){for(s=0,n=i;n<a;n++)s+=r[n][a]*(i==n?1:r[i][n]);r[i][a]=-s}for(i=0;i<o;i++)for(a=0;a<o;a++){for(s=0,n=i>a?i:a;n<o;n++)s+=(a==n?1:r[a][n])*r[n][i];r[a][i]=s}return t},me=e=>{const t=e.real||0,r=e.imaginary||0;return ue({real:Math.exp(t),imaginary:0},{real:Math.cos(r),imaginary:Math.sin(r)})},fe=(e,t)=>{if(t.imaginary)return me(ue(t,(e=>{const t=le(e);return{real:Math.log(t.r),imaginary:t.theta}})(e)));{const r=le(e);return(e=>{const{r:t,theta:r}=e;return{real:t*Math.cos(r),imaginary:t*Math.sin(r)}})({r:Math.pow(r.r,t.real),theta:r.theta*t.real})}},pe=(e,t=0)=>e&&e.type===s.complex?e:{type:s.complex,value:{real:t,imaginary:0}},_e=e=>e.imaginary?{type:s.complex,value:e}:{type:s.number,value:e.real},ye=(e,t)=>{if(e.type===s.error)return[0,0,e];if(t.type===s.error)return[0,0,t];const r=[0,0];switch(e.type){case s.number:r[0]=e.value;break;case s.boolean:r[0]=e.value?1:0;break;case s.undefined:break;case s.complex:r[3]=e;break;default:return[0,0,se()]}switch(t.type){case s.number:r[1]=t.value;break;case s.boolean:r[1]=t.value?1:0;break;case s.undefined:break;case s.complex:r[4]=t;break;default:return[0,0,se()]}return(r[3]||r[4])&&(r[3]=pe(r[3],r[0]),r[4]=pe(r[4],r[1])),r},ge=(e,t)=>{let[r,i,a,n,o]=ye(e,t);return a||(n&&o?_e({real:n.value.real+o.value.real,imaginary:n.value.imaginary+o.value.imaginary}):{value:r+i,type:s.number})},ve=(e,t)=>{let[r,i,a,n,o]=ye(e,t);return a||(n&&o?_e({real:n.value.real-o.value.real,imaginary:n.value.imaginary-o.value.imaginary}):{value:r-i,type:s.number})},be=(e,t)=>{let[r,i,a,n,o]=ye(e,t);if(a)return a;if(n&&o)return _e(fe(n.value,o.value));const l=Math.pow(r,i);return isNaN(l)?se():{type:s.number,value:l}},we=(e,t)=>{let[r,i,a,n,o]=ye(e,t);return a||(n&&o?_e(ue(n.value,o.value)):{value:r*i,type:s.number})},xe=(e,t)=>{let[r,i,a,n,o]=ye(e,t);return a||(n&&o?0===o.value.real&&0===o.value.imaginary?te():_e(((e,t)=>{const r={real:t.real,imaginary:-t.imaginary},s=ue(e,r),i=ue(t,r);return{real:s.real/i.real,imaginary:s.imaginary/i.real}})(n.value,o.value)):0===i?te():{value:r/i,type:s.number})},Me=(e,t)=>{const[r,i,a]=ye(e,t);return a||(0===i?te():{value:r%i,type:s.number})},Ce=(e,t)=>e.type===s.error?e:t.type===s.error?t:{type:s.string,value:`${e.type===s.undefined?"":e.value}${t.type===s.undefined?"":t.value}`},Se=(e,t)=>{if(e.type===s.error)return e;if(t.type===s.error)return t;if(e.type===s.undefined&&(""===t.value||0===t.value||t.type===s.complex&&0===t.value.real&&0===t.value.complex)||t.type===s.undefined&&(""===e.value||0===e.value||e.type===s.complex&&0===e.value.real&&0===e.value.complex))return{type:s.boolean,value:!0};if(e.type===s.complex||t.type===s.complex){let r=!1;return e.type===t.type?r=e.value.real==t.value.real&&e.value.imaginary==t.value.imaginary:e.type===s.number?r=t.value.real==e.value&&!t.value.imaginary:t.type===s.number&&(r=e.value.real==t.value&&!e.value.imaginary),{type:s.boolean,value:r}}return{type:s.boolean,value:e.value==t.value}},Ae=(e,t)=>{const r=Se(e,t);return{type:s.boolean,value:!r.value}},Re=(e,t)=>e.type===s.error?e:t.type===s.error?t:e.type===s.complex||t.type===s.complex?se():{type:s.boolean,value:(e.value||0)>(t.value||0)},ke=(e,t)=>e.type===s.error?e:t.type===s.error?t:e.type===s.complex||t.type===s.complex?se():{type:s.boolean,value:e.value>=t.value},Ne=(e,t)=>e.type===s.error?e:t.type===s.error?t:e.type===s.complex||t.type===s.complex?se():{type:s.boolean,value:e.value<t.value},De=(e,t)=>e.type===s.error?e:t.type===s.error?t:e.type===s.complex||t.type===s.complex?se():{type:s.boolean,value:e.value<=t.value},Pe=e=>!Array.isArray(e)&&e.type===s.object&&!!e.value.type,Ee=e=>!Array.isArray(e)&&e.type===s.object&&"metadata"===e.value.type;class Te{constructor(e,t){this.library=e,this.parser=t,this.context={address:{row:-1,column:-1},volatile:!1,call_index:0},this.call_index=0,this.cells_map={},this.sheet_name_map={},this.named_range_map={}}SetModel(e){this.cells_map={},this.sheet_name_map={};for(const t of e.sheets)this.cells_map[t.id]=t.cells,this.sheet_name_map[t.name.toLowerCase()]=t.id;this.data_model=e,this.named_range_map=e.named_ranges.Map(),this.context.model=e}Calculate(e,t,r=!1){return r||(this.context.address=t,this.context.volatile=!1,this.context.call_index=0,this.call_index=0),{value:this.CalculateExpression(e),volatile:this.context.volatile}}CellFunction2(e){if(!e.sheet_id){if(!e.sheet)return()=>ie();e.sheet_id=this.sheet_name_map[e.sheet.toLowerCase()]}const t=this.cells_map[e.sheet_id];if(!t)return console.warn("missing cells reference @ "+e.sheet_id),()=>ie();const r=t.GetCell(e);return r?()=>r.GetValue4():()=>({type:s.undefined,value:void 0})}CellFunction4(e,t){if(!e.sheet_id)throw new Error("missing sheet id in CellFunction4");return this.cells_map[e.sheet_id].GetRange4(e,t,!0)}GetMetadata(e,t){let r,i;switch(e.type){case"address":r=e;break;case"range":i=e;break;case"identifier":{const t=this.named_range_map[e.name.toUpperCase()];t&&(1===t.count?r=t.start:i=t)}break;case"call":{const t=this.CalculateExpression(e,!0);if(!Pe(t))return t;if("address"===t.value.type)r=t.value;else{if("range"!==t.value.type)return t;i=t.value}}break;default:return this.CalculateExpression(e)}if(r){let e=this.data_model.active_sheet;if(r.sheet_id&&r.sheet_id!==e.id)for(const t of this.data_model.sheets)if(t.id===r.sheet_id){e=t;break}const i=e.CellData(r),a=i.calculated_type?i.calculated:i.value,n=Object.assign({type:"metadata",address:Object.assign({},r),value:a,format:i.style?i.style.number_format:void 0},t(i,r));return{type:s.object,value:n}}if(i){if(i.start.row===1/0||i.start.column===1/0)return ie();let e=this.data_model.active_sheet;if(i.start.sheet_id&&i.start.sheet_id!==e.id)for(const t of this.data_model.sheets)if(t.id===i.start.sheet_id){e=t;break}const a=[];for(let n=i.start.column;n<=i.end.column;n++){const o=[];for(let a=i.start.row;a<=i.end.row;a++){const l=e.CellData({row:a,column:n});r=Object.assign(Object.assign({},i.start),{row:a,column:n});const u=l.calculated_type?l.calculated:l.value,h=Object.assign({type:"metadata",address:r,value:u,format:l.style?l.style.number_format:void 0},t(l,r));o.push({type:s.object,value:h})}a.push(o)}return a}return this.CalculateExpression(e)}RewriteMacro(e,t){let r;switch(e.type){case"identifier":if(r=t[e.name.toUpperCase()],r)return JSON.parse(JSON.stringify(r));break;case"binary":e.left=this.RewriteMacro(e.left,t),e.right=this.RewriteMacro(e.right,t);break;case"unary":e.operand=this.RewriteMacro(e.operand,t);break;case"group":e.elements=e.elements.map((e=>this.RewriteMacro(e,t)));break;case"call":e.args=e.args.map((e=>this.RewriteMacro(e,t)))}return e}CallMacro(e,t){var r;if(!t.expression)return()=>X();const s=JSON.stringify(t.expression),i={},a=(null===(r=t.argument_names)||void 0===r?void 0:r.map((e=>e.toUpperCase())))||[];return e=>{const t=JSON.parse(s);for(let t=0;t<a.length;t++)i[a[t]]=e.args[t]||{type:"missing"};return this.CalculateExpression(this.RewriteMacro(t,i))}}CallExpression(e,t=!1){const r=this.library.Get(e.name);return r?i=>{const a=this.call_index++;this.context.volatile=this.context.volatile||!!r.volatile;const n="if"===e.name.toLowerCase();let o,l=-1;const h=r.arguments||[],c=i.args.map(((e,t)=>{if(o)return;const r=h[Math.min(t,h.length-1)]||{};if(t===l)return r.boxed?u():void 0;if(void 0===e)return n&&0===t&&(l=1),r.boxed?u():void 0;if(r.address)return r.boxed?{type:s.string,value:this.parser.Render(e).replace(/\$/g,"")}:this.parser.Render(e).replace(/\$/g,"");if(r.metadata)return this.GetMetadata(e,(()=>({})));{const i=this.CalculateExpression(e);if(!Array.isArray(i)&&i.type===s.error)return r.allow_error?i:void(o=i);if(n&&0===t&&!Array.isArray(i)){let e=!1;if(i.type===s.string){const t=i.value.toLowerCase().trim();e="false"!==t&&"f"!==t}else e=!!i.value;l=e?2:1}return r.boxed?i:Array.isArray(i)?i.map((e=>e.map((e=>e.value)))):i.value}}));if(o)return o;if(this.context.call_index=a,r.return_type===oe.reference){const e=r.fn.apply(null,c);if(t)return e;if(Pe(e)){if("address"===e.value.type)return this.CellFunction2(e.value)();if("range"===e.value.type)return this.CellFunction4(e.value.start,e.value.end)}return e}return r.fn.apply(null,c)}:()=>ae()}UnaryExpression(e){switch(e.operator){case"+":return e=>this.CalculateExpression(e.operand);case"-":{const e=ve,t={type:s.number,value:0};return r=>{const s=this.CalculateExpression(r.operand);return Array.isArray(s)?s.map((r=>r.map((r=>e(t,r))))):e(t,s)}}default:return()=>(console.warn("unexpected unary operator:",e.operator),X())}}RecycleArray(e,t,r){if(e[0].length<r){const t=e[0].length;for(const s of e)for(let e=t;e<r;e++)s[e]=s[e%t]}if(e.length<t){const r=e.length;for(let s=r;s<t;s++)e[s]=e[s%r].slice(0)}return e}ElementwiseBinaryExpression(e,t,r){const s=Math.max(t.length,r.length),i=Math.max(t[0].length,r[0].length);t=this.RecycleArray(t,s,i),r=this.RecycleArray(r,s,i);const a=[];for(let n=0;n<s;n++){const s=[];for(let a=0;a<i;a++)s[a]=e(t[n][a],r[n][a]);a.push(s)}return a}BinaryExpression(e){const t=(e=>{switch(e){case"&":return Ce;case"+":return ge;case"-":return ve;case"*":return we;case"/":return xe;case"^":case"**":return be;case"%":return Me;case"=":case"==":return Se;case"!=":case"<>":return Ae;case">":return Re;case">=":return ke;case"<":return Ne;case"<=":return De}})(e.operator);return t?e=>{const r=this.CalculateExpression(e.left),s=this.CalculateExpression(e.right);return Array.isArray(r)?Array.isArray(s)?this.ElementwiseBinaryExpression(t,r,s):this.ElementwiseBinaryExpression(t,r,[[s]]):Array.isArray(s)?this.ElementwiseBinaryExpression(t,[[r]],s):t(r,s)}:()=>(console.info(`(unexpected binary operator: ${e.operator})`),X())}Identifier(e){const t=e.name,r=t.toUpperCase();switch(r){case"FALSE":case"F":return()=>({value:!1,type:s.boolean});case"TRUE":case"T":return()=>({value:!0,type:s.boolean});case"UNDEFINED":return()=>({value:void 0,type:s.undefined})}return()=>{const e=this.named_range_map[r];return e?1===e.count?this.CellFunction4(e.start,e.start):this.CellFunction4(e.start,e.end):(console.info("** identifier",t),ae())}}GroupExpression(e){return e.elements&&1===e.elements.length?e=>this.CalculateExpression(e.elements[0]):(console.warn("Can't handle group !== 1"),()=>X())}CalculateExpression(e,t=!1){if(e.user_data)return e.user_data(e);switch(e.type){case"call":{const r=this.data_model.macro_functions[e.name.toUpperCase()];return r?(e.user_data=this.CallMacro(e,r))(e):(e.user_data=this.CallExpression(e,t))(e)}case"address":return(e.user_data=this.CellFunction2(e))();case"range":return(e.user_data=e=>this.CellFunction4(e.start,e.end))(e);case"binary":return(e.user_data=this.BinaryExpression(e))(e);case"unary":return(e.user_data=this.UnaryExpression(e))(e);case"identifier":return(e.user_data=this.Identifier(e))();case"missing":return(e.user_data=()=>({value:void 0,type:s.undefined}))();case"literal":{const t={value:e.value,type:i(e.value)};return(e.user_data=()=>t)()}case"group":return(e.user_data=this.GroupExpression(e))(e);case"complex":{const t={value:{real:e.real,imaginary:e.imaginary},type:s.complex};return(e.user_data=()=>t)()}case"array":return(e.user_data=()=>e.values.map((e=>(Array.isArray(e)?e:[e]).map((e=>({value:e,type:i(e)}))))))();default:return console.warn("Unhandled parse expr:",e),ne()}}}const Fe=e=>{const t=[],r=e.length,s=e[0].length;for(let i=0;i<s;i++){t[i]=[];for(let s=0;s<r;s++)t[i][s]=e[s][i]}return t},Oe=e=>Array.isArray(e)?e.reduce(((e,t)=>void 0===t?e:Array.isArray(t)?e.concat(Oe(t)):t instanceof Float32Array||t instanceof Float64Array?e.concat(Array.from(t)):e.concat([t])),[]):[e],Le=e=>(t,...r)=>Array.isArray(t)?t.map((t=>t.map((t=>e(t,...r))))):e(t,...r),Ie=e=>(t,r,...s)=>Array.isArray(t)?Array.isArray(r)?t.map(((t,i)=>t.map(((t,a)=>e(t,r[i][a],...s))))):t.map((t=>t.map((t=>e(t,r,...s))))):e(t,r,...s);class Ue{constructor(){this.functions={}}Register(...e){for(const t of e)for(const e of Object.keys(t)){if(/[^a-zA-Z0-9._]/.test(e))throw new Error("invalid function name (invalid character)");if(e.length>255)throw new Error("invalid function name (too long, > 255)");if(/^[^a-zA-Z]/.test(e))throw new Error("invalid function name (start with an ascii letter)");const r=e.toLowerCase();if(this.functions[r])throw new Error(`function name (${r}) is already in use`);const s=t[e];s.canonical_name=e,this.functions[r]=s}}Get(e){const t=e.toLowerCase();return this.functions[t]}List(){const e={};for(const t of Object.keys(this.functions))e[t]=this.functions[t];return e}Alias(e,t){const r=this.Get(t);if(!r)throw new Error(`referenced function ${t} does not exist`);this.Register({[e]:Object.assign({},r)})}}var Ve;!function(e){e[e.move=0]="move",e[e.line=1]="line"}(Ve||(Ve={}));class je{static UnpackValues(e){if(Array.isArray(e)){const t=e[0];return Array.isArray(t)||t instanceof Float64Array||t instanceof Float32Array?e.reduce(((e,t)=>e.concat(this.UnpackValues(t))),[]):e.map((e=>isNaN(e)?void 0:e))}if(e instanceof Float32Array||e instanceof Float64Array)return Array.prototype.slice.call(e);if(e&&"object"==typeof e){const t=Object.keys(e).length;if(void 0!==e[0]&&void 0!==e[(t-1).toString()]){const r=[];for(let s=0;s<t;s++)r[s]=e[s.toString()];return r}}return[]}static SparklineCommon(e,t){var r;let s=[];const i=(null===(r=t.text)||void 0===r?void 0:r.text)||this.default_color,a=[i,i];return Array.isArray(e.calculated)&&(s=this.UnpackValues(e.calculated[0]),"string"==typeof e.calculated[1]&&(a[0]=e.calculated[1]),"string"==typeof e.calculated[2]&&(a[1]=e.calculated[2])),{values:s,colors:a}}static RenderLine(e,t,r,s,i){const{values:a,colors:n}=this.SparklineCommon(s,i);let o=1;Array.isArray(s.calculated)&&"number"==typeof s.calculated[2]&&(o=s.calculated[2]);let l=0,u=0,h=-1;for(let e=0;e<a.length;e++){const t=a[e];"number"==typeof t&&(h>=0?(l=Math.min(l,t),u=Math.max(u,t)):(h=e,l=u=t))}if(l!==u){const s=.9*e/(a.length-1),i=u-l,c=.8*t,d=.1*t;r.strokeStyle=n[0],r.lineWidth=o,r.lineCap="round",r.lineJoin="round",r.beginPath();let m=Ve.move;for(let n=h;n<a.length;n++){const o=a[n];if("number"==typeof o){const a=.05*e+s*n,u=t-(o-l)*c/i-d;m===Ve.move?(r.moveTo(a,u),m=Ve.line):r.lineTo(a,u)}else m=Ve.move}r.stroke()}}static RenderColumn(e,t,r,s,i){const{values:a,colors:n}=this.SparklineCommon(s,i);let o=0,l=0,u=!1;for(const e of a)"number"==typeof e&&(u?(o=Math.min(o,e),l=Math.max(l,e)):(u=!0,o=l=e));if(a.length){const s=(e-6-2)/(a.length-0),i=t-5,u=2.5;if(o!==l)if(o<0&&l>0){const e=l-o,t=u+l/e*i;for(let o=0;o<a.length;o++){const l=a[o];if("number"==typeof l){const a=3+o*s,u=Math.abs(l)/e*i;if(l>=0){r.fillStyle=n[0];const e=t-u;r.fillRect(a+2,e,s-2,u)}else{r.fillStyle=n[1];const e=t;r.fillRect(a+2,e,s-2,u)}}}}else if(l>0){r.fillStyle=n[0];const e=l-o;for(let n=0;n<a.length;n++){const l=a[n];if("number"==typeof l){const a=3+n*s,h=Math.max(1,(l-o)/e*i),c=t-u-h;r.fillRect(a+2,c,s-2,h)}}}else{r.fillStyle=n[1];const e=l-o;for(let t=0;t<a.length;t++){const n=a[t];if("number"==typeof n){const a=3+t*s,o=Math.max(1,Math.abs(l-n)/e*i),h=u;r.fillRect(a+2,h,s-2,o)}}}}}}je.default_color="#888";const Ge=e=>{const t=1/(1+.3275911*(e=Math.abs(e)));return 1-((((1.061405429*t-1.453152027)*t+1.421413741)*t-.284496736)*t+.254829592)*t*Math.exp(-1*e*e)},Be=e=>{if(.5===e)return 0;const t=e<1&&e>.5?1-e:e,r=Math.sqrt(Math.log(1/Math.pow(t,2))),s=r-(2.515517+.802853*r+.010328*Math.pow(r,2))/(1+1.432788*r+.189269*Math.pow(r,2)+.001308*Math.pow(r,3));return e>.5?s:-s},ze={type:s.boolean,value:!0},Je={type:s.boolean,value:!1},qe={Rand:{volatile:!0,fn:()=>({type:s.number,value:Math.random()})},RandBetween:{arguments:[{name:"min"},{name:"max"}],volatile:!0,fn:(e=0,t=1)=>{if(e>t){const r=e;e=t,t=r}return{type:s.number,value:Math.floor(Math.random()*(t+1-e)+e)}}},Sum:{description:"Adds arguments and ranges",arguments:[{boxed:!0,name:"values or ranges"}],fn:(...e)=>{let t={real:0,imaginary:0};const r=Oe(e);for(const e of r)switch(e.type){case s.number:t.real+=e.value;break;case s.boolean:t.real+=e.value?1:0;break;case s.complex:t.real+=e.value.real,t.imaginary+=e.value.imaginary;break;case s.error:return e}return c(t)}},Now:{description:"Returns current time",volatile:!0,fn:()=>({type:s.number,value:M((new Date).getTime())})},Today:{description:"Returns current day",volatile:!0,fn:()=>{const e=new Date;return e.setMilliseconds(0),e.setSeconds(0),e.setMinutes(0),e.setHours(12),{type:s.number,value:M(e.getTime())}}},IfError:{description:"Returns the original value, or the alternate value if the original value contains an error",arguments:[{name:"original value",allow_error:!0,boxed:!0},{name:"alternate value"}],fn:(e,t=0)=>e&&e.type===s.error?{value:t,type:i(t)}:e},IsError:{description:"Checks if another cell contains an error",arguments:[{name:"reference",allow_error:!0,boxed:!0}],fn:e=>{if(Array.isArray(e)){const t=Oe(e);for(const e of t)if(e.type===s.error)return{type:s.boolean,value:!0}}else if(e)return{type:s.boolean,value:e.type===s.error};return{type:s.boolean,value:!1}}},Cell:{description:"Returns data about a cell",arguments:[{name:"type",description:"Type of data to return"},{name:"reference",description:"Cell reference",metadata:!0}],fn:(e,t)=>{if(!Ee(t))return ie();if(e)switch(e.toString().toLowerCase()){case"format":return t.value.format?{type:s.string,value:t.value.format}:ie();case"address":return{type:s.string,value:t.value.address.label.replace(/\$/g,"")}}return{type:s.error,value:K.error}}},Year:{description:"Returns year from date",arguments:[{name:"date"}],fn:e=>h(new Date(x(e)).getUTCFullYear())},Month:{description:"Returns month from date",arguments:[{name:"date"}],fn:e=>h(new Date(x(e)).getUTCMonth()+1)},Day:{description:"Returns day of month from date",arguments:[{name:"date"}],fn:e=>h(new Date(x(e)).getUTCDate())},Radians:{description:"Converts degrees to radians",arguments:[{name:"Degrees",description:"Angle in degrees"}],fn:Le((e=>h(e*Math.PI/180)))},Degrees:{description:"Converts radians to degrees",arguments:[{name:"Radians",description:"Angle in radians"}],fn:Le((e=>h(e/Math.PI*180)))},CountA:{description:"Counts cells that are not empty",fn:(...e)=>h(Oe(e).reduce(((e,t)=>void 0===t?e:e+1),0))},Count:{description:"Counts cells that contain numbers",fn:(...e)=>h(Oe(e).reduce(((e,t)=>"number"==typeof t?e+1:e),0))},Or:{fn:(...e)=>{let t=!1;e=Oe(e);for(const r of e)t=t||!!r;return h(t)}},And:{fn:(...e)=>{let t=!0;e=Oe(e);for(const r of e)t=t&&!!r;return h(t)}},Not:{fn:(...e)=>0===e.length?re():1===e.length?h(!e[0]):h(!0)},If:{arguments:[{name:"test value",boxed:!0},{name:"value if true",boxed:!0,allow_error:!0},{name:"value if false",boxed:!0,allow_error:!0}],fn:(e,t=ze,r=Je)=>Array.isArray(e)?e.map(((e,s)=>e.map(((e,i)=>(l(e)?"false"!==e.value.toLowerCase()&&"f"!==e.value.toLowerCase():e.value)?Array.isArray(t)?t[s][i]:t:Array.isArray(r)?r[s][i]:r)))):(l(e)?"false"!==e.value.toLowerCase()&&"f"!==e.value.toLowerCase():e.value)?t:r},Fact:{description:"Returns the factorial of a number",arguments:[{name:"number"}],fn:Le((e=>{e=Math.floor(e);let t=1;for(;e>1;)t*=e,e--;return{type:s.number,value:t}}))},Power:{description:"Returns base raised to the given power",arguments:[{name:"base",boxed:!0},{name:"exponent",boxed:!0}],fn:Ie(((e,t)=>{if(e.type===s.complex||t.type===s.complex){const r=e.type===s.complex?e.value:{real:e.value||0,imaginary:0},i=t.type===s.complex?t.value:{real:t.value||0,imaginary:0},a=fe(r,i);return c(a)}{const r=Math.pow(e.value,t.value);return isNaN(r)?se():{type:s.number,value:r}}}))},Mod:{fn:Ie(((e,t)=>t?h(e%t):te()))},Sort:{arguments:[{name:"values"}],fn:(...e)=>((e=Oe(e)).every((e=>"number"==typeof e))?e.sort(((e,t)=>e-t)):e.sort(),[e.map((e=>h(e)))])},Transpose:{description:"Returns transpose of input matrix",arguments:[{name:"matrix",boxed:!0}],fn:e=>Array.isArray(e)?Fe(e):e},Max:{fn:(...e)=>({type:s.number,value:Math.max.apply(0,Oe(e).filter((e=>"number"==typeof e)))})},Min:{fn:(...e)=>({type:s.number,value:Math.min.apply(0,Oe(e).filter((e=>"number"==typeof e)))})},SumProduct:{description:"Returns the sum of pairwise products of two or more ranges",fn:(...e)=>{const t=e.map((e=>Oe(e))),r=Math.max.apply(0,t.map((e=>e.length)));let i=0;for(let e=0;e<r;e++)i+=t.reduce(((t,r)=>t*(r[e]||0)),1);return{type:s.number,value:i}}},VLookup:{fn:(e,t,r,i=!0)=>{if(r=Math.max(0,r-1),i){let s=Math.abs(e-t[0][0]),i=t[r][0];for(let a=1;a<t[0].length;a++){const n=Math.abs(t[0][a]-e);n<s&&(s=n,i=t[r][a])}return h(i)}for(let s=1;s<t[0].length;s++)if(t[0][s]==e)return t[r][s];return{type:s.error,value:H.NA}}},Product:{arguments:[{boxed:!0}],fn:(...e)=>{let t={real:1,imaginary:0};e=Oe(e);for(const r of e)r.type===s.complex?t=ue(t,r.value):r.type===s.number&&(t.real*=r.value,t.imaginary*=r.value);return c(t)}},Log:{fn:Ie(((e,t=10)=>({type:s.number,value:Math.log(e)/Math.log(t)})))},Log10:{fn:Le((e=>({type:s.number,value:Math.log(e)/Math.log(10)})))},Ln:{fn:Le((e=>({type:s.number,value:Math.log(e)})))},Round:{fn:Ie(((e,t=0)=>{const r=Math.pow(10,t);return{type:s.number,value:Math.round(r*e)/r}}))},RoundDown:{fn:Ie(((e,t=0)=>{const r=Math.pow(10,t),i=e>=0;return{type:s.number,value:i?Math.floor(r*e)/r:Math.ceil(r*e)/r}}))},Reverse:{arguments:[{boxed:!0}],fn:e=>Array.isArray(e)?1===e.length?[e[0].reverse()]:e.reverse():{type:s.string,value:e.value.toString().split("").reverse().join("")}},Exp:{arguments:[{boxed:!0}],fn:Le((e=>{if(e.type===s.complex){const t=me(e.value);return c(t)}return{type:s.number,value:Math.exp(e.value||0)}}))},Abs:{arguments:[{boxed:!0}],fn:Le((e=>e.type===s.complex?{type:s.number,value:Math.sqrt(e.value.real*e.value.real+e.value.imaginary*e.value.imaginary)}:{type:s.number,value:Math.abs(e.value||0)}))},Simplify:{fn:Ie(((e,t=2)=>{if(t=t||2,0===e)return{type:s.number,value:e};const r=e<0?-1:1;e*=r;const i=Math.pow(10,Math.floor(Math.log10(e))+1-t);return{type:s.number,value:Math.round(e/i)*i*r}}))},Erf:{fn:e=>({type:s.number,value:Ge(e)})},NormsInv:{description:"Inverse of the normal cumulative distribution",arguments:[{name:"probability"}],fn:e=>({type:s.number,value:Be(e)})},"Norm.Inv":{description:"Inverse of the normal cumulative distribution",arguments:[{name:"probability"},{name:"mean",default:0},{name:"standard deviation",default:1}],fn:(e,t=0,r=1)=>({type:s.number,value:Be(e)*r+t})},"Norm.Dist":{description:"Cumulative normal distribution",arguments:[{name:"value"},{name:"mean",default:0},{name:"standard deviation",default:1}],fn:(e,t=0,r=1)=>{const i=e<t?-1:1;return{type:s.number,value:.5*(1+i*Ge(Math.abs(e-t)/(r*Math.sqrt(2))))}}},Sqrt:{description:"Returns the square root of the argument",arguments:[{boxed:!0}],fn:Le((e=>{if(e.type===s.complex){const t=fe(e.value,{real:.5,imaginary:0});return c(t)}if(e.type!==s.undefined&&e.value){const t=Math.sqrt(e.value);return isNaN(t)?se():{type:s.number,value:t}}return{type:s.number,value:0}}))},HexToDec:{arguments:[{description:"hexadecimal string"}],fn:e=>({type:s.number,value:parseInt(e,16)})},DecToHex:{arguments:[{description:"number"}],fn:e=>({type:s.string,value:e.toString(16)})},Checkbox:{arguments:[{name:"checked"}],click:e=>{const{x:t,y:r,width:s,height:i,cell:a}=e,n={};if(a&&s&&i&&t&&r){const e={x:3,y:i-3-16};if(a.style){switch(a.style.vertical_align){case y.VerticalAlign.Top:e.y=3;break;case y.VerticalAlign.Middle:e.y=Math.round(i/2-8)}switch(a.style.horizontal_align){case y.HorizontalAlign.Right:e.x=Math.round(s-3-16);break;case y.HorizontalAlign.Center:e.x=Math.round(s/2-8)}}t>=e.x&&t<=e.x+16&&r>=e.y&&r<=e.y+16&&(n.value=`=Checkbox(${a.calculated?"FALSE":"TRUE"})`,n.block_selection=!0)}return n},render:e=>{const{context:t,width:r,height:s,cell:i}=e,a=e.scale||1;t.lineJoin="round",t.lineCap="round";const n=3*a;let o=n,l=s-n-16*a;if(i.style){switch(i.style.vertical_align){case y.VerticalAlign.Top:l=n;break;case y.VerticalAlign.Middle:l=Math.round(s/2-8*a)}switch(i.style.horizontal_align){case y.HorizontalAlign.Right:o=Math.round(r-n-16*a);break;case y.HorizontalAlign.Center:o=Math.round(r/2-8*a)}}if(i&&i.calculated){t.lineWidth=.5,t.fillStyle=t.strokeStyle,t.beginPath(),t.moveTo(o,l),t.lineTo(o+16*a,l),t.lineTo(o+16*a,l+16*a),t.lineTo(o,l+16*a),t.closePath(),t.moveTo(o+15*a,l+4*a);for(const e of[[13.59,2.58],[6,10.17],[2.41,6.59],[1,8],[6,13]])t.lineTo(o+e[0]*a,l+e[1]*a);t.closePath(),t.fill()}else t.lineWidth=Math.max(2,2*a),t.strokeRect(o,l,16*a,16*a);return{handled:!0}},fn:e=>({value:!!e,type:s.boolean})},"Sparkline.Column":{arguments:[{name:"data"},{name:"color"},{name:"negative color"}],render:e=>(je.RenderColumn(e.width,e.height,e.context,e.cell,e.style),{handled:!0}),fn:(...e)=>({type:s.object,value:e})},"Sparkline.Line":{arguments:[{name:"data"},{name:"color"},{name:"line width"}],render:e=>(je.RenderLine(e.width,e.height,e.context,e.cell,e.style),{handled:!0}),fn:(...e)=>({type:s.object,value:e})}},He={};for(const e of Object.keys(qe))He[e.toLowerCase()]=e;const $e=["pow"],Ze={};for(const e of $e)Ze[e.toLowerCase()]=e;for(const e of Object.getOwnPropertyNames(Math)){const t=e.toLowerCase();if(He[t])continue;if(Ze[t])continue;const r=Object.getOwnPropertyDescriptor(Math,e);if(!r)continue;const i=r.value,a=typeof i;switch(a){case"number":qe[e]={fn:()=>({type:s.number,value:i}),category:["Math Functions"]};break;case"function":qe[e]={fn:(...e)=>h(i(...e)),category:["Math Functions"]};break;default:console.info("unexpected type:",a,e)}}Math.log10||(Math.log10=e=>Math.log(e)/Math.log(10));const We=(e,t,r=0,s=0,i=0)=>i?-r*(e/(1-Math.pow(1+e,-t)))/(1+e)-s*(1/((1+e)*((Math.pow(1+e,t)-1)/e))):-(r*e*Math.pow(1+e,t)+s*e)/(Math.pow(1+e,t)-1),Qe=(e,t,r,s=0,i=0)=>i?(1+e)*-r/e*(Math.pow(1+e,t)-1)-s*Math.pow(1+e,t):-r/e*(Math.pow(1+e,t)-1)-s*Math.pow(1+e,t),Ye=(e,t,r,s=0,i=0,a=0)=>{if(t<1)return NaN;if(1===t&&a)return 0;const n=We(e,r,s,i,a),o=Qe(e,t-1,n,s,a)*e;return a?o/(1+e):o},Ke=(e,t,r,s=0,i=0,a=0)=>We(e,r,s,i,a)-Ye(e,t,r,s,i,a),Xe={NPV:{description:"Returns the present value of a series of future cashflows",arguments:[{name:"Rate"},{name:"Cashflow"}],fn:(e=0,...t)=>{let r=0;const i=Oe(t);for(let t=0;t<i.length;t++){const s=i[t];"number"==typeof s&&(r+=Math.pow(1+e,-(t+1))*s)}return{type:s.number,value:r}}},IRR:{description:"Calculates the internal rate of return of a series of cashflows",arguments:[{name:"Cashflows"},{name:"Guess",default:.1}],fn:(e,t=.1)=>{const r=Oe(e).map((e=>"number"==typeof e?e:0)),i=[{found:!1,value:0},{found:!1,value:0}];for(let e=0;e<50;e++){let e=0;for(let s=0;s<r.length;s++)e+=Math.pow(1+t,-(s+1))*r[s];if(Math.abs(e)<=.00125)return{type:s.number,value:t};if(e>0){if(i[0].value=i[0].found?Math.max(i[0].value,t):t,i[0].found=!0,!i[1].found){t+=.1;continue}}else if(i[1].value=i[1].found?Math.min(i[1].value,t):t,i[1].found=!0,!i[0].found){t-=.1;continue}t=i[0].value+(i[1].value-i[0].value)/2}return{type:s.error,value:"NUM"}}},CUMPRINC:{description:"Returns cumulative principal paid on a loan between two periods",arguments:[{name:"Rate"},{name:"Periods"},{name:"Present Value"},{name:"Start Period"},{name:"End Period"},{name:"Type",default:0}],fn:(e,t,r,i,a,n=0)=>{let o=0;for(let s=i;s<=a;s++)o+=Ke(e,s,t,r,0,n);return{type:s.number,value:o}}},CUMIPMT:{description:"Returns cumulative interest paid on a loan between two periods",arguments:[{name:"Rate"},{name:"Periods"},{name:"Present Value"},{name:"Start Period"},{name:"End Period"},{name:"Type",default:0}],fn:(e,t,r,i,a,n=0)=>{let o=0;for(let s=i;s<=a;s++)o+=Ye(e,s,t,r,0,n);return{type:s.number,value:o}}},IPMT:{description:"Returns the interest portion of a payment",arguments:[{name:"Rate"},{name:"Period"},{name:"Periods"},{name:"Present Value",default:0},{name:"Future Value",default:0},{name:"Type",default:0}],fn:(e,t,r,i=0,a=0,n=0)=>({type:s.number,value:Ye(e,t,r,i,a,n)})},PPMT:{description:"Returns the principal portion of a payment",arguments:[{name:"Rate"},{name:"Period"},{name:"Periods"},{name:"Present Value",default:0},{name:"Future Value",default:0},{name:"Type",default:0}],fn:(e,t,r,i=0,a=0,n=0)=>({type:s.number,value:Ke(e,t,r,i,a,n)})},Rate:{description:"Returns the interest rate of a loan",arguments:[{name:"Periods"},{name:"Payment"},{name:"Present Value",default:0},{name:"Future Value",default:0},{name:"Type",default:0}],fn:(e,t,r=0,i=0,a=0)=>{let n=.25;const o=[-1,1];for(let l=0;l<32;l++){const l=We(n,e,r,i,a);if(Math.abs(l-t)<=1e-6)return{type:s.number,value:n};const u=We(o[1],e,r,i,a);t>=l&&t<=u||t>=u&&t<=l?o[0]=n:o[1]=n,n=o[0]+(o[1]-o[0])/2}return{type:s.number,value:n}}},FV:{description:"Returns the future value of an investment",arguments:[{name:"Rate"},{name:"Periods"},{name:"Payment"},{name:"Present Value",default:0},{name:"Type",default:0}],fn:(e,t,r,i=0,a=0)=>({type:s.number,value:Qe(e,t,r,i,a)})},PV:{description:"Returns the present value of an investment",arguments:[{name:"Rate"},{name:"Periods"},{name:"Payment"},{name:"Future Value",default:0},{name:"Type",default:0}],fn:(e,t,r,i=0,a=0)=>a?(r+=i*(1/((1+e)*((Math.pow(1+e,t)-1)/e))),{type:s.number,value:-(r+r/e*(1-Math.pow(1+e,-(t-1))))}):{type:s.number,value:-(i+r/e*(Math.pow(1+e,t)-1))/Math.pow(1+e,t)}},NPER:{description:"Returns the number of periods of an investment",arguments:[{name:"Rate"},{name:"Payment"},{name:"Present Value"},{name:"Future Value",default:0},{name:"Type",default:0}],fn:(e,t,r=0,i=0,a=0)=>a?{type:s.number,value:1+(-Math.log(1+e*(1-r/-t))+Math.log(1+i*e/(-t*(1+e))))/Math.log(1+e)}:{type:s.number,value:(Math.log(Math.pow(1-r*e/-t,-1))+Math.log(1+i*e/-t))/Math.log(1+e)}},PMT:{description:"Returns the periodic payment of a loan",arguments:[{name:"Rate"},{name:"Periods"},{name:"Present Value"},{name:"Future Value",default:0},{name:"Type",default:0}],fn:(e,t,r,i=0,a=0)=>({type:s.number,value:We(e,t,r,i,a)})}},et={Char:{arguments:[{name:"number"}],fn:e=>({type:s.string,value:String.fromCodePoint(e||32)}),category:["text"]},Code:{arguments:[{name:"string"}],fn:e=>({type:s.number,value:e.codePointAt(0)}),category:["text"]},Text:{arguments:[{name:"value"},{name:"number format"}],fn:(e,t="0.00####")=>({type:s.string,value:S.Get(t).Format(e||0)}),category:["text"]},Left:{arguments:[{name:"string"},{name:"count"}],fn:(e,t=1)=>({type:s.string,value:e.substr(0,t)}),category:["text"]},Right:{arguments:[{name:"string"},{name:"count"}],fn:(e,t=1)=>({type:s.string,value:e.slice(-t)}),category:["text"]},Mid:{arguments:[{name:"string"},{name:"left"},{name:"count"}],fn:(e,t=0,r=1)=>({type:s.string,value:e.substr(Math.max(0,t-1),r)}),category:["text"]},Search:{description:"Find a string (needle) in another string (haystack). Case-insensitive.",arguments:[{name:"Needle"},{name:"Haystack"},{name:"Start",default:1}],fn:(e,t,r=1)=>{if(r>=1){if(!e)return{type:s.number,value:r};const i=(e=>{const t=[],r=e.length,s="[\\^$.|?*+()";for(let i=0;i<r;i++){let r=e[i];switch(r){case"*":t.push(".","*");break;case"?":t.push(".");break;case"~":r=e[++i]||"";default:for(let e=0;e<s.length;e++)if(r===s[e]){t.push("\\");break}t.push(r)}}return t.join("")})(e),a=new RegExp(i,"i").exec(t.substr(r-1));if(a)return{type:s.number,value:a.index+r}}return se()}},Find:{description:"Find a string (needle) in another string (haystack). Case-sensitive.",arguments:[{name:"Needle"},{name:"Haystack"},{name:"Start",default:1}],fn:(e,t,r=1)=>{if(r>=1){if(!e)return{type:s.number,value:r};const i=new RegExp(e).exec(t.substr(r-1));if(i)return{type:s.number,value:i.index+r}}return se()}},Concat:{description:"Pastes strings together",fn:(...e)=>{const t=Oe(e).map((e=>{var t;const r=(null===(t=e)||void 0===t?void 0:t.toString())||"";return"number"==typeof e&&","===p.decimal_separator?r.replace(/\./,","):r})).join("");return{type:s.string,value:t}}}},tt={Concatenate:"Concat"},rt={IsBlank:{description:"Returns true if the reference is blank",arguments:[{name:"Reference",metadata:!0}],fn:Le((e=>({type:s.boolean,value:!(null==e?void 0:e.value)||void 0===e.value.value})))},IsNumber:{description:"Returns true if the reference is a number",arguments:[{name:"Reference",metadata:!0}],fn:Le((e=>({type:s.boolean,value:(null==e?void 0:e.value)&&"number"==typeof e.value.value})))},IsLogical:{description:"Returns true if the reference is a logical TRUE or FALSE",arguments:[{name:"Reference",metadata:!0}],fn:Le((e=>({type:s.boolean,value:(null==e?void 0:e.value)&&"boolean"==typeof e.value.value})))},IsText:{description:"Returns true if the reference is text",arguments:[{name:"Reference",metadata:!0}],fn:Le((e=>({type:s.boolean,value:(null==e?void 0:e.value)&&"string"==typeof e.value.value})))}},st=(e,t=!1)=>{const r=e.length;let s=0,i=0;for(let t=0;t<r;t++)s+=e[t];s/=r;for(let t=0;t<r;t++){const r=e[t]-s;i+=r*r}return t?i/(r-1):i/r},it={StDev:{description:"Returns the standard deviation of a set of values, corresponding to a population",arguments:[{name:"data"}],fn:(...e)=>({type:s.number,value:Math.sqrt(st(Oe(e),!1))})},"StDev.S":{description:"Returns the standard deviation of a set of values, corresponding to a sample of a population",arguments:[{name:"data"}],fn:(...e)=>({type:s.number,value:Math.sqrt(st(Oe(e),!0))})},Var:{description:"Returns the variance of a set of values, corresponding to a population",arguments:[{name:"data"}],fn:(...e)=>({type:s.number,value:st(Oe(e),!1)})},"Var.S":{description:"Returns the variance of a set of values, corresponding to a sample of a population",arguments:[{name:"data"}],fn:(...e)=>({type:s.number,value:st(Oe(e),!0)})},Correl:{description:"Returns the correlation between two ranges of values",arguments:[{name:"A"},{name:"B"}],fn:(e,t)=>{if(!Array.isArray(e)||!Array.isArray(t))return se();if(!Array.isArray(e[0])||!Array.isArray(t[0]))return se();let r=0,i=0,a=0,n=0,o=0,l=0,u=0;for(let r=0;r<e.length;r++){if(!e[r]||!t[r])continue;const s=e[r].length;for(let h=0;h<s;h++){const s=Number(e[r][h]),c=Number(t[r][h]);isNaN(s)||isNaN(c)||(i+=s*c,a+=s,n+=c,o+=s*s,l+=c*c,u++)}}return r=u*i-a*n,r&&(r/=Math.sqrt((u*o-a*a)*(u*l-n*n))),{type:s.number,value:r}}},GeoMean:{description:"Returns the geometric mean of all numeric arguments",arguments:[{boxed:!0}],fn:(...e)=>{e=Oe(e);let t=0,r={real:1,imaginary:0},i=!1,a=!1;for(const n of e)n.type===s.complex?(i=!0,r=ue(r,n.value),t++):n.type===s.number&&(n.value<0&&(a=!0),t++,r.real*=n.value,r.imaginary*=n.value);if(i){const e=fe(r,{real:1/t,imaginary:0});return e.imaginary?{type:s.complex,value:e}:{type:s.number,value:e.real}}return a?se():{type:s.number,value:Math.pow(r.real,1/t)}}},Average:{description:"Returns the arithmetic mean of all numeric arguments",arguments:[{boxed:!0}],fn:(...e)=>{e=Oe(e);const t={real:0,imaginary:0};let r=0;for(const i of e){if(i.type===s.error)return i;i.type===s.number&&(t.real+=i.value,r++),i.type===s.complex&&(t.real+=i.value.real,t.imaginary+=i.value.imaginary,r++)}return t.real/=r,t.imaginary/=r,t.imaginary?{type:s.complex,value:t}:{type:s.number,value:t.real}}},Percentile:{description:"Returns the kth percentile value from the range of data",arguments:[{name:"range"},{name:"percentile"}],fn:(e,t)=>{const r=Oe(e).filter((e=>"number"==typeof e));r.sort(((e,t)=>e-t));const i=r.length,a=Math.pow(10,8),n=Math.round((1+(i-1)*t)*a)/a,o=Math.floor(n),l=Math.ceil(n);return{type:s.number,value:(r[o-1]+r[l-1])/2}}},Median:{description:"Returns the median value of the range of data",arguments:[{name:"range"}],fn:(...e)=>{const t=Oe(e).filter((e=>"number"==typeof e));t.sort(((e,t)=>e-t));const r=1+.5*(t.length-1),i=Math.floor(r),a=Math.ceil(r);return{type:s.number,value:(t[i-1]+t[a-1])/2}}}},at={Mean:"Average","StDev.P":"StDev","Var.P":"Var"},nt={IsComplex:{description:"Returns true if the reference is a complex number",arguments:[{name:"Reference",metadata:!0}],fn:Le((e=>({type:s.boolean,value:(null==e?void 0:e.value)&&t(e.value.value)})))},Real:{description:"Returns the real part of a complex number",arguments:[{boxed:!0}],fn:Le((e=>e.type===s.number?Object.assign({},e):e.type===s.complex?{type:s.number,value:e.value.real||0}:e.type===s.undefined||e.type===s.string&&""===e.value?{type:s.number,value:0}:se()))},Imaginary:{description:"Returns the imaginary part of a complex number (as real)",arguments:[{boxed:!0}],fn:Le((e=>e.type===s.complex?{type:s.number,value:e.value.imaginary||0}:e.type===s.number||e.type===s.undefined||e.type===s.string&&""===e.value?{type:s.number,value:0}:se()))},Conjugate:{description:"Returns the conjugate of a complex number",arguments:[{boxed:!0}],fn:Le((e=>e.type===s.complex?{type:s.complex,value:{real:e.value.real,imaginary:-e.value.imaginary}}:e.type!==s.number&&e.type!==s.undefined&&e.value?se():{type:s.number,value:e.value||0}))},Arg:{description:"Returns the principal argument of a complex number",arguments:[{boxed:!0}],fn:Le((e=>e.type===s.complex?{type:s.number,value:Math.atan2(e.value.imaginary,e.value.real)}:e.type===s.number||e.type===s.undefined||e.type===s.string&&""===e.value?{type:s.number,value:Math.atan2(0,e.value||0)}:se()))},Rectangular:{description:"Converts a complex number in polar form to rectangular form",arguments:[{name:"r"},{name:" in radians"}],fn:(e=0,t=0)=>({type:s.complex,value:{real:e*Math.cos(t),imaginary:e*Math.sin(t)}})},Complex:{description:"Ensures that the given value will be treated as a complex number",arguments:[{boxed:!0}],fn:Le((e=>e.type===s.complex?e:e.type!==s.number&&e.type!==s.undefined&&e.value?se():{type:s.complex,value:{imaginary:0,real:e.value||0}}))},ComplexLog:{description:"Returns the principal value Log(z) of a complex number z",arguments:[{boxed:!0}],fn:Le((e=>{if(e.type===s.number){if(!e.value)return se();e={type:s.complex,value:{real:e.value,imaginary:0}}}else if(e.type===s.undefined||e.type===s.string&&""===e.value)return se();if(e.type===s.complex){const t=le(e.value),r={real:Math.log(t.r),imaginary:t.theta};return r.imaginary?{type:s.complex,value:r}:{type:s.number,value:r.real}}return se()}))}},ot=e=>{Array.isArray(e)||(e=[[e]]);const t=e.length,r=t?e[0].length:0,i=[];if(!t||!r)return{m:t,n:r,array:i};for(let a=0;a<t;a++){const n=[];for(let i=0;i<r;i++){const o=e[a][i];if(o.type===s.complex)n.push(Object.assign({},o.value));else if(o.type===s.number)n.push({real:o.value,imaginary:0});else{if(o.type!==s.undefined&&""!==o.value)return{m:t,n:r,error:!0,array:[]};n.push({real:0,imaginary:0})}}i.push(n)}return{m:t,n:r,array:i}},lt={MDeterm:{description:"Returns the determinant of a matrix",arguments:[{name:"matrix",boxed:!0}],fn:e=>{const t=ot(e);if(!t.array||!t.m||!t.n||t.m!==t.n||t.error)return se();const r=ce(t);return r?c(r):se()}},MInverse:{description:"Returns the inverse matrix",arguments:[{name:"matrix",boxed:!0}],fn:e=>{const t=ot(e);if(!t.array||!t.m||!t.n||t.m!==t.n||t.error)return se();const r=ce(t);if(r&&0===r.real&&0===(null==r?void 0:r.imaginary))return se();const s=(e=>{const t=[];if(e.m!==e.n)return;const{real:r,imaginary:s,flags:i}=(e=>{const t={real_values:!1,imaginary_values:!1,square:e.m===e.n,unit_diagonal:!0},r={m:e.m,n:e.n,array:[]},s={m:e.m,n:e.n,array:[]};for(let i=0;i<e.m;i++){const a=e.array[i],n=[],o=[];for(let r=0;r<e.n;r++)a[r].real&&(t.real_values=!0),a[r].imaginary&&(t.imaginary_values=!0),r===i&&t.unit_diagonal&&(1===a[r].real&&0===a[r].imaginary||(t.unit_diagonal=!1)),n.push(a[r].real),o.push(a[r].imaginary);r.array.push(n),s.array.push(o)}return{real:r,imaginary:s,flags:t}})(e),a=de(r);if(!a)return;if(!i.imaginary_values){for(let r=0;r<e.m;r++){const s=[];for(let t=0;t<e.n;t++)s.push({real:a.array[r][t],imaginary:0});t.push(s)}return t}const n=he(a,s),o=((e,t)=>{const r=[];for(let s=0;s<e.m;s++){const i=[];for(let r=0;r<e.n;r++)i.push(e.array[s][r]+t.array[s][r]);r.push(i)}return{m:e.m,n:e.n,array:r}})(r,he(s,n)),l=de(o);if(!l)return;const u=he(n,l);for(let r=0;r<e.m;r++){const s=[];for(let t=0;t<e.n;t++)s.push({real:l.array[r][t],imaginary:-u.array[r][t]});t.push(s)}return t})(t);return s?s.map((e=>e.map((e=>c(e))))):se()}},MMult:{description:"Returns the dot product of A and B",arguments:[{name:"A",boxed:!0},{name:"B",boxed:!0}],fn:(e,t)=>{const r=ot(e),s=ot(t);return!r.array||r.error||!s.array||s.error||r.m!==s.n?se():((e,t)=>{const r=[];for(let s=0;s<e.m;s++){const i=[];for(let r=0;r<t.n;r++){const a={real:0,imaginary:0};for(let i=0;i<e.n;i++)a.real+=e.array[s][i].real*t.array[i][r].real-e.array[s][i].imaginary*t.array[i][r].imaginary,a.imaginary+=e.array[s][i].real*t.array[i][r].imaginary+e.array[s][i].imaginary*t.array[i][r].real;i.push(a)}r.push(i)}return r})(s,r).map((e=>e.map((e=>c(e)))))}}};class ut extends Q{constructor(){super(...arguments),this.state_id=0,this.type=ut.type,this.color=z.black,this.state_representation=""}UpdateState(){const e=JSON.stringify(this.edges_in.map((e=>e.result)));e!==this.state_representation&&(this.state_representation=e,this.state_id++)}Calculate(e){if(this.dirty){for(const e of this.edges_in)if(e.dirty)return;this.UpdateState(),this.dirty=!1}}AddDependent(e){throw new Error("leaf vertex cannot have dependents")}}ut.type="leaf-vertex";const ht=e=>{const t=4+e.data.length,r=new Float64Array(t);return r[0]=e.column,r[1]=e.row,r[2]=e.sheet_id,r[3]=e.data.length,r.set(e.data,4),r},ct=e=>e.length===3+e[2]?{column:e[0],row:e[1],sheet_id:0,data:e.subarray(3)}:{column:e[0],row:e[1],sheet_id:e[2],data:e.subarray(4)};var dt,mt=r(691);!function(e){e[e.Null=0]="Null",e[e.Prep=1]="Prep",e[e.Simulation=2]="Simulation",e[e.Post=3]="Post"}(dt||(dt={}));const ft=e=>{const t=mt.MC.Uniform(e),r=[];for(let t=0;t<e;t++)r[t]=t;for(let s=0;s<e;s++){const i=s+Math.floor(t[s]*(e-s)),a=r[s];r[s]=r[i],r[i]=a}return r};class pt{constructor(){this.address={row:0,column:0},this.volatile=!1,this.iteration=0,this.iterations=0,this.call_index=0,this.lhs=!1,this.state=dt.Null,this.results=[],this.elapsed=0,this.trials=0,this.distributions=[],this.correlated_distributions={},this.functions={"Multivariate.Normal":{description:"Returns a sample from the multivariate normal distribution",simulation_volatile:!0,arguments:[{name:"range of values",description:"Set of Correlated Distributions (N)",address:!0},{name:"correlation",description:"Correlation Matrix (NxN)"},{name:"mean",description:"Distribution Mean",default:0},{name:"stdev",description:"Standard Deviation",default:1}],fn:this.multivariate_normal.bind(this),category:["RiskAMP Random Distributions"],extension:!0},"Multivariate.LogNormal":{description:"Returns a sample from the multivariate log-normal distribution",simulation_volatile:!0,arguments:[{name:"range of values",description:"Set of Correlated Distributions (N)",address:!0},{name:"correlation",description:"Correlation Matrix (NxN)"},{name:"mean",description:"Mean of underlying Normal distribution",default:0},{name:"stdev",description:"Standard Deviation of underlying Normal distribution",default:1}],fn:this.multivariate_lognormal.bind(this),category:["RiskAMP Random Distributions"],extension:!0},"Multivariate.Uniform":{description:"Returns a sample from the multivariate uniform distribution",simulation_volatile:!0,arguments:[{name:"range of values",description:"Set of Correlated Distributions (N)",address:!0},{name:"correlation",description:"Correlation Matrix (NxN)"},{name:"min",description:"Minimum Value",default:0},{name:"max",description:"Maximum Value",default:1}],fn:this.multivariate_uniform.bind(this),category:["RiskAMP Random Distributions"],extension:!0},"Multivariate.Beta":{description:"Returns a sample from the multivariate beta distribution",simulation_volatile:!0,arguments:[{name:"range of values",description:"Set of Correlated Distributions (N)",address:!0},{name:"correlation",description:"Correlation Matrix (NxN)"},{name:"w",description:"Shape Parameter"},{name:"v",description:"Shape Parameter"}],fn:this.multivariate_beta.bind(this),category:["RiskAMP Random Distributions"],extension:!0},"Multivariate.PERT":{description:"Returns a sample from the multivariate PERT distribution",simulation_volatile:!0,arguments:[{name:"range of values",description:"Set of Correlated Distributions (N)",address:!0},{name:"correlation",description:"Correlation Matrix (NxN)"},{name:"min",description:"Minimum Value"},{name:"mode",description:"Most-Likely Value"},{name:"max",description:"Maximum Value"},{name:"lambda",default:4}],fn:this.multivariate_pert.bind(this),category:["RiskAMP Random Distributions"],extension:!0},"Multivariate.Triangular":{description:"Returns a sample from the multivariate triangular distribution",simulation_volatile:!0,arguments:[{name:"range of values",description:"Set of Correlated Distributions (N)",address:!0},{name:"correlation",description:"Correlation Matrix (NxN)"},{name:"min",description:"Minimum Value"},{name:"mode",description:"Most-Likely Value"},{name:"max",description:"Maximum Value"}],fn:this.multivariate_triangular.bind(this),category:["RiskAMP Random Distributions"],extension:!0},UniformRangeSample:{description:"Returns one of a set of values, with equal probability and with replacement",simulation_volatile:!0,arguments:[{name:"range",description:"Range of Values"}],fn:this.uniformrangesample.bind(this),category:["RiskAMP Random Distributions"],extension:!0},SampleValue:{description:"Returns one of a set of values, with equal probability and with replacement",simulation_volatile:!0,arguments:[{name:"range",description:"Range of Values"}],fn:this.samplevalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},"SampleValue.Weighted":{description:"Returns one of a set of values, weighted by a second set of values",simulation_volatile:!0,arguments:[{name:"range",description:"Range of Values"},{name:"weights",description:"Range of Weights"}],fn:this.samplevalue_weighted.bind(this),category:["RiskAMP Random Distributions"],extension:!0},BernoulliValue:{description:"Returns true or false (boolean) based on the given probability",simulation_volatile:!0,arguments:[{name:"p",description:"Probability to return True",default:.5}],fn:this.bernoullivalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},ProbabilityValue:{description:"Returns true or false (boolean) based on the given probability",simulation_volatile:!0,arguments:[{name:"p",description:"Probability to return True",default:.5}],fn:this.probabilityvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},UniformValue:{description:"Returns a sample from the uniform distribution",simulation_volatile:!0,arguments:[{name:"min",description:"Minimum",default:0},{name:"max",description:"Maximum",default:1}],fn:this.uniformvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},BetaValue:{description:"Returns a sample from the beta distribution",simulation_volatile:!0,arguments:[{name:"w",description:"Shape Parameter"},{name:"v",description:"Shape Parameter"}],fn:this.betavalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},TruncatedNormalValue:{description:"Returns a sample from the normal distribution",simulation_volatile:!0,arguments:[{name:"mean",description:"Mean",default:0},{name:"stdev",description:"Standard Deviation",default:1},{name:"min",description:"Minimum Value"},{name:"max",description:"Maximum Value"}],fn:this.truncatednormalvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},NormalValue:{description:"Returns a sample from the normal distribution",simulation_volatile:!0,arguments:[{name:"mean",description:"Mean",default:0},{name:"stdev",description:"Standard Deviation",default:1}],fn:this.normalvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},PERTValue:{description:"Returns a sample from the beta-PERT distribution",simulation_volatile:!0,arguments:[{name:"min",description:"Minimum Value",default:0},{name:"mode",description:"Most-Likely Value",default:.5},{name:"max",description:"Maximum Value",default:1},{name:"lambda",default:4}],fn:this.pertvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},LognormalValue:{description:"Returns a sample from the log-normal distribution",simulation_volatile:!0,arguments:[{name:"mean",description:"Mean of underlying Normal distribution",default:0},{name:"stdev",description:"Standard Deviation of underlying Normal distribution",default:1}],fn:this.lognormalvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},SequentialValue:{description:"Returns one from a set of values, in order",simulation_volatile:!0,arguments:[{name:"values",description:"Data Array"},{name:"count",description:"Count",default:0}],fn:this.sequentialvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},IndexValue:{description:"Returns a monotonically increasing value",simulation_volatile:!0,arguments:[{name:"max",description:"Maximum",default:0}],fn:this.indexvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},"PERTValue.P":{description:"Returns a sample from the beta-PERT distribution",simulation_volatile:!0,arguments:[{name:"p10",description:"10th-Percentile Value",default:0},{name:"mode",description:"Most-Likely Value",default:.5},{name:"p90",description:"90th-Percentile Value",default:1},{name:"lambda",default:4}],fn:this.pertvalue_p.bind(this),category:["RiskAMP Random Distributions"],extension:!0},TriangularValue:{description:"Returns a sample from the triangular distribution",simulation_volatile:!0,arguments:[{name:"min",description:"Minimum Value",default:0},{name:"mode",description:"Most Likely Value",default:.5},{name:"max",description:"Maximum Value",default:1}],fn:this.triangularvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},SimulationCorrelation:{description:"Returns the correlation between the data from two cells in the simulation",arguments:[{name:"reference cell",description:"Cell 1",collector:!0},{name:"reference cell",description:"Cell 2",collector:!0}],fn:this.simulationcorrelation.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationRSquared:{description:"Returns the r-squared value (coefficient of correlation) of the data from two cells in the simulation",arguments:[{name:"dependent",description:"Dependent Value",collector:!0},{name:"independent",description:"Indepdendent Value",collector:!0}],fn:this.simulationrsquared.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationSkewness:{description:"Returns the skewness of data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationskewness.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationKurtosis:{description:"Returns the kurtosis (peakedness) of data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationkurtosis.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationPercentile:{description:"Returns the value of a cell at a given percentile in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0},{name:"percentile",description:"Percentile (as %)"}],fn:this.simulationpercentile.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationInterval:{description:"Returns the portion of results in the simulation that fall within some bounds (as a percentage)",arguments:[{name:"reference cell",description:"Source Cell",collector:!0},{name:"min",description:"Minimum Value (optional, inclusive)"},{name:"max",description:"Maximum Value (optional, inclusive)"}],fn:this.simulationinterval.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationMean:{description:"Returns the mean (average) value of the data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationmean.bind(this),extension:!0,category:["RiskAMP Simulation Functions"]},SimulationMedian:{description:"Returns the median value of the data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationmedian.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationValue:{description:"Returns the value of this cell in the simulation at the given trial number",arguments:[{name:"reference cell",description:"Source Cell",collector:!0},{name:"iteration",description:"Trial Number"}],fn:this.simulationvalue.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationValuesArray:{description:"Returns all values of this cell in the simulation, as an array",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationvaluesarray.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SortedSimulationIndex:{description:"Returns the iteration number of a sorted value for this cell",arguments:[{name:"reference cell",description:"Source Cell",collector:!0},{name:"index"}],fn:this.sortedsimulationindex.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},"SimulationValuesArray.Ordered":{description:"Returns all values of this cell in the simulation, as an array, ordered by a second cell",arguments:[{name:"reference cell",description:"Source Cell",collector:!0},{name:"order by",description:"Reference Cell for Ordering",collector:!0}],fn:this.simulationvaluesarray_ordered.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationMin:{description:"Returns the minimum value of the data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationmin.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationMax:{description:"Returns the maximum value of the data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationmax.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationStandardError:{description:"Returns the standard error of the mean from this cell in the simulation",arguments:[{name:"reference cell",collector:!0}],fn:this.simulationstandarderror.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationStandardDeviation:{description:"Returns the standard deviation of the data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationstandarddeviation.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationVariance:{description:"Returns the variance of the data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationvariance.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationTrials:{description:"Returns the number of trials from the last simulation",fn:this.simulationtrials.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationTime:{description:"Returns the elapsed time of the last simulation",fn:this.simulationtime.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},IsPosDef:{description:"Checks that a matrix is positive-definite",arguments:[{name:"matrix"}],fn:e=>{if(e.some((e=>e.some((e=>"number"!=typeof e)))))return se();const t=mt.Matrix.FromArray(e);return{type:s.boolean,value:t.IsPosDef()}},extension:!0},MakePosDef:{description:"Returns a matrix that is positive-definite",arguments:[{name:"matrix"}],fn:e=>e.some((e=>e.some((e=>"number"!=typeof e))))?se():mt.Matrix.FromArray(e).MakePosDef().ToArray().map((e=>e.map((e=>({type:s.number,value:e}))))),extension:!0},Cholesky:{arguments:[{name:"matrix"},{name:"transpose",default:!1}],fn:(e,t=!1)=>mt.Matrix.FromArray(e).Cholesky(t).ToArray().map((e=>e.map((e=>({type:s.number,value:e}))))),extension:!0},EigenValues:{description:"Returns the eigenvalues of the matrix (as column vector)",arguments:[{name:"matrix"}],fn:e=>e.some((e=>e.some((e=>"number"!=typeof e))))?se():[mt.Matrix.FromArray(e).EigenSystem().realvalues.map((e=>({type:s.number,value:e})))],extension:!0},EigenVectors:{description:"Returns the eigenvectors of the matrix (as matrix)",arguments:[{name:"matrix"}],fn:e=>e.some((e=>e.some((e=>"number"!=typeof e))))?se():mt.Matrix.FromArray(e).EigenSystem().vectors.map((e=>Array.from(e).map((e=>({type:s.number,value:e}))))),extension:!0},"RiskAMP.Scale":{description:"Creates a uniform scale within a given range",arguments:[{name:"min"},{name:"max"}],fn:this.Scale.bind(this),extension:!0},"RiskAMP.HistogramTable":{description:"Creates a histogram table from a source cell",arguments:[{name:"reference cell",collector:!0}],fn:this.HistogramTable.bind(this),extension:!0},"RiskAMP.Permutation":{description:"Creates a random permutation of source data",arguments:[{name:"range",boxed:!0}],fn:this.Permutation.bind(this),extension:!0,simulation_volatile:!0}}}set seed(e){mt.Random.Seed(e)}CallerArea(){var e;let t,r=1,s=1;if(this.address.sheet_id)for(const r of(null===(e=this.model)||void 0===e?void 0:e.sheets)||[])if(r.id===this.address.sheet_id){r.cells.data[this.address.row]&&(t=r.cells.data[this.address.row][this.address.column]);break}return(null==t?void 0:t.area)&&(r=t.area.rows,s=t.area.columns),{rows:r,columns:s}}CorrelateDistributions(){for(const e of Object.keys(this.correlated_distributions)){const t=this.correlated_distributions[e],r=t.addresses.map((e=>this.distributions[e.sheet_id||0][e.column][e.row][e.call_index]));try{const e=mt.MC.CorrelateCDM(t.correlation,r,!0);t.addresses.forEach(((t,r)=>{this.distributions[t.sheet_id||0][t.column][t.row][t.call_index]=e[r]}))}catch(e){console.warn(e)}}}InitDistribution(){if(!this.address)throw new Error("invalid address");if(!this.address.sheet_id)throw new Error("address missing sheet ID");this.distributions[this.address.sheet_id]||(this.distributions[this.address.sheet_id]=[]);const e=this.distributions[this.address.sheet_id];e[this.address.column]||(e[this.address.column]=[]);const t=e[this.address.column];t[this.address.row]||(t[this.address.row]=[])}StoreCellResults(e){if(e||(e=this.address),!e)return;if(!e.sheet_id)throw new Error("SCR called without sheet id");this.results[e.sheet_id]||(this.results[e.sheet_id]=[]),this.results[e.sheet_id][e.column]||(this.results[e.sheet_id][e.column]=[]);const t=this.results[e.sheet_id][e.column];return t[e.row]||(t[e.row]=[]),t[e.row]}PrepMultivariate(e,t){if(!this.correlated_distributions[e]){let r=mt.CDMatrix.FromArray(t);if(!r.IsSymmetric()){for(let e=1;e<t.length;e++)for(let r=0;r<e;r++)if(t[e][r]){console.warn("invalid lower-triangular matrix");break}r=r.Symmetrize(!0)}this.correlated_distributions[e]={correlation:r,addresses:[]}}this.correlated_distributions[e].addresses.push({column:this.address.column,row:this.address.row,sheet_id:this.address.sheet_id,call_index:this.call_index}),this.InitDistribution()}ValidateCorrelationMatrix(e){let t=mt.Matrix.FromArray(e);return t.IsSymmetric()||(t=t.Symmetrize(!0)),!(e.some((e=>e.some((e=>"number"!=typeof e&&void 0!==e))))||!t.IsPosDef())}multivariate_normal(e,t,r=0,i=1){if(this.state===dt.Prep)this.PrepMultivariate(e,t),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=mt.MC.Normal(this.iterations,{mean:r,sd:i,lhs:this.lhs,ordered:!0});else if(this.state===dt.Simulation)return{type:s.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return this.ValidateCorrelationMatrix(t)?{type:s.number,value:mt.MC.Normal(1,{mean:r,sd:i})[0]}:ee()}multivariate_lognormal(e,t,r=0,i=1){if(this.state===dt.Prep)this.PrepMultivariate(e,t),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=mt.MC.LogNormal(this.iterations,{mean:r,sd:i,lhs:this.lhs,ordered:!0});else if(this.state===dt.Simulation)return{type:s.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return this.ValidateCorrelationMatrix(t)?{type:s.number,value:mt.MC.LogNormal(1,{mean:r,sd:i})[0]}:ee()}multivariate_beta(e,t,r=1,i=2){if(this.state===dt.Prep)this.PrepMultivariate(e,t),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=mt.MC.Beta(this.iterations,{a:r,b:i,lhs:this.lhs,ordered:!0});else if(this.state===dt.Simulation)return{type:s.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return this.ValidateCorrelationMatrix(t)?{type:s.number,value:mt.MC.Beta(1,{a:r,b:i})[0]}:ee()}multivariate_uniform(e,t,r=0,i=1){if(this.state===dt.Prep)this.PrepMultivariate(e,t),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=mt.MC.Uniform(this.iterations,{min:r,max:i,lhs:this.lhs,ordered:!0});else if(this.state===dt.Simulation)return{type:s.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return this.ValidateCorrelationMatrix(t)?{type:s.number,value:mt.MC.Uniform(1,{min:r,max:i})[0]}:ee()}multivariate_pert(e,t,r=0,i=.5,a=1,n=4){if(this.state===dt.Prep)this.PrepMultivariate(e,t),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=mt.MC.PERT(this.iterations,{a:r,b:a,c:i,lambda:n,lhs:this.lhs,ordered:!0});else if(this.state===dt.Simulation)return{type:s.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return this.ValidateCorrelationMatrix(t)?{type:s.number,value:mt.MC.PERT(1,{a:r,b:a,c:i,lambda:n})[0]}:ee()}multivariate_triangular(e,t,r=0,i=.5,a=1){if(this.state===dt.Prep)this.PrepMultivariate(e,t),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=mt.MC.Triangular(this.iterations,{a:r,b:a,c:i,lhs:this.lhs,ordered:!0});else if(this.state===dt.Simulation)return{type:s.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return this.ValidateCorrelationMatrix(t)?{type:s.number,value:mt.MC.Triangular(1,{a:r,b:a,c:i})[0]}:ee()}uniformvalue(e=0,t=1){if(this.state===dt.Prep)this.InitDistribution(),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=mt.MC.Uniform(this.iterations,{min:e,max:t,lhs:this.lhs});else if(this.state===dt.Simulation)return{type:s.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return{type:s.number,value:mt.MC.Uniform(1,{min:e,max:t})[0]}}bernoullivalue(e=.5){if(this.state===dt.Prep)this.InitDistribution(),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=mt.MC.Bernoulli(this.iterations,{p:e,lhs:this.lhs});else if(this.state===dt.Simulation)return{type:s.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return{type:s.boolean,value:mt.MC.Bernoulli(1,{p:e})[0]}}probabilityvalue(e=.5){return this.bernoullivalue(e)}sequentialvalue(e,t=0){if(this.state===dt.Prep)this.InitDistribution();else if(this.state===dt.Simulation){let r=this.iteration;t>0&&(r=this.iteration%t);const i=e[0].length,a=Math.floor(r/i)%e.length,n=r%i;return{type:s.number,value:e[a][n]}}return{type:s.number,value:e[0][0]}}indexvalue(e=0){if(this.state===dt.Prep)this.InitDistribution();else if(this.state===dt.Simulation)return e>0?{type:s.number,value:this.iteration%e+1}:{type:s.number,value:this.iteration+1};return{type:s.number,value:1}}lognormalvalue(e=0,t=1){if(this.state===dt.Prep)this.InitDistribution(),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=mt.MC.LogNormal(this.iterations,{mean:e,sd:t,lhs:this.lhs});else if(this.state===dt.Simulation)return{type:s.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return{type:s.number,value:mt.MC.LogNormal(1,{mean:e,sd:t})[0]}}truncatednormalvalue(e=0,t=1,r,i){if(this.state===dt.Prep)this.InitDistribution(),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=mt.MC.TruncatedNormal(this.iterations,{mean:e,sd:t,lhs:this.lhs,min:r,max:i});else if(this.state===dt.Simulation)return{type:s.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return{type:s.number,value:mt.MC.TruncatedNormal(1,{mean:e,sd:t,min:r,max:i})[0]}}normalvalue(e=0,t=1){if(this.state===dt.Prep)this.InitDistribution(),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=mt.MC.Normal(this.iterations,{mean:e,sd:t,lhs:this.lhs});else if(this.state===dt.Simulation)return{type:s.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return{type:s.number,value:mt.MC.Normal(1,{mean:e,sd:t})[0]}}pertvalue(e=0,t=.5,r=1,i=4){if(this.state===dt.Prep)this.InitDistribution(),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=mt.MC.PERT(this.iterations,{a:e,b:r,c:t,lambda:i,lhs:this.lhs});else if(this.state===dt.Simulation)return{type:s.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return{type:s.number,value:mt.MC.PERT(1,{a:e,b:r,c:t,lambda:i})[0]}}pertvalue_p(e=0,t=.5,r=1,i=4){if(this.state===dt.Prep){const s=mt.MC.P80Pert(e,r,t,i);this.InitDistribution(),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=mt.MC.PERT(this.iterations,Object.assign(Object.assign({},s),{lambda:i,lhs:this.lhs}))}else if(this.state===dt.Simulation)return{type:s.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};const a=mt.MC.P80Pert(e,r,t,i);return{type:s.number,value:mt.MC.PERT(1,Object.assign(Object.assign({},a),{lambda:i}))[0]}}CommonDistributionFunction(e,t,r){if(this.state===dt.Prep)this.InitDistribution(),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=e.apply(t,[this.iterations].concat(r));else if(this.state===dt.Simulation)return this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration];return e.apply(t,[1].concat(r))[0]}triangularvalue(e=0,t=.5,r=1){if(this.state===dt.Prep)this.InitDistribution(),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=mt.MC.Triangular(this.iterations,{a:e,b:r,c:t,lhs:this.lhs});else if(this.state===dt.Simulation)return{type:s.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return{type:s.number,value:mt.MC.Triangular(1,{a:e,b:r,c:t})[0]}}betavalue(e=1,t=1){if(this.state===dt.Prep)this.InitDistribution(),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=mt.MC.Beta(this.iterations,{a:e,b:t,lhs:this.lhs});else if(this.state===dt.Simulation)return{type:s.number,value:this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]};return{type:s.number,value:mt.MC.Beta(1,{a:e,b:t})[0]}}samplevalue(e){return this.uniformrangesample(e)}samplevalue_weighted(e,t){if(this.state===dt.Prep)this.InitDistribution(),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=mt.MC.Uniform(this.iterations,{min:0,max:1,lhs:this.lhs});else{const r=this.state===dt.Simulation?this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]:mt.MC.Uniform(1,{min:0,max:1})[0];if(!e||!e.length)return{type:s.undefined,value:void 0};const i=r*Oe(t).reduce(((e,t)=>void 0===t?e:e+Number(t)),0);let a=0;for(let r=0;r<e.length;r++)for(let n=0;n<e[r].length;n++)if(a+=t[r][n],a>=i)return{type:s.number,value:e[r][n]}}return{type:s.number,value:e[0][0]}}uniformrangesample(e){this.state===dt.Prep&&(this.InitDistribution(),this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index]=mt.MC.Uniform(this.iterations,{min:0,max:1,lhs:this.lhs}));const t=this.state===dt.Simulation?this.distributions[this.address.sheet_id||0][this.address.column][this.address.row][this.call_index][this.iteration]:mt.MC.Uniform(1,{min:0,max:1})[0];if(!e||!e.length)return{type:s.undefined,value:void 0};const r=Math.floor(e[0].length*e.length*t),a=e[r%e.length][Math.floor(r/e.length)]||"";return{value:a,type:i(a)}}simulationtrials(){return{type:s.number,value:this.trials}}simulationtime(){return{type:s.number,value:this.elapsed/1e3}}simulationvaluesarray(e){if(this.state!==dt.Null)return{type:s.number,value:0};if(!e||!e.length)return ee();const t=[];for(let r=0;r<e.length;r++)t[r]={type:s.number,value:e[r]};return[t]}simulationvaluesarray_ordered(e,t){if(this.state!==dt.Null)return{type:s.number,value:0};if(!e||!e.length||t&&!t.length)return ee();if(!t)return[Array.prototype.slice.call(e,0).sort(((e,t)=>e-t)).map((e=>({type:s.number,value:e})))];const r=Array.from(e).map(((e,r)=>[e,t[r]]));return r.sort(((e,t)=>e[1]-t[1])),[r.map((e=>({type:s.number,value:e[0]})))]}simulationrsquared(e,t){return this.state!==dt.Null?{type:s.number,value:0}:e&&e.length&&t&&t.length?{type:s.number,value:mt.Stats.R2(e,t)}:ee()}simulationcorrelation(e,t){return this.state!==dt.Null?{type:s.number,value:0}:e&&e.length&&t&&t.length?{type:s.number,value:mt.Stats.Correlation(e,t)}:ee()}sortedsimulationindex(e,t=1){if(this.state!==dt.Null)return{type:s.number,value:0};if(!e||!e.length)return ee();if(t<1||t>e.length)return re();const r=Array.from(e).map(((e,t)=>[e,t+1]));return r.sort(((e,t)=>e[0]-t[0])),{type:s.number,value:r[t-1][1]}}simulationvalue(e,t=1){return this.state!==dt.Null?{type:s.number,value:0}:e&&e.length?t<1||t>e.length?re():{type:s.number,value:e[t-1]}:ee()}simulationpercentile(e,t=.5){return this.state!==dt.Null?{type:s.number,value:0}:e&&e.length?{type:s.number,value:mt.Stats.Percentile(e,t)}:ee()}simulationstandarddeviation(e){if(this.state!==dt.Null)return{type:s.number,value:0};if(!e||!e.length)return ee();const t=mt.Stats.Statistics(e);return{type:s.number,value:t.stdev}}simulationvariance(e){if(this.state!==dt.Null)return{type:s.number,value:0};if(!e||!e.length)return ee();const t=mt.Stats.Statistics(e);return{type:s.number,value:t.variance}}simulationskewness(e){if(this.state!==dt.Null)return{type:s.number,value:0};if(!e||!e.length)return ee();const t=mt.Stats.Statistics(e);return{type:s.number,value:t.skewness}}simulationkurtosis(e){if(this.state!==dt.Null)return{type:s.number,value:0};if(!e||!e.length)return ee();const t=mt.Stats.Statistics(e);return{type:s.number,value:t.kurtosis}}simulationinterval(e,t,r){return this.state!==dt.Null?{type:s.number,value:0}:e&&e.length?{type:s.number,value:mt.Stats.Interval({data:e,min:t,max:r})}:ee()}simulationstandarderror(e){if(this.state!==dt.Null)return{type:s.number,value:0};if(!e||!e.length)return ee();let t=0,r=0;for(const r of e)t+=r||0;const i=t/e.length;for(const t of e){const e=t-i;r+=e*e}return{type:s.number,value:Math.sqrt(r/e.length)/Math.sqrt(e.length)}}simulationmin(e){return this.state!==dt.Null?{type:s.number,value:0}:e&&e.length?{type:s.number,value:Math.min.apply(0,e)}:ee()}simulationmax(e){return this.state!==dt.Null?{type:s.number,value:0}:e&&e.length?{type:s.number,value:Math.max.apply(0,e)}:ee()}simulationmean(e){if(this.state!==dt.Null)return{type:s.number,value:0};if(!e||!e.length)return ee();let t=0;for(const r of e)t+=r;return{type:s.number,value:t/e.length}}simulationmedian(e){if(this.state!==dt.Null)return{type:s.number,value:0};if(!e||!e.length)return ee();const t=e.filter((e=>"number"==typeof e?e:0));return t.sort(((e,t)=>e-t)),{type:s.number,value:t[Math.round(t.length/2)]}}Permutation(e){if(!e){const{rows:e,columns:t}=this.CallerArea(),r=e*t;if(r<=0)return re();const i=ft(r),a=[];let n=0;for(let r=0;r<t;r++){const t=[];for(let r=0;r<e;r++)t.push({type:s.number,value:i[n++]});a.push(t)}return a}if(Array.isArray(e)){const t=e.length,r=e[0].length;if(!t||!r)return re();const s=e.reduce(((e,t)=>t.concat(e)),[]),i=t*r;if(s.length!==i)throw console.info("invalid?",i,e,s),new Error("invalid length");const a=ft(i),n=[];let o=0;for(let e=0;e<t;e++){const e=[];for(let t=0;t<r;t++){const t=a[o++];e.push(Object.assign({},s[t]))}n.push(e)}return n}return Object.assign({},e)}Scale(e,t){const{rows:r,columns:i}=this.CallerArea(),a=Math.max(r,i),n=e>t?N(t,e,a-1,!0):N(e,t,a-1,!0);let o=n.min;const l=[[]];if(n.count<a-1&&(o=n.min-Math.floor((a-1-n.count)/2)*n.step),e>t)for(let e=0;e<a;e++){const t=o+e*n.step;l[0][a-1-e]={type:s.number,value:t}}else for(let e=0;e<a;e++){const t=o+e*n.step;l[0][e]={type:s.number,value:t}}return r<i?Fe(l):l}HistogramTable(e){const{rows:t,columns:r}=this.CallerArea(),i=Math.max(t,r),a=Math.min(t,r);if(Array.isArray(e)||e instanceof Float64Array||e instanceof Float32Array){if(e.length<=1)return{type:s.number,value:0};Array.isArray(e)||(e=Array.prototype.slice.call(e)),e.sort(((e,t)=>e-t));const n=e[0]||0,o=e[e.length-1]||0;if(o===n)return{type:s.number,value:0};let l=[[],[]];const u=N(n,o,i,!0);let h=u.min,c=0;u.count<i&&(h=u.min-Math.ceil(i-u.count)/2*u.step);for(let t=0;t<i;t++){const r=h+(t+1)*u.step;let i=0;for(;c<e.length&&e[c]<r;c++,i++);l[1][t]={type:s.number,value:i},l[0][t]={type:s.number,value:r}}return 1===a&&(l=[l[1]]),r>t?Fe(l):l}return{type:s.number,value:0}}}class _t extends Te{constructor(e,t){super(e,t),this.simulation_model=new pt,this.context=this.simulation_model}CallExpression(e,t=!1){const r=this.library.Get(e.name);if(!r)return e=>ae();const i=r.arguments||[];return this.simulation_model.state===dt.Prep&&e.args.forEach(((e,t)=>{const r=i[t]||{};if(e&&r.collector)if("address"===e.type)this.simulation_model.StoreCellResults(e);else if("identifier"===e.type){const t=this.named_range_map[e.name.toUpperCase()];t&&this.simulation_model.StoreCellResults(t.start)}else if("call"===e.type){const t=this.CalculateExpression(e,!0);t&&Pe(t)&&("address"===t.value.type?this.simulation_model.StoreCellResults(t.value):"range"===t.value.type&&this.simulation_model.StoreCellResults(t.value.start))}})),a=>{const n=this.call_index++;this.simulation_model.volatile=this.simulation_model.volatile||!!r.volatile||!!r.simulation_volatile&&this.simulation_model.state!==dt.Null;const o="IF"===e.name.toUpperCase();let l,h=-1;const c=a.args.map(((e,t)=>{if(l)return;const r=i[Math.min(t,i.length-1)]||{};if(t===h)return r.boxed?u():void 0;if(void 0===e)return o&&0===t&&(h=1),r.boxed?u():void 0;if(r.address)return r.boxed?{type:s.string,value:this.parser.Render(e).replace(/\$/g,"")}:this.parser.Render(e).replace(/\$/g,"");if(r.metadata)return this.GetMetadata(e,((e,t)=>({simulation_data:this.simulation_model.state===dt.Null?this.simulation_model.StoreCellResults(t):[]})));if(r.collector&&this.simulation_model.state===dt.Null){if("address"===e.type)return this.simulation_model.StoreCellResults(e);if("range"===e.type)return this.simulation_model.StoreCellResults(e.start);if("identifier"===e.type){const t=this.named_range_map[e.name.toUpperCase()];if(t)return this.simulation_model.StoreCellResults(t.start)}else if("call"===e.type){const t=this.CalculateExpression(e,!0);if(t&&Pe(t)){if("address"===t.value.type)return this.simulation_model.StoreCellResults(t.value);if("range"===t.value.type)return this.simulation_model.StoreCellResults(t.value.start)}}return l=ie(),l}{const i=this.CalculateExpression(e);if(!Array.isArray(i)&&i.type===s.error)return r.allow_error?i:void(l=i);if(o&&0===t&&!Array.isArray(i)){let e=!1;if(i.type===s.string){const t=i.value.toLowerCase().trim();e="false"!==t&&"f"!==t}else e=!!i.value;h=e?2:1}return r.boxed?i:Array.isArray(i)?i.map((e=>e.map((e=>e.value)))):i.value}}));if(l)return l;if(this.context.call_index=n,r.return_type===oe.reference){const e=r.fn.apply(null,c);if(t)return e;if(Pe(e)){if("address"===e.value.type)return this.CellFunction2(e.value)();if("range"===e.value.type)return this.CellFunction4(e.value.start,e.value.end)}return e}return r.fn.apply(null,c)}}}class yt extends class extends class{constructor(){this.vertices=[[]],this.volatile_list=[],this.calculation_list=[],this.cells_map={},this.leaf_vertices=[],this.dirty_list=[],this.loop_check_required=!1}IsSpreadsheetVertex(e){return e.type===Q.type}AttachData(e){this.model=e,this.cells_map={};for(const t of e.sheets)this.cells_map[t.id]=t.cells}FlushTree(){this.dirty_list=[],this.volatile_list=[],this.vertices=[[]],this.leaf_vertices=[],this.cells_map={},Y.Clear()}ResolveArrayHead(e){if(!e.sheet_id)throw new Error("resolve array head with no sheet id");const t=this.cells_map[e.sheet_id];if(!t)throw new Error("no cells? sheet id "+e.sheet_id);const r=t.data[e.row];if(r){const t=r[e.column];if(t&&t.area){const r={row:t.area.start.row,column:t.area.start.column,sheet_id:e.sheet_id};return console.info("array head",e,r),r}}return e}GetVertex(e,t){if(!e.sheet_id)throw new Error("getvertex with no sheet id");const r=this.cells_map[e.sheet_id];if(!r)throw new Error("no cells? sheet id "+e.sheet_id);if(!this.vertices[e.sheet_id]){if(!t)return;this.vertices[e.sheet_id]=[]}if(this.vertices[e.sheet_id][e.column]){const r=this.vertices[e.sheet_id][e.column][e.row];if(r)return r;if(!t)return}else{if(!t)return;this.vertices[e.sheet_id][e.column]=[]}const s=new Q;return s.address={row:e.row,column:e.column,absolute_row:e.absolute_row,absolute_column:e.absolute_column,sheet_id:e.sheet_id},s.reference=r.EnsureCell(e),this.vertices[e.sheet_id][e.column][e.row]=s,Y.CreateImplicitEdges(s,e),s}RemoveVertex(e){if(!e.sheet_id)throw new Error("removevertex with no sheet id");const t=this.GetVertex(e,!1);t&&(t.Reset(),this.vertices[e.sheet_id][e.column][e.row]=void 0)}ResetVertex(e){const t=this.GetVertex(e,!1);t&&t.Reset()}ResetInbound(e,t=!1,r=!0,s=!1){const i=this.GetVertex(e,r);if(i)i.ClearDependencies(),t&&this.SetVertexDirty(i),s&&this.RemoveVertex(e);else if(t){const t=Y.GetContainingArrays(e);for(const e of t)this.SetVertexDirty(e)}}ResetLoopState(){for(const e of this.vertices)if(e)for(const t of e)if(t)for(const e of t)e&&(e.color=e.edges_out.length?z.white:z.black);for(const e of this.leaf_vertices)e.color=z.black}LoopCheck(e=!1){if(!this.loop_check_required&&!e)return!1;const t=[];for(const e of this.vertices)if(e)for(const r of e)if(r)for(const e of r)e&&(e.color=e.edges_out.length?z.white:z.black,t.push(e));const r=[];for(const e of t)if(e.color===z.white){for(e.color=z.gray,r.push(e);r.length;){const t=r[r.length-1];let s=!0;if(t.color!==z.black)for(const i of t.edges_out){if(i.color===z.gray)return this.loop_hint=this.RenderAddress(e.address),console.info("loop detected @",this.loop_hint),!0;i.color===z.white&&(i.color=z.gray,r.push(i),s=!1)}s&&(r.pop(),t.color=z.black)}e.color=z.black}return this.loop_check_required=!1,this.loop_hint=void 0,!1}RenderAddress(t){if(!t)return"undefined";let r="";if(t.sheet_id&&this.model)for(const e of this.model.sheets)if(t.sheet_id===e.id){r=e.name+"!";break}return r+new e(t).spreadsheet_label}AddArrayEdge(e,t){if(!e.start.sheet_id)throw new Error("AddArrayEdge called without sheet ID");const r=this.GetVertex(t,!0),[s,i]=Y.GetVertex(e);if(r.DependsOn(s),this.loop_check_required=!0,!i)return;const a=this.vertices[e.start.sheet_id];if(a)if(e.entire_row){for(let t=0;t<a.length;t++)if(a[t])for(let r=e.start.row;r<=e.end.row;r++){const e=a[t][r];e&&s.DependsOn(e)}console.groupEnd()}else if(e.entire_column){for(let t=e.start.column;t<=e.end.column;t++)if(a[t])for(const e of a[t])(null==e?void 0:e.address)&&s.DependsOn(e);console.groupEnd()}else for(let t=e.start.row;t<=e.end.row;t++)for(let r=e.start.column;r<=e.end.column;r++){const e=a[r][t];e&&s.DependsOn(e)}}AddEdge(e,t){const r=this.GetVertex(e,!0);this.GetVertex(t,!0).DependsOn(r),r.reference&&r.reference.area&&!r.array_head&&this.AddEdge(Object.assign(Object.assign({},e),{row:r.reference.area.start.row,column:r.reference.area.start.column}),t),this.loop_check_required=!0}RemoveEdge(e,t){const r=this.GetVertex(e,!1),s=this.GetVertex(t,!1);r&&s&&(r.RemoveDependent(s),s.RemoveDependency(r))}SetAreaDirty(e){if(e.start.column===1/0||e.end.column===1/0||e.start.row===1/0||e.end.row===1/0)throw new Error("don't iterate over infinite area");const t=e.start.sheet_id;if(!t)throw new Error("invalid area, missing sheet id");for(let r=e.start.column;r<=e.end.column;r++)for(let s=e.start.row;s<=e.end.row;s++){const e={row:s,column:r,sheet_id:t};this.GetVertex(e,!1)&&this.SetDirty(e)}}SetVertexDirty(e){if(!e.dirty){this.dirty_list.push(e),e.dirty=!0;for(const t of e.edges_out)this.SetVertexDirty(t)}}SetDirty(e){const t=this.GetVertex(e,!0);this.SetVertexDirty(t)}AddLeafVertex(e){for(const t of this.leaf_vertices)if(t===e)return;this.leaf_vertices.push(e)}RemoveLeafVertex(e){this.leaf_vertices=this.leaf_vertices.filter((t=>t!==e))}AddLeafVertexEdge(e,t){const r=this.GetVertex(e,!0);return t.DependsOn(r),q.OK}RemoveLeafVertexEdge(e,t){const r=this.GetVertex(e,!1);r&&(r.RemoveDependent(t),t.RemoveDependency(r))}InitializeGraph(){for(const e of this.dirty_list)this.IsSpreadsheetVertex(e)&&(e.TakeReferenceValue(),this.CheckVolatile(e)&&this.volatile_list.push(e)),e.dirty=!1;this.dirty_list=[]}Recalculate(){for(const e of this.volatile_list)this.SetVertexDirty(e);this.calculation_list=this.dirty_list.slice(0),this.volatile_list=[],this.dirty_list=[],this.loop_check_required&&(this.ResetLoopState(),this.loop_check_required=!1);for(let e=0;e<this.calculation_list.length;e++)this.calculation_list[e].Calculate(this);this.calculation_list=[]}}{constructor(){super(),this.library=new Ue,this.parser=new G,this.expression_calculator=new Te(this.library,this.parser),this.full_rebuild_required=!1,this.UpdateLocale(),this.library.Register(qe,et,it,Xe,rt,nt,lt);for(const e of Object.keys(at))this.library.Alias(e,at[e]);for(const e of Object.keys(tt))this.library.Alias(e,tt[e]);this.library.Register({CountIf:{arguments:[{name:"range"},{name:"criteria"}],fn:(e,t)=>{const r=Oe(e);"string"!=typeof t?t="="+(t||0).toString():(t=t.trim(),/^[=<>]/.test(t)||(t="="+t));const i=this.parser.Parse("{}"+t),a=i.expression;if(i.error||!a)return X();if("binary"!==a.type)return X();if("array"!==a.left.type)return X();a.left.values=[r];const n=this.CalculateExpression(a);if(Array.isArray(n)){let e=0;for(const t of n)for(const r of t)r.value&&e++;return{type:s.number,value:e}}return n}},Offset:{arguments:[{name:"reference",description:"Base reference",metadata:!0},{name:"rows",description:"number of rows to offset"},{name:"columns",description:"number of columns to offset"}],return_type:oe.reference,volatile:!0,fn:((e,t=0,r=0,i=1,a=1)=>{if(!e)return re();if(!Ee(e))return ie();const n=this.DynamicDependencies(e.value.address,this.expression_calculator.context.address,!0,t,r,i,a);if(!n)return ie();if(n.dirty)return this.GetVertex(this.expression_calculator.context.address,!0).short_circuit=!0,{type:s.undefined,value:void 0};if(n.area){const e=Object.assign(Object.assign({type:"address"},n.area.start),{label:"",position:0,id:0}),t=Object.assign(Object.assign({type:"address"},n.area.end),{label:"",position:0,id:0}),r=1===n.area.count?e:{type:"range",start:e,end:t,label:"",position:0,id:0};return{type:s.object,value:r}}return se()}).bind(this)},Indirect:{arguments:[{name:"reference",description:"Cell reference (string)"}],return_type:oe.reference,volatile:!0,fn:(e=>{if(!e||"string"!=typeof e)return re();const t=this.parser.Parse(e);if(t.error||!t.expression||"address"!==t.expression.type&&"range"!==t.expression.type)return ie();const r=this.DynamicDependencies(t.expression,this.expression_calculator.context.address);return r?r.dirty?(this.GetVertex(this.expression_calculator.context.address,!0).short_circuit=!0,{type:s.undefined,value:void 0}):{type:s.object,value:t.expression}:ie()}).bind(this)},Rows:{arguments:[{name:"reference",description:"Array or reference"}],volatile:!1,fn:e=>{if(!e)return re();if(Array.isArray(e)){const t=e[0];return Array.isArray(t)?{type:s.number,value:t.length}:se()}return{type:s.number,value:1}}},Columns:{arguments:[{name:"reference",description:"Array or reference"}],volatile:!1,fn:e=>e?Array.isArray(e)?{type:s.number,value:e.length}:{type:s.number,value:1}:re()},IsFormula:{description:"Returns true if the reference is a formula",arguments:[{name:"Reference",metadata:!0}],fn:Le((e=>{var t,r;if(null===(t=null==e?void 0:e.value)||void 0===t?void 0:t.address)for(const t of(null===(r=this.model)||void 0===r?void 0:r.sheets)||[])if(t.id===e.value.address.sheet_id){const r=t.cells.GetCell(e.value.address,!1);return{type:s.boolean,value:(null==r?void 0:r.type)===s.formula}}return{type:s.boolean,value:!1}}))}})}SpreadCallback(e,t){if(!e.address||!e.address.sheet_id)throw new Error("spread callback called without sheet id");const r=this.cells_map[e.address.sheet_id];if(!r)throw new Error("spread callback called without cells");if(!e||!e.reference)return;const i=e.reference.area;if(i){const e=i.rows,a=i.columns;if(Array.isArray(t)){t=Fe(t);for(let n=0;n<e;n++)if(t[n]){let e=0;for(;e<a&&e<t[n].length;e++)r.data[n+i.start.row][e+i.start.column].SetCalculatedValue(t[n][e].value,t[n][e].type);for(;e<a;e++)r.data[n+i.start.row][e+i.start.column].SetCalculatedValue(void 0,s.undefined)}else for(let e=0;e<a;e++)r.data[n+i.start.row][e+i.start.column].SetCalculatedValue(void 0,s.undefined)}else for(let s=0;s<e;s++)for(let e=0;e<a;e++)r.data[s+i.start.row][e+i.start.column].SetCalculatedValue(t.value,t.type)}}CalculationCallback(e){if(!e.address)throw new Error("vertex missing address");return e.expression_error?{value:ne()}:this.expression_calculator.Calculate(e.expression,e.address)}DynamicDependencies(t,r,s=!1,i=0,a=0,n=1,o=1){if(!this.model)return;let l=this.ResolveExpressionAddress(t,r);if(!l)return;let u=!1;l=this.model.active_sheet.RealArea(l);const h=l.start.sheet_id;s&&(l=new e({column:l.start.column+a,row:l.start.row+i,sheet_id:l.start.sheet_id},{column:l.start.column+a+n-1,row:l.start.row+i+o-1,sheet_id:l.end.sheet_id}));for(let e=l.start.row;e<=l.end.row;e++)for(let t=l.start.column;t<=l.end.column;t++){const r=this.GetVertex({row:e,column:t,sheet_id:h},!1);r&&r.dirty&&(this.AddEdge({row:e,column:t,sheet_id:h},this.expression_calculator.context.address),u=!0)}return{dirty:u,area:l}}UpdateLocale(){","===p.decimal_separator?(this.parser.decimal_mark=O.Comma,this.parser.argument_separator=F.Semicolon):(this.parser.decimal_mark=O.Period,this.parser.argument_separator=F.Comma)}GetFunction(e){return this.library.Get(e)}SupportedFunctions(){const e=this.library.List(),t=Object.keys(e).map((t=>{let r=e[t].canonical_name;return r||(r=t.replace(/_/g,".")),{name:r,description:e[t].description,arguments:(e[t].arguments||[]).map((e=>({name:e.name||""})))}}));if(this.model)for(const e of Object.keys(this.model.macro_functions)){const r=this.model.macro_functions[e];t.push({name:r.name,description:r.description,arguments:(r.argument_names||[]).map((e=>({name:e})))})}return t}RegisterFunction(e){for(const t of Object.keys(e)){const r=e[t],s=r.fn;r.fn=(...e)=>s.apply({address:Object.assign({},this.expression_calculator.context.address)},e),this.library.Register({[t]:r})}}AttachModel(e){this.AttachData(e),this.expression_calculator.SetModel(e)}Calculate(e,t){if(this.AttachModel(e),t&&!t.start.sheet_id)throw new Error("CalculateInternal called with subset w/out sheet ID");this.full_rebuild_required&&(t=void 0,this.UpdateAnnotations(),this.full_rebuild_required=!1),this.RebuildGraph(t);try{this.Recalculate()}catch(e){console.error(e),console.info("calculation error trapped")}}Reset(){this.FlushTree(),this.model&&this.AttachModel(this.model),this.full_rebuild_required=!0}CalculateExpression(e,t={row:-1,column:-1},r=!1){return this.expression_calculator.Calculate(e,t,r).value}RebuildClean(e,t=!1){this.full_rebuild_required=!1,this.AttachModel(e),this.RebuildGraph(),this.UpdateAnnotations(),this.InitializeGraph(),t&&this.volatile_list.length&&this.Recalculate()}FlattenCellList(t){const r={},s=[];for(const i of t){const t={column:i.column,row:i.row,sheet_id:i.sheet_id},a=e.CellAddressToLabel(t,!0);r[a]||(r[a]=a,s.push(t))}return s}MetadataReferences(e){const t=[];if(!this.model)return t;const r=this.parser.Parse(e);if(r.expression&&"call"===r.expression.type){const e=this.GetFunction(r.expression.name);if(!e||!e.arguments)return t;for(let s=0;s<e.arguments.length;s++){const i=e.arguments[s];if(!i||!i.metadata)continue;const a=r.expression.args[s];if(!a)continue;const n=this.ResolveExpressionAddress(a);n&&t.push(n.start)}}return t}RemoveAnnotation(e){const t=e.temp.vertex;t&&(t.Reset(),this.RemoveLeafVertex(t))}UpdateAnnotations(e){if(!e&&this.model&&(e=this.model.active_sheet.annotations),e){void 0===e||Array.isArray(e)||(e=[e]);for(const t of e)if(t.formula){t.temp.vertex||(t.temp.vertex=new ut);const e=t.temp.vertex;this.AddLeafVertex(e),this.UpdateLeafVertex(e,t.formula)}}}ResolveSheetID(e,t){if(!this.model)throw new Error("ResolveSheetID called without model");const r="address"===e.type?e:e.start;if(r.sheet_id)return!0;if(!r.sheet)return r.sheet_id=(null==t?void 0:t.sheet_id)||this.model.active_sheet.id,!0;{const e=r.sheet.toLowerCase();for(const t of this.model.sheets)if(t.name.toLowerCase()===e)return r.sheet_id=t.id,!0}return!1}ResolveExpressionAddress(t,r){switch(t.type){case"address":if(this.ResolveSheetID(t,r))return new e(t);break;case"range":if(this.ResolveSheetID(t,r))return new e(t.start,t.end);break;case"identifier":if(this.model){const r=this.model.named_ranges.Get(t.name.toUpperCase());if(r)return new e(r.start,r.end)}}}NamedRangeToAddressUnit(e){if(!this.model)return;const t=e.name.toUpperCase(),r=this.model.named_ranges.Get(t);return r?1===r.count?this.ConstructAddressUnit(r.start,t,e.id,e.position):{type:"range",start:this.ConstructAddressUnit(r.start,t,e.id,e.position),end:this.ConstructAddressUnit(r.end,t,e.id,e.position),label:t,id:e.id,position:e.position}:void 0}ConstructAddressUnit(e,t,r,s){return{type:"address",row:e.row,column:e.column,sheet_id:e.sheet_id,label:t,id:r,position:s}}RebuildDependencies(e,t,r,s={addresses:{},ranges:{}},i){if(!i&&(i={},this.model)){for(const e of this.model.sheets)i[e.name.toLowerCase()]=e.id;if(!r)for(const e of this.model.sheets)if(e.id===t){r=e.name;break}}switch(e.type){case"literal":case"missing":case"operator":break;case"identifier":{const t=this.NamedRangeToAddressUnit(e);t&&("address"===t.type?s.addresses[t.label]=t:s.ranges[t.label]=t)}break;case"address":e.sheet_id||(e.sheet_id=e.sheet?i[e.sheet.toLowerCase()]||0:t,e.sheet||(e.sheet=r)),s.addresses[e.sheet_id+"!"+e.label]=e;break;case"range":e.start.sheet_id||(e.start.sheet_id=e.start.sheet?i[e.start.sheet.toLowerCase()]||0:t,e.start.sheet||(e.start.sheet=r)),s.ranges[e.start.sheet_id+"!"+e.start.label+":"+e.end.label]=e;break;case"unary":this.RebuildDependencies(e.operand,t,r,s,i);break;case"binary":this.RebuildDependencies(e.left,t,r,s,i),this.RebuildDependencies(e.right,t,r,s,i);break;case"group":e.elements.forEach((e=>this.RebuildDependencies(e,t,r,s,i)));break;case"call":{const a=e.args.slice(0),n=this.library.Get(e.name);n&&n.arguments&&n.arguments.forEach(((e,s)=>{e&&e.address&&(this.RebuildDependencies(a[s],t,r,void 0,i),a[s]={type:"missing",id:-1})})),a.forEach((e=>this.RebuildDependencies(e,t,r,s,i)))}}return s}UpdateLeafVertex(t,r){if(!this.model)throw new Error("UpdateLeafVertex called without model");t.Reset();const s=this.parser.Parse(r);if(s.expression){const r=this.RebuildDependencies(s.expression,this.model.active_sheet.id,this.model.active_sheet.name);for(const s of Object.keys(r.ranges)){const i=r.ranges[s];new e(i.start,i.end).Iterate((e=>{this.AddLeafVertexEdge(e,t)}))}for(const e of Object.keys(r.addresses)){const s=r.addresses[e];this.AddLeafVertexEdge(s,t)}}t.expression=s.expression||{type:"missing",id:-1},t.expression_error=!s.valid}ApplyMacroFunctionInternal(e,t,r){switch(e.type){case"identifier":if(r[0]){const t=r[0][(e.name||"").toUpperCase()];if(t)return JSON.parse(JSON.stringify(t))}break;case"binary":e.left=this.ApplyMacroFunctionInternal(e.left,t,r),e.right=this.ApplyMacroFunctionInternal(e.right,t,r);break;case"unary":e.operand=this.ApplyMacroFunctionInternal(e.operand,t,r);break;case"group":e.elements=e.elements.map((e=>this.ApplyMacroFunctionInternal(e,t,r)));break;case"call":if(e.args=e.args.map((e=>this.ApplyMacroFunctionInternal(e,t,r))),!this.library.Get(e.name)){const s=t.macro_functions[e.name.toUpperCase()];if(s&&s.expression){const i=JSON.parse(JSON.stringify(s.expression)),a={};if(s.argument_names)for(let t=0;t<s.argument_names.length;t++)a[s.argument_names[t].toUpperCase()]=e.args[t]?e.args[t]:{type:"missing"};r.unshift(a);const n=this.ApplyMacroFunctionInternal(i,t,r);return r.shift(),n}}}return e}ApplyMacroFunctions(e){if(this.model)return Object.keys(this.model.macro_functions).length?this.ApplyMacroFunctionInternal(e,this.model,[]):void 0}RebuildGraphCell(t,r){if(t.area&&t.area.start.column===r.column&&t.area.start.row===r.row){const{start:e,end:s}=t.area,i=e.sheet_id||r.sheet_id;e.sheet_id||(e.sheet_id=i);for(let t=e.column;t<=s.column;t++)for(let r=e.row;r<=s.row;r++)this.ResetInbound({column:t,row:r,sheet_id:i},!0,!1);this.SetDirty(r);for(let t=e.column;t<=s.column;t++)for(let r=e.row;r<=s.row;r++)r===e.row&&t===e.column||this.AddEdge(e,Object.assign(Object.assign({},e),{row:r,column:t}))}if(t.type===s.formula){this.ResetInbound(r,!0);const s=this.parser.Parse(t.value);if(s.expression){if("call"===s.expression.type){const e=this.library.Get(s.expression.name);e&&(e.render||e.click)&&(t.render_function=e.render,t.click_function=e.click)}const i=this.RebuildDependencies(s.expression,r.sheet_id,"");for(const t of Object.keys(i.ranges)){const s=i.ranges[t],a=new e(s.start,s.end);a.entire_row||a.entire_column?this.AddArrayEdge(a,r):a.Iterate((e=>this.AddEdge(e,r)))}for(const e of Object.keys(i.addresses)){const t=i.addresses[e];this.AddEdge(t,r)}}const i=this.GetVertex(r,!0);i&&(i.expression=s.expression||{type:"missing",id:-1},i.expression_error=!s.valid)}else t.value!==t.calculated?this.ResetInbound(r,!0,!1):t.type===s.undefined?this.ResetInbound(r,!0,!1,!0):console.warn("UNHANDLED CASE",t)}RebuildGraph(e){var t;if(e){if(!e.start.sheet_id)throw new Error("subset missing sheet id");const t=this.cells_map[e.start.sheet_id];for(let r=e.start.row;r<=e.end.row;r++){const s=t.data[r];if(s)for(let t=e.start.column;t<=e.end.column;t++){const i=s[t];i&&this.RebuildGraphCell(i,{row:r,column:t,sheet_id:e.start.sheet_id})}}}else for(const e of(null===(t=this.model)||void 0===t?void 0:t.sheets)||[]){const t=e.cells.data.length;for(let r=0;r<t;r++){const t=e.cells.data[r];if(t){const s=t.length;for(let i=0;i<s;i++){const s=t[i];s&&this.RebuildGraphCell(s,{row:r,column:i,sheet_id:e.id})}}}}}IsNativeOrTypedArray(e){return Array.isArray(e)||e instanceof Float64Array||e instanceof Float32Array}CheckVolatile(e){if(!e.expression||e.expression_error)return!1;let t=!1;return this.parser.Walk(e.expression,(e=>{if("call"===e.type){const r=this.library.Get(e.name);r&&r.volatile&&(t=!0)}return!t})),t}}{constructor(){super(),this.expression_calculator=this.simulation_expression_calculator=new _t(this.library,this.parser),this.library.Register(this.simulation_expression_calculator.simulation_model.functions)}InitSimulation(e,t,r,s,i){var a;const n=this.simulation_expression_calculator.simulation_model;if(n.iterations=e,n.results=[],n.lhs=t,n.correlated_distributions={},"number"==typeof i&&(n.seed=i),this.Reset(),this.AttachModel(r),s&&s.length)for(const e of s){if(!e.sheet_id)throw new Error("additional cell passed without sheet id");for(const t of(null===(a=this.model)||void 0===a?void 0:a.sheets)||[])if(t.id===e.sheet_id){t.cells.GetCell(e,!1)&&n.StoreCellResults(e);break}}if(this.RebuildGraph(),this.LoopCheck())throw new Error("Loop (circular dependency) found in graph");return n.state=dt.Prep,n.iteration=0,this.Recalculate(),n.CorrelateDistributions(),n.state=dt.Simulation,q.OK}GetResults(){return this.simulation_expression_calculator.simulation_model.results}SimulationTrial(e){const t=this.simulation_expression_calculator.simulation_model;t.iteration=e;try{this.Recalculate();for(const r in t.results){const s=this.cells_map[r];for(const i in t.results[r]){const a=t.results[r][i];for(const t in a){const r=s.GetCell({row:Number(t),column:Number(i)});if(r){const s=r.GetValue();switch(typeof s){case"number":a[t][e]=s;break;case"boolean":a[t][e]=s?1:0;break;default:a[t][e]=0}}}}}return{status:q.OK,reference:null}}catch(e){return console.info("calculation error trapped",e),{status:q.CalculationError,reference:null}}}FlattenedResults(){const e=this.simulation_expression_calculator.simulation_model,t=[];for(const r in e.results)for(const s in e.results[r]){const i=e.results[r][s];for(const e in i)t.push(ht({row:Number(e),column:Number(s),sheet_id:Number(r),data:i[e]}).buffer)}return t}FlushSimulationResults(){const e=this.simulation_expression_calculator.simulation_model;e.results=[],e.elapsed=0,e.trials=0}ShiftSimulationResults(e,t,r,s){}UpdateResults(e,t=this.model,r=!0){if(!t)throw new Error("UpdateResults called without model");const s=this.simulation_expression_calculator.simulation_model;if(e){s.results=[],s.elapsed=e.elapsed,s.trials=e.trials;for(const i of e.results){const e=i instanceof ArrayBuffer?ct(new Float64Array(i)):i;e.sheet_id||(e.sheet_id=t.active_sheet.id),s.results[e.sheet_id]||(s.results[e.sheet_id]=[]),s.results[e.sheet_id][e.column]||(s.results[e.sheet_id][e.column]=[]),s.results[e.sheet_id][e.column][e.row]=e.data,r&&this.SetDirty(e)}}else s.results=[],s.elapsed=0,s.trials=0}}const gt=self,vt=new class{constructor(e){this.base_worker=e,this.trials=0,this.lhs=!1,this.data_model={active_sheet:E.Blank({}),sheets:[E.Blank({})],named_ranges:new T,macro_functions:{}},this.screen_updates=!1,this.calculator=new yt,this.start_time=0,this.additional_cells=[],this.iteration=0}Timestamp(){return self.performance?performance.now():Date.now()}OnMessage(e){const t=e.data;if(t)switch(t.type){case"configure":if(t.locale&&t.locale!==p.locale&&(p.UpdateLocale(t.locale),this.calculator.UpdateLocale()),this.data_model.sheets=t.sheets.map((e=>E.FromJSON(e,{}))),this.data_model.active_sheet=this.data_model.sheets[0],t.additional_cells&&(this.additional_cells=t.additional_cells),this.data_model.named_ranges.Deserialize(t.named_ranges),this.data_model.macro_functions={},t.macro_functions)for(const e of t.macro_functions)this.data_model.macro_functions[e.name.toUpperCase()]=e;this.seed=t.seed;break;case"step":this.SimulationStep();break;case"start":this.trials=t.trials||1e3,this.lhs=!!t.lhs,this.screen_updates=!!t.screen_updates,this.Start()}}Post(e,t){this.base_worker.postMessage(e,t)}SimulationStep(){if(this.iteration>=this.trials)return;this.calculator.SimulationTrial(this.iteration);const e=Math.floor(this.iteration/this.trials*100);if(++this.iteration===this.trials)return void this.Finish();const t=this.calculator.FlattenedResults(),r=this.Timestamp()-this.start_time;this.Post({type:"update",percent_complete:e,cells:this.data_model.active_sheet.cells.toJSON(),trial_data:{results:t,trials:this.iteration,elapsed:r}},t)}Start(){if(!this.trials)throw new Error("invalid trial count");this.start_time=this.Timestamp();const e=this.calculator.InitSimulation(this.trials,this.lhs,this.data_model,this.additional_cells,this.seed);if(this.seed=void 0,e!==q.OK)throw new Error("graph failed");let t=0;if(this.screen_updates)this.iteration=0,this.SimulationStep();else{for(let e=0;e<this.trials;e++){this.calculator.SimulationTrial(e);const r=Math.floor(e/this.trials*100);r!==t&&(t=r,this.Post({type:"progress",percent_complete:t}))}this.Finish()}}Finish(){this.Post({type:"progress",percent_complete:100});const e=this.calculator.FlattenedResults(),t=this.Timestamp()-this.start_time;this.Post({type:"complete",trial_data:{results:e,trials:this.trials,elapsed:t}},e)}}(gt);gt.addEventListener("message",(e=>vt.OnMessage(e)))})()})();